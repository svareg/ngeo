{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/goog.asserts.prod.js","webpack:///./src/GeometryType.js","webpack:///./src/format/FeatureProperties.js","webpack:///./src/format/AttributeType.js","webpack:///./contribs/gmf/src/theme/Themes.js","webpack:///./src/datasource/OGC.js","webpack:///./src/rule/Rule.js","webpack:///./contribs/gmf/src/index.js","webpack:///./src/misc/ToolActivate.js","webpack:///./src/misc/FeatureHelper.js","webpack:///./src/utils.js","webpack:///./src/CustomEvent.js","webpack:///./src/message/Message.js","webpack:///./src/map/LayerHelper.js","webpack:///./src/rule/Geometry.js","webpack:///./src/map/FeatureOverlayMgr.js","webpack:///./src/layertree/Controller.js","webpack:///./src/interaction/Measure.js","webpack:///./contribs/gmf/src/layertree/TreeManager.js","webpack:///./src/misc/decorate.js","webpack:///./src/query/MapQuerent.js","webpack:///./src/misc/EventHelper.js","webpack:///./src/misc/WMSTime.js","webpack:///./src/misc/filters.js","webpack:///./contribs/gmf/src/layertree/SyncLayertreeMap.js","webpack:///./src/misc/ToolActivateMgr.js","webpack:///./src/filter/Condition.js","webpack:///./src/rule/Date.js","webpack:///./src/rule/Text.js","webpack:///./src/filter/RuleHelper.js","webpack:///./src/datasource/File.js","webpack:///./src/datasource/FileGroup.js","webpack:///./src/datasource/OGCGroup.js","webpack:///./src/datasource/WMSGroup.js","webpack:///./contribs/gmf/src/datasource/ExternalDataSourcesManager.js","webpack:///./src/misc/btnComponent.js","webpack:///./src/datasource/DataSources.js","webpack:///./contribs/gmf/src/editing/editFeatureComponent.js","webpack:///./contribs/gmf/src/theme/Manager.js","webpack:///./src/datasource/DataSource.js","webpack:///./src/rule/Select.js","webpack:///./contribs/gmf/src/editing/EditFeature.js","webpack:///./src/misc/debounce.js","webpack:///./src/statemanager/Location.js","webpack:///./src/statemanager/Service.js","webpack:///./src/interaction/common.js","webpack:///./contribs/gmf/src/authentication/Service.js","webpack:///./src/misc/Time.js","webpack:///./src/interaction/DrawAzimut.js","webpack:///./src/interaction/MeasureAzimut.js","webpack:///./src/message/popupComponent.js","webpack:///./src/message/Popup.js","webpack:///./src/map/FeatureOverlay.js","webpack:///./src/format/XSDAttribute.js","webpack:///./src/datasource/Group.js","webpack:///./src/WFSDescribeFeatureType.js","webpack:///./src/query/Querent.js","webpack:///./src/format/WFSAttribute.js","webpack:///./src/datasource/Helper.js","webpack:///./contribs/gmf/src/editing/Snapping.js","webpack:///./src/interaction/Translate.js","webpack:///./src/interaction/Rotate.js","webpack:///./src/draw/features.js","webpack:///./src/Menu.js","webpack:///./src/download/service.js","webpack:///./contribs/gmf/src/datasource/DataSourceBeingFiltered.js","webpack:///./src/message/modalComponent.js","webpack:///./src/message/Notification.js","webpack:///./src/misc/php-date-formatter.js","webpack:///./contribs/gmf/src/permalink/ShareService.js","webpack:///./src/print/Utils.js","webpack:///./src/proj/EPSG21781.js","webpack:///./src/interaction/MeasureLength.js","webpack:///./src/interaction/MeasureArea.js","webpack:///./contribs/gmf/src/authentication/component.js","webpack:///./contribs/gmf/src/authentication/module.js","webpack:///./src/map/BackgroundLayerMgr.js","webpack:///./contribs/gmf/src/backgroundlayerselector/component.js","webpack:///./contribs/gmf/src/datasource/Helper.js","webpack:///./contribs/gmf/src/datasource/OGC.js","webpack:///./contribs/gmf/src/datasource/WFSAliases.js","webpack:///./contribs/gmf/src/datasource/Manager.js","webpack:///./contribs/gmf/src/datasource/module.js","webpack:///./src/message/Disclaimer.js","webpack:///./contribs/gmf/src/disclaimer/component.js","webpack:///./contribs/gmf/src/filters/SavedFilters.js","webpack:///./src/filter/ruleComponent.js","webpack:///./src/filter/component.js","webpack:///./contribs/gmf/src/filters/filterselectorComponent.js","webpack:///./contribs/gmf/src/filters/module.js","webpack:///./contribs/gmf/src/layertree/timeSliderComponent.js","webpack:///./contribs/gmf/src/layertree/module.js","webpack:///./contribs/gmf/src/permalink/module.js","webpack:///./src/map/component.js","webpack:///./src/map/scaleselector.js","webpack:///./src/map/module.js","webpack:///./contribs/gmf/src/map/component.js","webpack:///./contribs/gmf/src/map/mousepositionComponent.js","webpack:///./contribs/gmf/src/map/module.js","webpack:///./src/grid/Config.js","webpack:///./src/grid/component.js","webpack:///./contribs/gmf/src/query/gridComponent.js","webpack:///./src/misc/swipe.js","webpack:///./contribs/gmf/src/query/windowComponent.js","webpack:///./contribs/gmf/src/query/extraModule.js","webpack:///./contribs/gmf/src/search/module.js","webpack:///./contribs/gmf/src/theme/selectorComponent.js","webpack:///./contribs/gmf/src/theme/module.js","webpack:///./src/message/displaywindowComponent.js","webpack:///./src/misc/controlComponent.js","webpack:///./src/misc/filereaderComponent.js","webpack:///./src/misc/getBrowserLanguage.js","webpack:///./src/misc/extraModule.js","webpack:///./src/query/mapQueryComponent.js","webpack:///./src/statemanager/WfsPermalink.js","webpack:///./contribs/gmf/src/controllers/AbstractAppController.js","webpack:///./src/interaction/ModifyCircle.js","webpack:///./src/interaction/ModifyRectangle.js","webpack:///./src/interaction/Modify.js","webpack:///./src/draw/Controller.js","webpack:///./src/draw/point.js","webpack:///./src/draw/rectangle.js","webpack:///./src/draw/text.js","webpack:///./src/measure/area.js","webpack:///./src/measure/azimut.js","webpack:///./src/measure/length.js","webpack:///./src/draw/component.js","webpack:///./src/editing/createfeatureComponent.js","webpack:///./contribs/gmf/src/editing/XSDAttributes.js","webpack:///./contribs/gmf/src/raster/RasterService.js","webpack:///./src/proj/somerc.js","webpack:///./src/misc/colorpickerComponent.js","webpack:///./src/misc/AutoProjection.js","webpack:///./contribs/gmf/src/search/FulltextSearch.js","webpack:///./src/download/Csv.js","webpack:///./src/map/resizemap.js","webpack:///./contribs/gmf/src/permalink/shareComponent.js","webpack:///./contribs/gmf/src/layertree/datasourceGroupTreeComponent.js","webpack:///./src/statemanager/module.js","webpack:///./contribs/gmf/src/permalink/Permalink.js","webpack:///./src/misc/datepickerComponent.js","webpack:///./src/format/Attribute.js","webpack:///./contribs/gmf/src/editing/EnumerateAttribute.js","webpack:///./src/misc/File.js","webpack:///./contribs/gmf/src/controllers/AbstractDesktopController.js","webpack:///./contribs/gmf/src/contextualdata/component.js","webpack:///./contribs/gmf/src/contextualdata/module.js","webpack:///./src/format/FeatureHashStyleType.js","webpack:///./src/format/FeatureHash.js","webpack:///./contribs/gmf/src/editing/editFeatureSelectorComponent.js","webpack:///./contribs/gmf/src/editing/module.js","webpack:///./src/print/VectorEncoder.js","webpack:///./src/print/Service.js","webpack:///./contribs/gmf/src/drawing/featureStyleComponent.js","webpack:///./contribs/gmf/src/drawing/drawFeatureComponent.js","webpack:///./contribs/gmf/src/drawing/module.js","webpack:///./contribs/gmf/src/import/wmsCapabilityLayertreeComponent.js","webpack:///./contribs/gmf/src/import/wmtsCapabilityLayertreeComponent.js","webpack:///./contribs/gmf/src/import/importdatasourceComponent.js","webpack:///./contribs/gmf/src/import/module.js","webpack:///./src/search/searchDirective.js","webpack:///./src/search/createGeoJSONBloodhound.js","webpack:///./src/search/createLocationSearchBloodhound.js","webpack:///./src/search/module.js","webpack:///./src/profile/d3Elevation.js","webpack:///./src/profile/elevationComponent.js","webpack:///./contribs/gmf/src/profile/component.js","webpack:///./contribs/gmf/src/profile/drawLineComponent.js","webpack:///./contribs/gmf/src/profile/module.js","webpack:///./src/query/bboxQueryComponent.js","webpack:///./contribs/gmf/src/raster/component.js","webpack:///./contribs/gmf/src/print/component.js","webpack:///./src/misc/datetimepickerComponent.js","webpack:///./src/editing/attributesComponent.js","webpack:///./src/editing/exportfeaturesComponent.js","webpack:///./src/misc/sortableComponent.js","webpack:///./src/message/popoverComponent.js","webpack:///./contribs/gmf/src/search/component.js","webpack:///./src/map/recenter.js","webpack:///./src/misc/syncArrays.js","webpack:///./src/layertree/component.js","webpack:///./src/olcs/constants.js","webpack:///./src/Popover.js","webpack:///./contribs/gmf/src/layertree/component.js","webpack:///./contribs/gmf/apps/appmodule.js","webpack:///./contribs/gmf/src/objectediting/coordinate.js","webpack:///./contribs/gmf/src/objectediting/geom.js","webpack:///./contribs/gmf/src/objectediting/Query.js","webpack:///./contribs/gmf/src/objectediting/getWMSFeatureComponent.js","webpack:///./src/interaction/DrawRegularPolygonFromClick.js","webpack:///./src/editing/createregularpolygonfromclickComponent.js","webpack:///./contribs/gmf/src/objectediting/toolsComponent.js","webpack:///./contribs/gmf/src/objectediting/component.js","webpack:///./contribs/gmf/src/objectediting/Manager.js","webpack:///./contribs/gmf/src/objectediting/module.js","webpack:///./src/proj/EPSG2056.js","webpack:///./contribs/gmf/apps/oeedit/Controller.js","webpack:///./contribs/gmf/apps/oeedit/contextualdata.html","webpack:///./contribs/gmf/src/objectediting/component.html","webpack:///./contribs/gmf/src/objectediting/toolsComponent.html","webpack:///./contribs/gmf/src/import/importdatasourceComponent.html","webpack:///./contribs/gmf/src/import/wmtsCapabilityLayertreeComponent.html","webpack:///./contribs/gmf/src/import/wmsCapabilityLayertreeComponent.html","webpack:///./contribs/gmf/src/raster/widgetComponent.html","webpack:///./contribs/gmf/src/profile/component.html","webpack:///./contribs/gmf/src/print/component.html","webpack:///./contribs/gmf/src/editing/editFeatureSelectorComponent.html","webpack:///./contribs/gmf/src/editing/editFeatureComponent.html","webpack:///./src/editing/attributescomponent.html","webpack:///./contribs/gmf/src/drawing/drawFeatureComponent.html","webpack:///./contribs/gmf/src/drawing/featureStyleComponent.html","webpack:///./src/message/displaywindowComponent.html","webpack:///./contribs/gmf/src/theme/selectorComponent.html","webpack:///./contribs/gmf/src/search/component.html","webpack:///./src/misc/colorpickerComponent.html","webpack:///./contribs/gmf/src/query/windowComponent.html","webpack:///./contribs/gmf/src/query/gridComponent.html","webpack:///./src/grid/component.html","webpack:///./contribs/gmf/src/map/mousepositionComponent.html","webpack:///./contribs/gmf/src/map/component.html","webpack:///./src/map/scaleselector.html","webpack:///./contribs/gmf/src/permalink/shareComponent.html","webpack:///./contribs/gmf/src/layertree/timesliderComponent.html","webpack:///./contribs/gmf/src/layertree/component.html","webpack:///./src/layertree/component.html","webpack:///./contribs/gmf/src/layertree/datasourceGroupTreeComponent.html","webpack:///./contribs/gmf/src/permalink/crosshair.svg","webpack:///./contribs/gmf/src/filters/filterselectorcomponent.html","webpack:///./src/filter/component.html","webpack:///./src/filter/rulecomponent.html","webpack:///./src/misc/datepickerComponent.html","webpack:///./src/message/popupcomponent.html","webpack:///./contribs/gmf/src/backgroundlayerselector/component.html","webpack:///./contribs/gmf/src/authentication/component.html"],"names":["webpackJsonpCallback","data","chunkIds","moreModules","executeModules","moduleId","chunkId","i","resolves","length","installedChunks","push","Object","prototype","hasOwnProperty","call","modules","parentJsonpFunction","shift","deferredModules","apply","checkDeferredModules","result","deferredModule","fulfilled","j","depId","splice","__webpack_require__","s","installedModules","1","exports","module","l","m","c","d","name","getter","o","defineProperty","configurable","enumerable","get","r","value","n","__esModule","getDefault","getModuleExports","object","property","p","jsonpArray","window","oldJsonpFunction","bind","slice","assert","condition","opt_message","var_args","assertNumber","assertString","assertFunction","assertObject","assertArray","assertBoolean","assertElement","assertInstanceof","type","assertObjectPrototypeIsIntact","CIRCLE","LINE_STRING","MULTI_LINE_STRING","MULTI_POINT","MULTI_POLYGON","POINT","POLYGON","RECTANGLE","TEXT","ANGLE","COLOR","IS_CIRCLE","IS_RECTANGLE","IS_TEXT","NAME","SHOW_LABEL","OPACITY","AZIMUT","SHOW_MEASURE","SIZE","STROKE","BOOLEAN","DATE","DATETIME","TIME","GEOMETRY","NUMBER","SELECT","$http","$injector","$q","ngeoLayerHelper","gettextCatalog","gmfThemesOptions","olEventsEventTarget","this","addBlankBackgroundLayer_","addBlankBackgroundLayer","undefined","$q_","$http_","treeUrl_","has","cacheVersion_","ngeoLocation_","layerHelper_","deferred_","defer","promise_","promise","loaded","bgLayerPromise_","olBase","findGroupByLayerNodeName","themes","ii","theme","jj","children","group","childNodes","getFlatNodes","findObjectByName","findGroupByName","internalNodes","getFlatInternalNodes","objects","objectName","olArray","findThemeByName","themeName","node","nodes","getBgLayers","_this","layerHelper","getIds","item","array","forEach","child","callback","layer","set","metadata","dimensions","ids","layerLayerCreationFn","ogcServers","gmfLayer","gmfLayerWMTS","googAsserts","url","createWMTSLayerFromCapabilitites","matrixSet","customOpenLayersOptions","then","response","message","console","error","resolve","gmfLayerWMS","ogcServer","server","imageType","opt_params","STYLES","styles","_iterator","entries","_isArray","Array","isArray","_i","Symbol","iterator","_ref2","next","done","_ref","key","createBasicWMSLayer","layers","credential","fail","layerGroupCreationFn","orderedChildren","map","x","reverse","promises","all","collection","filter","olCollection","createBasicGroup","promiseSuccessFn","background_layers","itemType","values","getString","olLayerTile","label","thumbnail","getThemeObject","getThemesObject","getBackgroundLayersObject","getOgcServersObject","hasEditableLayers","hasEditableLayers_","_this2","some","hasNodeEditableLayers_","editable","getSnappingConfig","config","snappingConfig","getNodeMaxResolution","maxResolution","maxResolutionHint","getNodeMinResolution","minResolution","minResolutionHint","loadThemes","opt_roleId","_this3","params","role","cache_version","cache","withCredentials","errors","join","hasParam","alert","dispatchEvent","reject","NodeType","MIXED_GROUP","NOT_MIXED_GROUP","WMTS","WMS","angular","ngeoMapLayerHelper","service","_inherits","_ngeoDatasourceDataSo","options","_classCallCheck","_possibleConstructorReturn","dimensionsConfig_","dimensionsConfig","dimensionsFiltersConfig_","dimensionsFiltersConfig","filterCondition_","filterCondition","ngeoFilterCondition","AND","filterRules_","filterRules","filtrable_","filtrable","copyable_","copyable","dimensions_","geometryName_","geometryName","DEFAULT_GEOMETRY_NAME_","ogcImageType_","ogcImageType","ogcLayers_","ogcLayers","ogcServerType_","ogcServerType","ServerType","MAPSERVER","ogcType_","ogcType","Type","snappable_","snappable","snappingToEdges_","snappingToEdges","snappingToVertice_","snappingToVertice","snappingTolerance_","snappingTolerance","timeAttributeName_","timeAttributeName","timeLowerValue_","timeLowerValue","timeProperty_","timeProperty","timeUpperValue_","timeUpperValue","wfsFeatureNS_","wfsFeatureNS","WFSFeatureNS","wfsFeaturePrefix_","wfsFeaturePrefix","WFSFeaturePrefix","FEATURE","wfsOutputFormat_","wfsOutputFormat","WFSOutputFormat","GML3","wfsUrl_","wfsUrl","wmsInfoFormat_","wmsInfoFormat","WMSInfoFormat","GML","wmsIsSingleTile_","wmsIsSingleTile","wmsUrl_","wmsUrl","wmtsLayer_","wmtsLayer","wmtsUrl_","wmtsUrl","queryable","ogcLayer","wfsFormat","supportsWFS","format","olFormatGML3","GML2","olFormatGML2","olFormatWFS","featureNS","featureType","gmlFormat","wfsFormat_","wmsFormat","supportsWMS","olFormatWMSGetFeatureInfo","wmsFormat_","getAttributes","attributes","setAttributes","updateGeometryNameFromAttributes_","combinableWithDataSourceForWFS","dataSource","combinableForWFS","haveTheSameActiveDimensions","combinableWithDataSourceForWMS","combinableForWMS","isAnyOGCLayerInRange","res","queryableOnly","arguments","getInRangeOGCLayerNames","layerNames","_iterator2","_isArray2","_i2","maxRes","minRes","inMinRange","inMaxRange","inRange","getOGCLayerNames","_iterator3","_isArray3","_i3","_ref3","getFiltrableOGCLayerName","_iterator4","_isArray4","_i4","_ref4","attribute","ngeoFormatAttributeType","share","myActive","activeDimensions","itsActive","_createClass","time","range","lower","upper","end","start","active","timeRangeValue","supportsOGCQueries","_iterator5","_isArray5","_i5","_ref5","ngeoDatasourceDataSource","guessServiceTypeByUrl","test","GEOSERVER","QGISSERVER","geoserver","mapserver","qgisserver","active_","expression","lowerBoundary_","lowerBoundary","operator_","operator","upperBoundary_","upperBoundary","isCustom_","isCustom","name_","operators_","operators","propertyName_","propertyName","type_","listenerKeys","getExpression","setExpression","reset","destroy","olEvents","OperatorType","BETWEEN","TemporalOperatorType","DURING","EQUAL_TO","GREATER_THAN","GREATER_THAN_OR_EQUAL_TO","LESSER_THAN","LESSER_THAN_OR_EQUAL_TO","LIKE","NOT_EQUAL_TO","SpatialOperatorType","CONTAINS","INTERSECTS","WITHIN","BEGINS","ENDS","EQUALS","DATALAYERGROUP_NAME","EXTERNALLAYERGROUP_NAME","COORDINATES_LAYER_NAME","PermalinkParam","BG_LAYER","BG_LAYER_OPACITY","EXTERNAL_DATASOURCES_NAMES","EXTERNAL_DATASOURCES_URLS","FEATURES","MAP_CROSSHAIR","MAP_TOOLTIP","MAP_X","MAP_Y","MAP_Z","TREE_GROUPS","WFS_LAYER","WFS_NGROUPS","WFS_SHOW_FEATURES","toolContext","activePropertyName","getActive","setActive","newVal","$filter","$filter_","decimals_","precision_","numberFormat_","unitPrefixFormat_","ngeoNumberCoordinates_","pointFilterFn_","pointFilterArgs_","filterElements","split","filterName","projection_","download_","setProjection","projection","setStyle","feature","opt_select","getStyle","supportsVertex_","getVertexStyle","unshift","getHaloStyle_","getType","style","ngeoGeometryType","getLineStringStyle_","getPointStyle_","getPolygonStyle_","getTextStyle_","constructor","strokeWidth","getStrokeProperty","showLabel","getShowLabelProperty","showMeasure","getShowMeasureProperty","color","getRGBAColorProperty","olStyleStyle","stroke","olStyleStroke","width","textLabelValues","getMeasure","getNameProperty","textLabelValue","text","createTextStyle_","size","getSizeProperty","image","olStyleCircle","radius","fill","olStyleFill","font_size","point_to_px","offsetY","optNumber","attrib","getNumber","opacity","getOpacityProperty","fillColor","azimut","ngeoFormatFeatureProperties","line","getRadiusLine","ngeoInteractionMeasure","getFormattedLength","geometry","angle","olGeomPoint","getLastCoordinate","offsetX","Math","cos","PI","sin","exceedLength","getAngleProperty","createEditingStyles","white","blue","geom","getGeometry","zIndex","Infinity","opt_incGeomFunc","incGeomFunc","olStyleRegularShape","points","innerMultiCoordinates","multiCoordinates","coordinates","olGeomLineString","getCoordinates","olGeomMultiLineString","olGeomPolygon","olGeomMultiPolygon","concat","olGeomMultiPoint","supported","haloSize","getFilteredFeatureValues","properties","getProperties","getGeometryName","getColorProperty","olColor","export","features","formatType","FormatType","GPX","exportGPX","KML","exportKML","olFormatGPX","mimeType","fileName","export_","olFormatKML","opt_mimeType","clones","clone","olFeature","writeOptions","dataProjection","featureProjection","writeFeatures","rotation","font","olStyleText","measure","ngeoInteractionMeasureAzimut","getFormattedAzimutRadius","getFormattedArea","getFormattedPoint","args","panMapToFeature","opt_panDuration","panDuration","getSize","view","getView","extent","calculateExtent","intersectsExtent","mapCenter","getCenter","featureCenter","getCoordinateAt","getInteriorPoint","olExtent","getExtent","animate","center","duration","y","endPoint","getNonSpatialProperties","nonSpatialProperties","clearNonSpatialProperties","ngeoDownloadService","ngeoMiscFilters","toMulti","multiGeom","appendPoint","appendLineString","appendPolygon","isSafari","navigator","userAgent","indexOf","colorZeroPadding","hex","rgbArrayToHex","rgb","g","b","Error","hexR","toString","hexG","hexB","decodeQueryString","queryString","queryData","pairs","substring","pair","indexOfEquals","decodeURIComponent","encodeQueryString","queryItem","encodeURIComponent","deleteCondition","event","olEventsCondition","extentToRectangle","getTopLeft","getTopRight","getBottomRight","getBottomLeft","detail","olEventsEvent","showMessage","show","msgObjects","getMessageObjects","ERROR","info","INFORMATION","success","SUCCESS","warn","WARNING","opt_type","msgObject","defaultType","msg","ngeoTilesPreloadingLimit","tilesPreloadingLimit_","GROUP_KEY","REFRESH_PARAM","sourceURL","sourceLayersName","sourceFormat","opt_serverType","opt_time","opt_crossOrigin","opt_customSourceOptions","opt_customLayerOptions","FORMAT","LAYERS","olServerType","replace","assign","serverType","crossOrigin","source","olSourceImageWMS","updateParams","layerOptions","olLayerImage","createBasicWMSLayerFromDataSource","setVisible","visible","id","capabilitiesURL","layerName","opt_matrixSet","opt_dimensions","opt_customOptions","parser","olFormatWMTSCapabilities","preload","read","optionsFromCapabilities","olSourceWMTS","olObj","updateDimensions","setSource","elt","index","createWMTSLayerFromCapabilititesObj","capabilities","layerCap","capabilitiesStyles","opt_layers","OlLayerGroup","setLayers","getGroupFromMap","groupName","groups","getLayerGroup","getLayers","getArray","existingGroup","addLayer","getFlatLayers","sublayers","hasGroupLayer","sublayer","getFlatLayers_","computedOpacity","getOpacity","getLayerByName","found","getWMTSLegendURL","legendURL","getWMSLegendURL","opt_scale","opt_legendRule","opt_legendWidth","opt_legendHeight","opt_servertype","opt_dpi","opt_bbox","opt_srs","opt_additionalQueryString","TRANSPARENT","SERVICE","VERSION","REQUEST","LAYER","round","olUri","isLayerVisible","getVisible","currentResolution","getResolution","getMinResolution","getMaxResolution","refreshWMSLayer","source_","getSource","olSourceTileWMS","getParams","random","setZIndexToFirstLevelChildren","element","ZIndex","innerGroupLayers","innerLayer","setZIndex","updateWMSLayerState","names","getQuerySourceIds","_ngeoRuleRule","featureProperties","feature_","format_","olFormatGeoJSON","updatingExpression_","updatingGeometry_","geometryChangeListenerKey_","handleFeatureGeometryChange_","setGeometryFromExpression_","registerGeometryChange_","writeGeometry","handleGeometryChange_","evt","target","olGeomGeometry","readGeometry","setGeometry","ngeoRuleRule","featureUidToGroupIndex_","groups_","olSourceVector","useSpatialIndex","layer_","olLayerVector","styleFunction_","updateWhileAnimating","updateWhileInteracting","addFeature","groupIndex","featureUid","removeFeature","clear","getLayer","getFeatureOverlay","styleFunction","olStyleDefaultFunction","ngeoMapFeatureOverlay","init","setMap","defaultFunction","toStyleFunction","resolution","$scope","$rootScope","$attrs","isRoot","nodeExpr","rootScope_","state_","$watch","oldVal","$eval","mapExpr","parent","$parent","$on","uid","depth","nodelayerExpr","nodelayerexprExpr","newNodelayerExpr","treeCtrl","olLayerLayer","olLayerGroup","dataSource_","ngeoMiscDecorate","layerLoading","$broadcast","listenersExpr","listenersexprExpr","treeScope","getState","setState","state","opt_broadcast","setStateInternal_","refreshState","firstParents","getFirstParentTree","firstParent","newState","getCalculateState","childState","previousChildState","getSetActive","val","removeLayer","getDataSource","setDataSource","tree","VisitorDecision","STOP","SKIP","DESCEND","Visitor","traverseDepthFirst","visitor","decision","stop","controller","olInteractionInteraction","handleEvent","handleEvent_","helpTooltipElement_","helpTooltipOverlay_","measureTooltipElement_","measureTooltipOverlay_","measureTooltipOverlayCoord_","sketchFeature","continueMsg","decimals","precision","displayHelpTooltip_","displayHelpTooltip","startMsg","document","createElement","textContent","changeEventKey_","postcomposeEventKey_","vectorLayer_","drawInteraction_","createDrawInteraction","sketchStyle","shouldHandleDrawInteractionActiveChange_","handleDrawInteractionActiveChange_","onDrawStart_","onDrawEnd_","updateState_","polygon","transform","area","abs","olSphere","getFormattedCircleArea","circle","pow","getRadius","lineString","c1","olProj","c2","point","opt_template","dragging","helpMsg","olDom","appendChild","setPosition","coordinate","getDrawInteraction","prevMap","getMap","removeInteraction","addInteraction","createMeasureTooltip_","handleMeasure","coord","innerHTML","cancelEventKey_","body","handleEscapeKeyDown_","classList","add","setOffset","ngeoCustomEvent","unlistenerEvent_","createHelpTooltip_","removeHelpTooltip_","olOverlay","offset","positioning","addOverlay","removeOverlay","parentNode","removeChild","removeMeasureTooltip_","stopEvent","getTooltipElement","escPressed","keyCode","$timeout","ngeoNotification","gmfThemes","ngeoStateManager","$timeout_","$injector_","gettextCatalog_","ngeoNotification_","gmfThemes_","root","rootCtrl","numberOfGroupsToAddInThisDigestLoop","groupsToAddInThisDigestLoop_","promiseForGroupsToAddInThisDigestLoop_","ngeoStateManager_","ogcServers_","handleThemesChange_","refreshFirstLevelGroups_","setFirstLevelGroups","firstLevelGroups","deleteParam","gmfBase","addFirstLevelGroups","opt_add","opt_silent","groupNotAdded","addFirstLevelGroup_","notifyCantAddGroups_","updateTreeGroupsState_","treeGroupsParam","updateState","cleanParams","alreadyAdded","groupID","rootChild","grp","cancel","addGroupByName","_this4","gmfThemeThemes","addGroupByLayerName","_this5","groupAdded","getTreeCtrlByNodeId","treeCtrlToActive","ngeoLayertreeController","removeGroup","removeAll","cloneGroupNode_","toggleNodeCheck_","_this6","childNode","isChecked","notify","ngeoMessageMessage","correspondingTreeCtrl","getOgcServer","mixed","firstLevelGroupCtrl","gmfGroup","_this7","firstLevelGroupsFullState","getFirstLevelGroupFullState_","nodesToRestore","nodeToRestore","fullState","setNodeMetadataFromFullState_","_this8","isExpanded","isLegendExpanded","nodeElement","$","hasClass","legendElement","is","_this9","ngeoMessageNotification","ngeoStatemanagerService","interaction","olLayerBase","setOpacity","incrementEvents","decrementEvents","incrementLoadCount_","increment_","decrementLoadCount_","decrement_","on","olEvent","newLayer","olSourceTile","olSourceImage","$applyAsync","load_count","$inject","ngeoDataSources","ngeoDataSourcesHelper","ngeoQuerent","ngeoQueryResult","dataSources_","ngeoDataSourcesHelper_","ngeoQuerent_","result_","limit_","limit","queryCountFirst_","queryCountFirst","tolerancePx_","tolerance","bboxAsGETParam_","bboxAsGETParam","dataSourceNames_","issue","queryableDataSources","dataSources","getQueryableDataSources","tolerancePx","wfsCount","pending","handleResult_","total","sources","queried","tooManyResults","totalFeatureCount","_loop","idStr","Number","querentResultItem","tooManyFeatures","typeSeparatedFeatures","filteredProperties","alias","unset","setProperties","featuresByType","ngeoDatasourceDataSources","ngeoDatasourceHelper","ngeoQueryQuerent","listenerKeys_","addListenerKey","initListenerKey_","clearListenerKey","ngeoMiscTime","formatTimeValue","opt_useISOFormat","opt_toUTC","date","Date","utc","yearResolution","monthResolution","dayResolution","secondResolution","toISOString","formatWMSTimeParam","wmsTimeProperty","times","mode","Scalify","numberFilter","filterFn","scale","$locale","formats","NUMBER_FORMATS","number","opt_precision","groupSep","GROUP_SEP","decimalSep","DECIMAL_SEP","sign","nb_decimal","floor","log","factor","decimal","unit","str_number","str_unit","UnitPrefix","standardPrefix","binaryPrefix","opt_unit","divisor","prefix","index_max","postfix","space","NumberCoordinates","opt_fractionDigits","template","fractionDigits","parseInt","DMSCoordinates","degreesToStringHDMS","degrees","hemispheres","normalizedDegrees","olMath","dms","olString","charAt","xdms","ydms","trustHtmlFilter","$sce","input","trustAsHtml","Duration","TimeUnits","freeze","SECONDS","MINUTES","HOURS","DAYS","pluralize","amount","formattedUnit","getPlural","output","remainder","removeCDATA","ngeoWMSTime","ngeoWMSTime_","ogcServersObject_","ogcServersObject","sync_","createLayer","dataLayerGroup","opt_position","createGroup_","createLeafInAMixedGroup_","initGmfLayerInANotMixedGroup_","updateLayerState_","groupNode","isFirstLevelGroup","printNativeAngle","createLayerFromGroup_","position","insertAt","inAMixedGroup","isOneParentNotMixed_","layerGroup","timeParam","getTimeParam_","hasActiveChildren","ctrl","updateLayerReferences_","createWMTSLayer_","checked","leafNode","firstLevelGroup","getFirstLevelGroupCtrl_","querySourceIds","disclaimer","disclaimers","wmsTime","timeValues","getOptions","isOneParentNotMix","ngeoMiscWMSTime","scope_","registerTool","tool","opt_defaultActivate","unlisten","deactivateTools_","activateDefault_","defaultTool","ENABLE_ASSERTS","defaultTools","entry","unregisterTool","unregisterGroup","activateTool","deactivateTool","hasActiveTool","NOT","OR","Text_inherits","Text_classCallCheck","Text_possibleConstructorReturn","ngeoFeatureHelper","RuleHelper_classCallCheck","ngeoFeatureHelper_","createRulesFromAttributes","opt_isCustom","rules","createRuleFromAttribute","rule","ngeoRuleDate","ngeoRuleGeometry","ngeoRuleSelect","choices","ngeoRuleText","createRules","optionsList","createRule","selectOptions","cloneRule","extendRule","sourceRule","destRule","serializeRules","serializedRule","serializeRule","obj","createFilter","mainFilter","conditions","createFilterFromRule_","srsName","olFormatFilter","incTime","timeFilter","createTimeFilterFromDataSource_","incDimensions","dimensionsFilter","createDimensionsFilterFromDataSource_","createFilterString","filterString","filterNode","writeFilter","xmlSerializer","XMLSerializer","serializeToString","opt_srsName","rot","rsot","rtot","spatialTypes","numericTypes","beginValue","endValue","moment","selectedChoices","selectedChoice","numericExpression","stringExpression","String","field","momentEnd","subtract","startValue","ngeoMiscFeatureHelper","featuresCollection_","wrapX","FileGroup_inherits","_ngeoDatasourceGroup","FileGroup_classCallCheck","FileGroup_possibleConstructorReturn","injector","unregister_","addDataSource","ngeoDatasourceFile","registerDataSource_","handleDataSourceVisibleChange_","oldValue","removeDataSource","unregisterDataSource_","ngeoDatasourceGroup","OGCGroup_inherits","OGCGroup_classCallCheck","OGCGroup_possibleConstructorReturn","url_","OGCGroup_createClass","WMSGroup_inherits","_ngeoDatasourceOGCGro","WMSGroup_classCallCheck","WMSGroup_possibleConstructorReturn","ngeoLayerHelper_","wmsDataSourceUnregister_","init_","ngeoDatasourceOGC","updateLayer_","unregister","WMSGroup_createClass","ngeoDatasourceOGCGroup","ngeoFile","ExternalDataSourcesManager_classCallCheck","injector_","q_","ngeoFile_","extDataSources_","files_","map_","fileGroup_","ngeoDatasourceFileGroup","title","wmsGroupsCollection_","wmtsGroupsCollection_","wmtsCache_","handleDataSourcesRemove_","addWMSGroup_","wmsGroup","wmsGroupsCollection","removeWMSGroup_","remove","getWMSGroup","wmsGroups","addWMTSGroup_","wmtsGroup","wmtsGroupsCollection","removeWMTSGroup_","getWMTSGroup","wmtsGroups","isExternalDataSource","addLayer_","removeLayer_","createAndAddDataSourceFromWMSCapability","getId","req","imagePngType","includes","infoFormats","ngeoDatasourceWMSGroup","createAndAddDataSourceFromWMTSCapability","layerObj","handleWMTSDataSourceVisibleChange_","createAndAddDataSourceFromFile","file","opt_callback","getFileDataSource_","fileGroup","isEmpty","fit","rejections","content","readOptions","getProjection","isKml","extractStyles","readFeatures","isGpx","removeFileDataSource_","removeOGCDataSource_","ExternalDataSourcesManager_createClass","ngeoMiscFile","btnGroupComponent_","$parse","restrict","link","scope","attrs","buttons_","buttonModel","newValue","directive","BtnGroupController","activate","expressionFn","addButton","btnComponent_","require","ctrls","buttonsCtrl","ngModelCtrl","indexInGroup","ngModelGet","ngModelSet","$apply","$setViewValue","$viewValue","$render","toggleClass","collection_","handleDataSourcesAdd_","bindMap_","handleViewResolutionChange_","syncDataSourcesToResolution_","unbindMap_","olView","syncDataSourceToResolution_","supportsDynamicInRange","gmfEditingEditFeature","gmfEditingSnapping","gmfEditingXSDAttributes","ngeoEditingAttributesComponent","ngeoEditingCreatefeatureComponent","ngeoMessageModalComponent","ngeoMiscBtnComponent","ngeoMiscEventHelper","ngeoMiscToolActivateMgr","run","$templateCache","put","component_","dirty","editableTreeCtrl","vectorLayer","closeAfterSave","bindToController","templateUrl","Controller_","$element","gmfEditFeature","gmfSnapping","gmfXSDAttributes","ngeoEventHelper","ngeoToolActivateMgr","element_","timeout_","gmfEditFeature_","gmfSnapping_","gmfXSDAttributes_","ngeoEventHelper_","ngeoToolActivateMgr_","editableNode_","editableWMSLayer_","confirmDeferred_","unsavedModificationsModalShown","createActive","createToolActivate","ngeoMiscToolActivate","mapSelectActive","mapSelectToolActivate","handleFeatureChange_","featureId","interactions_","modify_","modifyToolActivate","menu_","ngeoMenu","actions","cls","translate_","rotate_","rotateToolActivate","translateToolActivate","geomType","showServerError","serverErrorMessage","serverErrorType","$onInit","lang","getCurrentLanguage","datetimepicker","setLocale","setDateFormatter","DateFormatter","getFeaturesCollection","gmfLayertreeSyncLayertreeMap","olInteractionModify","ngeoUtils","ngeoInteractionRotate","ngeoInteractionTranslate","initializeInteractions_","ensureSnapInteractionsOnTop","handleDestroy_","handleFeatureAdd_","handleMapSelectActiveChange_","State","STOP_EDITING_PENDING","confirmCancel","STOP_EDITING_EXECUTE","DEACTIVATE_PENDING","DEACTIVATE_EXECUTE","IDLE","setAttributes_","toggle_","save","setId","dateFormatter","parseDate","jsonFormat","setMinutes","getMinutes","getTimezoneOffset","formatDate","updateFeature","insertFeatures","handleEditFeature_","refresh","close","checkForModifications_","scopeApply","continueWithoutSaving","delete","confirm","deleteFeature","submit","find","click","resp","mask","geomAttr","ngeoFormatXSDAttribute","getGeometryAttribute","keys","createUid","otherUid","toolMgr","handleMenuActionClick_","handleTranslateEnd_","handleRotateEnd_","mapDiv","getViewport","handleMapClick_","handleMapContextMenu_","interactions","getInteractions","activeInteraction","pixel","forEachFeatureAtPixel","ret","hitTolerance","buffer","getFeaturesInExtent","handleGetFeatures_","getEventPixel","getCoordinateFromPixel","open","preventDefault","stopPropagation","_this10","registerInteractions_","_this11","unregisterInteractions_","_this12","newFeature","oldFeature","_this13","handleFeaturePropertyChange_","action","gmfTreeManagerModeFlush","gmfTreeManager","$rootScope_","modeFlush","gmfTreeManager_","themeName_","addTheme","setThemeName","getThemeName","isLoading","updateCurrentTheme","fallbackThemeName","fallbackTheme","$emit","EventType","THEME_NAME_SET","gmfLayertreeTreeManager","inRange_","visible_","id_","identifierAttribute_","identifierAttribute","maxResolution_","minResolution_","choices_","gmfLayersUrl","http_","baseUrl_","layerIds","bbox","getFeaturesWithComparisonFilters","filters","layerId","geoJSON","post","headers","Content-Type","writeFeature","factory_","func","wait","invokeApply","timeout","_len","_key","context","later","factory","location","history","history_","schema_","protocol","domain_","hostname","port_","port","path_","pathname","queryData_","search","fragment_","hash","replaceState","getPath","getUriString","out","encodedQueryData","encodedFragment","hasFragmentParam","getParam","getFragmentParam","getParamAsInt","valueAsInt","isNaN","getParamAsFloat","valueAsFloat","parseFloat","getFragmentParamAsInt","getParamKeys","getFragmentParamKeys","getParamKeysWithPrefix","getFragmentParamKeysWithPrefix","updateFragmentParams","deleteFragmentParam","setPath","path","LocationFactory","$window","lastUri","newUri","$evalAsync","MockProvider","$locationProvider","locationMock","absUrl","opt_path","host","opt_search","opt_paramValue","opt_url","ngeoLocation","ngeoUsedKeyRegexp","initialState","usedKeyRegexp","useLocalStorage_","setUseLocalStorage","paramKeys","keyRegexp","match","localStorage","err","getInitialValue","getInitialStringValue","getInitialNumberValue","getInitialBooleanValue","ngeoStatemanagerLocation","RegExp","getDefaultDrawStyleFunction","createEditingStyle","getDefaultModifyStyleFunction","_olEventsEventTarget","authenticationBaseUrl","gmfUser","user_","noReloadRole_","load_","RouteSuffix","IS_LOGGED_IN","handleLogin_","changePassword","oldPwd","newPwd","confPwd","CHANGE_PASSWORD","param","oldPassword","newPassword","confirmNewPassword","is_password_changed","login","pwd","LOGIN","password","logout","noReload","LOGOUT","resetUser_","resetPassword","RESET_PASSWORD","successFn","respData","getFunctionalities","functionalities","getRoleId","role_id","checkingLoginStatus","setUser_","user","emitEvent","username","role_name","createDate","defaultValue","getTime","minDate","minValue","maxDate","maxValue","minDefaultDate","minDefValue","maxDefaultDate","maxDefValue","defaultValues","getUTCDate","localDate","getUTCFullYear","getUTCMonth","olInteractionPointer","handleDownEvent","handleDownEvent_","handleUpEvent","handleUpEvent_","downPx_","started_","sketchFeature_","sketchPoint_","squaredClickTolerance_","sketchLayer_","ngeoInteractionCommon","downPx","clickPx","dx","dy","squaredDistance","pass","handlePointerMove_","startDrawing_","finishDrawing_","mapBrowserEvent","pointerHandleEvent","modifyDrawing_","createOrUpdateSketchPoint_","updateSketchFeatures_","sketchPointGeom","setCoordinates","sketchFeatures","addFeatures","olGeomCircle","olGeomGeometryCollection","geometries","getGeometriesArray","last","setRadius","getLength","abortDrawing_","shouldStopEvent","olFunctions","unitPrefixFormat","numberFormat","ngeoInteractionDrawAzimut","getGeometries","olProjProjection","formatLength","formatAzimut","getFormattedAzimut","getAzimut","coords","rad","acos","sqrt","directive_","ngeoPopupTemplateUrl","addClass","css","$compile","$new","autoDestroy_","sce_","append","getOpen","setOpen","$destroy","setTitle","trustedTitle","setContent","opt_trusted","setUrl","setWidth","setHeight","height","setSize","setAutoDestroy","autoDestroy","Factory","ngeoMessagePopupComponent","manager","manager_","features_","index_","setFeatures","handleFeatureRemove_","olFormatXML","readFromDocument","doc","nodeType","Node","DOCUMENT_NODE","firstChild","nextSibling","ELEMENT_NODE","readFromNode","localName","elements","getElementsByTagName","readFromElementNode_","getAttribute","nillable","required","ngeoFormatAttribute","setGeometryType","setAttributeByXsdType_","enumerations","restrictions","restrictionNode","maxLengths","maxLength","numType","NumberType","FLOAT","INTEGER","geomAttribute","dataSourcesCollection_","title_","getDataSourceState","VisibilityState","ON","OFF","toggleVisibilityState","visibleToSet","visibilityState","otherState","INDETERMINATE","olXml","PARSERS_","readElement_","objectStack","len","pop","readComplexType_","COMPLEX_TYPE_PARSERS_","readComplexContent_","COMPLEX_CONTENT_PARSERS_","readExtension_","EXTENSION_PARSERS_","readSequence_","SEQUENCE_PARSERS_","NAMESPACE_URIS_","complexType","complexContent","extension","sequence","ngeoRuleHelper","ngeoRuleHelper_","requestCancelers_","wmsGetCapabilitiesPromises_","wmtsGetCapabilitiesPromises_","cancelStillRunningRequests_","combinedWFSDataSources","getCombinableWFSDataSources_","wfs","issueCombinedWFS_","combinedWMSDataSources","getCombinableWMSDataSources_","wms","issueCombinedWMS_","handleCombinedQueryResult_","isDataSourceQueryable_","wfsDescribeFeatureType","supportsAttributes","ogcLayerNames","TYPENAME","ngeoWFSDescribeFeatureType","wmsFindLayerCapability","layerCapabilities","layerCapability","wmsGetCapabilities","baseUrl","opt_cache","olFormatWMSCapabilities","wmtsFindLayerCapability","wmtsGetCapabilities","combinedHash","dataSourceIdStr","dataSourceId","handleQueryResult_","readAndTypeFeatures_","setUniqueIds_","featureTypes","getSetOlFormatTypes_","opt_types","types","setFeatureType","getFeatureType","combinedDataSources","maxFeatures","getCode","getFeatureCommonOptions","_iterator7","_isArray7","_i7","_ref7","featurePrefix","outputFormat","getFeatureDefer","countPromise","getCountOptions","resultType","featureCountXml","writeGetFeature","featureCountRequest","canceler","registerCanceler_","meta","readFeatureCollectionMetadata","numberOfFeatures","getFeatureOptions","featureRequestXml","featureRequest","_iterator6","_isArray6","_i6","_ref6","FEATURE_COUNT","projCode","_iterator8","_isArray8","_i8","_ref8","INFO_FORMAT","activeDimensionsSet","filtrableLayerName","_iterator9","_isArray9","_i9","_ref9","filterParamValue","filterParamValues","wmsSource","wmsGetFeatureInfoUrl","getGetFeatureInfoUrl","combinableDataSources","notCombinableDataSources","_iterator10","_isArray10","_i10","_ref10","combined","_iterator11","_isArray11","_i11","_ref11","combinableDataSource","_iterator12","_isArray12","_i12","_ref12","_iterator13","_isArray13","_i13","_ref13","ds","ogcDS","_iterator14","_isArray14","_i14","_ref14","CombinedDataSources","ngeoFilterRuleHelper","complexTypeElements","readFromComplexTypeElement_","Helper_classCallCheck","cache_","getDataSourceAttributes","wfsDescribeFeatureTypeDefer","ogcLayerName","ngeoFormatWFSAttribute","mapViewChangePromise_","ngeoSnappingSource_","CustomSnap","_olInteractionSnap","addEventListener","olInteractionSnap","treeCtrlsUnregister_","unregisterAllTreeCtrl_","$watchCollection","registerTreeCtrl_","handleMapMoveEnd_","wfsConfig","getWFSConfig_","stateWatcherUnregister","handleTreeCtrlStateChange_","requestDeferred","deactivateItem_","childLayers","ogcServerName","firstTreeCtrl","firstNode","wfsSupport","urlWfs","activateItem_","edge","pixelTolerance","vertex","loadItemFeatures_","refreshSnappingSource_","loadAllItems_","extend","Cache","CacheItem","WFSConfig","featureListenerKeys_","keyPressListenerKey_","myFeatures_","vectorSource_","centerFeatures_","olInteractionTranslate","handleKeyUp_","setState_","currentMap","addFeature_","handleFeaturesAdd_","handleFeaturesRemove_","elem","getTargetElement","cursor","removeFeature_","getGeometryCenterPoint_","centerFeature","modified_","changingFeature_","pixelTolerance_","coordinate_","centerCoordinate_","overlay_","handleDown_","handleDragEvent","handleDrag_","handleUp_","getCenterCoordinate_","willModifyFeatures_","f","getFlatMidpoint","getFlatInteriorPoint","oldX","oldY","centerX","centerY","dx1","dy1","dx0","dy0","a0","atan2","a1","rotate","menuOptions","opt_overlayOptions","olOverlayPositioning","TOP_LEFT","clickOutListenerKey_","contentEl","class","autoClose_","autoClose","headerEl","appendTo","actionsEl","actions_","data-name","prepend","handleActionClick_","handleMapPointerMove_","documentElement","handleClickOut_","getElement","closest","originalEvent","Element","contains","download","opt_fileType","fileType","blob","Blob","saveAs","ngModel","transclude","bindings","resizable","closable","component","_class","$element_","$scope_","modal_","$postLink","attr","dialog","draggable","handle","modal","e","$onDestroy","container","container_","DEFAULT_DELAY_","clearMessageByCacheItem_","classNames","el","html","delay","DAY","HOUR","_compare","str1","str2","toLowerCase","_lpad","char","chr","_extend","_typeof","_indexOf","arr","defaultSettings","dateSettings","days","daysShort","months","monthsShort","meridiem","ordinal","suffixes","2","3","separators","validParts","intParts","tzParts","tzClip","self","getMonth","vDate","vFormat","year","month","day","hour","min","sec","vSettings","vDateFlag","vTimeFlag","vDatePart","iDatePart","vMonth","vMeriIndex","vMeriOffset","mer","vFormatParts","vDateParts","guessDate","vDateStr","vParts","vPattern","vDigit","iPart","iSec","vYear","substr","setMonth","setDate","getFullYear","setFullYear","setHours","setSeconds","parseFormat","vChar","fmt","backslash","doFormat","t","D","w","getDate","N","getDay","z","a","Y","W","F","M","L","A","G","B","H","getUTCHours","getUTCMinutes","getUTCSeconds","getHours","h","getSeconds","u","getMilliseconds","str","exec","I","UTC","O","tzo","P","T","Z","U","BACKSLASH","gmfShortenerCreateUrl","gmfShortenerCreateUrl_","getShortUrl","short_url","status","postShortUrl_","sendShortUrl","shortUrl","email","URL_MAX_LEN","URL_PATH_MAX_LEN","extentHalfHorizontalDistance_","extentHalfVerticalDistance_","INCHES_PER_METER_","DOTS_PER_INCH_","createPrintMaskPostcompose","getScale","opt_rotation","frameState","viewState","viewportWidth","pixelRatio","viewportHeight","olHas","ppi","ipm","extentHalfWidth","extentHalfHeight","beginPath","moveTo","lineTo","closePath","drawPrintZone_","drawPrintZoneWithRotation_","fillStyle","minx","miny","maxx","maxy","diagonal","gamma","atan","omega","x1","y1","x2","y2","x3","y3","x4","y4","getOptimalScale","mapSize","mapResolution","printMapSize","printMapScales","mapWidth","mapHeight","scaleWidth","scaleHeight","optimal","getOptimalResolution","printMapScale","dotsPerMeter","resolutionX","resolutionY","optimalResolution","max","getBottomLeftCorner","getBottomRightCorner","getUpLeftCorner","getUpRightCorner","epsg21781def","somerc","epsg21781extent","proj4","defs","olProjProj4","setExtent","modifierPressed","br","olInteractionDraw","geometryFunction","linestringGeometryFunction","opt_geometry","viewRotation","getRotation","from","to","distance","delta","layerSource","featuresInExtent","lastIntersection","bestIntersection","bestDistance","distanceFromTo","ax","ay","mx","my","unitVector","forEachSegment","point1","point2","computeLineSegmentIntersection","containsXY","lastDistance","proj","line1vertex1","line1vertex2","line2vertex1","line2vertex2","numerator1A","numerator1B","denominator1","ua1","ub1","verticesCount","gmfAuthenticationService","gmfAuthenticationTemplateUrl_","gmfAuthenticationTemplateUrl","allowPasswordReset","allowPasswordChange","passwordValidator","forcePasswordChange","infoMessage","AuthenticationController_","gmfAuthenticationService_","notification_","changingPassword","userMustChangeItsPassword","resetPasswordModalShown","loginVal","pwdVal","oldPwdVal","newPwdVal","newPwdConfVal","setError_","isPasswordValid","notValidMessage","changePasswordReset","catch","resetError_","resetPasswordSuccessFn","messageType","gmfAuthenticationComponent","olObservable","mapUids_","mapUid","BACKGROUNDLAYERGROUP_NAME","previous","bgGroup","setAt","removeAt","current","getOpacityBgLayer","setOpacityBgLayer","baseBgLayer","hasUpdates","updatedDimensions","ngeoMapBackgroundLayerMgr","gmfBackgroundlayerselectorTemplateUrl","opacityOptions","select","ngeoBackgroundLayerMgr","bgLayer","bgLayers","opacityLayer","backgroundLayerMgr_","indexOpa","findIndex","getSetBgLayerOpacity","setLayer","gmfEnumerateAttribute","gmfEnumerateAttribute_","prepareFiltrableDataSource","prepareFiltrableDataSourceDefer","enumAttributes","enumeratedAttributes","getAttributeValues","choice","gmfEditingEnumerateAttribute","_ngeoDatasourceOGC","OGC_classCallCheck","gmfLayer_","OGC_createClass","WFSAliases_classCallCheck","describe","gmfWFSAliases","Manager_classCallCheck","ngeoBackgroundLayerMgr_","ngeoDataSources_","gmfWFSAliases_","dataSourcesCache_","dimensionsWatcherUnregister","treeCtrlCache_","handleNgeoBackgroundLayerChange_","setDatasourceMap","setDimensions","handleDimensionsChange_","getDataSourceLayer_","updateLayerFilter_","clearDataSources_","clearTreeCtrlCache_","promiseThemes","createDataSource_","promiseBgLayers","backgroundLayers","backgroundLayer","handleTreeManagerRootChildrenChange_","newTreeCtrls","treeCtrls","newTreeCtrl","cacheItem","getTreeCtrlCacheItem_","addTreeCtrlToCache_","removeTreeCtrlCacheItem_","queryLayers","wmsLayers","childLayer","isSingleTile","dimensionsFilters","identifierAttributeField","timeAttribute","gmfDatasourceOGC","filterRulesWatcherUnregister","hasFilters","isVisible","handleDataSourceFilterRulesChange_","timeLowerValueWatcherUnregister","timeUpperValueWatcherUnregister","wmsLayer","handleDataSourceTimeValueChange_","treeDataSource","_source$updateParams","layersParam","layersList","filterParam","hasFilter","wmsLayerName","dsLayer","currentTimeParam","previousBackgroundLayer","currentBackgroundLayer","gmfDatasourceWFSAliases","gmfDatasourceDataSourceBeingFiltered","gmfDatasourceExternalDataSourcesManager","gmfDatasourceHelper","gmfDatasourceManager","ngeoCreatePopup","createPopup_","messages_","closeMessage_","getMessageUid_","showInPopup","popup","button","ngeoMessagePopup","ngeoMessageDisclaimer","ngeoDisclaimer","external","visibility","msgs_","disclaimer_","eventHelper_","dataLayerGroup_","registerLayer_","handleLayersAdd_","handleLayersRemove_","unregisterLayer_","layerUid","showDisclaimerMessage_","closeDisclaimerMessage_","SavedFilters_classCallCheck","currentDataSourceId_","currentDataSourceItems_","localStorageKey_","items_","items","rePopulateCurrentDataSourceItems_","loadItemsFromLocalStorage_","JSON","parse","indexOfItem","idx","saveItemsInLocalStorage_","stringify","SavedFilters_createClass","Item","customRules","directedRules","ngeoDrawComponent","ngeoMiscDatepickerComponent","ngeoRuleTemplateUrl","RuleController_","_operators","_operatorsShortFormat","ruleComponent_classCallCheck","featureOverlay","toolGroup","operatorType","spatialOperatorType","temporalOperatorType","operatorsShortFormat","timeRangeMode","widget","createDate_","createWeekAgoDate_","interval","timeValueMode","toolActivate_","unlisteners_","drawActive","drawToolActivate","drawnFeatures","selectedFeatures","ngeoInteractionModify","handleActiveChange_","supportedTypes","hasExpression","isActive","editToolIsActive","toggle","toggleChoiceSelection","onDateSelected","onDateRangeSelected","opt_timeDelta","setTime","timeToDate","toLocaleDateString","oldActive","ruleFeature","cloneFeature","drawnFeature","getRuleGeometryType","removeMenu_","ngeoFilterRuleComponent","ngeoQueryMapQuerent","ngeoFilterTemplateUrl","aRuleIsActive","datasource","FilterController_","ngeoMapQuerent","component_classCallCheck","ngeoMapQuerent_","geometryAttributes","otherAttributes","ruleUnlisteners_","handleARuleIsActiveChange_","registerRule_","hasARule","getRulesWithValue_","getData","createAndAddCustomRule","setCondition","removeCustomRule","unregisterRule_","handleRuleActiveChange_","unlistener","ngeoMapFeatureOverlayMgr","ngeoFilterComponent","gmfFiltersSavedFilters","gmfFilterselectorTemplateUrl","gmfDataSourceBeingFiltered","gmfDataSourcesHelper","gmfSavedFilters","ngeoFeatureOverlayMgr","filterselectorComponent_classCallCheck","handleSelectedDataSourceChange_","gmfDataSourcesHelper_","currentDataSourceItems","saveFilterManageModalShown","gmfUser_","handleGmfUserFunctionalitiesChange_","filtrableDataSources","filtrableLayerNodeNames_","gmfDataSources_","readyDataSource","ruleCache_","saveFilterSaveModalShown","saveFilterName","enableDataSourceRegistration_","handleEnableDataSourceRegistrationChange_","defaultFiltrableDataSourceName_","toggleDataSourceRegistration_","usrFunc","newDataSourceRegistration","register","isDataSourceFiltrable_","opt_notify","gettext","msgs","p1","p2","p3","currentDataSourceId","getRuleCacheItem_","setRuleCacheItem_","directedFilterAttributes","directedAttributes","saveFilterShowModal","saveFilterSave","alreadyExist","saveFilterLoadItem","filterItem","saveFilterManage","saveFilterRemoveItem","RuleCache","RuleCacheItem","gmfFiltersFilterselectorComponent","pre","preLink","sliderOptions","onSliderReleased_","computeDates_","sliderUi","sDate","eDate","wmstime","getClosestValue_","dates","isModeRange","timeValueList","getTimeValueList_","initialOptions_","maxNbValues","endDate","nextDate","timestamp","leftIndex","rightIndex","leftDistance","rightDistance","targetDate","startDate","bestDate","getLocalizedDate","gmfLayertreeComponent","gmfLayertreeDatasourceGroupTreeComponent","gmfLayertreeTimeSliderComponent","gmfPermalinkPermalink","gmfPermalinkShareService","gmfPermalinkShareComponent","prop","olMap","setTarget","manageResizeAttr","manageResizeProp","manageResize","resizeTransitionAttr","resizeTransitionProp","resizeTransition","now","loop","adjustSize","updateSize","renderSync","requestAnimationFrame","ngeoScaleselectorTemplateUrl","ScaleselectorController","scalesExpr","scales","zoomLevels","newLength","sort","optionsExpr","getOptions_","resolutionChangeKey_","currentScale","currentZoom","getZoom","handleViewChange_","registerResolutionChangeListener_","dropup","zoom","changeZoom","setZoom","handleResolutionChange_","ngeoMapComponent","ngeoMapRecenter","ngeoMapResizemap","ngeoMapScaleselector","gmfPermalinkModule","ngeoMapModule","gmfPermalink","ngeoFeatureOverlayMgr_","gmfPermalink_","gmfMapMousepositionTemplateUrl","projections","control_","initOlControl_","removeControl","formatFn","filterAndArgs","olControlMousePosition","className","coordinateFormat","undefinedHTML","addControl","code","gmfMapComponent","gmfMapMousepositionComponent","columnDefs","selectedRows","getRowUid","isRowSelected","getSelectedCount","getSelectedRows","row","selectRow","toggleRow","isSelected","selectAll","unselectAll","rowId","invertSelection","ngeoGridConfig","ngeoGridTemplateUrl","configuration","sortedBy","sortAscending","floatTheadConfig","scrollContainer","$table","columnName","asc","attributes1","attributes2","clickRow","shiftKey","isShiftKeyOnly_","platformModifierKey","isPlatformModifierKeyOnly_","clickRow_","selectRange_","targetUid","posClickedRow","posSelectedRows","currentRow","currentUid","posClosestRow","currentPos","currentDistance","rangeStart","rangeEnd","preventTextSelection","altKey","metaKey","ctrlKey","ngeoDownloadCsv","ngeoGridComponent","gmfDisplayquerygridTemplateUrl","featuresStyleFn","selectedFeatureStyleFn","getMapFn","removeEmptyColumnsFn","maxResultsFn","maxRecenterZoomFn","mergeTabs","ngeoCsvDownload","queryOptions","ngeoCsvDownload_","maxResults","gridSources","loadedGridSources","selectedTab","removeEmptyColumns_","maxRecenterZoom","featuresForSources_","highlightFeatures_","filename_","newQueryResult","oldQueryResult","updateData_","unregisterSelectWatcher_","featuresOverlay","featuresStyle","highlightFeaturesOverlay","highlightFeatureStyle","mapFn","getGridSources","sourceLabel","hasOneWithTooManyResults_","getMergedSources_","makeGrid_","escapeValue","collectData_","firstSourceId","selectTab","isInteger","toEscape","gridSource","allSources","mergedSources","mergedSource","getMergedSource_","mergedSourceId","mergeSourceId","currentMergeSourceId","sourceLabels","containsSource","mergeSource","allProperties","featureGeometriesNames","featuresForSource","featureGeometryName","cleanProperties_","gridCreated","removeEmptyColumnsFn_","keysToKeep","keyToRemove","gridConfig","getGridConfiguration_","ol_uid","columns","column","newSelected","oldSelectedRows","onSelectionChanged_","updateFeatures_","reflowGrid_","activePane","removeClass","getActiveGridSource","isOneSelected","getSelectedRowCount","zoomToSelection","maxZoom","downloadCsv","startDownload","MOVE_BUFFER_RADIUS","POINTER_EVENTS","mouse","move","touch","pointer","touches","changedTouches","clientX","clientY","getEvents","pointerTypes","eventType","pointerType","eventName","eventHandlers","totalX","totalY","startCoords","lastPos","events","makeSwipeDirective_","directiveName","direction","$verticalSwipe","MAX_HORIZONTAL_DISTANCE","MAX_HORIZONTAL_RATIO","MIN_VERTICAL_DISTANCE","swipeHandler","valid","validSwipe","deltaY","deltaX","isDefined","triggerHandler","$event","ngeoMiscSwipe","$animateProvider","classNameFilter","gmfDisplayquerywindowTemplateUrl","draggableContainment","defaultCollapsedFn","desktop","showUnqueriedLayers","collapsed","showUnqueriedLayers_","sourcesFilter","selectedSource","currentResult","isNext","updateQueryResult_","windowContainer","containment","minHeight","minWidth","setCurrentResult_","collectFeatures_","highlightCurrentFeature_","setHighlight","hasChanged","lastFeature","getResultLength","animate_","positionMax","queryResult","isFirst","isLast","getFeatureValues","opt_lastFeature","setSelectedSource","gmfQueryGridComponent","gmfQueryWindowComponent","gmfSearchComponent","gmfSearchFulltextSearch","gmfThemeManager","gmfThemeSelectorTemplateUrl","setThemes_","setTheme","gmfThemeSelectorComponent","ngeoMessageDisplaywindowTemplateUrl","displaywindowComponent_classCallCheck","clearOnClose","contentTemplate","contentScope","compile_","updateContentTemplate_","compiled","displayWindow","empty","clear_","displaywindowComponent_createClass","trustAsResourceUrl","control","olControlControl","fileContent","changeEvent","fileReader","FileReader","onload","readAsText","files","availableLanguages","nav","browserLanguages","languages","language","browserLanguage","systemLanguage","userLanguage","supportedLanguages","ngeoMiscAutoProjection","ngeoMiscControlComponent","ngeoMiscDebounce","ngeoMiscFilereaderComponent","ngeoMiscGetBrowserLanguage","ngeoMiscSortableComponent","clickEventKey_","pointerMoveEventKey_","sourceids","hit","forEachLayerAtPixel","activate_","cursorHover","deactivate_","WfsPermalinkService","ngeoWfsPermalinkOptions","maxFeatures_","wfsTypes_","wfsTypes","wfsType","defaultFeatureNS_","defaultFeatureNS","defaultFeaturePrefix_","defaultFeaturePrefix","pointRecenterZoom_","pointRecenterZoom","clearResult_","typeName","createFilters_","filterGroups","issueRequest_","showFeatures","padding","getExtent_","resultSource","reduce","createFiltersForGroup","filterGroup","filterDef","or_","cond","equalTo","and_","joinFilters_","joinFn","combinedFilters","currentFilter","permalink_","gmfAuthentication","updateHasEditableLayers_","loginRedirectUrl","loginInfoMessage","loginActive","unbind","userChange","roleId","filterSelectorEnabled","open_panel","filterSelectorActive","previousThemeName","defaultThemeNameFromFunctionalities","setDefaultBackground_","searchDatasources","labelKey","groupValues","groupActions","srid","gmfDataSourcesManager","defaultDimensions","dim","leftNavVisible","rightNavVisible","queryFill","queryStroke","queryFeatureStyle","queryActive","queryAutoClear","printPanelActive","printActive","measurePointActive","measureLengthActive","drawFeatureActive","drawProfilePanelActive","getBrowserLanguage","stateManager","tmhDynamicLocale","defaultLang","langUrls","initLanguage","mapTools","mapToolsGroup","queryToolActivate","measurePointActivate","measureLengthActivate","drawFeatureActivate","drawProfilePanelActivate","printPanelActivate","$root","updateCurrentBackgroundLayer_","skipPermalink","background","getBackgroundLayer","defaultBasemapArray","default_basemap","defaultBasemapLabel","gmfx","openIframePopup","opt_width","opt_height","opt_apply","displaywindowUrl","openPopup_","openTextPopup","displaywindowContent","displaywindowTitle","displaywindowOpen","displaywindowWidth","displaywindowHeight","cgxp","tools","openInfoWindow","displaywindowDraggableContainment","getLayerByLabels","labels","switchLanguage","setCurrentLanguage","loadRemote","urlLanguage","getLocationIcon","arrow","arrowWrapper","gmfAuthenticationModule","gmfBackgroundlayerselectorComponent","gmfDatasourceModule","gmfDisclaimerComponent","gmfFiltersModule","gmfLayertreeModule","gmfMapModule","gmfQueryExtraModule","gmfSearchModule","gmfThemeModule","ngeoMessageDisplaywindowComponent","ngeoMiscExtraModule","ngeoQueryMapQueryComponent","ngeoStatemanagerModule","ngeoStatemanagerWfsPermalink","tmhDynamicLocaleProvider","angularLocaleScript","localeLocationPattern","handleDragEvent_","vertexFeature_","lastPixel_","rBush_","olStructsRBush","snappedToVertex_","dragSegments_","writeCircleGeometry_","handlePointerAtPixel_","removeFeatureSegmentData_","rBush","nodesToRemove","rings","segment","segmentData","insert","createOrUpdateVertexFeature_","vertexFeature","compareIndexes_","vertexExtent","segmentDataMatches","getInExtent","componentSegments","segmentDataMatch","olCoordinate","fromCircle","setGeometryCoordinates_","olMapBrowserPointerEvent","handled","getInteracting","handlingDownUpSequence","pixelCoordinate","sortByDistance","lowerLeft","upperRight","box","closestSegment","vertexPixel","getPixelFromCoordinate","pixel1","pixel2","squaredDist1","squaredDist2","dist","vertexSegments","vectorPoints_","params_","featureGeom","pointSource","corners","pointFeatures","cornerPoint","cornerFeature","corner","siblingX","siblingY","boxFeature","previousFeature","nextFeature","initializeParams_","origin","originPoint","originCoordinate","originPixel","siblingXPoint","siblingXCoordinate","siblingXPixel","vectorX","vectorXMagnitude","siblingYPoint","siblingYCoordinate","siblingYPixel","vectorY","vectorYMagnitude","destinationPixel","b2Pixel","calculateNewPixel_","b2Coordinate","c2Pixel","c2Coordinate","destination","vector","aVector","abScalarProduct","deltaVector","ModifyParams","otherFeatures_","circleFeatures_","ngeoInteractionModifyCircle","rectangleFeatures_","ngeoInteractionModifyRectangle","getFeatureCollection_","isCircle","isRectangle","ngeoFeatures","featureHelper_","ngeoFeatures_","drawPoint","measureLength","measureArea","measureAzimut","drawRectangle","drawText","interaction_","registerInteraction","handleActiveChange","getUid","listen","handleDrawEnd","sketch","ngeoDrawFeatures","drawFeatureCtrl","maxPoints","ngeoDrawController","contMsg","ngeoInteractionMeasureArea","ngeoInteractionMeasureLength","ngeoDrawPoint","ngeoDrawRectangle","ngeoDrawText","ngeoMeasureArea","ngeoMeasureAzimut","ngeoMeasureLength","filter_","handleDrawEnd_","promises_","handleGetAttributes_","gmfRasterUrl","getRaster","Param","X","handleGetRaster_","Proj","ngeoColorpickerTemplateUrl","colors","DEFAULT_COLORS","setColor","stringToCoordinates","getProjectionList","projectionsCodes","toUpperCase","tryProjections","viewProjection","opt_projections","tryProjectionsWithInversion","defaultParams_","query","queryParams","Promise","encoding_","extension_","includeHeader_","quote_","separator_","generateCsv","translatedColumnHeaders","columnHeader","header","getRow_","dataRows","rowValues","matchAllQuotesRegex","doubleQuote","stateExpr","animationDelayKey","animationDelay","cancelAnimationFrame","gmfPermalinkShareTemplateUrl","enableEmail","ShareComponentController","gmfShareService","gmfShareService_","shortLink","showLengthWarning","successfullySent","errorOnsend","errorOnGetShortUrl","when","permalink","$valid","gmfLayertreeDatasourceGroupTreeTemplateUrl","getGroupUid","toggleDataSource","ngeoDebounce","mapViewPropertyChangeEventKey_","ngeoDebounce_","featureOverlay_","gmfPermalinkOptions","useLocalStorage","crosshairEnabledByDefault_","crosshairEnabledByDefault","gmfExternalDataSourcesManager_","gmfObjectEditingManager_","gmfThemeManager_","defaultTheme_","ngeoWfsPermalink_","ngeoAutoProjection_","sourceProjections_","projectionCodes","crosshairFeature_","crosshairStyle_","crosshairStyle","olStyleIcon","src","mapTooltip_","featureHashFormat_","ngeoFormatFeatureHash","encodeStyles","propertiesType","fillOpacity","fontColor","fontSize","isBox","isLabel","pointRadius","strokeColor","handleBackgroundLayerManagerChange_","ParamPrefix","TREE_ENABLE","gmfLayerNames","TREE_GROUP_LAYERS","stateName","TREE_OPACITY","TREE_GROUP_OPACITY","getFeatures","addNgeoFeature_","handleNgeoFeaturesAdd_","handleNgeoFeaturesRemove_","setThemeInUrl_","setExternalDataSourcesStatePromise_","initExternalDataSources_","handleExternalDSGroupCollectionAdd_","handleExternalDSGroupCollectionRemove_","registerExternalDSGroup_","initLayers_","getMapCenter","targetProjection","reprojectedCenter","getMapZoom","getMapCrosshair","crosshair","setMapCrosshair","opt_center","crosshairCoordinate","getMapTooltip","setMapTooltip","tooltipText","tooltipPosition","div","ngeoPopover","DIMENSIONS","unregisterMap_","getFeature","registerMap_","oeFeature","enabled3d","ngeoOlcsConstants","Permalink3dParam","ENABLED","setCenter","wfsPermalinkData","getWfsPermalinkData_","getBackgroundLayerOpacity","opacity_","refreshFirstLevelGroups","groupNodes","orderedNames","themeInUrl_","pathElements","indexOfTheme","defaultThemeName","decodeURI","tn","defaultTheme","default_theme","initialUri","href","authenticationRequired","groupsNames","enable","groupLayers","groupLayersArray","removeNgeoFeature_","handleNgeoFeaturesChange_","wfsLayer","numGroups","WFS","createFilterGroup_","showFeaturesParam","paramKey","gmfExtDSManager","layerNamesString","urlsString","ExtDSSeparator","LIST","urls","groupLayerNamesString","groupLayerNames","NAMES","serviceType","getCapabilitiesDefer","_ret","responses","setExternalDataSourcesState_","dataSourcesCollection","containsLayerName","unregisterExternalDSGroup_","_this9$ngeoStateManag","wmsGroupLayerNames","wmsDataSource","wmtsGroupLayerNames","wmtsDataSource","startsWith","_iterator15","_isArray15","_i15","_ref15","OpenLayersLayerProperties","regexp","key1","key2","ngeoDatePickerTemplateUrl","sdateOptions","initialMinDate","initialMaxDate","onClose","selectedDate","datepicker","edateOptions","dp","ngeoTime","ngeoTime_","changeMonth","changeYear","sdate","edate","$watchGroup","newDates","oldDates","isDate","geomRegex","promiseId","handleGetAttributeValues_","isValidFileSize","fileSize","isWmsGetCap","isWmtsGetCap","readyState","LOADING","abort","onerror","reason","onprogress","load","opt_cancelP","viewConfig","mapViewConfig","gmfControllersAbstractAppController","mapPixelRatio","controls","mapControls","olControlScaleLine","getElementById","olControlZoom","zoomInTipLabel","zoomOutTipLabel","olControlRotate","tipLabel","mapInteractions","olInteraction","pinchRotate","altShiftDragRotate","loadTilesWhileAnimating","loadTilesWhileInteracting","toolsActive","modalShareShown","editFeatureActive","routingfeatureActive","googleStreetViewActive","googleStreetViewStyle","importDataSourceActive","tooltip","trigger","selector","off","drawFeatureLayer","editFeatureVectorLayer","editFeatureActivate","googleStreetViewActivate","scaleSelectorOptions","profileLine","gmfContextualdataModule","gmfDrawingModule","gmfEditingModule","gmfPrintComponent","gmfProfileModule","gmfRasterComponent","ngeoQueryBboxQueryComponent","gmfImportModule","gmfRasterRasterService","gmfRaster","$compile_","gmfRaster_","gmfContextualdataOptions_","hidePopover","preparePopover_","setContent_","showPopover","content_","mapProjection","getRasterSuccess","getRasterError","rasterParams","setAttribute","autoPan","autoPanAnimation","contentDirective_","gmfContextualdatacontentTemplateUrl","gmfContextualdataComponent","opt_options","olFormatTextFeature","accuracy_","accuracy","ACCURACY_","encodeStyles_","propertiesFunction_","defaultPropertiesFunction_","setStyle_","prevX_","prevY_","LegacyProperties_","defaultValues_","StyleTypes_","LineString","ngeoFormatFeatureHashStyleType","Point","Polygon","MultiLineString","MultiPoint","MultiPolygon","readFeature","CHAR64_","encodeSignedNumber_","num","signedNum","encodeNumber_","encodedNumber","geometryType","encodedStyles","styleType","getFill","imageStyle","getImage","strokeStyle","getStroke","textStyle","getText","encodeStylePolygon_","encodeStyleLine_","encodeStylePoint_","encodeStyleText_","encodeStyleStroke_","encodeStyleFill_","opt_propertyName","getColor","fillColorRgba","fillColorHex","strokeColorRgba","strokeColorHex","getWidth","fontStyle","getFont","readLineStringGeometry_","flatCoordinates","decodeCoordinates_","setFlatCoordinates","olGeomGeometryLayout","XY","readMultiLineStringGeometry_","ends","lineStrings","multiLineString","readPointGeometry_","readMultiPointGeometry_","multiPoint","readPolygonGeometry_","readMultiPolygonGeometry_","endss","polygons","multipolygon","setStyleInFeature_","getStyleProperties_","setStyleProperties_","castValue_","numProperties","boolProperties","parts","part","keyVal","writeLineStringGeometry_","getFlatCoordinates","stride","getStride","encodeCoordinates_","writeMultiLineStringGeometry_","getEnds","lineStringCount","textArray","writePointGeometry_","writeMultiPointGeometry_","encodeRings_","linearRingCount","writePolygonGeometry_","writeMultiPolygonGeometry_","getEndss","polygonCount","GEOMETRY_READERS_","GEOMETRY_WRITERS_","opt_flatCoordinates","encodedCoordinates","readFeatureFromText","splitIndex","geometryText","readGeometryFromText","attributesAndStylesText","attributesText","stylesText","readFeaturesFromText","geometryReader","writeFeatureText","encodedParts","encodedGeometry","writeGeometryText","encodedProperties","propFunction","encoded","getStyleFunction","writeFeaturesText","geometryWriter","transformedGeometry","olFormatFeature","gmfEditingEditFeatureComponent","selectedEditableTreeCtrl","updateEditableTreeCtrls","editables","editableTreeCtrls","treeCtrlsWatcherUnregister_","stopEditing","gmfEditingEditFeatureSelectorComponent","geojsonFormat","PrintStyleType","PrintStyleTypes_","encodeVectorLayer","geojsonFeatures","mapfishStyleObject","version","originalFeature","styleData","origGeojsonFeature","writeFeatureObject","isOriginalFeatureAdded","geojsonFeature","styledFeature","featureStyleProp","styleId","encodeVectorStyle","geojsonFeatureCollection","geoJson","styleObject","symbolizers","encodeVectorStylePolygon","encodeVectorStyleLine","encodeVectorStylePoint","encodeTextStyle","encodeVectorStyleFill","symbolizer","encodeVectorStyleStroke","URL","getSrc","externalGraphic","graphicOpacity","graphicWidth","graphicHeight","getPoints","graphicName","sizeShape","rotationShape","opacityShape","strokeShape","fillShape","strokeOpacity","strokeDashstyle","getLineDash","strokeLineCap","getLineCap","strokeLinecap","xAlign","yAlign","olTextAlign","getTextAlign","olTextBaseline","getTextBaseline","labelAlign","labelRotation","fontWeight","fontFamily","haloColor","haloOpacity","haloRadius","labelXOffset","getOffsetX","labelYOffset","getOffsetY","vectorEncoder","ngeoPrintVectorEncoder","printNativeAngle_","ref","opt_httpConfig","httpConfig","createSpec","dpi","layout","customAttributes","specMap","encodeMap_","currentLanguage","spec","viewCenter","viewResolution","mapLayerGroup","layer_a","layer_b","getZIndex","encodeLayer","encodeImageLayer_","encodeTileLayer_","encodeImageWmsLayer_","getUrl","encodeWmsLayer_","url_url","customParams","searchParams","baseURL","getAbsoluteUrl_","imageFormat","getOpacityOrInherited_","useNativeAngle","encodeURI","encodeTileWmtsLayer_","encodeTileWmsLayer_","tileGrid","getTileGrid","olTilegridWMTS","matrixIds","getMatrixIds","matrices","tileRange","getFullTileRange","identifier","scaleDenominator","getMetersPerUnit","tileSize","olSize","getTileSize","topLeftCorner","getOrigin","matrixSize","maxX","minX","maxY","minY","getDimensions","dimensionKeys","getWmtsUrl_","dimensionParams","getFormat","getMatrixSet","requestEncoding","getRequestEncoding","getVersion","getUrls","createReport","printSpec","getStatus","getReportUrl","getCapabilities","createPrintServiceFactory","ngeoMiscColorpickerComponent","handleColorSet_","handleFeatureSet_","propName","newColor","currentColor","getSetAngle","getSetProperty_","getSetName","getSetShowLabel","getSetOpacity","getSetShowMeasure","getSetSize","getSetStroke","gmfDrawingFeatureStyleComponent","ngeoEditingExportfeaturesComponent","longPressTimeout_","selectedFeature","listSelectionInProgress_","nameProperty","drawUid","selectFeatureFromList","getFeaturesArray","clearFeatures","handleMapTouchStart_","handleMapTouchEnd_","handleCancelKeyEvent_","setTimeout","clearTimeout","gmfDrawingDrawFeatureComponent","gmfWmscapabilitylayertreenodeTemplateUrl","gmfExternalDataSourcesManager","createAndAddDataSource","gmfWmtscapabilitylayertreTemplateUrl","wmtsCapabilityLayertreeComponent_classCallCheck","gmfImportWmsCapabilityLayertreeComponent","gmfImportWmtsCapabilityLayertreeComponent","gmfImportdatasourceTemplateUrl","importdatasourceComponent_classCallCheck","fileInput_","hasError","hasErrorPromise_","Mode","ONLINE","modes","LOCAL","wmsCapabilities","wmtsCapabilities","serversEngine_","servers","serverUrls","Bloodhound","datumTokenizer","datum","originalDatumTokenizers","tokenizers","whitespace","datumTokenizers","originalDatumTokenizer","queryTokenizer","identify","local","$urlInput","$connectBtn","typeahead","hint","highlight","minLength","ttAdapter","ev","suggestion","focus","browse","connect","startWorking_","stopWorking_","opt_hasError","nameAndSize","gmfImportImportdatasourceComponent","typeaheadOptionsExpr","typeaheadOptions","typeaheadDatasetsExpr","typeaheadDatasets","typeaheadListenersExpr","typeaheadListeners_","typeaheadListeners","adaptListeners_","dataset","cursorchange","autocomplete","datasetsempty","opt_filter","opt_featureProjection","opt_dataProjection","opt_remoteOptions","bloodhoundOptions","remote","prepare","settings","parsedResponse","featureCollection","remoteOptions","Function","sourceProjection","ngeoProjEPSG21781","parseBbox","regex","removeHtmlTags","extractName","origins","results","geom_st_box2d","bhOptions","ngeoSearchSearchDirective","ngeoSearchCreateGeoJSONBloodhound","ngeoSearchCreateLocationSearchBloodhound","d3","bisector","axisBottom","axisLeft","scaleLinear","light","margin","top","right","bottom","left","hoverCallback","outCallback","distanceExtractor","linesConfiguration","numberOfLines","bisectDistance","poiExtractor","styleDefs","poiLabelAngle","i18n","xAxisLabel","xAxis","yAxisLabel","yAxis","formatter","xhover","units","toPrecision","yhover","ele","xtick","ytick","lightXAxis","svg","scaleModifier","xFactor","xUnits","xDomain","profile","selection","each","clientWidth","clientHeight","y0","firstLineName","zExtractor","svgEnter","enter","gEnter","clearPois","xHover","domain","yDomain","elevationsValues","every","isFinite","transition","yHover","defined","tickFormat","tickValues","ticks","tickSize","mouseout","mousemove","mouseX","x0","invert","clearHighlight","elevation","elevations","elevationsRef","lineName","xtranslate","yUnits","showPois","pois","pe","profileData","ps","poiEnterG","exit","optionsAttr","elevationData","poiData","origHoverCallback","origOutCallback","ngeoProfileD3Elevation","refreshData","ngeoProfileElevationComponent","gmfProfileTemplateUrl","getLinesConfigurationFn","getHoverPointStyleFn","getNbPointsFn","getOptionsFn","gmfProfileJsonUrl","pointHoverOverlay_","gmfProfileJsonUrl_","linesConfiguration_","layersNames_","nbPoints_","currentPoint","profileHighlight","measureTooltip_","snappedPoint_","profileLabels_","profileOptions","pointerMoveKey_","isErrored","updateEventsListening_","newLine","oldLine","update_","hoverPointStyle","hoverPointStyleFn","lineConfig","getZFactory_","getDist_","hoverCallback_","outCallback_","optionsFn","getJsonProfile_","onPointerMove_","getEventCoordinate","closestPoint","getClosestPoint","eventToLine","pixelDist","getDistanceOnALine_","pointOnLine","distOnLine","fakeExtent","firstPoint","lastPoint","getTooltipHTML_","separator","elevationName","translatedElevationName","DistDecimal","int_value","lineConfiguration","getLayersNames","getZFn","nbPoints","method","paramSerializer","getProfileDataSuccess_","getProfileDataError_","hasDistance","rows","getStyleFn","overlay","styleFn","gmfProfileComponent","gmfProfileDrawLineComponent","olInteractionDragBox","handleBoxEnd","gmfElevationwidgetTemplateUrl","layersconfig","loading","toggleActive_","layersConfig","inViewport_","pointerStop_","getRasterSuccess_","getRasterError_","custom_args","widgetComponent_","WidgetController_","selectedElevationLayer","LayerConfig","ngeoPrintService","ngeoPrintUtils","PrintStateEnum","NOT_IN_USE","PRINTING","ERROR_ON_REPORT","CAPABILITIES_NOT_LOADED","ERROR_ON_GETCAPABILITIES","gmfPrintTemplateUrl","rotateMask","fieldValues","hiddenAttributeNames","attributesOut","optionsLegendType","optionsType","ngeoCreatePrint","gmfPrintUrl","gmfPrintState","gmfPrintState_","featureOverlayLayer_","ngeoPrintUtils_","ngeoPrint_","ngeoQueryResult_","scaleInput","gmfLegendOptions_","useBbox","legend","requestCanceler_","statusTimeoutPromise_","onDragPreviousMousePosition_","rotationTimeoutPromise_","postComposeListenerKey_","pointerDragListenerKey_","mapViewResolutionChangeKey_","curRef_","formats_","layouts_","layout_","paperSize_","layoutInfo","scaleManuallySelected_","rotationInput_","setRotation","postcomposeListener_","capabilities_","currentThemes_","updateRotation_","togglePrintPanel_","print","currentThemes","getSizeFn","getRotationFn","getScaleFn","getOptimalScale_","getCapabilities_","parseCapabilities_","onPointerDrag_","render","layouts","updateFields_","mapInfo","isAttributeInCurrentLayout_","clientInfo","updateCustomFields_","dpis","rawType","simpleAttributes","previousAttributes","default","p0x","p0y","p1x","p1y","centerToP0","centerToP1","sense","boost","increment","$digest","getDataSource_","getLegend_","setView","ol_layers","new_ol_layers","print_native_angle","server_name","layer_names","printLayers","setLayerGroup","handleCreateReportSuccess_","handleCreateReportError_","resetPrintStates_","opt_printState","datasourceObj","datasourceArr","tanslateColumns","table","mfResp","getStatus_","handleGetStatusSuccess_","classes","icons","getMetadataLegendImage_","serverType_","legendImage","setLayout","layoutName","getSetScale","contrainRes","constrainResolution","setResolution","setDpi","isState","stateEnumKey","fromJson","ngeoMiscDatetimepickerComponent","ngeoAttributesTemplateUrl","disabled","form","updating_","handleInputChange","$menu","aria-labelledby","$item","handleMenuItemClick_","handleElementClick_","parentElement","sortable","resetUpDragDrop","optionsObject","callbackFn","callbackCtx","sortableElement","sortableOptions","axis","ui-sortable-helper","ui","oldIndex","newIndex","defaultHandleClassName","handleClassName","ngeoPopoverCtrl","anchorElm","popover","bodyElm","shown","placement","dismissPopover","anchorComponent","contentComponent","hide","PopoverController_","onMouseDown","clickEvent","ngeoSearchModule","ngeoMessagePopoverComponent","gmfSearchTemplateUrl_","gmfSearchTemplateUrl","inputValue","placeholder","datasources","featuresStyles","clearButton","colorChooser","coordinatesProjections","additionalListeners","onInitCallback","SearchController_","ngeoAutoProjection","fullTextSearch_","ngeoSearchCreateGeoJSONBloodhound_","styles_","datasets","displayColorPicker","listeners","coordProj","initStyles_","getSearchStyle_","initDatasets_","setStyleColor","mergeListeners_","select_","close_","datasetsempty_","searchQuery","resultIndex","mapZoom","fulltextsearch_","filterLayername_","filterAction_","createDataset_","datasetTitle","groupsKey","typeaheadDatasetOptions","createSearchCoordinates_","display","templates","componentScope","compile","bloodhoundEngine","createAndInitBloodhound_","typeaheadDataset","act","opt_layerName","featureLayerName","mapProjectionCode","getBloodhoudRemoteOptions_","bloodhound","initialize","rateLimitWait","xhrFields","suggestions","tt_source","radius2","customStyles","imageStrokeStyle","imageFillStyle","setImage","changed","setTTDropdownVisibility_","ttDropdown","onClearButton","ttmenu","inputs","blur","layer_name","leaveSearch_","selectFromGMF_","featureGeometry","_loop2","actionName","actionData","datasourcesActionsHaveAddLayer","groupAction","silent","fitArray","menu","opt_zoom","fitOptions","recenter","selected","selectedIndex","arr1","arr2","dereg1","dereg2","ngeoLayertreeTemplateUrl","__webpack_exports__","originalEl","closeEl_","contentEl_","one","ngeoLayertreeComponent","subTemplateUrl","gmfLayertreeTemplate","openLinksInNewWindow","gmfSyncLayertreeMap","gmfSyncLayertreeMap_","groupNodeStates_","ngeoMiscSyncArrays","updateDimensions_","updateLayerDimensions_","once","toggleActive","getNodeState","updateWMSTimeLayerState","layertreeCtrl","getLegendIconURL","iconUrl","legendRule","gmfOgcServer","getLegendsObject","legendsObject","gmfLayerDefaultName","wmtsLegendURL","layersNames","getScale_","getNumberOfLegendsObject","mpu","displayMetadata","metadataURL","afterReorder","currentTreeCtrls","removeNode","removeAllNodes","nodesCount","getResolutionStyle","zoomToResolution","toggleNodeLegend","legendNodeId","toggleFiltrableDataSource","isNodeLegendVisible","supportsCustomization","supportsLegend","supportsOpacityChange","$compileProvider","debugInfoEnabled","toXY","nesting","olGeomSimpleGeometry","gmfObjecteditingCoordinate","getQueryableLayerNodesDefered_","getQueryableLayersInfo","allQueryableLayersInfo","getQueryableLayersInfoFromThemes","queryableLayersInfo","layerNode","k","kk","getFeatureInfo","layerInfo","infoFormat","QUERY_LAYERS","gmfObjecteditingQuery","gmfObjectEditingQuery","gmfObjectEditingQuery_","angle_","radius_","sides_","sides","enable_","disable_","makeRegular","interactionListenerKey_","ngeoInteractionDrawRegularPolygonFromClick","gmfObjecteditingGetWMSFeatureComponent","ngeoEditingCreateregularpolygonfromclickComponent","copyFromActive","deleteFromActive","process","queryableLayerInfo","requiresLayer","geomTypePolygon","toolActiveNames_","registerTool_","ProcessType","ADD","eraseActive","DELETE","drawTriangleActive","triangleAngle","oeToolsOptions","triangleRadius","regularPolygonRadius","toolActiveName","opt_requiresLayer","handleToolActiveChange_","NAMESPACE_","toolActivate","gmfObjecteditingToolsComponent","gmfObjecteditingTemplateUrl","layerNodeId","Controller","selectedQueryableLayerInfo","queryableLayerListShown","featureHasGeom","skipGeometryChange_","jstsOL3Parser_","OL3Parser","LinearRing","GeometryCollection","geometryChanges_","defaultStyles_","defaultStylesWoVertice_","dirtyStyles_","dirtyStylesWoVertice_","modifyToolActivate_","toolsToolActivate_","handleGetQueryableLayersInfo_","UPDATE","INSERT","defaultColor","dirtyColor","initializeStyles_","setFeatureStyle_","gmfObjecteditingGeom","resetGeometryChanges_","handleDeleteFeature_","undo","cloneGeometry_","isStateInsert","refreshWMSLayer_","handleModifyInteractionModifyEnd_","handleWindowBeforeUnload_","handleSketchFeaturesAdd_","undoAllChanges_","jstsGeom","jstsBuffered","write","opt_incVertice","incVertice","rgbaColor","modifyActive","returnValue","sketchGeom","jstsSketchGeom","jstsProcessedGeom","union","intersects","difference","processedGeom","layersInfo","getFeatureDefered_","GEOM_TYPE","ID","PROPERTY","THEME","getGeomType","getLayerNodeId","gmfObjecteditingComponent","gmfObjecteditingManager","epsg2056def","epsg2056extent","oeEditActive","gmfControllersAbstractDesktopController","resolutions","oeEditToolActivate","gmfObjectEditingManager","oeGeomType","oeLayerNodeId","searchCoordinatesProjections","ngeoProjEPSG2056","scaleSelectorValues","elevationLayers","profileLinesconfiguration","aster","srtm","mousePositionProjections","raven","Raven","addPlugin","RavenPluginsAngular","install","appBase","gmfObjecteditingModule"],"mappings":"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AD,QAAA,6gFCAAC,EAAAD,QAAA,mjDCAAC,EAAAD,QAAA,m0ECAAC,EAAAD,QAAA,2sCCAAC,EAAAD,QAAA,6tCCAAC,EAAAD,QAAA,0jKCAAC,EAAAD,QAAA,ysCCAAC,EAAAD,QAAA,q5GCAAC,EAAAD,QAAA,6+GCAAC,EAAAD,QAAA,8pHCAAC,EAAAD,QAAA,soGCAAC,EAAAD,QAAA,ysBCAAC,EAAAD,QAAA,wUCAAC,EAAAD,QAAA,kxBCAAC,EAAAD,QAAA,+SCAAC,EAAAD,QAAA,u5FCAAC,EAAAD,QAAA,i+FCAAC,EAAAD,QAAA,0nCCAAC,EAAAD,QAAA,6jBCAAC,EAAAD,QAAA,2ICAAC,EAAAD,QAAA,omBCAAC,EAAAD,QAAA,4yECAAC,EAAAD,QAAA,svBCAAC,EAAAD,QAAA,w0RCAAC,EAAAD,QAAA,2iBCAAC,EAAAD,QAAA,kuCCAAC,EAAAD,QAAiBJ,EAAAyB,EAAuB,sCCAxCpB,EAAAD,QAAA,82GCAAC,EAAAD,QAAA,q8ECAAC,EAAAD,QAAA,kjOCAAC,EAAAD,QAAA,wsBCAAC,EAAAD,QAAA,2OCAAC,EAAAD,QAAA,+uBCAAC,EAAAD,QAAA","file":"oeedit.90b06b.js","sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t1: 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([425,0]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","const exports = {};\n\nexports.assert = function(condition, opt_message, var_args) {\n  return condition;\n};\n\nexports.assertNumber = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertString = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertFunction = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertObject = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertArray = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertBoolean = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertElement = function(value, opt_message, var_args) {\n  return value;\n};\n\nexports.assertInstanceof = function(value, type, opt_message, var_args) {\n  return value;\n};\n\nexports.assertObjectPrototypeIsIntact = function() {};\n\nexport default exports;\n","/**\n * @module ngeo.GeometryType\n */\n/**\n * @enum {string}\n * @export\n */\nconst exports = {\n  /**\n   * @type {string}\n   * @export\n   */\n  CIRCLE: 'Circle',\n  /**\n   * @type {string}\n   * @export\n   */\n  LINE_STRING: 'LineString',\n  /**\n   * @type {string}\n   * @export\n   */\n  MULTI_LINE_STRING: 'MultiLineString',\n  /**\n   * @type {string}\n   * @export\n   */\n  MULTI_POINT: 'MultiPoint',\n  /**\n   * @type {string}\n   * @export\n   */\n  MULTI_POLYGON: 'MultiPolygon',\n  /**\n   * @type {string}\n   * @export\n   */\n  POINT: 'Point',\n  /**\n   * @type {string}\n   * @export\n   */\n  POLYGON: 'Polygon',\n  /**\n   * @type {string}\n   * @export\n   */\n  RECTANGLE: 'Rectangle',\n  /**\n   * @type {string}\n   * @export\n   */\n  TEXT: 'Text'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.format.FeatureProperties\n */\n/**\n * @enum {string}\n * @export\n */\nconst exports = {\n  /**\n   * @type {string}\n   * @export\n   */\n  ANGLE: 'a',\n  /**\n   * @type {string}\n   * @export\n   */\n  COLOR: 'c',\n  /**\n   * @type {string}\n   * @export\n   */\n  IS_CIRCLE: 'l',\n  /**\n   * @type {string}\n   * @export\n   */\n  IS_RECTANGLE: 'r',\n  /**\n   * @type {string}\n   * @export\n   */\n  IS_TEXT: 't',\n  /**\n   * @type {string}\n   * @export\n   */\n  NAME: 'n',\n  /**\n   * @type {string}\n   * @export\n   */\n  SHOW_LABEL: 'b',\n  /**\n   * @type {string}\n   * @export\n   */\n  OPACITY: 'o',\n  /**\n   * @type {number}\n   * @export\n   */\n  AZIMUT: 'z',\n  /**\n   * @type {string}\n   * @export\n   */\n  SHOW_MEASURE: 'm',\n  /**\n   * @type {string}\n   * @export\n   */\n  SIZE: 's',\n  /**\n   * @type {string}\n   * @export\n   */\n  STROKE: 'k'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.format.AttributeType\n */\n/**\n * @enum {string}\n * @export\n */\nconst exports = {\n  /**\n   * @type {string}\n   */\n  BOOLEAN: 'boolean',\n  /**\n   * @type {string}\n   */\n  DATE: 'date',\n  /**\n   * @type {string}\n   */\n  DATETIME: 'datetime',\n  /**\n   * @type {string}\n   */\n  TIME: 'time',\n  /**\n   * @type {string}\n   */\n  GEOMETRY: 'geometry',\n  /**\n   * @type {string}\n   */\n  NUMBER: 'number',\n  /**\n   * @type {string}\n   */\n  SELECT: 'select',\n  /**\n   * @type {string}\n   */\n  TEXT: 'text'\n};\n\n\nexport default exports;\n","/**\n * @module gmf.theme.Themes\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport * as olBase from 'ol/index.js';\nimport * as olArray from 'ol/array.js';\nimport olCollection from 'ol/Collection.js';\nimport olEventsEventTarget from 'ol/events/EventTarget.js';\nimport olLayerTile from 'ol/layer/Tile.js';\n\n/**\n * The Themes service. This service interacts\n * with c2cgeoportal's \"themes\" web service and exposes functions that return\n * objects in the tree returned by the \"themes\" web service.\n *\n * @constructor\n * @struct\n * @extends {ol.events.EventTarget}\n * @param {angular.$http} $http Angular http service.\n * @param {angular.$injector} $injector Main injector.\n * @param {angular.$q} $q Angular q service\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {gmfx.ThemesOptions} gmfThemesOptions Themes options.\n * @ngInject\n * @ngdoc service\n * @ngname gmfThemes\n */\nconst exports = function($http, $injector, $q, ngeoLayerHelper, gettextCatalog, gmfThemesOptions) {\n\n  olEventsEventTarget.call(this);\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.addBlankBackgroundLayer_ = true;\n  if (gmfThemesOptions.addBlankBackgroundLayer !== undefined) {\n    this.addBlankBackgroundLayer_ = gmfThemesOptions.addBlankBackgroundLayer;\n  }\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.$q_ = $q;\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {string|undefined}\n   * @private\n   */\n  this.treeUrl_ = undefined;\n  if ($injector.has('gmfTreeUrl')) {\n    this.treeUrl_ = $injector.get('gmfTreeUrl');\n  }\n\n  this.cacheVersion_ = '0';\n  if ($injector.has('cacheVersion')) {\n    this.cacheVersion_ = $injector.get('cacheVersion');\n  }\n\n  /**\n   * @type {?ngeo.statemanager.Location}\n   * @private\n   */\n  this.ngeoLocation_ = null;\n  if ($injector.has('ngeoLocation')) {\n    this.ngeoLocation_ = $injector.get('ngeoLocation');\n  }\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.layerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog = gettextCatalog;\n\n  /**\n   * @type {angular.$q.Deferred}\n   * @private\n   */\n  this.deferred_ = $q.defer();\n\n  /**\n   * @type {angular.$q.Promise}\n   * @private\n   */\n  this.promise_ = this.deferred_.promise;\n\n  /**\n   * @type {boolean}\n   */\n  this.loaded = false;\n\n  /**\n   * @type {angular.$q.Promise}\n   * @private\n   */\n  this.bgLayerPromise_ = null;\n};\n\nolBase.inherits(exports, olEventsEventTarget);\n\n\n/**\n * @param {Array.<gmfThemes.GmfTheme>} themes Array of \"theme\" objects.\n * @param {string} name The layer name.\n * @return {gmfThemes.GmfGroup} The group.\n */\nexports.findGroupByLayerNodeName = function(themes, name) {\n  for (let i = 0, ii = themes.length; i < ii; i++) {\n    const theme = themes[i];\n    for (let j = 0, jj = theme.children.length; j < jj; j++) {\n      const group = theme.children[j];\n      const childNodes = [];\n      exports.getFlatNodes(group, childNodes);\n      if (exports.findObjectByName(childNodes, name)) {\n        return group;\n      }\n    }\n  }\n  return null;\n};\n\n/**\n * Find a layer group object by its name. Return null if not found.\n * @param {Array.<gmfThemes.GmfTheme>} themes Array of \"theme\" objects.\n * @param {string} name The group name.\n * @return {gmfThemes.GmfGroup} The group.\n */\nexports.findGroupByName = function(themes, name) {\n  for (let i = 0, ii = themes.length; i < ii; i++) {\n    const theme = themes[i];\n    for (let j = 0, jj = theme.children.length; j < jj; j++) {\n      const group = theme.children[j];\n      const internalNodes = [];\n      exports.getFlatInternalNodes(group, internalNodes);\n      if (exports.findObjectByName(internalNodes, name)) {\n        return group;\n      }\n    }\n  }\n  return null;\n};\n\n\n/**\n * Find an object by its name. Return null if not found.\n * @param {Array.<T>} objects Array of objects with a 'name' attribute.\n * @param {string} objectName The object name.\n * @return {T} The object or null.\n * @template T\n */\nexports.findObjectByName = function(objects, objectName) {\n  return olArray.find(objects, object => object['name'] === objectName);\n};\n\n\n/**\n * Find a theme object by its name. Return null if not found.\n * @param {Array.<gmfThemes.GmfTheme>} themes Array of \"theme\" objects.\n * @param {string} themeName The theme name.\n * @return {gmfThemes.GmfTheme} The theme object or null.\n */\nexports.findThemeByName = function(themes, themeName) {\n  return exports.findObjectByName(themes, themeName);\n};\n\n\n/**\n * Fill the given \"nodes\" array with all internal nodes (non-leaf nones) in\n * the given node.\n *\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node Layertree node.\n * @param {Array.<gmfThemes.GmfGroup|gmfThemes.GmfLayer>} nodes An array.\n */\nexports.getFlatInternalNodes = function(node, nodes) {\n  const children = node.children;\n  if (children !== undefined) {\n    nodes.push(node);\n    for (let i = 0; i < children.length; i++) {\n      exports.getFlatInternalNodes(children[i], nodes);\n    }\n  }\n};\n\n\n/**\n * Fill the given \"nodes\" array with all leaf nodes in the given node.\n *\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node Layertree node.\n * @param {Array.<gmfThemes.GmfGroup|gmfThemes.GmfLayer>} nodes An array.\n */\nexports.getFlatNodes = function(node, nodes) {\n  let i;\n  const children = node.children;\n  if (children !== undefined) {\n    for (i = 0; i < children.length; i++) {\n      exports.getFlatNodes(children[i], nodes);\n    }\n  } else {\n    nodes.push(node);\n  }\n};\n\n\n/**\n * Get background layers.\n * @return {!angular.$q.Promise.<!Array.<!ol.layer.Base>>} Promise.\n */\nexports.prototype.getBgLayers = function() {\n  const gettextCatalog = this.gettextCatalog;\n  if (this.bgLayerPromise_) {\n    return this.bgLayerPromise_;\n  }\n  const $q = this.$q_;\n  const layerHelper = this.layerHelper_;\n\n  /**\n   * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} item A group or a leaf.\n   * @param {Array.<number>} array Array of ids;\n   */\n  const getIds = function(item, array) {\n    array.push(olBase.getUid(item));\n    const children = item.children || [];\n    children.forEach((child) => {\n      getIds(child, array);\n    });\n  };\n\n  /**\n   * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} item The item.\n   * @param {ol.layer.Base} layer The layer.\n   * @return {ol.layer.Base} the provided layer.\n   */\n  const callback = function(item, layer) {\n    layer.set('label', item.name);\n    layer.set('metadata', item.metadata);\n    layer.set('dimensions', item.dimensions);\n    const ids = [];\n    getIds(item, ids);\n    layer.set('querySourceIds', ids);\n    return layer;\n  };\n\n  /**\n   * @param {gmfThemes.GmfOgcServers} ogcServers The ogc servers.\n   * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} gmfLayer The item.\n   * @return {angular.$q.Promise.<ol.layer.Base>|ol.layer.Base} the created layer.\n   */\n  const layerLayerCreationFn = function(ogcServers, gmfLayer) {\n    if (gmfLayer.type === 'WMTS') {\n      const gmfLayerWMTS = /** @type gmfThemes.GmfLayerWMTS */ (gmfLayer);\n      googAsserts.assert(gmfLayerWMTS.url, 'Layer URL is required');\n      return layerHelper.createWMTSLayerFromCapabilitites(\n        gmfLayerWMTS.url,\n        gmfLayerWMTS.layer || '',\n        gmfLayerWMTS.matrixSet,\n        gmfLayer.dimensions,\n        gmfLayerWMTS.metadata.customOpenLayersOptions\n      ).then(callback.bind(null, gmfLayer)).then(null, (response) => {\n        let message = `Unable to build layer \"${gmfLayerWMTS.layer}\" from WMTSCapabilities: ${gmfLayerWMTS.url}\\n`;\n        message += `OpenLayers error is \"${response['message']}`;\n        console.error(message);\n        // Continue even if some layers have failed loading.\n        return $q.resolve(undefined);\n      });\n    } else if (gmfLayer.type === 'WMS') {\n      const gmfLayerWMS = /** @type gmfThemes.GmfLayerWMS */ (gmfLayer);\n      googAsserts.assert(gmfLayerWMS.ogcServer, 'An OGC server is required');\n      const server = ogcServers[gmfLayerWMS.ogcServer];\n      googAsserts.assert(server, 'The OGC server was not found');\n      googAsserts.assert(server.url, 'The server URL is required');\n      googAsserts.assert(server.imageType, 'The server image type is required');\n\n      // Manage WMS styles\n      const opt_params = {STYLES: gmfLayerWMS.styles};\n      if (gmfLayer.dimensions) {\n        for (const [key, value] of Object.entries(gmfLayer.dimensions)) {\n          opt_params[key] = value;\n        }\n      }\n\n      return callback(gmfLayer, layerHelper.createBasicWMSLayer(\n        server.url,\n        gmfLayerWMS.layers || '',\n        server.imageType,\n        server.type,\n        undefined, // time\n        opt_params,\n        server.credential ? 'use-credentials' : 'anonymous',\n        gmfLayerWMS.metadata.customOpenLayersOptions\n      ));\n    }\n    googAsserts.fail(`Unsupported type: ${gmfLayer.type}`);\n  };\n\n  /**\n   * @param {gmfThemes.GmfOgcServers} ogcServers The ogc servers.\n   * @param {gmfThemes.GmfGroup} item The item.\n   * @return {angular.$q.Promise.<ol.layer.Group>} the created layer.\n   */\n  const layerGroupCreationFn = function(ogcServers, item) {\n    // We assume no child is a layer group.\n    const orderedChildren = item.children.map(x => x).reverse(); // the order of insertion in OL3 is the contrary of the theme\n    const promises = orderedChildren.map(layerLayerCreationFn.bind(null, ogcServers));\n    return $q.all(promises).then((layers) => {\n      let collection;\n      if (layers) {\n        layers = layers.filter(l => l);\n        collection = new olCollection(layers);\n      }\n      const group = layerHelper.createBasicGroup(collection);\n      callback(item, group);\n      return group;\n    });\n  };\n\n  /**\n   * @param {gmfThemes.GmfThemesResponse} data The \"themes\" web service\n   *     response.\n   * @return {angular.$q.Promise.<Array.<ol.layer.Base>>} Promise.\n   */\n  const promiseSuccessFn = function(data) {\n    const promises = data.background_layers.map((item) => {\n      const itemType = item.type;\n      if (itemType === 'WMTS' || itemType === 'WMS') {\n        return layerLayerCreationFn(data.ogcServers, item);\n      } else if (item.children) {\n        // group of layers\n        return layerGroupCreationFn(data.ogcServers, item);\n      } else {\n        return undefined;\n      }\n    }, this);\n    return $q.all(promises);\n  }.bind(this);\n\n  this.bgLayerPromise_ = this.promise_.then(promiseSuccessFn).then((values) => {\n    const layers = [];\n\n    // (1) add a blank layer\n    if (this.addBlankBackgroundLayer_) {\n      // For i18n string collection\n      gettextCatalog.getString('blank');\n      layers.push(new olLayerTile({\n        'label': 'blank',\n        'metadata': {'thumbnail': ''}\n      }));\n    }\n\n    // (2) add layers that were returned\n    values.forEach((layer) => {\n      if (layer) {\n        layers.push(layer);\n      }\n    });\n    return layers;\n  });\n\n  return this.bgLayerPromise_;\n};\n\n\n/**\n * Get a theme object by its name.\n * @param {string} themeName Theme name.\n * @return {angular.$q.Promise.<gmfThemes.GmfTheme>} Promise.\n * @export\n */\nexports.prototype.getThemeObject = function(themeName) {\n  return this.promise_.then(\n    /**\n       * @param {gmfThemes.GmfThemesResponse} data The \"themes\" web service\n       *     response.\n       * @return {gmfThemes.GmfTheme?} The theme object for themeName, or null\n       *     if not found.\n       */\n    data => exports.findThemeByName(data.themes, themeName));\n};\n\n\n/**\n * Get an array of theme objects.\n * @return {angular.$q.Promise.<!Array.<!gmfThemes.GmfTheme>>} Promise.\n * @export\n */\nexports.prototype.getThemesObject = function() {\n  return this.promise_.then(\n    /**\n       * @param {!gmfThemes.GmfThemesResponse} data The \"themes\" web service\n       *     response.\n       * @return {!Array.<!gmfThemes.GmfTheme>} The themes object.\n       */\n    data => data.themes);\n};\n\n\n/**\n * Get an array of background layer objects.\n * @return {angular.$q.Promise.<!Array.<!gmfThemes.GmfLayer>>} Promise.\n */\nexports.prototype.getBackgroundLayersObject = function() {\n  googAsserts.assert(this.promise_ !== null);\n  return this.promise_.then(\n    /**\n       * @param {!gmfThemes.GmfThemesResponse} data The \"themes\" web service\n       *     response.\n       * @return {!Array.<!gmfThemes.GmfLayer>} The background layers object.\n       */\n    data => data.background_layers\n  );\n};\n\n\n/**\n * Get the `ogcServers` object.\n * @return {angular.$q.Promise.<!gmfThemes.GmfOgcServers>} Promise.\n * @export\n */\nexports.prototype.getOgcServersObject = function() {\n  googAsserts.assert(this.promise_ !== null);\n  return this.promise_.then(\n    /**\n       * @param {gmfThemes.GmfThemesResponse} data The \"themes\" web service\n       *     response.\n       * @return {gmfThemes.GmfOgcServers} The `ogcServers` object.\n       */\n    data => data.ogcServers);\n};\n\n\n/**\n * Returns a promise to check if one of the layers in the themes is editable.\n * @return {angular.$q.Promise.<boolean>} Promise.\n */\nexports.prototype.hasEditableLayers = function() {\n  googAsserts.assert(this.promise_ !== null);\n  return this.promise_.then(this.hasEditableLayers_.bind(this));\n};\n\n\n/**\n * Returns if one of the layers in the themes is editable.\n * @param {gmfThemes.GmfThemesResponse} data The \"themes\" web service response.\n * @return {boolean} Editable layers?\n */\nexports.prototype.hasEditableLayers_ = function(data) {\n  return data.themes.some((theme) => {\n    const hasEditableLayers = theme.children.some(this.hasNodeEditableLayers_.bind(this));\n    return hasEditableLayers;\n  });\n};\n\n\n/**\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node Theme node\n * @return {boolean} Editable layers?\n */\nexports.prototype.hasNodeEditableLayers_ = function(node) {\n  if (node.editable) {\n    return true;\n  }\n\n  let hasEditableLayers = false;\n  const children = node.children;\n  if (children && children.length) {\n    hasEditableLayers = children.some(this.hasNodeEditableLayers_.bind(this));\n  }\n  return hasEditableLayers;\n};\n\n\n/**\n * Get the snapping configuration object from a Layertree controller\n * @param {gmfThemes.GmfLayer} node Layer node from the theme.\n * @return {?gmfThemes.GmfSnappingConfig} Snapping configuration, if found.\n * @export\n */\nexports.getSnappingConfig = function(node) {\n  const config = (node.metadata && node.metadata.snappingConfig !== undefined) ?\n    node.metadata.snappingConfig : null;\n  return config;\n};\n\n\n/**\n * Get the maximal resolution defined for this layer. Looks in the\n *     layer itself before to look into its metadata.\n * @param {gmfThemes.GmfLayerWMS} gmfLayer the GeoMapFish Layer. WMTS layer is\n *     also allowed (the type is defined as GmfLayerWMS only to avoid some\n *     useless tests to know if a maxResolutionHint property can exist\n *     on the node).\n * @return {number|undefined} the max resolution or undefined if any.\n */\nexports.getNodeMaxResolution = function(gmfLayer) {\n  const metadata = gmfLayer.metadata;\n  let maxResolution = gmfLayer.maxResolutionHint;\n  if (maxResolution === undefined && metadata !== undefined) {\n    maxResolution = metadata.maxResolution;\n  }\n  return maxResolution;\n};\n\n\n/**\n * Get the minimal resolution defined for this layer. Looks in the\n *     layer itself before to look into its metadata.\n * @param {gmfThemes.GmfLayerWMS} gmfLayer the GeoMapFish Layer. WMTS layer is\n *     also allowed (the type is defined as GmfLayerWMS only to avoid some\n *     useless tests to know if a minResolutionHint property can exist\n *     on the node).\n * @return {number|undefined} the min resolution or undefined if any.\n */\nexports.getNodeMinResolution = function(gmfLayer) {\n  const metadata = gmfLayer.metadata;\n  let minResolution = gmfLayer.minResolutionHint;\n  if (minResolution === undefined && metadata !== undefined) {\n    minResolution = metadata.minResolution;\n  }\n  return minResolution;\n};\n\n\n/**\n * @param {number=} opt_roleId The role id to send in the request.\n * Load themes from the \"themes\" service.\n * @export\n */\nexports.prototype.loadThemes = function(opt_roleId) {\n\n  googAsserts.assert(this.treeUrl_, 'gmfTreeUrl should be defined.');\n\n  if (this.loaded) {\n    // reload the themes\n    this.deferred_ = this.$q_.defer();\n    this.promise_ = this.deferred_.promise;\n    this.bgLayerPromise_ = null;\n    this.loaded = false;\n  }\n\n  this.$http_.get(this.treeUrl_, {\n    params: opt_roleId !== undefined ? {\n      'role': opt_roleId,\n      'cache_version': this.cacheVersion_\n    } : {\n      'cache_version': this.cacheVersion_\n    },\n    cache: false,\n    withCredentials: true\n  }).then((response) => {\n    if (response.data.errors.length != 0) {\n      const message = `The themes contain some errors:\\n${\n        response.data.errors.join('\\n')}`;\n      console.error(message);\n      if (this.ngeoLocation_ !== null && this.ngeoLocation_.hasParam('debug')) {\n        window.alert(message);\n      }\n    }\n    this.deferred_.resolve(response.data);\n    this.dispatchEvent('change');\n    this.loaded = true;\n  }, (response) => {\n    this.deferred_.reject(response);\n  });\n};\n\n\n/**\n * @enum {string}\n */\nexports.NodeType = {\n  MIXED_GROUP: 'MixedGroup',\n  NOT_MIXED_GROUP: 'NotMixedGroup',\n  WMTS: 'WMTS',\n  WMS: 'WMS'\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfThemes', [\n  ngeoMapLayerHelper.module.name,\n]);\nexports.module.value('gmfThemesOptions', {});\nexports.module.service('gmfThemes', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.OGC\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceDataSource from 'ngeo/datasource/DataSource.js';\nimport ngeoFilterCondition from 'ngeo/filter/Condition.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport olFormatGML2 from 'ol/format/GML2.js';\nimport olFormatGML3 from 'ol/format/GML3.js';\nimport olFormatWFS from 'ol/format/WFS.js';\nimport olFormatWMSGetFeatureInfo from 'ol/format/WMSGetFeatureInfo.js';\n\n/**\n * @implements {ngeox.datasource.OGC}\n */\nconst exports = class extends ngeoDatasourceDataSource {\n\n  /**\n   * A data source contains information of a single source of data that can\n   * show or fetch the data using an OGC server. Several OGC service types are\n   * supported by this data source: WMS, WMTS and even WFS.\n   *\n   * You can use the information stored within an OGC data source to do all\n   * sorts of things:\n   * - issue WMS/WFS queries\n   * - apply filter rules on it\n   * - create `ol.layer.Layer` objects using the WMS, WMTS or event WFS\n   *   information\n   *\n   * @struct\n   * @param {ngeox.datasource.OGCOptions} options Options.\n   */\n  constructor(options) {\n\n    super(options);\n\n    // === DYNAMIC properties (i.e. that can change / be watched) ===\n\n    /**\n     * The dimensions configuration for the data source.\n     * @type {?ngeox.Dimensions}\n     * @private\n     */\n    this.dimensionsConfig_ = options.dimensionsConfig || null;\n\n    /**\n     * The dimensions applied by filters configuration for the data source.\n     * @type {?ngeox.DimensionsFiltersConfig}\n     * @private\n     */\n    this.dimensionsFiltersConfig_ = options.dimensionsFiltersConfig || null;\n\n    /**\n     * The filter condition to apply to the filter rules (if any).\n     * @type {string}\n     * @private\n     */\n    this.filterCondition_ = options.filterCondition || ngeoFilterCondition.AND;\n\n    /**\n     * A list of filter rules to apply to this data source using the filter\n     * condition.\n     * @type {?Array.<!ngeo.rule.Rule>}\n     * @private\n     */\n    this.filterRules_ = options.filterRules || null;\n\n    /**\n     * Whether the data source is filtrable or not. When `null`, that means\n     * that we do not know if the data source if filtrable or not, yet. In\n     * that case, the value of the property needs to be determined from an\n     * external way.\n     * @type {?boolean}\n     * @private\n     */\n    this.filtrable_ = options.filtrable || null;\n\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * Whether the geometry from this data source can be copied to other data\n     * sources or not. Defaults to `false`.\n     * @type {boolean}\n     * @private\n     */\n    this.copyable_ = options.copyable === true;\n\n    /**\n     * A reference to the dimensions object.\n     * @type {?ngeox.Dimensions}\n     * @private\n     */\n    this.dimensions_ = options.dimensions || null;\n\n    /**\n     * The name of the geometry attribute.\n     * @type {string}\n     * @private\n     */\n    this.geometryName_ = options.geometryName ||\n      exports.DEFAULT_GEOMETRY_NAME_;\n\n    /**\n     * The type of images to fetch by queries by the (WMS) or (WMTS) .\n     * @type {string}\n     * @private\n     */\n    this.ogcImageType_ = options.ogcImageType || 'image/png';\n\n    /**\n     * A list of layer definitions that are used by (WMS) and (WFS) queries.\n     * These are **not** used by the (WMTS) queries (the wmtsLayers is used\n     * by WMTS queries).\n     * @type {?Array.<!ngeox.datasource.OGCLayer>}\n     * @private\n     */\n    this.ogcLayers_ = options.ogcLayers || null;\n\n    /**\n     * The type of OGC server making the requests.\n     * @type {string}\n     * @private\n     */\n    this.ogcServerType_ = options.ogcServerType ||\n      exports.ServerType.MAPSERVER;\n\n    /**\n     * The type data source. Can be: 'WMS' or 'WMTS'.\n     * @type {string}\n     * @private\n     */\n    this.ogcType_ = options.ogcType || exports.Type.WMS;\n\n    /**\n     * Whether the geometry from this data source can be used to snap the\n     * geometry of features from other data sources that are being edited.\n     * Defaults to `false`.\n     * @type {boolean}\n     * @private\n     */\n    this.snappable_ = options.snappable === true;\n\n    /**\n     * Determines whether external features can be snapped to the edges of\n     * features from this data source or not. Defaults to `true`. Requires\n     * `snappable` to be set.\n     * @type {boolean}\n     * @private\n     */\n    this.snappingToEdges_ = options.snappingToEdges !== false;\n\n    /**\n     * Determines whether external features can be snapped to the vertice of\n     * features from this data source or not. Defaults to `true`. Requires\n     * `snappable` to be set.\n     * @type {boolean}\n     * @private\n     */\n    this.snappingToVertice_ = options.snappingToVertice !== false;\n\n    /**\n     * The tolerance in pixels the snapping should occur. Defaults to `10`.\n     * @type {number}\n     * @private\n     */\n    this.snappingTolerance_ = options.snappingTolerance !== undefined ?\n      options.snappingTolerance : 10;\n\n    /**\n     * The name of the time attribute.\n     * @type {string|undefined}\n     * @private\n     */\n    this.timeAttributeName_ = options.timeAttributeName;\n\n    /**\n     * @type {number|undefined}\n     * @private\n     */\n    this.timeLowerValue_ = options.timeLowerValue;\n\n    /**\n     * @type {?ngeox.TimeProperty}\n     * @private\n     */\n    this.timeProperty_ = options.timeProperty !== undefined ?\n      options.timeProperty : null;\n\n    /**\n     * @type {number|undefined}\n     * @private\n     */\n    this.timeUpperValue_ = options.timeUpperValue;\n\n    /**\n     * The feature namespace to use with WFS requests.\n     * @type {string}\n     * @private\n     */\n    this.wfsFeatureNS_ = options.wfsFeatureNS ||\n      exports.WFSFeatureNS[this.ogcServerType_];\n\n    /**\n     * The feature prefix to use with WFS requests.\n     * @type {string}\n     * @private\n     */\n    this.wfsFeaturePrefix_ = options.wfsFeaturePrefix ||\n      exports.WFSFeaturePrefix.FEATURE;\n\n    /**\n     * The OutputFormat to use with WFS requests.\n     * @type {string}\n     * @private\n     */\n    this.wfsOutputFormat_ = options.wfsOutputFormat ||\n      exports.WFSOutputFormat.GML3;\n\n    /**\n     * The url to use for (WFS) requests.\n     * @type {string|undefined}\n     * @private\n     */\n    this.wfsUrl_ = options.wfsUrl;\n\n    /**\n     * The InfoFormat to use with WMS requests.\n     * @type {string}\n     * @private\n     */\n    this.wmsInfoFormat_ = options.wmsInfoFormat ||\n      exports.WMSInfoFormat.GML;\n\n    /**\n     * Whether the (WMS) images returned by this data source\n     * should be single tiles or not.\n     * @type {boolean}\n     * @private\n     */\n    this.wmsIsSingleTile_ = options.wmsIsSingleTile === true;\n\n    /**\n     * The url to use for (WMS) requests.\n     * @type {string|undefined}\n     * @private\n     */\n    this.wmsUrl_ = options.wmsUrl;\n\n    /**\n     * The layer name to use for the (WMTS) requests.\n     * @type {string|undefined}\n     * @private\n     */\n    this.wmtsLayer_ = options.wmtsLayer;\n\n    /**\n     * The url to use for (WMTS) requests.\n     * @type {string|undefined}\n     * @private\n     */\n    this.wmtsUrl_ = options.wmtsUrl;\n\n\n    // === Calculated properties ===\n\n    // Get queryable ogc layer names\n    const layers = [];\n    if (this.queryable && this.ogcLayers) {\n      for (const ogcLayer of this.ogcLayers) {\n        if (ogcLayer.queryable) {\n          layers.push(ogcLayer.name);\n        }\n      }\n    }\n\n    let wfsFormat = null;\n    if (this.supportsWFS && layers.length) {\n      let format = undefined;\n      if (this.wfsOutputFormat_ === exports.WFSOutputFormat.GML3) {\n        format = new olFormatGML3();\n      } else if (this.wfsOutputFormat_ === exports.WFSOutputFormat.GML2) {\n        format = new olFormatGML2();\n      }\n      googAsserts.assert(format);\n      wfsFormat = new olFormatWFS({\n        featureNS: this.wfsFeatureNS,\n        featureType: layers,\n        gmlFormat: format\n      });\n    }\n\n    /**\n     * @type {?ol.format.WFS}\n     * @private\n     */\n    this.wfsFormat_ = wfsFormat;\n\n    let wmsFormat = null;\n    if (this.supportsWMS && layers.length) {\n      if (this.wmsInfoFormat === exports.WMSInfoFormat.GML) {\n        wmsFormat = new olFormatWMSGetFeatureInfo({\n          layers\n        });\n      }\n      // Todo, support more formats for WMS\n    }\n\n    /**\n     * @type {?ol.format.WMSGetFeatureInfo}\n     * @private\n     */\n    this.wmsFormat_ = wmsFormat;\n  }\n\n  // ========================================\n  // === Dynamic property getters/setters ===\n  // ========================================\n  /**\n   * @return {?ngeox.Dimensions} Current dimensions to use for this data source\n   * @export\n   */\n  get dimensions() {\n    return this.dimensions_;\n  }\n\n  /**\n   * @return {?ngeox.Dimensions} Dimensions configuration for this data source\n   * @export\n   */\n  get dimensionsConfig() {\n    return this.dimensionsConfig_;\n  }\n\n  /**\n   * @param {?ngeox.Dimensions} dimensionsConfig Dimensions configuration\n   * @export\n   */\n  set dimensionsConfig(dimensionsConfig) {\n    this.dimensionsConfig_ = dimensionsConfig;\n  }\n\n  /**\n  * @return {?ngeox.DimensionsFiltersConfig} dimensionsFiltersConfig Dimensions\n  * filters configuration for this data source\n  * @export\n  */\n  get dimensionsFiltersConfig() {\n    return this.dimensionsFiltersConfig_;\n  }\n\n  /**\n   * @param {?ngeox.DimensionsFiltersConfig}dimensionsFiltersConfig Dimensions\n  * filters configuration for this data source\n   * @export\n   */\n  set dimensionsFiltersConfig(dimensionsFiltersConfig) {\n    this.dimensionsFiltersConfig_ = dimensionsFiltersConfig;\n  }\n\n  /**\n   * @return {string} Filter condition\n   * @export\n   */\n  get filterCondition() {\n    return this.filterCondition_;\n  }\n\n  /**\n   * @param {string} filterCondition Filter condition\n   * @export\n   */\n  set filterCondition(filterCondition) {\n    this.filterCondition_ = filterCondition;\n  }\n\n  /**\n   * @return {?Array.<!ngeo.rule.Rule>} Filter rules\n   * @export\n   */\n  get filterRules() {\n    return this.filterRules_;\n  }\n\n  /**\n   * @param {?Array.<!ngeo.rule.Rule>} filterRules Filter rules\n   * @export\n   */\n  set filterRules(filterRules) {\n    this.filterRules_ = filterRules;\n  }\n\n  /**\n   * @return {number|undefined} Time lower value\n   * @export\n   */\n  get timeLowerValue() {\n    return this.timeLowerValue_;\n  }\n\n  /**\n   * @param {number|undefined} time Time lower value\n   * @export\n   */\n  set timeLowerValue(time) {\n    this.timeLowerValue_ = time;\n  }\n\n  /**\n   * @return {?ngeox.TimeRange} Time range value\n   * @export\n   */\n  get timeRangeValue() {\n    let range = null;\n    const lower = this.timeLowerValue;\n    const upper = this.timeUpperValue;\n    if (lower !== undefined) {\n      range = {\n        end: upper,\n        start: lower\n      };\n    }\n    return range;\n  }\n\n  /**\n   * @param {?ngeox.TimeRange} range Time range value\n   * @export\n   */\n  set timeRangeValue(range) {\n    if (range) {\n      this.timeUpperValue = range.end;\n      this.timeLowerValue = range.start;\n    } else {\n      this.timeUpperValue = undefined;\n      this.timeLowerValue = undefined;\n    }\n  }\n\n  /**\n   * @return {number|undefined} Time upper value\n   * @export\n   */\n  get timeUpperValue() {\n    return this.timeUpperValue_;\n  }\n\n  /**\n   * @param {number|undefined} time Time upper value\n   * @export\n   */\n  set timeUpperValue(time) {\n    this.timeUpperValue_ = time;\n  }\n\n  // =======================================\n  // === Static property getters/setters ===\n  // =======================================\n\n  /**\n   * @inheritDoc\n   */\n  getAttributes() {\n    return super.attributes;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  setAttributes(attributes) {\n    super.setAttributes(attributes);\n    this.updateGeometryNameFromAttributes_();\n  }\n\n  /**\n   * @return {boolean} Copyable\n   * @export\n   */\n  get copyable() {\n    return this.copyable_;\n  }\n\n  /**\n   * @return {?boolean} Filtrable.\n   * @export\n   */\n  get filtrable() {\n    return this.filtrable_;\n  }\n\n  /**\n   * @param {?boolean} filtrable Filtrable.\n   * @export\n   */\n  set filtrable(filtrable) {\n    this.filtrable_ = filtrable;\n  }\n\n  /**\n   * @return {string} Geometry name\n   * @export\n   */\n  get geometryName() {\n    return this.geometryName_;\n  }\n\n  /**\n   * @return {string} OGC image type\n   * @export\n   */\n  get ogcImageType() {\n    return this.ogcImageType_;\n  }\n\n  /**\n   * @return {?Array.<!ngeox.datasource.OGCLayer>} OGC layers\n   * @export\n   */\n  get ogcLayers() {\n    return this.ogcLayers_;\n  }\n\n  /**\n   * @return {string} OGC server type\n   * @export\n   */\n  get ogcServerType() {\n    return this.ogcServerType_;\n  }\n\n  /**\n   * @return {string} OGC type\n   * @export\n   */\n  get ogcType() {\n    return this.ogcType_;\n  }\n\n  /**\n   * @return {boolean} Snappable\n   * @export\n   */\n  get snappable() {\n    return this.snappable_;\n  }\n\n  /**\n   * @return {boolean} Snapping to edges\n   * @export\n   */\n  get snappingToEdges() {\n    return this.snappingToEdges_;\n  }\n\n  /**\n   * @return {boolean} Snapping to vertices\n   * @export\n   */\n  get snappingToVertice() {\n    return this.snappingToVertice_;\n  }\n\n  /**\n   * @return {number} Snapping tolerance\n   * @export\n   */\n  get snappingTolerance() {\n    return this.snappingTolerance_;\n  }\n\n  /**\n   * @return {string|undefined} Time attribute name\n   * @export\n   */\n  get timeAttributeName() {\n    return this.timeAttributeName_;\n  }\n\n  /**\n   * @return {?ngeox.TimeProperty} Time property\n   * @export\n   */\n  get timeProperty() {\n    return this.timeProperty_;\n  }\n\n  /**\n   * @return {string} WFS feature namespace\n   * @export\n   */\n  get wfsFeatureNS() {\n    return this.wfsFeatureNS_;\n  }\n\n  /**\n   * @return {string} WFS feature prefix\n   * @export\n   */\n  get wfsFeaturePrefix() {\n    return this.wfsFeaturePrefix_;\n  }\n\n  /**\n   * @return {string} WFS output format\n   * @export\n   */\n  get wfsOutputFormat() {\n    return this.wfsOutputFormat_;\n  }\n\n  /**\n   * @export\n   * @return {string|undefined} WFS url\n   */\n  get wfsUrl() {\n    return this.wfsUrl_;\n  }\n\n  /**\n   * @return {string} WMS info format\n   * @export\n   */\n  get wmsInfoFormat() {\n    return this.wmsInfoFormat_;\n  }\n\n  /**\n   * @return {boolean} WMS is single tile\n   * @export\n   */\n  get wmsIsSingleTile() {\n    return this.wmsIsSingleTile_;\n  }\n\n  /**\n   * @return {string|undefined} WMS url\n   * @export\n   * @override\n   */\n  get wmsUrl() {\n    return this.wmsUrl_;\n  }\n\n  /**\n   * @return {string|undefined} WMTS layer\n   * @export\n   */\n  get wmtsLayer() {\n    return this.wmtsLayer_;\n  }\n\n  /**\n   * @return {string|undefined} WMTS url\n   * @export\n   * @override\n   */\n  get wmtsUrl() {\n    return this.wmtsUrl_;\n  }\n\n  // ===================================\n  // === Calculated property getters ===\n  // ===================================\n\n  /**\n   * @return {!ngeox.DimensionsActive} Active dimensions\n   * @export\n   */\n  get activeDimensions() {\n    const active = {};\n    const dimensions = this.dimensions_ || {};\n    const config = this.dimensionsConfig || {};\n\n    for (const key in config) {\n      if (config[key] === null) {\n        if (dimensions[key] !== undefined && dimensions[key] !== null) {\n          active[key] = dimensions[key];\n        }\n      } else {\n        active[key] = config[key];\n      }\n    }\n\n    return active;\n  }\n\n  /**\n   * A data source can't be combined to other data source to issue a single\n   * WFS request if:\n   *\n   * - it has filter rules set\n   * - it has time range set\n   *\n   * @return {boolean} Whether the data source can be combined to an other\n   *     data source to fetch features in a single WFS request.\n   * @export\n   * @override\n   */\n  get combinableForWFS() {\n    return this.filterRules_ === null &&\n      this.timeRangeValue === null;\n  }\n\n  /**\n   * A data source can't be combined to other data source to issue a single\n   * WMS request if:\n   *\n   * - it has filter rules set\n   * - it has time range set\n   *\n   * @return {boolean} Whether the data source can be combined to an other\n   *     data source to fetch features in a single WMS request.\n   * @export\n   * @override\n   */\n  get combinableForWMS() {\n    return this.filterRules_ === null &&\n      this.timeRangeValue === null;\n  }\n\n  /**\n   * Whether the data source is queryable or not. For an OGC data source to be\n   * queryable, it requires the support of WFS or WMS and at least one ogc\n   * layer to be querable.\n   * @export\n   */\n  get queryable() {\n    let queryable = false;\n    const supportsOGCQueries = this.supportsWMS || this.supportsWFS;\n    if (supportsOGCQueries && this.ogcLayers) {\n      for (const ogcLayer of this.ogcLayers) {\n        if (ogcLayer.queryable === true) {\n          queryable = true;\n          break;\n        }\n      }\n    }\n    return queryable;\n  }\n\n  /**\n   * @return {boolean} Whether the data source supports making WFS requests\n   *     or not.\n   * @export\n   * @override\n   */\n  get supportsWFS() {\n    return this.wfsUrl !== undefined;\n  }\n\n  /**\n   * To be able to do advanced operations on a data source, such as editing\n   * or filtering, a data source must be bound to 1 set of attributes.\n   * These attributes are the ones defined by an ogcLayer.  This means that\n   * to be considered to support having attributes defined, you either need\n   * to define them directly when creating the data source, or if you let\n   * the querent service get them for you using a WFS DescribeFeatureType\n   * request, the data source must have only 1 ogcLayer set, which must\n   * be queryable.\n   * @return {boolean} Supports attributes.\n   * @export\n   */\n  get supportsAttributes() {\n    return this.attributes !== null || (\n      this.supportsWFS &&\n      this.ogcLayers !== null &&\n      this.ogcLayers.length === 1 &&\n      this.ogcLayers[0].queryable === true\n    );\n  }\n\n  /**\n   * @return {boolean} Whether the data source supports making WMS requests\n   *     or not.\n   * @export\n   * @override\n   */\n  get supportsWMS() {\n    return this.wmsUrl !== undefined;\n  }\n\n  /**\n   * @return {boolean} Whether the data source supports making WTMS requests\n   *     or not.\n   * @export\n   */\n  get supportsWMTS() {\n    return this.wmtsUrl !== undefined;\n  }\n\n  /**\n   * @return {?ol.format.WFS} WFS format.\n   * @export\n   */\n  get wfsFormat() {\n    return this.wfsFormat_;\n  }\n\n  /**\n   * @return {?ol.format.WMSGetFeatureInfo} WMS format.\n   * @export\n   */\n  get wmsFormat() {\n    return this.wmsFormat_;\n  }\n\n  // ============================\n  // === Other public methods ===\n  // ============================\n\n  /**\n   * @param {ngeox.datasource.OGC} dataSource Data source.\n   * @return {boolean} Whether this data source can be combined to the given\n   *     other data source to fetch features in a single WFS request.\n   * @export\n   * @override\n   */\n  combinableWithDataSourceForWFS(dataSource) {\n    return this.combinableForWFS && dataSource.combinableForWFS &&\n      this.supportsWFS && dataSource.supportsWFS &&\n      this.queryable && dataSource.queryable &&\n      this.wfsUrl === dataSource.wfsUrl &&\n      this.haveTheSameActiveDimensions(dataSource);\n  }\n\n  /**\n   * @param {ngeox.datasource.OGC} dataSource Data source.\n   * @return {boolean} Whether this data source can be combined to the given\n   *     other data source to fetch features in a single WMS request.\n   * @export\n   * @override\n   */\n  combinableWithDataSourceForWMS(dataSource) {\n    return this.combinableForWMS && dataSource.combinableForWMS &&\n      this.supportsWMS && dataSource.supportsWMS &&\n      this.queryable && dataSource.queryable &&\n      this.wmsUrl === dataSource.wmsUrl &&\n      this.haveTheSameActiveDimensions(dataSource);\n  }\n\n  /**\n   * Check if there's at least one OGC layer in range of a given resolution.\n   * @param {number} res Resolution.\n   * @param {boolean} queryableOnly Whether to additionally check if the\n   *     OGC layer is queryable as well or not. Defaults to `false`.\n   * @return {boolean} At least one OGC layer is in range.\n   * @export\n   */\n  isAnyOGCLayerInRange(res, queryableOnly = false) {\n    return !!(this.getInRangeOGCLayerNames(res, queryableOnly).length);\n  }\n\n  /**\n   * Returns a list of OGC layer names that are in range of a given resolution.\n   * If there's no OGC layers defined, an empty array is returned.\n   * @param {number} res Resolution.\n   * @param {boolean} queryableOnly Whether to additionally check if the\n   *     OGC layer is queryable as well or not. Defaults to `false`.\n   * @return {Array.<string>} The OGC layer names that are in range.\n   * @export\n   */\n  getInRangeOGCLayerNames(res, queryableOnly = false) {\n\n    const layerNames = [];\n\n    if (this.ogcLayers) {\n      for (const ogcLayer of this.ogcLayers) {\n        const maxRes = ogcLayer.maxResolution;\n        const minRes = ogcLayer.minResolution;\n        const inMinRange = minRes === undefined || res >= minRes;\n        const inMaxRange = maxRes === undefined || res <= maxRes;\n        const inRange = inMinRange && inMaxRange;\n\n        if (inRange && (!queryableOnly || ogcLayer.queryable)) {\n          layerNames.push(ogcLayer.name);\n        }\n      }\n    }\n\n    return layerNames;\n  }\n\n  /**\n   * Returns the list of OGC layer names.\n   * @param {boolean} queryableOnly Whether to additionally check if the\n   *     OGC layer is queryable as well or not. Defaults to `false`.\n   * @return {Array.<string>} The OGC layer names.\n   * @export\n   */\n  getOGCLayerNames(queryableOnly = false) {\n\n    const layerNames = [];\n\n    if (this.ogcLayers) {\n      for (const ogcLayer of this.ogcLayers) {\n        if (!queryableOnly || ogcLayer.queryable) {\n          layerNames.push(ogcLayer.name);\n        }\n      }\n    }\n\n    return layerNames;\n  }\n\n  /**\n   * Returns the filtrable OGC layer name. This methods asserts that\n   * the name exists and is filtrable.\n   * @return {string} OGC layer name.\n   * @export\n   */\n  getFiltrableOGCLayerName() {\n    googAsserts.assert(this.filtrable);\n    const layerNames = this.getOGCLayerNames();\n    googAsserts.assert(layerNames.length === 1);\n    return layerNames[0];\n  }\n\n  /**\n   * Loop in the attributes of the data source. Update the `geometryName`\n   * property on the first geometry attribute found. If none is found, then\n   * the default geometry name is set.\n   * @private\n   */\n  updateGeometryNameFromAttributes_() {\n    let geometryName = exports.DEFAULT_GEOMETRY_NAME_;\n\n    if (this.attributes) {\n      for (const attribute of this.attributes) {\n        if (attribute.type === ngeoFormatAttributeType.GEOMETRY) {\n          geometryName = attribute.name;\n          break;\n        }\n      }\n    }\n\n    this.geometryName_ = geometryName;\n  }\n\n  /**\n   * @param {!ngeox.datasource.OGC} dataSource Remote data source to\n   *     compare with this one.\n   * @return {boolean} Whether the two data sources have the same active\n   *     dimensions. If both have no dimensions, they are considered to be\n   *     sharing the same dimensions.\n   * @export\n   * @override\n   */\n  haveTheSameActiveDimensions(dataSource) {\n    let share = true;\n\n    const myActive = this.activeDimensions;\n    const itsActive = dataSource.activeDimensions;\n\n    for (const key in myActive) {\n      if (myActive[key] !== itsActive[key]) {\n        share = false;\n        break;\n      }\n    }\n\n    if (share) {\n      for (const key in itsActive) {\n        if (itsActive[key] !== myActive[key]) {\n          share = false;\n          break;\n        }\n      }\n    }\n\n    return share;\n  }\n};\n\n\n/**\n * Guess the type of OGC service from a given url. Default returned value is\n * WMS.\n * @param {string} url Url\n * @return {string} Guessed OGC service type.\n */\nexports.guessServiceTypeByUrl = function(url) {\n  let type;\n\n  if (/(wmts)/i.test(url)) {\n    type = exports.Type.WMTS;\n  } else {\n    type = exports.Type.WMS;\n  }\n\n  return type;\n};\n\n\n/**\n * Default name of the geometry attribute.\n * @type {string}\n * @private\n */\nexports.DEFAULT_GEOMETRY_NAME_ = 'the_geom';\n\n\n/**\n * Available OGC server types.\n * @enum {string}\n */\nexports.ServerType = {\n  GEOSERVER: 'geoserver',\n  MAPSERVER: 'mapserver',\n  QGISSERVER: 'qgisserver'\n};\n\n\n/**\n * Available OGC types.\n * @enum {string}\n */\nexports.Type = {\n  WMS: 'WMS',\n  WMTS: 'WMTS'\n};\n\n\n/**\n * Available Feature namespace for WFS requests.\n * @const {Object.<string, string>}\n */\nexports.WFSFeatureNS = {\n  'geoserver': 'http://www.opengis.net/gml/3.2',\n  'mapserver': 'http://mapserver.gis.umn.edu/mapserver',\n  'qgisserver': 'http://www.qgis.org/gml'\n};\n\n\n/**\n * Available Feature namespace for WFS requests.\n * @enum {string}\n */\nexports.WFSFeaturePrefix = {\n  FEATURE: 'feature'\n};\n\n\n/**\n * Available OutputFormat for WFS requests.\n * @enum {string}\n */\nexports.WFSOutputFormat = {\n  GML2: 'GML2',\n  GML3: 'GML3'\n};\n\n\n/**\n * Available InfoFormat for WMS requests.\n * @enum {string}\n */\nexports.WMSInfoFormat = {\n  GML: 'application/vnd.ogc.gml'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.rule.Rule\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olEvents from 'ol/events.js';\n\n/**\n * @implements {ngeox.rule.Rule}\n */\nconst exports = class {\n\n  /**\n   * The abstract class for all filter rules.\n   *\n   * Rules are used to define filters that can be applied on data sources.\n   * A rule is usually a combination of 3 things:\n   *\n   * - a property name, for example 'city_name'\n   * - an operator, for example 'is equal to'\n   * - and an expression, for example 'Chicoutimi'.\n   *\n   * A rule is useful to hold those properties and change them on the fly.\n   * For example, changing an operator from 'is equal to' to 'like'.\n   *\n   * Also, a rule is especially useful for its `value` getter, which returns\n   * the combination of properties described above or `null` if there are some\n   * missing.  The `value` getter can be watched and used when the value is\n   * not null.\n   *\n   * When the operator is `between`, the `lowerBoundary` and `upperBoundary`\n   * properties are used instead of `expression`.\n   *\n   * @struct\n   * @param {!ngeox.rule.RuleOptions} options Options.\n   */\n  constructor(options) {\n\n    // === DYNAMIC properties (i.e. that can change / be watched ===\n\n    /**\n     * Whether the rule is active or not. Used by the `ngeo-rule` component.\n     * Defaults to `false`.\n     * @type {boolean}\n     * @private\n     */\n    this.active_ = options.active === true;\n\n    /**\n     * The expression of the rule. The expression and boundaries are mutually\n     * exclusives.\n     *\n     * Note: exported (instead of private) due to the problem with the\n     * compiler. See the getter/setter methods below...  As a setter, the\n     * `expression` property would support being bond to an `ng-model`. Without\n     * it, it can't unless we expose the property directly.\n     *\n     * @type {?number|string}\n     * @export\n     */\n    this.expression = options.expression !== undefined ?\n      options.expression : null;\n\n    /**\n     * The lower boundary of the rule. The expression and boundaries are\n     * mutually exclusives.\n     * @type {?number}\n     * @private\n     */\n    this.lowerBoundary_ = options. lowerBoundary !== undefined ?\n      options.lowerBoundary : null;\n\n    /**\n     * The rule operator.\n     * @type {?string}\n     * @private\n     */\n    this.operator_ = options.operator || null;\n\n    /**\n     * The upper boundary of the rule. The expression and boundaries are\n     * mutually exclusives.\n     * @type {?number}\n     * @private\n     */\n    this.upperBoundary_ = options. upperBoundary !== undefined ?\n      options.upperBoundary : null;\n\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * Whether the rule is a custom one or not.\n     * @type {boolean}\n     * @private\n     */\n    this.isCustom_ = options.isCustom !== false;\n\n    /**\n     * The human-readable name of the rule.\n     * @type {string}\n     * @private\n     */\n    this.name_ = options.name;\n\n    /**\n     * A list of rule operators.\n     * @type {?Array.<string>}\n     * @private\n     */\n    this.operators_ = options.operators || null;\n\n    /**\n     * The property name (a.k.a. the attribute name).\n     * @type {string}\n     * @private\n     */\n    this.propertyName_ = options.propertyName;\n\n    /**\n     * The type of rule.\n     * @type {string}\n     * @private\n     */\n    this.type_ = googAsserts.assert(options.type);\n\n\n    // === Other properties ===\n\n    /**\n     * @type {Array.<!ol.EventsKey>}\n     * @protected\n     */\n    this.listenerKeys = [];\n\n  }\n\n  // === Dynamic property getters/setters ===\n\n  /**\n   * @return {boolean} Active\n   * @export\n   */\n  get active() {\n    return this.active_;\n  }\n\n  /**\n   * @param {boolean} active Active\n   * @export\n   */\n  set active(active) {\n    this.active_ = active;\n  }\n\n  /**\n   * The `expression` property does not have conventionnal getter/setters\n   * method because of a limitation of the compiler. It doesn't support\n   * yet having such methods being extended in child classes.\n   *\n   * See: https://github.com/google/closure-compiler/issues/1089\n   *\n   * @return {?number|string} Expression\n   * @export\n   */\n  getExpression() {\n    return this.expression;\n  }\n\n  /**\n   * @param {?number|string} expression Expression\n   * @export\n   */\n  setExpression(expression) {\n    this.expression = expression;\n  }\n\n  /**\n   * @return {?number} Lower boundary\n   * @export\n   */\n  get lowerBoundary() {\n    return this.lowerBoundary_;\n  }\n\n  /**\n   * @param {?number} lowerBoundary Lower boundary\n   * @export\n   */\n  set lowerBoundary(lowerBoundary) {\n    this.lowerBoundary_ = lowerBoundary;\n  }\n\n  /**\n   * @return {?string} Operator\n   * @export\n   */\n  get operator() {\n    return this.operator_;\n  }\n\n  /**\n   * @param {?string} operator Operator\n   * @export\n   */\n  set operator(operator) {\n    this.operator_ = operator;\n  }\n\n  /**\n   * @return {?number} Upper boundary\n   * @export\n   */\n  get upperBoundary() {\n    return this.upperBoundary_;\n  }\n\n  /**\n   * @param {?number} upperBoundary Upper boundary\n   * @export\n   */\n  set upperBoundary(upperBoundary) {\n    this.upperBoundary_ = upperBoundary;\n  }\n\n  // === Static property getters/setters ===\n\n  /**\n   * @return {boolean} Is custom.\n   * @export\n   */\n  get isCustom() {\n    return this.isCustom_;\n  }\n\n  /**\n   * @return {string} name\n   * @export\n   */\n  get name() {\n    return this.name_;\n  }\n\n  /**\n   * @return {?Array.<string>} Operators\n   * @export\n   */\n  get operators() {\n    return this.operators_;\n  }\n\n  /**\n   * @return {string} Property name\n   * @export\n   */\n  get propertyName() {\n    return this.propertyName_;\n  }\n\n  /**\n   * @return {string} Type\n   * @export\n   */\n  get type() {\n    return this.type_;\n  }\n\n  // === Calculated property getters ===\n\n  /**\n   * @return {?ngeox.rule.RuleSimpleValue|ngeox.rule.RuleRangeValue} Value.\n   * @export\n   */\n  get value() {\n    let value = null;\n\n    const expression = this.getExpression();\n    const lowerBoundary = this.lowerBoundary;\n    const operator = this.operator;\n    const propertyName = this.propertyName;\n    const upperBoundary = this.upperBoundary;\n\n    if (operator) {\n      if (operator === exports.OperatorType.BETWEEN ||\n          operator === exports.TemporalOperatorType.DURING) {\n        if (lowerBoundary !== null && upperBoundary !== null) {\n          value = {\n            operator,\n            lowerBoundary,\n            propertyName,\n            upperBoundary\n          };\n        }\n      } else {\n        if (expression !== null) {\n          value = {\n            expression,\n            operator,\n            propertyName\n          };\n        }\n      }\n    }\n\n    return value;\n  }\n\n  // === Other utility methods ===\n\n  /**\n   * Reset the following properties to `null`: expression, lowerBoundary,\n   * upperBoundary.\n   * @export\n   */\n  reset() {\n    if (this.getExpression() !== null) {\n      this.setExpression(null);\n    }\n    if (this.lowerBoundary !== null) {\n      this.lowerBoundary = null;\n    }\n    if (this.upperBoundary !== null) {\n      this.upperBoundary = null;\n    }\n  }\n\n  /**\n   * @export\n   */\n  destroy() {\n    this.listenerKeys.forEach(olEvents.unlistenByKey);\n    this.listenerKeys.length = 0;\n  }\n\n};\n\n\n/**\n * @enum {string}\n */\nexports.OperatorType = {\n  BETWEEN: '..',\n  EQUAL_TO: '=',\n  GREATER_THAN: '>',\n  GREATER_THAN_OR_EQUAL_TO: '>=',\n  LESSER_THAN: '<',\n  LESSER_THAN_OR_EQUAL_TO: '<=',\n  LIKE: '~',\n  NOT_EQUAL_TO: '!='\n};\n\n\n/**\n * @enum {string}\n */\nexports.SpatialOperatorType = {\n  CONTAINS: 'contains',\n  INTERSECTS: 'intersects',\n  WITHIN: 'within'\n};\n\n\n/**\n * @enum {string}\n */\nexports.TemporalOperatorType = {\n  BEGINS: 'time_start',\n  DURING: 'time_during',\n  ENDS: 'time_end',\n  EQUALS: 'time_equal'\n};\n\n\nexport default exports;\n","/**\n * @module gmf\n */\nconst exports = {};\n\n/**\n * The default template base URL for modules, used as-is by the template cache.\n * @type {string}\n */\n\n/**\n * @const\n * @export\n */\nexports.DATALAYERGROUP_NAME = 'data';\n\n/**\n * @const\n * @export\n */\nexports.EXTERNALLAYERGROUP_NAME = 'external';\n\n/**\n * @const\n * @export\n */\nexports.COORDINATES_LAYER_NAME = 'gmfCoordinatesLayerName';\n\n\n/**\n * @enum {string}\n */\nexports.PermalinkParam = {\n  BG_LAYER: 'baselayer_ref',\n  BG_LAYER_OPACITY: 'baselayer_opacity',\n  EXTERNAL_DATASOURCES_NAMES: 'eds_n',\n  EXTERNAL_DATASOURCES_URLS: 'eds_u',\n  FEATURES: 'rl_features',\n  MAP_CROSSHAIR: 'map_crosshair',\n  MAP_TOOLTIP: 'map_tooltip',\n  MAP_X: 'map_x',\n  MAP_Y: 'map_y',\n  MAP_Z: 'map_zoom',\n  TREE_GROUPS: 'tree_groups',\n  WFS_LAYER: 'wfs_layer',\n  WFS_NGROUPS: 'wfs_ngroups',\n  WFS_SHOW_FEATURES: 'wfs_showFeatures'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.ToolActivate\n */\n/**\n * A simple object that can be managed by `ngeo.misc.ToolActivateMgr`.\n *\n * See our live examples:\n * [../examples/mapquery.html](../examples/mapquery.html)\n * [../examples/toolActivate.html](../examples/toolActivate.html)\n *\n * @param {Object} toolContext An object which acts as the context for the tool.\n * @param {string} activePropertyName The name of a boolean property on\n *      `toolContext` which represents the active state of the tool.\n * @constructor\n * @struct\n * @ngname ngeoToolActivate\n * @export\n */\nconst exports = function(toolContext, activePropertyName) {\n\n  /**\n   * A getter function to get the active state of the tool.\n   * @return {boolean} Is active.\n   * @export\n   */\n  this.getActive = function() {\n    return toolContext[activePropertyName];\n  };\n\n  /**\n   * A setter function to set the active state of the tool.\n   * @param {boolean} newVal New active state.\n   * @export\n   */\n  this.setActive = function(newVal) {\n    toolContext[activePropertyName] = newVal;\n  };\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.FeatureHelper\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDownloadService from 'ngeo/download/service.js';\n\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionMeasure from 'ngeo/interaction/Measure.js';\nimport ngeoInteractionMeasureAzimut from 'ngeo/interaction/MeasureAzimut.js';\nimport * as olArray from 'ol/array.js';\nimport * as olColor from 'ol/color.js';\nimport * as olExtent from 'ol/extent.js';\nimport olFeature from 'ol/Feature.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomMultiLineString from 'ol/geom/MultiLineString.js';\nimport olGeomMultiPoint from 'ol/geom/MultiPoint.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olGeomMultiPolygon from 'ol/geom/MultiPolygon.js';\nimport olFormatGPX from 'ol/format/GPX.js';\nimport olFormatKML from 'ol/format/KML.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleRegularShape from 'ol/style/RegularShape.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\n\n/**\n * Provides methods for features, such as:\n *  - style setting / getting\n *  - measurement\n *  - export\n *\n * @constructor\n * @struct\n * @param {!angular.$injector} $injector Main injector.\n * @param {!angular.$filter} $filter Angular filter.\n * @ngdoc service\n * @ngname ngeoFeatureHelper\n * @ngInject\n */\nconst exports = function($injector, $filter) {\n\n  /**\n   * @type {!angular.$filter}\n   * @private\n   */\n  this.$filter_ = $filter;\n\n  /**\n   * @type {number|undefined}\n   * @private\n   */\n  this.decimals_ = undefined;\n  if ($injector.has('ngeoMeasureDecimals')) {\n    this.decimals_ = $injector.get('ngeoMeasureDecimals');\n  }\n\n\n  /**\n   * @type {number|undefined}\n   * @private\n   */\n  this.precision_ = undefined;\n  if ($injector.has('ngeoMeasurePrecision')) {\n    this.precision_ = $injector.get('ngeoMeasurePrecision');\n  }\n\n  /**\n   * @type {!ngeox.number}\n   */\n  this.numberFormat_ = /** @type {ngeox.number} */ ($filter('number'));\n\n  /**\n   * @type {!ngeox.unitPrefix}\n   */\n  this.unitPrefixFormat_ = /** @type {ngeox.unitPrefix} */ ($filter('ngeoUnitPrefix'));\n\n  /**\n   * @type {!ngeox.numberCoordinates}\n   */\n  this.ngeoNumberCoordinates_ = /** @type {ngeox.numberCoordinates} */ ($filter('ngeoNumberCoordinates'));\n\n  /**\n   * Filter function to display point coordinates or null to don't use any filter.\n   * @type {function(*):string|null}\n   * @private\n   */\n  this.pointFilterFn_ = null;\n\n  /**\n   * Arguments to apply to the point filter function.\n   * @type {Array.<*>}\n   * @private\n   */\n  this.pointFilterArgs_ = [];\n\n  if ($injector.has('ngeoPointfilter')) {\n    const filterElements = $injector.get('ngeoPointfilter').split(':');\n    const filterName = filterElements.shift();\n    const filter = this.$filter_(filterName);\n    googAsserts.assertFunction(filter);\n    this.pointFilterFn_ = filter;\n    this.pointFilterArgs_ = filterElements;\n  } else {\n    this.pointFilterFn_ = null;\n  }\n\n  /**\n   * @type {!ol.proj.Projection}\n   * @private\n   */\n  this.projection_;\n\n  /**\n   * Download service.\n   * @type {ngeox.Download}\n   * @private\n   */\n  this.download_ = $injector.get('ngeoDownload');\n\n};\n\n\n/**\n * @param {!ol.proj.Projection} projection Projection.\n * @export\n */\nexports.prototype.setProjection = function(projection) {\n  this.projection_ = projection;\n};\n\n\n// === STYLE METHODS ===\n\n\n/**\n * Set the style of a feature using its inner properties and depending on\n * its geometry type.\n * @param {!ol.Feature} feature Feature.\n * @param {boolean=} opt_select Whether the feature should be rendered as\n *     selected, which includes additional vertex and halo styles.\n * @export\n */\nexports.prototype.setStyle = function(feature, opt_select) {\n  const styles = this.getStyle(feature);\n  if (opt_select) {\n    if (this.supportsVertex_(feature)) {\n      styles.push(this.getVertexStyle());\n    }\n    styles.unshift(this.getHaloStyle_(feature));\n  }\n  feature.setStyle(styles);\n};\n\n\n/**\n * Create and return a style object from a given feature using its inner\n * properties and depending on its geometry type.\n * @param {!ol.Feature} feature Feature.\n * @return {!Array.<!ol.style.Style>} The style object.\n * @export\n */\nexports.prototype.getStyle = function(feature) {\n  const type = this.getType(feature);\n  let style;\n\n  switch (type) {\n    case ngeoGeometryType.LINE_STRING:\n      style = this.getLineStringStyle_(feature);\n      break;\n    case ngeoGeometryType.POINT:\n      style = this.getPointStyle_(feature);\n      break;\n    case ngeoGeometryType.CIRCLE:\n    case ngeoGeometryType.POLYGON:\n    case ngeoGeometryType.RECTANGLE:\n      style = this.getPolygonStyle_(feature);\n      break;\n    case ngeoGeometryType.TEXT:\n      style = this.getTextStyle_(feature);\n      break;\n    default:\n      break;\n  }\n\n  googAsserts.assert(style, 'Style should be thruthy');\n\n  let styles;\n  if (style.constructor === Array) {\n    styles = /** @type {!Array.<!ol.style.Style>}*/ (style);\n  } else {\n    styles = [style];\n  }\n\n  return styles;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature with linestring geometry.\n * @return {!Array.<!ol.style.Style>} Style.\n * @private\n */\nexports.prototype.getLineStringStyle_ = function(feature) {\n  const strokeWidth = this.getStrokeProperty(feature);\n  const showLabel = this.getShowLabelProperty(feature);\n  const showMeasure = this.getShowMeasureProperty(feature);\n  const color = this.getRGBAColorProperty(feature);\n\n  const styles = [new olStyleStyle({\n    stroke: new olStyleStroke({\n      color: color,\n      width: strokeWidth\n    })\n  })];\n  //Label Style\n  const textLabelValues = [];\n  if (showMeasure) {\n    textLabelValues.push(this.getMeasure(feature));\n  }\n  if (showLabel) {\n    textLabelValues.push(this.getNameProperty(feature));\n  }\n  if (showLabel ||  showMeasure) {\n    // display both label using  \\n\n    const textLabelValue = textLabelValues.join('\\n');\n    styles.push(new olStyleStyle({\n      text: this.createTextStyle_({\n        text: textLabelValue\n      })\n    }));\n  }\n  return styles;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature with point geometry.\n * @return {!Array.<!ol.style.Style>} Style.\n * @private\n */\nexports.prototype.getPointStyle_ = function(feature) {\n  const size = this.getSizeProperty(feature);\n  const color = this.getRGBAColorProperty(feature);\n  const showLabel = this.getShowLabelProperty(feature);\n  const showMeasure = this.getShowMeasureProperty(feature);\n  const styles = [new olStyleStyle({\n    image: new olStyleCircle({\n      radius: size,\n      fill: new olStyleFill({\n        color: color\n      })\n    })\n  })];\n  // Label Style\n  const textLabelValues = [];\n  if (showMeasure) {\n    textLabelValues.push(this.getMeasure(feature));\n  }\n  if (showLabel) {\n    textLabelValues.push(this.getNameProperty(feature));\n  }\n  if (showLabel ||  showMeasure) {\n    // display both label using  \\n\n    const textLabelValue = textLabelValues.join('\\n');\n    const font_size = 10;\n    // https://reeddesign.co.uk/test/points-pixels.html\n    const point_to_px = 1.3;\n    styles.push(new olStyleStyle({\n      text: this.createTextStyle_({\n        text: textLabelValue,\n        size: font_size,\n        offsetY: -(size + (font_size / 2) * textLabelValues.length * point_to_px + 4)\n      })\n    }));\n  }\n  return styles;\n};\n\n\n/**\n * Get an optional number feature attribute.\n *\n * @param {!ol.Feature} feature Feature.\n * @param {string} attrib The attribute name.\n * @return {number|undefined}, The attribute value\n */\nexports.prototype.optNumber = function(feature, attrib) {\n  const value = feature.get(attrib);\n  if (value !== undefined) {\n    if (typeof value == 'string') {\n      return +value;\n    } else {\n      return googAsserts.assertNumber(value);\n    }\n  } else {\n    return undefined;\n  }\n};\n\n\n/**\n * Get a number feature attribute.\n *\n * @param {!ol.Feature} feature Feature.\n * @param {string} attrib The attribute name.\n * @return {number}, The attribute value\n */\nexports.prototype.getNumber = function(feature, attrib) {\n  const value = feature.get(attrib);\n  if (typeof value == 'string') {\n    return +value;\n  } else {\n    return googAsserts.assertNumber(value);\n  }\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature with polygon geometry.\n * @return {!Array.<!ol.style.Style>} Style.\n * @private\n */\nexports.prototype.getPolygonStyle_ = function(feature) {\n  const strokeWidth = this.getStrokeProperty(feature);\n  const opacity = this.getOpacityProperty(feature);\n  const color = this.getRGBAColorProperty(feature);\n  const showLabel = this.getShowLabelProperty(feature);\n  const showMeasure = this.getShowMeasureProperty(feature);\n\n  // fill color with opacity\n  const fillColor = color.slice();\n  fillColor[3] = opacity;\n\n  const azimut = this.optNumber(feature, ngeoFormatFeatureProperties.AZIMUT);\n\n  const styles = [new olStyleStyle({\n    fill: new olStyleFill({\n      color: fillColor\n    }),\n    stroke: new olStyleStroke({\n      color: color,\n      width: strokeWidth\n    })\n  })];\n  if (showMeasure || showLabel) {\n    if (showMeasure && azimut !== undefined) {\n      // Radius style:\n      const line = this.getRadiusLine(feature, azimut);\n      const length = ngeoInteractionMeasure.getFormattedLength(\n        line, this.projection_, this.precision_, this.unitPrefixFormat_);\n\n      styles.push(new olStyleStyle({\n        geometry: line,\n        fill: new olStyleFill({\n          color: fillColor\n        }),\n        stroke: new olStyleStroke({\n          color: color,\n          width: strokeWidth\n        }),\n        text: this.createTextStyle_({\n          text: length,\n          angle: ((azimut % 180) + 180) % 180 - 90\n        })\n      }));\n\n      // Azimut style\n      styles.push(new olStyleStyle({\n        geometry: new olGeomPoint(line.getLastCoordinate()),\n        text: this.createTextStyle_({\n          text: `${this.numberFormat_(azimut, this.decimals_)}°`,\n          size: 10,\n          offsetX: Math.cos((azimut - 90) * Math.PI / 180) * 20,\n          offsetY: Math.sin((azimut - 90) * Math.PI / 180) * 20\n        })\n      }));\n\n      //Label Style\n      if (showLabel) {\n        styles.push(new olStyleStyle({\n          text: this.createTextStyle_({\n            text: this.getNameProperty(feature),\n            offsetY: -8,\n            exceedLength: true\n          })\n        }));\n      }\n    } else {\n      //Label Style\n      const textLabelValues = [];\n      if (showMeasure) {\n        textLabelValues.push(this.getMeasure(feature));\n      }\n      if (showLabel) {\n        textLabelValues.push(this.getNameProperty(feature));\n      }\n      if (showLabel ||  showMeasure) {\n        // display both label using  \\n\n        const textLabelValue = textLabelValues.join('\\n');\n        styles.push(new olStyleStyle({\n          text: this.createTextStyle_({\n            text: textLabelValue,\n            exceedLength: true\n          })\n        }));\n      }\n    }\n  }\n  return styles;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature with point geometry, rendered as text.\n * @return {!ol.style.Style} Style.\n * @private\n */\nexports.prototype.getTextStyle_ = function(feature) {\n\n  return new olStyleStyle({\n    text: this.createTextStyle_({\n      text: this.getNameProperty(feature),\n      size: this.getSizeProperty(feature),\n      angle: this.getAngleProperty(feature),\n      color: this.getRGBAColorProperty(feature),\n      width: this.getStrokeProperty(feature)\n    })\n  });\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature to create the editing styles with.\n * @return {!Array.<!ol.style.Style>} List of style.\n * @export\n */\nexports.prototype.createEditingStyles = function(feature) {\n  // (1) Style definition depends on geometry type\n  const white = [255, 255, 255, 1];\n  const blue = [0, 153, 255, 1];\n  const width = 3;\n  const styles = [];\n\n  const geom = feature.getGeometry();\n  console.assert(geom);\n  const type = geom.getType();\n\n  if (type === 'Point') {\n    styles.push(\n      new olStyleStyle({\n        image: new olStyleCircle({\n          radius: width * 2,\n          fill: new olStyleFill({\n            color: blue\n          }),\n          stroke: new olStyleStroke({\n            color: white,\n            width: width / 2\n          })\n        }),\n        zIndex: Infinity\n      })\n    );\n  } else {\n    if (type === 'LineString') {\n      styles.push(\n        new olStyleStyle({\n          stroke: new olStyleStroke({\n            color: white,\n            width: width + 2\n          })\n        })\n      );\n      styles.push(\n        new olStyleStyle({\n          stroke: new olStyleStroke({\n            color: blue,\n            width: width\n          })\n        })\n      );\n    } else {\n      styles.push(\n        new olStyleStyle({\n          stroke: new olStyleStroke({\n            color: blue,\n            width: width / 2\n          }),\n          fill: new olStyleFill({\n            color: [255, 255, 255, 0.5]\n          })\n        })\n      );\n    }\n\n    // (2) Anything else than 'Point' requires the vertex style as well\n    styles.push(this.getVertexStyle(true));\n  }\n\n  return styles;\n};\n\n\n/**\n * Create and return a style object to be used for vertex.\n * @param {boolean=} opt_incGeomFunc Whether to include the geometry function\n *     or not. One wants to use the geometry function when you want to draw\n *     the vertex of features that don't have point geometries. One doesn't\n *     want to include the geometry function if you just want to have the\n *     style object itself to be used to draw features that have point\n *     geometries. Defaults to `true`.\n * @return {!ol.style.Style} Style.\n * @export\n */\nexports.prototype.getVertexStyle = function(opt_incGeomFunc) {\n  const incGeomFunc = opt_incGeomFunc !== undefined ? opt_incGeomFunc : true;\n\n  const options = {\n    image: new olStyleRegularShape({\n      radius: 6,\n      points: 4,\n      angle: Math.PI / 4,\n      fill: new olStyleFill({\n        color: [255, 255, 255, 0.5]\n      }),\n      stroke: new olStyleStroke({\n        color: [0, 0, 0, 1]\n      })\n    })\n  };\n\n  if (incGeomFunc) {\n    options.geometry = function(feature) {\n      const geom = feature.getGeometry();\n\n      if (geom.getType() == 'Point') {\n        return;\n      }\n\n      let innerMultiCoordinates;\n      let multiCoordinates = [];\n      let coordinates = [];\n      let i, ii;\n      if (geom instanceof olGeomLineString) {\n        coordinates = geom.getCoordinates();\n      } else if (geom instanceof olGeomMultiLineString) {\n        multiCoordinates = geom.getCoordinates();\n      } else if (geom instanceof olGeomPolygon) {\n        coordinates = geom.getCoordinates()[0];\n      } else if (geom instanceof olGeomMultiPolygon) {\n        innerMultiCoordinates = geom.getCoordinates();\n      }\n\n      if (innerMultiCoordinates) {\n        for (i = 0, ii = innerMultiCoordinates.length; i < ii; i++) {\n          multiCoordinates = multiCoordinates.concat(innerMultiCoordinates[i]);\n        }\n      }\n      for (i = 0, ii = multiCoordinates.length; i < ii; i++) {\n        coordinates = coordinates.concat(multiCoordinates[i]);\n      }\n\n      if (coordinates.length) {\n        return new olGeomMultiPoint(coordinates);\n      } else {\n        return geom;\n      }\n    };\n  }\n\n  return new olStyleStyle(options);\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {boolean} Whether the feature supports vertex or not.\n * @private\n */\nexports.prototype.supportsVertex_ = function(feature) {\n  const supported = [\n    ngeoGeometryType.LINE_STRING,\n    ngeoGeometryType.POLYGON,\n    ngeoGeometryType.RECTANGLE\n  ];\n  const type = this.getType(feature);\n  return olArray.includes(supported, type);\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {!ol.style.Style} Style.\n * @private\n */\nexports.prototype.getHaloStyle_ = function(feature) {\n  const type = this.getType(feature);\n  let style;\n  const haloSize = 3;\n\n  switch (type) {\n    case ngeoGeometryType.POINT:\n      const size = this.getSizeProperty(feature);\n      style = new olStyleStyle({\n        image: new olStyleCircle({\n          radius: size + haloSize,\n          fill: new olStyleFill({\n            color: [255, 255, 255, 1]\n          })\n        })\n      });\n      break;\n    case ngeoGeometryType.LINE_STRING:\n    case ngeoGeometryType.CIRCLE:\n    case ngeoGeometryType.POLYGON:\n    case ngeoGeometryType.RECTANGLE:\n      const strokeWidth = this.getStrokeProperty(feature);\n      style = new olStyleStyle({\n        stroke: new olStyleStroke({\n          color: [255, 255, 255, 1],\n          width: strokeWidth + haloSize * 2\n        })\n      });\n      break;\n    case ngeoGeometryType.TEXT:\n      style = new olStyleStyle({\n        text: this.createTextStyle_({\n          text: this.getNameProperty(feature),\n          size: this.getSizeProperty(feature),\n          angle: this.getAngleProperty(feature),\n          width: haloSize * 3\n        })\n      });\n      break;\n    default:\n      break;\n  }\n\n  googAsserts.assert(style, 'Style should be thruthy');\n\n  return style;\n};\n\n\n// === PROPERTY GETTERS ===\n\n/**\n * Delete the unwanted ol3 properties from the current feature then return the\n * properties.\n * Also delete the 'ngeo_feature_type_' from the ngeo query system.\n * @param {!ol.Feature} feature Feature.\n * @return {!Object.<string, *>} Filtered properties of the current feature.\n * @export\n */\nexports.getFilteredFeatureValues = function(feature) {\n  const properties = feature.getProperties();\n  delete properties['boundedBy'];\n  delete properties[feature.getGeometryName()];\n  delete properties['ngeo_feature_type_'];\n  return properties;\n};\n\n/**\n * @param {ol.Feature} feature Feature.\n * @return {number} Angle.\n * @export\n */\nexports.prototype.getAngleProperty = function(feature) {\n  const angle = +(/** @type {string} */ (\n    feature.get(ngeoFormatFeatureProperties.ANGLE)));\n  googAsserts.assertNumber(angle);\n  return angle;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {string} Color.\n * @export\n */\nexports.prototype.getColorProperty = function(feature) {\n\n  const color = googAsserts.assertString(feature.get(ngeoFormatFeatureProperties.COLOR));\n\n  googAsserts.assertString(color);\n\n  return color;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {ol.Color} Color.\n * @export\n */\nexports.prototype.getRGBAColorProperty = function(feature) {\n  return olColor.fromString(this.getColorProperty(feature));\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {string} Name.\n * @export\n */\nexports.prototype.getNameProperty = function(feature) {\n  const name = googAsserts.assertString(feature.get(ngeoFormatFeatureProperties.NAME));\n  googAsserts.assertString(name);\n  return name;\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {number} Opacity.\n * @export\n */\nexports.prototype.getOpacityProperty = function(feature) {\n  return this.getNumber(feature, ngeoFormatFeatureProperties.OPACITY);\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {boolean} Show measure.\n * @export\n */\nexports.prototype.getShowMeasureProperty = function(feature) {\n  let showMeasure = feature.get(ngeoFormatFeatureProperties.SHOW_MEASURE);\n  if (showMeasure === undefined) {\n    showMeasure = false;\n  } else if (typeof showMeasure === 'string') {\n    showMeasure = (showMeasure === 'true') ? true : false;\n  }\n  return googAsserts.assertBoolean(showMeasure);\n};\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {boolean} Show feature label.\n * @export\n */\nexports.prototype.getShowLabelProperty = function(feature) {\n  let showLabel = feature.get(ngeoFormatFeatureProperties.SHOW_LABEL);\n  if (showLabel === undefined) {\n    showLabel = false;\n  } else if (typeof showLabel === 'string') {\n    showLabel = (showLabel === 'true') ? true : false;\n  }\n  return googAsserts.assertBoolean(showLabel);\n};\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {number} Size.\n * @export\n */\nexports.prototype.getSizeProperty = function(feature) {\n  return this.getNumber(feature, ngeoFormatFeatureProperties.SIZE);\n};\n\n\n/**\n * @param {!ol.Feature} feature Feature.\n * @return {number} Stroke.\n * @export\n */\nexports.prototype.getStrokeProperty = function(feature) {\n  return this.getNumber(feature, ngeoFormatFeatureProperties.STROKE);\n};\n\n\n// === EXPORT ===\n\n\n/**\n * Export features in the given format. The projection of the exported features\n * is: `EPSG:4326`.\n * @param {!Array.<!ol.Feature>} features Array of vector features.\n * @param {string} formatType Format type to export the features.\n * @export\n */\nexports.prototype.export = function(features, formatType) {\n  switch (formatType) {\n    case exports.FormatType.GPX:\n      this.exportGPX(features);\n      break;\n    case exports.FormatType.KML:\n      this.exportKML(features);\n      break;\n    default:\n      break;\n  }\n};\n\n\n/**\n * Export features in GPX and download the result to the browser. The\n * projection of the exported features is: `EPSG:4326`.\n * @param {!Array.<!ol.Feature>} features Array of vector features.\n * @export\n */\nexports.prototype.exportGPX = function(features) {\n  const format = new olFormatGPX();\n  const mimeType = 'application/gpx+xml';\n  const fileName = 'export.gpx';\n  this.export_(features, format, fileName, mimeType);\n};\n\n\n/**\n * Export features in KML and download the result to the browser. The\n * projection of the exported features is: `EPSG:4326`.\n * @param {!Array.<!ol.Feature>} features Array of vector features.\n * @export\n */\nexports.prototype.exportKML = function(features) {\n  const format = new olFormatKML();\n  const mimeType = 'application/vnd.google-earth.kml+xml';\n  const fileName = 'export.kml';\n  this.export_(features, format, fileName, mimeType);\n};\n\n\n/**\n * Export features using a given format to a specific filename and download\n * the result to the browser. The projection of the exported features is:\n * `EPSG:4326`.\n * @param {!Array.<!ol.Feature>} features Array of vector features.\n * @param {!ol.format.Feature} format Format\n * @param {string} fileName Name of the file.\n * @param {string=} opt_mimeType Mime type. Defaults to 'text/plain'.\n * @private\n */\nexports.prototype.export_ = function(features, format, fileName, opt_mimeType) {\n  const mimeType = opt_mimeType !== undefined ? opt_mimeType : 'text/plain';\n\n  // clone the features to apply the original style to the clone\n  // (the original may have select style active)\n  const clones = [];\n  let clone;\n  features.forEach((feature) => {\n    clone = new olFeature(feature.getProperties());\n    this.setStyle(clone, false);\n    clones.push(clone);\n  });\n\n  const writeOptions = this.projection_ ? {\n    dataProjection: 'EPSG:4326',\n    featureProjection: this.projection_\n  } : {};\n\n  const data = format.writeFeatures(clones, writeOptions);\n  this.download_(\n    data, fileName, `${mimeType};charset=utf-8`);\n};\n\n\n// === OTHER UTILITY METHODS ===\n\n\n/**\n * @param {!ngeox.style.TextOptions} options Options.\n * @return {!ol.style.Text} Style.\n * @private\n */\nexports.prototype.createTextStyle_ = function(options) {\n  if (options.angle) {\n    const angle = options.angle !== undefined ? options.angle : 0;\n    const rotation = angle * Math.PI / 180;\n    options.rotation = rotation;\n    delete options.angle;\n  }\n\n  options.font = ['normal', `${options.size || 10}pt`, 'Arial'].join(' ');\n\n  if (options.color) {\n    options.fill = new olStyleFill({color: options.color || [0, 0, 0, 1]});\n    delete options.color;\n  }\n\n  options.stroke = new olStyleStroke({\n    color: [255, 255, 255, 1],\n    width: options.width || 3\n  });\n  delete options.width;\n\n  return new olStyleText(options);\n};\n\n\n/**\n * Get the measure of the given feature as a string. For points, you can format\n * the result by setting a filter to apply on the coordinate with the function\n * {@link ngeo.misc.FeatureHelper.prototype.setPointFilterFn}.\n * @param {!ol.Feature} feature Feature.\n * @return {string} Measure.\n * @export\n */\nexports.prototype.getMeasure = function(feature) {\n\n  const geometry = feature.getGeometry();\n  googAsserts.assert(geometry, 'Geometry should be truthy');\n\n  let measure = '';\n\n  if (geometry instanceof olGeomPolygon) {\n    if (this.getType(feature) === ngeoGeometryType.CIRCLE) {\n      const azimut = this.optNumber(feature, ngeoFormatFeatureProperties.AZIMUT);\n      googAsserts.assertNumber(azimut);\n      const line = this.getRadiusLine(feature, azimut);\n\n      measure = ngeoInteractionMeasureAzimut.getFormattedAzimutRadius(\n        line, this.projection_, this.decimals_, this.precision_, this.unitPrefixFormat_, this.numberFormat_);\n    } else {\n      measure = ngeoInteractionMeasure.getFormattedArea(\n        geometry, this.projection_, this.precision_, this.unitPrefixFormat_);\n    }\n  } else if (geometry instanceof olGeomLineString) {\n    measure = ngeoInteractionMeasure.getFormattedLength(\n      geometry, this.projection_, this.precision_, this.unitPrefixFormat_);\n  } else if (geometry instanceof olGeomPoint) {\n    if (this.pointFilterFn_ === null) {\n      measure = ngeoInteractionMeasure.getFormattedPoint(\n        geometry, this.decimals_, this.ngeoNumberCoordinates_);\n    } else {\n      const coordinates = geometry.getCoordinates();\n      const args = this.pointFilterArgs_.slice(0);\n      args.unshift(coordinates);\n      measure = this.pointFilterFn_(...args);\n    }\n  }\n\n  return measure;\n};\n\n\n/**\n * Return the type of geometry of a feature using its geometry property and\n * some inner properties.\n * @param {!ol.Feature} feature Feature.\n * @return {string} The type of geometry.\n * @export\n */\nexports.prototype.getType = function(feature) {\n  const geometry = feature.getGeometry();\n  googAsserts.assert(geometry, 'Geometry should be thruthy');\n\n  let type;\n\n  if (geometry instanceof olGeomPoint) {\n    if (feature.get(ngeoFormatFeatureProperties.IS_TEXT)) {\n      type = ngeoGeometryType.TEXT;\n    } else {\n      type = ngeoGeometryType.POINT;\n    }\n  } else if (geometry instanceof olGeomMultiPoint) {\n    type = ngeoGeometryType.MULTI_POINT;\n  } else if (geometry instanceof olGeomPolygon) {\n    if (feature.get(ngeoFormatFeatureProperties.IS_CIRCLE)) {\n      type = ngeoGeometryType.CIRCLE;\n    } else if (feature.get(ngeoFormatFeatureProperties.IS_RECTANGLE)) {\n      type = ngeoGeometryType.RECTANGLE;\n    } else {\n      type = ngeoGeometryType.POLYGON;\n    }\n  } else if (geometry instanceof olGeomMultiPolygon) {\n    type = ngeoGeometryType.MULTI_POLYGON;\n  } else if (geometry instanceof olGeomLineString) {\n    type = ngeoGeometryType.LINE_STRING;\n  } else if (geometry instanceof olGeomMultiLineString) {\n    type = ngeoGeometryType.MULTI_LINE_STRING;\n  }\n\n  googAsserts.assert(type, 'Type should be thruthy');\n\n  return type;\n};\n\n\n/**\n * This method first checks if a feature's extent intersects with the map view\n * extent. If it doesn't, then the view gets recentered with an animation to\n * the center of the feature.\n * @param {!ol.Feature} feature Feature.\n * @param {!ol.Map} map Map.\n * @param {number=} opt_panDuration Pan animation duration. Defaults to `250`.\n * @export\n */\nexports.prototype.panMapToFeature = function(feature, map,\n  opt_panDuration) {\n\n  const panDuration = opt_panDuration !== undefined ? opt_panDuration : 250;\n  const size = map.getSize();\n  googAsserts.assertArray(size);\n  const view = map.getView();\n  const extent = view.calculateExtent(size);\n  const geometry = feature.getGeometry();\n\n  if (!geometry.intersectsExtent(extent)) {\n    const mapCenter = view.getCenter();\n    googAsserts.assertArray(mapCenter);\n\n    let featureCenter;\n    if (geometry instanceof olGeomLineString) {\n      featureCenter = geometry.getCoordinateAt(0.5);\n    } else if (geometry instanceof olGeomPolygon) {\n      featureCenter = geometry.getInteriorPoint().getCoordinates();\n    } else if (geometry instanceof olGeomPoint) {\n      featureCenter = geometry.getCoordinates();\n    } else {\n      featureCenter = olExtent.getCenter(geometry.getExtent());\n    }\n\n    view.animate({\n      center: mapCenter,\n      duration: panDuration\n    }, {\n      center: featureCenter,\n      duration: panDuration\n    });\n  }\n};\n\n\n/**\n * This method generates a line string geometry that represents the radius for\n * a given azimut. It expects the input geometry to be a circle.\n * @param {!ol.Feature} feature Feature.\n * @param {number} azimut Azimut in degrees.\n * @return {!ol.geom.LineString} The line geometry.\n */\nexports.prototype.getRadiusLine = function(feature, azimut) {\n  const geometry = feature.getGeometry();\n  // Determine the radius for the circle\n  const extent = geometry.getExtent();\n  const radius = (extent[3] - extent[1]) / 2;\n\n  const center = olExtent.getCenter(geometry.getExtent());\n\n  const x = Math.cos((azimut - 90) * Math.PI / 180) * radius;\n  const y = -Math.sin((azimut - 90) * Math.PI / 180) * radius;\n  const endPoint = [x + center[0], y + center[1]];\n  return new olGeomLineString([center, endPoint]);\n};\n\n\n/**\n * Return the properties of a feature, with the exception of the geometry.\n * @param {!ol.Feature} feature Feature.\n * @return {!Object.<string, *>} Object.\n * @export\n */\nexports.prototype.getNonSpatialProperties = function(feature) {\n  const geometryName = feature.getGeometryName();\n  const nonSpatialProperties = {};\n  const properties = feature.getProperties();\n  for (const key in properties) {\n    if (key !== geometryName) {\n      nonSpatialProperties[key] = properties[key];\n    }\n  }\n  return nonSpatialProperties;\n};\n\n\n/**\n * Clear all properties of a feature, with the exception of the geometry.\n * @param {!ol.Feature} feature Feature.\n * @export\n */\nexports.prototype.clearNonSpatialProperties = function(feature) {\n  const geometryName = feature.getGeometryName();\n  const properties = feature.getProperties();\n  for (const key in properties) {\n    if (key !== geometryName) {\n      feature.set(key, undefined);\n    }\n  }\n};\n\n\n// === FORMAT TYPES ===\n\n\n/**\n * @enum {string}\n * @export\n */\nexports.FormatType = {\n  /**\n   * @type {string}\n   * @export\n   */\n  GPX: 'GPX',\n  /**\n   * @type {string}\n   * @export\n   */\n  KML: 'KML'\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoFeatureHelper', [\n  ngeoDownloadService.name,\n  ngeoMiscFilters.name,\n]);\nexports.module.service('ngeoFeatureHelper', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.utils\n */\nconst exports = {};\nimport * as olEventsCondition from 'ol/events/condition.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomMultiPoint from 'ol/geom/MultiPoint.js';\nimport olGeomMultiLineString from 'ol/geom/MultiLineString.js';\nimport olGeomMultiPolygon from 'ol/geom/MultiPolygon.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport {getTopLeft, getTopRight, getBottomLeft, getBottomRight} from 'ol/extent.js';\n\n/**\n * Utility method that converts a simple geometry to its multi equivalent. If\n * the geometry itself is already multi, it is returned as-is.\n * @param {ol.geom.Geometry} geometry A geometry\n * @return {ol.geom.Geometry} A multi geometry\n */\nexports.toMulti = function(geometry) {\n  let multiGeom;\n  if (geometry instanceof olGeomPoint) {\n    multiGeom = new olGeomMultiPoint([]);\n    multiGeom.appendPoint(geometry);\n  } else if (geometry instanceof olGeomLineString) {\n    multiGeom = new olGeomMultiLineString([]);\n    multiGeom.appendLineString(geometry);\n  } else if (geometry instanceof olGeomPolygon) {\n    multiGeom = new olGeomMultiPolygon([]);\n    multiGeom.appendPolygon(geometry);\n  } else {\n    multiGeom = geometry;\n  }\n  return multiGeom;\n};\n\n/**\n * Checks if on Safari.\n * @return {boolean} True if on Safari.\n */\nexports.isSafari = function() {\n  return navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1;\n};\n\n/**\n * Takes a hex value and prepends a zero if it's a single digit.\n * @param {string} hex Hex value to prepend if single digit.\n * @return {string} hex value prepended with zero if it was single digit,\n *     otherwise the same value that was passed in.\n */\nexports.colorZeroPadding = function(hex) {\n  return hex.length == 1 ? `0${hex}` : hex;\n};\n\n/**\n * Converts a color from RGB to hex representation.\n * @param {!Array.<number>} rgb rgb representation of the color.\n * @return {string} hex representation of the color.\n */\nexports.rgbArrayToHex = function(rgb) {\n  const r = rgb[0];\n  const g = rgb[1];\n  const b = rgb[2];\n  if (r != (r & 255) || g != (g & 255) || b != (b & 255)) {\n    throw Error(`\"(${r},${g},${b})\" is not a valid RGB color`);\n  }\n  const hexR = exports.colorZeroPadding(r.toString(16));\n  const hexG = exports.colorZeroPadding(g.toString(16));\n  const hexB = exports.colorZeroPadding(b.toString(16));\n  return `#${hexR}${hexG}${hexB}`;\n};\n\n/**\n * Decode the encoded query string into a query data dictionary.\n * @param {string|undefined} queryString The queryString.\n * @return {!Object.<string, string>} The result.\n */\nexports.decodeQueryString = function(queryString) {\n  const queryData = {};\n  if (queryString) {\n    const pairs = queryString.substring(1).split('&');\n    for (const pair of pairs) {\n      const indexOfEquals = pair.indexOf('=');\n      if (indexOfEquals >= 0) {\n        const name = pair.substring(0, indexOfEquals);\n        const value = pair.substring(indexOfEquals + 1);\n        queryData[decodeURIComponent(name)] = decodeURIComponent(value);\n      } else {\n        queryData[pair] = '';\n      }\n    }\n  }\n  return queryData;\n};\n\n/**\n * Encode the query data dictionary into an encoded query string.\n * @param {!Object.<string, string>} queryData The queryData,\n * @return {string} The result.\n */\nexports.encodeQueryString = function(queryData) {\n  const queryItem = [];\n  for (const key in queryData) {\n    const value = queryData[key];\n    queryItem.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);\n  }\n  return queryItem.join('&');\n};\n\n\n/**\n * Delete condition passed to the modify interaction\n * @param {ol.MapBrowserEvent} event Browser event.\n * @return {boolean} The result.\n */\nexports.deleteCondition = function(event) {\n  return olEventsCondition.noModifierKeys(event) && olEventsCondition.singleClick(event);\n};\n\n/**\n * Takes an ol.Extent and return an Array of ol.Coordinate representing a rectangle polygon.\n * @param {ol.Extent} extent The extent.\n * @return {Array.<ol.Coordinate>} The Array of coordinate of the rectangle.\n */\nexport function extentToRectangle(extent) {\n  return [\n    getTopLeft(extent),\n    getTopRight(extent),\n    getBottomRight(extent),\n    getBottomLeft(extent),\n    getTopLeft(extent),\n  ];\n}\n\nexport default exports;\n","/**\n * @module ngeo.CustomEvent\n */\nimport * as olBase from 'ol/index.js';\nimport olEventsEvent from 'ol/events/Event.js';\n\n/**\n * @constructor\n * @extends {ol.events.Event}\n * @param {string} type Event type.\n * @param {T} detail Event Detail.\n * @template T\n */\nconst exports = function(type, detail = {}) {\n\n  olEventsEvent.call(this, type);\n\n  /**\n   * @type {T}\n   */\n  this.detail = detail;\n\n};\n\nolBase.inherits(exports, olEventsEvent);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.Message\n */\n/**\n * Abstract class for services that display messages.\n *\n * @constructor\n * @struct\n * @abstract\n */\nconst exports = function() {};\n\n\n/**\n * Show the message.\n *\n * @abstract\n * @param {ngeox.Message} message Message.\n * @protected\n */\nexports.prototype.showMessage = function(message) {};\n\n\n/**\n * Show disclaimer message string or object or list of disclame message\n * strings or objects.\n *\n * @param {string|Array.<string>|ngeox.Message|Array.<ngeox.Message>}\n *     object A message or list of messages as text or configuration objects.\n * @export\n */\nexports.prototype.show = function(object) {\n  const msgObjects = this.getMessageObjects(object);\n  msgObjects.forEach(this.showMessage, this);\n};\n\n\n/**\n * Display the given error message or list of error messages.\n *\n * @param {string|Array.<string>} message Message or list of messages.\n * @export\n */\nexports.prototype.error = function(message) {\n  this.show(this.getMessageObjects(message, exports.Type.ERROR));\n};\n\n\n/**\n * Display the given info message or list of info messages.\n * @param {string|Array.<string>} message Message or list of messages.\n * @export\n */\nexports.prototype.info = function(message) {\n  this.show(this.getMessageObjects(message, exports.Type.INFORMATION));\n};\n\n\n/**\n * Display the given success message or list of success messages.\n * @param {string|Array.<string>} message Message or list of messages.\n * @export\n */\nexports.prototype.success = function(message) {\n  this.show(this.getMessageObjects(message, exports.Type.SUCCESS));\n};\n\n\n/**\n * Display the given warning message or list of warning messages.\n * @param {string|Array.<string>} message Message or list of messages.\n * @export\n */\nexports.prototype.warn = function(message) {\n  this.show(this.getMessageObjects(message, exports.Type.WARNING));\n};\n\n\n/**\n * Returns an array of message object from any given message string, list of\n * message strings, message object or list message objects. The type can be\n * overridden here as well OR defined (if the message(s) is/are string(s),\n * defaults to 'information').\n * @param {string|Array.<string>|ngeox.Message|Array.<ngeox.Message>}\n *     object A message or list of messages as text or configuration objects.\n * @param {string=} opt_type The type of message to override the messages with.\n * @return {Array.<ngeox.Message>} List of message objects.\n * @protected\n */\nexports.prototype.getMessageObjects = function(object, opt_type) {\n  const msgObjects = [];\n  let msgObject = null;\n  const defaultType = exports.Type.INFORMATION;\n\n  if (typeof object === 'string') {\n    msgObjects.push({\n      msg: object,\n      type: opt_type !== undefined ? opt_type : defaultType\n    });\n  } else if (Array.isArray(object)) {\n    object.forEach((msg) => {\n      if (typeof object === 'string') {\n        msgObject = {\n          msg: msg,\n          type: opt_type !== undefined ? opt_type : defaultType\n        };\n      } else {\n        msgObject = msg;\n        if (opt_type !== undefined) {\n          msgObject.type = opt_type;\n        }\n      }\n      msgObjects.push(msgObject);\n    }, this);\n  } else {\n    msgObject = object;\n    if (opt_type !== undefined) {\n      msgObject.type = opt_type;\n    }\n    if (msgObject.type === undefined) {\n      msgObject.type = defaultType;\n    }\n    msgObjects.push(msgObject);\n  }\n\n  return msgObjects;\n};\n\n\n/**\n * @enum {string}\n * @export\n */\nexports.Type = {\n  /**\n   * @type {string}\n   * @export\n   */\n  ERROR: 'error',\n  /**\n   * @type {string}\n   * @export\n   */\n  INFORMATION: 'information',\n  /**\n   * @type {string}\n   * @export\n   */\n  SUCCESS: 'success',\n  /**\n   * @type {string}\n   * @export\n   */\n  WARNING: 'warning'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.map.LayerHelper\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olArray from 'ol/array.js';\nimport olFormatWMTSCapabilities from 'ol/format/WMTSCapabilities.js';\nimport OlLayerGroup from 'ol/layer/Group.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport * as olObj from 'ol/obj.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport olSourceWMTS, {optionsFromCapabilities} from 'ol/source/WMTS.js';\nimport * as olUri from 'ol/uri.js';\n\n/**\n * Provides help functions that helps you to create and manage layers.\n * @param {angular.$q} $q Angular promises/deferred service.\n * @param {angular.$http} $http Angular http service.\n * @param {number} ngeoTilesPreloadingLimit Load tiles up to preload levels. By default preload is Infinity,\n *     which means load all tiles on the top of the visible level. See also preload value\n *     in documentation for ol.Layer.Tile.\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoLayerHelper\n * @ngInject\n */\nconst exports = function($q, $http, ngeoTilesPreloadingLimit) {\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.$q_ = $q;\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * The Tiles Preloading Limit value\n   * @type {number}\n   * @private\n   */\n  this.tilesPreloadingLimit_ = ngeoTilesPreloadingLimit;\n};\n\n\n/**\n * @const\n */\nexports.GROUP_KEY = 'groupName';\n\n\n/**\n * @const\n */\nexports.REFRESH_PARAM = 'random';\n\n\n/**\n * Create and return a basic WMS layer with only a source URL and a comma\n * separated layers names (see {@link ol.source.ImageWMS}).\n *\n * @param {string} sourceURL The source URL.\n * @param {string} sourceLayersName A comma separated names string.\n * @param {string} sourceFormat Image format, for example 'image/png'.\n * @param {string=} opt_serverType Type of the server (\"mapserver\",\n *     \"geoserver\", \"qgisserver\", …).\n * @param {string=} opt_time time parameter for layer queryable by time/periode\n * @param {Object.<string, string>=} opt_params WMS parameters.\n * @param {string=} opt_crossOrigin crossOrigin.\n * @param {Object=} opt_customSourceOptions Some initial options.\n * @param {Object=} opt_customLayerOptions The layer opacity.\n * @return {ol.layer.Image} WMS Layer.\n * @export\n */\nexports.prototype.createBasicWMSLayer = function(sourceURL,\n  sourceLayersName, sourceFormat, opt_serverType, opt_time, opt_params, opt_crossOrigin,\n  opt_customSourceOptions, opt_customLayerOptions) {\n\n  const params = {\n    'FORMAT': sourceFormat,\n    'LAYERS': sourceLayersName\n  };\n  let olServerType;\n  if (opt_time) {\n    params['TIME'] = opt_time;\n  }\n  if (opt_serverType) {\n    params['SERVERTYPE'] = opt_serverType;\n    // OpenLayers expects 'qgis' insteads of 'qgisserver'\n    olServerType = opt_serverType.replace('qgisserver', 'qgis');\n  }\n  const options = Object.assign({}, opt_customSourceOptions, {\n    url: sourceURL,\n    params: params,\n    serverType: olServerType,\n    crossOrigin: opt_crossOrigin\n  });\n  const source = new olSourceImageWMS(options);\n  if (opt_params) {\n    source.updateParams(opt_params);\n  }\n\n  const layerOptions = Object.assign({}, opt_customLayerOptions, {source});\n  return new olLayerImage(layerOptions);\n};\n\n\n/**\n * Create and return a basic WMS layer using an OGC data source.\n *\n * @param {ngeo.datasource.OGC} dataSource OGC data source.\n * @param {string=} opt_crossOrigin crossOrigin.\n * @return {ol.layer.Image} WMS Layer.\n * @export\n */\nexports.prototype.createBasicWMSLayerFromDataSource = function(\n  dataSource, opt_crossOrigin\n) {\n  const url = dataSource.wmsUrl;\n  googAsserts.assert(url);\n\n  const layerNames = dataSource.getOGCLayerNames().join(',');\n  const serverType = dataSource.ogcServerType;\n  const imageType = dataSource.ogcImageType;\n\n  // (1) Layer creation\n  const layer = this.createBasicWMSLayer(\n    url,\n    layerNames,\n    imageType,\n    serverType,\n    undefined,\n    undefined,\n    opt_crossOrigin\n  );\n\n  // (2) Manage visibility\n  layer.setVisible(dataSource.visible);\n\n  // (3) Reference to the data source\n  layer.set('querySourceIds', [dataSource.id]);\n\n  return layer;\n};\n\n\n/**\n * Create and return a promise that provides a WMTS layer with source on\n * success, no layer else.\n * The WMTS layer source will be configured by the capabilities that are\n * loaded from the given capabilitiesUrl.\n * The style object described in the capabilities for this layer will be added\n * as key 'capabilitiesStyles' as param of the new layer.\n * @param {string} capabilitiesURL The getCapabilities url.\n * @param {string} layerName The name of the layer.\n * @param {string=} opt_matrixSet Optional WMTS matrix set.\n * @param {Object.<string, string>=} opt_dimensions WMTS dimensions.\n * @param {Object=} opt_customOptions Some initial options.\n * @return {angular.$q.Promise.<ol.layer.Tile>} A Promise with a layer (with source) on success,\n *     no layer else.\n * @export\n */\nexports.prototype.createWMTSLayerFromCapabilitites = function(capabilitiesURL, layerName, opt_matrixSet, opt_dimensions, opt_customOptions) {\n  const parser = new olFormatWMTSCapabilities();\n  const layer = new olLayerTile({\n    preload: this.tilesPreloadingLimit_\n  });\n  const $q = this.$q_;\n\n  return this.$http_.get(capabilitiesURL, {cache: true}).then((response) => {\n    let result;\n    if (response.data) {\n      result = parser.read(response.data);\n    }\n    if (result) {\n      const options = Object.assign({}, opt_customOptions, optionsFromCapabilities(result, {\n        matrixSet: opt_matrixSet,\n        crossOrigin: 'anonymous',\n        layer: layerName\n      }));\n      const source = new olSourceWMTS(/** @type {olx.source.WMTSOptions} */ (options));\n      if (opt_dimensions && !olObj.isEmpty(opt_dimensions)) {\n        source.updateDimensions(opt_dimensions);\n      }\n      layer.setSource(source);\n\n      // Add styles from capabilities as param of the layer\n      const layers = result['Contents']['Layer'];\n      const l = olArray.find(layers, (elt, index, array) => elt['Identifier'] == layerName);\n      layer.set('capabilitiesStyles', l['Style']);\n\n      return $q.resolve(layer);\n    }\n    return $q.reject(`Failed to get WMTS capabilities from ${capabilitiesURL}`);\n  });\n};\n\n\n/**\n * Create and return a WMTS layer using a formatted capabilities response\n * and a capability layer.\n *\n * @param {!Object} capabilities The complete capabilities object of the service\n * @param {!Object} layerCap The layer capability object\n * @param {Object.<string, string>=} opt_dimensions WMTS dimensions.\n * @return {!ol.layer.Tile} WMTS layer\n * @export\n */\nexports.prototype.createWMTSLayerFromCapabilititesObj = function(\n  capabilities, layerCap, opt_dimensions\n) {\n\n  const options = optionsFromCapabilities(capabilities, {\n    crossOrigin: 'anonymous',\n    layer: layerCap['Identifier']\n  });\n\n  googAsserts.assert(options);\n  const source = new olSourceWMTS(\n    /** @type {olx.source.WMTSOptions} */ (options));\n\n  if (opt_dimensions && !olObj.isEmpty(opt_dimensions)) {\n    source.updateDimensions(opt_dimensions);\n  }\n\n  return new olLayerTile({\n    'capabilitiesStyles': layerCap['Style'],\n    preload: Infinity,\n    source: source\n  });\n};\n\n\n/**\n * Create and return an ol.layer.Group. You can pass a collection of layers to\n * directly add them in the returned group.\n * @param {ol.Collection.<ol.layer.Base>=} opt_layers The layer to add to the\n * returned Group.\n * @return {ol.layer.Group} Layer group.\n * @export\n */\nexports.prototype.createBasicGroup = function(opt_layers) {\n  const group = new OlLayerGroup();\n  if (opt_layers) {\n    group.setLayers(opt_layers);\n  }\n  return group;\n};\n\n\n/**\n * Retrieve (or create if it doesn't exist) and return a group of layer from\n * the base array of layers of a map. The given name is used as unique\n * identifier. If the group is created, it will be automatically added to\n * the map.\n * @param {ol.Map} map A map.\n * @param {string} groupName The name of the group.\n * @return {ol.layer.Group} The group corresponding to the given name.\n * @export\n */\nexports.prototype.getGroupFromMap = function(map, groupName) {\n  const groups = map.getLayerGroup().getLayers();\n  let group;\n  groups.getArray().some((existingGroup) => {\n    if (existingGroup.get(exports.GROUP_KEY) === groupName) {\n      group = /** @type {ol.layer.Group} */ (existingGroup);\n      return true;\n    } else {\n      return false;\n    }\n  });\n  if (!group) {\n    group = this.createBasicGroup();\n    group.set(exports.GROUP_KEY, groupName);\n    map.addLayer(group);\n  }\n  return group;\n};\n\n\n/**\n * Get an array of all layers in a group. The group can contain multiple levels\n * of others groups.\n * @param {ol.layer.Base} layer The base layer, mostly a group of layers.\n * @return {Array.<ol.layer.Layer>} Layers.\n * @export\n */\nexports.prototype.getFlatLayers = function(layer) {\n  if (layer instanceof OlLayerGroup) {\n    const sublayers = layer.getLayers().getArray();\n    const hasGroupLayer = sublayers.some(sublayer => sublayer instanceof OlLayerGroup);\n    if (!hasGroupLayer) {\n      return sublayers.slice();\n    }\n  }\n  return this.getFlatLayers_(layer, [], undefined);\n};\n\n\n/**\n * Get an array of all layers in a group. The group can contain multiple levels\n * of others groups. When we flatten a group, we get the child layers.\n * If opacity is defined on the group, this value is lost.\n * Computed opacity is a custom 'back-up' value that contains\n * the calculated value of all ancestors and the given layer.\n * @param {ol.layer.Base} layer The base layer, mostly a group of layers.\n * @param {Array.<ol.layer.Base>} array An array to add layers.\n * @param {number|undefined} computedOpacity Opacity inherited from ancestor layer groups.\n * @return {Array.<ol.layer.Layer>} Layers.\n * @private\n */\nexports.prototype.getFlatLayers_ = function(layer, array, computedOpacity) {\n  const opacity = layer.getOpacity();\n  if (computedOpacity !== undefined) {\n    computedOpacity *= opacity;\n  } else {\n    computedOpacity = opacity;\n  }\n  if (layer instanceof OlLayerGroup) {\n    const sublayers = layer.getLayers();\n    sublayers.forEach((l) => {\n      this.getFlatLayers_(l, array, computedOpacity);\n    });\n  } else {\n    if (array.indexOf(layer) < 0) {\n      layer.set('inheritedOpacity', computedOpacity, true);\n      array.push(layer);\n    }\n  }\n  return array;\n};\n\n\n/**\n * Get a layer that has a `layerName` property equal to a given layer name from\n * an array of layers. If one of the layers in the array is a group, then the\n * layers contained in that group are searched as well.\n * @param {string} layerName The name of the layer we're looking for.\n * @param {Array.<ol.layer.Base>} layers Layers.\n * @return {?ol.layer.Base} Layer.\n * @export\n */\nexports.prototype.getLayerByName = function(layerName, layers) {\n  let found = null;\n  layers.some((layer) => {\n    if (layer instanceof OlLayerGroup) {\n      const sublayers = layer.getLayers().getArray();\n      found = this.getLayerByName(layerName, sublayers);\n    } else if (layer.get('layerNodeName') === layerName) {\n      found = layer;\n    }\n    return !!found;\n  });\n\n  return found;\n};\n\n\n/**\n * Get the WMTS legend URL for the given layer.\n * @param {ol.layer.Tile} layer Tile layer as returned by the\n * ngeo layerHelper service.\n * @return {string|undefined} The legend URL or undefined.\n * @export\n */\nexports.prototype.getWMTSLegendURL = function(layer) {\n  // FIXME case of multiple styles ?  case of multiple legendUrl ?\n  let url;\n  const styles = layer.get('capabilitiesStyles');\n  if (styles !== undefined) {\n    const legendURL = styles[0]['legendURL'];\n    if (legendURL !== undefined) {\n      url = legendURL[0]['href'];\n    }\n  }\n  return url;\n};\n\n\n/**\n * Get the WMS legend URL for the given node.\n * @param {string|undefined} url The base url of the wms service.\n * @param {string} layerName The name of a wms layer.\n * @param {number=} opt_scale A scale.\n * @param {string=} opt_legendRule rule parameters to add to the returned URL.\n * @param {number=} opt_legendWidth the legend width.\n * @param {number=} opt_legendHeight the legend height.\n * @param {string=} opt_servertype the OpenLayers server type.\n * @param {number=} opt_dpi the DPI.\n * @param {Array.number=} opt_bbox the bbox.\n * @param {string=} opt_srs The projection code.\n * @param {Object.<string, string>=} opt_additionalQueryString Additional query string parameters.\n * @return {string|undefined} The legend URL or undefined.\n * @export\n */\nexports.prototype.getWMSLegendURL = function(url,\n  layerName, opt_scale, opt_legendRule, opt_legendWidth, opt_legendHeight,\n  opt_servertype, opt_dpi, opt_bbox, opt_srs, opt_additionalQueryString) {\n  if (!url) {\n    return undefined;\n  }\n  const queryString = {\n    'FORMAT': 'image/png',\n    'TRANSPARENT': true,\n    'SERVICE': 'WMS',\n    'VERSION': '1.1.1',\n    'REQUEST': 'GetLegendGraphic',\n    'LAYER': layerName\n  };\n  if (opt_scale !== undefined) {\n    queryString['SCALE'] = opt_scale;\n  }\n  if (opt_legendRule !== undefined) {\n    queryString['RULE'] = opt_legendRule;\n    if (opt_legendWidth !== undefined) {\n      queryString['WIDTH'] = opt_legendWidth;\n    }\n    if (opt_legendHeight !== undefined) {\n      queryString['HEIGHT'] = opt_legendHeight;\n    }\n  }\n  if (opt_servertype == 'qgis') {\n    if (opt_dpi != undefined) {\n      queryString['DPI'] = opt_dpi;\n    }\n    if (opt_bbox != undefined && opt_srs != undefined && opt_scale != undefined && opt_dpi != undefined && opt_legendRule == undefined) {\n      queryString['BBOX'] = opt_bbox.join(',');\n      queryString['SRS'] = opt_srs;\n      queryString['WIDTH'] = Math.round((opt_bbox[2] - opt_bbox[0]) / opt_scale * 39.37 * opt_dpi);\n      queryString['HEIGHT'] = Math.round((opt_bbox[3] - opt_bbox[1]) / opt_scale * 39.37 * opt_dpi);\n    }\n  }\n  if (opt_additionalQueryString) {\n    Object.assign(queryString, opt_additionalQueryString);\n  }\n  return olUri.appendParams(url, queryString);\n};\n\n\n/**\n * Returns if this layer is visible at the current resolution.\n * @param {ol.layer.Base} layer Layer.\n * @param {ol.Map} map Map.\n * @return {boolean} Is the layer currently visible?\n */\nexports.prototype.isLayerVisible = function(layer, map) {\n  if (!layer.getVisible()) {\n    return false;\n  }\n\n  const currentResolution = map.getView().getResolution();\n  return currentResolution > layer.getMinResolution() &&\n      currentResolution < layer.getMaxResolution();\n};\n\n\n/**\n * Force a WMS layer to refresh using a random value.\n * @param {ol.layer.Image|ol.layer.Tile} layer Layer to refresh.\n */\nexports.prototype.refreshWMSLayer = function(layer) {\n  const source_ = layer.getSource();\n  googAsserts.assert(\n    source_ instanceof olSourceImageWMS ||\n    source_ instanceof olSourceTileWMS\n  );\n  const source = /** @type {ol.source.ImageWMS|ol.source.TileWMS} */ (source_);\n  const params = source.getParams();\n  params[exports.REFRESH_PARAM] = Math.random();\n  source.updateParams(params);\n};\n\n\n/**\n * Set ZIndex property to first level children elements\n * @param {ol.layer.Group|ol.layer.Base} element The group of layer with first level children layers.\n * @param {number} ZIndex The ZIndex for children element.\n */\nexports.prototype.setZIndexToFirstLevelChildren = function(element, ZIndex) {\n  if (!(element instanceof OlLayerGroup)) {\n    return;\n  }\n  const innerGroupLayers = element.getLayers();\n  innerGroupLayers.forEach(innerLayer => innerLayer.setZIndex(ZIndex));\n};\n\n\n/**\n * Update the LAYERS parameter of the source of the given WMS layer.\n * @param {ol.layer.Image} layer The WMS layer.\n * @param {string} names The names that will be used to set\n * the LAYERS parameter.\n * @param {string=} opt_time The start\n * and optionally the end datetime (for time range selection) selected by user\n * in a ISO-8601 string datetime or time interval format\n * @export\n */\nexports.prototype.updateWMSLayerState = function(layer, names, opt_time) {\n  // Don't send layer without parameters, hide layer instead;\n  if (names.length <= 0) {\n    layer.setVisible(false);\n  } else {\n    layer.setVisible(true);\n    const source = /** @type {ol.source.ImageWMS} */ (layer.getSource());\n    if (opt_time) {\n      source.updateParams({'LAYERS': names, 'TIME': opt_time});\n    } else {\n      source.updateParams({'LAYERS': names});\n    }\n  }\n};\n\n\n/**\n * @param {ol.layer.Image} layer The WMS layer.\n * @return {Array.<number>|undefined} List of query source ids, a.k.a.\n *     the data source ids this layer is composed of.\n * @export\n */\nexports.prototype.getQuerySourceIds = function(layer) {\n  return /** @type {Array.<number>|undefined} */ (\n    layer.get('querySourceIds'));\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoLayerHelper', [])\n  .service('ngeoLayerHelper', exports)\n  .value('ngeoTilesPreloadingLimit', Infinity);\n\n\nexport default exports;\n","/**\n * @module ngeo.rule.Geometry\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport olGeomGeometry from 'ol/geom/Geometry.js';\n\nconst exports = class extends ngeoRuleRule {\n\n  /**\n   * A rule bound to the geometry of a `ol.Feature` object. Changes made\n   * to the geometry are applied to the `expression` property of the rule.\n   *\n   * @struct\n   * @param {!ngeox.rule.GeometryOptions} options Options.\n   */\n  constructor(options) {\n\n    options.type = ngeoFormatAttributeType.GEOMETRY;\n\n    super(options);\n\n    // === STATIC properties ===\n\n    const properties = options.featureProperties || {};\n\n    /**\n     * @type {!ol.Feature}\n     * @private\n     */\n    this.feature_ = new olFeature(properties);\n\n    /**\n     * @type {!ol.format.GeoJSON}\n     * @private\n     */\n    this.format_ = new olFormatGeoJSON();\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.updatingExpression_ = false;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.updatingGeometry_ = false;\n\n    /**\n     * @type {?ol.EventsKey}\n     * @private\n     */\n    this.geometryChangeListenerKey_ = null;\n\n    this.listenerKeys.push(\n      olEvents.listen(\n        this.feature_,\n        `change:${this.feature.getGeometryName()}`,\n        this.handleFeatureGeometryChange_,\n        this\n      )\n    );\n\n    this.setGeometryFromExpression_();\n\n  }\n\n  // === Static property getters/setters ===\n\n  /**\n   * @return {!ol.Feature} Feature.\n   * @export\n   */\n  get feature() {\n    return this.feature_;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  setExpression(expression) {\n    this.updatingExpression_ = true;\n    super.setExpression(expression);\n\n    if (!this.updatingGeometry_) {\n      this.setGeometryFromExpression_();\n    }\n\n    this.registerGeometryChange_();\n\n    this.updatingExpression_ = false;\n  }\n\n  // === Calculated property getters/setters ===\n\n  /**\n   * @return {?ol.geom.Geometry} Geometry\n   * @export\n   */\n  get geometry() {\n    return this.feature_.getGeometry() || null;\n  }\n\n  /**\n   * @param {?ol.geom.Geometry} geometry Geometry\n   * @export\n   */\n  set geometry(geometry) {\n    this.feature_.setGeometry(geometry);\n  }\n\n  // === Other methods ===\n\n  /**\n   * Called when the geometry property in the feature changes. Update the\n   * expression accordingly.\n   * @private\n   */\n  handleFeatureGeometryChange_() {\n    if (this.updatingExpression_) {\n      return;\n    }\n\n    this.updatingGeometry_ = true;\n\n    const geometry = this.feature_.getGeometry();\n    if (geometry) {\n      this.expression = this.format_.writeGeometry(geometry);\n    } else {\n      this.expression = null;\n    }\n\n    this.registerGeometryChange_();\n\n    this.updatingGeometry_ = false;\n  }\n\n  /**\n   * Called when the geometry of the features changes. Update the expression\n   * accordingly.\n   * @param {ol.Object.Event} evt Event\n   * @private\n   */\n  handleGeometryChange_(evt) {\n    const geometry = googAsserts.assertInstanceof(\n      evt.target, olGeomGeometry\n    );\n    this.updatingGeometry_ = true;\n    this.expression = this.format_.writeGeometry(geometry);\n    this.updatingGeometry_ = false;\n  }\n\n  /**\n   * Set geometry property using the expression property.\n   * @private\n   */\n  setGeometryFromExpression_() {\n    let geometry = null;\n    if (this.expression) {\n      // An expression can only have a string value with a geometry rule.\n      const expression = googAsserts.assertString(this.expression);\n      geometry = this.format_.readGeometry(expression);\n    }\n    this.geometry = geometry;\n  }\n\n  /**\n   * Unlisten the feature geometry change event, then listen to it if the\n   * feature has a geometry.\n   * @private\n   */\n  registerGeometryChange_() {\n\n    // (1) Unlisten\n    if (this.geometryChangeListenerKey_ !== null) {\n      olEvents.unlistenByKey(this.geometryChangeListenerKey_);\n      this.geometryChangeListenerKey_ = null;\n    }\n\n    // (2) Listen, if geom\n    const geometry = this.feature_.getGeometry();\n    if (geometry) {\n      this.geometryChangeListenerKey_ = olEvents.listen(\n        geometry,\n        'change',\n        this.handleGeometryChange_,\n        this\n      );\n    }\n  }\n\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.map.FeatureOverlayMgr\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapFeatureOverlay from 'ngeo/map/FeatureOverlay.js';\nimport * as olBase from 'ol/index.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport * as olObj from 'ol/obj.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olStyleStyle, {toFunction as toStyleFunction, createDefaultStyle as olStyleDefaultFunction} from 'ol/style/Style.js';\n\n\n/**\n * Provides a service that wraps an \"unmanaged\" vector layer,\n * used as a shared vector layer across the application.\n *\n * Example:\n *\n * The application's main component/controller initializes the feature\n * overlay manager with the map:\n *\n *     ngeoFeatureOverlayMgr.init(map);\n *\n * Once initialized, components of the application can use the manager to\n * create a feature overlay, configuring it with specific styles:\n *\n *     let featureOverlay = ngeoFeatureOverlayMgr.getFeatureOverlay();\n *     featureOverlay.setStyle(myStyle);\n *     featureOverlay.addFeature(myFeature);\n *\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoFeatureOverlayMgr\n */\nconst exports = function() {\n\n  /**\n   * @type {Object.<string, number>}\n   * @private\n   */\n  this.featureUidToGroupIndex_ = {};\n\n  /**\n   * @type {Array.<ngeox.MapFeatureOverlayGroup>}\n   * @private\n   */\n  this.groups_ = [];\n\n  /**\n   * @type {ol.source.Vector}\n   * @private\n   */\n  this.source_ = new olSourceVector({\n    useSpatialIndex: false\n  });\n\n  /**\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.layer_ = new olLayerVector({\n    source: this.source_,\n    style: this.styleFunction_.bind(this),\n    updateWhileAnimating: true,\n    updateWhileInteracting: true\n  });\n\n};\n\n\n/**\n * @param {ol.Feature} feature The feature to add.\n * @param {number} groupIndex The group groupIndex.\n * @export\n */\nexports.prototype.addFeature = function(feature, groupIndex) {\n  googAsserts.assert(groupIndex >= 0);\n  googAsserts.assert(groupIndex < this.groups_.length);\n  const featureUid = olBase.getUid(feature).toString();\n  this.featureUidToGroupIndex_[featureUid] = groupIndex;\n  this.groups_[groupIndex].features[featureUid] = feature;\n  this.source_.addFeature(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature The feature to add.\n * @param {number} groupIndex The group groupIndex.\n * @export\n */\nexports.prototype.removeFeature = function(feature, groupIndex) {\n  googAsserts.assert(groupIndex >= 0);\n  googAsserts.assert(groupIndex < this.groups_.length);\n  const featureUid = olBase.getUid(feature).toString();\n  delete this.featureUidToGroupIndex_[featureUid];\n  delete this.groups_[groupIndex].features[featureUid];\n  this.source_.removeFeature(feature);\n};\n\n\n/**\n * @param {number} groupIndex The group groupIndex.\n * @export\n */\nexports.prototype.clear = function(groupIndex) {\n  googAsserts.assert(groupIndex >= 0);\n  googAsserts.assert(groupIndex < this.groups_.length);\n  const group = this.groups_[groupIndex];\n  for (const featureUid in group.features) {\n    this.removeFeature(group.features[featureUid], groupIndex);\n  }\n  googAsserts.assert(olObj.isEmpty(group.features));\n};\n\n\n/**\n * @return {ol.layer.Vector} The vector layer used internally.\n * @export\n */\nexports.prototype.getLayer = function() {\n  return this.layer_;\n};\n\n\n/**\n * @return {ngeo.map.FeatureOverlay} Feature overlay.\n * @export\n */\nexports.prototype.getFeatureOverlay = function() {\n  const groupIndex = this.groups_.length;\n  this.groups_.push({\n    styleFunction: olStyleDefaultFunction,\n    features: {}\n  });\n  return new ngeoMapFeatureOverlay(this, groupIndex);\n};\n\n\n/**\n * @param {ol.Map} map Map.\n * @export\n */\nexports.prototype.init = function(map) {\n  this.layer_.setMap(map);\n};\n\n\n/**\n * @param {ol.style.Style|Array.<ol.style.Style>|ol.StyleFunction} style\n * Style.\n * @param {number} groupIndex Group index.\n * @export\n */\nexports.prototype.setStyle = function(style, groupIndex) {\n  googAsserts.assert(groupIndex >= 0);\n  googAsserts.assert(groupIndex < this.groups_.length);\n  this.groups_[groupIndex].styleFunction = style === null ?\n    olStyleStyle.defaultFunction : toStyleFunction(style);\n};\n\n\n/**\n * @param {ol.Feature|ol.render.Feature} feature Feature.\n * @param {number} resolution Resolution.\n * @return {Array.<ol.style.Style>|ol.style.Style} Styles.\n * @private\n */\nexports.prototype.styleFunction_ = function(feature, resolution) {\n  const featureUid = olBase.getUid(feature).toString();\n  googAsserts.assert(featureUid in this.featureUidToGroupIndex_);\n  const groupIndex = this.featureUidToGroupIndex_[featureUid];\n  const group = this.groups_[groupIndex];\n  return group.styleFunction(feature, resolution);\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoFeatureOverlayMgr', [\n  ngeoMapFeatureOverlay.module.name\n]);\nexports.module.service('ngeoFeatureOverlayMgr', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.layertree.Controller\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\n\n/**\n * The controller for the \"tree node\" directive.\n * @param {angular.Scope} $scope Scope.\n * @param {angular.Scope} $rootScope Angular rootScope.\n * @param {angular.Attributes} $attrs Attributes.\n * @constructor\n * @ngInject\n * @export\n * @struct\n * @ngdoc controller\n * @ngname NgeoLayertreeController\n */\nconst exports = function($scope, $rootScope, $attrs) {\n\n  const isRoot = $attrs['ngeoLayertreeNotroot'] === undefined;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.isRoot = isRoot;\n\n  const nodeExpr = $attrs['ngeoLayertree'];\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.rootScope_ = $rootScope;\n\n  /**\n   * @type {!Object}\n   * @export\n   */\n  this.properties = {};\n\n  /**\n   * @type {!string}\n   * @private\n   */\n  this.state_ = 'off';\n\n  /**\n   * @type {!Object}\n   * @export\n   */\n  this.node;\n\n  if (isRoot) {\n    $scope.$watch(nodeExpr, (newVal, oldVal) => {\n      this.node = newVal;\n    });\n  } else {\n    this.node = /** @type {!Object} */ ($scope.$eval(nodeExpr));\n    googAsserts.assert(this.node !== undefined);\n  }\n\n  const mapExpr = $attrs['ngeoLayertreeMap'];\n  const map = /** @type {ol.Map} */ ($scope.$eval(mapExpr));\n  googAsserts.assert(map !== undefined);\n\n  /**\n   * @type {ngeo.layertree.Controller}\n   * @export\n   */\n  this.parent = $scope.$parent['layertreeCtrl'];\n\n  /**\n   * @type {Array.<ngeo.layertree.Controller>}\n   * @export\n   */\n  this.children = [];\n\n  if (this.parent) {\n    this.parent.children.push(this);\n  }\n\n  $scope.$on('$destroy', () => {\n    if (this.parent) {\n      const index = this.parent.children.indexOf(this);\n      googAsserts.assert(index >= 0);\n      this.parent.children.splice(index, 1);\n    }\n  });\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.uid = olBase.getUid(this);\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.depth = isRoot ? 0 : this.parent.depth + 1;\n\n  // We set 'uid' and 'depth' in the scope as well to access the parent values\n  // in the inherited scopes. This is intended to be used in the javascript not\n  // in the templates.\n  $scope['uid'] = this.uid;\n  $scope['depth'] = this.depth;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map = map;\n\n  let nodelayerExpr = $attrs['ngeoLayertreeNodelayer'];\n  if (nodelayerExpr === undefined) {\n    const nodelayerexprExpr = $attrs['ngeoLayertreeNodelayerexpr'];\n    const newNodelayerExpr = $scope.$eval(nodelayerexprExpr);\n    googAsserts.assertString(newNodelayerExpr);\n    nodelayerExpr = newNodelayerExpr;\n  }\n  googAsserts.assert(nodelayerExpr !== undefined);\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.nodelayerExpr = nodelayerExpr;\n\n  /**\n   * @type {?ol.layer.Layer|ol.layer.Group}\n   * @export\n   */\n  this.layer = null;\n  if (!isRoot) {\n    const layer = $scope.$eval(nodelayerExpr, {'treeCtrl': this}) || null;\n    if (layer) {\n      googAsserts.assert(\n        layer instanceof olLayerLayer || layer instanceof olLayerGroup\n      );\n      this.layer = layer;\n    }\n  }\n\n  /**\n   * @type {?ngeo.datasource.DataSource}\n   * @private\n   */\n  this.dataSource_ = null;\n\n  if (this.layer) {\n    ngeoMiscDecorate.layerLoading(this.layer, $scope);\n    ngeoMiscDecorate.layer(this.layer);\n\n    olEvents.listen(this.layer, 'change:opacity', () => {\n      this.rootScope_.$broadcast('ngeo-layertree-opacity', this);\n    });\n  }\n\n  let listenersExpr = $attrs['ngeoLayertreeListeners'];\n  if (listenersExpr === undefined) {\n    const listenersexprExpr = $attrs['ngeoLayertreeListenersexpr'];\n    listenersExpr = $scope.$eval(listenersexprExpr);\n  }\n\n  if (listenersExpr !== undefined) {\n    googAsserts.assertString(listenersExpr);\n  }\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.listenersExpr = listenersExpr;\n\n  // Eval function to bind functions to this tree's events.\n  if (listenersExpr) {\n    $scope.$eval(listenersExpr, {'treeScope': $scope, 'treeCtrl': this});\n  }\n\n  $scope['layertreeCtrl'] = this;\n};\n\n\n/**\n * Return the current state.\n * @return {string} 'on', 'off', 'indeterminate'.\n * @export\n */\nexports.prototype.getState = function() {\n  return this.state_;\n};\n\n\n/**\n * Set the state of this treeCtrl. Update its children with its value and then\n * ask its parent to refresh its state.\n * @param {string} state 'on' or 'off'.\n * @param {boolean=} opt_broadcast Broadcast.\n * @export\n */\nexports.prototype.setState = function(state, opt_broadcast) {\n  if (state === this.state_) {\n    return;\n  }\n  this.setStateInternal_(state);\n\n  // Ask to its parent to update it's state.\n  if (this.parent) {\n    this.parent.refreshState();\n  }\n\n  const firstParents = this.isRoot ? this.children : [exports.getFirstParentTree(this)];\n\n  if (opt_broadcast === undefined || opt_broadcast) {\n    firstParents.forEach((firstParent) => {\n      this.rootScope_.$broadcast('ngeo-layertree-state', this, firstParent);\n    });\n  }\n};\n\n\n/**\n * @param {string} state 'on' or 'off'.\n */\nexports.prototype.setStateInternal_ = function(state) {\n  // Set the state\n  this.state_ = state === 'on' ? 'on' : 'off';\n  // Asks to each child to set its state;\n  this.children.forEach((child) => {\n    child.setStateInternal_(this.state_);\n  });\n};\n\n\n/**\n * Refresh the state of this treeCtrl based on it's children value. The call its\n * parent to do the same.\n * @public\n */\nexports.prototype.refreshState = function() {\n  const newState = this.getCalculateState();\n  if (this.state_ === newState) {\n    return;\n  }\n  this.state_ = newState;\n  if (this.parent) {\n    this.parent.refreshState();\n  }\n};\n\n\n/**\n * Return the current state, calculate on all its children recursively.\n * @return {string} 'on', 'off' or 'indeterminate'.\n * @export\n */\nexports.prototype.getCalculateState = function() {\n  if (this.node.children === undefined) {\n    return this.state_;\n  }\n  let childState;\n  let previousChildState;\n  this.children.some((child) => {\n    childState = child.getCalculateState();\n    if (previousChildState) {\n      if (previousChildState !== childState) {\n        return childState = 'indeterminate';\n      }\n    }\n    previousChildState = childState;\n  });\n  return childState;\n};\n\n\n/**\n * @param {boolean|undefined} val Value.\n * @return {boolean|undefined} Value.\n * @export\n */\nexports.prototype.getSetActive = function(val) {\n  const layer = this.layer;\n  const map = this.map;\n  if (!layer) {\n    return;\n  }\n  if (val !== undefined) {\n    if (!val) {\n      map.removeLayer(layer);\n    } else {\n      map.addLayer(layer);\n    }\n  } else {\n    return map.getLayers().getArray().indexOf(layer) >= 0;\n  }\n};\n\n\n/**\n * @return {?ngeo.datasource.DataSource} dataSource The data source bound to\n *     this layer tree controller.\n * @export\n */\nexports.prototype.getDataSource = function() {\n  return this.dataSource_;\n};\n\n\n/**\n * @param {?ngeo.datasource.DataSource} dataSource Data source or null.\n * @export\n */\nexports.prototype.setDataSource = function(dataSource) {\n  this.dataSource_ = dataSource;\n};\n\n\n/**\n * Get the \"top level\" layertree (one of the first level child under the root\n * layertree). Can return itself.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @return {ngeo.layertree.Controller} the top level layertree.\n * @public\n */\nexports.getFirstParentTree = function(treeCtrl) {\n  let tree = treeCtrl;\n  while (!tree.parent.isRoot) {\n    tree = tree.parent;\n  }\n  return tree;\n};\n\n\n/**\n * @enum {string}\n */\nexports.VisitorDecision = {\n  STOP: 'STOP',\n  SKIP: 'SKIP',\n  DESCEND: 'DESCEND'\n};\n\n\n/**\n * @typedef {\n *   function(ngeo.layertree.Controller): (!ngeo.layertree.Controller.VisitorDecision|undefined)\n * }\n */\nexports.Visitor;\n\n\n/**\n * Recursive method to traverse the layertree controller graph.\n * @param {ngeo.layertree.Controller.Visitor} visitor A visitor called for each node.\n * @return {boolean} whether to stop traversing.\n * @export\n */\nexports.prototype.traverseDepthFirst = function(visitor) {\n  // First visit the current controller\n  const decision = visitor(this) || exports.VisitorDecision.DESCEND;\n\n  switch (decision) {\n    case exports.VisitorDecision.STOP:\n      return true; // stop traversing\n    case exports.VisitorDecision.SKIP:\n      return false; // continue traversing but skip current branch\n    case exports.VisitorDecision.DESCEND:\n      for (let i = 0; i < this.children.length; ++i) {\n        const child = this.children[i];\n        const stop = child.traverseDepthFirst(visitor);\n        if (stop) {\n          return true; // stop traversing\n        }\n      }\n      return false; // continue traversing\n    default:\n      googAsserts.fail('Unhandled case');\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoLayertreeController', []);\nexports.module.controller('ngeoLayertreeController', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.Measure\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport * as olDom from 'ol/dom.js';\nimport * as olProj from 'ol/proj.js';\nimport olOverlay from 'ol/Overlay.js';\nimport * as olSphere from 'ol/sphere.js';\nimport * as olEvents from 'ol/events.js';\nimport olInteractionInteraction from 'ol/interaction/Interaction.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\n/**\n * Interaction that allows measuring (length, area, ...).\n *\n * @constructor\n * @struct\n * @abstract\n * @extends {ol.interaction.Interaction}\n * @param {ngeo.interaction.MeasureBaseOptions=} options Options\n */\nconst exports = function(options = /** @type {ngeo.interaction.MeasureBaseOptions} */ ({})) {\n\n  olInteractionInteraction.call(this, {\n    handleEvent: exports.handleEvent_\n  });\n\n  /**\n   * The help tooltip element.\n   * @type {Element}\n   * @private\n   */\n  this.helpTooltipElement_ = null;\n\n\n  /**\n   * Overlay to show the help messages.\n   * @type {ol.Overlay}\n   * @private\n   */\n  this.helpTooltipOverlay_ = null;\n\n\n  /**\n   * The measure tooltip element.\n   * @type {Element}\n   * @private\n   */\n  this.measureTooltipElement_ = null;\n\n\n  /**\n   * Overlay to show the measurement.\n   * @type {ol.Overlay}\n   * @private\n   */\n  this.measureTooltipOverlay_ = null;\n\n\n  /**\n   * The measurement overlay coordinate.\n   * @type {ol.Coordinate}\n   * @private\n   */\n  this.measureTooltipOverlayCoord_ = null;\n\n\n  /**\n   * The sketch feature.\n   * @type {ol.Feature}\n   * @protected\n   */\n  this.sketchFeature = null;\n\n  /**\n   * Message to show after the first point is clicked.\n   * @type {?Element}\n   */\n  this.continueMsg = null;\n\n  /**\n   * Defines the number of decimals to keep in the measurement. If not defined,\n   * then the default behaviour occurs depending on the measure type.\n   * @type {number|undefined}\n   * @protected\n   */\n  this.decimals = options.decimals;\n\n  /**\n   * Defines the number of precision to keep in the measurement. If not defined,\n   * then the default behaviour occurs depending on the measure type.\n   * @type {number|undefined}\n   * @protected\n   */\n  this.precision = options.precision;\n\n  /**\n   * Whether or not to display any tooltip\n   * @type {boolean}\n   * @private\n   */\n  this.displayHelpTooltip_ = options.displayHelpTooltip !== undefined ? options.displayHelpTooltip : true;\n\n  /**\n   * The message to show when user is about to start drawing.\n   * @type {Element}\n   */\n  this.startMsg;\n  if (options.startMsg !== undefined) {\n    this.startMsg = options.startMsg;\n  } else {\n    this.startMsg = document.createElement('span');\n    this.startMsg.textContent =  'Click to start drawing.';\n  }\n\n  /**\n   * The key for geometry change event.\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.changeEventKey_ = null;\n\n  /**\n   * The key for map postcompose event.\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.postcomposeEventKey_ = null;\n\n  const style = options.style !== undefined ? options.style : [\n    new olStyleStyle({\n      fill: new olStyleFill({\n        color: 'rgba(255, 255, 255, 0.2)'\n      })\n    }),\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: 'white',\n        width: 5\n      })\n    }),\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: '#ffcc33',\n        width: 3\n      })\n    })\n  ];\n\n  /**\n   * The vector layer used to show final measure features.\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.vectorLayer_ = new olLayerVector({\n    source: new olSourceVector(),\n    style: style\n  });\n\n  /**\n   * The draw interaction to be used.\n   * @type {ol.interaction.Draw|ngeo.interaction.DrawAzimut|ngeo.interaction.MobileDraw}\n   * @private\n   */\n  this.drawInteraction_ = this.createDrawInteraction(options.sketchStyle,\n    this.vectorLayer_.getSource());\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.shouldHandleDrawInteractionActiveChange_ = true;\n\n  olEvents.listen(this.drawInteraction_, 'change:active', this.handleDrawInteractionActiveChange_, this);\n  olEvents.listen(this.drawInteraction_, 'drawstart', this.onDrawStart_, this);\n  olEvents.listen(this.drawInteraction_, 'drawend', this.onDrawEnd_, this);\n\n  olEvents.listen(this, 'change:active', this.updateState_, this);\n};\n\nolBase.inherits(exports, olInteractionInteraction);\n\n\n/**\n * @const\n * @type {ol.Sphere}\n */\n\n\n/**\n * Calculate the area of the passed polygon and return a formatted string\n * of the area.\n * @param {!ol.geom.Polygon} polygon Polygon.\n * @param {!ol.proj.Projection} projection Projection of the polygon coords.\n * @param {number|undefined} precision Precision.\n * @param {!ngeox.unitPrefix} format The format function.\n * @return {string} Formatted string of the area.\n * @this {ngeo.interaction.Measure}\n */\nexports.getFormattedArea = function(polygon, projection, precision, format) {\n  const geom = /** @type {ol.geom.Polygon} */ (polygon.clone().transform(projection, 'EPSG:4326'));\n  const area = Math.abs(olSphere.getArea(geom, {'projection': 'EPSG:4326'}));\n  return format(area, 'm²', 'square', precision);\n};\n\n\n/**\n * Calculate the area of the passed circle and return a formatted string\n * of the area.\n * @param {!ol.geom.Circle} circle Circle\n * @param {number|undefined} precision Precision.\n * @param {!ngeox.unitPrefix} format The format function.\n * @return {string} Formatted string of the area.\n */\nexports.getFormattedCircleArea = function(circle, precision, format) {\n  const area = Math.PI * Math.pow(circle.getRadius(), 2);\n  return format(area, 'm²', 'square', precision);\n};\n\n\n/**\n * Calculate the length of the passed line string and return a formatted\n * string of the length.\n * @param {!ol.geom.LineString} lineString Line string.\n * @param {!ol.proj.Projection} projection Projection of the line string coords.\n * @param {number|undefined} precision Precision.\n * @param {!ngeox.unitPrefix} format The format function.\n * @return {string} Formatted string of length.\n */\nexports.getFormattedLength = function(lineString, projection, precision, format) {\n  let length = 0;\n  const coordinates = lineString.getCoordinates();\n  for (let i = 0, ii = coordinates.length - 1; i < ii; ++i) {\n    const c1 = olProj.transform(coordinates[i], projection, 'EPSG:4326');\n    const c2 = olProj.transform(coordinates[i + 1], projection, 'EPSG:4326');\n    length += olSphere.getDistance(c1, c2);\n  }\n  return format(length, 'm', 'unit', precision);\n};\n\n\n/**\n * Return a formatted string of the point.\n * @param {!ol.geom.Point} point Point.\n * @param {number|undefined} decimals Decimals.\n * @param {!ngeox.numberCoordinates} format A function to format coordinate into text\n * @param {string=} opt_template The template.\n * @return {string} Formatted string of coordinate.\n */\nexports.getFormattedPoint = function(point, decimals, format, opt_template) {\n  return format(point.getCoordinates(), decimals, opt_template);\n};\n\n\n/**\n * Handle map browser event.\n * @param {ol.MapBrowserEvent} evt Map browser event.\n * @return {boolean} `false` if event propagation should be stopped.\n * @this {ngeo.interaction.Measure}\n * @private\n */\nexports.handleEvent_ = function(evt) {\n  if (evt.type != 'pointermove' || evt.dragging) {\n    return true;\n  }\n\n  const helpMsg = this.sketchFeature === null ? this.startMsg : this.continueMsg;\n\n  if (this.displayHelpTooltip_) {\n    olDom.removeChildren(this.helpTooltipElement_);\n    this.helpTooltipElement_.appendChild(helpMsg);\n    this.helpTooltipOverlay_.setPosition(evt.coordinate);\n  }\n\n  return true;\n};\n\n\n/**\n * @return {ol.interaction.Draw|ngeo.interaction.DrawAzimut|ngeo.interaction.MobileDraw} The draw interaction.\n */\nexports.prototype.getDrawInteraction = function() {\n  return this.drawInteraction_;\n};\n\n\n/**\n * Creates the draw interaction.\n *\n * @abstract\n * @param {ol.style.Style|Array.<ol.style.Style>|ol.StyleFunction|undefined}\n *     style The sketchStyle used for the drawing interaction.\n * @param {ol.source.Vector} source Vector source.\n * @return {ol.interaction.Draw|ngeo.interaction.DrawAzimut|ngeo.interaction.MobileDraw} The interaction\n * @protected\n */\nexports.prototype.createDrawInteraction = function(style, source) {};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n\n  olInteractionInteraction.prototype.setMap.call(this, map);\n\n  this.vectorLayer_.setMap(map);\n\n  const prevMap = this.drawInteraction_.getMap();\n  if (prevMap !== null) {\n    prevMap.removeInteraction(this.drawInteraction_);\n  }\n\n  if (map !== null) {\n    map.addInteraction(this.drawInteraction_);\n  }\n};\n\n\n/**\n * Handle draw interaction `drawstart` event.\n * @param {ol.interaction.Draw.Event|ngeox.DrawEvent} evt Event.\n * @private\n */\nexports.prototype.onDrawStart_ = function(evt) {\n  this.sketchFeature = evt.feature || evt.detail.feature;\n  this.vectorLayer_.getSource().clear(true);\n  this.createMeasureTooltip_();\n\n  const geometry = this.sketchFeature.getGeometry();\n\n  googAsserts.assert(geometry !== undefined);\n  this.changeEventKey_ = olEvents.listen(geometry, 'change', () => {\n    this.handleMeasure((measure, coord) => {\n      if (coord !== null) {\n        this.measureTooltipElement_.innerHTML = measure;\n        this.measureTooltipOverlayCoord_ = coord;\n      }\n    });\n  });\n\n  this.cancelEventKey_ = olEvents.listen(document.body, 'keydown', (event) => {\n    this.handleEscapeKeyDown_(event);\n  });\n\n  this.postcomposeEventKey_ = olEvents.listen(this.getMap(), 'postcompose', () => {\n    this.measureTooltipOverlay_.setPosition(this.measureTooltipOverlayCoord_);\n  });\n};\n\n\n/**\n * Handle draw interaction `drawend` event.\n * @param {ol.interaction.Draw.Event|ngeox.DrawEvent} evt Event.\n * @private\n */\nexports.prototype.onDrawEnd_ = function(evt) {\n  this.measureTooltipElement_.classList.add('ngeo-tooltip-static');\n  this.measureTooltipOverlay_.setOffset([0, -7]);\n  /** @type {ngeox.MeasureEvent} */\n  const event = new ngeoCustomEvent('measureend', {feature: this.sketchFeature});\n  this.dispatchEvent(event);\n  this.sketchFeature = null;\n  this.unlistenerEvent_();\n};\n\n/**\n * Handle unlistener events for 'end of drawing' interaction\n * @private\n */\nexports.prototype.unlistenerEvent_ = function() {\n  if (this.changeEventKey_ !== null && this.postcomposeEventKey_ !== null) {\n    olEvents.unlistenByKey(this.changeEventKey_);\n    olEvents.unlistenByKey(this.postcomposeEventKey_);\n    olEvents.unlistenByKey(this.cancelEventKey_);\n    this.changeEventKey_ = null;\n    this.postcomposeEventKey_ = null;\n    this.cancelEventKey_ = null;\n  }\n};\n\n/**\n * Creates a new help tooltip\n * @private\n */\nexports.prototype.createHelpTooltip_ = function() {\n  this.removeHelpTooltip_();\n  if (this.displayHelpTooltip_) {\n    this.helpTooltipElement_ = document.createElement('div');\n    this.helpTooltipElement_.classList.add('tooltip');\n    this.helpTooltipOverlay_ = new olOverlay({\n      element: this.helpTooltipElement_,\n      offset: [15, 0],\n      positioning: 'center-left'\n    });\n    this.getMap().addOverlay(this.helpTooltipOverlay_);\n  }\n};\n\n\n/**\n * Destroy the help tooltip\n * @private\n */\nexports.prototype.removeHelpTooltip_ = function() {\n  if (this.displayHelpTooltip_) {\n    this.getMap().removeOverlay(this.helpTooltipOverlay_);\n    if (this.helpTooltipElement_ !== null) {\n      this.helpTooltipElement_.parentNode.removeChild(this.helpTooltipElement_);\n    }\n    this.helpTooltipElement_ = null;\n    this.helpTooltipOverlay_ = null;\n  }\n};\n\n\n/**\n * Creates a new measure tooltip\n * @private\n */\nexports.prototype.createMeasureTooltip_ = function() {\n  this.removeMeasureTooltip_();\n  this.measureTooltipElement_ = document.createElement('div');\n  this.measureTooltipElement_.classList.add('tooltip');\n  this.measureTooltipElement_.classList.add('ngeo-tooltip-measure');\n  this.measureTooltipOverlay_ = new olOverlay({\n    element: this.measureTooltipElement_,\n    offset: [0, -15],\n    positioning: 'bottom-center',\n    stopEvent: false\n  });\n  this.getMap().addOverlay(this.measureTooltipOverlay_);\n};\n\n\n/**\n * Destroy the help tooltip\n * @private\n */\nexports.prototype.removeMeasureTooltip_ = function() {\n  if (this.measureTooltipElement_ !== null) {\n    this.measureTooltipElement_.parentNode.removeChild(this.measureTooltipElement_);\n    this.measureTooltipElement_ = null;\n    this.measureTooltipOverlay_ = null;\n    this.measureTooltipOverlayCoord_ = null;\n  }\n};\n\n\n/**\n * @private\n */\nexports.prototype.updateState_ = function() {\n  const active = this.getActive();\n  this.shouldHandleDrawInteractionActiveChange_ = false;\n  this.drawInteraction_.setActive(active);\n  this.shouldHandleDrawInteractionActiveChange_ = true;\n  if (!this.getMap()) {\n    return;\n  }\n  if (active) {\n    if (!this.measureTooltipOverlay_) {\n      this.createMeasureTooltip_();\n      this.createHelpTooltip_();\n    }\n  } else {\n    this.vectorLayer_.getSource().clear(true);\n    this.getMap().removeOverlay(this.measureTooltipOverlay_);\n    this.removeMeasureTooltip_();\n    this.removeHelpTooltip_();\n    this.unlistenerEvent_();\n  }\n};\n\n\n/**\n * Function implemented in inherited classes to compute measurement, determine\n * where to place the tooltip and determine which help message to display.\n *\n * @abstract\n * @param {function(string, ?ol.Coordinate)} callback The function\n *     to be called.\n * @protected\n */\nexports.prototype.handleMeasure = function(callback) {};\n\n\n/**\n * Get a reference to the tooltip element.\n * @return {Element} Tooltip Element.\n */\nexports.prototype.getTooltipElement = function() {\n  return this.measureTooltipElement_;\n};\n\n\n/**\n * Called when the draw interaction `active` property changes. If the\n * change is due to something else than this measure interactino, then\n * update follow the its active state accordingly.\n *\n * @private\n */\nexports.prototype.handleDrawInteractionActiveChange_ = function() {\n  if (this.shouldHandleDrawInteractionActiveChange_) {\n    this.setActive(this.drawInteraction_.getActive());\n  }\n};\n\n\n/**\n * Called when escape key is pressed to reset drawing.\n * @param {ol.interaction.Draw.Event|ngeox.MeasureEvent} event Event.\n * @private\n * @export\n */\nexports.prototype.handleEscapeKeyDown_ = function(event) {\n  const escPressed = event.keyCode === 27; // Escape key\n  if (this.drawInteraction_.getActive() && escPressed) {\n    this.drawInteraction_.setActive(false);\n    this.drawInteraction_.setActive(true);\n  }\n};\n\nexport default exports;\n","/**\n * @module gmf.layertree.TreeManager\n */\nimport gmfBase from 'gmf/index.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\nimport ngeoMessageNotification from 'ngeo/message/Notification.js';\nimport ngeoStatemanagerService from 'ngeo/statemanager/Service.js';\nimport * as olArray from 'ol/array.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olObj from 'ol/obj.js';\n\n/**\n * Manage a tree with children. This service can be used in mode 'flush'\n * (default) or not (mode 'add'). In mode 'flush', each theme, group or group\n * by layer that you add will replace the previous children's array. In mode\n * 'add', children will be just pushed in this array. The default state can be\n * changed by setting the value `gmfTreeManagerModeFlush`, e.g.:\n *\n *     let module = angular.module('app');\n *     module.value('gmfTreeManagerModeFlush', false);\n *\n * This service's theme is a GmfTheme with only children and a name.\n * Thought to be the tree source of the gmf layertree directive.\n * @constructor\n * @struct\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {angular.$injector} $injector Angular injector service.\n * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {ngeo.message.Notification} ngeoNotification Ngeo notification service.\n * @param {gmf.theme.Themes} gmfThemes gmf Themes service.\n * @param {ngeo.statemanager.Service} ngeoStateManager The ngeo statemanager service.\n * @ngInject\n * @ngdoc service\n * @ngname gmfTreeManager\n */\nconst exports = function($timeout, $injector, gettextCatalog, ngeoLayerHelper,\n  ngeoNotification, gmfThemes, ngeoStateManager) {\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.$timeout_ = $timeout;\n\n  /**\n   * @type {angular.$injector}\n   * @private\n   */\n  this.$injector_ = $injector;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.layerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {ngeo.message.Notification}\n   * @private\n   */\n  this.ngeoNotification_ = ngeoNotification;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * The root node and its children used to generate the layertree (with the\n   * same ordre).\n   * @type {gmfThemes.GmfRootNode}\n   * @public\n   */\n  this.root = /** @type {gmfThemes.GmfRootNode} */ ({\n    children: []\n  });\n\n  /**\n   * The controller of the (unique) root layer tree.\n   * The array of top level layer trees is available through `rootCtrl.children`.\n   * The order doesn't match with the ordre of the displayed layertree.\n   * @type {ngeo.layertree.Controller}\n   * @export\n   */\n  this.rootCtrl = null;\n\n  /**\n   * Number of groups to add to the layertree during one single Angular\n   * digest loop.\n   * @type {number}\n   * @public\n   */\n  this.numberOfGroupsToAddInThisDigestLoop = 0;\n\n  /**\n   * @type {Array.<gmfThemes.GmfGroup>}\n   * @private\n   */\n  this.groupsToAddInThisDigestLoop_ = [];\n\n  /**\n   * @type {angular.$q.Promise}\n   * @private\n   */\n  this.promiseForGroupsToAddInThisDigestLoop_ = null;\n\n  /**\n   * @type {ngeo.statemanager.Service}\n   * @private\n   */\n  this.ngeoStateManager_ = ngeoStateManager;\n\n  /**\n   * A reference to the OGC servers loaded by the theme service.\n   * @type {gmfThemes.GmfOgcServers|null}\n   * @private\n   */\n  this.ogcServers_ = null;\n\n  olEvents.listen(this.gmfThemes_, 'change', this.handleThemesChange_, this);\n};\n\n/**\n * Called when the themes change. Get the OGC servers, then listen to the\n * tree manager Layertree controllers array changes.\n * The themes could have been changed so it also call a refresh of the\n * layertree.\n * @private\n */\nexports.prototype.handleThemesChange_ = function() {\n  this.gmfThemes_.getOgcServersObject().then((ogcServers) => {\n    this.ogcServers_ = ogcServers;\n  });\n\n  if (this.rootCtrl && this.rootCtrl.children) {\n    this.gmfThemes_.getThemesObject().then((themes) => {\n      this.refreshFirstLevelGroups_(themes);\n    });\n  }\n};\n\n/**\n * Set some groups as tree's children. If the service use mode 'flush', the\n * previous tree's children will be removed. Add only groups that are not\n * already in the tree.\n * @param {Array.<gmfThemes.GmfGroup>} firstLevelGroups An array of gmf theme group.\n * @return {boolean} True if the group has been added. False otherwise.\n * @export\n */\nexports.prototype.setFirstLevelGroups = function(firstLevelGroups) {\n  this.root.children.length = 0;\n  this.ngeoStateManager_.deleteParam(gmfBase.PermalinkParam.TREE_GROUPS);\n  return this.addFirstLevelGroups(firstLevelGroups);\n};\n\n/**\n * Add some groups as tree's children. If the service use mode 'flush', the\n * previous tree's children will be removed. Add only groups that are not\n * already in the tree.\n * @param {Array.<gmfThemes.GmfGroup>} firstLevelGroups An array of gmf theme\n *     group.\n * @param {boolean=} opt_add if true, force to use the 'add' mode this time.\n * @param {boolean=} opt_silent if true notifyCantAddGroups_ is not called.\n * @return {boolean} True if the group has been added. False otherwise.\n * @export\n */\nexports.prototype.addFirstLevelGroups = function(firstLevelGroups,\n  opt_add, opt_silent) {\n  const groupNotAdded = [];\n\n  firstLevelGroups.slice().reverse().forEach((group) => {\n    if (!this.addFirstLevelGroup_(group)) {\n      groupNotAdded.push(group);\n    }\n  });\n  if (groupNotAdded.length > 0 && !opt_silent) {\n    this.notifyCantAddGroups_(groupNotAdded);\n  }\n\n  return groupNotAdded.length === 0;\n};\n\n\n/**\n * Update the application state with the list of first level groups in the tree\n * @param {Array.<gmfThemes.GmfGroup>} groups firstlevel groups of the tree\n * @private\n */\nexports.prototype.updateTreeGroupsState_ = function(groups) {\n  const treeGroupsParam = {};\n  treeGroupsParam[gmfBase.PermalinkParam.TREE_GROUPS] = groups.map(node => node.name).join(',');\n  this.ngeoStateManager_.updateState(treeGroupsParam);\n  if (this.$injector_.has('gmfPermalink')) {\n    /** @type {gmf.permalink.Permalink} */(this.$injector_.get('gmfPermalink')).cleanParams(groups);\n  }\n};\n\n\n/**\n * Add a group as tree's children without consideration of this service 'mode'.\n * Add it only if it's not already in the tree.\n * @param {gmfThemes.GmfGroup} group The group to add.\n * @return {boolean} true if the group has been added.\n * @private\n */\nexports.prototype.addFirstLevelGroup_ = function(group) {\n  let alreadyAdded = false;\n  const groupID = group.id;\n  this.root.children.some((rootChild) => {\n    if (groupID === rootChild.id) {\n      return alreadyAdded = true;\n    }\n  }, this);\n  this.groupsToAddInThisDigestLoop_.some((grp) => {\n    if (groupID === grp.id) {\n      return alreadyAdded = true;\n    }\n  }, this);\n  if (alreadyAdded) {\n    return false;\n  }\n\n  // Add groups in the list of groups to add and be sure that the counter of\n  // groups to add is reset.\n  this.groupsToAddInThisDigestLoop_.push(group);\n  this.numberOfGroupsToAddInThisDigestLoop = 0;\n\n  // Delete previous timeout promise if it exists to do this action only once.\n  if (this.promiseForGroupsToAddInThisDigestLoop_ !== null) {\n    this.$timeout_.cancel(this.promiseForGroupsToAddInThisDigestLoop_);\n  }\n\n  // Add the groups only when there is no more group to come during this digest\n  // loop. The purpose of this is to preserve a consistent order between the\n  // layertree (generated by a template) and the layers in the map.\n  this.promiseForGroupsToAddInThisDigestLoop_ = this.$timeout_(() => {\n    // Set the number of group to add.\n    this.numberOfGroupsToAddInThisDigestLoop = this.groupsToAddInThisDigestLoop_.length;\n    // Add each first-level-groups.\n    this.groupsToAddInThisDigestLoop_.forEach((grp) => {\n      this.root.children.unshift(grp);\n    });\n    //Update the permalink\n    this.updateTreeGroupsState_(this.root.children);\n    // Reset the groups and the promise state. Don't reset the\n    // numberOfGroupsToAddInThisDigestLoop, it must persist because the layers\n    // will be added into the map after that the layertree template is\n    // generated (so in the next angular loop).\n    this.groupsToAddInThisDigestLoop_.length = 0;\n    this.promiseForGroupsToAddInThisDigestLoop_ = null;\n  });\n\n  return true;\n};\n\n\n/**\n * Retrieve a group (first found) by its name and add in the tree. Do nothing\n * if any corresponding group is found.\n * @param {string} groupName Name of the group to add.\n * @param {boolean=} opt_add if true, force to use the 'add' mode this time.\n * @export\n */\nexports.prototype.addGroupByName = function(groupName, opt_add) {\n  this.gmfThemes_.getThemesObject().then((themes) => {\n    const group = gmfThemeThemes.findGroupByName(themes, groupName);\n    if (group) {\n      this.addFirstLevelGroups([group], opt_add, false);\n    }\n  });\n};\n\n\n/**\n * Retrieve a group by the name of a layer that is contained in this group\n * (first found). This group will be added in the tree. Do nothing if any\n * corresponding group is found.\n * @param {string} layerName Name of the layer inside the group to add.\n * @param {boolean=} opt_add if true, force to use the 'add' mode this time.\n * @param {boolean=} opt_silent if true notifyCantAddGroups_ is not called\n * @export\n */\nexports.prototype.addGroupByLayerName = function(layerName, opt_add, opt_silent) {\n  this.gmfThemes_.getThemesObject().then((themes) => {\n    const group = gmfThemeThemes.findGroupByLayerNodeName(themes, layerName);\n    if (group) {\n      const groupAdded = this.addFirstLevelGroups([group], opt_add, opt_silent);\n      this.$timeout_(() => {\n        const treeCtrl = this.getTreeCtrlByNodeId(group.id);\n        if (!treeCtrl) {\n          console.warn('Tree controller not found, unable to add the group');\n          return;\n        }\n        let treeCtrlToActive;\n        treeCtrl.traverseDepthFirst((treeCtrl) => {\n          if (treeCtrl.node.name === layerName) {\n            treeCtrlToActive = treeCtrl;\n            return ngeoLayertreeController.VisitorDecision.STOP;\n          }\n        });\n\n        // Deactive all layers in the group if it's not in the tree.\n        if (groupAdded)  {\n          treeCtrl.setState('off');\n        }\n\n        // Active it.\n        if (treeCtrlToActive) {\n          treeCtrlToActive.setState('on');\n        }\n      });\n    }\n  });\n};\n\n\n/**\n * Remove a group from this tree's children. The first group that is found (\n * based on its name) will be removed. If any is found, nothing will append.\n * @param {gmfThemes.GmfGroup} group The group to remove.\n * @export\n */\nexports.prototype.removeGroup = function(group) {\n  const children = this.root.children;\n  let index = 0, found = false;\n  children.some((child) => {\n    if (child.name === group.name) {\n      return found = true;\n    }\n    index++;\n  });\n  if (found) {\n    children.splice(index, 1);\n    this.updateTreeGroupsState_(children);\n  }\n};\n\n\n/**\n * Remove all groups.\n * @export\n */\nexports.prototype.removeAll = function() {\n  while (this.root.children.length) {\n    this.removeGroup(this.root.children[0]);\n  }\n};\n\n\n/**\n * Clone a group node and recursively set all child node `isChecked` using\n * the given list of layer names.\n * @param {gmfThemes.GmfGroup} group The original group node.\n * @param {Array.<string>} names Array of node names to check (i.e. that\n *     should have their checkbox checked)\n * @return {gmfThemes.GmfGroup} Cloned node.\n * @private\n */\nexports.prototype.cloneGroupNode_ = function(group, names) {\n  const clone = /** @type {gmfThemes.GmfGroup} */ (olObj.assign({}, group));\n  this.toggleNodeCheck_(clone, names);\n  return clone;\n};\n\n\n/**\n * Set the child nodes metadata `isChecked` if its name is among the list of\n * given names. If a child node also has children, check those instead.\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node The original node.\n * @param {Array.<string>} names Array of node names to check (i.e. that\n *     should have their checkbox checked)\n * @private\n */\nexports.prototype.toggleNodeCheck_ = function(node, names) {\n  if (!node.children) {\n    return;\n  }\n  node.children.forEach((childNode) => {\n    if (childNode.children) {\n      this.toggleNodeCheck_(childNode, names);\n    } else if (childNode.metadata) {\n      childNode.metadata.isChecked = olArray.includes(names, childNode.name);\n    }\n  });\n};\n\n\n/**\n * Display a notification that informs that the given groups are already in the\n * tree.\n * @param {Array.<gmfThemes.GmfGroup>} groups An array of groups that already in\n *   the tree.\n * @private\n */\nexports.prototype.notifyCantAddGroups_ = function(groups) {\n  const names = [];\n  const gettextCatalog = this.gettextCatalog_;\n  groups.forEach((group) => {\n    names.push(gettextCatalog.getString(group.name));\n  });\n  const msg = (names.length < 2) ?\n    gettextCatalog.getString('group is already loaded.') :\n    gettextCatalog.getString('groups are already loaded.');\n  this.ngeoNotification_.notify({\n    msg: `${names.join(', ')} ${msg}`,\n    type: ngeoMessageMessage.Type.INFORMATION\n  });\n};\n\n\n/**\n * Get a treeCtrl based on it's node id.\n * @param {number} id the id of a GMFThemesGroup or a GMFThemesLeaf.\n * @return {ngeo.layertree.Controller?} treeCtrl The associated controller or null.\n * @public\n */\nexports.prototype.getTreeCtrlByNodeId = function(id) {\n  let correspondingTreeCtrl = null;\n  if (this.rootCtrl && this.rootCtrl.traverseDepthFirst) {\n    this.rootCtrl.traverseDepthFirst((treeCtrl) => {\n      if (treeCtrl.node.id === id) {\n        correspondingTreeCtrl = treeCtrl;\n        return ngeoLayertreeController.VisitorDecision.STOP;\n      }\n    });\n  }\n  return correspondingTreeCtrl;\n};\n\n\n/**\n * Get the OGC server.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @return {gmfThemes.GmfOgcServer} The OGC server.\n */\nexports.prototype.getOgcServer = function(treeCtrl) {\n  if (treeCtrl.parent.node.mixed) {\n    const gmfLayerWMS = /** @type {gmfThemes.GmfLayerWMS} */ (treeCtrl.node);\n    googAsserts.assert(gmfLayerWMS.ogcServer);\n    return this.ogcServers_[gmfLayerWMS.ogcServer];\n  } else {\n    let firstLevelGroupCtrl = treeCtrl;\n    while (!firstLevelGroupCtrl.parent.isRoot) {\n      firstLevelGroupCtrl = firstLevelGroupCtrl.parent;\n    }\n    const gmfGroup = /** @type {gmfThemes.GmfGroup} */ (firstLevelGroupCtrl.node);\n    googAsserts.assert(gmfGroup.ogcServer);\n    return this.ogcServers_[gmfGroup.ogcServer];\n  }\n};\n\n\n/**\n * Keep the state of each existing first-level-groups in the layertree then\n * remove it and recreate it with nodes that come from the new theme and\n * the corresponding saved state (when possible, otherwise, juste take the\n * corresponding new node).\n * FIXME: Currently doesn't save nor restore the opacity.\n * @param {Array.<gmfThemes.GmfTheme>} themes the array of themes to be based on.\n * @private\n */\nexports.prototype.refreshFirstLevelGroups_ = function(themes) {\n  const firstLevelGroupsFullState = {};\n\n  // Save state of each child\n  this.rootCtrl.children.map((treeCtrl) => {\n    const name = treeCtrl.node.name;\n    firstLevelGroupsFullState[name] = this.getFirstLevelGroupFullState_(treeCtrl);\n  });\n\n  // Get nodes and set their state\n  const nodesToRestore = [];\n  // Iterate on the root to keep the same order in the tree as before.\n  this.root.children.map((node) => {\n    const name = node.name;\n\n    // Find the right firstlevelgroup in the new theme.\n    const nodeToRestore = gmfThemeThemes.findGroupByName(themes, name);\n    if (nodeToRestore) {\n      // Restore state.\n      const fullState = firstLevelGroupsFullState[name];\n      if (fullState) {\n        this.setNodeMetadataFromFullState_(nodeToRestore, fullState);\n      }\n      nodesToRestore.push(nodeToRestore);\n    }\n  });\n\n  // Readd the firstlevelgroups.\n  this.setFirstLevelGroups(nodesToRestore);\n\n  // Wait that Angular has created the layetree, then update the permalink.\n  this.$timeout_(() => {\n    this.updateTreeGroupsState_(this.root.children);\n  });\n};\n\n\n/**\n * Return a gmfx.TreeManagerFullState that keeps the state of the given\n * treeCtrl including the state of its children.\n * @param {ngeo.layertree.Controller} treeCtrl the ngeo layertree controller to\n *     save.\n * @return {gmfx.TreeManagerFullState!} the fullState object.\n * @private\n */\nexports.prototype.getFirstLevelGroupFullState_ = function(treeCtrl) {\n  const children = {};\n  // Get the state of the treeCtrl children recursively.\n  treeCtrl.children.map((child) => {\n    children[child.node.name] = this.getFirstLevelGroupFullState_(child);\n  });\n\n  let isChecked, isExpanded, isLegendExpanded;\n  if (treeCtrl.children.length > 0) {\n    const nodeElement = $(`#gmf-layertree-layer-group-${treeCtrl.uid}`);\n    // Set isExpanded only in groups.\n    if (nodeElement) {\n      isExpanded = nodeElement.hasClass('in');\n    }\n  } else {\n    // Set state and isLegendExpanded only in leaves.\n    isChecked = treeCtrl.getState();\n    if (isChecked === 'on') {\n      isChecked = true;\n    } else if (isChecked === 'off') {\n      isChecked = false;\n    } else {\n      isChecked = undefined;\n    }\n    const legendElement = $(`#gmf-layertree-node-${treeCtrl.uid}-legend`);\n    if (legendElement) {\n      isLegendExpanded = legendElement.is(':visible');\n    }\n  }\n\n  return {\n    children,\n    isChecked,\n    isExpanded,\n    isLegendExpanded\n  };\n};\n\n\n/**\n * Set a node's metadata with the given fullState. Update also its children\n * recursively with the fullState children.\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node to update.\n * @param {gmfx.TreeManagerFullState|undefined} fullState the fullState object\n *     to use.\n * @return {gmfThemes.GmfGroup|gmfThemes.GmfLayer} the node with modification.\n * @private\n */\nexports.prototype.setNodeMetadataFromFullState_ = function(node, fullState) {\n  if (!fullState) {\n    return node;\n  }\n\n  // Set the metadata of the node children recursively.\n  if (node.children) {\n    node.children.map((child) => {\n      this.setNodeMetadataFromFullState_(child, fullState.children[child.name]);\n    });\n  }\n\n  // Set the metadata with the fullState object information.\n  const metadata = node.metadata;\n  metadata.isChecked = fullState.isChecked;\n  metadata.isExpanded = fullState.isExpanded;\n  metadata.isLegendExpanded = fullState.isLegendExpanded;\n\n  return node;\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfTreeManager', [\n  gmfThemeThemes.module.name,\n  ngeoLayertreeController.module.name,\n  ngeoMessageNotification.module.name,\n  ngeoStatemanagerService.module.name,\n]);\nexports.module.service('gmfTreeManager', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.decorate\n */\nconst exports = {};\nimport googAsserts from 'goog/asserts.js';\nimport olInteractionInteraction from 'ol/interaction/Interaction.js';\nimport olLayerBase from 'ol/layer/Base.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\nimport olSourceImage from 'ol/source/Image.js';\nimport olSourceTile from 'ol/source/Tile.js';\n\n\n/**\n * Provides a function that adds an \"active\" property (using\n * `Object.defineProperty`) to an interaction, making it possible to use ngModel\n * to activate/deactivate interactions.\n *\n * Example:\n *\n *      <input type=\"checkbox\" ngModel=\"interaction.active\" />\n *\n * @param {ol.interaction.Interaction} interaction Interaction to decorate.\n */\nexports.interaction = function(interaction) {\n  googAsserts.assertInstanceof(interaction, olInteractionInteraction);\n\n  Object.defineProperty(interaction, 'active', {\n    get: () => interaction.getActive(),\n    set: (val) => {\n      interaction.setActive(val);\n    }\n  });\n};\n\n\n/**\n * Provides a function that adds properties (using\n * `Object.defineProperty`) to the layer, making it possible to control layer\n * properties with ngModel.\n *\n * Example:\n *\n *      <input type=\"checkbox\" ngModel=\"layer.visible\" />\n *\n * @param {ol.layer.Base} layer Layer to decorate.\n */\nexports.layer = function(layer) {\n  googAsserts.assertInstanceof(layer, olLayerBase);\n\n  Object.defineProperty(layer, 'visible', {\n    configurable: true,\n    /**\n     * @return {boolean} Visible.\n     */\n    get: () => layer.getVisible(),\n    /**\n     * @param {boolean} val Visible.\n     */\n    set: (val) => {\n      layer.setVisible(val);\n    }\n  });\n\n  Object.defineProperty(layer, 'opacity', {\n    configurable: true,\n    /**\n     * @return {number} Opacity.\n     */\n    get: () => layer.getOpacity(),\n    /**\n     * @param {number} val Opacity.\n     */\n    set: (val) => {\n      layer.setOpacity(val);\n    }\n  });\n};\n\n\n/**\n * Provides a function that adds a 'loading 'property (using\n * `Object.defineProperty`) to an ol.layer.Group or a layer with\n * an ol.source.Tile or an ol.source.Image source.\n * This property is true when the layer is loading and false otherwise.\n *\n * Example:\n *\n *      <span ng-if=\"layer.loading\">please wait</span>\n *\n * @param {ol.layer.Base} layer layer.\n * @param {angular.Scope} $scope Scope.\n */\nexports.layerLoading = function(layer, $scope) {\n\n  let source;\n\n  /**\n   * @type {Array<string>|null}\n   */\n  let incrementEvents = null;\n\n  /**\n   * @type {Array<string>|null}\n   */\n  let decrementEvents = null;\n\n  /**\n   * @function\n   * @private\n   */\n  const incrementLoadCount_ = increment_;\n\n  /**\n   * @function\n   * @private\n   */\n  const decrementLoadCount_ = decrement_;\n\n  layer.set('load_count', 0, true);\n\n  if (layer instanceof olLayerGroup) {\n    layer.getLayers().on('add', (olEvent) => {\n      const newLayer = olEvent.element;\n      newLayer.set('parent_group', layer);\n    });\n  }\n\n  if (layer instanceof olLayerLayer) {\n    source = layer.getSource();\n    if (source === null) {\n      return;\n    } else if (source instanceof olSourceTile) {\n      incrementEvents = ['tileloadstart'];\n      decrementEvents = ['tileloadend', 'tileloaderror'];\n    } else if (source instanceof olSourceImage) {\n      incrementEvents = ['imageloadstart'];\n      decrementEvents = ['imageloadend', 'imageloaderror'];\n    } else {\n      googAsserts.fail('unsupported source type');\n    }\n\n    source.on(incrementEvents, () => {\n      incrementLoadCount_(layer);\n      $scope.$applyAsync();\n    });\n\n    source.on(decrementEvents, () => {\n      decrementLoadCount_(layer);\n      $scope.$applyAsync();\n    });\n  }\n\n  Object.defineProperty(layer, 'loading', {\n    configurable: true,\n    get: () => /** @type {number} */ (layer.get('load_count')) > 0\n  });\n\n  /**\n   * @function\n   * @param {ol.layer.Base} layer Layer\n   * @private\n   */\n  function increment_(layer) {\n    let load_count = /** @type {number} */ (layer.get('load_count'));\n    const parent = /** @type {ol.layer.Base} */ (layer.get('parent_group'));\n    layer.set('load_count', ++load_count, true);\n    if (parent) {\n      increment_(parent);\n    }\n  }\n\n  /**\n   * @function\n   * @param {ol.layer.Base} layer Layer\n   * @private\n   */\n  function decrement_(layer) {\n    let load_count = /** @type {number} */ (layer.get('load_count'));\n    const parent = /** @type {ol.layer.Base} */ (layer.get('parent_group'));\n    layer.set('load_count', --load_count, true);\n    if (parent) {\n      decrement_(parent);\n    }\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.query.MapQuerent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoQueryQuerent from 'ngeo/query/Querent.js';\nimport ngeoDatasourceDataSources from 'ngeo/datasource/DataSources.js';\nimport ngeoDatasourceHelper from 'ngeo/datasource/Helper.js';\nimport * as olObj from 'ol/obj.js';\n\nconst exports = class {\n\n  /**\n   * The ngeo Map Querent is the service bound to a map that issues\n   * queries using the Querent service. The result is stored inside this\n   * service.\n   *\n   * @struct\n   * @param {angular.$injector} $injector Main injector.\n   * @param {ngeo.datasource.DataSources} ngeoDataSources Ngeo data sources service.\n   * @param {ngeo.datasource.Helper} ngeoDataSourcesHelper Ngeo data\n   *     sources helper service.\n   * @param {ngeo.query.Querent} ngeoQuerent The ngeo querent service.\n   * @param {ngeox.QueryResult} ngeoQueryResult The ngeo query result service.\n   * @ngdoc service\n   * @ngname ngeoQuerent\n   * @ngInject\n   */\n  constructor($injector, ngeoDataSources, ngeoDataSourcesHelper, ngeoQuerent,\n    ngeoQueryResult) {\n\n    const options = /** @type {ngeox.QueryOptions} */ (\n      $injector.has('ngeoQueryOptions') ?\n        $injector.get('ngeoQueryOptions') : {});\n\n    /**\n     * @type {ngeox.datasource.DataSources}\n     * @private\n     */\n    this.dataSources_ = ngeoDataSources.collection;\n\n    /**\n     * @type {ngeo.datasource.Helper}\n     * @private\n     */\n    this.ngeoDataSourcesHelper_ = ngeoDataSourcesHelper;\n\n    /**\n     * @type {ngeo.query.Querent}\n     * @private\n     */\n    this.ngeoQuerent_ = ngeoQuerent;\n\n    /**\n     * @type {ngeox.QueryResult}\n     * @private\n     */\n    this.result_ = ngeoQueryResult;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.limit_ = options.limit !== undefined ? options.limit : 50;\n\n    /**\n     * When set, before making WFS GetFeature requests to fetch features,\n     * WFS GetFeature requests with `resultType = 'hits'` are made first. If\n     * the number of records for the request would exceed the limit, then\n     * no features are returned.\n     *\n     * @type {boolean}\n     * @private\n     */\n    this.queryCountFirst_ = options.queryCountFirst !== undefined ?\n      options.queryCountFirst : false;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.tolerancePx_ = options.tolerance !== undefined ?\n      options.tolerance : 3;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.bboxAsGETParam_ = options.bboxAsGETParam || false;\n\n    /**\n     * A hash of data source names classified by ids.\n     * @type {Object.<number, string>}\n     * @private\n     */\n    this.dataSourceNames_ = {};\n  }\n\n  /**\n   * @param {ngeox.IssueGetFeaturesOptions} options Options.\n   * @export\n   */\n  issue(options) {\n    // (1) Clear previous result\n    this.clear();\n\n    // (2) Get queryable data sources, unless they are already set\n    let queryableDataSources;\n    if (options.dataSources === undefined &&\n        options.queryableDataSources === undefined\n    ) {\n      queryableDataSources = this.ngeoQuerent_.getQueryableDataSources(\n        this.dataSources_.getArray(),\n        options.map\n      );\n    }\n\n    // (3) Update query options, update the pending property and issue the\n    //     request.\n    const limit = options.limit !== undefined ? options.limit : this.limit_;\n    olObj.assign(options, {\n      queryableDataSources: queryableDataSources,\n      limit: limit,\n      tolerancePx: this.tolerancePx_,\n      wfsCount: this.queryCountFirst_,\n      bboxAsGETParam: this.bboxAsGETParam_\n    });\n    this.result_.pending = true;\n    this.ngeoQuerent_.issue(options).then(this.handleResult_.bind(this));\n  }\n\n  /**\n   * Clear result, i.e. clear all 'result source' from their features and other\n   * information.\n   * @export\n   */\n  clear() {\n    this.result_.total = 0;\n    for (const source of this.result_.sources) {\n      source.features.length = 0;\n      source.pending = false;\n      source.queried = false;\n      source.tooManyResults = false;\n      source.totalFeatureCount = undefined;\n    }\n    this.result_.sources.length = 0; // Clear previous result sources\n    this.result_.pending = false;\n  }\n\n  /**\n   * Called after a request to the querent service. Update the result.\n   *\n   * @param {ngeox.QuerentResult} response Response\n   * @private\n   */\n  handleResult_(response) {\n    let total = 0;\n\n    // (1) Update result sources, i.e. add them\n    for (const idStr in response) {\n      const id = Number(idStr);\n      const dataSource = this.ngeoDataSourcesHelper_.getDataSource(id);\n      let label = dataSource.name;\n      googAsserts.assert(dataSource);\n\n      const querentResultItem = response[id];\n      const features = querentResultItem.features;\n      const limit = querentResultItem.limit;\n      const tooManyResults = querentResultItem.tooManyFeatures === true;\n      const totalFeatureCount = querentResultItem.totalFeatureCount;\n\n      const typeSeparatedFeatures = {};\n      features.forEach((feature) => {\n        const type = googAsserts.assertString(feature.get('ngeo_feature_type_'));\n        if (!typeSeparatedFeatures[type]) {\n          typeSeparatedFeatures[type] = [];\n        }\n        // Use properties aliases if any\n        if (dataSource.attributes && dataSource.attributes.length) {\n          const properties = feature.getProperties();\n          const filteredProperties = {};\n          dataSource.attributes.forEach((attribute) => {\n            if (attribute.alias) {\n              filteredProperties[attribute.alias] = properties[attribute.name];\n              feature.unset(attribute.name, /* silent */ true);\n            } else {\n              // No alias is available => use the attribute as is.\n              filteredProperties[attribute.name] = properties[attribute.name];\n            }\n          });\n          feature.setProperties(filteredProperties, /* silent */ true);\n        }\n        typeSeparatedFeatures[type].push(feature);\n      });\n\n      for (const type in typeSeparatedFeatures) {\n        label = type ? type : label;\n        const featuresByType = typeSeparatedFeatures[type];\n        this.result_.sources.push({\n          features: featuresByType,\n          id: id,\n          label: label,\n          limit: limit,\n          pending: false,\n          queried: true,\n          tooManyResults: tooManyResults,\n          totalFeatureCount: totalFeatureCount\n        });\n        total += features.length;\n      }\n    }\n\n    // (2) Update total & pending\n    this.result_.total = total;\n    this.result_.pending = false;\n  }\n\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoMapQuerent', [\n  ngeoDatasourceDataSources.module.name,\n  ngeoDatasourceHelper.module.name,\n  ngeoQueryQuerent.module.name,\n]);\nexports.module.service('ngeoMapQuerent', exports);\n\n\n/**\n * The `ngeoQueryResult` is the value service where the features of the query\n * result are added.\n */\nexports.module.value('ngeoQueryResult', /** @type {ngeox.QueryResult} */ ({\n  sources: [],\n  total: 0,\n  pending: false\n}));\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.EventHelper\n */\nimport * as olEvents from 'ol/events.js';\n\n/**\n * Provides methods to manage the listening/unlistening of OpenLayers events\n *\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoEventHelper\n * @ngInject\n */\nconst exports = function() {\n\n  /**\n   * @type {Object.<number|string, Array.<ol.EventsKey>>}\n   * @private\n   */\n  this.listenerKeys_ = {};\n\n};\n\n\n/**\n * Utility method to add a listener key bound to a unique id. The key has\n * to come from `ol.events`.\n * @param {number|string} uid Unique id.\n * @param {ol.EventsKey} key Key.\n * @export\n */\nexports.prototype.addListenerKey = function(uid, key) {\n  if (!this.listenerKeys_[uid]) {\n    this.initListenerKey_(uid);\n  }\n  this.listenerKeys_[uid].push(/** @type {ol.EventsKey} */ (key));\n};\n\n\n/**\n * Clear all listener keys from the given unique id.\n * @param {number|string} uid Unique id.\n * @export\n */\nexports.prototype.clearListenerKey = function(uid) {\n  this.initListenerKey_(uid);\n};\n\n\n/**\n * Utility method that does 2 things:\n * - initialize the listener keys of a given uid with an array (if that key\n *   has not array set yet)\n * - unlisten any events if the array already exists for the given uid and\n *   empty the array.\n * @param {number|string} uid Unique id.\n * @private\n */\nexports.prototype.initListenerKey_ = function(uid) {\n  if (!this.listenerKeys_[uid]) {\n    this.listenerKeys_[uid] = [];\n  } else {\n    if (this.listenerKeys_[uid].length) {\n      this.listenerKeys_[uid].forEach(olEvents.unlistenByKey);\n      this.listenerKeys_[uid].length = 0;\n    }\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoEventHelper', []);\nexports.module.service('ngeoEventHelper', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.WMSTime\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscTime from 'ngeo/misc/Time.js';\nimport * as olBase from 'ol/index.js';\n\n/**\n * ngeo - WMS time service\n * @extends {ngeo.misc.Time}\n * @param {angular.$filter} $filter angular filter service.\n * @param {!angularGettext.Catalog} gettextCatalog service.\n * @constructor\n * @struct\n * @ngInject\n * @ngdoc service\n * @ngname ngeoWMSTime\n */\nconst exports = function($filter, gettextCatalog) {\n\n  /**\n   * @private\n   * @type {angular.$filter}\n   */\n  this.$filter_ = $filter;\n\n  /**\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  ngeoMiscTime.call(this);\n};\n\nolBase.inherits(exports, ngeoMiscTime);\n\n\n/**\n * Format time regarding a resolution\n * @param  {number} time (in ms format) timestamp to format\n * @param  {(ngeox.TimePropertyResolutionEnum|undefined)} resolution resolution to use\n * @param  {boolean=} opt_useISOFormat True to a ISO-8601 date string that can be used\n *     as a WMS-T Parameter. Otherwise, use a localized date format.\n * @param  {boolean=} opt_toUTC to get the UTC date\n * @return {string} Date string regarding the resolution.\n */\nexports.prototype.formatTimeValue = function(time, resolution, opt_useISOFormat, opt_toUTC) {\n  const date = new Date(time);\n  const utc = opt_toUTC ? 'UTC' : undefined;\n\n  // ISO-8601 format to use date as a WMS-T Parameter.\n  let yearResolution = 'yyyy';\n  let monthResolution = 'yyyy-MM';\n  let dayResolution = 'yyyy-MM-dd';\n  let secondResolution = undefined;\n\n  // Localized format.\n  if (!opt_useISOFormat) {\n    const gettextCatalog = this.gettextCatalog_;\n    yearResolution = gettextCatalog.getString('yyyy');\n    monthResolution = gettextCatalog.getString('M/yyyy');\n    dayResolution = gettextCatalog.getString('M/d/yyyy');\n    secondResolution = gettextCatalog.getString('M/d/yyyy HH:MM:ss');\n  }\n\n  switch (resolution) {\n    case 'year':\n      return this.$filter_('date')(date, yearResolution, utc);\n    case 'month':\n      return this.$filter_('date')(date, monthResolution, utc);\n    case 'day':\n      return this.$filter_('date')(date, dayResolution, utc);\n    case 'second':\n      if (secondResolution) {\n        return this.$filter_('date')(date, secondResolution, utc);\n      } else {\n        return date.toISOString().replace(/\\.\\d{3}/, '');\n      }\n    default:\n      //case \"second\":\n      return date.toISOString().replace(/\\.\\d{3}/, '');\n  }\n};\n\n\n/**\n * Format time to be used as a WMS Time query parameter\n * @param  {ngeox.TimeProperty} wmsTimeProperty a wmstime property from a node\n * @param  {{start : number, end : (number|undefined)}} times start & end time selected (in ms format)\n * @param  {boolean=} opt_toUTC to get the UTC date\n * @return {string} ISO-8601 date string ready to be used as a query parameter for a\n * WMS request\n * @export\n */\nexports.prototype.formatWMSTimeParam = function(wmsTimeProperty, times, opt_toUTC) {\n  googAsserts.assert(wmsTimeProperty.resolution !== undefined);\n  if (wmsTimeProperty.mode === 'range') {\n    googAsserts.assert(times.end !== undefined);\n    return (\n      `${this.formatTimeValue(times.start, wmsTimeProperty.resolution, true, opt_toUTC)}/${\n        this.formatTimeValue(times.end, wmsTimeProperty.resolution, true, opt_toUTC)}`\n    );\n  } else {\n    return this.formatTimeValue(times.start, wmsTimeProperty.resolution, true, opt_toUTC);\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoWMSTime', [\n  ngeoMiscTime.module.name,\n]);\nexports.module.service('ngeoWMSTime', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.filters\n */\nimport * as olMath from 'ol/math.js';\nimport * as olString from 'ol/string.js';\nconst exports = angular.module('ngeoAngularFilters', []);\n\n/**\n * Format a number as a localized scale.\n * For instance:\n *  - For 'fr-CH' the value 25000 will become '1 : 25 000'.\n *  - For 'en-US' the value 25000 will become '1 : 25,000'.\n *\n * Example:\n *\n *      <p>{{25000 | ngeoScalify}}</p>\n *\n *\n * @param {angular.$filter} $filter Angular filter\n * @return {function(number): string} A function to format number into a 'scale'\n *     string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoScalify\n */\nexports.Scalify = function($filter) {\n  const numberFilter = $filter('number');\n  const filterFn = function(scale) {\n    const text = numberFilter(scale, 0);\n    return text ? `1\\u00a0:\\u00a0${text}` : '';\n  };\n  filterFn['$stateful'] = true;\n  return filterFn;\n};\n\nexports.filter('ngeoScalify', exports.Scalify);\n\n/**\n * A filter used to format a number with a precision, using the locale.\n *\n * Arguments:\n * - opt_precision: The used precision, default is 3.\n *\n * Examples:\n *\n *      {{0.1234 | ngeoNumber}} => 0.123\n *      {{1.234 | ngeoNumber}} => 1.23\n *      {{12.34 | ngeoNumber}} => 12.3\n *      {{123.4 | ngeoNumber}} => 123\n *      {{1234 | ngeoNumber}} => 1230\n *\n * @param {angular.$locale} $locale Angular locale\n * @return {ngeox.number} Function used to format number into a string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoNumber\n */\nexports.Number = function($locale) {\n  const formats = $locale.NUMBER_FORMATS;\n\n  /**\n   * @param {number} number The number to format.\n   * @param {number=} opt_precision The used precision, default is 3.\n   * @return {string} The formatted string.\n   */\n  const result = function(number, opt_precision) {\n    const groupSep = formats.GROUP_SEP;\n    const decimalSep = formats.DECIMAL_SEP;\n    if (opt_precision === undefined) {\n      opt_precision = 3;\n    }\n\n    if (number === Infinity) {\n      return '\\u221e';\n    } else if (number === -Infinity) {\n      return '-\\u221e';\n    } else if (number === 0) {\n      // 0 will creates infinity values\n      return '0';\n    }\n    const sign = number < 0;\n    number = Math.abs(number);\n\n    const nb_decimal = opt_precision - Math.floor(Math.log(number) / Math.log(10)) - 1;\n    const factor = Math.pow(10, nb_decimal);\n    number = Math.round(number * factor);\n    let decimal = '';\n    const unit = Math.floor(number / factor);\n\n    if (nb_decimal > 0) {\n      let str_number = `${number}`;\n      // 0 padding\n      while (str_number.length < nb_decimal) {\n        str_number = `0${str_number}`;\n      }\n      decimal = str_number.substring(str_number.length - nb_decimal);\n      while (decimal[decimal.length - 1] === '0') {\n        decimal = decimal.substring(0, decimal.length - 1);\n      }\n    }\n\n    const groups = [];\n    let str_unit = `${unit}`;\n    while (str_unit.length > 3) {\n      const index = str_unit.length - 3;\n      groups.unshift(str_unit.substring(index));\n      str_unit = str_unit.substring(0, index);\n    }\n    groups.unshift(str_unit);\n\n    return (sign ? '-' : '') + groups.join(groupSep) + (\n      decimal.length === 0 ? '' : decimalSep + decimal\n    );\n  };\n  return result;\n};\n\nexports.filter('ngeoNumber', exports.Number);\n\n/**\n * A filter used to format a number with the prefix and unit\n *\n * Arguments:\n * - opt_unit: The unit to used, default is ''.\n * - opt_type: (unit|square|binary) the type of units, default is 'unit'.\n * - opt_precision: The used precision, default is 3.\n *\n * Examples:\n *\n *      {{25000 | ngeoUnitPrefix}} => 25 k\n *      {{25000 | ngeoUnitPrefix:'m'}} => 25 km\n *      {{25000000 | ngeoUnitPrefix:'m²':'square'}} => 25 km²\n *      {{2048 | ngeoUnitPrefix:'o':'binary'}} => 2 Kio\n *\n *\n * @param {angular.$filter} $filter Angular filter\n * @return {ngeox.unitPrefix} Function used to format number into a string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoUnitPrefix\n */\nexports.UnitPrefix = function($filter) {\n  const numberFilter = $filter('ngeoNumber');\n  const standardPrefix = ['', 'k', 'M', 'G', 'T', 'P'];\n  const binaryPrefix = ['', 'Ki', 'Mi', 'Gi', 'Ti', 'Pi'];\n  /**\n   * @param {number} number The number to format.\n   * @param {string=} opt_unit The unit to used, default is ''.\n   * @param {string=} opt_type (unit|square|binary) the type of units, default is 'unit'.\n   * @param {number=} opt_precision The used precision, default is 3.\n   * @return {string} The formatted string.\n   */\n  const result = function(number, opt_unit, opt_type, opt_precision) {\n    if (opt_unit === undefined) {\n      opt_unit = '';\n    }\n    let divisor = 1000;\n    let prefix = standardPrefix;\n    if (opt_type === 'square') {\n      divisor = 1000000;\n    } else if (opt_type === 'binary') {\n      divisor = 1024;\n      prefix = binaryPrefix;\n    }\n\n    let index = 0;\n    const index_max = prefix.length - 1;\n    while (number >= divisor && index < index_max) {\n      number = number / divisor;\n      index++;\n    }\n\n    const postfix = prefix[index] + opt_unit;\n    const space = postfix.length == 0 ? '' : '\\u00a0';\n    return numberFilter(number, opt_precision) + space + postfix;\n  };\n  return result;\n};\n\nexports.filter('ngeoUnitPrefix', exports.UnitPrefix);\n\n/**\n * Format a couple of numbers as number coordinates.\n *\n * Example without parameters:\n *\n *      <p>{{[7.1234, 46.9876] | ngeoNumberCoordinates}}</p>\n *      <!-- will Become 7 47 -->\n *\n * Example with defined fractionDigits and template (en-US localization):\n *\n *      <!-- With en-US localization -->\n *      <p>{{[7.1234, 46.9876] | ngeoNumberCoordinates:2:'co {x} E; {y} N'}}</p>\n *      <!-- will Become co 7.12 E; 46.99 N -->\n *      <br/>\n *      <!-- With en-US localization -->\n *      <p>{{[2600000, 1600000] | ngeoNumberCoordinates:0:'{x}, {y}'}}</p>\n *      <!-- will Become 2,600,000, 1,600,000 -->\n *      <br/>\n *      <!-- With fr-CH localization -->\n *      <p>{{[2600000, 1600000] | ngeoNumberCoordinates:0:'{x}, {y}'}}</p>\n *      <!-- will Become 2'600'000, 1'600'000 -->\n *\n * @param {angular.$filter} $filter Angular filter\n * @return {ngeox.numberCoordinates} A function to format numbers into coordinates string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoNumberCoordinates\n */\nexports.NumberCoordinates = function($filter) {\n  /**\n   * @param {ol.Coordinate} coordinates Array of two numbers.\n   * @param {(number|string)=} opt_fractionDigits Optional number of digit.\n   *     Default to 0.\n   * @param {string=} opt_template Optional template. Default to '{x} {y}'.\n   *     Where \"{x}\" will be replaced by the easting coordinate and \"{y}\" by the\n   *     northing one. Note: Use a html entity to use the semicolon symbol\n   *     into a template.\n   * @return {string} Number formatted coordinates.\n   */\n  const filterFn = function(coordinates, opt_fractionDigits, opt_template) {\n    const template = opt_template ? opt_template : '{x} {y}';\n    let x = coordinates[0];\n    let y = coordinates[1];\n    const fractionDigits = parseInt(opt_fractionDigits, 10) | 0;\n    x = $filter('number')(x, fractionDigits);\n    y = $filter('number')(y, fractionDigits);\n    return template.replace('{x}', x).replace('{y}', y);\n  };\n  return filterFn;\n};\n\nexports.filter('ngeoNumberCoordinates', exports.NumberCoordinates);\n\n\n/**\n * Format coordinates as DMS coordinates.\n *\n * Example without parameters:\n *\n *      <p>{{[7.1234, 46.9876] | ngeoDMSCoordinates}}</p>\n *      <!-- will Become  7° 07' 24'' E 46° 59' 15'' N-->\n *\n * Example with defined fractionDigits and a template.\n *\n *      <p>{{[7.1234, 46.9876] | ngeoDMSCoordinates:2:'[{y}; {x]'}}</p>\n *      <!-- will Become [46° 59' 15.36'' N; 7° 07' 24.24'' E] -->\n *\n * @return {ngeox.dmsCoordinates} A function to format numbers into a DMS coordinates string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoDMSCoordinates\n */\nexports.DMSCoordinates = function() {\n  const degreesToStringHDMS = function(degrees, hemispheres, fractionDigits) {\n    const normalizedDegrees = olMath.modulo(degrees + 180, 360) - 180;\n    const dms = Math.abs(3600 * normalizedDegrees);\n    const d = Math.floor(dms / 3600);\n    const m = Math.floor((dms / 60) % 60);\n    const s = (dms % 60);\n    return `${d}\\u00b0 ${\n      olString.padNumber(m, 2)}\\u2032 ${\n      olString.padNumber(s, 2, fractionDigits)}\\u2033 ${\n      hemispheres.charAt(normalizedDegrees < 0 ? 1 : 0)}`;\n  };\n\n  /**\n   * @param {ol.Coordinate} coordinates Array of two numbers.\n   * @param {(number|string)=} opt_fractionDigits Optional number of digit.\n   *     Default to 0.\n   * @param {string=} opt_template Optional template. Default to\n   *     '{x} {y}'. Where \"{x}\" will be replaced by the easting\n   *     coordinate, {y} by the northing one. Note: Use a html entity to use the\n   *     semicolon symbol into a template.\n   * @return {string} DMS formatted coordinates.\n   */\n  const filterFn = function(coordinates, opt_fractionDigits, opt_template) {\n    const fractionDigits = parseInt(opt_fractionDigits, 10) | 0;\n\n    const template = opt_template ? opt_template : '{x} {y}';\n\n    const xdms = degreesToStringHDMS(coordinates[0], 'EW', fractionDigits);\n    const ydms = degreesToStringHDMS(coordinates[1], 'NS', fractionDigits);\n\n    return template.replace('{x}', xdms).replace('{y}', ydms);\n  };\n\n  return filterFn;\n};\n\nexports.filter('ngeoDMSCoordinates', exports.DMSCoordinates);\n\n\n/**\n * A filter to mark a value as trusted HTML.\n *\n * Usage:\n *\n *    <p ng-bind-html=\"ctrl.someValue | ngeoTrustHtml\"></p>\n *\n * If you use it, you don't require the \"ngSanitize\".\n * @return {function(?):string} The filter function.\n * @ngInject\n * @ngdoc filter\n * @param {angular.$sce} $sce Angular sce service.\n * @ngname ngeoTrustHtml\n */\nexports.trustHtmlFilter = function($sce) {\n  return function(input) {\n    if (input !== undefined && input !== null) {\n      return $sce.trustAsHtml(`${input}`);\n    } else {\n      return $sce.trustAsHtml('&nbsp;');\n    }\n  };\n};\n\nexports.filter('ngeoTrustHtml', exports.trustHtmlFilter);\n\n\n/**\n * A filter used to format a time duration in seconds into a more\n * readable form.\n * Only the two largest units will be shown.\n *\n * Examples:\n *      {{42 | ngeoDuration}} => 42 seconds\n *      {{132 | ngeoDuration}} => 2 minutes 12 seconds\n *      {{3910 | ngeoDuration}} => 1 hour 5 minutes\n *        -> Note: the remaining 10 seconds will be dropped\n *\n * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @return {ngeox.duration} Function used to format a time duration in seconds into a string.\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoDuration\n */\nexports.Duration = function(gettextCatalog) {\n  // time unit enum\n  const TimeUnits = Object.freeze({\n    SECONDS: Symbol('seconds'),\n    MINUTES: Symbol('minutes'),\n    HOURS: Symbol('hours'),\n    DAYS: Symbol('days')\n  });\n\n  /**\n   * @param {number} amount Amount of time.\n   * @param {symbol} unit Unit of time.\n   * @return {string} formatted and translated string\n   */\n  const pluralize = function(amount, unit) {\n    let formattedUnit = '';\n    switch (unit) {\n      case TimeUnits.SECONDS:\n        formattedUnit = gettextCatalog.getPlural(amount, 'second', 'seconds');\n        break;\n      case TimeUnits.MINUTES:\n        formattedUnit = gettextCatalog.getPlural(amount, 'minute', 'minutes');\n        break;\n      case TimeUnits.HOURS:\n        formattedUnit = gettextCatalog.getPlural(amount, 'hour', 'hours');\n        break;\n      case TimeUnits.DAYS:\n        formattedUnit = gettextCatalog.getPlural(amount, 'day', 'days');\n        break;\n      default:\n        break;\n    }\n    return `${amount} ${formattedUnit}`;\n  };\n\n  /**\n   * @param {number} duration The duration in seconds.\n   * @return {string} The formatted string.\n   */\n  const result = function(duration) {\n    // round to next integer\n    duration = Math.round(duration);\n\n    // just seconds\n    let output;\n    if (duration < 60) {\n      return pluralize(duration, TimeUnits.SECONDS);\n    }\n\n    // minutes (+ seconds)\n    let remainder = duration % 60; // seconds\n    duration = Math.floor(duration / 60); // minutes\n    if (duration < 60) { // less than an hour\n      output = pluralize(duration, TimeUnits.MINUTES);\n      if (remainder > 0) {\n        output += ` ${pluralize(remainder, TimeUnits.SECONDS)}`;\n      }\n      return output;\n    }\n\n    // hours (+ minutes)\n    remainder = duration % 60; // minutes\n    duration = Math.floor(duration / 60); // hours\n    if (duration < 24) { // less than a day\n      output = pluralize(duration, TimeUnits.HOURS);\n      if (remainder > 0) {\n        output += ` ${pluralize(remainder, TimeUnits.MINUTES)}`;\n      }\n      return output;\n    }\n\n    // days (+ hours)\n    remainder = duration % 24; // hours\n    duration = Math.floor(duration / 24); // days\n    output = pluralize(duration, TimeUnits.DAYS);\n    if (remainder > 0) {\n      output += ` ${pluralize(remainder, TimeUnits.HOURS)}`;\n    }\n    return output;\n  };\n\n  return result;\n};\n\nexports.filter('ngeoDuration', exports.Duration);\n\n\n/**\n * A filter used to remove the CDATA prefix and postfix.\n *\n * @return {function(string): string} Retult string\n * @ngInject\n * @ngdoc filter\n * @ngname ngeoDuration\n */\nconst removeCDATA = function() {\n  return function(input) {\n    if (input) {\n      return input.replace(/<!\\[CDATA\\[(.*)\\]\\]>/, '$1');\n    }\n  };\n};\n\nexports.filter('removeCDATA', removeCDATA);\n\n\nexport default exports;\n","/**\n * @module gmf.layertree.SyncLayertreeMap\n */\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\nimport * as olBase from 'ol/index.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\n\n/**\n * Service to create layer based on a ngeo.layertree.Controller with a\n * GMFThemesGroup or a GMFThemesLeaf as node object.\n * This layer is also used to synchronise a state of ngeo.layertree.Controller\n * and its corresponding layer in the map.\n *\n * @constructor\n * @param {angular.Scope} $rootScope Angular rootScope.\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {ngeo.misc.WMSTime} ngeoWMSTime wms time service.\n * @param {gmf.theme.Themes} gmfThemes The gmf Themes service.\n * @ngInject\n * @ngdoc service\n * @ngname gmfSyncLayertreeMap\n */\nconst exports = function($rootScope, ngeoLayerHelper, ngeoWMSTime,\n  gmfThemes) {\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.layerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {ngeo.misc.WMSTime}\n   * @private\n   */\n  this.ngeoWMSTime_ = ngeoWMSTime;\n\n  /**\n   * @type {gmfThemes.GmfOgcServers}\n   * @private\n   */\n  this.ogcServersObject_;\n\n  gmfThemes.getOgcServersObject().then((ogcServersObject) => {\n    this.ogcServersObject_ = ogcServersObject;\n  });\n\n  $rootScope.$on('ngeo-layertree-state', (map, treeCtrl, firstParent) => {\n    this.sync_(/** @type ol.Map */ (map), firstParent);\n  });\n};\n\n\n/**\n * Create, insert (or update) and return a layer from the GmfGroup or the\n * GmfLayer of the given treeCtrl.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @param {ol.Map} map A map that contains the group to insert the not first\n *     level group layer.\n * @param {ol.layer.Group} dataLayerGroup the layer group to insert the first\n *     level group layer.\n * @param {number=} opt_position for first level Group, you can precise the\n *     position to add the group in the array of layers of the dataLayerGroup.\n * @return {ol.layer.Base|ol.layer.Group} a new layer.\n * @public\n */\nexports.prototype.createLayer = function(treeCtrl, map, dataLayerGroup, opt_position) {\n  /**\n   * @type {ol.layer.Base|ol.layer.Group}\n   */\n  let layer = null;\n  if (treeCtrl.node.children !== undefined && treeCtrl.node.mixed) {\n    // Mixed groups\n    layer = this.createGroup_(treeCtrl, map, dataLayerGroup, opt_position);\n  } else if (treeCtrl.node.children === undefined && treeCtrl.parent.node.mixed) {\n    // Layers in a mixed group\n    layer = this.createLeafInAMixedGroup_(treeCtrl, map);\n  } else if (treeCtrl.node.children === undefined) {\n    // Layers in a non mixed group\n    this.initGmfLayerInANotMixedGroup_(treeCtrl, map);\n  } else if (treeCtrl.depth === 1 && !treeCtrl.node.mixed) {\n    // First level group non mix\n    layer = this.createGroup_(treeCtrl, map, dataLayerGroup, opt_position);\n  }\n\n  if (layer && treeCtrl.node.metadata.opacity) {\n    layer.setOpacity(treeCtrl.node.metadata.opacity);\n  }\n\n  return layer;\n};\n\n\n/**\n * Synchronise the state of each layers corresponding to the given tree and\n * all its children.\n * @param {ol.Map} map A map that contains the layers.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @private\n */\nexports.prototype.sync_ = function(map, treeCtrl) {\n  treeCtrl.traverseDepthFirst((treeCtrl) => {\n    if (treeCtrl.layer && !treeCtrl.node.mixed) {\n      this.updateLayerState_(/** @type ol.layer.Image|ol.layer.Tile */ (treeCtrl.layer), treeCtrl);\n    }\n  });\n};\n\n\n/**\n * Set the active state of a layer based on its treeCtrl state.\n * @param {ol.layer.Tile|ol.layer.Image} layer A layer.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @private\n */\nexports.prototype.updateLayerState_ = function(layer, treeCtrl) {\n  const active = treeCtrl.getState() === 'on';\n  if (treeCtrl.node.type === 'WMTS') {\n    layer.setVisible(active);\n  } else if (!treeCtrl.node.mixed && treeCtrl.depth === 1) {\n    // First level non mixed group\n    googAsserts.assertInstanceof(layer, olLayerImage);\n    const names = [];\n    const styles = [];\n    treeCtrl.traverseDepthFirst((treeCtrl) => {\n      if (treeCtrl.node.children === undefined && treeCtrl.getState() === 'on') {\n        names.push(treeCtrl.node.layers);\n        const style = (treeCtrl.node.style !== undefined) ? treeCtrl.node.style : '';\n        styles.push(style);\n      }\n    });\n    if (names.length === 0) {\n      layer.setVisible(false);\n    }\n    /** @type {ol.source.ImageWMS} */ (layer.getSource()).updateParams({\n      'LAYERS': names.reverse().join(','),\n      'STYLES': styles.reverse().join(',')\n    });\n    if (names.length !== 0) {\n      layer.setVisible(true);\n    }\n  } else {\n    // WMS mixed layer\n    googAsserts.assertInstanceof(layer, olLayerImage);\n    layer.setVisible(active);\n  }\n};\n\n\n/**\n * Create insert and return a layer group (for not mixed case) or a wmsLayer (for\n * mixed case). Take care about the insertion order in the map in case of first\n * level group.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @param {ol.Map} map A map that contains the group to insert the not first\n *     level group layer.\n * @param {ol.layer.Group} dataLayerGroup the layer group to insert the first\n *     level group layer.\n * @param {number=} opt_position for first level Group, you can precise the\n *     position to add the group in the array of layers of the dataLayerGroup.\n * @return {ol.layer.Image|ol.layer.Group} a new layer.\n * @private\n */\nexports.prototype.createGroup_ = function(treeCtrl, map,\n  dataLayerGroup, opt_position) {\n  const groupNode = /** @type {gmfThemes.GmfGroup} */ (treeCtrl.node);\n  let layer = null;\n  const isFirstLevelGroup = treeCtrl.parent.isRoot;\n\n  let printNativeAngle = true;\n  if (groupNode.metadata.printNativeAngle !== undefined) {\n    printNativeAngle = groupNode.metadata.printNativeAngle;\n  }\n\n  if (isFirstLevelGroup) { // First level group\n    layer = this.createLayerFromGroup_(treeCtrl, !!groupNode.mixed);\n    // Insert the layer at the right place\n    const position = opt_position | 0;\n    dataLayerGroup.getLayers().insertAt(position, layer);\n\n  } else { // Other Groups, create a group layer only in mixed groups\n    const inAMixedGroup = !this.isOneParentNotMixed_(treeCtrl);\n    if (inAMixedGroup) {\n      layer = this.createLayerFromGroup_(treeCtrl, true);\n      const layerGroup = /** @type {ol.layer.Group} */ (\n        exports.getLayer(treeCtrl.parent));\n      layerGroup.getLayers().insertAt(0, layer);\n    }\n  }\n\n  layer.set('printNativeAngle', printNativeAngle);\n  return layer;\n};\n\n\n/**\n * Create, insert and return a layer group (for not mixed case) or a wmsLayer\n * for mixed case).\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @param {boolean} mixed True for a group layer, false for a WMS layer.\n * @return {ol.layer.Image|ol.layer.Group} a new layer.\n * @private\n */\nexports.prototype.createLayerFromGroup_ = function(treeCtrl,\n  mixed) {\n  let layer;\n  const groupNode = /** @type {gmfThemes.GmfGroup} */ (treeCtrl.node);\n  if (mixed) { // Will be one ol.layer per each node.\n    layer = this.layerHelper_.createBasicGroup();\n  } else { // Will be one ol.layer for multiple WMS nodes.\n    const timeParam = this.getTimeParam_(treeCtrl);\n    const ogcServer = this.ogcServersObject_[groupNode.ogcServer || ''];\n    googAsserts.assert(ogcServer);\n    googAsserts.assert(ogcServer.url);\n    googAsserts.assert(ogcServer.type);\n    googAsserts.assert(ogcServer.imageType);\n    layer = this.layerHelper_.createBasicWMSLayer(\n      ogcServer.url,\n      '',\n      ogcServer.imageType,\n      ogcServer.type,\n      timeParam,\n      undefined, // WMS parameters\n      ogcServer.credential ? 'use-credentials' : 'anonymous'\n    );\n    let hasActiveChildren = false;\n    treeCtrl.traverseDepthFirst((ctrl) => {\n      // Update layer information and tree state.\n      this.updateLayerReferences_(/** @type gmfThemes.GmfLayer */ (ctrl.node), layer);\n      if (ctrl.node.metadata.isChecked) {\n        ctrl.setState('on', false);\n        this.updateLayerState_(/** @type {ol.layer.Image} */ (layer), ctrl);\n        hasActiveChildren = true;\n      }\n    });\n    layer.setVisible(hasActiveChildren);\n    layer.set('layerNodeName', groupNode.name); //Really useful ?\n  }\n  return layer;\n};\n\n\n/**\n * Create and insert a layer from a leaf in a mixed group.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @param {ol.Map} map A map that contains the group to insert the layer.\n * @return {ol.layer.Tile|ol.layer.Image} a new layer.\n * @private\n */\nexports.prototype.createLeafInAMixedGroup_ = function(treeCtrl, map) {\n  const gmfLayer = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n  let layer;\n  // Make layer.\n  if (gmfLayer.type === 'WMTS') {\n    layer = this.createWMTSLayer_(/** @type gmfThemes.GmfLayerWMTS */ (gmfLayer));\n  } else {\n    const gmfLayerWMS = /** @type gmfThemes.GmfLayerWMS */ (gmfLayer);\n    const timeParam = this.getTimeParam_(treeCtrl);\n    const ogcServer = this.ogcServersObject_[/** @type string */ (gmfLayerWMS.ogcServer)];\n    googAsserts.assert(ogcServer);\n    googAsserts.assert(ogcServer.url);\n    googAsserts.assert(ogcServer.type);\n    googAsserts.assert(gmfLayerWMS.layers);\n    googAsserts.assert(ogcServer.imageType);\n\n    const opt_params = {STYLES: gmfLayerWMS.style};\n\n    layer = this.layerHelper_.createBasicWMSLayer(\n      ogcServer.url,\n      gmfLayerWMS.layers,\n      ogcServer.imageType,\n      ogcServer.type,\n      timeParam,\n      opt_params, // WMS parameters\n      ogcServer.credential ? 'use-credentials' : 'anonymous'\n    );\n  }\n  // Update layer information and tree state.\n  layer.set('layerNodeName', gmfLayer.name); // Really useful ?\n  this.updateLayerReferences_(gmfLayer, layer);\n  const checked = gmfLayer.metadata.isChecked === true;\n  if (checked) {\n    treeCtrl.setState('on', false);\n  }\n  layer.setVisible(checked);\n  // Insert layer in the map.\n  const layerGroup = /** @type {ol.layer.Group} */ (\n    exports.getLayer(treeCtrl.parent));\n  layerGroup.getLayers().insertAt(0, layer);\n  return layer;\n};\n\n\n/**\n * Update a WMS layer with the given treeCtrl node information. Assumes that\n * the first parent with ogcServer information is linked to the layer to update\n * and that this treeCtrl node is a leafNode.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @param {ol.Map} map A map that contains the layer to update.\n * @private\n */\nexports.prototype.initGmfLayerInANotMixedGroup_ = function(treeCtrl, map) {\n  const leafNode = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n  const firstLevelGroup = this.getFirstLevelGroupCtrl_(treeCtrl);\n  googAsserts.assert(firstLevelGroup);\n  const layer = /** @type {ol.layer.Image} */ (firstLevelGroup.layer);\n  googAsserts.assertInstanceof(layer, olLayerImage);\n  // Update layer information and tree state.\n  this.updateLayerReferences_(leafNode, layer);\n  if (leafNode.metadata.isChecked) {\n    treeCtrl.setState('on', false);\n    this.updateLayerState_(layer, firstLevelGroup);\n  } else {\n    treeCtrl.parent.refreshState();\n  }\n};\n\n\n/**\n * Create and return a Tile layer.\n * @param {gmfThemes.GmfLayerWMTS} gmfLayerWMTS A leaf node.\n * @return {ol.layer.Tile} a Tile WMTS layer. (Source and capabilities can come\n *     later).\n * @private\n */\nexports.prototype.createWMTSLayer_ = function(gmfLayerWMTS) {\n  const newLayer = new olLayerTile();\n  googAsserts.assert(gmfLayerWMTS.url);\n  googAsserts.assert(gmfLayerWMTS.layer);\n  this.layerHelper_.createWMTSLayerFromCapabilitites(gmfLayerWMTS.url,\n    gmfLayerWMTS.layer, gmfLayerWMTS.matrixSet, gmfLayerWMTS.dimensions).then((layer) => {\n    newLayer.setSource(layer.getSource());\n    newLayer.set('capabilitiesStyles', layer.get('capabilitiesStyles'));\n  });\n  return newLayer;\n};\n\n\n/**\n * Update properties of a layer with the node of a given leafNode.\n * @param {gmfThemes.GmfLayer} leafNode a leaf node.\n * @param {ol.layer.Base} layer A layer.\n * @private\n */\nexports.prototype.updateLayerReferences_ = function(leafNode, layer) {\n  const id = olBase.getUid(leafNode);\n  const querySourceIds = layer.get('querySourceIds') || [];\n  querySourceIds.push(id);\n  layer.set('querySourceIds', querySourceIds);\n\n  const disclaimer = leafNode.metadata.disclaimer;\n  if (disclaimer) {\n    const disclaimers = layer.get('disclaimers') || [];\n    disclaimers.push(leafNode.metadata.disclaimer);\n    layer.set('disclaimers', disclaimers);\n  }\n};\n\n\n/**\n * Get the time parameter for a WMS Layer. If it's a group and it doesn't have\n * time, get the first time parameter available in any child.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @return {string|undefined} A wms time param.\n * @private\n */\nexports.prototype.getTimeParam_ = function(treeCtrl) {\n  let wmsTime;\n  let timeParam;\n  const node = treeCtrl.node;\n  if (node.time) {\n    wmsTime = node.time;\n  } else if (node.children) {\n    treeCtrl.traverseDepthFirst((treeCtrl) => {\n      if (treeCtrl.node.children === undefined && treeCtrl.node.time) {\n        wmsTime = treeCtrl.node.time;\n        return ngeoLayertreeController.VisitorDecision.STOP;\n      }\n    });\n  }\n  if (wmsTime) {\n    const timeValues = this.ngeoWMSTime_.getOptions(wmsTime)['values'];\n    timeParam = this.ngeoWMSTime_.formatWMSTimeParam(wmsTime, {\n      start: timeValues[0] || timeValues,\n      end: timeValues[1]\n    });\n  }\n  return timeParam;\n};\n\n\n/**\n * Return true if a parent tree is mixed, based on its node.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @return {boolean} True is any parent is mixed. False Otherwise.\n * @private\n */\nexports.prototype.isOneParentNotMixed_ = function(treeCtrl) {\n  let tree = treeCtrl.parent;\n  let isOneParentNotMix = false;\n  do {\n    isOneParentNotMix = tree.node.mixed === false;\n    tree = tree.parent;\n  }\n  while (tree.parent && !isOneParentNotMix);\n  return isOneParentNotMix;\n};\n\n\n/**\n * Return the first parent, from the root parent, that is not mixed.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @return {ngeo.layertree.Controller} The first not mixed parent.\n * @private\n */\nexports.prototype.getFirstLevelGroupCtrl_ = function(\n  treeCtrl) {\n  let tree = treeCtrl;\n  while (!tree.parent.isRoot) {\n    tree = tree.parent;\n  }\n  return tree;\n};\n\n\n/**\n * Return the layer used by the given treeCtrl.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller.\n * @return {ol.layer.Base} The layer.\n * @public\n */\nexports.getLayer = function(treeCtrl) {\n  let tree = treeCtrl;\n  let layer = null;\n  while (!tree.isRoot && layer === null) {\n    if (tree.layer) {\n      layer = tree.layer;\n    }\n    tree = tree.parent;\n  }\n  return layer;\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfSyncLayertreeMap', [\n  gmfThemeThemes.module.name,\n  ngeoLayertreeController.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\nexports.module.service('gmfSyncLayertreeMap', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.ToolActivateMgr\n */\nimport googAsserts from 'goog/asserts.js';\n\n/**\n * Provides a service to manage the activation of `ngeo.misc.ToolActivate` objects.\n *\n * Example:\n *\n * Each tool must be registered before using it.\n *\n *     let tool = new ngeo.misc.ToolActivate(interaction, 'active');\n *     ngeoToolActivateMgr.registerTool('mapTools', tool);\n *\n * A tool will be registered in a group identified by a group name.\n * Once registered a tool can be activated and deactivated. When activating a\n * tool, all others tools in the same group will be deactivated.\n *\n *     ngeoToolActivateMgr.activateTool(tool);\n *     ngeoToolActivateMgr.deactivateTool(tool);\n *\n * See our live examples:\n * [../examples/mapquery.html](../examples/mapquery.html)\n * [../examples/toolActivate.html](../examples/toolActivate.html)\n *\n * @param {angular.Scope} $rootScope The rootScope provider.\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoToolActivateMgr\n * @ngInject\n */\nconst exports = function($rootScope) {\n\n  /**\n   * @type {!Object.<string, Array.<ngeox.miscToolActivateMgrEntry>>}\n   * @private\n   */\n  this.groups_ = {};\n\n  /**\n   * The scope.\n   * @type {angular.Scope}\n   * @private\n   */\n  this.scope_ = $rootScope;\n};\n\n\n/**\n * Register a tool.\n * @param {string} groupName Name of the group of this tool.\n * @param {ngeo.misc.ToolActivate} tool Tool to register.\n * @param {boolean=} opt_defaultActivate If true, this tool will be activated\n *     when all other tools in the group are deactivated.\n * @export\n */\nexports.prototype.registerTool = function(groupName, tool,\n  opt_defaultActivate) {\n  let entries = this.groups_[groupName];\n  if (!entries) {\n    entries = this.groups_[groupName] = [];\n  }\n\n  const unlisten = this.scope_.$watch(\n    tool.getActive,\n    (newVal, oldVal) => {\n      if (newVal === oldVal) {\n        return;\n      }\n      if (newVal) {\n        this.deactivateTools_(groupName, tool);\n      } else {\n        this.activateDefault_(groupName);\n      }\n    });\n\n  entries.push({\n    tool: tool,\n    defaultTool: opt_defaultActivate || false,\n    unlisten: unlisten\n  });\n\n  if (googAsserts.ENABLE_ASSERTS) {\n    // check that only one default tool per group exists\n    let defaultTools = 0;\n    entries.forEach((entry) => {\n      if (entry.defaultTool) {\n        defaultTools++;\n      }\n    });\n    googAsserts.assert(\n      defaultTools <= 1, `more than one default tool in group ${groupName}`);\n  }\n};\n\n\n/**\n * Unregister a tool from a group.\n * @param {string} groupName Name of the group of this tool.\n * @param {ngeo.misc.ToolActivate} tool Tool to unregister.\n * @export\n */\nexports.prototype.unregisterTool = function(groupName, tool) {\n  const entries = this.groups_[groupName];\n  if (entries) {\n    for (let i = 0; i < entries.length; i++) {\n      if (entries[i].tool == tool) {\n        entries[i].unlisten();\n        entries.splice(i, 1);\n        break;\n      }\n    }\n  }\n};\n\n\n/**\n * Unregister each tool from a group.\n * @param {string} groupName Name of the group of tools to unregister.\n * @export\n */\nexports.prototype.unregisterGroup = function(groupName) {\n  const entries = this.groups_[groupName];\n  if (entries) {\n    for (let i = 0; i < entries.length; i++) {\n      entries[i].unlisten();\n    }\n    delete this.groups_[groupName];\n  }\n};\n\n\n/**\n * Activate a tool.\n * @param {ngeo.misc.ToolActivate} tool Tool to activate.\n * @export\n */\nexports.prototype.activateTool = function(tool) {\n  tool.setActive(true);\n};\n\n\n/**\n * Deactivate a tool.\n * @param {ngeo.misc.ToolActivate} tool Tool to deactivate.\n * @export\n */\nexports.prototype.deactivateTool = function(tool) {\n  tool.setActive(false);\n};\n\n\n/**\n * Deactivate all tools except the given one.\n *\n * @param {string} groupName Name of the group.\n * @param {ngeo.misc.ToolActivate} tool Tool to activate.\n * @private\n */\nexports.prototype.deactivateTools_ = function(groupName, tool) {\n  const entries = this.groups_[groupName];\n  for (let i = 0; i < entries.length; i++) {\n    if (tool != entries[i].tool) {\n      entries[i].tool.setActive(false);\n    }\n  }\n};\n\n\n/**\n * Activate the default tool in the given group if no other tool is active.\n *\n * @param {string} groupName Name of the group.\n * @private\n */\nexports.prototype.activateDefault_ = function(groupName) {\n  const entries = this.groups_[groupName];\n  let defaultTool = null;\n  let hasActiveTool = false;\n\n  for (let i = 0; i < entries.length; i++) {\n    hasActiveTool = hasActiveTool || entries[i].tool.getActive();\n\n    if (entries[i].defaultTool) {\n      defaultTool = entries[i].tool;\n    }\n  }\n\n  if (!hasActiveTool && defaultTool !== null) {\n    defaultTool.setActive(true);\n  }\n};\n\n\nexports.module = angular.module('ngeoToolActivateMgr', []);\nexports.module.service('ngeoToolActivateMgr', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.filter.Condition\n */\n/**\n * @enum {string}\n * @export\n */\nconst exports = {\n  /**\n   * @type {string}\n   * @export\n   */\n  AND: '&&',\n  /**\n   * @type {string}\n   * @export\n   */\n  NOT: '!',\n  /**\n   * @type {string}\n   * @export\n   */\n  OR: '||'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.rule.Date\n */\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\n\nconst exports = class extends ngeoRuleRule {\n\n  /**\n   * A date rule.\n   *\n   * @struct\n   * @param {!ngeox.rule.DateOptions} options Options.\n   */\n  constructor(options) {\n\n    options.type = options.type || ngeoFormatAttributeType.DATE;\n\n    super(options);\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.rule.Text\n */\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\n\nconst exports = class extends ngeoRuleRule {\n\n  /**\n   * A text rule, which always compares the value with the LIKE operator, by\n   * default.\n   *\n   * @struct\n   * @param {!ngeox.rule.TextOptions} options Options.\n   */\n  constructor(options) {\n\n    options.operator = options.operator || ngeoRuleRule.OperatorType.LIKE;\n    options.type = ngeoFormatAttributeType.TEXT;\n\n    super(options);\n\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.filter.RuleHelper\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoFilterCondition from 'ngeo/filter/Condition.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\nimport ngeoRuleDate from 'ngeo/rule/Date.js';\nimport ngeoRuleGeometry from 'ngeo/rule/Geometry.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\nimport ngeoRuleSelect from 'ngeo/rule/Select.js';\nimport ngeoRuleText from 'ngeo/rule/Text.js';\nimport {writeFilter} from 'ol/format/WFS.js';\nimport * as olFormatFilter from 'ol/format/filter.js';\nimport * as olArray from 'ol/array.js';\n\nimport moment from 'moment';\n\n\nconst exports = class {\n\n  /**\n   * A service that provides utility methods to create `ngeo.rule.Rule`\n   * objects.\n   *\n   * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n   * @param {!ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n   * @param {!ngeo.misc.WMSTime} ngeoWMSTime wms time service.\n   * @struct\n   * @ngdoc service\n   * @ngname ngeoRuleHelper\n   * @ngInject\n   */\n  constructor(gettextCatalog, ngeoFeatureHelper, ngeoWMSTime) {\n\n    /**\n     * @type {!angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * @type {!ngeo.misc.FeatureHelper}\n     * @private\n     */\n    this.ngeoFeatureHelper_ = ngeoFeatureHelper;\n\n    /**\n     * @type {!ngeo.misc.WMSTime}\n     * @private\n     */\n    this.ngeoWMSTime_ = ngeoWMSTime;\n  }\n\n  /**\n   * @param {!Array.<!ngeox.Attribute>} attributes Attributes.\n   * @param {boolean=} opt_isCustom Whether the created rules should be marked\n   *     as custom or not. Defaults to `false`.\n   * @return {Array.<!ngeo.rule.Rule>} Rules.\n   * @export\n   */\n  createRulesFromAttributes(attributes, opt_isCustom) {\n    const rules = [];\n    for (const attribute of attributes) {\n      rules.push(this.createRuleFromAttribute(attribute, opt_isCustom));\n    }\n    return rules;\n  }\n\n  /**\n   * @param {!ngeox.Attribute} attribute Attribute.\n   * @param {boolean=} opt_isCustom Whether the created rule should be marked\n   *     as custom or not. Defaults to `false`.\n   * @return {!ngeo.rule.Rule} Rule.\n   * @export\n   */\n  createRuleFromAttribute(attribute, opt_isCustom) {\n\n    let rule;\n    const isCustom = opt_isCustom === true;\n\n    /**\n     * @type {string}\n     */\n    const name = this.gettextCatalog_.getString(attribute.name);\n\n    // Todo: support geometry\n\n    switch (attribute.type) {\n      case ngeoFormatAttributeType.DATE:\n      case ngeoFormatAttributeType.DATETIME:\n        if (isCustom) {\n          rule = new ngeoRuleDate({\n            name: name,\n            operator: ngeoRuleRule.TemporalOperatorType.EQUALS,\n            operators: [\n              ngeoRuleRule.TemporalOperatorType.EQUALS,\n              ngeoRuleRule.TemporalOperatorType.BEGINS,\n              ngeoRuleRule.TemporalOperatorType.ENDS\n            ],\n            propertyName: attribute.name,\n            type: attribute.type\n          });\n        } else {\n          rule = new ngeoRuleDate({\n            name: name,\n            operator: ngeoRuleRule.TemporalOperatorType.DURING,\n            propertyName: attribute.name,\n            type: attribute.type\n          });\n        }\n        break;\n      case ngeoFormatAttributeType.GEOMETRY:\n        rule = new ngeoRuleGeometry({\n          name: name,\n          operator: ngeoRuleRule.SpatialOperatorType.WITHIN,\n          operators: [\n            ngeoRuleRule.SpatialOperatorType.CONTAINS,\n            ngeoRuleRule.SpatialOperatorType.INTERSECTS,\n            ngeoRuleRule.SpatialOperatorType.WITHIN\n          ],\n          propertyName: attribute.name,\n          type: attribute.type\n        });\n        break;\n      case ngeoFormatAttributeType.NUMBER:\n        if (isCustom) {\n          rule = new ngeoRuleRule({\n            name: name,\n            operator: ngeoRuleRule.OperatorType.EQUAL_TO,\n            operators: [\n              ngeoRuleRule.OperatorType.EQUAL_TO,\n              ngeoRuleRule.OperatorType.GREATER_THAN,\n              ngeoRuleRule.OperatorType.GREATER_THAN_OR_EQUAL_TO,\n              ngeoRuleRule.OperatorType.LESSER_THAN,\n              ngeoRuleRule.OperatorType.LESSER_THAN_OR_EQUAL_TO,\n              ngeoRuleRule.OperatorType.NOT_EQUAL_TO\n            ],\n            propertyName: attribute.name,\n            type: ngeoFormatAttributeType.NUMBER\n          });\n        } else {\n          rule = new ngeoRuleRule({\n            name: name,\n            operator: ngeoRuleRule.OperatorType.BETWEEN,\n            propertyName: attribute.name,\n            type: ngeoFormatAttributeType.NUMBER\n          });\n        }\n        break;\n      case ngeoFormatAttributeType.SELECT:\n        rule = new ngeoRuleSelect({\n          choices: googAsserts.assert(attribute.choices),\n          name: name,\n          propertyName: attribute.name\n        });\n        break;\n      default:\n        if (isCustom) {\n          rule = new ngeoRuleText({\n            name: name,\n            operator: ngeoRuleRule.OperatorType.LIKE,\n            operators: [\n              ngeoRuleRule.OperatorType.LIKE,\n              ngeoRuleRule.OperatorType.EQUAL_TO,\n              ngeoRuleRule.OperatorType.NOT_EQUAL_TO\n            ],\n            propertyName: attribute.name\n          });\n        } else {\n          rule = new ngeoRuleText({\n            name: name,\n            operator: ngeoRuleRule.OperatorType.LIKE,\n            propertyName: attribute.name\n          });\n        }\n        break;\n    }\n\n    return rule;\n  }\n\n  /**\n   * @param {!Array.<!ngeox.rule.RuleOptions|!ngeox.rule.SelectOptions>} optionsList List of options\n   * @return {Array.<!ngeo.rule.Rule>} Rules.\n   * @export\n   */\n  createRules(optionsList) {\n    const rules = [];\n    for (const options of optionsList) {\n      rules.push(this.createRule(options));\n    }\n    return rules;\n  }\n\n  /**\n   * @param {!ngeox.rule.RuleOptions|!ngeox.rule.SelectOptions} options Options\n   * @return {!ngeo.rule.Rule} Rule.\n   * @export\n   */\n  createRule(options) {\n    let rule;\n    switch (options.type) {\n      case ngeoFormatAttributeType.DATE:\n      case ngeoFormatAttributeType.DATETIME:\n        rule = new ngeoRuleDate(options);\n        break;\n      case ngeoFormatAttributeType.GEOMETRY:\n        rule = new ngeoRuleGeometry(options);\n        break;\n      case ngeoFormatAttributeType.SELECT:\n        const selectOptions = /** @type {!ngeox.rule.SelectOptions} */ (\n          options);\n        googAsserts.assert(selectOptions.choices);\n        rule = new ngeoRuleSelect(selectOptions);\n        break;\n      default:\n        rule = new ngeoRuleText(options);\n        break;\n    }\n    return rule;\n  }\n\n  /**\n   * Create a new `ngeo.rule.Rule` object using an other given rule.\n   *\n   * @param {!ngeo.rule.Rule} rule Original rule to clone.\n   * @return {!ngeo.rule.Rule} A clone rule.\n   * @export\n   */\n  cloneRule(rule) {\n\n    let clone;\n\n    let expression = rule.getExpression();\n    if (expression === null) {\n      expression = undefined;\n    }\n    const isCustom = rule.isCustom;\n    const lowerBoundary = rule.lowerBoundary !== null ? rule.lowerBoundary :\n      undefined;\n    const name = rule.name;\n    const operator = rule.operator !== null ? rule.operator : undefined;\n    const operators = rule.operators ? rule.operators.slice(0) : undefined;\n    const propertyName = rule.propertyName;\n    const type = rule.type !== null ? rule.type : undefined;\n    const upperBoundary = rule.upperBoundary !== null ? rule.upperBoundary :\n      undefined;\n\n    const options = {\n      expression,\n      isCustom,\n      lowerBoundary,\n      name,\n      operator,\n      operators,\n      propertyName,\n      type,\n      upperBoundary\n    };\n\n    if (rule instanceof ngeoRuleDate) {\n      clone = new ngeoRuleDate(options);\n    } else if (rule instanceof ngeoRuleGeometry) {\n      clone = new ngeoRuleGeometry(options);\n      clone.feature.setProperties(\n        this.ngeoFeatureHelper_.getNonSpatialProperties(rule.feature)\n      );\n    } else if (rule instanceof ngeoRuleSelect) {\n      options.choices = rule.choices.slice(0);\n      clone = new ngeoRuleSelect(options);\n    } else if (rule instanceof ngeoRuleText) {\n      clone = new ngeoRuleText(options);\n    } else {\n      clone = new ngeoRuleRule(options);\n    }\n\n    return clone;\n  }\n\n  /**\n   * Extend the dynamic properties from a source rule to destination rule.\n   * The source rule remains unchanged, while the destination rule changes.\n   *\n   * @param {!ngeo.rule.Rule} sourceRule Source rule to collect the dynamic\n   *     properties from.\n   * @param {!ngeo.rule.Rule} destRule Destination rule where the dynamic\n   *     properties are set.\n   * @export\n   */\n  extendRule(sourceRule, destRule) {\n\n    if (destRule.getExpression() !== sourceRule.getExpression()) {\n      destRule.setExpression(sourceRule.getExpression());\n    }\n\n    if (destRule.lowerBoundary !== sourceRule.lowerBoundary) {\n      destRule.lowerBoundary = sourceRule.lowerBoundary;\n    }\n\n    if (destRule.operator !== sourceRule.operator) {\n      destRule.operator = sourceRule.operator;\n    }\n\n    if (destRule.upperBoundary !== sourceRule.upperBoundary) {\n      destRule.upperBoundary = sourceRule.upperBoundary;\n    }\n\n    if (sourceRule instanceof ngeoRuleGeometry &&\n       destRule instanceof ngeoRuleGeometry\n    ) {\n      this.ngeoFeatureHelper_.clearNonSpatialProperties(destRule.feature);\n      destRule.feature.setProperties(\n        this.ngeoFeatureHelper_.getNonSpatialProperties(sourceRule.feature)\n      );\n    }\n  }\n\n  /**\n   * @param {!Array.<!ngeo.rule.Rule>} rules Rules\n   * @return {!Array.<!ngeox.rule.AnyOptions>} List of serialized rule options.\n   * @export\n   */\n  serializeRules(rules) {\n    return rules.map((rule) => {\n      const serializedRule = this.serializeRule(rule);\n      return serializedRule;\n    });\n  }\n\n  /**\n   * Selialize a rule into options to re-create it later.\n   * @param {!ngeo.rule.Rule} rule Rule to serialize.\n   * @return {!ngeox.rule.AnyOptions} Serialized rule options.\n   * @export\n   */\n  serializeRule(rule) {\n    const obj = {\n      name: rule.name,\n      propertyName: rule.propertyName,\n      type: rule.type\n    };\n\n    if (rule.expression !== null) {\n      obj.expression = rule.expression;\n    }\n\n    if (rule.lowerBoundary !== null) {\n      obj.lowerBoundary = rule.lowerBoundary;\n    }\n\n    if (rule.operator !== null) {\n      obj.operator = rule.operator;\n    }\n\n    if (rule.operators !== null) {\n      obj.operators = rule.operators.slice(0);\n    }\n\n    if (rule.upperBoundary !== null) {\n      obj.upperBoundary = rule.upperBoundary;\n    }\n\n    if (rule instanceof ngeoRuleGeometry) {\n      obj.featureProperties = this.ngeoFeatureHelper_.getNonSpatialProperties(\n        rule.feature);\n    }\n\n    if (rule instanceof ngeoRuleSelect) {\n      obj.choices = rule.choices;\n    }\n\n    return obj;\n  }\n\n  /**\n   * Create a `ol.format.filter.Filter` object for a given data source.\n   * See the `ngeox.CreateFilterOptions` to learn more.\n   *\n   * @param {ngeox.CreateFilterOptions} options Options.\n   * @return {?ol.format.filter.Filter} Filter.\n   * @export\n   */\n  createFilter(options) {\n\n    const dataSource = /** @type {ngeo.datasource.OGC} */ (options.dataSource);\n    let mainFilter = null;\n\n    if (options.filter) {\n      mainFilter = options.filter;\n    } else {\n      const rules = options.filterRules || dataSource.filterRules;\n      const conditions = [];\n\n      if (rules && rules.length) {\n        for (const rule of rules) {\n          const filter = this.createFilterFromRule_(\n            rule,\n            dataSource,\n            options.srsName\n          );\n          if (filter) {\n            conditions.push(filter);\n          }\n        }\n      }\n\n      const condition = dataSource.filterCondition;\n      if (conditions.length === 1) {\n        mainFilter = conditions[0];\n      } else if (conditions.length >= 2) {\n        if (condition === ngeoFilterCondition.AND) {\n          mainFilter = olFormatFilter.and.apply(null, conditions);\n        } else if (condition === ngeoFilterCondition.OR ||\n                   condition === ngeoFilterCondition.NOT\n        ) {\n          mainFilter = olFormatFilter.or.apply(null, conditions);\n        }\n      }\n      if (mainFilter && condition === ngeoFilterCondition.NOT) {\n        mainFilter = olFormatFilter.not(mainFilter);\n      }\n    }\n\n    if (options.incTime) {\n      const timeFilter = this.createTimeFilterFromDataSource_(dataSource);\n      if (timeFilter) {\n        if (mainFilter) {\n          mainFilter = olFormatFilter.and.apply(\n            null,\n            [\n              mainFilter,\n              timeFilter\n            ]\n          );\n        } else {\n          mainFilter = timeFilter;\n        }\n      }\n    }\n\n    if (options.incDimensions) {\n      const dimensionsFilter = this.createDimensionsFilterFromDataSource_(dataSource);\n      if (dimensionsFilter) {\n        if (mainFilter) {\n          mainFilter = olFormatFilter.and.apply(null, [mainFilter, dimensionsFilter]);\n        } else {\n          mainFilter = dimensionsFilter;\n        }\n      }\n    }\n\n    return mainFilter;\n  }\n\n  /**\n   * @param {ngeox.CreateFilterOptions} options Options.\n   * @return {?string} Filter string.\n   * @export\n   */\n  createFilterString(options) {\n    let filterString = null;\n    const filter = this.createFilter(options);\n    if (filter) {\n      const filterNode = writeFilter(filter);\n      const xmlSerializer = new XMLSerializer();\n      filterString = xmlSerializer.serializeToString(filterNode);\n    }\n    return filterString;\n  }\n\n  /**\n   * @param {ngeo.rule.Rule} rule Rule.\n   * @param {ngeo.datasource.OGC} dataSource Data source.\n   * @param {string=} opt_srsName SRS name. No srsName attribute will be\n   *     set on geometries when this is not provided.\n   * @return {?ol.format.filter.Filter} filter Filter;\n   * @private\n   */\n  createFilterFromRule_(rule, dataSource, opt_srsName) {\n\n    let filter = null;\n\n    const value = rule.value;\n    if (!value) {\n      return null;\n    }\n\n    const expression = value.expression;\n    const lowerBoundary = value.lowerBoundary;\n    const operator = value.operator;\n    const propertyName = value.propertyName;\n    const upperBoundary = value.upperBoundary;\n\n    const rot =  ngeoRuleRule.OperatorType;\n    const rsot = ngeoRuleRule.SpatialOperatorType;\n    const rtot = ngeoRuleRule.TemporalOperatorType;\n\n    const spatialTypes = [\n      rsot.CONTAINS,\n      rsot.INTERSECTS,\n      rsot.WITHIN\n    ];\n\n    const numericTypes = [\n      rot.GREATER_THAN,\n      rot.GREATER_THAN_OR_EQUAL_TO,\n      rot.LESSER_THAN,\n      rot.LESSER_THAN_OR_EQUAL_TO\n    ];\n\n    if (rule instanceof ngeoRuleDate) {\n      let beginValue;\n      let endValue;\n\n      if (operator === rtot.DURING) {\n        beginValue = moment(lowerBoundary).format('YYYY-MM-DD');\n        endValue = moment(upperBoundary).format('YYYY-MM-DD');\n      } else if (operator === rtot.EQUALS) {\n        beginValue = moment(expression)\n          .format('YYYY-MM-DD');\n        endValue = beginValue;\n      } else if (operator === rtot.BEGINS) {\n        beginValue = moment(expression)\n          .format('YYYY-MM-DD');\n        // NOTE: end value is CURRENT + 30 years\n        endValue = moment(expression)\n          .add(30, 'years')\n          .format('YYYY-MM-DD');\n      } else if (operator === rtot.ENDS) {\n        // NOTE: begin value is hardcoded to 1970-01-01\n        beginValue = '1970-01-01';\n        endValue = moment(expression)\n          .format('YYYY-MM-DD');\n      }\n      if (beginValue && endValue) {\n        filter = olFormatFilter.during(\n          propertyName,\n          beginValue,\n          endValue\n        );\n      }\n    } else if (rule instanceof ngeoRuleSelect) {\n      const selectedChoices = rule.selectedChoices;\n      if (selectedChoices.length === 1) {\n        filter = olFormatFilter.equalTo(\n          propertyName,\n          selectedChoices[0]\n        );\n      } else if (selectedChoices.length >= 2) {\n        const conditions = [];\n        for (const selectedChoice of selectedChoices) {\n          conditions.push(\n            olFormatFilter.equalTo(\n              propertyName,\n              selectedChoice\n            )\n          );\n        }\n        filter = olFormatFilter.or.apply(null, conditions);\n      }\n    } else if (olArray.includes(spatialTypes, operator)) {\n      const geometryName = dataSource.geometryName;\n      googAsserts.assertInstanceof(rule, ngeoRuleGeometry);\n      const geometry = googAsserts.assert(rule.geometry);\n      if (operator === rsot.CONTAINS) {\n        filter = olFormatFilter.contains(\n          geometryName,\n          geometry,\n          opt_srsName\n        );\n      } else if (operator === rsot.INTERSECTS) {\n        filter = olFormatFilter.intersects(\n          geometryName,\n          geometry,\n          opt_srsName\n        );\n      } else if (operator === rsot.WITHIN) {\n        filter = olFormatFilter.within(\n          geometryName,\n          geometry,\n          opt_srsName\n        );\n      }\n    } else if (olArray.includes(numericTypes, operator)) {\n      const numericExpression = googAsserts.assertNumber(expression);\n      if (operator === rot.GREATER_THAN) {\n        filter = olFormatFilter.greaterThan(\n          propertyName,\n          numericExpression\n        );\n      } else if (operator === rot.GREATER_THAN_OR_EQUAL_TO) {\n        filter = olFormatFilter.greaterThanOrEqualTo(\n          propertyName,\n          numericExpression\n        );\n      } else if (operator === rot.LESSER_THAN) {\n        filter = olFormatFilter.lessThan(\n          propertyName,\n          numericExpression\n        );\n      } else if (operator === rot.LESSER_THAN_OR_EQUAL_TO) {\n        filter = olFormatFilter.lessThanOrEqualTo(\n          propertyName,\n          numericExpression\n        );\n      }\n    } else if (operator === rot.BETWEEN) {\n      filter = olFormatFilter.between(\n        propertyName,\n        lowerBoundary,\n        upperBoundary\n      );\n    } else if (operator === rot.EQUAL_TO) {\n      filter = olFormatFilter.equalTo(\n        propertyName,\n        expression\n      );\n    } else if (operator === rot.LIKE) {\n      const stringExpression = String(expression)\n        .replace(/!/g, '!!')\n        .replace(/\\./g, '!.')\n        .replace(/\\*/g, '!*');\n      filter = olFormatFilter.like(\n        propertyName,\n        `*${stringExpression}*`,\n        '*', /* wildCard */\n        '.', /* singleChar */\n        '!', /* escapeChar */\n        false /* matchCase */\n      );\n    } else if (operator === rot.NOT_EQUAL_TO) {\n      filter = olFormatFilter.notEqualTo(\n        propertyName,\n        expression\n      );\n    }\n\n    return filter;\n  }\n\n  /**\n   * Create and return an OpenLayers filter object using the available\n   * dimensions filters configuration within the data source.\n   * @param {ngeo.DataSource} dataSource Data source from which to create the\n   *     filter.\n   * @return {?ol.format.filter.Filter} Filter\n   * @private\n   */\n  createDimensionsFilterFromDataSource_(dataSource) {\n    const config = dataSource.dimensionsFiltersConfig;\n    const dimensions = dataSource.dimensions;\n\n    const conditions = [];\n    for (const key in config) {\n      let value = config[key].value;\n      if (value === null) {\n        if (dimensions[key] !== undefined && dimensions[key] !== null) {\n          value = dimensions[key];\n        }\n      }\n      if (value !== null) {\n        conditions.push(olFormatFilter.equalTo(config[key].field, value, true));\n      }\n    }\n    if (conditions.length === 1) {\n      return conditions[0];\n    } else if (conditions.length >= 2) {\n      return olFormatFilter.and.apply(null, conditions);\n    }\n    return null;\n  }\n\n  /**\n   * Create and return an OpenLayers filter object using the available\n   * time properties within the data source.\n   * @param {ngeo.datasource.OGC} dataSource Data source from which to\n   *     create the filter.\n   * @return {?ol.format.filter.Filter} Filter\n   * @private\n   */\n  createTimeFilterFromDataSource_(dataSource) {\n    let filter = null;\n    const range = dataSource.timeRangeValue;\n    const timeProperty = dataSource.timeProperty;\n    const name = dataSource.timeAttributeName;\n\n    if (range && timeProperty && name) {\n\n      if (range.end !== undefined) {\n        // Case 1: the range has both 'start' and 'end' values.  Use them to\n        //         create a During filter.\n\n        const values = this.ngeoWMSTime_.formatWMSTimeParam(\n          timeProperty,\n          range\n        ).split('/');\n\n        filter = olFormatFilter.during(name, values[0], values[1]);\n      } else {\n\n        // Case 2: we only have a 'start' value. We need to calculate the 'end'\n        //         using the resolution of the time property.\n\n        const resolution = timeProperty.resolution || 'seconds';\n        const value = this.ngeoWMSTime_.formatWMSTimeParam(\n          timeProperty,\n          range\n        );\n        let momentEnd;\n\n        switch (resolution) {\n          case 'year':\n            momentEnd = moment(value).add(1, 'years').subtract(1, 'seconds');\n            break;\n          case 'month':\n            momentEnd = moment(value).add(1, 'months').subtract(1, 'seconds');\n            break;\n          case 'day':\n            momentEnd = moment(value).add(1, 'days').subtract(1, 'seconds');\n            break;\n          default:\n            //case \"second\":\n            // This would require a TContains filter, which neither OpenLayers\n            // and MapServer support. Skip...\n        }\n\n        if (momentEnd) {\n          const startValue = moment(value).utc().format('YYYY-MM-DD HH:mm:ss');\n          const endValue = momentEnd.utc().format('YYYY-MM-DD HH:mm:ss');\n          filter = olFormatFilter.during(name, startValue, endValue);\n        }\n      }\n    }\n\n    return filter;\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoRuleHelper', [\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\nexports.module.service('ngeoRuleHelper', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.File\n */\nimport ngeoDatasourceDataSource from 'ngeo/datasource/DataSource.js';\nimport olCollection from 'ol/Collection.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\n\nconst exports = class extends ngeoDatasourceDataSource {\n\n  /**\n   * A data source that contains vector features that were loaded from a file.\n   *\n   * @struct\n   * @param {ngeox.datasource.FileOptions} options Options.\n   */\n  constructor(options) {\n\n    super(options);\n\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * @type {!ol.Collection.<!ol.Feature>}\n     * @private\n     */\n    this.featuresCollection_ = options.features || new olCollection();\n\n    /**\n     * @type {!ol.source.Vector}\n     * @private\n     */\n    this.source_ = new olSourceVector({\n      features: this.featuresCollection_,\n      wrapX: false\n    });\n\n    /**\n     * @type {!ol.layer.Vector}\n     * @private\n     */\n    this.layer_ = new olLayerVector({\n      source: this.source_\n    });\n  }\n\n\n  // ========================================\n  // === Dynamic property getters/setters ===\n  // ========================================\n\n  /**\n   * @return {!Array.<!ol.Feature>} Features\n   * @export\n   */\n  get features() {\n    return this.featuresCollection_.getArray();\n  }\n\n\n  // =======================================\n  // === Static property getters/setters ===\n  // =======================================\n\n  /**\n   * @return {!ol.Collection.<!ol.Feature>} Features collection\n   * @export\n   */\n  get featuresCollection() {\n    return this.featuresCollection_;\n  }\n\n  /**\n   * @return {!ol.layer.Vector} Vector layer.\n   * @export\n   */\n  get layer() {\n    return this.layer_;\n  }\n\n\n  // ===================================\n  // === Calculated property getters ===\n  // ===================================\n\n  /**\n   * @return {ol.Extent} Extent.\n   * @export\n   */\n  get extent() {\n    return this.source_.getExtent();\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.FileGroup\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceFile from 'ngeo/datasource/File.js';\nimport ngeoDatasourceGroup from 'ngeo/datasource/Group.js';\n\nconst exports = class extends ngeoDatasourceGroup {\n\n  /**\n   * A FileGroup data source combines multiple `ngeo.datasource.File` objects.\n   * Its main goal is to synchronize the added data source 'visible' properties\n   * with the visibility of their layer 'visible' property.\n   *\n   * @struct\n   * @param {ngeox.datasource.FileGroupOptions} options Options.\n   */\n  constructor(options) {\n\n    super(options);\n\n    const injector = options.injector;\n\n\n    // === PRIVATE properties ===\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.rootScope_ = injector.get('$rootScope');\n\n    /**\n     * The functions to call to unregister the `watch` event on data sources\n     * that are registered. Key is the id of the data source.\n     * @type {!Object.<number, Function>}\n     * @private\n     */\n    this.unregister_ = {};\n  }\n\n  /**\n   * @inheritDoc\n   */\n  addDataSource(dataSource) {\n    super.addDataSource(dataSource);\n    googAsserts.assertInstanceof(dataSource, ngeoDatasourceFile);\n    this.registerDataSource_(dataSource);\n  }\n\n  /**\n   * @param {!ngeo.datasource.File} dataSource File data source to register.\n   * @private\n   */\n  registerDataSource_(dataSource) {\n    this.unregister_[dataSource.id] = this.rootScope_.$watch(\n      () => dataSource.visible,\n      this.handleDataSourceVisibleChange_.bind(this, dataSource)\n    );\n  }\n\n  /**\n   * @param {!ngeo.datasource.File} dataSource File data source.\n   * @param {boolean|undefined} value Current visible property of the DS\n   * @param {boolean|undefined} oldValue Old visible property of the DS\n   * @private\n   */\n  handleDataSourceVisibleChange_(dataSource, value, oldValue) {\n    if (value !== undefined) {\n      dataSource.layer.setVisible(value);\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeDataSource(dataSource) {\n    super.removeDataSource(dataSource);\n    googAsserts.assertInstanceof(dataSource, ngeoDatasourceFile);\n    this.unregisterDataSource_(dataSource);\n  }\n\n  /**\n   * @param {!ngeo.datasource.File} dataSource File data source to unregister.\n   * @private\n   */\n  unregisterDataSource_(dataSource) {\n    this.unregister_[dataSource.id]();\n    delete this.unregister_[dataSource.id];\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.OGCGroup\n */\nimport ngeoDatasourceGroup from 'ngeo/datasource/Group.js';\n\nconst exports = class extends ngeoDatasourceGroup {\n\n  /**\n   * A OGCGroup data source combines multiple `ngeo.datasource.OGC` objects.\n   *\n   * @struct\n   * @param {ngeox.datasource.OGCGroupOptions} options Options.\n   */\n  constructor(options) {\n\n    super(options);\n\n    /**\n     * @type {string}\n     * @private\n     */\n    this.url_ = options.url;\n  }\n\n  /**\n   * @return {string} Url\n   * @export\n   */\n  get url() {\n    return this.url_;\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.WMSGroup\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceOGCGroup from 'ngeo/datasource/OGCGroup.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\nimport * as olArray from 'ol/array.js';\n\nconst exports = class extends ngeoDatasourceOGCGroup {\n\n  /**\n   * A WMSGroup data source combines multiple `ngeo.datasource.OGC` objects\n   * that have the 'WMS' type. Its main goal is to create a single\n   * `ol.layer.Image` object in which the data source visible properties\n   * determine the WMS LAYERS parameter.\n   *\n   * Note: the layer is not added to the map here.\n   *\n   * @struct\n   * @param {ngeox.datasource.WMSGroupOptions} options Options.\n   * @param {!ngeo.map.LayerHelper} ngeoLayerHelper the ngeo map LayerHelper service.\n   */\n  constructor(options, ngeoLayerHelper) {\n\n    super(options);\n\n    const injector = options.injector;\n\n\n    // === PRIVATE properties ===\n\n    /**\n     * @type {ol.layer.Image}\n     * @private\n     */\n    this.layer_;\n\n    /**\n     * @type {!ngeo.map.LayerHelper}\n     * @private\n     */\n    this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.rootScope_ = injector.get('$rootScope');\n\n    /**\n     * The functions to call to unregister the `watch` event on data sources\n     * that are registered. Key is the id of the data source.\n     * @type {!Object.<number, Function>}\n     * @private\n     */\n    this.wmsDataSourceUnregister_ = {};\n\n\n    this.init_();\n  }\n\n  /**\n   * @private\n   */\n  init_() {\n    googAsserts.assert(\n      this.dataSources.length, 'At least one data source is required.');\n\n    for (const dataSource of this.dataSources) {\n      googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n      this.registerDataSource_(dataSource);\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n  destroy() {\n    for (const dataSource of this.dataSources) {\n      googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n      this.unregisterDataSource_(dataSource);\n    }\n    super.destroy();\n  }\n\n\n  // =======================================\n  // === Static property getters/setters ===\n  // =======================================\n\n  /**\n   * @return {ol.layer.Image} layer\n   * @export\n   */\n  get layer() {\n    return this.layer_;\n  }\n\n\n  // =======================\n  // === Utility Methods ===\n  // =======================\n\n  /**\n   * @inheritDoc\n   */\n  addDataSource(dataSource) {\n    super.addDataSource(dataSource);\n    googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n    this.registerDataSource_(dataSource);\n  }\n\n  /**\n   * @param {!ngeo.datasource.OGC} dataSource OGC data source to register.\n   * @private\n   */\n  registerDataSource_(dataSource) {\n\n    const id = dataSource.id;\n\n    this.wmsDataSourceUnregister_[id] = this.rootScope_.$watch(\n      () => dataSource.visible,\n      this.handleDataSourceVisibleChange_.bind(this)\n    );\n\n    if (!this.layer_) {\n      this.layer_ = this.ngeoLayerHelper_.createBasicWMSLayerFromDataSource(\n        dataSource\n      );\n    } else {\n      this.layer_.get('querySourceIds').push(id);\n      this.updateLayer_();\n    }\n  }\n\n  /**\n   * @param {boolean|undefined} value Current visible property of the DS\n   * @param {boolean|undefined} oldValue Old visible property of the DS\n   * @private\n   */\n  handleDataSourceVisibleChange_(value, oldValue) {\n    if (value !== undefined && value !== oldValue) {\n      this.updateLayer_();\n    }\n  }\n\n  /**\n   * @private\n   */\n  updateLayer_() {\n    const layer = this.layer;\n    let layerNames = [];\n\n    // (1) Collect layer names from data sources in the group\n    for (const dataSource of this.dataSources) {\n      googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n      if (dataSource.visible) {\n        layerNames = layerNames.concat(dataSource.getOGCLayerNames());\n      }\n    }\n\n    // (2) Update layer object\n    this.ngeoLayerHelper_.updateWMSLayerState(layer, layerNames.join(','));\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeDataSource(dataSource) {\n    super.removeDataSource(dataSource);\n    googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n    this.unregisterDataSource_(dataSource);\n  }\n\n  /**\n   * @param {!ngeo.datasource.OGC} dataSource OGC data source to unregister.\n   * @private\n   */\n  unregisterDataSource_(dataSource) {\n\n    const id = dataSource.id;\n    const layer = this.layer;\n\n    // Unregister watcher\n    const unregister = this.wmsDataSourceUnregister_[id];\n    unregister();\n    delete this.wmsDataSourceUnregister_[id];\n\n    // Remove DS from the group\n    olArray.remove(this.dataSources, dataSource);\n\n    // Remove query source id\n    const ids = this.ngeoLayerHelper_.getQuerySourceIds(layer);\n    if (ids) {\n      olArray.remove(ids, id);\n    }\n\n    if (this.dataSources.length) {\n      this.updateLayer_();\n    }\n  }\n};\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.ExternalDataSourcesManager\n */\n// TODO - MaxScaleDenominator\n// TODO - MinScaleDenominator\n\nimport gmfBase from 'gmf/index.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMiscFile from 'ngeo/misc/File.js';\nimport ngeoDatasourceDataSources from 'ngeo/datasource/DataSources.js';\nimport ngeoDatasourceFile from 'ngeo/datasource/File.js';\nimport ngeoDatasourceFileGroup from 'ngeo/datasource/FileGroup.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\nimport ngeoDatasourceOGCGroup from 'ngeo/datasource/OGCGroup.js';\nimport ngeoDatasourceWMSGroup from 'ngeo/datasource/WMSGroup.js';\nimport * as olBase from 'ol/index.js';\nimport {isEmpty} from 'ol/extent.js';\nimport * as olEvents from 'ol/events.js';\nimport olCollection from 'ol/Collection.js';\nimport olFormatGPX from 'ol/format/GPX.js';\nimport olFormatKML from 'ol/format/KML.js';\n\nconst exports = class {\n\n  /**\n   * External data sources come remote online resources, such as WMS/WMTS\n   * servers, and also files such as KML/GPX. This service is responsible of\n   * creating, storing and managing them.\n   *\n   * @param {!angularGettext.Catalog} gettextCatalog service.\n   * @param {!angular.$injector} $injector Main injector.\n   * @param {!angular.$q} $q The Angular $q service.\n   * @param {!angular.Scope} $rootScope The rootScope provider.\n   * @param {!ngeo.datasource.DataSources} ngeoDataSources Ngeo data sources service.\n   * @param {!ngeo.misc.File} ngeoFile Ngeo file.\n   * @param {!ngeo.map.LayerHelper} ngeoLayerHelper Ngeo layer helper service\n   * @struct\n   * @ngInject\n   * @ngdoc service\n   * @ngname gmfExternalDataSourcesManager\n   */\n  constructor(gettextCatalog, $injector, $q, $rootScope, ngeoDataSources,\n    ngeoFile, ngeoLayerHelper) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {!angular.$injector}\n     * @private\n     */\n    this.injector_ = $injector;\n\n    /**\n     * @type {!angular.$q}\n     * @private\n     */\n    this.q_ = $q;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.rootScope_ = $rootScope;\n\n    /**\n     * The collection of DataSources from ngeo. When this service creates\n     * a data source, its gets added to that collection.\n     * @type {!ngeox.datasource.DataSources}\n     * @private\n     */\n    this.dataSources_ = ngeoDataSources.collection;\n\n    /**\n     * @type {!ngeo.misc.File}\n     * @private\n     */\n    this.ngeoFile_ = ngeoFile;\n\n    /**\n     * @type {!ngeo.map.LayerHelper}\n     * @private\n     */\n    this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n\n    // === Inner properties ===\n\n    /**\n     * All external data sources that are created are stored here. The key\n     * is the data source id.\n     *\n     * Note: This cache is never cleaned and elements are never removed from it.\n     * If a data source with an id already exists in this cache, it is used\n     * instead of being re-created.\n     *\n     * @type {Object.<number, !ngeo.datasource.OGC|!ngeo.datasource.File>}\n     * @private\n     */\n    this.extDataSources_ = {};\n\n    /**\n     * File external data sources, with the key being the file name.\n     * @type {Object.<string, !ngeo.datasource.File>}\n     * @private\n     */\n    this.files_ = {};\n\n    /**\n     * @type {?ol.Map}\n     * @private\n     */\n    this.map_ = null;\n\n    /**\n     * Group that contains file data sources.\n     * @type {!ngeo.datasource.FileGroup}\n     * @private\n     */\n    this.fileGroup_ = new ngeoDatasourceFileGroup({\n      dataSources: [],\n      injector: this.injector_,\n      title: gettextCatalog.getString('Local files')\n    });\n\n    /**\n     * Collection of WMS groups.\n     * @type {!ol.Collection.<!ngeo.datasource.WMSGroup>}\n     * @private\n     */\n    this.wmsGroupsCollection_ = new olCollection();\n\n    /**\n     * Collection of groups for WMTS data sources.\n     * @type {!ol.Collection.<!ngeo.datasource.OGCGroup>}\n     * @private\n     */\n    this.wmtsGroupsCollection_ = new olCollection();\n\n    /**\n     * Cache that stores the information of a WMTS data source. The key is the\n     * data source id.\n     * @type {!Object.<number, gmfx.datasource.ExternalDataSourcesManagerWMTSCacheItem>}\n     * @private\n     */\n    this.wmtsCache_ = {};\n\n    olEvents.listen(this.dataSources_, 'remove', this.handleDataSourcesRemove_, this);\n  }\n\n\n  // === File Group ===\n\n  /**\n   * @return {!ngeo.datasource.FileGroup} File group.\n   * @export\n   */\n  get fileGroup() {\n    return this.fileGroup_;\n  }\n\n\n  // === WMS Groups ===\n\n  /**\n   * @param {!ngeo.datasource.WMSGroup} wmsGroup WMS group.\n   * @private\n   */\n  addWMSGroup_(wmsGroup) {\n    this.wmsGroupsCollection.push(wmsGroup);\n  }\n\n  /**\n   * @param {!ngeo.datasource.WMSGroup} wmsGroup WMS group.\n   * @private\n   */\n  removeWMSGroup_(wmsGroup) {\n    this.wmsGroupsCollection.remove(wmsGroup);\n  }\n\n  /**\n   * @param {string} url Online resource url\n   * @return {?ngeo.datasource.WMSGroup} WMS group.\n   */\n  getWMSGroup(url) {\n    let found = null;\n    for (const wmsGroup of this.wmsGroups) {\n      if (wmsGroup.url === url) {\n        found = wmsGroup;\n        break;\n      }\n    }\n    return found;\n  }\n\n  /**\n   * @return {!Array.<!ngeo.datasource.WMSGroup>} List of WMS groups.\n   * @export\n   */\n  get wmsGroups() {\n    return this.wmsGroupsCollection_.getArray();\n  }\n\n  /**\n   * @return {!ol.Collection.<!ngeo.datasource.WMSGroup>} Collection of WMS\n   *     groups.\n   * @export\n   */\n  get wmsGroupsCollection() {\n    return this.wmsGroupsCollection_;\n  }\n\n\n  // === WMTS Groups ===\n\n  /**\n   * @param {!ngeo.datasource.OGCGroup} wmtsGroup Group for WMTS data sources.\n   * @private\n   */\n  addWMTSGroup_(wmtsGroup) {\n    this.wmtsGroupsCollection.push(wmtsGroup);\n  }\n\n  /**\n   * @param {!ngeo.datasource.OGCGroup} wmtsGroup Group for WMTS data sources.\n   * @private\n   */\n  removeWMTSGroup_(wmtsGroup) {\n    this.wmtsGroupsCollection.remove(wmtsGroup);\n  }\n\n  /**\n   * @param {string} url Online resource url\n   * @return {?ngeo.datasource.OGCGroup} WMTS group.\n   */\n  getWMTSGroup(url) {\n    let found = null;\n    for (const wmtsGroup of this.wmtsGroups) {\n      if (wmtsGroup.url === url) {\n        found = wmtsGroup;\n        break;\n      }\n    }\n    return found;\n  }\n\n  /**\n   * @return {!Array.<!ngeo.datasource.OGCGroup>} List of groups for WMTS data\n   *     sources.\n   * @export\n   */\n  get wmtsGroups() {\n    return this.wmtsGroupsCollection_.getArray();\n  }\n\n  /**\n   * @return {!ol.Collection.<!ngeo.datasource.OGCGroup>} Collection of groups\n   *     for WMTS data sources.\n   * @export\n   */\n  get wmtsGroupsCollection() {\n    return this.wmtsGroupsCollection_;\n  }\n\n\n  // === Other methods ===\n\n  /**\n   * @param {!ngeo.datasource.DataSource} dataSource Data source\n   * @return {boolean} Whether the given data source is external or not. To\n   *     be considered external, it needs to be in the external data source\n   *     hash (cache).\n   */\n  isExternalDataSource(dataSource) {\n    return !!this.extDataSources_[dataSource.id];\n  }\n\n  /**\n   * @return {ol.layer.Group} Layer group where to push layers created by\n   *     this service.\n   */\n  get layerGroup() {\n    const map = this.map_;\n    googAsserts.assert(map);\n    return this.ngeoLayerHelper_.getGroupFromMap(\n      map,\n      gmfBase.EXTERNALLAYERGROUP_NAME\n    );\n  }\n\n  /**\n   * @param {?ol.Map} map Map\n   */\n  set map(map) {\n    this.map_ = map;\n  }\n\n  /**\n   * @param {ol.layer.Layer} layer Layer.\n   * @private\n   */\n  addLayer_(layer) {\n    this.layerGroup.getLayers().push(layer);\n  }\n\n  /**\n   * @param {ol.layer.Layer} layer Layer.\n   * @private\n   */\n  removeLayer_(layer) {\n    this.layerGroup.getLayers().remove(layer);\n  }\n\n  /**\n   * @param {!Object} layer WMS Capability Layer object.\n   * @param {!Object} capabilities  WMS Capabilities definition\n   * @param {string} url The WMS service url.\n   * @export\n   */\n  createAndAddDataSourceFromWMSCapability(layer, capabilities, url) {\n\n    const id = exports.getId(layer);\n    const service = capabilities['Service'];\n\n    url = service['OnlineResource'] || url;\n\n    let dataSource;\n\n    // (1) Get data source from cache if it exists, otherwise create it\n    if (this.extDataSources_[id]) {\n      dataSource = this.extDataSources_[id];\n    } else {\n      const req = capabilities['Capability']['Request'];\n\n      // ogcImageType\n      const formats = req['GetMap']['Format'];\n      const imagePngType = 'image/png';\n      const ogcImageType = formats.includes(imagePngType) ?\n        imagePngType : formats[0];\n\n      // wmsInfoFormat\n      const infoFormats = req['GetFeatureInfo']['Format'];\n      const wmsInfoFormat = infoFormats.includes(\n        ngeoDatasourceOGC.WMSInfoFormat.GML\n      ) ? ngeoDatasourceOGC.WMSInfoFormat.GML : undefined;\n\n      // queryable\n      const queryable = layer['queryable'] === true &&\n          wmsInfoFormat !== undefined;\n\n      // TODO - MaxScaleDenominator\n      // TODO - MinScaleDenominator\n      dataSource = new ngeoDatasourceOGC({\n        id: id,\n        name: layer['Title'],\n        ogcImageType: ogcImageType,\n        ogcLayers: [{\n          name: layer['Name'],\n          queryable: queryable\n        }],\n        ogcType: ngeoDatasourceOGC.Type.WMS,\n        visible: true,\n        wmsInfoFormat: wmsInfoFormat,\n        wmsUrl: url\n      });\n\n      // Keep a reference to the external data source in the cache\n      this.extDataSources_[id] = dataSource;\n    }\n\n\n    // (2) Add data source in WMS group, unless it's already in there.\n    //     Will also add the data source to the `ngeo.DataSources` collection.\n    //     If the group is created, its inner OL layer is also added to the map.\n    let wmsGroup = this.getWMSGroup(url);\n    if (wmsGroup) {\n      if (!wmsGroup.dataSources.includes(dataSource)) {\n        wmsGroup.addDataSource(dataSource);\n        this.dataSources_.push(dataSource);\n      }\n    } else {\n      wmsGroup = new ngeoDatasourceWMSGroup({\n        dataSources: [dataSource],\n        injector: this.injector_,\n        title: service['Title'],\n        url: url\n      }, this.ngeoLayerHelper_);\n      this.addLayer_(wmsGroup.layer);\n      this.addWMSGroup_(wmsGroup);\n      this.dataSources_.push(dataSource);\n    }\n  }\n\n  /**\n   * @param {!Object} layer WTMS Capability Layer object.\n   * @param {!Object} capabilities  WMTS Capabilities definition\n   * @param {string} wmtsUrl The WMTS capabilities url\n   * @export\n   */\n  createAndAddDataSourceFromWMTSCapability(layer, capabilities, wmtsUrl) {\n    const id = exports.getId(layer);\n\n    // (1) No need to do anything if there's already a WMTS data source (and its\n    // layer in the map)\n    if (this.wmtsCache_[id]) {\n      return;\n    }\n\n    let dataSource;\n\n    // (2) Get data source from cache if it exists, otherwise create it\n    if (this.extDataSources_[id]) {\n      dataSource = this.extDataSources_[id];\n    } else {\n\n      const name = googAsserts.assertString(layer['Title']);\n      const wmtsLayer = googAsserts.assertString(layer['Identifier']);\n\n      // TODO - MaxScaleDenominator\n      // TODO - MinScaleDenominator\n      dataSource = new ngeoDatasourceOGC({\n        id: id,\n        name: name,\n        ogcType: ngeoDatasourceOGC.Type.WMTS,\n        visible: true,\n        wmtsLayer: wmtsLayer,\n        wmtsUrl: wmtsUrl\n      });\n\n      // Keep a reference to the external data source in the cache\n      this.extDataSources_[id] = dataSource;\n    }\n\n    // (3) Get/Create group, then add data source to group\n    let wmtsGroup = this.getWMTSGroup(wmtsUrl);\n    if (!wmtsGroup) {\n      wmtsGroup = new ngeoDatasourceOGCGroup({\n        dataSources: [],\n        title: capabilities['ServiceIdentification']['Title'],\n        url: wmtsUrl\n      });\n      this.addWMTSGroup_(wmtsGroup);\n    }\n    wmtsGroup.addDataSource(dataSource);\n\n    // (4) Create and add the OL layer\n    const layerObj = this.ngeoLayerHelper_.createWMTSLayerFromCapabilititesObj(\n      capabilities,\n      layer\n    );\n    this.addLayer_(layerObj);\n\n    // (5) Add data source to ngeo collection\n    this.dataSources_.push(dataSource);\n\n    // (6) Create and set WMTS cache item\n    this.wmtsCache_[id] = {\n      layerObj: layerObj,\n      // This watcher synchronizes the data source visible property to\n      // the OL layer object visible property\n      unregister: this.rootScope_.$watch(\n        () => dataSource.visible,\n        this.handleWMTSDataSourceVisibleChange_.bind(this, layerObj)\n      )\n    };\n  }\n\n  /**\n   * @param {!File} file File.\n   * @param {function(boolean):*?} opt_callback Callback called with true if the file is loaded and added.\n   *     Otherwise with false.\n   * @export\n   */\n  createAndAddDataSourceFromFile(file, opt_callback) {\n    this.getFileDataSource_(file).then(\n      (dataSource) => {\n        let success = true;\n        const fileGroup = this.fileGroup_;\n\n        // Look if the extent is valid (and so at least one geometry)\n        if (isEmpty(dataSource.extent)) {\n          success = false;\n\n        } else {\n          // (1) No need to do anything if the file has already been added...\n          if (fileGroup.dataSources.includes(dataSource)) {\n            return;\n          }\n\n          // (2) Okay, we need to add this data source. First, add its layer  to the map.\n          this.addLayer_(dataSource.layer);\n\n          // (3) Add it to the file group\n          fileGroup.addDataSource(dataSource);\n\n          // (4) Recenter the map view onto its extent if there is at least one geometry (and so a valid extent)\n          this.map_.getView().fit(dataSource.extent);\n\n          // (5) Finally, add it to the ngeo collection\n          this.dataSources_.push(dataSource);\n        }\n        // Call the callback.\n        if (opt_callback) {\n          opt_callback(success);\n        }\n      },\n      (rejections) => {\n        console.error(`Failed to load file: ${file.name}`);\n        if (opt_callback) {\n          opt_callback(false);\n        }\n      }\n    );\n  }\n\n  /**\n   * Get file data source from cache, else create, store and return a new one.\n   * @param {!File} file File.\n   * @return {!angular.$q.Promise} Promise\n   * @private\n   */\n  getFileDataSource_(file) {\n\n    const defer = this.q_.defer();\n\n    if (this.files_[file.name]) {\n      defer.resolve(this.files_[file.name]);\n    } else {\n      const ngeoFile = this.ngeoFile_;\n      ngeoFile.read(file).then((content) => {\n        let features;\n        const readOptions = {\n          featureProjection: this.map_.getView().getProjection()\n        };\n\n        if (ngeoFile.isKml(content)) {\n          features = new olFormatKML({extractStyles: false}).readFeatures(content, readOptions);\n        } else if (ngeoFile.isGpx(content)) {\n          features = new olFormatGPX().readFeatures(content, readOptions);\n        }\n\n        if (features) {\n          const id = exports.getId(file);\n\n          const dataSource = new ngeoDatasourceFile({\n            features: new olCollection(features),\n            id: id,\n            name: file.name,\n            visible: true\n          });\n\n          // Keep a reference if both caches\n          this.files_[file.name] = dataSource;\n          this.extDataSources_[id] = dataSource;\n\n          defer.resolve(dataSource);\n        } else {\n          defer.reject();\n        }\n      });\n    }\n\n    return defer.promise;\n  }\n\n  /**\n   * @param {!ol.layer.Tile} layer WMTS layer\n   * @param {boolean|undefined} value Current visible property of the DS\n   * @param {boolean|undefined} oldValue Old visible property of the DS\n   * @private\n   */\n  handleWMTSDataSourceVisibleChange_(layer, value, oldValue) {\n    if (value !== undefined && value !== oldValue) {\n      layer.setVisible(value);\n    }\n  }\n\n  /**\n   * Called when a data source is removed from the collection of ngeo data\n   * sources. If it's an external data source, remove it from its WMS Group\n   *\n   * @param {ol.Collection.Event} evt Collection event.\n   * @private\n   */\n  handleDataSourcesRemove_(evt) {\n    const dataSource = evt.element;\n    if (this.extDataSources_[dataSource.id] === dataSource) {\n      if (dataSource instanceof ngeoDatasourceFile) {\n        this.removeFileDataSource_(dataSource);\n      } else if (dataSource instanceof ngeoDatasourceOGC) {\n        this.removeOGCDataSource_(dataSource);\n      }\n    }\n  }\n\n  /**\n   * Remove a data source from its group. Remove its layer from the map as well.\n   *\n   * Note: it is expected that the data source has already been removed\n   * from the ngeo collection.\n   *\n   * @param {!ngeo.datasource.File} dataSource External File data source.\n   * @private\n   */\n  removeFileDataSource_(dataSource) {\n    this.removeLayer_(dataSource.layer);\n    this.fileGroup_.removeDataSource(dataSource);\n  }\n\n  /**\n   * Remove the data source from its group. If the group no longer has\n   * any data source in it, it is removed then destroyed and its layer is\n   * removed from the map.\n   *\n   * Note: it is expected that the data source has already been removed\n   * from the ngeo collection.\n   *\n   * @param {!ngeo.datasource.OGC} dataSource External OGC data source.\n   * @private\n   */\n  removeOGCDataSource_(dataSource) {\n    if (dataSource.ogcType === ngeoDatasourceOGC.Type.WMS) {\n      // WMS data source\n      const url = dataSource.wmsUrl;\n      googAsserts.assert(url);\n\n      const wmsGroup = this.getWMSGroup(url);\n      if (wmsGroup && wmsGroup.dataSources.includes(dataSource)) {\n        // Remove from group\n        wmsGroup.removeDataSource(dataSource);\n\n        // In case we removed the last data source from the group, then remove\n        // and destroy the group, and remove the layer from the map as well.\n        if (!wmsGroup.dataSources.length) {\n          this.removeLayer_(wmsGroup.layer);\n          wmsGroup.destroy();\n          this.removeWMSGroup_(wmsGroup);\n        }\n      }\n    } else if (dataSource.ogcType === ngeoDatasourceOGC.Type.WMTS) {\n      // WMTS data source\n      const url = dataSource.wmtsUrl;\n      googAsserts.assert(url);\n\n      const wmtsGroup = this.getWMTSGroup(url);\n      if (wmtsGroup && wmtsGroup.dataSources.includes(dataSource)) {\n        // Remove from group\n        wmtsGroup.removeDataSource(dataSource);\n\n        // Remove the cache item, in addition to removing the layer from the\n        // map and unregister the watcher\n        const id = dataSource.id;\n        this.removeLayer_(this.wmtsCache_[id].layerObj);\n        this.wmtsCache_[id].unregister();\n        delete this.wmtsCache_[id];\n\n        // In case we removed the last data source from the group, then remove\n        // and destroy the groug.\n        if (!wmtsGroup.dataSources.length) {\n          wmtsGroup.destroy();\n          this.removeWMTSGroup_(wmtsGroup);\n        }\n      }\n    }\n  }\n};\n\n\n/**\n * Get the data source id from a WMS or WMTS Capability Layer object, or\n * from a File object.\n *\n * Please, note that this is used to generate a unique id for the created\n * external data sources and since a WMS/WMTS Capability Layer objects don't\n * natively contains an id by themselves, then it is programmatically generated\n * using the `ol.getUid` method, plus a million.\n *\n * @param {!Object} layer WMS/WMTS Capability Layer object.\n * @return {number} Data source id.\n * @export\n */\nexports.getId = function(layer) {\n  return olBase.getUid(layer) + 1000000;\n};\n\n\nexports.module = angular.module('gmfExternalDataSourcesManager', [\n  ngeoMapLayerHelper.module.name,\n  ngeoMiscFile.module.name,\n  ngeoDatasourceDataSources.module.name,\n]);\nexports.module.service('gmfExternalDataSourcesManager',\n  exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.btnComponent\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoBtnComponent', []);\n\n\n/**\n * Provides two directives: ngeo-btn-group and ngeo-btn.\n *\n * The ngeo-btn-group directive allows creating \"toggle\" groups. It works with\n * the ngeo-btn directive.\n *\n * Example:\n *\n *     <div ngeo-btn-group>\n *       <button ngeo-btn class=\"btn\" ng-model=\"ctrl.drawPoint.active\"></button>\n *       <button ngeo-btn class=\"btn\" ng-model=\"ctrl.drawLine.active\"></button>\n *     </div>\n *\n * In that example the ngeo-btn are combined together in a \"toggle group\",\n * where activating a button will deactivate the others.\n *\n * One can use `ng-model` directive at the group level in order to know if\n * a button is active.\n *\n * Example:\n *\n *     <div ngeo-btn-group ngeo-btn-group-active=\"ctrl.drawToolActive\">\n *\n * See our live example: [../examples/interactionbtngroup.html](../examples/interactionbtngroup.html)\n *\n * @htmlAttribute {*} ngeo-btn-group-active Any property of the scope.\n * Tells whether at least one button of the group is active.\n * @param {angular.$parse} $parse Angular parse service.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoBtnGroup\n */\nexports.btnGroupComponent_ = function($parse) {\n  return {\n    restrict: 'A',\n    controller: 'ngeoBtnGroupController',\n    /**\n     * @param {!angular.Scope} scope Scope.\n     * @param {!angular.JQLite=} element Element.\n     * @param {!angular.Attributes=} attrs Attributes.\n     * @param {!ngeo.misc.btnComponent.BtnGroupController=} controller Controller.\n     */\n    link: (scope, element, attrs, controller) => {\n      const setActive = $parse(attrs['ngeoBtnGroupActive']).assign;\n\n      if (setActive) {\n        scope.$watch(\n          // return true if at least one button is active otherwise false\n          () => controller.buttons_.some(buttonModel => buttonModel(scope) === true),\n          (newValue) => {\n            setActive(scope, newValue);\n          }\n        );\n      }\n    }\n  };\n};\n\n\nexports.directive('ngeoBtnGroup', exports.btnGroupComponent_);\n\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @constructor\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoBtnGroupController\n */\nexports.BtnGroupController = function($scope) {\n  /**\n   * @type {!Array.<!angular.parse.Expression>}\n   * @private\n   */\n  this.buttons_ = [];\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n};\n\n\n/**\n * @param {number} index Index of the button in buttons array.\n */\nexports.BtnGroupController.prototype.activate = function(index) {\n  this.buttons_.forEach((expressionFn, i) => {\n    if (i != index) {\n      expressionFn.assign(this.scope_, false);\n    }\n  });\n};\n\n\n/**\n * @param {angular.parse.Expression} expressionFn Expression function.\n * @return {number} Index of the pushed setter.\n */\nexports.BtnGroupController.prototype.addButton = function(expressionFn) {\n  this.buttons_.push(expressionFn);\n  return this.buttons_.length - 1;\n};\n\n\nexports.controller('ngeoBtnGroupController',\n  exports.BtnGroupController);\n\n\n/**\n * The ngeo-btn allows creating toggle buttons working with ng-model. It is\n * typically used with Bootstrap buttons (`btn`).\n *\n * Example:\n *\n *     <button ngeo-btn class=\"btn\" ng-model=\"ctrl.interaction.active\"></button>\n *\n * This example is about creating a Bootstrap button that can pressed/depressed\n * to activate/deactivate an OpenLayers interaction.\n *\n * @htmlAttribute {*} ng-model Any property on the scope. Ideally a boolean.\n * @param {angular.$parse} $parse Angular parse service.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoBtn\n */\nexports.btnComponent_ = function($parse) {\n  return {\n    require: ['?^ngeoBtnGroup', 'ngModel'],\n    restrict: 'A',\n    /**\n     * @param {!angular.Scope} scope Scope.\n     * @param {!angular.JQLite=} element Element.\n     * @param {!angular.Attributes=} attrs Attributes.\n     * @param {!Array.<!Object>=} ctrls Controller.\n     */\n    link: (scope, element, attrs, ctrls) => {\n      const buttonsCtrl = ctrls[0];\n      const ngModelCtrl = ctrls[1];\n      let indexInGroup = -1;\n\n      const ngModelGet = $parse(attrs['ngModel']);\n      const ngModelSet = ngModelGet.assign;\n\n      // Set ng-model value to false if undefined\n      if (ngModelGet(scope) === undefined) {\n        ngModelSet(scope, false);\n      }\n      if (buttonsCtrl !== null) {\n        indexInGroup = buttonsCtrl.addButton(ngModelGet);\n      }\n\n      // UI -> model\n      element.on('click', () => {\n        scope.$apply(() => {\n          ngModelCtrl.$setViewValue(!ngModelCtrl.$viewValue);\n          ngModelCtrl.$render();\n        });\n      });\n\n      // model -> UI\n      ngModelCtrl.$render = function() {\n        if (ngModelCtrl.$viewValue && buttonsCtrl !== null) {\n          buttonsCtrl.activate(indexInGroup);\n        }\n        element.toggleClass('active', ngModelCtrl.$viewValue);\n      };\n    }\n  };\n};\n\n\nexports.directive('ngeoBtn', exports.btnComponent_);\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.DataSources\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceDataSource from 'ngeo/datasource/DataSource.js';\nimport olCollection from 'ol/Collection.js';\nimport * as olEvents from 'ol/events.js';\nimport olView from 'ol/View.js';\n\nconst exports = class {\n\n  /**\n   * This service is responsible of the synchronization between the ngeo\n   * collection of data sources and a specific map. It listens to events\n   * that come directly or indirectly from the map and update the inner\n   * properties of the data sources.\n   *\n   * The following data sources properties are synchronized here:\n   *\n   * - inRange: The map view 'change:resolution' event is listened and the\n   *   property is updated depending on the current resolution.\n   *\n   * @struct\n   * @ngdoc service\n   * @ngname ngeoDataSources\n   * @ngInject\n   */\n  constructor() {\n\n    /**\n     * @type {ngeox.datasource.DataSources}\n     * @private\n     */\n    this.collection_ = new olCollection();\n\n    /**\n     * @type {ol.Map}\n     * @private\n     */\n    this.map_ = null;\n\n    /**\n     * @type {!Array.<!ol.EventsKey>}\n     * @private\n     */\n    this.listenerKeys_ = [];\n\n    olEvents.listen(this.collection_, 'add', this.handleDataSourcesAdd_, this);\n  }\n\n  /**\n   * Set a map to this service. Null can be given to unset the map.\n   * @param {?ol.Map} map Map.\n   */\n  set map(map) {\n    if (this.map_ === map) {\n      return;\n    }\n\n    if (this.map_) {\n      this.unbindMap_(this.map_);\n    }\n\n    this.map_ = map;\n\n    if (map) {\n      this.bindMap_(map);\n    }\n  }\n\n  get collection() {\n    return this.collection_;\n  }\n\n  /**\n   * Bind a map to this service.\n   * @param {ol.Map} map Map.\n   * @private\n   */\n  bindMap_(map) {\n\n    // (1) Event listeners\n    const view = map.getView();\n    this.listenerKeys_.push(\n      olEvents.listen(view, 'change:resolution', this.handleViewResolutionChange_, this)\n    );\n\n    // (2) Sync resolution with existing data sources\n    const resolution = view.getResolution();\n    googAsserts.assertNumber(resolution);\n    this.syncDataSourcesToResolution_(resolution);\n  }\n\n  /**\n   * Unbind a map to this service.\n   * @param {ol.Map} map Map.\n   * @private\n   */\n  unbindMap_(map) {\n    this.listenerKeys_.forEach(olEvents.unlistenByKey);\n    this.listenerKeys_ = [];\n  }\n\n  /**\n   * Called when the resolution of the map view changes. Synchronize the\n   * datasources to current resolution of the view.\n   * @param {Event} evt Event.\n   * @private\n   */\n  handleViewResolutionChange_(evt) {\n    const view = evt.target;\n    googAsserts.assertInstanceof(view, olView);\n    const resolution = view.getResolution();\n    googAsserts.assertNumber(resolution);\n    this.syncDataSourcesToResolution_(resolution);\n  }\n\n  /**\n   * Synchronize all datasources in the ngeo collection with a given resolution.\n   * @param {number} resolution Resolution\n   * @private\n   */\n  syncDataSourcesToResolution_(resolution) {\n    this.collection_.forEach((dataSource) => {\n      this.syncDataSourceToResolution_(dataSource, resolution);\n    });\n  }\n\n  /**\n   * Synchronize a data source `inRange` property with a given resolution.\n   * @param {ngeo.datasource.DataSource} dataSource Data source\n   * @param {number} resolution Resolution\n   * @private\n   */\n  syncDataSourceToResolution_(dataSource, resolution) {\n    // No need to do anything if the data source doesn't support dynamic\n    // setting of inRange\n    if (!dataSource.supportsDynamicInRange) {\n      return;\n    }\n\n    const maxResolution = dataSource.maxResolution;\n    const minResolution = dataSource.minResolution;\n\n    const inMinRange = minResolution === null ||\n        minResolution === undefined ||\n        resolution >= minResolution;\n    const inMaxRange = maxResolution === null ||\n        maxResolution === undefined ||\n        resolution <= maxResolution;\n    const inRange = inMinRange && inMaxRange;\n\n    dataSource.inRange = inRange;\n  }\n\n  /**\n   * Called when a new data source is added to the ngeo collection. If there's\n   * map bound, update its `inRange` right away.\n   * @param {!ol.Collection.Event} event Event\n   * @private\n   */\n  handleDataSourcesAdd_(event) {\n    const dataSource = googAsserts.assertInstanceof(\n      event.element, ngeoDatasourceDataSource);\n    if (this.map_) {\n      const resolution = this.map_.getView().getResolution();\n      googAsserts.assertNumber(resolution);\n      this.syncDataSourceToResolution_(dataSource, resolution);\n    }\n  }\n\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoDataSources', []);\n// DataSources with the ngeox.datasource.DataSources type.\nexports.module.service('ngeoDataSources', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.editing.editFeatureComponent\n */\nimport gmfEditingEditFeature from 'gmf/editing/EditFeature.js';\n\n/** @suppress {extraRequire} */\nimport gmfEditingSnapping from 'gmf/editing/Snapping.js';\n\nimport gmfEditingXSDAttributes from 'gmf/editing/XSDAttributes.js';\nimport gmfLayertreeSyncLayertreeMap from 'gmf/layertree/SyncLayertreeMap.js';\nimport googAsserts from 'goog/asserts.js';\nimport DateFormatter from 'ngeo/misc/php-date-formatter.js';\nimport 'jquery-datetimepicker/jquery.datetimepicker.js';\nimport 'jquery-datetimepicker/jquery.datetimepicker.css';\n\n\n/** @suppress {extraRequire} */\nimport ngeoEditingAttributesComponent from 'ngeo/editing/attributesComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoEditingCreatefeatureComponent from 'ngeo/editing/createfeatureComponent.js';\n\nimport ngeoUtils from 'ngeo/utils.js';\nimport ngeoFormatXSDAttribute from 'ngeo/format/XSDAttribute.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionRotate from 'ngeo/interaction/Rotate.js';\nimport ngeoInteractionTranslate from 'ngeo/interaction/Translate.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMenu from 'ngeo/Menu.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessageModalComponent from 'ngeo/message/modalComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscBtnComponent from 'ngeo/misc/btnComponent.js';\n\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\n\nimport * as olBase from 'ol/index.js';\nimport * as olArray from 'ol/array.js';\nimport olCollection from 'ol/Collection.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olExtent from 'ol/extent.js';\nimport olFeature from 'ol/Feature.js';\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport olInteractionModify from 'ol/interaction/Modify.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('GmfEditingFeatureComponent', [\n  gmfEditingEditFeature.module.name,\n  gmfEditingSnapping.module.name,\n  gmfEditingXSDAttributes.module.name,\n  ngeoEditingAttributesComponent.name,\n  ngeoEditingCreatefeatureComponent.name,\n  ngeoMapLayerHelper.module.name,\n  ngeoMessageModalComponent.name,\n  ngeoMiscBtnComponent.name,\n  ngeoMiscEventHelper.module.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscToolActivateMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/editing/editFeatureComponent', require('./editFeatureComponent.html'));\n});\n\n\n/**\n * Directive used to insert, modify and delete features from a single layer.\n * It allows you to modify the geometry of the feature in addition to its\n * attributes.\n *\n * In order to modify or delete a feature, you must click on the map at the\n * location of the feature to select it first.\n *\n * In order to create a new feature, you use the \"Draw\" button and digitize\n * the feature on the map.\n *\n * Example:\n *\n *     <gmf-editfeature\n *         gmf-editfeature-dirty=\"ctrl.dirty\"\n *         gmf-editfeature-editabletreectrl=\"::ctrl.treeCtrl\"\n *         gmf-editfeature-map=\"::ctrl.map\"\n *         gmf-editfeature-state=\"efsCtrl.state\"\n *         gmf-editfeature-tolerance=\"::ctrl.tolerance\"\n *         gmf-editfeature-vector=\"::ctrl.vectorLayer\">\n *         gmf-editfeature-closeaftersave=\"::ctrl.closeaftersave\">\n *     </gmf-editfeature>\n *\n * @htmlAttribute {boolean} gmf-editfeature-dirty Flag that is toggled as soon\n *     as the feature changes, i.e. if any of its properties change, which\n *     includes the geometry.\n * @htmlAttribute {ngeo.layertree.Controller} gmf-editfeature-editabletreectrl\n *     A reference to the editable Layertree controller, which contains a\n *     a reference to the node and WMS layer.\n * @htmlAttribute {ol.Map} gmf-editfeature-map The map.\n * @htmlAttribute {string} gmf-editfeature-state The state property shared\n *     with the `gmf-editfeatureselector` directive. For more info, see in\n *     that directive.\n * @htmlAttribute {number|undefined} gmf-editfeatureselector-tolerance The\n *     buffer in pixels to use when making queries to get the features.\n * @htmlAttribute {ol.layer.Vector} gmf-editfeature-vector The vector layer in\n *     which to draw the vector features.\n * @htmlAttribute {boolean} gmf-editfeatureselector-closeaftersave If true,\n *     immediately return to the main edit panel after save. Default is false.\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname gmfEditfeature\n */\nexports.component_ = function() {\n  return {\n    controller: 'GmfEditfeatureController as efCtrl',\n    scope: {\n      'dirty': '=gmfEditfeatureDirty',\n      'editableTreeCtrl': '=gmfEditfeatureEditabletreectrl',\n      'map': '<gmfEditfeatureMap',\n      'state': '=gmfEditfeatureState',\n      'tolerance': '<?gmfEditfeatureTolerance',\n      'vectorLayer': '<gmfEditfeatureVector',\n      'closeAfterSave': '=?gmfEditfeatureCloseaftersave'\n    },\n    bindToController: true,\n    templateUrl: 'gmf/editing/editFeatureComponent'\n  };\n};\n\n\nexports.directive('gmfEditfeature',\n  exports.component_);\n\n\n/**\n * @param {jQuery} $element Element.\n * @param {angular.$q} $q Angular $q service.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {gmf.editing.EditFeature} gmfEditFeature Gmf edit feature service.\n * @param {gmf.editing.Snapping} gmfSnapping The gmf snapping service.\n * @param {gmf.editing.XSDAttributes} gmfXSDAttributes The gmf XSDAttributes service.\n * @param {ngeo.misc.EventHelper} ngeoEventHelper Ngeo Event Helper.\n * @param {ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {ngeo.misc.ToolActivateMgr} ngeoToolActivateMgr Ngeo ToolActivate manager\n *     service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfEditfeatureController\n */\nexports.Controller_ = function($element, $q, $scope, $timeout,\n  gettextCatalog, gmfEditFeature, gmfSnapping, gmfXSDAttributes,\n  ngeoEventHelper, ngeoFeatureHelper, ngeoLayerHelper, ngeoToolActivateMgr) {\n\n\n  // === Binding properties ===\n\n  /**\n   * Flag that is toggled as soon as the feature changes, i.e. if any of its\n   * properties change, which includes the geometry.\n   * @type {boolean}\n   * @export\n   */\n  this.dirty;\n\n  /**\n   * @type {ngeo.layertree.Controller}\n   * @export\n   */\n  this.editableTreeCtrl;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * The state property shared with the `gmf-editfeatureselector` directive.\n   * For more info, see in that directive.\n   * @type {string}\n   * @export\n   */\n  this.state;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.tolerance;\n\n  /**\n   * @type {ol.layer.Vector}\n   * @export\n   */\n  this.vectorLayer;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.closeAfterSave = false;\n\n  // === Injected properties ===\n\n  /**\n   * @type {jQuery}\n   * @private\n   */\n  this.element_ = $element;\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.q_ = $q;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {gmf.editing.EditFeature}\n   * @private\n   */\n  this.gmfEditFeature_ = gmfEditFeature;\n\n  /**\n   * @type {gmf.editing.Snapping}\n   * @private\n   */\n  this.gmfSnapping_ = gmfSnapping;\n\n  /**\n   * @type {gmf.editing.XSDAttributes}\n   * @private\n   */\n  this.gmfXSDAttributes_ = gmfXSDAttributes;\n\n  /**\n   * @type {ngeo.misc.EventHelper}\n   * @private\n   */\n  this.ngeoEventHelper_ = ngeoEventHelper;\n\n  /**\n   * @type {ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.ngeoFeatureHelper_ = ngeoFeatureHelper;\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {ngeo.misc.ToolActivateMgr}\n   * @private\n   */\n  this.ngeoToolActivateMgr_ = ngeoToolActivateMgr;\n\n\n  // === Private properties ===\n\n  /**\n   * @type {gmfThemes.GmfLayer}\n   * @private\n   */\n  this.editableNode_;\n\n  /**\n   * @type {ol.layer.Image|ol.layer.Tile}\n   * @private\n   */\n  this.editableWMSLayer_;\n\n  /**\n   * A deferred object resolved after the confirm modal \"continue w/o saving\" or\n   * \"save\" buttons are clicked.\n   * @type {angular.$q.Deferred|null}\n   * @private\n   */\n  this.confirmDeferred_ = null;\n\n  /**\n   * Flag that controls the visibility of the modal that manages unsaved\n   * modifications.\n   * @type {boolean}\n   * @export\n   */\n  this.unsavedModificationsModalShown = false;\n\n  /**\n   * Flag that is toggled while a request is pending, either one to get\n   * features when a map is clicked or when saving\n   * @private\n   */\n  this.pending = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active = true;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.createActive = false;\n\n  /**\n   * @type {ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.createToolActivate = new ngeoMiscToolActivate(this, 'createActive');\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.mapSelectActive = true;\n\n  /**\n   * @type {ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.mapSelectToolActivate = new ngeoMiscToolActivate(this, 'mapSelectActive');\n\n  /**\n   * @type {?ol.Feature}\n   * @export\n   */\n  this.feature = null;\n\n  this.scope_.$watch(\n    () => this.feature,\n    this.handleFeatureChange_.bind(this)\n  );\n\n  /**\n   * @type {number|string|undefined}\n   * @export\n   */\n  this.featureId = undefined;\n\n  /**\n   * @type {ol.Collection}\n   * @export\n   */\n  this.features;\n\n  /**\n   * @type {ol.Collection}\n   * @private\n   */\n  this.interactions_ = new olCollection();\n\n  /**\n   * @type {ol.interaction.Modify}\n   * @private\n   */\n  this.modify_;\n\n  /**\n   * @type {ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.modifyToolActivate;\n\n  /**\n   * @type {ngeo.Menu}\n   * @private\n   */\n  this.menu_ = new ngeoMenu({\n    actions: [{\n      cls: 'fa fa-arrows',\n      label: gettextCatalog.getString('Move'),\n      name: 'move'\n    }, {\n      cls: 'fa fa-rotate-right',\n      label: gettextCatalog.getString('Rotate'),\n      name: 'rotate'\n    }]\n  });\n\n  /**\n   * @type {ngeo.interaction.Translate}\n   * @private\n   */\n  this.translate_;\n\n  /**\n   * @type {ngeo.interaction.Rotate}\n   * @private\n   */\n  this.rotate_;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.rotateToolActivate;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.translateToolActivate;\n\n  /**\n   * @type {!Array.<!ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {?Array.<!ngeox.Attribute>}\n   * @export\n   */\n  this.attributes = null;\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.geomType;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.showServerError = false;\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.serverErrorMessage = null;\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.serverErrorType = null;\n};\n\n\n/**\n * Called on initialization of the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  const lang = this.gettextCatalog_.getCurrentLanguage();\n  $.datetimepicker.setLocale(lang);\n  $.datetimepicker.setDateFormatter(new DateFormatter());\n\n  // (1) Set default values and other properties\n  this.dirty = this.dirty === true;\n  this.editableNode_ = /** @type {gmfThemes.GmfLayer} */ (\n    this.editableTreeCtrl.node);\n  this.features = this.vectorLayer.getSource().getFeaturesCollection();\n  this.tolerance = this.tolerance !== undefined ? this.tolerance : 10;\n\n  // (1.1) Set editable WMS layer\n  const layer = gmfLayertreeSyncLayertreeMap.getLayer(this.editableTreeCtrl);\n  googAsserts.assert(\n    layer instanceof olLayerImage || layer instanceof olLayerTile);\n  this.editableWMSLayer_ = layer;\n\n  // (1.2) Create, set and initialize interactions\n  this.modify_ = new olInteractionModify({\n    deleteCondition: ngeoUtils.deleteCondition,\n    features: this.features,\n    style: this.ngeoFeatureHelper_.getVertexStyle(false)\n  });\n  this.interactions_.push(this.modify_);\n\n  this.rotate_ = new ngeoInteractionRotate({\n    features: this.features,\n    style: new olStyleStyle({\n      text: new olStyleText({\n        text: '\\uf01e',\n        font: 'normal 18px FontAwesome',\n        fill: new olStyleFill({\n          color: '#7a7a7a'\n        })\n      })\n    })\n  });\n  this.interactions_.push(this.rotate_);\n\n  this.translate_ = new ngeoInteractionTranslate({\n    features: this.features,\n    style: new olStyleStyle({\n      text: new olStyleText({\n        text: '\\uf047',\n        font: 'normal 18px FontAwesome',\n        fill: new olStyleFill({\n          color: '#7a7a7a'\n        })\n      })\n    })\n  });\n  this.interactions_.push(this.translate_);\n\n  this.initializeInteractions_();\n\n  this.modifyToolActivate = new ngeoMiscToolActivate(this.modify_, 'active');\n  this.rotateToolActivate = new ngeoMiscToolActivate(this.rotate_, 'active');\n  this.translateToolActivate = new ngeoMiscToolActivate(this.translate_, 'active');\n\n  // (1.3) Add menu to map\n  this.map.addOverlay(this.menu_);\n\n\n  // (2) Watchers and event listeners\n  this.scope_.$watch(\n    () => this.createActive,\n    (newVal, oldVal) => {\n      if (newVal) {\n        this.gmfSnapping_.ensureSnapInteractionsOnTop();\n      }\n    }\n  );\n\n  this.scope_.$on('$destroy', this.handleDestroy_.bind(this));\n\n  const uid = olBase.getUid(this);\n  this.ngeoEventHelper_.addListenerKey(\n    uid,\n    olEvents.listen(\n      this.features,\n      'add',\n      this.handleFeatureAdd_,\n      this\n    )\n  );\n\n  this.scope_.$watch(\n    () => this.mapSelectActive,\n    this.handleMapSelectActiveChange_.bind(this)\n  );\n\n  this.scope_.$watch(\n    () => this.state,\n    (newValue, oldValue) => {\n      const state = exports.State;\n      if (newValue === state.STOP_EDITING_PENDING) {\n        this.confirmCancel().then(() => {\n          this.state = state.STOP_EDITING_EXECUTE;\n        });\n      } else if (newValue === state.DEACTIVATE_PENDING) {\n        this.confirmCancel().then(() => {\n          this.state = state.DEACTIVATE_EXECUTE;\n        });\n      }\n    }\n  );\n\n  this.scope_.$watch(\n    () => this.unsavedModificationsModalShown,\n    (newValue, oldValue) => {\n      // Reset stop request when closing the confirmation modal\n      if (oldValue && !newValue) {\n        this.state = exports.State.IDLE;\n      }\n    }\n  );\n\n\n  // (3) Get attributes\n  this.gmfXSDAttributes_.getAttributes(this.editableNode_.id).then(\n    this.setAttributes_.bind(this));\n\n\n  // (4) Toggle\n  this.toggle_(true);\n\n};\n\n\n/**\n * Save the currently selected feature modifications.\n * @export\n */\nexports.Controller_.prototype.save = function() {\n  googAsserts.assert(this.attributes);\n\n  const feature = this.feature.clone();\n  feature.setId(this.feature.getId());\n  const id = this.featureId;\n\n  this.pending = true;\n\n  const dateFormatter = new DateFormatter();\n  for (const attribute of this.attributes) {\n    if (attribute.format) {\n      if (this.feature.get(attribute.name)) {\n        const name = this.feature.get(attribute.name);\n        googAsserts.assertString(name);\n        const value = dateFormatter.parseDate(name, attribute.format);\n        let jsonFormat = 'Y-m-d\\\\TH:i:s';\n        if (attribute.type === 'date') {\n          jsonFormat = 'Y-m-d';\n        } else if (attribute.type === 'time') {\n          jsonFormat = 'H:i:s';\n        } else if (attribute.type === 'datetime') {\n          // Time zone correction\n          value.setMinutes(value.getMinutes() + value.getTimezoneOffset());\n        }\n        feature.set(attribute.name, dateFormatter.formatDate(value, jsonFormat));\n      } else {\n        // Shouldn't be set to an empty string\n        feature.set(attribute.name, null);\n      }\n    }\n  }\n\n  const promise = id ?\n    this.gmfEditFeature_.updateFeature(\n      this.editableNode_.id,\n      feature\n    ) :\n    this.gmfEditFeature_.insertFeatures(\n      this.editableNode_.id,\n      [feature]\n    );\n  promise.then(\n    (response) => {\n      this.dirty = false;\n      this.pending = false;\n      this.handleEditFeature_(response);\n      this.gmfSnapping_.refresh();\n      if (this.closeAfterSave) {\n        this.cancel();\n      }\n    },\n    (response) => {\n      this.showServerError = true;\n      this.pending = false;\n      this.serverErrorType =  `error type : ${response.data['error_type']}`;\n      this.serverErrorMessage = `error message : ${response.data['message']}`;\n    }\n  );\n};\n\n\n/**\n * @export\n */\nexports.Controller_.prototype.cancel = function() {\n  this.dirty = false;\n  this.feature = null;\n  this.features.clear();\n  this.menu_.close();\n  this.unsavedModificationsModalShown = false;\n};\n\n\n/**\n * Check if there are unsaved modifications. If there aren't, then cancel.\n * Used by the 'cancel' button in the template.\n * @return {angular.$q.Promise} The promise attached to the confirm deferred\n *     object.\n * @export\n */\nexports.Controller_.prototype.confirmCancel = function() {\n  return this.checkForModifications_().then(() => {\n    this.cancel();\n  });\n};\n\n\n/**\n * Check if there's a feature selected and if it contains modifications\n * (a.k.a. is dirty), then the confirmation modal is shown.\n * @param {boolean=} scopeApply Whether to force scope to refresh or not.\n *     when the confirm modal is not dismissed.\n * @return {angular.$q.Promise} The promise attached to the confirm deferred\n *     object.\n * @private\n */\nexports.Controller_.prototype.checkForModifications_ = function(\n  scopeApply) {\n  this.confirmDeferred_ = this.q_.defer();\n  if (this.feature && this.dirty) {\n    this.unsavedModificationsModalShown = true;\n    if (scopeApply) {\n      this.scope_.$apply();\n    }\n  } else {\n    this.confirmDeferred_.resolve();\n  }\n\n  return this.confirmDeferred_.promise;\n};\n\n\n/**\n * @export\n */\nexports.Controller_.prototype.continueWithoutSaving = function() {\n  this.cancel();\n  this.confirmDeferred_.resolve();\n};\n\n\n/**\n * @export\n */\nexports.Controller_.prototype.delete = function() {\n  const msg = this.gettextCatalog_.getString(\n    'Do you really want to delete the selected feature?');\n  // Confirm deletion first\n  if (confirm(msg)) {\n    this.pending = true;\n\n    // (1) Launch request\n    this.gmfEditFeature_.deleteFeature(\n      this.editableNode_.id,\n      this.feature\n    ).then(\n      (response) => {\n        this.dirty = false;\n        this.pending = false;\n        this.ngeoLayerHelper_.refreshWMSLayer(this.editableWMSLayer_);\n\n        // (2) Reset selected feature\n        this.cancel();\n      },\n      (response) => {\n        this.showServerError = true;\n        this.pending = false;\n        this.serverErrorType =  `error type : ${response.data['error_type']}`;\n        this.serverErrorMessage = `error message : ${response.data['message']}`;\n      }\n    );\n\n  }\n};\n\n\n/**\n * Called when the modal 'save' button is clicked. Do as if the user had\n * clicked on the 'save' input button in the form, which allows the form\n * to be validated.\n * @export\n */\nexports.Controller_.prototype.submit = function() {\n  // Use timeout to prevent the digest already in progress\n  // due to clicking on the modal button to throw an error.\n  this.timeout_(() => {\n    this.element_.find('input[type=\"submit\"]').click();\n  }, 0);\n};\n\n/**\n * Called after an insert, update or delete request.\n * @param {angular.$http.Response} resp Ajax response.\n * @private\n */\nexports.Controller_.prototype.handleEditFeature_ = function(resp) {\n  const features = new olFormatGeoJSON().readFeatures(resp.data);\n  if (features.length) {\n    this.feature.setId(features[0].getId());\n    this.ngeoLayerHelper_.refreshWMSLayer(this.editableWMSLayer_);\n  }\n  if (this.confirmDeferred_) {\n    this.confirmDeferred_.resolve();\n  }\n};\n\n\n/**\n * @param {!Array.<ngeox.Attribute>} attributes Attributes.\n * @private\n */\nexports.Controller_.prototype.setAttributes_ = function(attributes) {\n  // Set attributes\n  this.attributes = attributes;\n  for (const attribute of attributes) {\n    if (attribute.type == 'date') {\n      attribute.format = 'Y-m-d';\n      attribute.mask = '9999-19-39';\n    } else if (attribute.type == 'time') {\n      attribute.format = 'H:i';\n      attribute.mask = '29:59';\n    } else if (attribute.type == 'datetime') {\n      attribute.format = 'Y-m-d H:i';\n      attribute.mask = '9999-19-39 29:59';\n    }\n  }\n\n  // Get geom type from attributes and set\n  const geomAttr = ngeoFormatXSDAttribute.getGeometryAttribute(\n    this.attributes\n  );\n  if (geomAttr && geomAttr.geomType) {\n    this.geomType = geomAttr.geomType;\n  }\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleFeatureAdd_ = function(evt) {\n  this.feature = null;\n  this.timeout_(() => {\n    googAsserts.assert(this.attributes);\n    const feature = evt.element;\n    googAsserts.assertInstanceof(feature, olFeature);\n    const dateFormatter = new DateFormatter();\n    for (const attribute of this.attributes) {\n      if (attribute.format) {\n        if (feature.get(attribute.name)) {\n          let value;\n          if (attribute.type === 'datetime') {\n            value = new Date(feature.get(attribute.name));\n            // Time zone correction\n            value.setMinutes(value.getMinutes() - value.getTimezoneOffset());\n          } else {\n            let jsonFormat = '';\n            if (attribute.type === 'date') {\n              jsonFormat = 'Y-m-d';\n            } else if (attribute.type === 'time') {\n              jsonFormat = 'H:i:s';\n            }\n            const name = feature.get(attribute.name);\n            googAsserts.assertString(name);\n            value = dateFormatter.parseDate(name, jsonFormat);\n          }\n          feature.set(attribute.name, dateFormatter.formatDate(value, attribute.format));\n        } else {\n          // Shouldn't be set to an empty string\n          feature.set(attribute.name, null);\n        }\n      }\n    }\n    this.feature = feature;\n    this.createActive = false;\n    if (!feature.getId()) {\n      this.dirty = true;\n    }\n    this.scope_.$apply();\n  }, 0);\n};\n\n\n/**\n * Activate or deactivate this directive.\n * @param {boolean} active Whether to activate this directive or not.\n * @private\n */\nexports.Controller_.prototype.toggle_ = function(active) {\n\n  const keys = this.listenerKeys_;\n  const createUid = ['create-', olBase.getUid(this)].join('-');\n  const otherUid = ['other-', olBase.getUid(this)].join('-');\n  const toolMgr = this.ngeoToolActivateMgr_;\n\n  if (active) {\n\n    // FIXME\n    //this.registerInteractions_();\n\n    keys.push(olEvents.listen(this.menu_, 'actionclick',\n      this.handleMenuActionClick_, this));\n\n    keys.push(olEvents.listen(this.translate_,\n      'translateend',\n      this.handleTranslateEnd_, this));\n\n    keys.push(olEvents.listen(this.rotate_, 'rotateend', this.handleRotateEnd_, this));\n\n    toolMgr.registerTool(createUid, this.createToolActivate, false);\n    toolMgr.registerTool(createUid, this.mapSelectToolActivate, true);\n\n    toolMgr.registerTool(otherUid, this.createToolActivate, false);\n    toolMgr.registerTool(otherUid, this.modifyToolActivate, true);\n    toolMgr.registerTool(otherUid, this.translateToolActivate, false);\n    toolMgr.registerTool(otherUid, this.rotateToolActivate, false);\n\n  } else {\n\n    // FIXME\n    //this.unregisterInteractions_();\n\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n\n    toolMgr.unregisterTool(createUid, this.createToolActivate);\n    toolMgr.unregisterTool(createUid, this.mapSelectToolActivate);\n\n    toolMgr.unregisterTool(otherUid, this.createToolActivate);\n    toolMgr.unregisterTool(otherUid, this.modifyToolActivate);\n    toolMgr.unregisterTool(otherUid, this.translateToolActivate);\n    toolMgr.unregisterTool(otherUid, this.rotateToolActivate);\n\n    this.createActive = false;\n    this.cancel();\n  }\n\n  this.modify_.setActive(active);\n  this.mapSelectActive = active;\n  this.editableTreeCtrl.properties['editing'] = active;\n\n};\n\n\n/**\n * Called when the mapSelectActive property changes.\n * @param {boolean} active Whether the map select is active or not.\n * @private\n */\nexports.Controller_.prototype.handleMapSelectActiveChange_ = function(\n  active) {\n\n  const mapDiv = this.map.getViewport();\n  googAsserts.assertElement(mapDiv);\n\n  if (active) {\n    olEvents.listen(this.map, 'click',\n      this.handleMapClick_, this);\n\n    olEvents.listen(mapDiv, 'contextmenu',\n      this.handleMapContextMenu_, this);\n\n  } else {\n    olEvents.unlisten(this.map, 'click',\n      this.handleMapClick_, this);\n\n    olEvents.unlisten(mapDiv, 'contextmenu',\n      this.handleMapContextMenu_, this);\n  }\n};\n\n\n/**\n * Called when the map is clicked.\n *\n * (1) If a vector feature was clicked, don't do anything (i.e. allow the\n *     interactions to do their bidings without selecting a new feature).\n *\n * (2) Otherwise, if there is a feature being edited and has unsaved\n *     modifications, show the confirmation modal asking the user what to do\n *     about it.\n *\n * (3) If there's no feature selected or we have one without unsaved\n *     modifications or with modifications that were canceled, launch a query\n *     to fetch the features at the clicked location.\n *\n * @param {ol.MapBrowserEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapClick_ = function(evt) {\n  const interactions = evt.target.getInteractions().getArray();\n  const activeInteraction = interactions.find(interaction => interaction.getActive() === true);\n\n  if (this.cancelEventKey_ === undefined) {\n    this.cancelEventKey_ = olEvents.listen(document.body, 'keydown', (event) => {\n      const escPressed = event.keyCode === 27; // Escape key\n      if (escPressed && activeInteraction.getActive()) {\n        this.cancel();\n        this.scope_.$apply();\n\n        olEvents.unlistenByKey(this.cancelEventKey_);\n        this.cancelEventKey_ = undefined;\n      }\n    });\n  }\n\n  const coordinate = evt.coordinate;\n  const pixel = evt.pixel;\n\n  // (1) Check if we clicked on an existing vector feature, i.e the one\n  //     selected. In that case, no need to do any further action.\n  const feature = this.map.forEachFeatureAtPixel(\n    pixel,\n    (feature) => {\n      let ret = false;\n      if (olArray.includes(this.features.getArray(), feature)) {\n        ret = feature;\n      }\n      return ret;\n    },\n    {\n      hitTolerance: 5\n    }\n  );\n\n  if (feature) {\n    return;\n  }\n\n  // (2) If a feature is being edited and has unsaved changes, show modal\n  //     to let the user decide what to do\n  this.checkForModifications_(true).then(() => {\n\n    const map = this.map;\n    const view = map.getView();\n    const resolution = view.getResolution();\n    const buffer = resolution * this.tolerance;\n    const extent = olExtent.buffer(\n      [coordinate[0], coordinate[1], coordinate[0], coordinate[1]],\n      buffer\n    );\n\n    // (3) Launch query to fetch features\n    this.gmfEditFeature_.getFeaturesInExtent(\n      [this.editableNode_.id],\n      extent\n    ).then(this.handleGetFeatures_.bind(this));\n\n    // (4) Clear any previously selected feature\n    this.cancel();\n\n    // (5) Pending\n    this.pending = true;\n  });\n};\n\n\n/**\n * @param {Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapContextMenu_ = function(evt) {\n  const pixel = this.map.getEventPixel(evt);\n  const coordinate = this.map.getCoordinateFromPixel(pixel);\n\n  let feature = this.map.forEachFeatureAtPixel(\n    pixel,\n    (feature) => {\n      let ret = false;\n      if (olArray.includes(this.features.getArray(), feature)) {\n        ret = feature;\n      }\n      return ret;\n    },\n    {\n      hitTolerance: 7\n    }\n  );\n\n  feature = feature ? feature : null;\n\n  // show contextual menu when clicking on certain types of features\n  if (feature) {\n    const type = this.ngeoFeatureHelper_.getType(feature);\n    if (type === ngeoGeometryType.POLYGON || type === ngeoGeometryType.MULTI_POLYGON ||\n        type === ngeoGeometryType.LINE_STRING || type === ngeoGeometryType.MULTI_LINE_STRING) {\n      this.menu_.open(coordinate);\n    }\n    evt.preventDefault();\n    evt.stopPropagation();\n  }\n};\n\n\n/**\n * @param {Array.<ol.Feature>} features Features.\n * @private\n */\nexports.Controller_.prototype.handleGetFeatures_ = function(features) {\n  this.pending = false;\n\n  this.timeout_(() => {\n    if (features.length) {\n      const feature = features[0];\n      this.feature = feature;\n      this.features.push(feature);\n    }\n  }, 0);\n};\n\n\n/**\n * Initialize interactions by setting them inactive and decorating them\n * @private\n */\nexports.Controller_.prototype.initializeInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    interaction.setActive(false);\n    ngeoMiscDecorate.interaction(interaction);\n  });\n};\n\n\n/**\n * Register interactions by adding them to the map\n * @private\n */\nexports.Controller_.prototype.registerInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.addInteraction(interaction);\n  });\n};\n\n\n/**\n * Unregister interactions, i.e. set them inactive and remove them from the map\n * @private\n */\nexports.Controller_.prototype.unregisterInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.removeInteraction(interaction);\n  });\n};\n\n\n/**\n * @param {?ol.Feature} newFeature The new feature.\n * @param {?ol.Feature} oldFeature The old feature.\n * @private\n */\nexports.Controller_.prototype.handleFeatureChange_ = function(\n  newFeature, oldFeature\n) {\n\n  let geom;\n  if (oldFeature) {\n    olEvents.unlisten(oldFeature, 'propertychange', this.handleFeaturePropertyChange_, this);\n    geom = oldFeature.getGeometry();\n    googAsserts.assert(geom);\n    olEvents.unlisten(\n      geom,\n      'change',\n      this.handleFeatureGeometryChange_,\n      this\n    );\n    this.unregisterInteractions_();\n  }\n\n  if (newFeature) {\n    this.featureId = newFeature.getId();\n    olEvents.listen(newFeature, 'propertychange', this.handleFeaturePropertyChange_, this);\n    geom = newFeature.getGeometry();\n    googAsserts.assert(geom);\n    olEvents.listen(\n      geom,\n      'change',\n      this.handleFeatureGeometryChange_,\n      this\n    );\n    this.registerInteractions_();\n\n    this.gmfSnapping_.ensureSnapInteractionsOnTop();\n\n    // The `ui-date` triggers an unwanted change, i.e. it converts the text\n    // to Date, which makes the directive dirty when it shouldn't... to\n    // bypass this, we reset the dirty state here. We do so only if we're\n    // editing an existing feature\n    if (this.featureId) {\n      this.timeout_(() => {\n        this.dirty = false;\n        this.scope_.$apply();\n      }, 0);\n    }\n  } else {\n    this.featureId = undefined;\n  }\n\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleFeaturePropertyChange_ = function() {\n  this.dirty = true;\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleFeatureGeometryChange_ = function() {\n  this.dirty = true;\n  this.scope_.$apply();\n};\n\n\n/**\n * @param {ngeox.MenuEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMenuActionClick_ = function(evt) {\n  const action = evt.detail.action;\n\n  switch (action) {\n    case 'move':\n      this.translate_.setActive(true);\n      this.scope_.$apply();\n      break;\n    case 'rotate':\n      this.rotate_.setActive(true);\n      this.scope_.$apply();\n      break;\n    default:\n      break;\n  }\n};\n\n\n/**\n * @param {ol.interaction.Translate.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleTranslateEnd_ = function(evt) {\n  this.translate_.setActive(false);\n  this.scope_.$apply();\n};\n\n\n/**\n * @param {!ngeox.RotateEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleRotateEnd_ = function(evt) {\n  this.rotate_.setActive(false);\n  this.scope_.$apply();\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  this.features.clear();\n  this.handleFeatureChange_(null, this.feature);\n  this.feature = null;\n  const uid = olBase.getUid(this);\n  this.ngeoEventHelper_.clearListenerKey(uid);\n  this.toggle_(false);\n  this.handleMapSelectActiveChange_(false);\n  this.unregisterInteractions_();\n  olEvents.unlistenByKey(this.cancelEventKey_);\n  this.cancelEventKey_ = undefined;\n};\n\n\nexports.controller('GmfEditfeatureController',\n  exports.Controller_);\n\n\n/**\n * The different possible values of the `state` inner property.\n * @enum {string}\n */\nexports.State = {\n  /**\n   * The default state. While idle, nothing happens.\n   * @type {string}\n   */\n  IDLE: 'idle',\n  /**\n   * The state active after the deactivation of the editing tools and the\n   * unsaved modifications were saved or discarded.\n   * @type {string}\n   */\n  DEACTIVATE_EXECUTE: 'deactivate_execute',\n  /**\n   * The state active when the deactivation of the editing tools is in\n   * progress while there are unsaved modifications.\n   * @type {string}\n   */\n  DEACTIVATE_PENDING: 'deactivate_pending',\n  /**\n   * Final state set after the \"stop editing\" button has been clicked while\n   * no unsaved modifications were made or if the user saved them or confirmed\n   * to continue without saving.\n   * @type {string}\n   */\n  STOP_EDITING_EXECUTE: 'stop_editing_execute',\n  /**\n   * The state that is active while when the \"stop editing\" button has been\n   * clicked but before any confirmation has been made to continue.\n   * @type {string}\n   */\n  STOP_EDITING_PENDING: 'stop_editing_pending'\n};\n\n\nexport default exports;\n","/**\n * @module gmf.theme.Manager\n */\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport ngeoStatemanagerService from 'ngeo/statemanager/Service.js';\n\n/**\n * Manage a tree with children. This service can be used in mode 'flush'\n * (default) or not (mode 'add'). In mode 'flush', each theme, group or group\n * by layer that you add will replace the previous children's array. In mode\n * 'add', children will be just pushed in this array. The default state can be\n * changed by setting the value `gmfTreeManagerModeFlush`, e.g.:\n *\n *    let module = angular.module('app');\n *    module.value('gmfTreeManagerModeFlush', false);\n *\n * This service's theme is a GmfTheme with only children and a name.\n * Thought to be the tree source of the gmf layertree directive.\n * @constructor\n * @param {angular.Scope} $rootScope Angular rootScope.\n * @param {gmf.theme.Themes} gmfThemes gmf Themes service.\n * @param {boolean} gmfTreeManagerModeFlush Flush mode active?\n * @param {gmf.layertree.TreeManager} gmfTreeManager the tree manager.\n * @param {ngeo.statemanager.Service} ngeoStateManager The ngeo statemanager service.\n * @ngInject\n * @struct\n * @ngdoc service\n * @ngname gmfTreeManager\n */\nconst exports = function($rootScope, gmfThemes, gmfTreeManagerModeFlush,\n  gmfTreeManager, ngeoStateManager) {\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.$rootScope_ = $rootScope;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.modeFlush = gmfTreeManagerModeFlush;\n\n  /**\n   * @type {gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = gmfTreeManager;\n\n  /**\n   * @type {ngeo.statemanager.Service}\n   * @private\n   */\n  this.ngeoStateManager_ = ngeoStateManager;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.themeName_ = '';\n};\n\n\n/**\n * Set the current theme name (mode 'flush' only) and add its children. Add\n * only groups that are not already in the tree.\n * @param {!gmfThemes.GmfTheme} theme A theme object.\n * @param {boolean=} opt_silent if true it will be no user message if\n *     the theme should be added but it's already added.\n * @export\n */\nexports.prototype.addTheme = function(theme, opt_silent) {\n  if (this.modeFlush) {\n    this.ngeoStateManager_.updateState({\n      'theme': theme.name\n    });\n    this.setThemeName(theme.name);\n    this.gmfTreeManager_.setFirstLevelGroups(theme.children);\n  } else {\n    this.gmfTreeManager_.addFirstLevelGroups(theme.children, false, opt_silent);\n  }\n};\n\n\n/**\n * @return {string} The theme name. Will be empty on 'not flush' mode.\n * @export\n */\nexports.prototype.getThemeName = function() {\n  return this.themeName_;\n};\n\n\n/**\n * @return {boolean} true if the theme is loading.\n * @export\n */\nexports.prototype.isLoading = function() {\n  return !this.gmfThemes_.loaded;\n};\n\n\n/**\n * @param {string} themeName wanted theme name.\n * @param {string} fallbackThemeName fallback theme name.\n * @param {boolean=} opt_silent if true notifyCantAddGroups_ is not called.\n * @export\n */\nexports.prototype.updateCurrentTheme = function(themeName, fallbackThemeName, opt_silent) {\n  this.gmfThemes_.getThemesObject().then((themes) => {\n    if (!themeName && this.modeFlush) {\n      // In flush mode load current theme private groups\n      const fallbackTheme = gmfThemeThemes.findThemeByName(themes, /** @type {string} */ (fallbackThemeName));\n      if (fallbackTheme) {\n        this.gmfTreeManager_.addFirstLevelGroups(fallbackTheme.children, false, opt_silent);\n      }\n    }\n    if (themeName) {\n      const theme = gmfThemeThemes.findThemeByName(themes, /** @type {string} */ (themeName));\n      if (theme) {\n        this.addTheme(theme, true);\n      }\n    } else {\n      this.setThemeName(fallbackThemeName);\n    }\n  });\n};\n\n\n/**\n * @param {string} name The new theme name.\n * @param {boolean=} opt_silent Don't emit a theme change event, default is false.\n */\nexports.prototype.setThemeName = function(name, opt_silent) {\n  this.themeName_ = name;\n  if (!opt_silent) {\n    this.$rootScope_.$emit(exports.EventType.THEME_NAME_SET, name);\n  }\n};\n\n\n/**\n * Remove all groups.\n * @export\n */\nexports.prototype.removeAll = function() {\n  this.gmfTreeManager_.removeAll();\n};\n\n\n/**\n * @enum {string}\n */\nexports.EventType = {\n  /**\n   * Triggered when the theme name change.\n   */\n  THEME_NAME_SET: 'gmf-thememanager-theme_name_set'\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfThemeManager', [\n  gmfLayertreeTreeManager.module.name,\n  gmfThemeThemes.module.name,\n  ngeoStatemanagerService.module.name,\n]);\n\n/**\n * The default value for `modeFlush` that `gmf.layertree.TreeManager` is initialized with.\n */\nexports.module.value('gmfTreeManagerModeFlush', true);\n\nexports.module.service('gmfThemeManager', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.DataSource\n */\n/**\n * @implements {ngeox.datasource.DataSource}\n */\nconst exports = class {\n\n  /**\n   * A `ngeo.datasource.DataSource` represents a single source of data, which\n   * can combine different type of servers to display or fetch the data. It can\n   * serve as a point of entry to get all the information about a single data\n   * source.\n   *\n   * You can use the information in a data source to do all sorts of things:\n   *  - create `ol.layer.Layer` objects using the WMS, WMTS or even WFS\n   *    information\n   *  - issue WMS/WFS queries\n   *  - know whether the data is visible or not\n   *  - apply filter rules on it\n   *\n   * @struct\n   * @param {ngeox.datasource.DataSourceOptions} options Options.\n   */\n  constructor(options) {\n\n    // === DYNAMIC properties (i.e. that can change / be watched ===\n\n    /**\n     * A data source is considered 'in range' when it is synchronized to\n     * a map view and the resolution of that view is within the range of\n     * the `maxResolution` and `minResolution`. These 2 properties are\n     * required for the `inRange` property to be dynamic, otherwise its\n     * value is always `true` by default.\n     *\n     * The synchronization is made in the `ngeo.datasource.DataSources`\n     * service.\n     *\n     * @type {boolean}\n     * @private\n     */\n    this.inRange_ = options.inRange !== false;\n\n    /**\n     * Whether the data source is visible or not, i.e. whether its is ON or OFF.\n     * Defaults to `false`.\n     * @type {boolean}\n     * @private\n     */\n    this.visible_ = options.visible === true;\n\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * The attributes of the data source.\n     *\n     * Note: `attributes` is not using the conventionnal getter/setter due\n     * to:  See: https://github.com/google/closure-compiler/issues/1089\n     *\n     * @type {?Array.<ngeox.Attribute>}\n     * @export\n     */\n    this.attributes = options.attributes || null;\n\n    /**\n     * (Required) The data source id.\n     * @type {number}\n     * @private\n     */\n    this.id_ = options.id;\n\n    /**\n     * The name of an attribute among the attributes of the data source.\n     * The value of that attribute, in records, can be used to identify\n     * each record individually.\n     * @type {string|undefined}\n     * @private\n     */\n    this.identifierAttribute_ = options.identifierAttribute;\n\n    /**\n     * Maximum resolution where the data source can be displayed or queried.\n     * @type {number|undefined}\n     * @private\n     */\n    this.maxResolution_ = options.maxResolution;\n\n    /**\n     * Minimum resolution where the data source can be displayed or queried.\n     * @type {number|undefined}\n     * @private\n     */\n    this.minResolution_ = options.minResolution;\n\n    /**\n     * (Required) A human-readable name for the data source.\n     * @type {string}\n     * @private\n     */\n    this.name_ = options.name;\n  }\n\n  // ========================================\n  // === Dynamic property getters/setters ===\n  // ========================================\n\n  /**\n   * @return {boolean} In range\n   * @export\n   */\n  get inRange() {\n    return this.inRange_;\n  }\n\n  /**\n   * @param {boolean} inRange In range\n   * @export\n   */\n  set inRange(inRange) {\n    this.inRange_ = inRange;\n  }\n\n  /**\n   * @return {boolean} Visible\n   * @export\n   */\n  get visible() {\n    return this.visible_;\n  }\n\n  /**\n   * @param {boolean} visible Visible\n   * @export\n   */\n  set visible(visible) {\n    this.visible_ = visible;\n  }\n\n  // =======================================\n  // === Static property getters/setters ===\n  // =======================================\n\n  /**\n   * @return {?Array.<ngeox.Attribute>} Attributes\n   * @export\n   */\n  getAttributes() {\n    return this.attributes;\n  }\n\n  /**\n   * @param {?Array.<ngeox.Attribute>} attributes Attributes\n   * @export\n   */\n  setAttributes(attributes) {\n    this.attributes = attributes;\n  }\n\n  /**\n   * @return {number} Id\n   * @export\n   */\n  get id() {\n    return this.id_;\n  }\n\n  /**\n   * @return {string|undefined} Identifier attribute\n   * @export\n   */\n  get identifierAttribute() {\n    return this.identifierAttribute_;\n  }\n\n  /**\n   * @return {number|undefined} Maximum resolution\n   * @export\n   */\n  get maxResolution() {\n    return this.maxResolution_;\n  }\n\n  /**\n   * @return {number|undefined} Minimum resolution\n   * @export\n   */\n  get minResolution() {\n    return this.minResolution_;\n  }\n\n  /**\n   * @return {string} Name\n   * @export\n   */\n  get name() {\n    return this.name_;\n  }\n\n\n  // ===================================\n  // === Calculated property getters ===\n  // ===================================\n\n  /**\n   * Whether the data source is queryable or not.\n   * @return {boolean} Whether the data source is queryable or not.\n   * @export\n   */\n  get queryable() {\n    return false;\n  }\n\n  /**\n   * @return {boolean} Whether the data source supports a dynamic `inRange`\n   *     property or not, i.e. whether it can be calculated.\n   * @export\n   */\n  get supportsDynamicInRange() {\n    return this.maxResolution !== null || this.minResolution !== null;\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.rule.Select\n */\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\n\nconst exports = class extends ngeoRuleRule {\n\n  /**\n   * A select rule, which allows the selection of multiple values among a list\n   * of choices.\n   *\n   * The expression property holds the list of selected choices, which is\n   * comma-separated.\n   *\n   * @struct\n   * @param {!ngeox.rule.SelectOptions} options Options.\n   */\n  constructor(options) {\n\n    options.operator = ngeoRuleRule.OperatorType.EQUAL_TO;\n    options.type = ngeoFormatAttributeType.SELECT;\n\n    super(options);\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * @type {Array.<string>}\n     * @private\n     */\n    this.choices_ = options.choices;\n\n  }\n\n  // === Static property getters/setters ===\n\n  /**\n   * @return {Array.<string>} Choices\n   * @export\n   */\n  get choices() {\n    return this.choices_;\n  }\n\n  // === Calculated property getters ===\n\n  /**\n   * @return {Array.<string>} Selected choices\n   * @export\n   */\n  get selectedChoices() {\n    let selectedChoices;\n    if (this.expression) {\n      const stringExpression = String(this.expression);\n      selectedChoices = stringExpression.split(',');\n    } else {\n      selectedChoices = [];\n    }\n    return selectedChoices;\n  }\n\n};\n\n\nexport default exports;\n","/**\n * @module gmf.editing.EditFeature\n */\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport * as olUri from 'ol/uri.js';\n\n/**\n * Service that provides methods to get, insert, update and delete vector\n * features with the use of a GeoMapFish Protocol as back-end.\n *\n * The GeoJSON format is used when obtaining or sending features.\n *\n * @constructor\n * @struct\n * @param {angular.$http} $http Angular http service.\n * @param {string} gmfLayersUrl Url to the GeoMapFish layers service.\n * @ngInject\n */\nconst exports = function($http, gmfLayersUrl) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.http_ = $http;\n\n  /**\n   * Url to the GeoMapFish layers service. Required in applications that use:\n   * - the editfeature tools\n   * - the objectediting tools\n   *\n   * @type {string}\n   * @private\n   */\n  this.baseUrl_ = gmfLayersUrl;\n\n};\n\n\n/**\n * Build a query to the MapFish protocol to fetch features from a list\n * of layer ids inside a specified extent.\n *\n * @param {Array.<number>} layerIds List of layer ids to get the features from.\n * @param {ol.Extent} extent The extent where to get the features from.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getFeaturesInExtent = function(layerIds, extent) {\n  const url = olUri.appendParams(\n    `${this.baseUrl_}/${layerIds.join(',')}`,\n    {\n      'bbox': extent.join(',')\n    }\n  );\n  return this.http_.get(url).then(this.handleGetFeatures_.bind(this));\n};\n\n\n/**\n * Build a query to the MapFish protocol to fetch features from a list\n * of layer ids and a list of comparison filters.\n *\n * This method is called in the ObjectEditing service, which is injected in\n * the permalink service, i.e. it's always called. Since we don't have to\n * define the url to the GMF Protocol (layers) a dummy promise returns an\n * empty array of features if the url is not defined.\n *\n * @param {!Array.<number>} layerIds List of layer ids to get the features from.\n * @param {!Array.<!gmfx.ComparisonFilter>} filters List of comparison filters\n * @return {angular.$q.Promise} Promise.\n */\nexports.prototype.getFeaturesWithComparisonFilters = function(\n  layerIds, filters\n) {\n  const properties = [];\n  const params = {};\n\n  for (const filter of filters) {\n    params[`${filter.property}__${filter.operator}`] = filter.value;\n    properties.push(filter.property);\n  }\n\n  params['queryable'] = properties.join(',');\n\n  const url = olUri.appendParams(`${this.baseUrl_}/${layerIds.join(',')}`, params);\n  return this.http_.get(url).then(this.handleGetFeatures_.bind(this));\n};\n\n\n/**\n * @param {angular.$http.Response} resp Ajax response.\n * @return {Array.<ol.Feature>} List of features.\n * @private\n */\nexports.prototype.handleGetFeatures_ = function(resp) {\n  return new olFormatGeoJSON().readFeatures(resp.data);\n};\n\n\n/**\n * @param {number} layerId The layer id that contains the feature.\n * @param {Array.<ol.Feature>} features List of features to insert.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.insertFeatures = function(layerId, features) {\n  const url = `${this.baseUrl_}/${layerId}`;\n  const geoJSON = new olFormatGeoJSON().writeFeatures(features);\n  return this.http_.post(url, geoJSON, {\n    headers: {'Content-Type': 'application/json'},\n    withCredentials: true\n  });\n};\n\n\n/**\n * @param {number} layerId The layer id that contains the feature.\n * @param {ol.Feature} feature The feature to update.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.updateFeature = function(layerId, feature) {\n  const url = `${this.baseUrl_}/${layerId.toString()}/${feature.getId()}`;\n  const geoJSON = new olFormatGeoJSON().writeFeature(feature);\n  return this.http_.put(url, geoJSON, {\n    headers: {'Content-Type': 'application/json'},\n    withCredentials: true\n  });\n};\n\n\n/**\n * @param {number} layerId The layer id that contains the feature.\n * @param {ol.Feature} feature The feature to delete.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.deleteFeature = function(layerId, feature) {\n  const url = `${this.baseUrl_}/${layerId.toString()}/${feature.getId()}`;\n  return this.http_.delete(url, {\n    headers: {'Content-Type': 'application/json'},\n    withCredentials: true\n  });\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfEditFeature', []);\nexports.module.service('gmfEditFeature', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.debounce\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDebounce', []);\n\n\n/**\n * Provides a debounce service. That service is a function\n * used to debounce calls to a user-provided function.\n *\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @return {ngeox.miscDebounce} The debounce function.\n *\n * @ngdoc service\n * @ngname ngeoDebounce\n * @ngInject\n */\nexports.factory_ = function($timeout) {\n  return (\n    // FIXME: eslint can't detect that the function returns a function\n    /**\n     * @param {function(?)} func The function to debounce.\n     * @param {number} wait The wait time in ms.\n     * @param {boolean} invokeApply Whether the call to `func` is wrapped\n     *    into an `$apply` call.\n     * return {function()} The wrapper function.\n     */\n    function(func, wait, invokeApply) {\n      /**\n       * @type {?angular.$q.Promise}\n       */\n      let timeout = null;\n      return (\n        function(...args) {\n          const context = this;\n          const later = function() {\n            timeout = null;\n            func.apply(context, args);\n          };\n          if (timeout !== null) {\n            $timeout.cancel(timeout);\n          }\n          timeout = $timeout(later, wait, invokeApply);\n        });\n    });\n};\n\nexports.factory('ngeoDebounce', exports.factory_);\n\n\nexport default exports;\n","/**\n * @module ngeo.statemanager.Location\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoUtils from 'ngeo/utils.js';\n\n/**\n * Provides a service for interacting with the URL in the\n * browser address bar.\n *\n * WARNING: because of a bug in Angular this service is not compatible with\n * the $location service. This further means that service is not compatible\n * with the $anchorScroll and $route services, and with the ng-include and\n * ng-view directives (which are based on the $anchorScroll and $route\n * services). See <https://github.com/angular/angular.js/issues/1417>.\n *\n * This file also provides an ngeo.statemanager.Location.MockProvider function that you can\n * use to mock Angular's $location provider and make it possible to use both\n * ngeoLocation and ng-include.\n *\n *     app.module.config(ngeo.statemanager.Location.MockProvider);\n *\n * The ngeo Location type.\n *\n * See our live example: [../examples/permalink.html](../examples/permalink.html)\n *\n * @param {Location} location Location.\n * @param {History} history History.\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoLocation\n */\nconst exports = function(location, history) {\n  /**\n   * @type {History}\n   * @private\n   */\n  this.history_ = history;\n\n  /**\n   * @type {string|undefined}\n   * @private\n   */\n  this.schema_ = location.protocol.substring(0, location.protocol.length - 1);\n\n  /**\n   * @type {string|undefined}\n   * @private\n   */\n  this.domain_ = location.hostname;\n\n  /**\n   * @type {number|undefined}\n   * @private\n   */\n  this.port_ = location.port ? parseInt(location.port, 10) : undefined;\n\n  /**\n   * @type {string|undefined}\n   * @private\n   */\n  this.path_ = location.pathname;\n\n  /**\n   * @type {!Object.<string, string>}\n   * @private\n   */\n  this.queryData_ = ngeoUtils.decodeQueryString(location.search);\n\n  /**\n   * @type {!Object.<string, string>}\n   * @private\n   */\n  this.fragment_ = ngeoUtils.decodeQueryString(location.hash);\n};\n\n\n/**\n * @param {History} history History.\n * @param {string} state State.\n */\nexports.replaceState = function(history, state) {\n  try {\n    history.replaceState(null, '', state);\n  } catch (error) {\n    // replaceState fails on some browser if the domain in the state\n    // is not the same as location.origin\n  }\n};\n\n\n/**\n * Get the location's current path.\n * @return {string|undefined} The path.\n * @export\n */\nexports.prototype.getPath = function() {\n  return this.path_;\n};\n\n\n/**\n * Get the location's URI as a string\n * @return {string} The URI.\n * @export\n */\nexports.prototype.getUriString = function() {\n  const out = [];\n\n  if (this.schema_) {\n    out.push(this.schema_, ':');\n  }\n\n  if (this.domain_ || this.schema_ === 'file') {\n    out.push('//');\n\n    out.push(this.domain_);\n\n    if (this.port_ !== undefined) {\n      out.push(':', String(this.port_));\n    }\n  }\n\n  if (this.path_) {\n    if (this.domain_ && this.path_.charAt(0) !== '/') {\n      out.push('/');\n    }\n    out.push(this.path_);\n  }\n\n  const encodedQueryData = ngeoUtils.encodeQueryString(this.queryData_);\n  if (encodedQueryData.length > 0) {\n    out.push('?', encodedQueryData);\n  }\n\n  const encodedFragment = ngeoUtils.encodeQueryString(this.fragment_);\n  if (encodedFragment.length > 0) {\n    out.push('#', encodedFragment);\n  }\n  return out.join('');\n};\n\n\n/**\n * Check if a param exists in the location's URI.\n * @param {string} key Param key.\n * @return {boolean} True if the param exists.\n * @export\n */\nexports.prototype.hasParam = function(key) {\n  return key in this.queryData_;\n};\n\n\n/**\n * Check if a param exists in the fragment of the location's URI.\n * @param {string} key Param key.\n * @return {boolean} True if the param exists.\n * @export\n */\nexports.prototype.hasFragmentParam = function(key) {\n  return key in this.fragment_;\n};\n\n\n/**\n * Get a param in the location's URI.\n * @param {string} key Param key.\n * @return {string|undefined} Param value.\n * @export\n */\nexports.prototype.getParam = function(key) {\n  return this.queryData_[key];\n};\n\n\n/**\n * Get a param from the fragment of the location's URI.\n * @param {string} key Param key.\n * @return {string|undefined} Param value.\n * @export\n */\nexports.prototype.getFragmentParam = function(key) {\n  return this.fragment_[key];\n};\n\n\n/**\n * Get a param in the location's URI as integer. If the entry does not exist,\n * or if the value can not be parsed as integer, `undefined` is returned.\n * @param {string} key Param key.\n * @return {number|undefined} Param value.\n * @export\n */\nexports.prototype.getParamAsInt = function(key) {\n  const value = this.getParam(key);\n  if (value === undefined) {\n    return undefined;\n  }\n  googAsserts.assertString(value);\n  const valueAsInt = parseInt(value, 10);\n  return (isNaN(valueAsInt)) ? undefined : valueAsInt;\n};\n\n\n/**\n * Get a param in the location's URI as a floating point number.\n * If the entry does not exist, or if the value can not be parsed,\n * `undefined` is returned.\n * @param {string} key Param key.\n * @return {number|undefined} Param value.\n * @export\n */\nexports.prototype.getParamAsFloat = function(key) {\n  const value = this.getParam(key);\n  if (value === undefined) {\n    return undefined;\n  }\n  googAsserts.assertString(value);\n  const valueAsFloat = parseFloat(value);\n  return isNaN(valueAsFloat) ? undefined : valueAsFloat;\n};\n\n\n/**\n * Get a param from the fragment of the location's URI as integer. If the entry\n * does not exist, or if the value can not be parsed as integer, `undefined` is returned.\n * @param {string} key Param key.\n * @return {number|undefined} Param value.\n * @export\n */\nexports.prototype.getFragmentParamAsInt = function(key) {\n  const value = this.getFragmentParam(key);\n  if (value === undefined) {\n    return undefined;\n  }\n  googAsserts.assertString(value);\n  const valueAsInt = parseInt(value, 10);\n  return (isNaN(valueAsInt)) ? undefined : valueAsInt;\n};\n\n\n/**\n * Get an array with all existing param's keys in the location's URI.\n * @return {Array.<string>} Param keys.\n * @export\n */\nexports.prototype.getParamKeys = function() {\n  const keys = [];\n  for (const key in this.queryData_) {\n    keys.push(key);\n  }\n  return keys;\n};\n\n\n/**\n * Get an array with all existing param's keys from the fragment of the location's URI.\n * @return {Array.<string>} Param keys.\n * @export\n */\nexports.prototype.getFragmentParamKeys = function() {\n  const keys = [];\n  for (const key in this.fragment_) {\n    keys.push(key);\n  }\n  return keys;\n};\n\n\n/**\n * Get an array with all existing param's keys in the location's URI that start\n * with the given prefix.\n * @param {string} prefix Key prefix.\n * @return {Array.<string>} Param keys.\n * @export\n */\nexports.prototype.getParamKeysWithPrefix = function(prefix) {\n  const keys = [];\n  for (const key in this.queryData_) {\n    if (key.indexOf(prefix) == 0) {\n      keys.push(key);\n    }\n  }\n  return keys;\n};\n\n\n/**\n * Get an array with all existing param's keys from the fragment of the location's URI\n * that start with the given prefix.\n * @param {string} prefix Key prefix.\n * @return {Array.<string>} Param keys.\n * @export\n */\nexports.prototype.getFragmentParamKeysWithPrefix = function(prefix) {\n  const keys = [];\n  for (const key in this.fragment_) {\n    if (key.indexOf(prefix) == 0) {\n      keys.push(key);\n    }\n  }\n  return keys;\n};\n\n\n/**\n * Set or create a param in the location's URI.\n * @param {!Object.<string, string>} params Parameters.\n * @export\n */\nexports.prototype.updateParams = function(params) {\n  for (const key in params) {\n    this.queryData_[key] = params[key];\n  }\n};\n\n\n/**\n * Set or create a param in the fragment of the location's URI.\n * @param {!Object.<string, string>} params Parameters.\n * @export\n */\nexports.prototype.updateFragmentParams = function(params) {\n  for (const key in params) {\n    this.fragment_[key] = params[key];\n  }\n};\n\n\n/**\n * Delete a param in the location's URI.\n * @param {string} key Param key.\n * @export\n */\nexports.prototype.deleteParam = function(key) {\n  delete this.queryData_[key];\n};\n\n\n/**\n * Delete a param int the fragment of the location's URI.\n * @param {string} key Param key.\n * @export\n */\nexports.prototype.deleteFragmentParam = function(key) {\n  delete this.fragment_[key];\n};\n\n\n/**\n * Refresh the the location's URI.\n * @export\n */\nexports.prototype.refresh = function() {\n  exports.replaceState(this.history_, this.getUriString());\n};\n\n\n/**\n * Set a new path for this location.\n * @param {string} path Path.\n * @export\n */\nexports.prototype.setPath = function(path) {\n  this.path_ = path;\n};\n\n\n/**\n * The factory creating the ngeo Location service.\n *\n * @param {angular.Scope} $rootScope The root scope.\n * @param {angular.$window} $window Angular window service.\n * @return {ngeo.statemanager.Location} The ngeo location service.\n * @ngInject\n */\nexports.LocationFactory = function($rootScope, $window) {\n  const history = $window.history;\n  const service = new exports($window.location, $window.history);\n\n  let lastUri = service.getUriString();\n  $rootScope.$watch(() => {\n    const newUri = service.getUriString();\n    if (lastUri !== newUri) {\n      $rootScope.$evalAsync(() => {\n        lastUri = newUri;\n        if (history !== undefined && history.replaceState !== undefined) {\n          exports.replaceState(history, newUri);\n        }\n        $rootScope.$broadcast('ngeoLocationChange');\n      });\n    }\n  });\n\n  return service;\n};\n\n/**\n * A function that changes Angular's $location provider to avoid problem\n * when both ngeoLocation and $location are used in an application. This\n * is how you can use that function in an application:\n *\n * app.module.config(ngeo.statemanager.Location.MockProvider);\n *\n * @param {angular.$locationProvider} $locationProvider Angular location\n *     provider.\n * @ngInject\n */\nexports.MockProvider = function($locationProvider) {\n  /**\n   * @return {angular.$location} Mock object for Angular location service.\n   */\n  $locationProvider['$get'] = function() {\n    const locationMock = /** @type {angular.$location} */ ({\n      /**\n       * @return {string} Absolute URL.\n       */\n      absUrl() {\n        return '';\n      },\n      /**\n       * @param {string=} opt_path Path.\n       * @return {string} Hash.\n       */\n      hash(opt_path) {\n        return opt_path !== undefined ? this : '';\n      },\n      /**\n       * @return {string} Host.\n       */\n      host() {\n        return '';\n      },\n      /**\n       * @param {string=} opt_path Path.\n       * @return {string} Path.\n       */\n      path(opt_path) {\n        return opt_path !== undefined ? this : '';\n      },\n      /**\n       * @return {number} Port.\n       */\n      port() {\n        return 0;\n      },\n      /**\n       * @return {string} Protocol.\n       */\n      protocol() {\n        return '';\n      },\n      replace() {\n      },\n      /**\n       * @param {string=} opt_search Search.\n       * @param {Object=} opt_paramValue Parameters.\n       * @return {Object} Search.\n       */\n      search(opt_search, opt_paramValue) {\n        return opt_search !== undefined ? this : {};\n      },\n      /**\n       * @param {string=} opt_url URL.\n       * @return {string} URL.\n       */\n      url(opt_url) {\n        return '';\n      }\n    });\n    return locationMock;\n  };\n};\n\n\n/**\n * @type {!angular.Module}\n * FIXME add utils dependencies.\n * FIXME What about Mockup provider ?\n */\nexports.module = angular.module('ngeoLocation', []);\nexports.module.factory('ngeoLocation', exports.LocationFactory);\n\n\nexport default exports;\n","/**\n * @module ngeo.statemanager.Service\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoStatemanagerLocation from 'ngeo/statemanager/Location.js';\n\n/**\n * Provides a service for managing the application state.\n * The application state is written to both the URL and the local storage.\n * @constructor\n * @struct\n * @param {!ngeo.statemanager.Location} ngeoLocation ngeo location service.\n * @param {!Array.<!RegExp>} ngeoUsedKeyRegexp regexp used to identify the used keys.\n * @ngInject\n */\nconst exports = function(ngeoLocation, ngeoUsedKeyRegexp) {\n\n  /**\n   * Object representing the application's initial state.\n   * @type {!Object.<string, string>}\n   */\n  this.initialState = {};\n\n  /**\n   * @type {!ngeo.statemanager.Location}\n   */\n  this.ngeoLocation = ngeoLocation;\n\n\n  /**\n   * @type {!Array.<!RegExp>}\n   */\n  this.usedKeyRegexp = ngeoUsedKeyRegexp;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.useLocalStorage_;\n\n  this.setUseLocalStorage(false);\n\n  // Populate initialState with the application's initial state. The initial\n  // state is read from the location URL, or from the local storage if there\n  // is no state in the location URL.\n\n  const paramKeys = ngeoLocation.getParamKeys().filter(key => key != 'debug' && key != 'no_redirect');\n\n  if (paramKeys.length === 0) {\n    if (this.useLocalStorage_) {\n      for (const key in window.localStorage) {\n        googAsserts.assert(key);\n\n        this.usedKeyRegexp.some((keyRegexp) => {\n          if (key.match(keyRegexp)) {\n            const value = window.localStorage[key];\n            if (value !== undefined || value !== null) {\n              this.initialState[key] = value;\n            } else {\n              this.initialState[key] = '';\n            }\n            return true;\n          }\n        });\n      }\n    }\n  } else {\n    paramKeys.forEach((key) => {\n      this.usedKeyRegexp.some((keyRegexp) => {\n        if (key.match(keyRegexp)) {\n          const value = this.ngeoLocation.getParam(key);\n          if (value !== undefined) {\n            this.initialState[key] = value;\n            return true;\n          }\n        }\n      });\n    });\n  }\n};\n\n\n/**\n * @param {boolean} value Use localStorage\n * @return {boolean} localStorage will be used.\n */\nexports.prototype.setUseLocalStorage = function(value) {\n  this.useLocalStorage_ = value;\n\n  // check if localStorage is supported\n  if (this.useLocalStorage_) {\n    try {\n      if ('localStorage' in window) {\n        window.localStorage['test'] = '';\n        delete window.localStorage['test'];\n      } else {\n        this.useLocalStorage_ = false;\n      }\n    } catch (err) {\n      console.error(err);\n      this.useLocalStorage_ = false;\n    }\n  }\n  return this.useLocalStorage_;\n};\n\n/**\n * Get the state value for `key`.\n * @param {string} key State key.\n * @return {string|undefined} State value.\n */\nexports.prototype.getInitialValue = function(key) {\n  return this.initialState[key];\n};\n\n\n/**\n * Get the state value for `key`.\n * @param {string} key State key.\n * @return {string|undefined} State value.\n */\nexports.prototype.getInitialStringValue = function(key) {\n  return this.initialState[key];\n};\n\n\n/**\n * Get the state value for `key`.\n * @param {string} key State key.\n * @return {number|undefined} State value.\n */\nexports.prototype.getInitialNumberValue = function(key) {\n  const value = this.initialState[key];\n  if (value === undefined) {\n    return undefined;\n  }\n  return parseFloat(value);\n};\n\n\n/**\n * Get the state value for `key`.\n * @param {string} key State key.\n * @return {boolean|undefined} State value.\n */\nexports.prototype.getInitialBooleanValue = function(key) {\n  const value = this.initialState[key];\n  if (value === undefined) {\n    return undefined;\n  }\n  return value === 'true';\n};\n\n\n/**\n * Update the application state with the values in `object`.\n * @param {!Object.<string, string>} object Object.\n */\nexports.prototype.updateState = function(object) {\n  this.ngeoLocation.updateParams(object);\n  if (this.useLocalStorage_) {\n    for (const key in object) {\n      googAsserts.assert(key);\n      const value = object[key];\n      googAsserts.assert(value !== undefined);\n      window.localStorage[key] = value;\n    }\n  }\n};\n\n\n/**\n * Delete a parameter\n * @param {string} key Key.\n */\nexports.prototype.deleteParam = function(key) {\n  this.ngeoLocation.deleteParam(key);\n  if (this.useLocalStorage_) {\n    delete window.localStorage[key];\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoStateManager', [\n  ngeoStatemanagerLocation.module.name\n]);\nexports.module.service('ngeoStateManager', exports);\nexports.module.value('ngeoUsedKeyRegexp', [new RegExp('.*')]);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.common\n */\nconst exports = {};\nimport {createEditingStyle} from 'ol/style/Style.js';\n\n\n/**\n * @return {ol.StyleFunction} Styles.\n */\nexports.getDefaultDrawStyleFunction = function() {\n  const style = createEditingStyle();\n  return function(feature, resolution) {\n    return style[feature.getGeometry().getType()];\n  };\n};\n\n\n/**\n * @return {ol.StyleFunction} Styles.\n */\nexports.getDefaultModifyStyleFunction = function() {\n  const style = createEditingStyle();\n  return function(feature, resolution) {\n    return style[/**@type {ol.geom.GeometryType} */ ('Point')];\n  };\n};\n\n\nexport default exports;\n","/**\n * @module gmf.authentication.Service\n */\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport olEventsEventTarget from 'ol/events/EventTarget.js';\n\n/**\n * An \"authentication\" service for a GeoMapFish application. Upon loading, it\n * launches a request to determine whether a user is currently logged in or\n * not.\n *\n * The possible API requests it supports, which are all self-explanatory, are:\n *\n * - changePassword\n * - login\n * - logout\n * - resetPassword\n *\n * @extends {ol.events.EventTarget}\n */\nconst exports = class extends olEventsEventTarget {\n\n  /**\n   * @param {angular.$http} $http Angular http service.\n   * @param {angular.$injector} $injector Main injector.\n   * @param {angular.Scope} $rootScope The directive's scope.\n   * @param {string} authenticationBaseUrl URL to \"authentication\" web service.\n   * @param {gmfx.User} gmfUser User.\n   * @ngInject\n   */\n  constructor($http, $injector, $rootScope, authenticationBaseUrl, gmfUser) {\n\n    super();\n\n    /**\n     * @type {angular.$http}\n     * @private\n     */\n    this.$http_ = $http;\n\n    /**\n     * @type {angular.Scope}\n     * @private\n     */\n    this.$rootScope_ = $rootScope;\n\n    /**\n     * The authentication url without trailing slash\n     * @type {string}\n     * @private\n     */\n    this.baseUrl_ = authenticationBaseUrl.replace(/\\/$/, '');\n\n    /**\n     * @type {gmfx.User}\n     * @private\n     */\n    this.user_ = gmfUser;\n\n    /**\n      * Don't request a new user object from the back-end after\n      * logging out if the logged-in user's role has this role.\n      * @type {?string}\n      * @private\n      */\n    this.noReloadRole_ =  $injector.has('gmfAuthenticationNoReloadRole')\n      ? $injector.get('gmfAuthenticationNoReloadRole')\n      : null;\n\n    this.load_();\n  }\n\n  /**\n   * Load the authentication service, which sends an asynch request to\n   * determine whether the user is currently connected or not.\n   * @private\n   */\n  load_() {\n    const url = `${this.baseUrl_}/${exports.RouteSuffix.IS_LOGGED_IN}`;\n    this.$http_.get(url, {withCredentials: true}).then(\n      this.handleLogin_.bind(this, true)\n    );\n  }\n\n  /**\n   * @param {string} oldPwd Old password.\n   * @param {string} newPwd New password.\n   * @param {string} confPwd New password confirmation.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  changePassword(oldPwd, newPwd, confPwd) {\n    const url = `${this.baseUrl_}/${exports.RouteSuffix.CHANGE_PASSWORD}`;\n\n    return this.$http_.post(url, $.param({\n      'oldPassword': oldPwd,\n      'newPassword': newPwd,\n      'confirmNewPassword': confPwd\n    }), {\n      headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n      withCredentials: true\n    }).then(((response) => {\n      this.user_.is_password_changed = true;\n    }));\n  }\n\n  /**\n   * @param {string} login Login name.\n   * @param {string} pwd Password.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  login(login, pwd) {\n    const url = `${this.baseUrl_}/${exports.RouteSuffix.LOGIN}`;\n\n    return this.$http_.post(url, $.param({'login': login, 'password': pwd}), {\n      headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n      withCredentials: true\n    }).then(\n      this.handleLogin_.bind(this, false));\n  }\n\n  /**\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  logout() {\n    const noReload = this.user_['role_name'] === this.noReloadRole_;\n    const url = `${this.baseUrl_}/${exports.RouteSuffix.LOGOUT}`;\n    return this.$http_.get(url, {withCredentials: true}).then(() => {\n      this.resetUser_(noReload);\n    });\n  }\n\n  /**\n   * @param {string} login Login name.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  resetPassword(login) {\n    const url = `${this.baseUrl_}/${exports.RouteSuffix.RESET_PASSWORD}`;\n\n    /**\n     * @param {angular.$http.Response} resp Ajax response.\n     * @return {gmfx.AuthenticationDefaultResponse} Response.\n     */\n    const successFn = function(resp) {\n      const respData = /** @type gmfx.AuthenticationDefaultResponse} */ (\n        resp.data);\n      return respData;\n    }.bind(this);\n\n    return this.$http_.post(url, $.param({'login': login}), {\n      headers: {'Content-Type': 'application/x-www-form-urlencoded'}\n    }).then(successFn);\n  }\n\n  /**\n   * @return {?gmfx.AuthenticationFunctionalities} The role functionalities.\n   */\n  getFunctionalities() {\n    return this.user_.functionalities;\n  }\n\n  /**\n   * @return {number|null} The role ID.\n   */\n  getRoleId() {\n    return this.user_.role_id;\n  }\n\n  /**\n   * @param {boolean} checkingLoginStatus Checking the login status?\n   * @param {angular.$http.Response} resp Ajax response.\n   * @return {angular.$http.Response} Response.\n   * @private\n   */\n  handleLogin_(checkingLoginStatus, resp) {\n    const respData = /** @type {gmfx.AuthenticationLoginResponse} */ (resp.data);\n    this.setUser_(respData, !checkingLoginStatus);\n    if (checkingLoginStatus) {\n      /** @type {gmfx.AuthenticationEvent} */\n      const event = new ngeoCustomEvent('ready', {user: this.user_});\n      this.dispatchEvent(event);\n    }\n    return resp;\n  }\n\n  /**\n   * @param {gmfx.AuthenticationLoginResponse} respData Response.\n   * @param {boolean} emitEvent Emit a login event?\n   * @private\n   */\n  setUser_(respData, emitEvent) {\n    for (const key in respData) {\n      this.user_[key] = respData[key];\n    }\n    if (emitEvent && respData.username !== undefined) {\n      /** @type {gmfx.AuthenticationEvent} */\n      const event = new ngeoCustomEvent('login', {user: this.user_});\n      this.dispatchEvent(event);\n    }\n  }\n\n  /**\n   * @private\n   * @param {boolean} noReload Don't request a new user object from\n   * the back-end after logging out, defaults to false.\n   */\n  resetUser_(noReload) {\n    noReload = noReload || false;\n    for (const key in this.user_) {\n      this.user_[key] = null;\n    }\n    /** @type {gmfx.AuthenticationEvent} */\n    const event = new ngeoCustomEvent('logout', {user: this.user_});\n    this.dispatchEvent(event);\n    if (!noReload) {\n      this.load_();\n    }\n  }\n};\n\n/**\n * @enum {string}\n */\nexports.RouteSuffix = {\n  CHANGE_PASSWORD: 'loginchange',\n  IS_LOGGED_IN: 'loginuser',\n  LOGIN: 'login',\n  LOGOUT: 'logout',\n  RESET_PASSWORD: 'loginresetpassword'\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfAuthenticationService', []);\nexports.module.service('gmfAuthenticationService', exports);\n\nexports.module.value('gmfUser', {\n  'functionalities': null,\n  'is_password_changed': null,\n  'role_id': null,\n  'role_name': null,\n  'username': null\n});\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.Time\n */\n/**\n * ngeo - Time service\n * @constructor\n * @struct\n * @ngInject\n * @ngdoc service\n * @ngname ngeoTime\n */\nconst exports = function() {};\n\n/**\n * @param {number|string|null} value The value\n * @param {Date} defaultValue The default value\n * @return {Date} the date\n */\nexports.prototype.createDate = function(value, defaultValue = null) {\n  return value !== null ? new Date(value) : defaultValue;\n};\n\n/**\n * @param {Date} date The date\n * @param {number|null=} defaultValue The default value\n * @return {number|null} the time\n */\nexports.prototype.getTime = function(date, defaultValue = null) {\n  return date ? date.getTime() : defaultValue;\n};\n\n/**\n * Get options regarding the time property of a node;\n *\n * @param {ngeox.TimeProperty} time the time property of a node\n * @return {{\n *  minDate : number,\n *  maxDate : number,\n *  values : (Array<number>|number)\n * }} - Configuration for the UI components\n * @export\n */\nexports.prototype.getOptions = function(time) {\n\n  const minDate = this.createDate(time.minValue);\n  const maxDate = this.createDate(time.maxValue);\n\n  const minDefaultDate = this.createDate(time.minDefValue, minDate);\n  const maxDefaultDate = this.createDate(time.maxDefValue, maxDate);\n\n  const defaultValues = (time.mode === 'range') ?\n    [this.getTime(minDefaultDate), this.getTime(maxDefaultDate)] :\n    this.getTime(minDefaultDate);\n\n  return {\n    minDate: this.getTime(minDate),\n    maxDate: this.getTime(maxDate),\n    values: defaultValues\n  };\n};\n\n\n/**\n * Time.prototype.getUTCDate - Get UTC date from a local date object\n *\n * @param  {Object} localDate loacl date object in\n * @return {Object} UTC date\n * @export\n */\nexports.prototype.getUTCDate = function(localDate) {\n  return new Date(\n    localDate.getUTCFullYear(),\n    localDate.getUTCMonth(),\n    localDate.getUTCDate());\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoTime', []);\nexports.module.service('ngeoTime', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.DrawAzimut\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionCommon from 'ngeo/interaction/common.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olFunctions from 'ol/functions.js';\nimport olGeomCircle from 'ol/geom/Circle.js';\nimport olGeomGeometryCollection from 'ol/geom/GeometryCollection.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olInteractionPointer, {handleEvent as pointerHandleEvent} from 'ol/interaction/Pointer.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\n\n/**\n * @classdesc\n * Interaction dedicated to measure azimut.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Pointer}\n * @param {olx.interaction.PointerOptions} options Options.\n */\nconst exports = function(options) {\n\n  olInteractionPointer.call(this, {\n    handleDownEvent: exports.handleDownEvent_,\n    handleEvent: exports.handleEvent_,\n    handleUpEvent: exports.handleUpEvent_\n  });\n\n  /**\n   * @type {ol.Pixel}\n   * @private\n   */\n  this.downPx_ = null;\n\n  /**\n   * Target source for drawn features.\n   * @type {ol.source.Vector}\n   * @private\n   */\n  this.source_ = options.source !== undefined ? options.source : null;\n\n  /**\n   * Tglls whether the drawing has started or not.\n   * @type {boolean}\n   * @private\n   */\n  this.started_ = false;\n\n  /**\n   * Sketch feature.\n   * @type {ol.Feature}\n   * @private\n   */\n  this.sketchFeature_ = null;\n\n  /**\n   * Sketch point.\n   * @type {ol.Feature}\n   * @private\n   */\n  this.sketchPoint_ = null;\n\n\n  /**\n   * Squared tolerance for handling up events.  If the squared distance\n   * between a down and up event is greater than this tolerance, up events\n   * will not be handled.\n   * @type {number}\n   * @private\n   */\n  this.squaredClickTolerance_ = 4;\n\n\n  /**\n   * Vector layer where our sketch features are drawn.\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.sketchLayer_ = new olLayerVector({\n    source: new olSourceVector({\n      useSpatialIndex: false,\n      wrapX: false\n    }),\n    style: options.style || ngeoInteractionCommon.getDefaultDrawStyleFunction()\n  });\n\n  olEvents.listen(this, 'change:active', this.updateState_, this);\n};\n\nolBase.inherits(exports, olInteractionPointer);\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} event Event.\n * @return {boolean} Start drag sequence?\n * @this {ngeo.interaction.DrawAzimut}\n * @private\n */\nexports.handleDownEvent_ = function(event) {\n  this.downPx_ = event.pixel;\n  return true;\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} event Event.\n * @return {boolean} Stop drag sequence?\n * @this {ngeo.interaction.DrawAzimut}\n * @private\n */\nexports.handleUpEvent_ = function(event) {\n  const downPx = this.downPx_;\n  const clickPx = event.pixel;\n  const dx = downPx[0] - clickPx[0];\n  const dy = downPx[1] - clickPx[1];\n  const squaredDistance = dx * dx + dy * dy;\n  let pass = true;\n  if (squaredDistance <= this.squaredClickTolerance_) {\n    this.handlePointerMove_(event);\n    if (!this.started_) {\n      this.startDrawing_(event);\n    } else {\n      this.finishDrawing_();\n    }\n    pass = false;\n  }\n  return pass;\n};\n\n\n/**\n * @param {ol.MapBrowserEvent} mapBrowserEvent Map browser event.\n * @return {boolean} `false` to stop event propagation.\n * @this {ngeo.interaction.DrawAzimut}\n * @private\n */\nexports.handleEvent_ = function(mapBrowserEvent) {\n  let pass = true;\n  if (mapBrowserEvent.type === 'pointermove') {\n    pass = this.handlePointerMove_(mapBrowserEvent);\n  } else if (mapBrowserEvent.type === 'dblclick') {\n    pass = false;\n  }\n  return pointerHandleEvent.call(this, mapBrowserEvent) && pass;\n};\n\n\n/**\n * Handle move events.\n * @param {ol.MapBrowserEvent} event A move event.\n * @return {boolean} Pass the event to other interactions.\n * @private\n */\nexports.prototype.handlePointerMove_ = function(event) {\n  if (this.started_) {\n    this.modifyDrawing_(event);\n  } else {\n    this.createOrUpdateSketchPoint_(event);\n  }\n  return true;\n};\n\n\n/**\n * @param {ol.MapBrowserEvent} event Event.\n * @private\n */\nexports.prototype.createOrUpdateSketchPoint_ = function(event) {\n  const coordinates = event.coordinate.slice();\n  if (this.sketchPoint_ === null) {\n    this.sketchPoint_ = new olFeature(new olGeomPoint(coordinates));\n    this.updateSketchFeatures_();\n  } else {\n    const sketchPointGeom = this.sketchPoint_.getGeometry();\n    googAsserts.assertInstanceof(sketchPointGeom, olGeomPoint);\n    sketchPointGeom.setCoordinates(coordinates);\n  }\n};\n\n\n/**\n * Redraw the skecth features.\n * @private\n */\nexports.prototype.updateSketchFeatures_ = function() {\n  const sketchFeatures = [];\n  if (this.sketchFeature_ !== null) {\n    sketchFeatures.push(this.sketchFeature_);\n  }\n  if (this.sketchPoint_ !== null) {\n    sketchFeatures.push(this.sketchPoint_);\n  }\n  const source = this.sketchLayer_.getSource();\n  source.clear(true);\n  source.addFeatures(sketchFeatures);\n};\n\n\n/**\n * Start the drawing.\n * @param {ol.MapBrowserEvent} event Event.\n * @private\n */\nexports.prototype.startDrawing_ = function(event) {\n  const start = event.coordinate;\n  this.started_ = true;\n  const line = new olGeomLineString([start.slice(), start.slice()]);\n  const circle = new olGeomCircle(start, 0);\n  const geometry = new olGeomGeometryCollection([line, circle]);\n  googAsserts.assert(geometry !== undefined);\n  this.sketchFeature_ = new olFeature();\n  this.sketchFeature_.setGeometry(geometry);\n  this.updateSketchFeatures_();\n  /** @type {ngeox.DrawEvent} */\n  const evt = new ngeoCustomEvent('drawstart', {feature: this.sketchFeature_});\n  this.dispatchEvent(evt);\n};\n\n\n/**\n * Modify the drawing.\n * @param {ol.MapBrowserEvent} event Event.\n * @private\n */\nexports.prototype.modifyDrawing_ = function(event) {\n  const coordinate = event.coordinate;\n  const geometry = googAsserts.assertInstanceof(\n    this.sketchFeature_.getGeometry(), olGeomGeometryCollection);\n  const geometries = geometry.getGeometriesArray();\n  const line = geometries[0];\n  googAsserts.assertInstanceof(line, olGeomLineString);\n  const coordinates = line.getCoordinates();\n  const sketchPointGeom = this.sketchPoint_.getGeometry();\n  googAsserts.assertInstanceof(sketchPointGeom, olGeomPoint);\n  sketchPointGeom.setCoordinates(coordinate);\n  const last = coordinates[coordinates.length - 1];\n  last[0] = coordinate[0];\n  last[1] = coordinate[1];\n  googAsserts.assertInstanceof(line, olGeomLineString);\n  line.setCoordinates(coordinates);\n  const circle = googAsserts.assertInstanceof(geometries[1], olGeomCircle);\n  circle.setRadius(line.getLength());\n  this.updateSketchFeatures_();\n};\n\n\n/**\n * Stop drawing without adding the sketch feature to the target layer.\n * @return {ol.Feature} The sketch feature (or null if none).\n * @private\n */\nexports.prototype.abortDrawing_ = function() {\n  this.started_ = false;\n  const sketchFeature = this.sketchFeature_;\n  if (sketchFeature !== null) {\n    this.sketchFeature_ = null;\n    this.sketchPoint_ = null;\n    this.sketchLayer_.getSource().clear(true);\n  }\n  return sketchFeature;\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.shouldStopEvent = olFunctions.FALSE;\n\n\n/**\n * @private\n */\nexports.prototype.updateState_ = function() {\n  const map = this.getMap();\n  const active = this.getActive();\n  if (map === null || !active) {\n    this.abortDrawing_();\n  }\n  this.sketchLayer_.setMap(active ? map : null);\n};\n\n\n/**\n * Stop drawing and add the sketch feature to the target layer.\n * @private\n */\nexports.prototype.finishDrawing_ = function() {\n  const sketchFeature = this.abortDrawing_();\n  googAsserts.assert(sketchFeature !== null);\n\n  if (this.source_ !== null) {\n    this.source_.addFeature(sketchFeature);\n  }\n\n  /** @type {ngeox.DrawEvent} */\n  const event = new ngeoCustomEvent('drawend', {feature: this.sketchFeature_});\n  this.dispatchEvent(event);\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n  olInteractionPointer.prototype.setMap.call(this, map);\n  this.updateState_();\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.MeasureAzimut\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionDrawAzimut from 'ngeo/interaction/DrawAzimut.js';\nimport ngeoInteractionMeasure from 'ngeo/interaction/Measure.js';\nimport * as olBase from 'ol/index.js';\nimport olGeomGeometryCollection from 'ol/geom/GeometryCollection.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olProjProjection from 'ol/proj/Projection.js';\n\n/**\n * @classdesc\n * Interaction dedicated to measure length.\n *\n * See our live example: [../examples/measure.html](../examples/measure.html)\n *\n * @constructor\n * @struct\n * @fires ngeox.MeasureEvent\n * @extends {ngeo.interaction.Measure}\n * @param {!ngeox.unitPrefix} unitPrefixFormat The format function\n * @param {!ngeox.number} numberFormat The format function\n * @param {!ngeox.interaction.MeasureOptions=} options Options\n */\nconst exports = function(unitPrefixFormat, numberFormat, options = /** @type {ngeox.interaction.MeasureOptions} */({})) {\n\n  ngeoInteractionMeasure.call(this, /** @type {ngeo.interaction.MeasureBaseOptions} */ (options));\n\n\n  /**\n   * Message to show after the first point is clicked.\n   * @type {Element}\n   */\n  this.continueMsg;\n  if (options.continueMsg !== undefined) {\n    this.continueMsg = options.continueMsg;\n  } else {\n    this.continueMsg = document.createElement('span');\n    this.continueMsg.textContent = 'Click to finish.';\n  }\n\n  /**\n   * The format function\n   * @type {ngeox.number}\n   */\n  this.numberFormat = googAsserts.assert(numberFormat);\n\n  /**\n   * The format function\n   * @type {ngeox.unitPrefix}\n   */\n  this.unitPrefixFormat = googAsserts.assert(unitPrefixFormat);\n\n};\n\nolBase.inherits(exports, ngeoInteractionMeasure);\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.createDrawInteraction = function(style,\n  source) {\n\n  return new ngeoInteractionDrawAzimut({\n    source,\n    style\n  });\n\n\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.handleMeasure = function(callback) {\n  const geom = googAsserts.assertInstanceof(this.sketchFeature.getGeometry(), olGeomGeometryCollection);\n  const line = googAsserts.assertInstanceof(geom.getGeometries()[0], olGeomLineString);\n  const output = exports.getFormattedAzimutRadius(\n    line, googAsserts.assertInstanceof(this.getMap().getView().getProjection(), olProjProjection),\n    this.decimals, this.precision, this.unitPrefixFormat, this.numberFormat);\n  callback(output, line.getLastCoordinate());\n};\n\n\n/**\n * Format measure output of azimut and radius.\n * @param {!ol.geom.LineString} line LineString.\n * @param {!ol.proj.Projection} projection Projection of the polygon coords.\n * @param {number|undefined} decimals Decimals.\n * @param {number|undefined} precision Precision.\n * @param {!ngeox.unitPrefix} formatLength The format function.\n * @param {!ngeox.number} formatAzimut The format function.\n * @return {string} Formatted measure.\n */\nexports.getFormattedAzimutRadius = function(\n  line, projection, decimals, precision, formatLength, formatAzimut) {\n\n  let output = exports.getFormattedAzimut(line, decimals, formatAzimut);\n\n  output += `, ${ngeoInteractionMeasure.getFormattedLength(\n    line, projection, precision, formatLength)}`;\n\n  return output;\n};\n\n\n/**\n * Format measure output of azimut.\n * @param {!ol.geom.LineString} line LineString.\n * @param {number|undefined} decimals Decimals.\n * @param {!ngeox.number} format The format function.\n * @return {string} Formatted measure.\n */\nexports.getFormattedAzimut = function(line, decimals, format) {\n  const azimut = exports.getAzimut(line);\n  return `${format(azimut, decimals)}°`;\n};\n\n\n/**\n * Compute azimut from a 2 points line.\n * @param {ol.geom.LineString} line LineString.\n * @return {number} Azimut value.\n */\nexports.getAzimut = function(line) {\n  const coords = line.getCoordinates();\n  const dx = coords[1][0] - coords[0][0];\n  const dy = coords[1][1] - coords[0][1];\n  const rad = Math.acos(dy / Math.sqrt(dx * dx + dy * dy));\n  const factor = dx > 0 ? 1 : -1;\n  return (factor * rad * 180 / Math.PI) % 360;\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.message.popupComponent\n */\n\nimport 'angular-sanitize';\n\n\nconst exports = angular.module('ngeoPopup', [\n  'ngSanitize',\n]);\n\n\nexports.value('ngeoPopupTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoPopupTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/message/popupcomponent';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/message/popupcomponent', require('./popupcomponent.html'));\n});\n\n\n/**\n * Provides a directive used to show a popup over the page with\n * a title and content.\n *\n *\n * Things to know about this directive:\n *\n * - This directive is intended to be used along with the popup service.\n *\n * - By default the directive uses \"popup.html\" as its templateUrl. This can be\n *   changed by redefining the \"ngeoPopupTemplateUrl\" value.\n *\n * - The directive doesn't create any scope but relies on its parent scope.\n *   Properties like 'content', 'title' or 'open' come from the parent scope.\n *\n * @private\n * @param {string} ngeoPopupTemplateUrl URL to popup template.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoPopup\n */\nexports.directive_ = function(ngeoPopupTemplateUrl) {\n  return {\n    restrict: 'A',\n    templateUrl: ngeoPopupTemplateUrl,\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n      element.addClass('popover');\n\n      /**\n       * @param {jQuery.Event} evt Event.\n       */\n      scope.close = function(evt) {\n        if (evt) {\n          evt.stopPropagation();\n          evt.preventDefault();\n        }\n        element.addClass('hidden');\n      };\n\n      // Watch the open property\n      scope.$watch('open', (newVal, oldVal) => {\n        element.css('display', newVal ? 'block' : 'none');\n      });\n    }\n  };\n};\n\nexports.directive('ngeoPopup', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.Popup\n */\nimport googAsserts from 'goog/asserts.js';\n\n/**\n * This goog.require is needed because of 'ngeo-popup' used in\n * the template.\n * @suppress {extraRequire}\n */\nimport ngeoMessagePopupComponent from 'ngeo/message/popupComponent.js';\n\n/**\n * Provides a factory to create a popup in the page.\n * The factory returns a ngeo.message.Popup object.\n *\n * Example:\n *\n *     let popup = ngeoCreatePopup();\n *     popup.setTitle(\"A title\");\n *     popup.setContent(\"Some content\");\n *     popup.setOpen(true);\n *\n * @constructor\n * @struct\n * @param {angular.$compile} $compile The compile provider.\n * @param {angular.Scope} $rootScope The rootScope provider.\n * @param {angular.$sce} $sce Angular sce service.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @ngdoc service\n * @ngname ngeoCreatePopup\n */\nconst exports = function($compile, $rootScope, $sce, $timeout) {\n\n  /**\n   * The scope the compiled element is link to.\n   * @type {angular.Scope}\n   * @export\n   */\n  this.scope = $rootScope.$new(true);\n\n  // manage the auto destruction of the popup\n  this.scope.$watch(\n    () => this.scope['open'],\n    (open) => {\n      if (!open && this.autoDestroy_) {\n        this.timeout_(() => {\n          this.destroy();\n        });\n      }\n    }\n  );\n\n  /**\n   * @private\n   * @type {angular.$sce}\n   */\n  this.sce_ = $sce;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * The element.\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.element_ = angular.element('<div ngeo-popup></div>');\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.autoDestroy_ = false;\n\n\n  // Compile the element, link it to the scope and add it to the document.\n  $compile(this.element_)(this.scope);\n  angular.element(document.body).append(this.element_);\n};\n\n\n/**\n * Get the current popup state.\n * @return {boolean} `true` if the popup is currently, otherwise `false`.\n * @export\n */\nexports.prototype.getOpen = function() {\n  return this.scope['open'];\n};\n\n\n/**\n * Show/hide the popup.\n * @param {boolean} open `true` to show the popup, `false` to hide it.\n * @export\n */\nexports.prototype.setOpen = function(open) {\n  this.scope['open'] = open;\n};\n\n\n/**\n * Destroy the popup.\n * @export\n */\nexports.prototype.destroy = function() {\n  this.scope.$destroy();\n  this.element_.remove();\n};\n\n\n/**\n * Set the popup's title.\n * @param {string} title The title.\n * @export\n */\nexports.prototype.setTitle = function(title) {\n  const trustedTitle = this.sce_.trustAsHtml(title);\n  this.scope['title'] = trustedTitle;\n};\n\n\n/**\n * Set the popup's content.\n * Note: the type of the `content` param is `*` instead of `string`, this\n * is because the content may be trusted using `$sce.trustAsHtml`.\n * @param {*} content The content.\n * @param {boolean=} opt_trusted Whether the content can be trusted.\n *     Default is false.\n * @export\n */\nexports.prototype.setContent = function(content, opt_trusted) {\n  this.scope['content'] = opt_trusted ? this.sce_.trustAsHtml(/** @type {string} */ (content)) : content;\n};\n\n\n/**\n * Set the popup's content with an iframe using the given url.\n * @param {string} url The url of the page.\n * @export\n */\nexports.prototype.setUrl = function(url) {\n  const content = this.sce_.trustAsHtml(\n    `<iframe src=\"${url}\" width=\"100%\" height=\"100%\"></iframe>`\n  );\n  this.setContent(content);\n};\n\n\n/**\n * Set the popup's width.\n * @param {string} width Width the popup should have.\n * @export\n */\nexports.prototype.setWidth = function(width) {\n  this.element_.width(width);\n};\n\n\n/**\n * Set the popup's height.\n * @param {string} height Height the popup should have.\n * @export\n */\nexports.prototype.setHeight = function(height) {\n  this.element_.height(height);\n};\n\n\n/**\n * Set the popup's width and height.\n * @param {string} width Width the popup should have.\n * @param {string} height Height the popup should have.\n * @export\n */\nexports.prototype.setSize = function(width, height) {\n  this.setWidth(width);\n  this.setHeight(height);\n};\n\n\n/**\n * Set the popup's autoDestroy property.\n * @param {boolean} autoDestroy Whether to automatically destroy the popup when\n *     being closed or not.\n * @export\n */\nexports.prototype.setAutoDestroy = function(autoDestroy) {\n  this.autoDestroy_ = autoDestroy;\n};\n\n\n/**\n * Add an extra CSS class name to the popup.\n * @param {string} cls Class name to add to the popup element.\n * @export\n */\nexports.prototype.addClass = function(cls) {\n  this.element_.addClass(cls);\n};\n\n\n/**\n * Open a popup with the given properties.\n * @param {ngeox.PopupOptions} options Options.\n * @export\n */\nexports.prototype.open = function(options) {\n\n  if (options.url) {\n    this.setUrl(options.url);\n  } else if (options.content) {\n    this.setContent(options.content);\n  } else {\n    googAsserts.fail('ngeo.message.Popup options requirest \"url\" or \"content\".');\n  }\n\n  if (options.autoDestroy !== undefined) {\n    this.setAutoDestroy(options.autoDestroy);\n  }\n\n  if (options.cls !== undefined) {\n    this.addClass(options.cls);\n  }\n\n  if (options.height !== undefined) {\n    this.setHeight(options.height);\n  }\n\n  if (options.title !== undefined) {\n    this.setTitle(options.title);\n  }\n\n  if (options.width !== undefined) {\n    this.setWidth(options.width);\n  }\n\n  this.setOpen(true);\n};\n\n\n/**\n * @param {angular.$compile} $compile Angular compile service.\n * @param {angular.Scope} $rootScope Angular rootScope service.\n * @param {angular.$sce} $sce Angular sce service.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @return {ngeox.PopupFactory} The function to create a popup.\n * @ngInject\n */\nexports.Factory = function($compile, $rootScope, $sce, $timeout) {\n  return (\n    /**\n     * @return {!ngeo.message.Popup} The popup instance.\n     */\n    function() {\n      return new exports($compile, $rootScope, $sce, $timeout);\n    }\n  );\n};\n\n/**\n * @type {angular.Module}\n */\nexports.module = angular.module('ngeoCreatePopup', [\n  ngeoMessagePopupComponent.name,\n]);\nexports.module.factory('ngeoCreatePopup', exports.Factory);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.FeatureOverlay\n */\nimport * as olEvents from 'ol/events.js';\n\n/**\n * @constructor\n * @param {ngeo.map.FeatureOverlayMgr} manager The feature overlay manager.\n * @param {number} index This feature overlay's index.\n */\nconst exports = function(manager, index) {\n\n  /**\n   * @type {ngeo.map.FeatureOverlayMgr}\n   * @private\n   */\n  this.manager_ = manager;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features_ = null;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.index_ = index;\n};\n\n\n/**\n * Add a feature to the feature overlay.\n * @param {ol.Feature} feature The feature to add.\n * @export\n */\nexports.prototype.addFeature = function(feature) {\n  this.manager_.addFeature(feature, this.index_);\n};\n\n\n/**\n * Remove a feature from the feature overlay.\n * @param {ol.Feature} feature The feature to remove.\n * @export\n */\nexports.prototype.removeFeature = function(feature) {\n  this.manager_.removeFeature(feature, this.index_);\n};\n\n\n/**\n * Remove all the features from the feature overlay.\n * @export\n */\nexports.prototype.clear = function() {\n  this.manager_.clear(this.index_);\n};\n\n\n/**\n * Configure this feature overlay with a feature collection. Features added\n * to the collection are also added to the overlay. Same for removal. If you\n * configure the feature overlay with a feature collection you will use the\n * collection to add and remove features instead of using the overlay's\n * `addFeature`, `removeFeature` and `clear` functions.\n * @param {ol.Collection.<ol.Feature>} features Feature collection.\n * @export\n */\nexports.prototype.setFeatures = function(features) {\n  if (this.features_ !== null) {\n    this.features_.clear();\n    olEvents.unlisten(this.features_, 'add', this.handleFeatureAdd_, this);\n    olEvents.unlisten(this.features_, 'remove', this.handleFeatureRemove_, this);\n  }\n  if (features !== null) {\n    features.forEach((feature) => {\n      this.addFeature(feature);\n    });\n    olEvents.listen(features, 'add', this.handleFeatureAdd_, this);\n    olEvents.listen(features, 'remove', this.handleFeatureRemove_, this);\n  }\n  this.features_ = features;\n};\n\n\n/**\n * Set a style for the feature overlay.\n * @param {ol.style.Style|Array.<ol.style.Style>|ol.StyleFunction} style\n * Style.\n * @export\n */\nexports.prototype.setStyle = function(style) {\n  this.manager_.setStyle(style, this.index_);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Feature collection event.\n * @private\n */\nexports.prototype.handleFeatureAdd_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.addFeature(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Feature collection event.\n * @private\n */\nexports.prototype.handleFeatureRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature(feature);\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoFeatureOverlay', []);\n\n\nexport default exports;\n","/**\n * @module ngeo.format.XSDAttribute\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoFormatAttribute from 'ngeo/format/Attribute.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport * as olBase from 'ol/index.js';\nimport olFormatXML from 'ol/format/XML.js';\n\n/**\n * @classdesc\n * Reads attributes that are defined in XSD format and return them as a list.\n *\n * @constructor\n * @struct\n * @extends {ol.format.XML}\n */\nconst exports = function() {\n  olFormatXML.call(this);\n};\n\nolBase.inherits(exports, olFormatXML);\n\n\n/**\n * @param {Document|Node|string} source Source.\n * @return {Array.<ngeox.Attribute>} The parsed result.\n * @override\n */\nexports.prototype.read = function(source) {\n  return (\n    /** @type {Array.<ngeox.Attribute>} */ olFormatXML.prototype.read.call(this, source)\n  );\n};\n\n\n/**\n * @param {Document} doc Document.\n * @return {Array.<ngeox.Attribute>} List of attributes.\n * @override\n */\nexports.prototype.readFromDocument = function(doc) {\n  googAsserts.assert(doc.nodeType == Node.DOCUMENT_NODE,\n    'doc.nodeType should be DOCUMENT');\n  for (let n = doc.firstChild; n; n = n.nextSibling) {\n    if (n.nodeType == Node.ELEMENT_NODE) {\n      return this.readFromNode(n);\n    }\n  }\n  return null;\n};\n\n\n/**\n * @param {Node} node Node.\n * @return {Array.<ngeox.Attribute>} List of attributes.\n * @override\n */\nexports.prototype.readFromNode = function(node) {\n  googAsserts.assert(node.nodeType == Node.ELEMENT_NODE,\n    'node.nodeType should be ELEMENT');\n  googAsserts.assert(node.localName == 'schema',\n    'localName should be schema');\n\n  let elements = node.getElementsByTagName('element');\n  if (!elements.length) {\n    elements = node.getElementsByTagName('xsd:element');\n  }\n  const attributes = [];\n\n  let attribute;\n  for (let i = 0, ii = elements.length; i < ii; i++) {\n    attribute = this.readFromElementNode_(elements[i]);\n    if (attribute) {\n      attributes.push(attribute);\n    }\n  }\n\n  return attributes;\n};\n\n\n/**\n * @param {Node} node Node.\n * @return {?ngeox.Attribute} An attribute object.\n * @private\n */\nexports.prototype.readFromElementNode_ = function(node) {\n\n  const name = node.getAttribute('name');\n  googAsserts.assertString(name, 'name should be defined in element node.');\n\n  const alias = node.getAttribute('alias');\n  const nillable = node.getAttribute('nillable');\n  const required = !(nillable === true || nillable === 'true');\n\n  const attribute = {\n    name,\n    alias,\n    required\n  };\n\n  const type = node.getAttribute('type');\n  if (type) {\n    if (!ngeoFormatAttribute.setGeometryType(attribute, type)) {\n      this.setAttributeByXsdType_(attribute, type);\n    }\n  } else {\n\n    // Attribute has no type defined on 'element' node.  Try:\n\n    // (1) Enumerations\n    let enumerations = node.getElementsByTagName('enumeration');\n    if (!enumerations.length) {\n      enumerations = node.getElementsByTagName('xsd:enumeration');\n    }\n    if (enumerations.length) {\n      attribute.type = ngeoFormatAttributeType.SELECT;\n      const choices = [];\n      for (let i = 0, ii = enumerations.length; i < ii; i++) {\n        choices.push(enumerations[i].getAttribute('value'));\n      }\n      attribute.choices = choices;\n    } else {\n      // (2) Other types with restrictions\n      let restrictions = node.getElementsByTagName('restriction');\n      if (!restrictions.length) {\n        restrictions = node.getElementsByTagName('xsd:restriction');\n      }\n      if (restrictions.length && restrictions[0]) {\n        const restrictionNode = restrictions[0];\n        this.setAttributeByXsdType_(\n          attribute,\n          restrictionNode.getAttribute('base')\n        );\n        // MaxLength\n        let maxLengths = node.getElementsByTagName('maxLength');\n        if (!maxLengths.length) {\n          maxLengths = node.getElementsByTagName('xsd:maxLength');\n        }\n        if (maxLengths.length && maxLengths[0]) {\n          attribute.maxLength = Number(maxLengths[0].getAttribute('value'));\n        }\n      }\n    }\n  }\n\n  if (!attribute.type) {\n    return null;\n  }\n\n  googAsserts.assert(attribute.type);\n\n  return attribute;\n};\n\n\n/**\n * Set the `type` and `numType` properties of an attribute depending on the\n * given xsdType.\n *\n * @param {ngeox.AttributeBase} attribute Attribute.\n * @param {string} type The xsd type.\n * @private\n */\nexports.prototype.setAttributeByXsdType_ = function(\n  attribute, type\n) {\n  if (type === 'xsd:boolean') {\n    attribute.type = ngeoFormatAttributeType.BOOLEAN;\n  } else if (type === 'xsd:date') {\n    attribute.type = ngeoFormatAttributeType.DATE;\n  } else if (type === 'xsd:dateTime') {\n    attribute.type = ngeoFormatAttributeType.DATETIME;\n  } else if (type === 'xsd:time') {\n    attribute.type = ngeoFormatAttributeType.TIME;\n  } else if (type === 'xsd:decimal' || type === 'xsd:double') {\n    attribute.type = ngeoFormatAttributeType.NUMBER;\n    attribute.numType = exports.NumberType.FLOAT;\n  } else if (type === 'xsd:integer') {\n    attribute.type = ngeoFormatAttributeType.NUMBER;\n    attribute.numType = exports.NumberType.INTEGER;\n  } else if (type === 'xsd:string') {\n    attribute.type = ngeoFormatAttributeType.TEXT;\n  }\n};\n\n\n/**\n * Returns the first geometry attribute among a given list of attributes.\n * @param {Array.<ngeox.Attribute>} attributes The list of attributes.\n * @return {?ngeox.Attribute} A geometry attribute object.\n */\nexports.getGeometryAttribute = function(attributes) {\n  let geomAttribute = null;\n  for (let i = 0, ii = attributes.length; i < ii; i++) {\n    if (attributes[i].type === ngeoFormatAttributeType.GEOMETRY) {\n      geomAttribute = attributes[i];\n      break;\n    }\n  }\n  return geomAttribute;\n};\n\n\n/**\n * @enum {string}\n * @export\n */\nexports.NumberType = {\n  /**\n   * @type {string}\n   * @export\n   */\n  FLOAT: 'float',\n  /**\n   * @type {string}\n   * @export\n   */\n  INTEGER: 'integer'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.Group\n */\nimport googAsserts from 'goog/asserts.js';\nimport olCollection from 'ol/Collection.js';\n\nconst exports = class {\n\n  /**\n   * A Group data source combines multiple `ngeo.datasource.DataSource` objects.\n   * Its main purpose is to provide a calculated `visibilityState` property\n   * that can be used to determine if all its data source are all visible, all\n   * hidden or some are hidden and other visible.\n   *\n   * @struct\n   * @param {ngeox.datasource.GroupOptions} options Options.\n   */\n  constructor(options) {\n\n    // === DYNAMIC properties (i.e. that can change / be watched ===\n\n    /**\n     * @type {!ol.Collection.<!ngeo.datasource.DataSource>}\n     * @protected\n     */\n    this.dataSourcesCollection_ = new olCollection(options.dataSources);\n\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * @type {string}\n     * @private\n     */\n    this.title_ = options.title;\n  }\n\n  /**\n   * @export\n   */\n  destroy() {\n    this.dataSourcesCollection_.clear();\n  }\n\n  // ========================================\n  // === Dynamic property getters/setters ===\n  // ========================================\n\n  /**\n   * @return {!Array.<!ngeo.datasource.DataSource>} Data sources\n   * @export\n   */\n  get dataSources() {\n    return this.dataSourcesCollection_.getArray();\n  }\n\n\n  /**\n   * @return {!ol.Collection.<!ngeo.datasource.DataSource>} Data sources\n   * @export\n   */\n  get dataSourcesCollection() {\n    return this.dataSourcesCollection_;\n  }\n\n\n  // =======================================\n  // === Static property getters/setters ===\n  // =======================================\n\n  /**\n   * @return {string} Title\n   * @export\n   */\n  get title() {\n    return this.title_;\n  }\n\n\n  // ===================================\n  // === Calculated property getters ===\n  // ===================================\n\n  /**\n   * @return {string} Visibility state\n   * @export\n   */\n  get visibilityState() {\n    let state;\n\n    for (const dataSource of this.dataSources) {\n      if (state === undefined) {\n        state = this.getDataSourceState(dataSource);\n      } else {\n        const otherState = this.getDataSourceState(dataSource);\n        if (otherState !== state) {\n          state = exports.VisibilityState.INDETERMINATE;\n        }\n      }\n      if (state === exports.VisibilityState.INDETERMINATE) {\n        break;\n      }\n    }\n\n    googAsserts.assertString(state);\n\n    return state;\n  }\n\n\n  // =======================\n  // === Utility Methods ===\n  // =======================\n\n  /**\n   * @param {!ngeo.datasource.DataSource} dataSource Data source.\n   * @return {string} Visible state of a data source\n   * @export\n   */\n  getDataSourceState(dataSource) {\n    return dataSource.visible ?\n      exports.VisibilityState.ON :\n      exports.VisibilityState.OFF;\n  }\n\n  /**\n   * @param {!ngeo.datasource.DataSource} dataSource Data source to add.\n   * @export\n   */\n  addDataSource(dataSource) {\n    this.dataSourcesCollection_.push(dataSource);\n  }\n\n  /**\n   * @param {!ngeo.datasource.DataSource} dataSource Data source to remove.\n   * @export\n   */\n  removeDataSource(dataSource) {\n    this.dataSourcesCollection_.remove(dataSource);\n  }\n\n  /**\n   * Update visible property of all data sources depending on the current\n   * visibility state:\n   *\n   * - state ON --> visible false\n   * - state OFF --> visible true\n   * - state IND. --> visible true\n   *\n   * @export\n   */\n  toggleVisibilityState() {\n    const visibleToSet =\n        this.visibilityState !== exports.VisibilityState.ON;\n    for (const dataSource of this.dataSources) {\n      if (dataSource.visible !== visibleToSet) {\n        dataSource.visible = visibleToSet;\n      }\n    }\n  }\n};\n\n\n/**\n * @enum {string}\n */\nexports.VisibilityState = {\n  INDETERMINATE: 'indeterminate',\n  OFF: 'off',\n  ON: 'on'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.WFSDescribeFeatureType\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olBase from 'ol/index.js';\nimport olFormatXML from 'ol/format/XML.js';\nimport * as olXml from 'ol/xml.js';\n\n/**\n * @classdesc\n * Format for reading WFS DescribeFeatureType data.\n *\n * @constructor\n * @extends {ol.format.XML}\n * @api\n */\nconst exports = function() {\n\n  olFormatXML.call(this);\n\n};\n\nolBase.inherits(exports, olFormatXML);\n\n\n/**\n * Read a WFS DescribeFeatureType document.\n *\n * @function\n * @param {Document|Node|string} source The XML source.\n * @return {Object} An object representing the WFS DescribeFeatureType.\n * @api\n */\nexports.prototype.read;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.readFromDocument = function(doc) {\n  for (let n = doc.firstChild; n; n = n.nextSibling) {\n    if (n.nodeType == Node.ELEMENT_NODE) {\n      return this.readFromNode(n);\n    }\n  }\n  return null;\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.readFromNode = function(node) {\n  let result = {};\n  result = olXml.pushParseAndPop(\n    result,\n    exports.PARSERS_,\n    node,\n    []\n  );\n  return result;\n};\n\n\n/**\n * @private\n * @param {Node} node Node.\n * @param {Array.<*>} objectStack Object stack.\n * @return {!Object.<string, string>} Attributes.\n */\nexports.readElement_ = function(node, objectStack) {\n  const attributes = {};\n  for (let i = 0, len = node.attributes.length; i < len; i++) {\n    const attribute = node.attributes.item(i);\n    attributes[attribute.name] = attribute.value;\n  }\n  if (objectStack.length === 1) {\n    // remove namespace from type\n    attributes['type'] = attributes['type'].split(':').pop();\n  }\n  return attributes;\n};\n\n\n/**\n * @private\n * @param {Node} node Node.\n * @param {Array.<*>} objectStack Object stack.\n * @return {!Object.<string, string>} Object.\n */\nexports.readComplexType_ = function(node, objectStack) {\n  const name = node.getAttribute('name');\n  const object = olXml.pushParseAndPop(\n    {'name': name},\n    exports.COMPLEX_TYPE_PARSERS_,\n    node, objectStack\n  );\n  // flatten\n  object['complexContent'] =\n    object['complexContent']['extension']['sequence']['element'];\n  return object;\n};\n\n\n/**\n * @private\n * @param {Node} node Node.\n * @param {Array.<*>} objectStack Object stack.\n * @return {!Object.<string, string>} Object.\n */\nexports.readComplexContent_ = function(\n  node, objectStack\n) {\n  return olXml.pushParseAndPop(\n    {},\n    exports.COMPLEX_CONTENT_PARSERS_,\n    node,\n    objectStack\n  );\n};\n\n\n/**\n * @private\n * @param {Node} node Node.\n * @param {Array.<*>} objectStack Object stack.\n * @return {!Object.<string, string>} Object.\n */\nexports.readExtension_ = function(node, objectStack) {\n  return olXml.pushParseAndPop(\n    {},\n    exports.EXTENSION_PARSERS_,\n    node,\n    objectStack\n  );\n};\n\n\n/**\n * @private\n * @param {Node} node Node.\n * @param {Array.<*>} objectStack Object stack.\n * @return {!Object.<string, string>} Object.\n */\nexports.readSequence_ = function(node, objectStack) {\n  return olXml.pushParseAndPop(\n    {},\n    exports.SEQUENCE_PARSERS_,\n    node,\n    objectStack\n  );\n};\n\n\n/**\n * @const\n * @private\n * @type {Array.<string>}\n */\nexports.NAMESPACE_URIS_ = [\n  null,\n  'http://www.w3.org/2001/XMLSchema'\n];\n\n\n/**\n * @const\n * @type {!Object.<string, !Object.<string, !ol.XmlParser>>}\n * @private\n */\nexports.PARSERS_ = googAsserts.assert(olXml.makeStructureNS(\n  exports.NAMESPACE_URIS_, {\n    'element': olXml.makeObjectPropertyPusher(\n      exports.readElement_\n    ),\n    'complexType': olXml.makeObjectPropertyPusher(\n      exports.readComplexType_\n    )\n  }));\n\n\n/**\n * @const\n * @type {!Object.<string, !Object.<string, !ol.XmlParser>>}\n * @private\n */\nexports.COMPLEX_TYPE_PARSERS_ = googAsserts.assert(olXml.makeStructureNS(\n  exports.NAMESPACE_URIS_, {\n    'complexContent': olXml.makeObjectPropertySetter(\n      exports.readComplexContent_\n    )\n  }));\n\n\n/**\n * @const\n * @type {!Object.<string, !Object.<string, !ol.XmlParser>>}\n * @private\n */\nexports.COMPLEX_CONTENT_PARSERS_ = googAsserts.assert(olXml.makeStructureNS(\n  exports.NAMESPACE_URIS_, {\n    'extension': olXml.makeObjectPropertySetter(\n      exports.readExtension_\n    )\n  }));\n\n\n/**\n * @const\n * @type {!Object.<string, !Object.<string, !ol.XmlParser>>}\n * @private\n */\nexports.EXTENSION_PARSERS_ = googAsserts.assert(olXml.makeStructureNS(\n  exports.NAMESPACE_URIS_, {\n    'sequence': olXml.makeObjectPropertySetter(\n      exports.readSequence_\n    )\n  }));\n\n\n/**\n * @const\n * @type {!Object.<string, !Object.<string, !ol.XmlParser>>}\n * @private\n */\nexports.SEQUENCE_PARSERS_ = googAsserts.assert(olXml.makeStructureNS(\n  exports.NAMESPACE_URIS_, {\n    'element': olXml.makeObjectPropertyPusher(\n      exports.readElement_\n    )\n  }));\n\n\nexport default exports;\n","/**\n * @module ngeo.query.Querent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\nimport ngeoFilterRuleHelper from 'ngeo/filter/RuleHelper.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\nimport olFormatWFS from 'ol/format/WFS.js';\nimport ngeoWFSDescribeFeatureType from 'ngeo/WFSDescribeFeatureType.js';\nimport olFormatWMSCapabilities from 'ol/format/WMSCapabilities.js';\nimport olFormatWMTSCapabilities from 'ol/format/WMTSCapabilities.js';\nimport * as olObj from 'ol/obj.js';\nimport * as olUri from 'ol/uri.js';\nimport * as olExtent from 'ol/extent.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\n\nconst exports = class {\n\n  /**\n   * The ngeo Querent is a service that issues all sorts of queries using\n   * ngeo data sources. It does not store the result. Instead, it returns it\n   * using promises. Any component that inject this service can use it to\n   * make it issue its own queries and do whatever it wants with the result.\n   *\n   * It supports sending OGC requests and parse the response, such as:\n   * - WFS DescribeFeatureType\n   * - WFS GetFeature\n   * - WMS GetCapabilites\n   * - WMS GetFeatureInfo\n   * - WMTS GetCapabilities\n   *\n   * @struct\n   * @param {angular.$http} $http Angular $http service.\n   * @param {angular.$q} $q The Angular $q service.\n   * @param {!ngeo.filter.RuleHelper} ngeoRuleHelper Ngeo rule helper service.\n   * @param {!ngeo.misc.WMSTime} ngeoWMSTime wms time service.\n   * @ngdoc service\n   * @ngname ngeoQuerent\n   * @ngInject\n   */\n  constructor($http, $q, ngeoRuleHelper, ngeoWMSTime) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {angular.$http}\n     * @private\n     */\n    this.http_ = $http;\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.q_ = $q;\n\n    /**\n     * @type {!ngeo.filter.RuleHelper}\n     * @private\n     */\n    this.ngeoRuleHelper_ = ngeoRuleHelper;\n\n    /**\n     * @type {!ngeo.misc.WMSTime}\n     * @private\n     */\n    this.ngeoWMSTime_ = ngeoWMSTime;\n\n\n    // === Other properties ===\n\n    /**\n     * Promises that can be resolved to cancel started requests.\n     * @type {!Array.<angular.$q.Deferred>}\n     * @private\n     */\n    this.requestCancelers_ = [];\n\n    /**\n     * Cache of promises for WMS GetCapabilities requests. They key is the\n     * online resource base url that is used to do the query.\n     * @type {!Object.<!angular.$q.Promise>}\n     * @private\n     */\n    this.wmsGetCapabilitiesPromises_ = {};\n\n    /**\n     * Cache of promises for WMST GetCapabilities requests. They key is the\n     * url that is used to do the query.\n     * @type {!Object.<!angular.$q.Promise>}\n     * @private\n     */\n    this.wmtsGetCapabilitiesPromises_ = {};\n  }\n\n\n  // === PUBLIC methods ===\n\n  /**\n   * Issue WMS GetFeatureInfo and/or WFS GetFeature requests using the given\n   * data sources, map and optional filters.\n   *\n   * @param {ngeox.IssueGetFeaturesOptions} options Options.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  issue(options) {\n\n    const promises = [];\n    const map = options.map;\n\n    // (1) Cancel requests that are still running\n    this.cancelStillRunningRequests_();\n\n    // (2) Get queryable data sources\n    let queryableDataSources;\n    if (options.queryableDataSources) {\n      queryableDataSources = options.queryableDataSources;\n    } else {\n      const dataSources = options.dataSources;\n      googAsserts.assert(dataSources, 'DataSources should be set');\n      queryableDataSources = this.getQueryableDataSources(dataSources, map);\n    }\n\n    // (3) Combine data sources that support WFS and issue WFS queries.\n    //     The 'bbox' ('extent' option) is not required for WFS requests to\n    //     be issued.\n    const combinedWFSDataSources = this.getCombinableWFSDataSources_(\n      queryableDataSources.wfs);\n    promises.push(this.issueCombinedWFS_(combinedWFSDataSources, options));\n\n    // (4) Combine data sources that support WMS and issue WMS queries.\n    //     Only occurs if the `coordinate` option is set, because it's required\n    //     by WMS GetFeatureInfo requests.\n    const coordinate = options.coordinate;\n    if (coordinate) {\n      const combinedWMSDataSources = this.getCombinableWMSDataSources_(\n        queryableDataSources.wms);\n      promises.push(this.issueCombinedWMS_(combinedWMSDataSources, options));\n    }\n\n    return this.q_.all(promises).then(\n      this.handleCombinedQueryResult_.bind(this)\n    );\n  }\n\n  /**\n   * Browse a given list of data sources. Return 2 lists of data sources that\n   * are queryable, the first one being those that support WFS and the other\n   * WMS only. This means that WFS is always favored first, then WMS.\n   *\n   * The map view resolution determines if the inner ogc layers are in range.\n   *\n   * @param {!Array.<!ngeo.datasource.DataSource>} dataSources Data sources\n   * @param {ol.Map} map Map.\n   * @return {!ngeox.QueryableDataSources} Queryable data sources.\n   * @export\n   */\n  getQueryableDataSources(dataSources, map) {\n\n    const queryableDataSources = {\n      wfs: [],\n      wms: []\n    };\n    const resolution = googAsserts.assertNumber(map.getView().getResolution());\n\n    for (const dataSource of dataSources) {\n\n      // (1) Skip data source that can't be queried\n      if (!this.isDataSourceQueryable_(dataSource, resolution)) {\n        continue;\n      }\n\n      if (dataSource instanceof ngeoDatasourceOGC) {\n        // (2) Split data sources\n        if (dataSource.supportsWFS) {\n          queryableDataSources.wfs.push(dataSource);\n        } else {\n          queryableDataSources.wms.push(dataSource);\n        }\n      }\n    }\n\n    return queryableDataSources;\n  }\n\n  /**\n   * @param {ngeo.datasource.OGC} dataSource Data source.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  wfsDescribeFeatureType(dataSource) {\n\n    googAsserts.assert(\n      dataSource.supportsAttributes,\n      `The data source must support WFS, have a single OGCLayer that\n      is queryable in order to issue WFS DescribeFeatureType requests`\n    );\n\n    const ogcLayerNames = dataSource.getOGCLayerNames();\n\n    const url = olUri.appendParams(\n      googAsserts.assertString(dataSource.wfsUrl),\n      {\n        'REQUEST': 'DescribeFeatureType',\n        'SERVICE': 'WFS',\n        'VERSION': '2.0.0',\n        'TYPENAME': ogcLayerNames\n      }\n    );\n\n    return this.http_.get(url).then((response) => {\n      const format = new ngeoWFSDescribeFeatureType();\n      return format.read(response.data);\n    });\n  }\n\n  /**\n   * @param {!Array.<!Object>} layerCapabilities List of WMS layer capabilities\n   * @param {string} layerName Name of the WMS layer\n   * @return {?Object} Found WMS layer capability\n   * @export\n   */\n  wmsFindLayerCapability(layerCapabilities, layerName) {\n\n    let found = null;\n\n    for (const layerCapability of layerCapabilities) {\n      if (layerCapability['Name'] === layerName) {\n        found = layerCapability;\n        break;\n      } else if (layerCapability['Layer']) {\n        found = this.wmsFindLayerCapability(\n          layerCapability['Layer'], layerName);\n        if (found) {\n          break;\n        }\n      }\n    }\n\n    return found;\n  }\n\n  /**\n   * @param {string} baseUrl Base url of the WMS server.\n   * @param {boolean=} opt_cache Whether to use the cached capability, if\n   *     available. Enabling this will also store the capability when required\n   *     for the first time. Defaults to: `true`.\n   * @return {!angular.$q.Promise} Promise.\n   * @export\n   */\n  wmsGetCapabilities(baseUrl, opt_cache) {\n\n    const cache = opt_cache !== false;\n\n    const params = {\n      'REQUEST': 'GetCapabilities',\n      'SERVICE': 'WMS',\n      'VERSION': '1.3.0'\n    };\n\n    const url = olUri.appendParams(baseUrl, params);\n    let promise;\n\n    if (!cache || !this.wmsGetCapabilitiesPromises_[baseUrl]) {\n      promise = this.http_.get(url).then((response) => {\n        const format = new olFormatWMSCapabilities();\n        return format.read(response.data);\n      });\n    } else if (cache && this.wmsGetCapabilitiesPromises_[baseUrl]) {\n      promise = this.wmsGetCapabilitiesPromises_[baseUrl];\n    }\n\n    googAsserts.assert(promise);\n\n    if (cache && !this.wmsGetCapabilitiesPromises_[baseUrl]) {\n      this.wmsGetCapabilitiesPromises_[baseUrl] = promise;\n    }\n\n    return promise;\n  }\n\n  /**\n   * @param {!Array.<!Object>} layerCapabilities List of WMTS layer capabilities\n   * @param {string} layerName Name of the WMTS layer, a.k.a. the identifier.\n   * @return {?Object} Found WTMS layer capability\n   * @export\n   */\n  wmtsFindLayerCapability(layerCapabilities, layerName) {\n    let found = null;\n    for (const layerCapability of layerCapabilities) {\n      if (layerCapability['Identifier'] === layerName) {\n        found = layerCapability;\n        break;\n      }\n    }\n    return found;\n  }\n\n  /**\n   * @param {string} url Url of the WMTS server. Note that it must contain\n   *     all required arguments.\n   * @param {boolean=} opt_cache Whether to use the cached capability, if\n   *     available. Enabling this will also store the capability when required\n   *     for the first time. Defaults to: `true`.\n   * @return {!angular.$q.Promise} Promise.\n   * @export\n   */\n  wmtsGetCapabilities(url, opt_cache) {\n\n    const cache = opt_cache !== false;\n    let promise;\n\n    if (!cache || !this.wmtsGetCapabilitiesPromises_[url]) {\n      promise = this.http_.get(url).then((response) => {\n        const format = new olFormatWMTSCapabilities();\n        return format.read(response.data);\n      });\n    } else if (cache && this.wmtsGetCapabilitiesPromises_[url]) {\n      promise = this.wmtsGetCapabilitiesPromises_[url];\n    }\n\n    googAsserts.assert(promise);\n\n    if (cache && !this.wmtsGetCapabilitiesPromises_[url]) {\n      this.wmtsGetCapabilitiesPromises_[url] = promise;\n    }\n\n    return promise;\n  }\n\n\n  // === PRIVATE methods ===\n\n  /**\n   * Handles the response of multiple promises that did either\n   * WMS GetFeatureInfo or WFS GetFeature requests, in which the result is\n   * a hash with key being the data source id and value the array of features.\n   *\n   * The response object itself is an array, one item being one result per\n   * promise. The idea is to return a single hash by combining the result\n   * objects.\n   *\n   * The keys are always unique, i.e. there can be multiple result objects for\n   * the same data source id.\n   *\n   * @param {!Array.<ngeox.QuerentResult>} response Response.\n   * @return {ngeox.QuerentResult} Hash of features by data source ids.\n   * @private\n   */\n  handleCombinedQueryResult_(response) {\n    const combinedHash = {};\n    for (const hash of response) {\n      for (const dataSourceIdStr in hash) {\n        const dataSourceId = Number(dataSourceIdStr);\n        combinedHash[dataSourceId] = hash[dataSourceId];\n      }\n    }\n    return combinedHash;\n  }\n\n\n  /**\n   * Handles the result of a single WMS GetFeatureInfo or WFS GetFeature\n   * request. Read features from the response and return them.\n   *\n   * @param {!Array.<!ngeo.datasource.OGC>} dataSources List of\n   *     queryable data sources that were used to do the query.\n   * @param {number} limit The maximum number of features to get with the query.\n   * @param {boolean} wfs Whether the query was WFS or WMS.\n   * @param {angular.$http.Response|number} response Response.\n   * @return {ngeox.QuerentResult} Hash of features by data source ids.\n   * @private\n   */\n  handleQueryResult_(dataSources, limit, wfs, response) {\n    const hash = {};\n\n    for (const dataSource of dataSources) {\n      let features;\n      let tooManyFeatures;\n      let totalFeatureCount;\n\n      if (typeof response === 'number') {\n        features = [];\n        tooManyFeatures = true;\n        totalFeatureCount = response;\n      } else {\n        if (dataSource instanceof ngeoDatasourceOGC) {\n          features = this.readAndTypeFeatures_(dataSource, response.data, wfs);\n        } else {\n          features = [];\n        }\n      }\n      const dataSourceId = dataSource.id;\n      this.setUniqueIds_(features, dataSource.id);\n      hash[dataSourceId] = {\n        features,\n        limit,\n        tooManyFeatures,\n        totalFeatureCount\n      };\n    }\n\n    return hash;\n  }\n\n  /**\n   * Read and assign the type of the feature to each feature in the data.\n   * The type will be stocked in the properties of the features as\n   * \"ngeo_feature_type_\".\n   * @param {ngeo.datasource.OGC} dataSource used to read the features.\n   * @param {Document | Node | Object | string} data the response data.\n   * @param {boolean} wfs Whether the query was WFS or WMS.\n   * @return {Array.<ol.Feature>} returned features with a type in each features.\n   * @private\n   */\n  readAndTypeFeatures_(dataSource, data, wfs) {\n    const features = [];\n    let readFeatures;\n    // Copy the types to be able to set it AND iterate on it.\n    const featureTypes = this.getSetOlFormatTypes_(dataSource, wfs).slice();\n    featureTypes.forEach((type) => {\n      // Assign temporarily a single feature type to read features separately.\n      this.getSetOlFormatTypes_(dataSource, wfs, [type]);\n      if (wfs) {\n        readFeatures = dataSource.wfsFormat.readFeatures(data);\n      } else {\n        readFeatures = dataSource.wmsFormat.readFeatures(data);\n      }\n      if (readFeatures.length > 0) {\n        readFeatures.forEach((feature) => {\n          feature.set('ngeo_feature_type_', type);\n          features.push(feature);\n        });\n      }\n    });\n    // Re-set the value to the datasource.xxxFormat to be able to re-use\n    // it later (in another query);\n    this.getSetOlFormatTypes_(dataSource, wfs, featureTypes);\n    return features;\n  }\n\n  /**\n   * Return the types defined in the format of the datasource. Can set the\n   * types if one is given.\n   * @param {ngeo.datasource.OGC} dataSource that contains the format object.\n   * @param {boolean} wfs Whether the query was WFS or WMS.\n   * @param {Array.<string>=} opt_types An array of type if you want to set the\n   *     type of the format object.\n   * @return {Array.<string>} The types defined in the format.\n   * @private\n   */\n  getSetOlFormatTypes_(dataSource, wfs, opt_types) {\n    let types;\n    if (wfs) {\n      if (opt_types) {\n        dataSource.wfsFormat.setFeatureType(opt_types);\n      }\n      types = dataSource.wfsFormat.getFeatureType();\n    } else {\n      if (opt_types) {\n        dataSource.wmsFormat.setLayers(opt_types);\n      }\n      types = dataSource.wmsFormat.getLayers();\n    }\n    if (!types) {\n      return [];\n    }\n    return (Array.isArray(types)) ? types : [types];\n  }\n\n  /**\n   * Issue WFS GetFeature requests using the given combined data sources, map\n   * and optional filters.\n   *\n   * @param {!ngeo.query.Querent.CombinedDataSources} combinedDataSources Combined\n   *     data sources.\n   * @param {ngeox.IssueGetFeaturesOptions} options Options.\n   * @return {angular.$q.Promise} Promise.\n   * @private\n   */\n  issueCombinedWFS_(combinedDataSources, options) {\n\n    const promises = [];\n\n    // The 'limit' option is mandatory in the querent service\n    const maxFeatures = googAsserts.assertNumber(options.limit);\n\n    const map = options.map;\n    const view = map.getView();\n    const resolution = googAsserts.assertNumber(view.getResolution());\n    const projection = view.getProjection();\n    const srsName = projection.getCode();\n    const wfsCount = options.wfsCount === true;\n\n    // (1) Extent (bbox), which is optional, i.e. its value can stay undefined\n    let bbox;\n    const coordinate = options.coordinate;\n    if (coordinate) {\n      const tolerancePx = options.tolerancePx;\n      googAsserts.assert(tolerancePx);\n      const tolerance = tolerancePx * resolution;\n      bbox = olExtent.buffer(\n        olExtent.createOrUpdateFromCoordinate(coordinate),\n        tolerance\n      );\n    } else {\n      bbox = options.extent;\n    }\n\n    // (2) Launch one request per combinaison of data sources\n    const wfsFormat = new olFormatWFS();\n    const xmlSerializer = new XMLSerializer();\n    for (const dataSources of combinedDataSources) {\n\n      let getFeatureCommonOptions;\n      let featureNS;\n      let featureTypes = [];\n      let url;\n      const params = {};\n\n      if (options.bboxAsGETParam && bbox) {\n        params['bbox'] = bbox.join(',');\n      }\n\n      // (3) Build query options\n      for (const dataSource of dataSources) {\n\n        // (a) Create common options, if not done yet\n        if (!getFeatureCommonOptions) {\n          featureNS = dataSource.wfsFeatureNS;\n          const featurePrefix = dataSource.wfsFeaturePrefix;\n          const geometryName = dataSource.geometryName;\n          const outputFormat = dataSource.wfsOutputFormat;\n\n          getFeatureCommonOptions = {\n            bbox,\n            featureNS,\n            featurePrefix,\n            geometryName,\n            outputFormat,\n            srsName\n          };\n\n          url = dataSource.wfsUrl;\n\n          // All data sources combined share the same active dimensions\n          olObj.assign(params, dataSource.activeDimensions);\n        }\n\n        // (b) Add queryable layer names in featureTypes array\n        featureTypes = featureTypes.concat(\n          dataSource.getInRangeOGCLayerNames(resolution, true));\n\n        // (c) Add filter, if any. If the case, then only one data source\n        //     is expected to be used for this request.\n        let filter;\n        if (options.filter) {\n          filter = this.ngeoRuleHelper_.createFilter({\n            dataSource: dataSource,\n            filter: options.filter,\n            incDimensions: true,\n            incTime: true\n          });\n        } else if ((dataSource.filterRules && dataSource.filterRules.length) ||\n            dataSource.timeRangeValue ||\n            (dataSource.dimensionsFiltersConfig && Object.keys(dataSource.dimensionsFiltersConfig).length > 0)) {\n\n          googAsserts.assert(\n            dataSources.length === 1,\n            `A data source having filterRules or timeRangeValue should issue\n            a single query, alone.`\n          );\n\n          filter = this.ngeoRuleHelper_.createFilter({\n            dataSource: dataSource,\n            incDimensions: true,\n            incTime: true,\n            srsName: srsName\n          });\n        }\n\n        if (filter) {\n          getFeatureCommonOptions['filter'] = filter;\n        }\n      }\n\n      googAsserts.assert(getFeatureCommonOptions);\n      getFeatureCommonOptions.featureTypes = featureTypes;\n      googAsserts.assert(url);\n\n      // (4) Build query then launch\n      //\n      //     If we require to do a WFS GetFeature request with\n      //     `resultType: 'hits'` first, do so. In that case, if there would\n      //     be too many features returned, no GetFeature is done thereafter\n      //     and the data sources will return empty arrays in the returned\n      //     response.\n      //\n      //     If we do not need to count features first, then proceed with\n      //     an normal WFS GetFeature request.\n      const getFeatureDefer = this.q_.defer();\n      promises.push(\n        getFeatureDefer.promise.then(\n          this.handleQueryResult_.bind(this, dataSources, maxFeatures, true)\n        )\n      );\n\n      // (4.1) Count, if required\n      let countPromise;\n      if (wfsCount) {\n        const getCountOptions = /** @type {olx.format.WFSWriteGetFeatureOptions} */ (\n          olObj.assign(\n            {\n              resultType: 'hits'\n            },\n            getFeatureCommonOptions\n          )\n        );\n        const featureCountXml = wfsFormat.writeGetFeature(getCountOptions);\n        const featureCountRequest = xmlSerializer.serializeToString(\n          featureCountXml);\n        const canceler = this.registerCanceler_();\n        countPromise = this.http_.post(\n          url,\n          featureCountRequest,\n          {\n            params: params,\n            headers: {'Content-Type': 'text/xml; charset=UTF-8'},\n            timeout: canceler.promise\n          }\n        ).then(((response) => {\n          const meta = dataSources[0].wfsFormat.readFeatureCollectionMetadata(\n            response.data\n          );\n          return meta['numberOfFeatures'];\n        }).bind(this));\n      } else {\n        countPromise = this.q_.resolve();\n      }\n\n      // (4.2) After count, do GetFeature (if required)\n      countPromise.then((numberOfFeatures) => {\n        // `true` is returned if a count request was made AND there would\n        // be too many features.\n        if (numberOfFeatures === undefined || numberOfFeatures < maxFeatures) {\n\n          const getFeatureOptions = /** @type {olx.format.WFSWriteGetFeatureOptions} */ (\n            olObj.assign(\n              {\n                maxFeatures\n              },\n              getFeatureCommonOptions\n            )\n          );\n          const featureRequestXml = wfsFormat.writeGetFeature(\n            getFeatureOptions);\n          const featureRequest = xmlSerializer.serializeToString(\n            featureRequestXml);\n          googAsserts.assertString(url);\n          const canceler = this.registerCanceler_();\n          this.http_.post(\n            url,\n            featureRequest,\n            {\n              params: params,\n              headers: {'Content-Type': 'text/xml; charset=UTF-8'},\n              timeout: canceler.promise\n            }\n          ).then((response) => {\n            getFeatureDefer.resolve(response);\n          });\n\n        } else {\n          getFeatureDefer.resolve(numberOfFeatures);\n        }\n      });\n    }\n\n    return this.q_.all(promises).then(\n      this.handleCombinedQueryResult_.bind(this)\n    );\n  }\n\n  /**\n   * Issue WMS GetFeatureInfo requests using the given combined data sources,\n   * map and optional filters.\n   *\n   * @param {!ngeo.query.Querent.CombinedDataSources} combinedDataSources Combined\n   *     data sources.\n   * @param {ngeox.IssueGetFeaturesOptions} options Options.\n   * @return {angular.$q.Promise} Promise.\n   * @private\n   */\n  issueCombinedWMS_(combinedDataSources, options) {\n\n    const promises = [];\n\n    // The 'limit' option is mandatory in the querent service\n    const FEATURE_COUNT = googAsserts.assertNumber(options.limit);\n\n    const map = options.map;\n    const view = map.getView();\n    const resolution = googAsserts.assertNumber(view.getResolution());\n    const projection = view.getProjection();\n    const projCode = projection.getCode();\n\n    // (1) Coordinate, which is required to issue WMS GetFeatureInfo requests\n    const coordinate = options.coordinate;\n    googAsserts.assert(coordinate);\n\n    // (2) Launch one request per combinaison of data sources\n    for (const dataSources of combinedDataSources) {\n\n      let url;\n      let LAYERS = [];\n      let INFO_FORMAT;\n      let activeDimensionsSet = false;\n      const params = {};\n      let filterString = null;\n      let filtrableLayerName = null;\n\n      // (3) Build query options\n      for (const dataSource of dataSources) {\n\n        // (a) Create common options, if not done yet\n        if (!INFO_FORMAT) {\n          INFO_FORMAT = dataSource.wmsInfoFormat;\n          url = dataSource.wmsUrl;\n        }\n\n        // (b) Add queryable layer names in featureTypes array\n        LAYERS = LAYERS.concat(\n          dataSource.getInRangeOGCLayerNames(resolution, true));\n\n        // (c) Manage active dimensions, which are added directly to the\n        //     query parameters. Note that this occurs only ONCE, i.e.\n        //     for the first data source, because all data sources here have\n        //     been combined together, therefore they share the same active\n        //     dimensions.\n        if (!activeDimensionsSet) {\n          olObj.assign(params, dataSource.activeDimensions);\n          activeDimensionsSet = true;\n        }\n\n        // (d) Add filter, if any. If there is a filter on the data source,\n        //     then it is expected that one request will be sent for this\n        //     data source only.\n        if (dataSource.filterRules && dataSource.filterRules.length) {\n          googAsserts.assert(dataSources.length === 1);\n          filtrableLayerName = dataSource.getFiltrableOGCLayerName();\n          filterString = this.ngeoRuleHelper_.createFilterString({\n            dataSource: dataSource,\n            srsName: projCode\n          });\n        }\n\n        // (e) Add TIME parameter if the data source has a time range value.\n        //     If that's the case, then it is expected that one request will be\n        //     sent for this data source only.\n        if (dataSource.timeRangeValue !== null && dataSource.timeProperty) {\n          googAsserts.assert(dataSources.length === 1);\n          params['TIME'] = this.ngeoWMSTime_.formatWMSTimeParam(\n            dataSource.timeProperty,\n            dataSource.timeRangeValue\n          );\n        }\n      }\n\n      params['LAYERS'] = LAYERS;\n      params['QUERY_LAYERS'] = LAYERS;\n\n      // Manage 'FILTER' parameter\n      if (filterString && filtrableLayerName) {\n        let filterParamValue = null;\n        if (LAYERS.length === 1) {\n          // When there's only one layer in the `LAYERS` parameters, then\n          // the filter string is given as-is.\n          filterParamValue = filterString;\n        } else {\n          // When there's more then one layer, then each filter must be wrapped\n          // between parenthesis and the order must also match the `LAYERS`\n          // parameter as well.\n          const filterParamValues = [];\n          for (let i = 0, ii = LAYERS.length; i < ii; i++) {\n            if (LAYERS[i] === filtrableLayerName) {\n              filterParamValues.push(`(${filterString})`);\n            } else {\n              filterParamValues.push('()');\n            }\n          }\n          filterParamValue = filterParamValues.join('');\n        }\n        params['FILTER'] = filterParamValue;\n      }\n\n      googAsserts.assert(url);\n      const wmsSource = new olSourceImageWMS({\n        params,\n        url\n      });\n\n      // (4) Build query url, then launch\n      const wmsGetFeatureInfoUrl = googAsserts.assertString(\n        wmsSource.getGetFeatureInfoUrl(\n          coordinate, resolution, projCode, {\n            // Without extern, quoting is necessary\n            'FEATURE_COUNT': FEATURE_COUNT,\n            'INFO_FORMAT': INFO_FORMAT\n          }\n        )\n      );\n\n      const canceler = this.registerCanceler_();\n      promises.push(\n        this.http_.get(\n          wmsGetFeatureInfoUrl,\n          {\n            timeout: canceler.promise\n          }\n        ).then(\n          this.handleQueryResult_.bind(this, dataSources, FEATURE_COUNT, false)\n        )\n      );\n    }\n\n    return this.q_.all(promises).then(\n      this.handleCombinedQueryResult_.bind(this)\n    );\n  }\n\n  /**\n   * @param {!Array.<ngeox.datasource.OGC>} dataSources List of\n   *     queryable data sources that supports WFS.\n   * @return {ngeo.query.Querent.CombinedDataSources} Combined lists of data sources.\n   * @private\n   */\n  getCombinableWFSDataSources_(dataSources) {\n    const combinableDataSources = [];\n    const notCombinableDataSources = [];\n\n    for (const dataSource of dataSources) {\n      if (dataSource.combinableForWFS) {\n        let combined = false;\n        for (const combinableDataSource of combinableDataSources) {\n          if (dataSource.combinableWithDataSourceForWFS(combinableDataSource[0])) {\n            combinableDataSource.push(dataSource);\n            combined = true;\n          }\n        }\n        if (!combined) {\n          combinableDataSources.push([dataSource]);\n        }\n      } else {\n        notCombinableDataSources.push([dataSource]);\n      }\n    }\n\n    return combinableDataSources.concat(notCombinableDataSources);\n  }\n\n  /**\n   * @param {!Array.<ngeox.datasource.OGC>} dataSources List of\n   *     queryable data sources that supports WMS.\n   * @return {ngeo.query.Querent.CombinedDataSources} Combined lists of data sources.\n   * @private\n   */\n  getCombinableWMSDataSources_(dataSources) {\n    const combinableDataSources = [];\n    const notCombinableDataSources = [];\n\n    for (const dataSource of dataSources) {\n      if (dataSource.combinableForWMS) {\n        let combined = false;\n        for (const combinableDataSource of combinableDataSources) {\n          if (dataSource.combinableWithDataSourceForWMS(combinableDataSource[0])) {\n            combinableDataSource.push(dataSource);\n            combined = true;\n          }\n        }\n        if (!combined) {\n          combinableDataSources.push([dataSource]);\n        }\n      } else {\n        notCombinableDataSources.push([dataSource]);\n      }\n    }\n\n    return combinableDataSources.concat(notCombinableDataSources);\n  }\n\n  /**\n   * Checks if a data source can be queried, which requires it to be:\n   * - visible\n   * - in range\n   * - queryable (using the native getter)\n   * - have at least one OGC layer in range of current map view resolution.\n   *\n   * @param {ngeo.datasource.DataSource} ds Data source\n   * @param {number} res Resolution.\n   * @return {boolean} Whether the data source is queryable\n   * @private\n   */\n  isDataSourceQueryable_(ds, res) {\n    let queryable = ds.visible && ds.inRange && ds.queryable;\n    if (queryable && ds instanceof ngeoDatasourceOGC) {\n      const ogcDS = /** @type {!ngeo.datasource.OGC} */ (ds);\n      queryable = ogcDS.isAnyOGCLayerInRange(res, true);\n    }\n    return queryable;\n  }\n\n  /**\n   * Make sure that feature ids are unique, because the same features might\n   * be returned for different layers.\n   * @param {Array.<ol.Feature>} features Features\n   * @param {number} dataSourceId Data source id.\n   * @private\n   */\n  setUniqueIds_(features, dataSourceId) {\n    features.forEach((feature) => {\n      if (feature.getId() !== undefined) {\n        const id = `${dataSourceId}_${feature.getId()}`;\n        feature.setId(id);\n      }\n    });\n  }\n\n  /**\n   * @return {angular.$q.Deferred} A deferred that can be resolved to cancel a\n   *    HTTP request.\n   * @private\n   */\n  registerCanceler_() {\n    const canceler = this.q_.defer();\n    this.requestCancelers_.push(canceler);\n    return canceler;\n  }\n\n  /**\n   * @private\n   */\n  cancelStillRunningRequests_() {\n    for (const canceler of this.requestCancelers_) {\n      canceler.resolve();\n    }\n    this.requestCancelers_.length = 0;\n  }\n};\n\n\n/**\n * @typedef {!Array.<!Array.<!ngeo.datasource.OGC>>}\n */\nexports.CombinedDataSources;\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoQuerent', [\n  ngeoFilterRuleHelper.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\nexports.module.service('ngeoQuerent', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.format.WFSAttribute\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoFormatAttribute from 'ngeo/format/Attribute.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoFormatXSDAttribute from 'ngeo/format/XSDAttribute.js';\n\nconst exports = class {\n\n\n  /**\n   * A format that reads the complexType from a WFS DescribeFeatureType\n   * response for a single set of attributes and return an array of\n   * `ngeox.Attribute`.\n   */\n\n\n  /**\n   * @param {Array.<Object>} complexTypeElements Complex type element\n   * @return {Array.<ngeox.Attribute>} Attributes\n   */\n  read(complexTypeElements) {\n    return complexTypeElements.map(this.readFromComplexTypeElement_);\n  }\n\n\n  /**\n   * @param {Object} object Complex type element\n   * @return {ngeox.Attribute} Attribute\n   * @private\n   */\n  readFromComplexTypeElement_(object) {\n\n    const name = googAsserts.assertString(object['name']);\n    const alias = 'alias' in object ?\n      googAsserts.assertString(object['alias']) : null;\n    const required = object['minOccurs'] != '0';\n\n    const attribute = {\n      name,\n      alias,\n      required\n    };\n\n    const type = googAsserts.assertString(object['type']);\n\n    if (!ngeoFormatAttribute.setGeometryType(attribute, type)) {\n      if (type === 'gml:TimeInstantType' || type === 'dateTime') {\n        attribute.type = ngeoFormatAttributeType.DATETIME;\n      } else if (type === 'date') {\n        attribute.type = ngeoFormatAttributeType.DATE;\n      } else if (type === 'time') {\n        attribute.type = ngeoFormatAttributeType.TIME;\n      } else if (type === 'decimal' || type === 'double') {\n        attribute.type = ngeoFormatAttributeType.NUMBER;\n        attribute.numType = ngeoFormatXSDAttribute.NumberType.FLOAT;\n      } else if (type === 'integer' || type === 'long') {\n        attribute.type = ngeoFormatAttributeType.NUMBER;\n        attribute.numType = ngeoFormatXSDAttribute.NumberType.INTEGER;\n      } else if (type === 'boolean') {\n        attribute.type = ngeoFormatAttributeType.BOOLEAN;\n      } else {\n        attribute.type = ngeoFormatAttributeType.TEXT;\n      }\n    }\n\n    return attribute;\n  }\n\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.datasource.Helper\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceDataSource from 'ngeo/datasource/DataSource.js';\nimport ngeoDatasourceDataSources from 'ngeo/datasource/DataSources.js';\nimport ngeoFormatWFSAttribute from 'ngeo/format/WFSAttribute.js';\nimport ngeoQueryQuerent from 'ngeo/query/Querent.js';\nimport * as olEvents from 'ol/events.js';\n\nconst exports = class {\n  /**\n   * A service that provides utility methods to manipulate or get data sources.\n   *\n   * @struct\n   * @param {angular.$q} $q The Angular $q service.\n   * @param {ngeo.datasource.DataSources} ngeoDataSources Ngeo data source\n   *     service.\n   * @param {ngeo.query.Querent} ngeoQuerent Ngeo querent service.\n   * @ngdoc service\n   * @ngname ngeoDataSourcesHelper\n   * @ngInject\n   */\n  constructor($q, ngeoDataSources, ngeoQuerent) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.q_ = $q;\n\n    /**\n     * @type {ngeox.datasource.DataSources}\n     * @private\n     */\n    this.collection_ = ngeoDataSources.collection;\n\n    /**\n     * @type {ngeo.query.Querent}\n     * @private\n     */\n    this.ngeoQuerent_ = ngeoQuerent;\n\n\n    // === Other properties ===\n\n    /**\n     * @type {Object.<number, ngeo.datasource.DataSource>}\n     * @private\n     */\n    this.cache_ = {};\n\n    // Events\n\n    olEvents.listen(this.collection_, 'add', this.handleDataSourcesAdd_, this);\n    olEvents.listen(this.collection_, 'remove', this.handleDataSourcesRemove_, this);\n  }\n\n  /**\n   * @return {ngeox.datasource.DataSources} Data sources collection.\n   * @export\n   */\n  get collection() {\n    return this.collection_;\n  }\n\n  /**\n   * Return a data source using its id.\n   * @param {number} id Data source id.\n   * @return {?ngeo.datasource.DataSource} Data source.\n   * @export\n   */\n  getDataSource(id) {\n    return this.cache_[id] || null;\n  }\n\n  /**\n   * Get the attributes of a data source. If they are not set, they are obtained\n   * from the querent service using a WFS DescribeFeatureType request, then set\n   * in the data source.\n   *\n   * Please, note that in order to be dynamically set, the data source must\n   * only have 1 ogcLayer set and be queryable.\n   *\n   * @param {ngeo.datasource.OGC} dataSource Filtrable data source.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  getDataSourceAttributes(dataSource) {\n\n    const wfsDescribeFeatureTypeDefer = this.q_.defer();\n\n    if (dataSource.attributes) {\n      wfsDescribeFeatureTypeDefer.resolve(dataSource.attributes);\n    } else {\n      this.ngeoQuerent_.wfsDescribeFeatureType(\n        dataSource\n      ).then((featureType) => {\n        // We know, at this point, that there's only one definition that\n        // was returned.  Just to be sure, let's do a bunch of assertions.\n        const ogcLayerName = dataSource.getOGCLayerNames()[0];\n        googAsserts.assertString(ogcLayerName, 'The data source should have only one ogcLayer.');\n        for (const element of featureType.element) {\n          if (element.name === ogcLayerName) {\n            for (const type of featureType.complexType) {\n              if (type.name == element.type) {\n                const complexContent = type.complexContent;\n                const attributes = new ngeoFormatWFSAttribute().read(complexContent);\n\n                // Set the attributes in the data source\n                dataSource.setAttributes(attributes);\n\n                wfsDescribeFeatureTypeDefer.resolve(attributes);\n                break;\n              }\n            }\n          }\n        }\n      });\n    }\n\n    return wfsDescribeFeatureTypeDefer.promise;\n  }\n\n  /**\n   * Called when a new data source is added to the ngeo collection. Add it\n   * to the cache.\n   * @param {ol.Collection.Event} evt Event\n   * @private\n   */\n  handleDataSourcesAdd_(evt) {\n    const dataSource = googAsserts.assertInstanceof(\n      evt.element, ngeoDatasourceDataSource);\n    this.cache_[dataSource.id] = dataSource;\n  }\n\n  /**\n   * Called when a data source is removed from the ngeo collection. Remove it\n   * from the cache.\n   * @param {ol.Collection.Event} evt Event\n   * @private\n   */\n  handleDataSourcesRemove_(evt) {\n    const dataSource = googAsserts.assertInstanceof(\n      evt.element, ngeoDatasourceDataSource);\n    delete this.cache_[dataSource.id];\n  }\n\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoDataSourcesHelper', [\n  ngeoDatasourceDataSources.module.name,\n  ngeoQueryQuerent.module.name,\n]);\nexports.module.service('ngeoDataSourcesHelper', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.editing.Snapping\n */\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olCollection from 'ol/Collection.js';\nimport olFormatWFS from 'ol/format/WFS.js';\nimport olInteractionSnap from 'ol/interaction/Snap.js';\n\n/**\n * The snapping service of GMF. Responsible of collecting the treeCtrls that\n * support snapping and store them here. As soon as a treeCtrl state becomes\n * 'on', a WFS GetFeature request is issued to collect the features at the\n * map view location. A new request is sent every time the map is panned or\n * zoomed for each treeCtrl that are still 'on'.\n *\n * Features returned by these requests get bound to a `ol.interaction.Snap`,\n * which allows the snapping to occur on other places where vector\n * features are drawn or modified.\n *\n * @constructor\n * @param {angular.$http} $http Angular $http service.\n * @param {angular.$q} $q The Angular $q service.\n * @param {!angular.Scope} $rootScope Angular rootScope.\n * @param {!angular.$injector} $injector Angular injector.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {gmf.theme.Themes} gmfThemes The gmf Themes service.\n * @param {gmf.layertree.TreeManager} gmfTreeManager The gmf TreeManager service.\n * @ngInject\n * @ngdoc service\n * @ngname gmfSnapping\n */\nconst exports = function($http, $q, $rootScope, $injector, $timeout, gmfThemes,\n  gmfTreeManager) {\n\n  // === Injected services ===\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.http_ = $http;\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.q_ = $q;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.rootScope_ = $rootScope;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {!angular.$injector}\n   * @private\n   */\n  this.injector_ = $injector;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = gmfTreeManager;\n\n\n  // === Properties ===\n\n  /**\n   * A cache containing all available snappable items, in which the listening\n   * of the state of the `treeCtrl` is registered and unregistered.\n   * @type {gmf.editing.Snapping.Cache}\n   * @private\n   */\n  this.cache_ = {};\n\n  /**\n   * @type {!Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {?ol.Map}\n   * @private\n   */\n  this.map_ = null;\n\n  /**\n   * Reference to the promise taking care of calling all GetFeature requests\n   * of the currently active cache items after the map view changed. Used\n   * to cancel if the map view changes often within a short period of time.\n   * @type {?angular.$q.Promise}\n   * @private\n   */\n  this.mapViewChangePromise_ = null;\n\n  /**\n   * A reference to the OGC servers loaded by the theme service.\n   * @type {gmfThemes.GmfOgcServers|null}\n   * @private\n   */\n  this.ogcServers_ = null;\n\n  /**\n   * @type {ol.source.Vector | undefined}\n   * @private\n   */\n  this.ngeoSnappingSource_ = this.injector_.has('ngeoSnappingSource') ? this.injector_.get('ngeoSnappingSource') : undefined;\n\n};\n\n\nclass CustomSnap extends olInteractionSnap {\n  constructor(options) {\n    super(options);\n    document.body.addEventListener('keydown', (evt) => {\n      this.setActive(evt.keyCode !== 17); // Ctrl key\n    });\n    document.body.addEventListener('keyup', () => {\n      this.setActive(true);\n    });\n  }\n}\n\n\n/**\n * In order for a `ol.interaction.Snap` to work properly, it has to be added\n * to the map after any draw interactions or other kinds of interactions that\n * interacts with features on the map.\n *\n * This method can be called to make sure the Snap interactions are on top.\n *\n * @export\n */\nexports.prototype.ensureSnapInteractionsOnTop = function() {\n  const map = this.map_;\n  googAsserts.assert(map);\n\n  let item;\n  for (const uid in this.cache_) {\n    item = this.cache_[uid];\n    if (item.active) {\n      googAsserts.assert(item.interaction);\n      map.removeInteraction(item.interaction);\n      map.addInteraction(item.interaction);\n    }\n  }\n};\n\n\n/**\n * Bind the snapping service to a map\n * @param {?ol.Map} map Map\n * @export\n */\nexports.prototype.setMap = function(map) {\n\n  const keys = this.listenerKeys_;\n\n  if (this.map_) {\n    this.treeCtrlsUnregister_();\n    this.unregisterAllTreeCtrl_();\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n  }\n\n  this.map_ = map;\n\n  if (map) {\n    this.treeCtrlsUnregister_ = this.rootScope_.$watchCollection(() => {\n      if (this.gmfTreeManager_.rootCtrl) {\n        return this.gmfTreeManager_.rootCtrl.children;\n      }\n    }, (value) => {\n      // Timeout required, because the collection event is fired before the\n      // leaf nodes are created and they are the ones we're looking for here.\n      this.timeout_(() => {\n        if (value) {\n          this.unregisterAllTreeCtrl_();\n          this.gmfTreeManager_.rootCtrl.traverseDepthFirst(this.registerTreeCtrl_.bind(this));\n        }\n      }, 0);\n    });\n\n    keys.push(\n      olEvents.listen(this.gmfThemes_, 'change', this.handleThemesChange_, this),\n      olEvents.listen(map, 'moveend', this.handleMapMoveEnd_, this)\n    );\n  }\n};\n\n\n/**\n * Called when the themes change. Get the OGC servers, then listen to the\n * tree manager Layertree controllers array changes.\n * @private\n */\nexports.prototype.handleThemesChange_ = function() {\n  this.ogcServers_ = null;\n  this.gmfThemes_.getOgcServersObject().then((ogcServers) => {\n    this.ogcServers_ = ogcServers;\n  });\n};\n\n\n/**\n * Registers a newly added Layertree controller 'leaf'. If it's snappable,\n * create and add a cache item with every configuration required to do the\n * snapping. It becomes active when its state is set to 'on'.\n *\n * @param {ngeo.layertree.Controller} treeCtrl Layertree controller to register\n * @private\n */\nexports.prototype.registerTreeCtrl_ = function(treeCtrl) {\n\n  // Skip any Layertree controller that has a node that is not a leaf\n  let node = /** @type {gmfThemes.GmfGroup|gmfThemes.GmfLayer} */ (treeCtrl.node);\n  if (node.children) {\n    return;\n  }\n\n  // If treeCtrl is snappable and supports WFS, listen to its state change.\n  // When it becomes visible, it's added to the list of snappable tree ctrls.\n  node = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n  const snappingConfig = gmfThemeThemes.getSnappingConfig(node);\n  if (snappingConfig) {\n    const wfsConfig = this.getWFSConfig_(treeCtrl);\n    if (wfsConfig) {\n      const uid = olBase.getUid(treeCtrl);\n\n      const stateWatcherUnregister = this.rootScope_.$watch(\n        () => treeCtrl.getState(),\n        this.handleTreeCtrlStateChange_.bind(this, treeCtrl)\n      );\n\n      // Todo: some of the properties here are hardcoded, but could come from\n      //       the node metadata at some point.\n      this.cache_[uid] = {\n        active: false,\n        featureNS: 'http://mapserver.gis.umn.edu/mapserver',\n        featurePrefix: 'feature',\n        features: new olCollection(),\n        geometryName: 'geom',\n        interaction: null,\n        maxFeatures: 50,\n        requestDeferred: null,\n        snappingConfig: snappingConfig,\n        treeCtrl: treeCtrl,\n        wfsConfig: wfsConfig,\n        stateWatcherUnregister: stateWatcherUnregister\n      };\n\n      // This extra call is to initialize the treeCtrl with its current state\n      this.handleTreeCtrlStateChange_(treeCtrl, treeCtrl.getState());\n    }\n  }\n};\n\n\n/**\n * Unregisters all removed layertree controllers 'leaf'. Remove the according\n * cache item and deactivate it as well. Unregister events.\n *\n * @private\n */\nexports.prototype.unregisterAllTreeCtrl_ = function() {\n  for (const uid in this.cache_) {\n    const item = this.cache_[uid];\n    if (item) {\n      item.stateWatcherUnregister();\n      this.deactivateItem_(item);\n      delete this.cache_[uid];\n    }\n  }\n};\n\n\n/**\n * Get the configuration required to do WFS requests (for snapping purpose)\n * from a Layertree controller that has a leaf node.\n *\n * The following requirements must be met in order for a treeCtrl to be\n * considered supporting WFS:\n *\n * 1) ogcServers objects are loaded\n * 2) its node `type` property is equal to `WMS`\n * 3) in its node `childLayers` property, the `queryable` property is set\n *    to `true`\n * 4) if its node `mixed` property is:\n *   a) true: then the node must have an `ogcServer` property set\n *   b) false: then the first parent node must have an `ogcServer` property set\n * 5) the ogcServer defined in 3) has the `wfsSupport` property set to `true`.\n *\n * @param {ngeo.layertree.Controller} treeCtrl The layer tree controller\n * @return {?gmf.editing.Snapping.WFSConfig} The configuration object.\n * @private\n */\nexports.prototype.getWFSConfig_ = function(treeCtrl) {\n\n  // (1)\n  if (this.ogcServers_ === null) {\n    return null;\n  }\n\n  const gmfLayer = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n\n  // (2)\n  if (gmfLayer.type !== gmfThemeThemes.NodeType.WMS) {\n    return null;\n  }\n\n  const gmfLayerWMS = /** @type {gmfThemes.GmfLayerWMS} */ (gmfLayer);\n\n  // (3)\n  const featureTypes = [];\n  for (let i = 0, ii = gmfLayerWMS.childLayers.length; i < ii; i++) {\n    if (gmfLayerWMS.childLayers[i].queryable) {\n      featureTypes.push(gmfLayerWMS.childLayers[i].name);\n    }\n  }\n  if (!featureTypes.length) {\n    return null;\n  }\n\n  // (4)\n  let ogcServerName;\n  const gmfGroup = /** @type {gmfThemes.GmfGroup} */ (treeCtrl.parent.node);\n  if (gmfGroup.mixed) {\n    ogcServerName = gmfLayerWMS.ogcServer;\n  } else {\n    const firstTreeCtrl = ngeoLayertreeController.getFirstParentTree(treeCtrl);\n    const firstNode = /** @type {gmfThemes.GmfGroup} */ (firstTreeCtrl.node);\n    ogcServerName = firstNode.ogcServer;\n  }\n  if (!ogcServerName) {\n    return null;\n  }\n\n  // (5)\n  const ogcServer = this.ogcServers_[ogcServerName];\n  if (!ogcServer.wfsSupport) {\n    return null;\n  }\n\n  // At this point, every requirements have been met.\n  // Create and return the configuration.\n  const urlWfs = ogcServer.urlWfs;\n  googAsserts.assert(urlWfs, 'urlWfs should be defined.');\n\n  return {\n    featureTypes: featureTypes.join(','),\n    url: urlWfs\n  };\n};\n\n\n/**\n * @param {ngeo.layertree.Controller} treeCtrl The layer tree controller\n * @param {string|undefined} newVal New state value\n * @private\n */\nexports.prototype.handleTreeCtrlStateChange_ = function(treeCtrl, newVal) {\n\n  const uid = olBase.getUid(treeCtrl);\n  const item = this.cache_[uid];\n\n  // Note: a snappable treeCtrl can only be a leaf, therefore the only possible\n  //       states are: 'on' and 'off'.\n  if (newVal === 'on') {\n    this.activateItem_(item);\n  } else {\n    this.deactivateItem_(item);\n  }\n};\n\n\n/**\n * Activate a cache item by adding a Snap interaction to the map and launch\n * the initial request to get the features.\n *\n * @param {gmf.editing.Snapping.CacheItem} item Cache item.\n * @private\n */\nexports.prototype.activateItem_ = function(item) {\n\n  // No need to do anything if item is already active\n  if (item.active) {\n    return;\n  }\n\n  const map = this.map_;\n  googAsserts.assert(map);\n\n  const interaction = new CustomSnap({\n    edge: item.snappingConfig.edge,\n    features: item.features,\n    pixelTolerance: item.snappingConfig.tolerance,\n    vertex: item.snappingConfig.vertex\n  });\n\n  map.addInteraction(interaction);\n\n  item.interaction = interaction;\n  item.active = true;\n\n  // Init features\n  this.loadItemFeatures_(item);\n};\n\n\n/**\n * Deactivate a cache item by removing the snap interaction and clearing any\n * existing features.\n *\n * @param {gmf.editing.Snapping.CacheItem} item Cache item.\n * @private\n */\nexports.prototype.deactivateItem_ = function(item) {\n\n  // No need to do anything if item is already inactive\n  if (!item.active) {\n    return;\n  }\n\n  const map = this.map_;\n  googAsserts.assert(map);\n\n  const interaction = item.interaction;\n  map.removeInteraction(interaction);\n\n  item.interaction = null;\n  item.features.clear();\n\n  // If a previous request is still running, cancel it.\n  if (item.requestDeferred) {\n    item.requestDeferred.resolve();\n    item.requestDeferred = null;\n  }\n\n  item.active = false;\n  this.refreshSnappingSource_();\n};\n\n\n/**\n * @private\n */\nexports.prototype.loadAllItems_ = function() {\n  this.mapViewChangePromise_ = null;\n  let item;\n  for (const uid in this.cache_) {\n    item = this.cache_[uid];\n    if (item.active) {\n      this.loadItemFeatures_(item);\n    }\n  }\n};\n\n\n/**\n * Manually refresh all features\n */\nexports.prototype.refresh = function() {\n  this.loadAllItems_();\n};\n\n\n/**\n * For a specific cache item, issue a new WFS GetFeatures request. The returned\n * features set in the item collection of features (they replace any existing\n * ones first).\n *\n * @param {gmf.editing.Snapping.CacheItem} item Cache item.\n * @private\n */\nexports.prototype.loadItemFeatures_ = function(item) {\n\n  // If a previous request is still running, cancel it.\n  if (item.requestDeferred) {\n    item.requestDeferred.resolve();\n  }\n\n  const map = this.map_;\n  googAsserts.assert(map);\n\n  const view = map.getView();\n  const size = map.getSize();\n  googAsserts.assert(size);\n\n  const extent = view.calculateExtent(size);\n  const projCode = view.getProjection().getCode();\n  const featureTypes = item.wfsConfig.featureTypes.split(',');\n\n  const getFeatureOptions = {\n    srsName: projCode,\n    featureNS: item.featureNS,\n    featurePrefix: item.featurePrefix,\n    featureTypes: featureTypes,\n    outputFormat: 'GML3',\n    bbox: extent,\n    geometryName: item.geometryName,\n    maxFeatures: item.maxFeatures\n  };\n\n  const wfsFormat = new olFormatWFS();\n  const xmlSerializer = new XMLSerializer();\n  const featureRequestXml = wfsFormat.writeGetFeature(getFeatureOptions);\n  const featureRequest = xmlSerializer.serializeToString(featureRequestXml);\n  const url = item.wfsConfig.url;\n\n  item.requestDeferred = this.q_.defer();\n\n  this.http_.post(url, featureRequest, {timeout: item.requestDeferred.promise})\n    .then((response) => {\n      // (1) Unset requestDeferred\n      item.requestDeferred = null;\n\n      // (2) Clear any previous features in the item\n      item.features.clear();\n\n      // (3) Read features from request response and add them to the item\n      const readFeatures = new olFormatWFS().readFeatures(response.data);\n      if (readFeatures) {\n        item.features.extend(readFeatures);\n        this.refreshSnappingSource_();\n      }\n    });\n\n};\n\n\n/**\n * Called when the map view changes. Load all active cache items after a small\n * delay. Cancel any currently delayed call, if required.\n * @private\n */\nexports.prototype.handleMapMoveEnd_ = function() {\n  if (this.mapViewChangePromise_) {\n    this.timeout_.cancel(this.mapViewChangePromise_);\n  }\n  this.mapViewChangePromise_ = this.timeout_(\n    this.loadAllItems_.bind(this),\n    400\n  );\n};\n\n/**\n * @private\n */\nexports.prototype.refreshSnappingSource_ = function() {\n  this.ngeoSnappingSource_.clear();\n  for (const uid in this.cache_) {\n    const item = this.cache_[uid];\n    if (item.active) {\n      this.ngeoSnappingSource_.addFeatures(item.features.getArray());\n    }\n  }\n};\n\n/**\n * @typedef {Object<number, gmf.editing.Snapping.CacheItem>}\n */\nexports.Cache;\n\n\n/**\n * @typedef {{\n *     active: (boolean),\n *     featureNS: (string),\n *     featurePrefix: (string),\n *     features: (ol.Collection.<ol.Feature>),\n *     geometryName: (string),\n *     interaction: (?ol.interaction.Snap),\n *     maxFeatures: (number),\n *     requestDeferred: (?angular.$q.Deferred),\n *     snappingConfig: (gmfThemes.GmfSnappingConfig),\n *     stateWatcherUnregister: (Function),\n *     treeCtrl: (ngeo.layertree.Controller),\n *     wfsConfig: (gmf.editing.Snapping.WFSConfig)\n * }}\n */\nexports.CacheItem;\n\n\n/**\n * @typedef {{\n *     featureTypes: (string),\n *     url: (string)\n * }}\n */\nexports.WFSConfig;\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfSnapping', [\n  gmfLayertreeTreeManager.module.name,\n  gmfThemeThemes.module.name,\n  ngeoLayertreeController.module.name,\n]);\nexports.module.service('gmfSnapping', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.Translate\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olBase from 'ol/index.js';\nimport * as olExtent from 'ol/extent.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olEvents from 'ol/events.js';\nimport olGeomGeometry from 'ol/geom/Geometry.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olInteractionTranslate from 'ol/interaction/Translate.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\n\n/**\n * An extension of the OpenLayers Translate interaction that adds the following\n * features to it:\n *\n * - show a small arrow icon in the middle of the features allowing a visual\n *   aspect that tells the user \"this feature can be moved\"\n * - pressing the ESC key automatically deactivate the interaction.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Translate}\n * @param {ngeox.interaction.TranslateOptions} options Options.\n */\nconst exports = function(options) {\n\n  /**\n   * @type {!Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {!Object.<number, ol.EventsKey>}\n   * @private\n   */\n  this.featureListenerKeys_ = {};\n\n  /**\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.keyPressListenerKey_ = null;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.myFeatures_ = options.features !== undefined ? options.features : null;\n\n  /**\n   * @type {ol.source.Vector}\n   * @private\n   */\n  this.vectorSource_ = new olSourceVector({\n    useSpatialIndex: false\n  });\n\n  /**\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.vectorLayer_ = new olLayerVector({\n    source: this.vectorSource_,\n    style: options.style,\n    updateWhileAnimating: true,\n    updateWhileInteracting: true\n  });\n\n  /**\n   * @type {!Object.<number, ol.Feature>}\n   * @private\n   */\n  this.centerFeatures_ = {};\n\n  olInteractionTranslate.call(\n    this, /** @type {olx.interaction.TranslateOptions} */ (options));\n};\n\nolBase.inherits(exports, olInteractionTranslate);\n\n\n/**\n * Activate or deactivate the interaction.\n * @param {boolean} active Active.\n * @override\n */\nexports.prototype.setActive = function(active) {\n\n  if (this.keyPressListenerKey_) {\n    olEvents.unlistenByKey(this.keyPressListenerKey_);\n    this.keyPressListenerKey_ = null;\n  }\n\n  olInteractionTranslate.prototype.setActive.call(this, active);\n\n  if (active) {\n    this.keyPressListenerKey_ = olEvents.listen(\n      document,\n      'keyup',\n      this.handleKeyUp_,\n      this\n    );\n  }\n\n  this.setState_();\n};\n\n\n/**\n * Remove the interaction from its current map and attach it to the new map.\n * Subclasses may set up event handlers to get notified about changes to\n * the map here.\n * @param {ol.PluggableMap} map Map.\n * @override\n */\nexports.prototype.setMap = function(map) {\n\n  const currentMap = this.getMap();\n  if (currentMap) {\n    this.vectorLayer_.setMap(null);\n  }\n\n  olInteractionTranslate.prototype.setMap.call(this, map);\n\n  if (map) {\n    this.vectorLayer_.setMap(map);\n  }\n\n  this.setState_();\n};\n\n\n/**\n * @private\n */\nexports.prototype.setState_ = function() {\n  const map = this.getMap();\n  const active = this.getActive();\n  const features = this.myFeatures_;\n  const keys = this.listenerKeys_;\n\n  if (map && active && features) {\n    features.forEach(feature => this.addFeature_(feature));\n    keys.push(\n      olEvents.listen(features, 'add', this.handleFeaturesAdd_, this),\n      olEvents.listen(features, 'remove', this.handleFeaturesRemove_, this)\n    );\n  } else {\n\n    if (map) {\n      const elem = map.getTargetElement();\n      elem.style.cursor = 'default';\n    }\n\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n    features.forEach(feature => this.removeFeature_(feature));\n  }\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeaturesAdd_ = function(evt) {\n  const feature = evt.element;\n  googAsserts.assertInstanceof(feature, olFeature,\n    'feature should be an ol.Feature');\n  this.addFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeaturesRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature_(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addFeature_ = function(feature) {\n  const uid = olBase.getUid(feature);\n  const geometry = feature.getGeometry();\n  googAsserts.assertInstanceof(geometry, olGeomGeometry);\n\n  this.featureListenerKeys_[uid] = olEvents.listen(\n    geometry,\n    'change',\n    this.handleGeometryChange_.bind(this, feature),\n    this\n  );\n\n  const point = this.getGeometryCenterPoint_(geometry);\n  const centerFeature = new olFeature(point);\n  this.centerFeatures_[uid] = centerFeature;\n  this.vectorSource_.addFeature(centerFeature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeature_ = function(feature) {\n  const uid = olBase.getUid(feature);\n  if (this.featureListenerKeys_[uid]) {\n    olEvents.unlistenByKey(this.featureListenerKeys_[uid]);\n    delete this.featureListenerKeys_[uid];\n\n    this.vectorSource_.removeFeature(this.centerFeatures_[uid]);\n    delete this.centerFeatures_[uid];\n  }\n};\n\n\n/**\n * @param {ol.Feature} feature Feature being moved.\n * @param {ol.events.Event} evt Event.\n * @private\n */\nexports.prototype.handleGeometryChange_ = function(feature,\n  evt) {\n  const geometry = evt.target;\n  googAsserts.assertInstanceof(geometry, olGeomGeometry);\n\n  const point = this.getGeometryCenterPoint_(geometry);\n  const uid = olBase.getUid(feature);\n  this.centerFeatures_[uid].setGeometry(point);\n};\n\n\n/**\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {ol.geom.Point} The center point of the geometry.\n * @private\n */\nexports.prototype.getGeometryCenterPoint_ = function(\n  geometry) {\n\n  let center;\n  let point;\n\n  if (geometry instanceof olGeomPolygon) {\n    point = geometry.getInteriorPoint();\n  } else if (geometry instanceof olGeomLineString) {\n    center = geometry.getCoordinateAt(0.5);\n  } else {\n    const extent = geometry.getExtent();\n    center = olExtent.getCenter(extent);\n  }\n\n  if (!point && center) {\n    point = new olGeomPoint(center);\n  }\n\n  googAsserts.assert(point, 'Point should be thruthy');\n\n  return point;\n};\n\n\n/**\n * Deactivate this interaction if the ESC key is pressed.\n * @param {KeyboardEvent} evt Event.\n * @private\n */\nexports.prototype.handleKeyUp_ = function(evt) {\n  // 27 == ESC key\n  if (evt.keyCode === 27) {\n    this.setActive(false);\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.Rotate\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionCommon from 'ngeo/interaction/common.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport * as olExtent from 'ol/extent.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olEvents from 'ol/events.js';\nimport olInteractionPointer from 'ol/interaction/Pointer.js';\nimport olGeomGeometry from 'ol/geom/Geometry.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\n\n/**\n * @classdesc\n * Interaction to rotate features.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Pointer}\n * @param {olx.interaction.ModifyOptions} options Options.\n * @fires ngeo.interaction.ModifyCircleEvent\n * @api\n */\nconst exports = function(options) {\n\n  googAsserts.assert(options.features);\n\n  /**\n   * @type {Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.modified_ = false;\n\n  /**\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.keyPressListenerKey_ = null;\n\n  /**\n   * Indicate whether the interaction is currently changing a feature's\n   * coordinates.\n   * @type {boolean}\n   * @private\n   */\n  this.changingFeature_ = false;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.pixelTolerance_ = options.pixelTolerance !== undefined ?\n    options.pixelTolerance : 10;\n\n  /**\n   * @type {!ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features_ = options.features;\n\n  /**\n   * The feature currently modified.\n   * @type {ol.Feature}\n   * @private\n   */\n  this.feature_ = null;\n\n  /**\n   * @type {ol.Pixel}\n   * @private\n   */\n  this.coordinate_ = null;\n\n  /**\n   * @type {ol.Coordinate}\n   * @private\n   */\n  this.centerCoordinate_ = null;\n\n  /**\n   * Draw overlay where sketch features are drawn.\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.overlay_ = new olLayerVector({\n    source: new olSourceVector({\n      useSpatialIndex: false,\n      wrapX: !!options.wrapX\n    }),\n    style: options.style || ngeoInteractionCommon.getDefaultModifyStyleFunction(),\n    updateWhileAnimating: true,\n    updateWhileInteracting: true\n  });\n\n  /**\n   * @type {!Object.<number, ol.Feature>}\n   * @private\n   */\n  this.centerFeatures_ = {};\n\n  olInteractionPointer.call(this, {\n    handleDownEvent: this.handleDown_,\n    handleDragEvent: this.handleDrag_,\n    handleUpEvent: this.handleUp_\n  });\n\n};\n\nolBase.inherits(exports, olInteractionPointer);\n\n\n/**\n * Activate or deactivate the interaction.\n * @param {boolean} active Active.\n * @override\n */\nexports.prototype.setActive = function(active) {\n\n  if (this.keyPressListenerKey_) {\n    olEvents.unlistenByKey(this.keyPressListenerKey_);\n    this.keyPressListenerKey_ = null;\n  }\n\n  olInteractionPointer.prototype.setActive.call(this, active);\n\n  if (active) {\n    this.keyPressListenerKey_ = olEvents.listen(\n      document,\n      'keyup',\n      this.handleKeyUp_,\n      this\n    );\n    this.features_.forEach(feature => this.addFeature_(feature));\n    this.listenerKeys_.push(\n      olEvents.listen(this.features_, 'add', this.handleFeatureAdd_, this),\n      olEvents.listen(this.features_, 'remove', this.handleFeatureRemove_, this)\n    );\n\n  } else {\n    this.listenerKeys_.forEach(olEvents.unlistenByKey);\n    this.listenerKeys_.length = 0;\n    this.features_.forEach(feature => this.removeFeature_(feature));\n  }\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addFeature_ = function(feature) {\n  const geometry = feature.getGeometry();\n  googAsserts.assertInstanceof(geometry, olGeomGeometry);\n\n  feature.set('angle', 0);\n\n  // Add the center icon to the overlay\n  const uid = olBase.getUid(feature);\n  const point = new olGeomPoint(this.getCenterCoordinate_(geometry));\n  const centerFeature = new olFeature(point);\n  this.centerFeatures_[uid] = centerFeature;\n  this.overlay_.getSource().addFeature(centerFeature);\n\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Map browser event\n * @private\n */\nexports.prototype.willModifyFeatures_ = function(evt) {\n  if (!this.modified_) {\n    this.modified_ = true;\n    /** @type {ngeox.ModifyEvent} */\n    const event = new ngeoCustomEvent('modifystart', {features: this.features_});\n    this.dispatchEvent(event);\n  }\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeature_ = function(feature) {\n  this.feature_ = null;\n  //this.overlay_.getSource().removeFeature(feature);\n\n  if (feature) {\n    const uid = olBase.getUid(feature);\n\n    if (this.centerFeatures_[uid]) {\n      this.overlay_.getSource().removeFeature(this.centerFeatures_[uid]);\n      delete this.centerFeatures_[uid];\n    }\n  }\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n  this.overlay_.setMap(map);\n  olInteractionPointer.prototype.setMap.call(this, map);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureAdd_ = function(evt) {\n  const feature = evt.element;\n  googAsserts.assertInstanceof(feature, olFeature,\n    'feature should be an ol.Feature');\n  this.addFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature_(feature);\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Start drag sequence?\n * @private\n */\nexports.prototype.handleDown_ = function(evt) {\n  const map = evt.map;\n\n  let feature = map.forEachFeatureAtPixel(evt.pixel,\n    (feature, layer) => feature, undefined);\n\n  if (feature) {\n    let found = false;\n    this.features_.forEach((f) => {\n      if (olBase.getUid(f) == olBase.getUid(feature)) {\n        found = true;\n      }\n    });\n    if (!found) {\n      feature = null;\n    }\n  }\n\n  if (feature) {\n    this.coordinate_ = evt.coordinate;\n    this.feature_ = feature;\n    const geometry = (this.feature_.getGeometry());\n    if (geometry !== undefined) {\n      this.centerCoordinate_ = this.getCenterCoordinate_(geometry);\n    }\n\n    return true;\n  }\n\n  return false;\n};\n\n\n/**\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {ol.Coordinate} The center coordinate of the geometry.\n * @private\n */\nexports.prototype.getCenterCoordinate_ = function(\n  geometry) {\n\n  let center;\n\n  if (geometry instanceof olGeomLineString) {\n    center = geometry.getFlatMidpoint();\n  } else if (geometry instanceof olGeomPolygon) {\n    center = geometry.getFlatInteriorPoint();\n  } else {\n    const extent = geometry.getExtent();\n    center = olExtent.getCenter(extent);\n  }\n\n  return center;\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @private\n */\nexports.prototype.handleDrag_ = function(evt) {\n  this.willModifyFeatures_(evt);\n\n  const geometry = /** @type {ol.geom.SimpleGeometry} */\n      (this.feature_.getGeometry());\n\n  const oldX = this.coordinate_[0];\n  const oldY = this.coordinate_[1];\n\n  const centerX = this.centerCoordinate_[0];\n  const centerY = this.centerCoordinate_[1];\n\n  const dx1 = oldX - centerX;\n  const dy1 = oldY - centerY;\n  const dx0 = evt.coordinate[0] - centerX;\n  const dy0 = evt.coordinate[1] - centerY;\n\n  this.coordinate_[0] = evt.coordinate[0];\n  this.coordinate_[1] = evt.coordinate[1];\n\n  const a0 = Math.atan2(dy0, dx0);\n  const a1 = Math.atan2(dy1, dx1);\n  const angle = a1 - a0;\n\n  geometry.rotate(-angle, [centerX, centerY]);\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Stop drag sequence?\n * @private\n */\nexports.prototype.handleUp_ = function(evt) {\n  if (this.modified_) {\n    /** @type {ngeox.RotateEvent} */\n    const event = new ngeoCustomEvent('rotateend', {feature: this.feature_});\n    this.dispatchEvent(event);\n    this.modified_ = false;\n    this.setActive(false);\n  }\n  return false;\n};\n\n\n/**\n * Deactivate this interaction if the ESC key is pressed.\n * @param {KeyboardEvent} evt Event.\n * @private\n */\nexports.prototype.handleKeyUp_ = function(evt) {\n  // 27 == ESC key\n  if (evt.keyCode === 27) {\n    this.setActive(false);\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.features\n */\nimport olCollection from 'ol/Collection.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoFeatures', []);\n\nexports.value('ngeoFeatures', new olCollection());\n\n\nexport default exports;\n","/**\n * @module ngeo.Menu\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olOverlay from 'ol/Overlay.js';\nimport olOverlayPositioning from 'ol/OverlayPositioning.js';\n\n/**\n * @classdesc\n * An OpenLayers overlay that shows a contextual menu with configurable actions\n * anchored from its top left to a specific location. An event is fired when\n * any of the action is clicked.\n *\n * @constructor\n * @extends {ol.Overlay}\n * @param {ngeox.MenuOptions=} menuOptions Menu options.\n * @param {olx.OverlayOptions=} opt_overlayOptions Overlay options.\n */\nconst exports = function(menuOptions, opt_overlayOptions) {\n\n  const options = opt_overlayOptions !== undefined ? opt_overlayOptions : {};\n\n  options.positioning = olOverlayPositioning.TOP_LEFT;\n\n  /**\n   * @type {Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.clickOutListenerKey_ = null;\n\n  const contentEl = $('<div/>', {\n    'class': 'panel panel-default'\n  });\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.autoClose_ = menuOptions.autoClose !== undefined ?\n    menuOptions.autoClose : true;\n\n  // titleEl\n  if (menuOptions.title) {\n    const headerEl = $('<div>', {\n      'class': 'panel-heading'\n    }).appendTo(contentEl);\n\n    $('<span>', {\n      text: menuOptions.title\n    }).appendTo(headerEl);\n  }\n\n  // actionsEl\n  const actionsEl = $('<div>', {\n    'class': 'list-group'\n  }).appendTo(contentEl);\n\n  /**\n   * @type {Array.<jQuery>}\n   * @private\n   */\n  this.actions_ = [];\n\n  menuOptions.actions.forEach((action) => {\n    this.actions_.push(\n      $('<button>', {\n        'class': 'list-group-item',\n        'data-name': action.name,\n        'text': [\n          ' ',\n          (action.label) !== undefined ? action.label : action.name\n        ].join('')\n      })\n        .appendTo(actionsEl)\n        .prepend($('<span>', {\n          'class': action.cls !== undefined ? action.cls : ''\n        }))\n    );\n  });\n\n  options.element = contentEl[0];\n\n  olOverlay.call(this, options);\n\n};\n\nolBase.inherits(exports, olOverlay);\n\n\n/**\n * @param {ol.PluggableMap|undefined} map Map.\n * @export\n * @override\n */\nexports.prototype.setMap = function(map) {\n\n  const currentMap = this.getMap();\n  if (currentMap) {\n    this.listenerKeys_.forEach(olEvents.unlistenByKey);\n    this.listenerKeys_.length = 0;\n  }\n\n  olOverlay.prototype.setMap.call(this, map);\n\n  if (map) {\n    this.actions_.forEach((action) => {\n      const data = action.data();\n      this.listenerKeys_.push(\n        olEvents.listen(\n          action[0],\n          'click',\n          this.handleActionClick_.bind(this, data.name)\n        )\n      );\n    });\n\n    // Autoclose the menu when clicking anywhere else than the menu\n    this.listenerKeys_.push(\n      olEvents.listen(\n        map,\n        'pointermove',\n        this.handleMapPointerMove_,\n        this\n      )\n    );\n  }\n\n};\n\n\n/**\n * Opens the menu at the desited coordinate. Also starts listening for the\n * clickout if autoClose is enabled.\n * @param {ol.Coordinate} coordinate Where to open the menu.\n * @export\n */\nexports.prototype.open = function(coordinate) {\n  this.setPosition(coordinate);\n  if (this.autoClose_) {\n    this.clickOutListenerKey_ = olEvents.listen(\n      document.documentElement,\n      'mousedown',\n      this.handleClickOut_,\n      this\n    );\n  }\n\n};\n\n\n/**\n * @export\n */\nexports.prototype.close = function() {\n  this.setPosition(undefined);\n\n  if (this.clickOutListenerKey_ !== null) {\n    olEvents.unlistenByKey(this.clickOutListenerKey_);\n  }\n};\n\n\n/**\n * @param {string} action The action name that was clicked.\n * @param {Event} evt Event.\n * @private\n */\nexports.prototype.handleActionClick_ = function(action, evt) {\n\n  this.dispatchEvent(new ngeoCustomEvent('actionclick', {\n    action: action\n  }));\n\n  if (this.autoClose_) {\n    this.close();\n  }\n\n  evt.stopPropagation();\n};\n\n\n/**\n * Handles clicks out of the menu. If the menu is visible, close it.\n * @param {Event} evt Event.\n * @private\n */\nexports.prototype.handleClickOut_ = function(evt) {\n  const element = this.getElement();\n  if (element && $(evt.target).closest(element).length === 0) {\n    this.close();\n  }\n};\n\n\n/**\n * When the mouse is hovering the menu, set the event coordinate and pixel\n * values to Infinity to do as if the mouse had been move out of range of the\n * map. This prevents behaviours such as vertex still appearing while mouse\n * hovering edges of features bound to an active modify control while the\n * cursor is on top of the menu.\n * @param {ol.MapBrowserEvent} evt Event.\n * @private\n */\nexports.prototype.handleMapPointerMove_ = function(evt) {\n  const target = evt.originalEvent.target;\n  googAsserts.assertInstanceof(target, Element);\n\n  const element = this.getElement();\n  googAsserts.assertInstanceof(element, Element);\n\n  if (element.contains(target)) {\n    evt.coordinate = [Infinity, Infinity];\n    evt.pixel = [Infinity, Infinity];\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.download.service\n */\nimport ngeoUtils from 'ngeo/utils.js';\n\nimport {saveAs} from 'file-saver';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDownload', []);\n\n/**\n * A service to start a download for a file.\n *\n * @return {ngeox.Download} The download function.\n * @ngdoc service\n * @ngname ngeoDownload\n */\nexports.factory_ = function() {\n  /**\n   * @param {string} content The file content.\n   * @param {string} fileName The file name.\n   * @param {string=} opt_fileType The file type. If not given,\n   *    `text/plain;charset=utf-8` is used.\n   */\n  function download(content, fileName, opt_fileType) {\n    // Safari does not properly work with FileSaver. Using the the type 'text/plain'\n    // makes it a least possible to show the file content so that users can\n    // do a manual download with \"Save as\".\n    // See also: https://github.com/eligrey/FileSaver.js/issues/12\n    /** @type {string} */\n    const fileType = opt_fileType !== undefined && !ngeoUtils.isSafari() ?\n      opt_fileType : 'text/plain;charset=utf-8';\n\n    const blob = new Blob([content], {type: fileType});\n    saveAs(blob, fileName);\n  }\n\n  return download;\n};\n\nexports.factory('ngeoDownload', exports.factory_);\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.DataSourceBeingFiltered\n */\nconst exports = {};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfDataSourceBeingFiltered', []);\n// type gmfx.datasource.DataSourceBeingFiltered\nexports.module.value('gmfDataSourceBeingFiltered', {\n  dataSource: null\n});\n\n\nexport default exports;\n","/**\n * @module ngeo.message.modalComponent\n */\nimport 'jquery';\nimport 'jquery-ui';\nimport 'jquery-ui/ui/widgets/draggable.js';\nimport 'bootstrap/js/modal.js';\nimport googAsserts from 'goog/asserts.js';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('ngeoModal', []);\n\n/**\n * Provides the \"ngeoModal\" component.\n *\n * This component shows a Bootstrap modal when the `ngModel` expression\n * evaluates to `true`, and it hides it when the `ngModel` expression\n * evaluates to `false`.\n *\n * The components also changes the `ngModel` value when the user manually\n * closes the modal.\n *\n * This component is based on Bootstrap's `modal` classes and associated\n * jQuery plugin.\n *\n *     <ngeo-modal ng-model=\"modalShown\">\n *       <div class=\"modal-header\">\n *         <button type=\"button\" class=\"close\" data-dismiss=\"modal\"\n *                 aria-hidden=\"true\">&times;</button>\n *         <h4 class=\"modal-title\">The Title</h4>\n *       </div>\n *       <div class=\"modal-body\">Some content</div>\n *     </ngeo-modal>\n *\n * Note: for z-indexing purpose, the modal DOM element is automatically moved\n * to document body element.\n *\n * See our live example: [../examples/modal.html](../examples/modal.html)\n *\n * @htmlAttribute {boolean} ngeo-modal-resizable Whether the modal can be\n *     resized or not. Defaults to `false`.\n * @htmlAttribute {boolean} ngeo-modal-closable Whether the modal can be\n *     closed by clicking outside it or by hiting the `escape` keyboard key. Defaults to `true`.\n * @ngdoc component\n * @ngname ngeoModal\n * @type {!angular.Component}\n */\nexports.component_ = {\n  template: `<div class=\"modal fade\" tabindex=\"-1\" role=\"dialog\">\n    <div class=\"modal-dialog\">\n      <div class=\"modal-content\">\n        <ng-transclude></ng-transclude>\n      </div>\n    </div>\n  </div>`,\n  require: {\n    'ngModel': 'ngModel'\n  },\n  transclude: true,\n  controller: 'ngeoModalController',\n  bindings: {\n    'resizable': '<ngeoModalResizable',\n    'closable': '<ngeoModalClosable'\n  }\n};\n\nexports.component('ngeoModal', exports.component_);\n\nexports.Controller_ = class {\n  /**\n   * @ngInject\n   * @param {!angular.Scope} $scope Scope.\n   * @param {!jQuery} $element Element.\n   */\n  constructor($scope, $element) {\n    /**\n     * @private\n     * @type {!jQuery}\n     */\n    this.$element_ = $element;\n\n    /**\n     * @private\n     * @type {!angular.Scope}\n     */\n    this.$scope_ = $scope;\n\n    /**\n     * @private\n     * @type {jQuery}\n     */\n    this.modal_;\n\n    /**\n     * @export\n     * @type {boolean}\n     */\n    this.closable;\n\n    /**\n     * @export\n     * @type {boolean}\n     */\n    this.resizable;\n\n    /**\n     * @export\n     * @type {angular.NgModelController|null}\n     */\n    this.ngModel;\n  }\n\n  $postLink() {\n    this.modal_ = this.$element_.children();\n\n    if (!this.closable) {\n      this.modal_.attr('data-keyboard', false);\n      this.modal_.attr('data-backdrop', 'static');\n    }\n\n    this.resizable = !!this.resizable;\n\n    const dialog = this.modal_.find('.modal-dialog');\n    dialog.draggable({\n      'handle': '.modal-header'\n    });\n    if (this.resizable) {\n      dialog.resizable();\n    }\n\n    this.ngModel.$render = () => {\n      this.modal_.modal(this.ngModel.$viewValue ? 'show' : 'hide');\n    };\n\n    this.modal_.on('shown.bs.modal hidden.bs.modal', (e) => {\n      const type = e.type;\n      googAsserts.assert(type == 'shown' || type == 'hidden');\n      this.ngModel.$setViewValue(type == 'shown');\n    });\n  }\n\n  $onDestroy() {\n    // Force close the modal.\n    this.modal_.modal('hide');\n    this.modal_.modal('removeBackdrop');\n    // Destroy the children's plugins.\n    const dialog = this.modal_.find('.modal-dialog');\n    dialog.draggable('destroy');\n    if (this.resizable) {\n      dialog.resizable('destroy');\n    }\n  }\n};\n\nexports.controller('ngeoModalController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.Notification\n */\nimport 'bootstrap/js/alert.js';\nimport googAsserts from 'goog/asserts.js';\n\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\nimport * as olBase from 'ol/index.js';\n\n/**\n * Provides methods to display any sort of messages, notifications, errors,\n * etc. Requires Bootstrap library (both CSS and JS) to display the alerts\n * properly.\n *\n * @constructor\n * @struct\n * @extends {ngeo.message.Message}\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @ngdoc service\n * @ngname ngeoNotification\n * @abstract\n * @ngInject\n */\nconst exports = function($timeout) {\n\n  ngeoMessageMessage.call(this);\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  const container = angular.element('<div class=\"ngeo-notification\"></div>');\n  angular.element(document.body).append(container);\n\n  /**\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.container_ = container;\n\n  /**\n   * @type {Object.<number, ngeo.message.Notification.CacheItem>}\n   * @private\n   */\n  this.cache_ = {};\n\n};\n\nolBase.inherits(exports, ngeoMessageMessage);\n\n\n/**\n * Default delay (in milliseconds) a message should be displayed.\n * @type {number}\n * @private\n */\nexports.DEFAULT_DELAY_ = 7000;\n\n\n// MAIN API METHODS\n\n\n/**\n * Display the given message string or object or list of message strings or\n * objects.\n * @param {string|Array.<string>|ngeox.Message|Array.<ngeox.Message>}\n *     object A message or list of messages as text or configuration objects.\n * @export\n */\nexports.prototype.notify = function(object) {\n  this.show(object);\n};\n\n\n/**\n * Clears all messages that are currently being shown.\n * @export\n */\nexports.prototype.clear = function() {\n  for (const uid in this.cache_) {\n    this.clearMessageByCacheItem_(this.cache_[parseInt(uid, 10)]);\n  }\n};\n\n\n/**\n * @override\n */\nexports.prototype.showMessage = function(message) {\n  const type = message.type;\n  googAsserts.assertString(type, 'Type should be set.');\n\n  const classNames = ['alert', 'fade'];\n  switch (type) {\n    case ngeoMessageMessage.Type.ERROR:\n      classNames.push('alert-danger');\n      break;\n    case ngeoMessageMessage.Type.INFORMATION:\n      classNames.push('alert-info');\n      break;\n    case ngeoMessageMessage.Type.SUCCESS:\n      classNames.push('alert-success');\n      break;\n    case ngeoMessageMessage.Type.WARNING:\n      classNames.push('alert-warning');\n      break;\n    default:\n      break;\n  }\n\n  const el = angular.element(`<div class=\"${classNames.join(' ')}\"></div>`);\n  let container;\n\n  if (message.target) {\n    container = angular.element(message.target);\n  } else {\n    container = this.container_;\n  }\n\n  container.append(el);\n  el.html(message.msg).addClass('in');\n\n  const delay = message.delay !== undefined ? message.delay :\n    exports.DEFAULT_DELAY_;\n\n  const item = /** @type {ngeo.message.Notification.CacheItem} */ ({\n    el\n  });\n\n  // Keep a reference to the promise, in case we want to manually cancel it\n  // before the delay\n  const uid = olBase.getUid(el);\n  item.promise = this.timeout_(() => {\n    el.alert('close');\n    delete this.cache_[uid];\n  }, delay);\n\n  this.cache_[uid] = item;\n};\n\n\n/**\n * Clear a message using its cache item.\n * @param {ngeo.message.Notification.CacheItem} item Cache item.\n * @private\n */\nexports.prototype.clearMessageByCacheItem_ = function(item) {\n  const el = item.el;\n  const promise = item.promise;\n  const uid = olBase.getUid(el);\n\n  // Close the message\n  el.alert('close');\n\n  // Cancel timeout in case we want to stop before delay. If called by the\n  // timeout itself, then this has no consequence.\n  this.timeout_.cancel(promise);\n\n  // Delete the cache item\n  delete this.cache_[uid];\n};\n\n\n/**\n * @typedef {{\n *     el: angular.JQLite,\n *     promise: angular.$q.Promise\n * }}\n */\nexports.CacheItem;\n\n\n/**\n * @type {angular.Module}\n */\nexports.module = angular.module('ngeoNotification', [\n]);\n\nexports.module.service('ngeoNotification', exports);\n\n\nexport default exports;\n","/*!\n * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2014 - 2016\n * @version 1.3.4\n *\n * Date formatter utility library that allows formatting date/time variables or Date objects using PHP DateTime format.\n * @see http://php.net/manual/en/function.date.php\n *\n * For more JQuery plugins visit http://plugins.krajee.com\n * For more Yii related demos visit http://demos.krajee.com\n */\n\n/* eslint-disable */\nconst DAY = 1000 * 60 * 60 * 24;\nconst HOUR = 3600;\n\nconst _compare = function(str1, str2) {\n  return typeof (str1) === 'string' && typeof (str2) === 'string' && str1.toLowerCase() === str2.toLowerCase();\n};\nconst _lpad = function(value, length, char) {\n  const chr = char || '0';\n  const val = value.toString();\n  return val.length < length ? _lpad(chr + val, length) : val;\n};\nconst _extend = function(out) {\n  let i, obj;\n  out = out || {};\n  for (i = 1; i < arguments.length; i++) {\n    obj = arguments[i];\n    if (!obj) {\n      continue;\n    }\n    for (const key in obj) {\n      if (obj.hasOwnProperty(key)) {\n        if (typeof obj[key] === 'object') {\n          _extend(out[key], obj[key]);\n        } else {\n          out[key] = obj[key];\n        }\n      }\n    }\n  }\n  return out;\n};\nconst _indexOf = function(val, arr) {\n  for (let i = 0; i < arr.length; i++) {\n    if (arr[i].toLowerCase() === val.toLowerCase()) {\n      return i;\n    }\n  }\n  return -1;\n};\nconst defaultSettings = {\n  dateSettings: {\n    days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],\n    daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],\n    months: [\n      'January', 'February', 'March', 'April', 'May', 'June', 'July',\n      'August', 'September', 'October', 'November', 'December'\n    ],\n    monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],\n    meridiem: ['AM', 'PM'],\n    ordinal: function(number) {\n      const n = number % 10, suffixes = {1: 'st', 2: 'nd', 3: 'rd'};\n      return Math.floor(number % 100 / 10) === 1 || !suffixes[n] ? 'th' : suffixes[n];\n    }\n  },\n  separators: /[ \\-+\\/\\.T:@]/g,\n  validParts: /[dDjlNSwzWFmMntLoYyaABgGhHisueTIOPZcrU]/g,\n  intParts: /[djwNzmnyYhHgGis]/g,\n  tzParts: /\\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\\d{4})?)\\b/g,\n  tzClip: /[^-+\\dA-Z]/g\n};\n\nconst DateFormatter = function(options) {\n  const self = this;\n  const config = _extend(defaultSettings, options);\n  self.dateSettings = config.dateSettings;\n  self.separators = config.separators;\n  self.validParts = config.validParts;\n  self.intParts = config.intParts;\n  self.tzParts = config.tzParts;\n  self.tzClip = config.tzClip;\n};\n\nDateFormatter.prototype = {\n  constructor: DateFormatter,\n  getMonth: function(val) {\n    const self = this;\n    let i;\n    i = _indexOf(val, self.dateSettings.monthsShort) + 1;\n    if (i === 0) {\n      i = _indexOf(val, self.dateSettings.months) + 1;\n    }\n    return i;\n  },\n  parseDate: function(vDate, vFormat) {\n    const self = this, out = {date: null, year: null, month: null, day: null, hour: 0, min: 0, sec: 0}, vSettings = self.dateSettings;\n    let i, vDateFlag = false, vTimeFlag = false, vDatePart, iDatePart,\n        vMonth, vMeriIndex, vMeriOffset, len, mer;\n    if (!vDate) {\n      return null;\n    }\n    if (vDate instanceof Date) {\n      return vDate;\n    }\n    if (vFormat === 'U') {\n      i = parseInt(vDate);\n      return i ? new Date(i * 1000) : vDate;\n    }\n    switch (typeof vDate) {\n      case 'number':\n        return new Date(vDate);\n      case 'string':\n        break;\n      default:\n        return null;\n    }\n    const vFormatParts = vFormat.match(self.validParts);\n    if (!vFormatParts || vFormatParts.length === 0) {\n      throw new Error('Invalid date format definition.');\n    }\n    const vDateParts = vDate.replace(self.separators, '\\0').split('\\0');\n    for (i = 0; i < vDateParts.length; i++) {\n      vDatePart = vDateParts[i];\n      iDatePart = parseInt(vDatePart);\n      switch (vFormatParts[i]) {\n        case 'y':\n        case 'Y':\n          if (iDatePart) {\n            len = vDatePart.length;\n            out.year = len === 2 ? parseInt((iDatePart < 70 ? '20' : '19') + vDatePart) : iDatePart;\n          } else {\n            return null;\n          }\n          vDateFlag = true;\n          break;\n        case 'm':\n        case 'n':\n        case 'M':\n        case 'F':\n          if (isNaN(iDatePart)) {\n            vMonth = self.getMonth(vDatePart);\n            if (vMonth > 0) {\n              out.month = vMonth;\n            } else {\n              return null;\n            }\n          } else {\n            if (iDatePart >= 1 && iDatePart <= 12) {\n              out.month = iDatePart;\n            } else {\n              return null;\n            }\n          }\n          vDateFlag = true;\n          break;\n        case 'd':\n        case 'j':\n          if (iDatePart >= 1 && iDatePart <= 31) {\n            out.day = iDatePart;\n          } else {\n            return null;\n          }\n          vDateFlag = true;\n          break;\n        case 'g':\n        case 'h':\n          vMeriIndex = (vFormatParts.indexOf('a') > -1) ? vFormatParts.indexOf('a') :\n            (vFormatParts.indexOf('A') > -1) ? vFormatParts.indexOf('A') : -1;\n          mer = vDateParts[vMeriIndex];\n          if (vMeriIndex > -1) {\n            vMeriOffset = _compare(mer, vSettings.meridiem[0]) ? 0 :\n              (_compare(mer, vSettings.meridiem[1]) ? 12 : -1);\n            if (iDatePart >= 1 && iDatePart <= 12 && vMeriOffset > -1) {\n              out.hour = iDatePart + vMeriOffset - 1;\n            } else if (iDatePart >= 0 && iDatePart <= 23) {\n              out.hour = iDatePart;\n            }\n          } else {\n            if (iDatePart >= 0 && iDatePart <= 23) {\n              out.hour = iDatePart;\n            } else {\n              return null;\n            }\n          }\n          vTimeFlag = true;\n          break;\n        case 'G':\n        case 'H':\n          if (iDatePart >= 0 && iDatePart <= 23) {\n            out.hour = iDatePart;\n          } else {\n            return null;\n          }\n          vTimeFlag = true;\n          break;\n        case 'i':\n          if (iDatePart >= 0 && iDatePart <= 59) {\n            out.min = iDatePart;\n          } else {\n            return null;\n          }\n          vTimeFlag = true;\n          break;\n        case 's':\n          if (iDatePart >= 0 && iDatePart <= 59) {\n            out.sec = iDatePart;\n          } else {\n            return null;\n          }\n          vTimeFlag = true;\n          break;\n      }\n    }\n    if (vDateFlag === true && out.year && out.month && out.day) {\n      out.date = new Date(out.year, out.month - 1, out.day, out.hour, out.min, out.sec, 0);\n    } else {\n      if (vTimeFlag !== true) {\n        return null;\n      }\n      out.date = new Date(0, 0, 0, out.hour, out.min, out.sec, 0);\n    }\n    return out.date;\n  },\n  guessDate: function(vDateStr, vFormat) {\n    if (typeof vDateStr !== 'string') {\n      return vDateStr;\n    }\n    const self = this, vParts = vDateStr.replace(self.separators, '\\0').split('\\0'), vPattern = /^[djmn]/g, vFormatParts = vFormat.match(self.validParts), vDate = new Date(), vDigit = 0;\n    let len, i, n, iPart, iSec, vYear;\n\n    if (!vPattern.test(vFormatParts[0])) {\n      return vDateStr;\n    }\n\n    for (i = 0; i < vParts.length; i++) {\n      let vDigit = 2;\n      iPart = vParts[i];\n      iSec = parseInt(iPart.substr(0, 2));\n      if (isNaN(iSec)) {\n        return null;\n      }\n      switch (i) {\n        case 0:\n          if (vFormatParts[0] === 'm' || vFormatParts[0] === 'n') {\n            vDate.setMonth(iSec - 1);\n          } else {\n            vDate.setDate(iSec);\n          }\n          break;\n        case 1:\n          if (vFormatParts[0] === 'm' || vFormatParts[0] === 'n') {\n            vDate.setDate(iSec);\n          } else {\n            vDate.setMonth(iSec - 1);\n          }\n          break;\n        case 2:\n          vYear = vDate.getFullYear();\n          len = iPart.length;\n          vDigit = len < 4 ? len : 4;\n          vYear = parseInt(len < 4 ? vYear.toString().substr(0, 4 - len) + iPart : iPart.substr(0, 4));\n          if (!vYear) {\n            return null;\n          }\n          vDate.setFullYear(vYear);\n          break;\n        case 3:\n          vDate.setHours(iSec);\n          break;\n        case 4:\n          vDate.setMinutes(iSec);\n          break;\n        case 5:\n          vDate.setSeconds(iSec);\n          break;\n      }\n      n = iPart.substr(vDigit);\n      if (n.length > 0) {\n        vParts.splice(i + 1, 0, n);\n      }\n    }\n    return vDate;\n  },\n  parseFormat: function(vChar, vDate) {\n    let fmt;\n    const self = this, vSettings = self.dateSettings, backslash = /\\\\?(.?)/gi, doFormat = function(t, s) {\n      return fmt[t] ? fmt[t]() : s;\n    };\n    fmt = {\n      /////////\n      // DAY //\n      /////////\n      /**\n       * Day of month with leading 0: `01..31`\n       * @return {string}\n       */\n      d: function() {\n        return _lpad(fmt.j(), 2);\n      },\n      /**\n       * Shorthand day name: `Mon...Sun`\n       * @return {string}\n       */\n      D: function() {\n        return vSettings.daysShort[fmt.w()];\n      },\n      /**\n       * Day of month: `1..31`\n       * @return {number}\n       */\n      j: function() {\n        return vDate.getDate();\n      },\n      /**\n       * Full day name: `Monday...Sunday`\n       * @return {number}\n       */\n      l: function() {\n        return vSettings.days[fmt.w()];\n      },\n      /**\n       * ISO-8601 day of week: `1[Mon]..7[Sun]`\n       * @return {number}\n       */\n      N: function() {\n        return fmt.w() || 7;\n      },\n      /**\n       * Day of week: `0[Sun]..6[Sat]`\n       * @return {number}\n       */\n      w: function() {\n        return vDate.getDay();\n      },\n      /**\n       * Day of year: `0..365`\n       * @return {number}\n       */\n      z: function() {\n        const a = new Date(fmt.Y(), fmt.n() - 1, fmt.j()), b = new Date(fmt.Y(), 0, 1);\n        return Math.round((a - b) / DAY);\n      },\n\n      //////////\n      // WEEK //\n      //////////\n      /**\n       * ISO-8601 week number\n       * @return {number}\n       */\n      W: function() {\n        const a = new Date(fmt.Y(), fmt.n() - 1, fmt.j() - fmt.N() + 3), b = new Date(a.getFullYear(), 0, 4);\n        return _lpad(1 + Math.round((a - b) / DAY / 7), 2);\n      },\n\n      ///////////\n      // MONTH //\n      ///////////\n      /**\n       * Full month name: `January...December`\n       * @return {string}\n       */\n      F: function() {\n        return vSettings.months[vDate.getMonth()];\n      },\n      /**\n       * Month w/leading 0: `01..12`\n       * @return {string}\n       */\n      m: function() {\n        return _lpad(fmt.n(), 2);\n      },\n      /**\n       * Shorthand month name; `Jan...Dec`\n       * @return {string}\n       */\n      M: function() {\n        return vSettings.monthsShort[vDate.getMonth()];\n      },\n      /**\n       * Month: `1...12`\n       * @return {number}\n       */\n      n: function() {\n        return vDate.getMonth() + 1;\n      },\n      /**\n       * Days in month: `28...31`\n       * @return {number}\n       */\n      t: function() {\n        return (new Date(fmt.Y(), fmt.n(), 0)).getDate();\n      },\n\n      //////////\n      // YEAR //\n      //////////\n      /**\n       * Is leap year? `0 or 1`\n       * @return {number}\n       */\n      L: function() {\n        const Y = fmt.Y();\n        return (Y % 4 === 0 && Y % 100 !== 0 || Y % 400 === 0) ? 1 : 0;\n      },\n      /**\n       * ISO-8601 year\n       * @return {number}\n       */\n      o: function() {\n        const n = fmt.n(), W = fmt.W(), Y = fmt.Y();\n        return Y + (n === 12 && W < 9 ? 1 : n === 1 && W > 9 ? -1 : 0);\n      },\n      /**\n       * Full year: `e.g. 1980...2010`\n       * @return {number}\n       */\n      Y: function() {\n        return vDate.getFullYear();\n      },\n      /**\n       * Last two digits of year: `00...99`\n       * @return {string}\n       */\n      y: function() {\n        return fmt.Y().toString().slice(-2);\n      },\n\n      //////////\n      // TIME //\n      //////////\n      /**\n       * Meridian lower: `am or pm`\n       * @return {string}\n       */\n      a: function() {\n        return fmt.A().toLowerCase();\n      },\n      /**\n       * Meridian upper: `AM or PM`\n       * @return {string}\n       */\n      A: function() {\n        const n = fmt.G() < 12 ? 0 : 1;\n        return vSettings.meridiem[n];\n      },\n      /**\n       * Swatch Internet time: `000..999`\n       * @return {string}\n       */\n      B: function() {\n        const H = vDate.getUTCHours() * HOUR, i = vDate.getUTCMinutes() * 60, s = vDate.getUTCSeconds();\n        return _lpad(Math.floor((H + i + s + HOUR) / 86.4) % 1000, 3);\n      },\n      /**\n       * 12-Hours: `1..12`\n       * @return {number}\n       */\n      g: function() {\n        return fmt.G() % 12 || 12;\n      },\n      /**\n       * 24-Hours: `0..23`\n       * @return {number}\n       */\n      G: function() {\n        return vDate.getHours();\n      },\n      /**\n       * 12-Hours with leading 0: `01..12`\n       * @return {string}\n       */\n      h: function() {\n        return _lpad(fmt.g(), 2);\n      },\n      /**\n       * 24-Hours w/leading 0: `00..23`\n       * @return {string}\n       */\n      H: function() {\n        return _lpad(fmt.G(), 2);\n      },\n      /**\n       * Minutes w/leading 0: `00..59`\n       * @return {string}\n       */\n      i: function() {\n        return _lpad(vDate.getMinutes(), 2);\n      },\n      /**\n       * Seconds w/leading 0: `00..59`\n       * @return {string}\n       */\n      s: function() {\n        return _lpad(vDate.getSeconds(), 2);\n      },\n      /**\n       * Microseconds: `000000-999000`\n       * @return {string}\n       */\n      u: function() {\n        return _lpad(vDate.getMilliseconds() * 1000, 6);\n      },\n\n      //////////////\n      // TIMEZONE //\n      //////////////\n      /**\n       * Timezone identifier: `e.g. Atlantic/Azores, ...`\n       * @return {string}\n       */\n      e: function() {\n        const str = /\\((.*)\\)/.exec(String(vDate))[1];\n        return str || 'Coordinated Universal Time';\n      },\n      /**\n       * DST observed? `0 or 1`\n       * @return {number}\n       */\n      I: function() {\n        const a = new Date(fmt.Y(), 0), c = Date.UTC(fmt.Y(), 0),\n            b = new Date(fmt.Y(), 6), d = Date.UTC(fmt.Y(), 6);\n        return ((a - c) !== (b - d)) ? 1 : 0;\n      },\n      /**\n       * Difference to GMT in hour format: `e.g. +0200`\n       * @return {string}\n       */\n      O: function() {\n        const tzo = vDate.getTimezoneOffset(), a = Math.abs(tzo);\n        return (tzo > 0 ? '-' : '+') + _lpad(Math.floor(a / 60) * 100 + a % 60, 4);\n      },\n      /**\n       * Difference to GMT with colon: `e.g. +02:00`\n       * @return {string}\n       */\n      P: function() {\n        const O = fmt.O();\n        return (`${O.substr(0, 3)}:${O.substr(3, 2)}`);\n      },\n      /**\n       * Timezone abbreviation: `e.g. EST, MDT, ...`\n       * @return {string}\n       */\n      T: function() {\n        const str = (String(vDate).match(self.tzParts) || ['']).pop().replace(self.tzClip, '');\n        return str || 'UTC';\n      },\n      /**\n       * Timezone offset in seconds: `-43200...50400`\n       * @return {number}\n       */\n      Z: function() {\n        return -vDate.getTimezoneOffset() * 60;\n      },\n\n      ////////////////////\n      // FULL DATE TIME //\n      ////////////////////\n      /**\n       * ISO-8601 date\n       * @return {string}\n       */\n      c: function() {\n        return 'Y-m-d\\\\TH:i:sP'.replace(backslash, doFormat);\n      },\n      /**\n       * RFC 2822 date\n       * @return {string}\n       */\n      r: function() {\n        return 'D, d M Y H:i:s O'.replace(backslash, doFormat);\n      },\n      /**\n       * Seconds since UNIX epoch\n       * @return {number}\n       */\n      U: function() {\n        return vDate.getTime() / 1000 || 0;\n      }\n    };\n    return doFormat(vChar, vChar);\n  },\n  formatDate: function(vDate, vFormat) {\n    const self = this;\n    let i, n, len, str, vChar, vDateStr = '';\n    const BACKSLASH = '\\\\';\n    if (typeof vDate === 'string') {\n      vDate = self.parseDate(vDate, vFormat);\n      if (!vDate) {\n        return null;\n      }\n    }\n    if (vDate instanceof Date) {\n      len = vFormat.length;\n      for (i = 0; i < len; i++) {\n        vChar = vFormat.charAt(i);\n        if (vChar === 'S' || vChar === BACKSLASH) {\n          continue;\n        }\n        if (i > 0 && vFormat.charAt(i - 1) === BACKSLASH) {\n          vDateStr += vChar;\n          continue;\n        }\n        str = self.parseFormat(vChar, vDate);\n        if (i !== (len - 1) && self.intParts.test(vChar) && vFormat.charAt(i + 1) === 'S') {\n          n = parseInt(str) || 0;\n          str += self.dateSettings.ordinal(n);\n        }\n        vDateStr += str;\n      }\n      return vDateStr;\n    }\n    return '';\n  }\n};\n/* eslint-enable */\n\nexport default DateFormatter;\n","/**\n * @module gmf.permalink.ShareService\n */\n/**\n * Service to handle the sharing of the permalink.\n * @param {angular.$http} $http Angular http service.\n * @param  {string} gmfShortenerCreateUrl URL for the shortener API\n * @constructor\n * @struct\n * @ngInject\n * @export\n * @ngname gmfShareService\n */\nconst exports = function($http, gmfShortenerCreateUrl) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.gmfShortenerCreateUrl_ = gmfShortenerCreateUrl;\n\n};\n\n\n/**\n * Get a short URL of the permalink by calling the url shortener service.\n * - If no shortener API url have been specified, it returns the permalink itself.\n * @param  {string} url the permalink\n * @return {gmfx.ShortenerAPIResponse|angular.$http.HttpPromise} an object containing the permalink not shortened or\n * the promise attached to the shortener API request\n */\nexports.prototype.getShortUrl = function(url) {\n  const params = /** @type {gmfx.ShortenerAPIRequestParams} */ ({\n    url\n  });\n\n  if (!this.gmfShortenerCreateUrl_) {\n    return {\n      data: {\n        short_url: url\n      },\n      status: 200\n    };\n  }\n\n  return this.postShortUrl_(params);\n};\n\n\n/**\n * Send the short permalink to the email provided\n * - If email is provided, the short permalink will be sent to this email\n * @param  {string} shortUrl the short permalink to send\n * @param  {string} email the email to which the short url must be send\n * @param  {string=} opt_message message for the email\n * @return {angular.$http.HttpPromise} the promise attached to the shortener API request\n */\nexports.prototype.sendShortUrl = function(shortUrl, email, opt_message) {\n  const params = /** @type {gmfx.ShortenerAPIRequestParams} */ ({\n    url: shortUrl,\n    email: email\n  });\n\n  if (opt_message) {\n    params['message'] = opt_message;\n  }\n\n  return this.postShortUrl_(params);\n};\n\n\n/**\n * @param  {gmfx.ShortenerAPIRequestParams} params parameters for the request\n * @return {angular.$http.HttpPromise} the promise attached to the shortener API request\n * @private\n */\nexports.prototype.postShortUrl_ = function(params) {\n  // Override default behavior of $http.post method (sending data in json format)\n  return this.$http_.post(this.gmfShortenerCreateUrl_, $.param(params), {\n    headers: {'Content-Type': 'application/x-www-form-urlencoded'}\n  });\n};\n\n\n/**\n * Max length defined for the complete url.\n * Check IE limits, see {@link http://support.microsoft.com/kb/208427}\n * @constant\n * @type {number}\n */\nexports.URL_MAX_LEN = 2083;\n\n/**\n * Max length defined for the url parth section.\n * Check IE limits, see {@link http://support.microsoft.com/kb/208427}\n * @constant\n * @type {number}\n */\nexports.URL_PATH_MAX_LEN = 2048;\n\nexports.module = angular.module('gmfShareService', []);\n\nexports.module.service('gmfShareService', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.print.Utils\n */\nimport * as olHas from 'ol/has.js';\nimport * as olMath from 'ol/math.js';\n\n/**\n * Provides a service with print utility functions.\n *\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoPrintUtils\n */\nconst exports = function() {\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.extentHalfHorizontalDistance_;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.extentHalfVerticalDistance_;\n\n};\n\n\n/**\n * @const\n * @private\n */\nexports.INCHES_PER_METER_ = 39.37;\n\n\n/**\n * @const\n * @private\n */\nexports.DOTS_PER_INCH_ = 72;\n\n\n/**\n * Return a function to use as map postcompose listener for drawing a print\n * mask on the map.\n * @param {function():ol.Size} getSize User-defined function returning the\n *     size in dots of the map to print.\n * @param {function(olx.FrameState):number} getScale User-defined function\n *     returning the scale of the map to print.\n * @param {function():number=} opt_rotation User defined function returning the\n *     inclination of the canvas in degree (-180 to 180).\n * returning the scale of the map to print.\n * @return {function(ol.render.Event)} Function to use as a map postcompose\n * listener.\n * @export\n */\nexports.prototype.createPrintMaskPostcompose = function(getSize, getScale, opt_rotation) {\n  const self = this;\n\n  return (\n  /**\n        * @param {ol.render.Event} evt Postcompose event.\n        */\n    function(evt) {\n      const context = evt.context;\n      const frameState = evt.frameState;\n\n      const resolution = frameState.viewState.resolution;\n\n      const viewportWidth = frameState.size[0] * frameState.pixelRatio;\n      const viewportHeight = frameState.size[1] * frameState.pixelRatio;\n\n      const center = [viewportWidth / 2, viewportHeight / 2];\n\n      const size = getSize();\n      const height = size[1] * olHas.DEVICE_PIXEL_RATIO;\n      const width = size[0] * olHas.DEVICE_PIXEL_RATIO;\n      const scale = getScale(frameState);\n\n      const ppi = exports.DOTS_PER_INCH_;\n      const ipm = exports.INCHES_PER_METER_;\n\n      const extentHalfWidth =\n           (((width / ppi) / ipm) * scale / resolution) / 2;\n      self.extentHalfHorizontalDistance_ =\n           (((size[0] / ppi) / ipm) * scale) / 2;\n\n      const extentHalfHeight =\n           (((height / ppi) / ipm) * scale / resolution) / 2;\n      self.extentHalfVerticalDistance_ =\n           (((size[1] / ppi) / ipm) * scale) / 2;\n\n      // Draw a mask on the whole map.\n      context.beginPath();\n      context.moveTo(0, 0);\n      context.lineTo(viewportWidth, 0);\n      context.lineTo(viewportWidth, viewportHeight);\n      context.lineTo(0, viewportHeight);\n      context.lineTo(0, 0);\n      context.closePath();\n\n      // Draw the print zone\n      if (!opt_rotation) {\n        self.drawPrintZone_(context, center, extentHalfWidth,\n          extentHalfHeight);\n      } else {\n        const rotation = olMath.toRadians(opt_rotation());\n        self.drawPrintZoneWithRotation_(context, center, extentHalfWidth,\n          extentHalfHeight, rotation);\n      }\n\n      // Fill the mask\n      context.fillStyle = 'rgba(0, 5, 25, 0.5)';\n      context.fill();\n    }\n  );\n};\n\n\n/**\n * @param {CanvasRenderingContext2D} context Context of the Postcompose event.\n * @param {Array.<number>} center Center of the viewport (x; y).\n * @param {number} extentHalfWidth Extent half width.\n * @param {number} extentHalfHeight Extent half height.\n * @private\n */\nexports.prototype.drawPrintZone_ = function(context, center,\n  extentHalfWidth, extentHalfHeight) {\n  const minx = center[0] - extentHalfWidth;\n  const miny = center[1] - extentHalfHeight;\n  const maxx = center[0] + extentHalfWidth;\n  const maxy = center[1] + extentHalfHeight;\n\n  context.moveTo(minx, miny);\n  context.lineTo(minx, maxy);\n  context.lineTo(maxx, maxy);\n  context.lineTo(maxx, miny);\n  context.lineTo(minx, miny);\n  context.closePath();\n};\n\n\n/**\n * @param {CanvasRenderingContext2D} context Context of the Postcompose event.\n * @param {Array.<number>} center Center of the viewport (x; y).\n * @param {number} extentHalfWidth Extent half width.\n * @param {number} extentHalfHeight Extent half height.\n * @param {number} rotation Rotation value in radians.\n * @private\n */\nexports.prototype.drawPrintZoneWithRotation_ = function(context, center,\n  extentHalfWidth, extentHalfHeight, rotation) {\n  // diagonal = distance p1 to center.\n  const diagonal = Math.sqrt(Math.pow(extentHalfWidth, 2) +\n      Math.pow(extentHalfHeight, 2));\n  // gamma = angle between horizontal and diagonal (with rotation).\n  const gamma = Math.atan(extentHalfHeight / extentHalfWidth) - rotation;\n  // omega = angle between diagonal and vertical (with rotation).\n  const omega = Math.atan(extentHalfWidth / extentHalfHeight) - rotation;\n  // Calculation of each corner.\n  const x1 = center[0] - Math.cos(gamma) * diagonal;\n  const y1 = center[1] + Math.sin(gamma) * diagonal;\n  const x2 = center[0] + Math.sin(omega) * diagonal;\n  const y2 = center[1] + Math.cos(omega) * diagonal;\n  const x3 = center[0] + Math.cos(gamma) * diagonal;\n  const y3 = center[1] - Math.sin(gamma) * diagonal;\n  const x4 = center[0] - Math.sin(omega) * diagonal;\n  const y4 = center[1] - Math.cos(omega) * diagonal;\n\n  context.moveTo(x1, y1);\n  context.lineTo(x2, y2);\n  context.lineTo(x3, y3);\n  context.lineTo(x4, y4);\n  context.lineTo(x1, y1);\n  context.closePath();\n};\n\n\n/**\n * Get the optimal print scale for a map, the map being defined by its\n * size (in pixels) and resolution (in map units per pixel).\n * @param {ol.Size} mapSize Size of the map on the screen (px).\n * @param {number} mapResolution Resolution of the map on the screen.\n * @param {ol.Size} printMapSize Size of the map on the paper (dots).\n * @param {Array.<number>} printMapScales Supported map scales on the paper.\n * The scales are provided as scale denominators, sorted in ascending order.\n * E.g. `[500, 1000, 2000, 4000]`.\n * @return {number} The best scale. `-1` is returned if there is no optimal\n * scale, that is the optimal scale is lower than or equal to the first value\n * in `printMapScales`.\n * @export\n */\nexports.prototype.getOptimalScale = function(\n  mapSize, mapResolution, printMapSize, printMapScales) {\n\n  const mapWidth = mapSize[0] * mapResolution;\n  const mapHeight = mapSize[1] * mapResolution;\n\n  const scaleWidth = mapWidth * exports.INCHES_PER_METER_ *\n      exports.DOTS_PER_INCH_ / printMapSize[0];\n  const scaleHeight = mapHeight * exports.INCHES_PER_METER_ *\n      exports.DOTS_PER_INCH_ / printMapSize[1];\n\n  const scale = Math.min(scaleWidth, scaleHeight);\n\n  let optimal = -1;\n  for (let i = 0, ii = printMapScales.length; i < ii; ++i) {\n    if (scale > printMapScales[i]) {\n      optimal = printMapScales[i];\n    }\n  }\n\n  return optimal;\n};\n\n\n/**\n * Get the optimal map resolution for a print scale and a map size.\n * @param {ol.Size} mapSize Size of the map on the screen (px).\n * @param {ol.Size} printMapSize Size of the map on the paper (dots).\n * @param {number} printMapScale Map scale on the paper.\n * @return {number} The optimal map resolution.\n * @export\n */\nexports.prototype.getOptimalResolution = function(\n  mapSize, printMapSize, printMapScale) {\n\n  const dotsPerMeter =\n      exports.DOTS_PER_INCH_ * exports.INCHES_PER_METER_;\n\n  const resolutionX = (printMapSize[0] * printMapScale) /\n      (dotsPerMeter * mapSize[0]);\n  const resolutionY = (printMapSize[1] * printMapScale) /\n      (dotsPerMeter * mapSize[1]);\n\n  const optimalResolution = Math.max(resolutionX, resolutionY);\n\n  return optimalResolution;\n};\n\n\n/**\n * Get the coordinates of the bottom left corner of the printed map.\n * @param {ol.Coordinate} mapCenter Center of the map to print.\n * @return {ol.Coordinate} The coordinates of the bottom left corner.\n */\nexports.prototype.getBottomLeftCorner = function(mapCenter) {\n  return [mapCenter[0] - this.extentHalfHorizontalDistance_,\n    mapCenter[1] - this.extentHalfVerticalDistance_];\n};\n\n\n/**\n * Get the coordinates of the bottom right corner of the printed map.\n * @param {ol.Coordinate} mapCenter Center of the map to print.ç\n * @return {ol.Coordinate} The coordinates of the bottom right corner.\n */\nexports.prototype.getBottomRightCorner = function(mapCenter) {\n  return [mapCenter[0] + this.extentHalfHorizontalDistance_,\n    mapCenter[1] - this.extentHalfVerticalDistance_];\n};\n\n\n/**\n * Get the coordinates of the up left corner of the printed map.\n * @param {ol.Coordinate} mapCenter Center of the map to print.\n * @return {ol.Coordinate} The coordinates of the up left corner.\n */\nexports.prototype.getUpLeftCorner = function(mapCenter) {\n  return [mapCenter[0] - this.extentHalfHorizontalDistance_,\n    mapCenter[1] + this.extentHalfVerticalDistance_];\n};\n\n\n/**\n * Get the coordinates of the up right corner of the printed map.\n * @param {ol.Coordinate} mapCenter Center of the map to print.\n * @return {ol.Coordinate} The coordinates of the up right corner.\n */\nexports.prototype.getUpRightCorner = function(mapCenter) {\n  return [mapCenter[0] + this.extentHalfHorizontalDistance_,\n    mapCenter[1] + this.extentHalfVerticalDistance_];\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoPrintUtils', []);\nexports.module.service('ngeoPrintUtils', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.proj.EPSG21781\n */\nimport * as olProj from 'ol/proj.js';\n\n/** @suppress {extraRequire} */\nimport * as olProjProj4 from 'ol/proj/proj4.js';\n\nimport somerc from 'ngeo/proj/somerc.js';\nimport proj4 from 'proj4';\n\nconst epsg21781def = [\n  `+proj=${somerc}`,\n  '+lat_0=46.95240555555556',\n  '+lon_0=7.439583333333333',\n  '+k_0=1',\n  '+x_0=600000',\n  '+y_0=200000',\n  '+ellps=bessel',\n  '+towgs84=674.374,15.056,405.346,0,0,0,0',\n  '+units=m',\n  '+no_defs'\n].join(' ');\nconst epsg21781extent = [420000, 30000, 900000, 350000];\n\nproj4.defs('EPSG:21781', epsg21781def);\nolProjProj4.register(proj4);\nolProj.get('EPSG:21781').setExtent(epsg21781extent);\n\nconst exports = 'EPSG:21781';\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.MeasureLength\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionMeasure from 'ngeo/interaction/Measure.js';\nimport * as olBase from 'ol/index.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\nimport {distance} from 'ol/coordinate.js';\nimport {containsXY} from 'ol/extent';\n\nlet modifierPressed = undefined;\n\n\n/**\n * @classdesc\n * Interaction dedicated to measure length.\n *\n * See our live example: [../examples/measure.html](../examples/measure.html)\n *\n * @constructor\n * @struct\n * @extends {ngeo.interaction.Measure}\n * @param {!ngeox.unitPrefix} format The format function\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {ngeox.interaction.MeasureOptions=} options Options\n */\nconst exports = function(format, gettextCatalog, options = /** @type {ngeox.interaction.MeasureOptions} */({})) {\n\n  ngeoInteractionMeasure.call(this, /** @type {ngeo.interaction.MeasureBaseOptions} */ (options));\n\n  if (modifierPressed === undefined) {\n    modifierPressed = false;\n    document.body.addEventListener('keydown', (evt) => {\n      modifierPressed = evt.keyCode === 17; // Ctrl key\n    });\n    document.body.addEventListener('keyup', () => {\n      modifierPressed = false;\n    });\n  }\n\n  if (options.continueMsg !== undefined) {\n    this.continueMsg = options.continueMsg;\n  } else {\n    this.continueMsg = document.createElement('span');\n    this.continueMsg.textContent = gettextCatalog.getString('Click to continue drawing the line.');\n    const br = document.createElement('br');\n    br.textContent = gettextCatalog.getString('Double-click or click last point to finish.');\n    this.continueMsg.appendChild(br);\n  }\n\n  /**\n   * The format function\n   * @type {ngeox.unitPrefix}\n   */\n  this.format = format;\n\n  /**\n   * The snapping tolerance in pixels.\n   * @params {number}\n   */\n  this.tolerance = options.tolerance;\n\n  /**\n   * The snapping source\n   * @params {ol.source.Vector}\n   */\n  this.source = options.source;\n};\n\nolBase.inherits(exports, ngeoInteractionMeasure);\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.createDrawInteraction = function(style, source) {\n  return new olInteractionDraw({\n    type: /** @type {ol.geom.GeometryType} */ ('LineString'),\n    geometryFunction: this.linestringGeometryFunction.bind(this),\n    condition: () => true,\n    style: style,\n    source: source,\n  });\n};\n\n\n/**\n * Create a `linestringGeometryFunction` that will create a line string with segments\n * snapped to π/4 angle.\n * Use this with the draw interaction and `type: 'LineString'`.\n * @param {LineCoordType} coordinates Coordinates.\n * @param {LineString=} opt_geometry Geometry.\n * @return {LineString} Geometry.\n */\nexports.prototype.linestringGeometryFunction = function(coordinates, opt_geometry) {\n  if (modifierPressed) {\n    const viewRotation = this.getMap().getView().getRotation();\n    const angle = Math.PI / 4;\n    const from = coordinates[coordinates.length - 2];\n    const to = coordinates[coordinates.length - 1];\n    const dx = from[0] - to[0];\n    const dy = from[1] - to[1];\n    const length = distance(from, to);\n    const rotation = viewRotation + Math.round((Math.atan2(dy, dx) - viewRotation) / angle) * angle;\n\n    to[0] = from[0] - (length * Math.cos(rotation));\n    to[1] = from[1] - (length * Math.sin(rotation));\n\n    if (this.tolerance !== undefined && this.source !== undefined) {\n      const delta = this.getMap().getView().getResolution() * this.tolerance;\n      const bbox = [to[0] - delta, to[1] - delta, to[0] + delta, to[1] + delta];\n\n      const layerSource = this.source;\n      const featuresInExtent = layerSource.getFeaturesInExtent(bbox);\n      featuresInExtent.forEach((feature) => {\n\n        let lastIntersection = [];\n        let bestIntersection = [];\n        let bestDistance = Infinity;\n\n        // Line points are: from A to M (to B that we need to find)\n        const distanceFromTo = distance(from, to);\n        const ax = from[0];\n        const ay = from[1];\n        const mx = to[0];\n        const my = to[1];\n        const unitVector = [(mx - ax) / distanceFromTo, (my - ay) / distanceFromTo];\n        const b = [(ax + (distanceFromTo + delta) * unitVector[0]), (ay + (distanceFromTo + delta) * unitVector[1])];\n\n        feature.getGeometry().forEachSegment((point1, point2) => {\n          // intersection calculation\n          lastIntersection = this.computeLineSegmentIntersection(from, b, point1, point2);\n          if (lastIntersection !== undefined && containsXY(bbox, lastIntersection[0], lastIntersection[1])) {\n            const lastDistance = distance(to, lastIntersection);\n            if (lastDistance < bestDistance) {\n              bestDistance = lastDistance;\n              bestIntersection = lastIntersection;\n            }\n          }\n        });\n\n        if (bestIntersection) {\n          to[0] = bestIntersection[0] || to[0];\n          to[1] = bestIntersection[1] || to[1];\n        }\n      });\n    }\n  }\n\n  const geometry = opt_geometry;\n  if (geometry) {\n    geometry.setCoordinates(coordinates);\n    return geometry;\n  }\n  return new olGeomLineString(coordinates);\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.handleMeasure = function(callback) {\n  const geom = googAsserts.assertInstanceof(this.sketchFeature.getGeometry(), olGeomLineString);\n  const proj = this.getMap().getView().getProjection();\n  googAsserts.assert(proj);\n  const output = ngeoInteractionMeasure.getFormattedLength(geom, proj, this.precision, this.format);\n  const coord = geom.getLastCoordinate();\n  callback(output, coord);\n};\n\n/**\n * Compute the intersection between 2 segments\n *\n * @param {Number} line1vertex1 The coordinates of the first line's first vertex.\n * @param {Number} line1vertex2 The coordinates of the first line's second vertex.\n * @param {Number} line2vertex1 The coordinates of the second line's first vertex.\n * @param {Number} line2vertex2 The coordinates of the second line's second vertex.\n * @return {Array<number> | undefined} The intersection point, undefined if there is no intersection point or lines are coincident.\n */\nexports.prototype.computeLineSegmentIntersection = function(line1vertex1, line1vertex2, line2vertex1, line2vertex2) {\n  const numerator1A = (line2vertex2[0] - line2vertex1[0]) * (line1vertex1[1] - line2vertex1[1])\n    - (line2vertex2[1] - line2vertex1[1]) * (line1vertex1[0] - line2vertex1[0]);\n  const numerator1B = (line1vertex2[0] - line1vertex1[0]) * (line1vertex1[1] - line2vertex1[1])\n    - (line1vertex2[1] - line1vertex1[1]) * (line1vertex1[0] - line2vertex1[0]);\n  const denominator1 = (line2vertex2[1] - line2vertex1[1]) * (line1vertex2[0] - line1vertex1[0])\n    - (line2vertex2[0] - line2vertex1[0]) * (line1vertex2[1] - line1vertex1[1]);\n\n  // If denominator = 0, then lines are parallel. If denominator = 0 and both numerators are 0, then coincident\n  if (denominator1 === 0) {\n    return;\n  }\n\n  const ua1 = numerator1A / denominator1;\n  const  ub1 = numerator1B / denominator1;\n\n  if (ua1 >= 0 && ua1 <= 1 && ub1 >= 0 && ub1 <= 1) {\n    const result = [];\n    result[0] = line1vertex1[0] + ua1 * (line1vertex2[0] - line1vertex1[0]);\n    result[1] = line1vertex1[1] + ua1 * (line1vertex2[1] - line1vertex1[1]);\n    return result;\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.MeasureArea\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionMeasure from 'ngeo/interaction/Measure.js';\nimport * as olBase from 'ol/index.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\n\n/**\n * @classdesc\n * Interaction dedicated to measure length.\n *\n * See our live example: [../examples/measure.html](../examples/measure.html)\n *\n * @constructor\n * @struct\n * @extends {ngeo.interaction.Measure}\n * @param {!ngeox.unitPrefix} format The format function\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {ngeox.interaction.MeasureOptions=} options Options\n */\nconst exports = function(format, gettextCatalog, options = {}) {\n\n  ngeoInteractionMeasure.call(this, /** @type {ngeo.interaction.MeasureBaseOptions} */ (options));\n\n\n  /**\n   * Message to show after the first point is clicked.\n   * @type {Element}\n   */\n  this.continueMsg;\n  if (options.continueMsg !== undefined) {\n    this.continueMsg = options.continueMsg;\n  } else {\n    this.continueMsg = document.createElement('span');\n    this.continueMsg.textContent = gettextCatalog.getString('Click to continue drawing the polygon.');\n    const br = document.createElement('br');\n    br.textContent = gettextCatalog.getString('Double-click or click starting point to finish.');\n    this.continueMsg.appendChild(br);\n  }\n\n  /**\n   * The format function\n   * @type {ngeox.unitPrefix}\n   */\n  this.format = format;\n\n};\n\nolBase.inherits(exports, ngeoInteractionMeasure);\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.createDrawInteraction = function(style, source) {\n  return new olInteractionDraw({\n    type: /** @type {ol.geom.GeometryType} */ ('Polygon'),\n    source: source,\n    style: style\n  });\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.handleMeasure = function(callback) {\n  const geom = googAsserts.assertInstanceof(this.sketchFeature.getGeometry(), olGeomPolygon);\n  const proj = this.getMap().getView().getProjection();\n  googAsserts.assert(proj);\n  const output = ngeoInteractionMeasure.getFormattedArea(geom, proj, this.precision, this.format);\n  const verticesCount = geom.getCoordinates()[0].length;\n  let coord = null;\n  if (verticesCount > 3) {\n    coord = geom.getInteriorPoint().getCoordinates();\n  }\n  callback(output, coord);\n};\n\n\nexport default exports;\n","/**\n * @module gmf.authentication.component\n */\nimport gmfAuthenticationService from 'gmf/authentication/Service.js';\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\nimport ngeoMessageNotification from 'ngeo/message/Notification.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessageModalComponent from 'ngeo/message/modalComponent.js';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('gmfAuthentication', [\n  gmfAuthenticationService.module.name,\n  ngeoMessageNotification.module.name,\n  ngeoMessageModalComponent.name,\n]);\n\n\n/**\n * @param {angular.JQLite} element Element.\n * @param {angular.Attributes} attrs Attributes.\n * @return {string} Template URL.\n */\nexports.gmfAuthenticationTemplateUrl_ = (element, attrs) => {\n  const templateUrl = attrs['gmfAuthenticationTemplateurl'];\n  return templateUrl !== undefined ? templateUrl :\n    'gmf/authentication';\n};\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/authentication', require('./component.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfAuthenticationTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfAuthenticationTemplateUrl($element, $attrs, gmfAuthenticationTemplateUrl) {\n  return gmfAuthenticationTemplateUrl($element, $attrs);\n}\n\n\n/**\n * An \"authentication\" component for a GeoMapFish application. With the\n * use of the \"authentication\" service, it features a complete interface\n * for the user to be able to login, logout, change or reset his or her\n * password.  The `gmfUser` angular value is also used to keep track of\n * the user information. When empty, that means that the user isn't connected\n * yet.\n *\n * While not logged in, the \"login\" form is shown, which allows the user to\n * either log in or ask for a password reset.\n *\n * Once logged in, the \"logout\" form is shown, which allows the user to either\n * log out or change his or her password.\n *\n * Example:\n *\n *      <gmf-authentication\n *        gmf-authentication-info-message=\"mainCtrl.loginInfoMessage\"\n *        gmf-authentication-allow-password-change=\"::true\">\n *      </gmf-authentication>\n *\n * @htmlAttribute {boolean} gmf-authentication-allow-password-reset Whether to\n *     show the password forgotten link. Default to true.\n * @htmlAttribute {boolean|function} gmf-authentication-allow-password-change Whether to\n *     show the change password button. Default to true. You can also specify a gmfx.PasswordValidator Object\n *     to add constraint on user's new password.\n * @htmlAttribute {gmfx.PasswordValidator} gmf-authentication-password-validator A gmfx.PasswordValidator\n *     Object to add constraint on user's new password. The gmf-authentication-allow-password-change. To use\n *     it you must also allow the user to change its password.\n * @htmlAttribute {boolean} gmf-authentication-force-password-change Force the\n *     user to change its password. Default to false. If you set it to true, you\n *     should also allow the user to change its password. Don't add this option alone, use\n *     it in a dedicated authentication component, in a ngeo-modal, directly in\n *     your index.html (see example 2.)\n * @htmlAttribute {string} gmf-authentication-info-message Message to show above the authentication form.\n *\n * Example 2:\n *\n *     <ngeo-modal\n *         ngeo-modal-closable=\"false\"\n *         ng-model=\"mainCtrl.userMustChangeItsPassword\">\n *       <div class=\"modal-header\">\n *         <h4 class=\"modal-title\">\n *           {{'You must change your password' | translate}}\n *         </h4>\n *       </div>\n *       <div class=\"modal-body\">\n *         <gmf-authentication\n *           gmf-authentication-force-password-change=\"::true\">\n *         </gmf-authentication>\n *       </div>\n *     </ngeo-modal>\n *\n * @ngdoc component\n * @ngname gmfAuthentication\n */\nexports.component_ = {\n  bindings: {\n    'allowPasswordReset': '<?gmfAuthenticationAllowPasswordReset',\n    'allowPasswordChange': '<?gmfAuthenticationAllowPasswordChange',\n    'passwordValidator': '<?gmfAuthenticationPasswordValidator',\n    'forcePasswordChange': '<?gmfAuthenticationForcePasswordChange',\n    'infoMessage': '=?gmfAuthenticationInfoMessage'\n  },\n  controller: 'GmfAuthenticationController',\n  templateUrl: gmfAuthenticationTemplateUrl\n};\n\nexports.value('gmfAuthenticationTemplateUrl',\n  exports.gmfAuthenticationTemplateUrl_);\n\nexports.component('gmfAuthentication', exports.component_);\n\n\n/**\n * @private\n */\nexports.AuthenticationController_ = class {\n  /**\n   * @private\n   * @param {!angular.JQLite} $element Element.\n   * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n   * @param {gmf.authentication.Service} gmfAuthenticationService GMF Authentication service\n   * @param {gmfx.User} gmfUser User.\n   * @param {ngeo.message.Notification} ngeoNotification Ngeo notification service.\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfAuthenticationController\n   */\n  constructor($element, gettextCatalog, gmfAuthenticationService, gmfUser, ngeoNotification) {\n\n    /**\n     * @type {!angular.JQLite}\n     * @private\n     */\n    this.$element_ = $element;\n\n    /**\n     * @type {gmfx.User}\n     * @export\n     */\n    this.gmfUser = gmfUser;\n\n    /**\n     * @type {angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog = gettextCatalog;\n\n    /**\n     * @type {gmf.authentication.Service}\n     * @private\n     */\n    this.gmfAuthenticationService_ = gmfAuthenticationService;\n\n    /**\n     * @type {ngeo.message.Notification}\n     * @private\n     */\n    this.notification_ = ngeoNotification;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.allowPasswordReset;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.allowPasswordChange;\n\n    /**\n     * @type {gmfx.PasswordValidator?}\n     * @export\n     */\n    this.passwordValidator = null;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.forcePasswordChange;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.infoMessage = null;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.changingPassword = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.userMustChangeItsPassword = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.resetPasswordModalShown = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.error = false;\n\n    // LOGIN form values\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.loginVal = '';\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.pwdVal = '';\n\n    // CHANGE PASSWORD form values\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.oldPwdVal = '';\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.newPwdVal = '';\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.newPwdConfVal = '';\n  }\n\n  /**\n   * Initialise the controller.\n   */\n  $onInit() {\n    this.allowPasswordReset = this.allowPasswordReset !== false;\n    this.allowPasswordChange = this.allowPasswordChange !== false;\n    this.forcePasswordChange = this.forcePasswordChange === true;\n    if (this.forcePasswordChange) {\n      this.changingPassword = true;\n    }\n    this.userMustChangeItsPassword = (this.gmfUser.is_password_changed === false && this.forcePasswordChange);\n  }\n\n\n  // METHODS THAT CALL THE AUTHENTICATION SERVICE METHODS\n\n  /**\n   * Calls the authentication service changePassword method.\n   * @export\n   */\n  changePassword() {\n    const gettextCatalog = this.gettextCatalog;\n\n    const oldPwd = this.oldPwdVal;\n    const newPwd = this.newPwdVal;\n    const confPwd = this.newPwdConfVal;\n\n    const errors = [];\n    // Validation - Passwords are required.\n    if (oldPwd === '') {\n      errors.push(gettextCatalog.getString('The old password is required.'));\n    }\n    if (newPwd === '') {\n      errors.push(gettextCatalog.getString('The new password is required.'));\n    }\n    if (confPwd === '') {\n      errors.push(gettextCatalog.getString('The password confirmation is required.'));\n    }\n\n    if (errors.length) {\n      this.setError_(errors);\n    } else {\n      // Default validation - Passwords must be new and must also match.\n      if (oldPwd === newPwd) {\n        errors.push(gettextCatalog.getString('The old and new passwords are the same.'));\n      }\n      if (newPwd !== confPwd) {\n        errors.push(gettextCatalog.getString('The passwords don\\'t match.'));\n      }\n      // Custom validation - If a passwordValidator is set, use it to validate the new password.\n      if (this.passwordValidator) {\n        if (!this.passwordValidator.isPasswordValid(oldPwd)) {\n          errors.push(gettextCatalog.getString(this.passwordValidator.notValidMessage));\n        }\n      }\n\n      if (errors.length) {\n        this.setError_(errors);\n      } else {\n        // Send request with current credentials, which may fail if the old password given is incorrect.\n        this.gmfAuthenticationService_.changePassword(oldPwd, newPwd, confPwd)\n          .then(() => {\n            this.changePasswordReset();\n            this.setError_(\n              [gettextCatalog.getString('Your password has successfully been changed.')],\n              ngeoMessageMessage.Type.INFORMATION\n            );\n          })\n          .catch((err) => {\n            this.setError_(gettextCatalog.getString('Incorrect old password.'));\n          });\n      }\n    }\n  }\n\n  /**\n   * Calls the authentication service login method.\n   * @export\n   */\n  login() {\n    const gettextCatalog = this.gettextCatalog;\n\n    const errors = [];\n    if (this.loginVal === '') {\n      errors.push(gettextCatalog.getString('The username is required.'));\n    }\n    if (this.pwdVal === '') {\n      errors.push(gettextCatalog.getString('The password is required.'));\n    }\n    if (errors.length) {\n      this.setError_(errors);\n    } else {\n      const error = gettextCatalog.getString('Incorrect credentials or disabled account.');\n      this.gmfAuthenticationService_.login(this.loginVal, this.pwdVal).then(\n        this.resetError_.bind(this),\n        this.setError_.bind(this, error));\n    }\n  }\n\n  /**\n   * Calls the authentication service logout method.\n   * @export\n   */\n  logout() {\n    const gettextCatalog = this.gettextCatalog;\n    const error = gettextCatalog.getString('Could not log out.');\n    this.gmfAuthenticationService_.logout().then(\n      this.resetError_.bind(this),\n      this.setError_.bind(this, error));\n  }\n\n  /**\n   * Calls the authentication service resetPassword method.\n   * @export\n   */\n  resetPassword() {\n    const gettextCatalog = this.gettextCatalog;\n\n    if (!this.loginVal) {\n      this.setError_(gettextCatalog.getString('Please, input a login...'));\n      return;\n    }\n\n    const error = gettextCatalog.getString('An error occurred while resetting the password.');\n\n    /**\n     * @param {gmfx.AuthenticationDefaultResponse} respData Response.\n     */\n    const resetPasswordSuccessFn = function(respData) {\n      this.resetPasswordModalShown = true;\n      this.resetError_();\n    }.bind(this);\n\n    this.gmfAuthenticationService_.resetPassword(this.loginVal).then(\n      resetPasswordSuccessFn,\n      this.setError_.bind(this, error)\n    );\n  }\n\n\n  // OTHER METHODS\n\n  /**\n   * Reset the changePassword values and error.\n   * @export\n   */\n  changePasswordReset() {\n    this.resetError_();\n    this.changingPassword = false;\n    this.oldPwdVal = '';\n    this.newPwdVal = '';\n    this.newPwdConfVal = '';\n  }\n\n  /**\n   * @param {string|Array.<string>} errors Errors.\n   * @param {ngeoMessageMessage.Type} [messageType] Type.\n   * @private\n   */\n  setError_(errors, messageType) {\n    if (messageType == undefined) {\n      messageType = ngeoMessageMessage.Type.ERROR;\n    }\n    if (this.error) {\n      this.resetError_();\n    }\n\n    this.error = true;\n\n    const container = this.$element_.find('.gmf-authentication-error');\n\n    if (!Array.isArray(errors)) {\n      errors = [errors];\n    }\n\n    errors.forEach(function(error) {\n      this.notification_.notify({\n        msg: error,\n        target: container,\n        type: messageType\n      });\n    }, this);\n  }\n\n  /**\n   * @private\n   */\n  resetError_() {\n    this.notification_.clear();\n    this.error = false;\n  }\n};\n\nexports.controller('GmfAuthenticationController',\n  exports.AuthenticationController_);\n\n\nexport default exports;\n","/**\n * @module gmf.authentication.module\n */\nimport gmfAuthenticationComponent from 'gmf/authentication/component.js';\n\n/** @suppress {extraRequire} */\nimport gmfAuthenticationService from 'gmf/authentication/Service.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfAuthenticationModule', [\n  gmfAuthenticationComponent.name,\n  gmfAuthenticationService.module.name\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.BackgroundLayerMgr\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport olObservable from 'ol/Observable.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport olSourceWMTS from 'ol/source/WMTS.js';\nimport ngeoLayerHelper from 'ngeo/map/LayerHelper.js';\n\n/**\n * Provides a service for setting/unsetting background layers\n * in maps.\n *\n * The notion of background/base layers doesn't exist in OpenLayers. This\n * service adds that notion.\n *\n * Setting a background layer to map is done with the `set` function:\n *\n *     ngeoBackgroundLayerMgr.set(map, layer);\n *\n * To unset the background layer pass `null` as the `layer` argument:\n *\n *     ngeoBackgroundLayerMgr.set(map, null);\n *\n * The `get` function returns the current background layer of the map passed\n * as an argument. `null` is returned if the map doesn't have a background\n * layer.\n *\n * The background layer is always added at index 0 in the map's layers\n * collection. When a background layer is set it is inserted (at index 0)\n * if the map does not already have a background layer, otherwise the\n * new background layer replaces the previous one at index 0.\n *\n * Users can subscribe to a 'change' event to get notified when the background\n * layer changes:\n *\n *     ngeoBackgroundLayerMgr.on('change', function(e) {\n *       // do something with the layer\n *       let layer = ngeoBackgroundLayerMgr.get();\n *       // know which layer was used before\n *       let previous = e.previous\n *     });\n *\n * See our live examples:\n * [../examples/backgroundlayer.html](../examples/backgroundlayer.html)\n * [../examples/backgroundlayerdropdown.html](../examples/backgroundlayerdropdown.html)\n *\n * @extends {ol.Observable}\n * @constructor\n * @struct\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Themes service.\n * @ngInject\n * @ngdoc service\n * @ngname ngeoBackgroundLayerMgr\n */\nconst exports = function(ngeoLayerHelper) {\n\n  olObservable.call(this);\n\n  /**\n   * Object used to track if maps have background layers.\n   * @type {Object.<string, boolean>}\n   * @private\n   */\n  this.mapUids_ = {};\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n};\n\nolBase.inherits(exports, olObservable);\n\n\n/**\n * Return the current background layer of a given map. `null` is returned if\n * the map does not have a background layer.\n * @param {ol.Map} map Map.\n * @return {ol.layer.Base} layer The background layer.\n * @export\n */\nexports.prototype.get = function(map) {\n  const mapUid = olBase.getUid(map).toString();\n  return mapUid in this.mapUids_ ? this.ngeoLayerHelper_.getGroupFromMap(map,\n    exports.BACKGROUNDLAYERGROUP_NAME).getLayers().item(0) : null;\n};\n\n\n/**\n * Set the background layer of a map. If `layer` is `null` the background layer\n * is removed.\n * @param {ol.Map} map The map.\n * @param {ol.layer.Base} layer The new background layer.\n * @return {ol.layer.Base} The previous background layer.\n * @export\n */\nexports.prototype.set = function(map, layer) {\n  const ZIndex = -200;\n  const mapUid = olBase.getUid(map).toString();\n  const previous = this.get(map);\n  if (layer !== null) {\n    layer.setZIndex(ZIndex);\n    this.ngeoLayerHelper_.setZIndexToFirstLevelChildren(layer, ZIndex);\n  }\n\n  const bgGroup = this.ngeoLayerHelper_.getGroupFromMap(map, exports.BACKGROUNDLAYERGROUP_NAME);\n\n  if (previous !== null) {\n    googAsserts.assert(mapUid in this.mapUids_);\n    if (layer !== null) {\n      bgGroup.getLayers().setAt(0, layer);\n    } else {\n      bgGroup.getLayers().removeAt(0);\n      delete this.mapUids_[mapUid];\n    }\n  } else if (layer !== null) {\n    bgGroup.getLayers().insertAt(0, layer);\n    this.mapUids_[mapUid] = true;\n  }\n  /** @type {ngeox.BackgroundEvent} */\n  const event = new ngeoCustomEvent('change', {\n    current: layer,\n    previous: previous\n  });\n  this.dispatchEvent(event);\n\n  return previous;\n};\n\n/**\n * Return the current background layer overlay of a given map, used by the opacity slider.\n * `null` is returned if the map does not have an opacity background layer.\n * @param {ol.Map} map Map.\n * @return {ol.layer.Base} layer The opacity background layer.\n * @export\n */\nexports.prototype.getOpacityBgLayer = function(map) {\n  const mapUid = olBase.getUid(map).toString();\n  return mapUid in this.mapUids_ ? this.ngeoLayerHelper_.getGroupFromMap(map,\n    exports.BACKGROUNDLAYERGROUP_NAME).getLayers().item(1) : null;\n};\n\n/**\n * Set an background layer overlay, used by the opacity slider.\n * @param {ol.Map} map The map.\n * @param {ol.layer.Base} layer The opacity background layer.\n * @export\n */\nexports.prototype.setOpacityBgLayer = function(map, layer) {\n  const bgGroup = this.ngeoLayerHelper_.getGroupFromMap(map, exports.BACKGROUNDLAYERGROUP_NAME);\n  const previous = bgGroup.getLayers().remove(this.getOpacityBgLayer(map));\n  const ZIndex = -100;\n  layer.setOpacity(previous ? previous.getOpacity() : 0);\n  layer.setVisible(previous ? previous.getVisible() : true);\n  layer.setZIndex(ZIndex);\n  this.ngeoLayerHelper_.setZIndexToFirstLevelChildren(layer, ZIndex);\n\n  const index = bgGroup.getLayers().getArray().indexOf(layer);\n  if (index === -1) {\n    bgGroup.getLayers().push(layer);\n  }\n};\n\n/**\n * @param {ol.Map} map The map.\n * @param {Object.<string, string>} dimensions The global dimensions object.\n * @export\n */\nexports.prototype.updateDimensions = function(map, dimensions) {\n  const baseBgLayer = this.get(map);\n  if (baseBgLayer) {\n    let layers = [baseBgLayer];\n    if (baseBgLayer instanceof olLayerGroup) {\n      // Handle the first level of layers of the base background layer.\n      layers = baseBgLayer.getLayers().getArray();\n    }\n\n    layers.forEach((layer) => {\n      googAsserts.assertInstanceof(layer, olLayerLayer);\n      if (layer) {\n        let hasUpdates = false;\n        const updatedDimensions = {};\n        for (const key in layer.get('dimensions')) {\n          const value = dimensions[key];\n          if (value !== undefined) {\n            updatedDimensions[key] = value;\n            hasUpdates = true;\n          }\n        }\n        if (hasUpdates) {\n          const source = layer.getSource();\n          if (source instanceof olSourceWMTS) {\n            source.updateDimensions(updatedDimensions);\n            source.refresh();\n          } else if (source instanceof olSourceTileWMS || source instanceof olSourceImageWMS) {\n            source.updateParams(updatedDimensions);\n            source.refresh();\n          }\n        }\n      }\n    });\n  }\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoBackgroundLayerMgr', [\n  ngeoLayerHelper.module.name\n]);\nexports.module.service('ngeoBackgroundLayerMgr', exports);\n\n/**\n * @const\n */\nexports.BACKGROUNDLAYERGROUP_NAME = 'background';\n\n\nexport default exports;\n","/**\n * @module gmf.backgroundlayerselector.component\n */\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport ngeoMapBackgroundLayerMgr from 'ngeo/map/BackgroundLayerMgr.js';\nimport * as olEvents from 'ol/events.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfBackgroundlayerselector', [\n  gmfThemeThemes.module.name,\n  ngeoMapBackgroundLayerMgr.module.name,\n]);\n\n\nexports.value('gmfBackgroundlayerselectorTemplateUrl',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template URL.\n   */\n  ($element, $attrs) => {\n    const templateUrl = $attrs['gmfBackgroundlayerselectorTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/backgroundlayerselector';\n  }\n);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/backgroundlayerselector', require('./component.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfBackgroundlayerselectorTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfBackgroundlayerselectorTemplateUrl($element, $attrs, gmfBackgroundlayerselectorTemplateUrl) {\n  return gmfBackgroundlayerselectorTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provide a \"background layer selector\" component.\n *\n * Example:\n *\n *      <gmf-backgroundlayerselector\n *        gmf-backgroundlayerselector-map=\"::ctrl.map\"\n *        gmf-backgroundlayer-opacity-options=\"::ctrl.bgOpacityOptions\"\n *        gmf-backgroundlayerselector-select=\"onBackgroundSelected()\">\n *      </gmf-backgroundlayerselector>\n *\n * Used UI metadata:\n *\n *  * thumbnail: The URL used for the icon.\n *\n * @htmlAttribute {ol.Map=} gmf-backgroundlayerselector-map The map.\n * @htmlAttribute {string} gmf-backgroundlayer-opacity-options The opacity slider options.\n * @htmlAttribute {Function} gmf-backgroundlayerselector-select Function called\n *     when a layer was selected by the user.\n *\n * @ngdoc component\n * @ngname gmfBackgroundlayerselector\n */\nexports.component_ = {\n  controller: 'GmfBackgroundlayerselectorController as ctrl',\n  bindings: {\n    'map': '=gmfBackgroundlayerselectorMap',\n    'opacityOptions': '=gmfBackgroundlayerOpacityOptions',\n    'select': '&?gmfBackgroundlayerselectorSelect'\n  },\n  templateUrl: gmfBackgroundlayerselectorTemplateUrl\n};\n\n\nexports.component('gmfBackgroundlayerselector',\n  exports.component_);\n\n\n/**\n * @constructor\n * @private\n * @struct\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!ngeo.map.BackgroundLayerMgr} ngeoBackgroundLayerMgr Background layer manager.\n * @param {!gmf.theme.Themes} gmfThemes Themes service.\n * @ngInject\n * @ngdoc controller\n * @ngname GmfBackgroundlayerselectorController\n */\nexports.Controller_ = function($scope, ngeoBackgroundLayerMgr, gmfThemes) {\n\n  /**\n   * @type {?ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {!string|undefined}\n   * @export\n   */\n  this.opacityOptions;\n\n  /**\n   * Function called when a layer was selected by the user.\n   * @type {?Function}\n   * @export\n   */\n  this.select;\n\n  /**\n   * @type {?ol.layer.Base}\n   * @export\n   */\n  this.bgLayer;\n\n  /**\n   * @type {?Array.<!ol.layer.Base>}\n   * @export\n   */\n  this.bgLayers;\n\n  /**\n   * @type {ol.layer.Base}\n   * @export\n   */\n  this.opacityLayer;\n\n  /**\n   * @type {!gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {!Array.<!ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  this.listenerKeys_.push(olEvents.listen(gmfThemes, 'change', this.handleThemesChange_, this));\n\n  /**\n   * @type {!ngeo.map.BackgroundLayerMgr}\n   * @private\n   */\n  this.backgroundLayerMgr_ = ngeoBackgroundLayerMgr;\n\n  this.listenerKeys_.push(olEvents.listen(this.backgroundLayerMgr_, 'change',\n    /**\n     * @param {!ngeox.BackgroundEvent} event Event.\n     */\n    (event) => {\n      this.bgLayer = event.detail.current;\n    }));\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n};\n\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.handleThemesChange_();\n};\n\n\n/**\n * Called when the themes changes. Set (or reset) the backround layers.\n * @private\n */\nexports.Controller_.prototype.handleThemesChange_ = function() {\n  this.gmfThemes_.getBgLayers().then((layers) => {\n    this.bgLayers = layers;\n\n    if (this.opacityOptions !== undefined) {\n      const opacityLayer = layers.find(layer => layer.get('label') === this.opacityOptions);\n      if (opacityLayer !== undefined) {\n        this.setOpacityBgLayer(opacityLayer);\n        this.opacityLayer = opacityLayer;\n\n        // Reorder for the UI the bgArray copy with the opacity layer at the end\n        this.bgLayers = this.bgLayers.slice();\n        const indexOpa = this.bgLayers.findIndex(layer => layer === this.opacityLayer);\n        this.bgLayers.splice(indexOpa, 1);\n        this.bgLayers.push(opacityLayer);\n      }\n    }\n  });\n};\n\n/**\n * Getter/setter for background layer overlay, used by opacity slider.\n * @param {?number} val The opacity.\n * @returns {number} The background layer opacity.\n * @export\n */\nexports.Controller_.prototype.getSetBgLayerOpacity = function(val) {\n  if (val !== undefined) {\n    this.opacityLayer.setOpacity(val);\n  }\n  return this.opacityLayer.getOpacity();\n};\n\n/**\n * @param {ol.layer.Base} layer Layer.\n * @param {boolean=} opt_silent Do not notify listeners.\n * @export\n */\nexports.Controller_.prototype.setLayer = function(layer, opt_silent) {\n  this.bgLayer = layer;\n  this.backgroundLayerMgr_.set(this.map, layer);\n  if (!opt_silent && this.select) {\n    this.select();\n  }\n};\n\n/**\n * Set a background layer overlay, used by the opacity slider.\n * @param {ol.layer.Base} layer The opacity background layer.\n * @export\n */\nexports.Controller_.prototype.setOpacityBgLayer = function(layer) {\n  this.backgroundLayerMgr_.setOpacityBgLayer(this.map, layer);\n};\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  this.listenerKeys_.forEach(olEvents.unlistenByKey);\n  this.listenerKeys_.length = 0;\n};\n\n\nexports.controller('GmfBackgroundlayerselectorController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.Helper\n */\nimport gmfEditingEnumerateAttribute from 'gmf/editing/EnumerateAttribute.js';\nimport ngeoDatasourceHelper from 'ngeo/datasource/Helper.js';\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport * as olArray from 'ol/array.js';\n\nconst exports = class {\n\n  /**\n   * A service that provides utility methods to manipulate or get GMF data\n   * sources.\n   *\n   * @struct\n   * @param {angular.$q} $q The Angular $q service.\n   * @param {gmf.editing.EnumerateAttribute} gmfEnumerateAttribute The Gmf enumerate\n   *     attribute service.\n   * @param {ngeo.datasource.Helper} ngeoDataSourcesHelper Ngeo data\n   *     source helper service.\n   * @ngdoc service\n   * @ngname gmfDataSourcesHelper\n   * @ngInject\n   */\n  constructor($q, gmfEnumerateAttribute, ngeoDataSourcesHelper) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.q_ = $q;\n\n    /**\n     * @type {gmf.editing.EnumerateAttribute}\n     * @private\n     */\n    this.gmfEnumerateAttribute_ = gmfEnumerateAttribute;\n\n    /**\n     * @type {ngeo.datasource.Helper}\n     * @private\n     */\n    this.ngeoDataSourcesHelper_ = ngeoDataSourcesHelper;\n\n\n    // === Other properties ===\n\n    /**\n     * @type {gmfx.datasource.DataSources}\n     * @protected\n     */\n    this.collection_;\n\n    /**\n     * @type {Object.<number, gmf.datasource.OGC>}\n     * @protected\n     */\n    this.cache_;\n  }\n\n  /**\n   * @return {gmfx.datasource.DataSources} Data sources collection.\n   * @export\n   */\n  get collection() {\n    return /** @type {gmfx.datasource.DataSources} */ (\n      this.ngeoDataSourcesHelper_.collection\n    );\n  }\n\n  /**\n   * Return a data source using its id.\n   * @param {number} id Data source id.\n   * @return {?gmf.datasource.OGC} Data source.\n   * @export\n   */\n  getDataSource(id) {\n    return /** @type {?gmf.datasource.OGC} */ (\n      this.ngeoDataSourcesHelper_.getDataSource(id)\n    );\n  }\n\n  /**\n   * @param {gmf.datasource.OGC} dataSource Filtrable data source.\n   * @return {angular.$q.Promise} Promise.\n   * @export\n   */\n  prepareFiltrableDataSource(dataSource) {\n\n    const prepareFiltrableDataSourceDefer = this.q_.defer();\n\n    // (1) Get the attributes. The first time, they will be asynchronously\n    //     obtained using a WFS DescribeFeatureType request.\n    this.ngeoDataSourcesHelper_.getDataSourceAttributes(\n      dataSource\n    ).then((attributes) => {\n      // (2) The attribute names that are in the `enumeratedAttributes`\n      //     metadata are the ones that need to have their values fetched.\n      //     Do that once then set the type to SELECT and the choices.\n      const meta = dataSource.gmfLayer.metadata || {};\n      const enumAttributes = meta.enumeratedAttributes;\n      if (enumAttributes && enumAttributes.length) {\n        const promises = [];\n        for (const attribute of attributes) {\n          if (olArray.includes(enumAttributes, attribute.name) &&\n             attribute.type !== ngeoFormatAttributeType.SELECT &&\n             (!attribute.choices || !attribute.choices.length)) {\n            promises.push(\n              this.gmfEnumerateAttribute_.getAttributeValues(\n                dataSource, attribute.name\n              ).then((values) => {\n                const choices = values.map(choice => choice.value);\n                attribute.type = ngeoFormatAttributeType.SELECT;\n                attribute.choices = choices;\n              })\n            );\n          }\n        }\n        return this.q_.all(promises).then(\n          prepareFiltrableDataSourceDefer.resolve(dataSource)\n        );\n      } else {\n        prepareFiltrableDataSourceDefer.resolve(dataSource);\n      }\n    });\n\n    return prepareFiltrableDataSourceDefer.promise;\n  }\n\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfDataSourcesHelper', [\n  ngeoDatasourceHelper.module.name,\n  gmfEditingEnumerateAttribute.module.name,\n]);\nexports.module.service('gmfDataSourcesHelper', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.OGC\n */\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\n\nconst exports = class extends ngeoDatasourceOGC {\n\n  /**\n   * A `gmf.datasource.OGC` extends a `ngeo.datasource.OGC` and\n   * adds some properties that are proper to GMF only.\n   *\n   * @struct\n   * @param {gmfx.datasource.OGCOptions} options Options.\n   */\n  constructor(options) {\n\n    super(options);\n\n    // === STATIC properties (i.e. that never change) ===\n\n    /**\n     * @type {gmfThemes.GmfLayer}\n     * @private\n     */\n    this.gmfLayer_ = options.gmfLayer;\n\n  }\n\n  // === Static property getters/setters ===\n\n  /**\n   * @return {gmfThemes.GmfLayer} GMF layer\n   * @export\n   */\n  get gmfLayer() {\n    return this.gmfLayer_;\n  }\n\n};\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.WFSAliases\n */\nimport ngeoDatasourceHelper from 'ngeo/datasource/Helper.js';\n\nconst exports = class {\n\n  /**\n   * Service that provides methods to get additional information and actions\n   * when performing WFS requests.\n   *\n   * @struct\n   * @param {ngeo.datasource.Helper} ngeoDataSourcesHelper Ngeo data\n   *     source helper service.\n   * @ngdoc service\n   * @ngname gmfWFSAliases\n   * @ngInject\n   */\n  constructor(ngeoDataSourcesHelper) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {ngeo.datasource.Helper}\n     * @private\n     */\n    this.ngeoDataSourcesHelper_ = ngeoDataSourcesHelper;\n  }\n\n\n  /**\n   * @param {ngeo.datasource.OGC} dataSource Data source.\n   * @export\n   */\n  describe(dataSource) {\n    // Only QGIS Server supports WFS aliases\n    if (dataSource.ogcServerType === 'qgisserver' &&\n      dataSource.wfsUrl_ &&\n      dataSource.getOGCLayerNames().length == 1 &&\n      !dataSource.attributes) {\n      // Trigger an additional WFS DescribeFeatureType request to get\n      // datasource attributes, including aliases.\n      this.ngeoDataSourcesHelper_.getDataSourceAttributes(dataSource);\n    }\n  }\n};\n\n\nexports.module = angular.module('gmfDatasourceWFSAliases', [\n  ngeoDatasourceHelper.module.name,\n]);\nexports.module.service('gmfWFSAliases', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.Manager\n */\nimport gmfDatasourceOGC from 'gmf/datasource/OGC.js';\nimport gmfDatasourceWFSAliases from 'gmf/datasource/WFSAliases.js';\nimport gmfLayertreeSyncLayertreeMap from 'gmf/layertree/SyncLayertreeMap.js';\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDatasourceDataSources from 'ngeo/datasource/DataSources.js';\n\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\n\n/** @suppress {extraRequire} */\nimport ngeoFilterRuleHelper from 'ngeo/filter/RuleHelper.js';\n\nimport ngeoMapBackgroundLayerMgr from 'ngeo/map/BackgroundLayerMgr.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport * as olObj from 'ol/obj.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\n\nconst exports = class {\n\n  /**\n   * The GeoMapFish DataSources Manager is responsible of listenening to the\n   * c2cgeoportal's themes to create instances of `ngeo.datasource.DataSource`\n   * objects with the layer definitions found and push them in the\n   * `ngeox.datasource.DataSources` collection. The Manager must be initialized\n   * with the app's map using the setDatasourcseMap() method.\n   *\n   * When changing theme, these data sources are cleared then re-created.\n   *\n   * @struct\n   * @param {angular.$q} $q Angular q service\n   * @param {!angular.Scope} $rootScope Angular rootScope.\n   * @param {angular.$timeout} $timeout Angular timeout service.\n   * @param {gmf.theme.Themes} gmfThemes The gmf Themes service.\n   * @param {gmf.layertree.TreeManager} gmfTreeManager The gmf TreeManager service.\n   * @param {!ngeo.map.BackgroundLayerMgr} ngeoBackgroundLayerMgr Background layer\n   *     manager.\n   * @param {ngeo.datasource.DataSources} ngeoDataSources Ngeo data sources service.\n   *     data sources service.\n   * @param {!ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n   * @param {!ngeo.filter.RuleHelper} ngeoRuleHelper Ngeo rule helper service.\n   * @param {!ngeo.misc.WMSTime} ngeoWMSTime wms time service.\n   * @param {!gmf.datasource.WFSAliases} gmfWFSAliases Gmf WFS aliases service.\n   * @ngInject\n   * @ngdoc service\n   * @ngname gmfDataSourcesManager\n   */\n  constructor($q, $rootScope, $timeout, gmfThemes, gmfTreeManager,\n    ngeoBackgroundLayerMgr, ngeoDataSources, ngeoLayerHelper, ngeoRuleHelper,\n    ngeoWMSTime, gmfWFSAliases\n  ) {\n\n    // === Injected properties ===\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.q_ = $q;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.rootScope_ = $rootScope;\n\n    /**\n     * @type {angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {gmf.theme.Themes}\n     * @private\n     */\n    this.gmfThemes_ = gmfThemes;\n\n    /**\n     * @type {gmf.layertree.TreeManager}\n     * @private\n     */\n    this.gmfTreeManager_ = gmfTreeManager;\n\n    /**\n     * @type {!ngeo.map.BackgroundLayerMgr}\n     * @private\n     */\n    this.ngeoBackgroundLayerMgr_ = ngeoBackgroundLayerMgr;\n\n    /**\n     * @type {ngeo.datasource.DataSources}\n     * @private\n     */\n    this.ngeoDataSources_ = ngeoDataSources;\n\n    /**\n     * The collection of DataSources from ngeo, which gets updated by this\n     * service. When the theme changes, first we remove all data sources, then\n     * the 'active' data source are added here.\n     * @type {ngeox.datasource.DataSources}\n     * @private\n     */\n    this.dataSources_ = ngeoDataSources.collection;\n\n    /**\n     * @type {!ngeo.map.LayerHelper}\n     * @private\n     */\n    this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n    /**\n     * @type {!ngeo.filter.RuleHelper}\n     * @private\n     */\n    this.ngeoRuleHelper_ = ngeoRuleHelper;\n\n    /**\n     * @type {!ngeo.misc.WMSTime}\n     * @private\n     */\n    this.ngeoWMSTime_ = ngeoWMSTime;\n\n    /**\n     * @type {!gmf.datasource.WFSAliases}\n     * @private\n     */\n    this.gmfWFSAliases_ = gmfWFSAliases;\n\n\n    // === Inner properties ===\n\n    /**\n     * While loading a new theme, this is where all of the created data sources\n     * are put using the id as key for easier find in the future.\n     * @type {Object.<number, gmf.datasource.OGC>}\n     * @private\n     */\n    this.dataSourcesCache_ = {};\n\n    /**\n     * A reference to the dimensions object.\n     * @type {ngeox.Dimensions|undefined}\n     * @private\n     */\n    this.dimensions_;\n\n    /**\n     * The function to call to unregister the `watch` event on the dimensions\n     * object properties.\n     * @type {?Function}\n     * @private\n     */\n    this.dimensionsWatcherUnregister = null;\n\n    /**\n     * The cache of layertree leaf controller, i.e. those that are added to\n     * the tree manager. When treeCtrl is added in this cache, it's given\n     * a reference to its according data source.\n     * @type {gmfx.datasource.ManagerTreeCtrlCache}\n     * @private\n     */\n    this.treeCtrlCache_ = {};\n\n    /**\n     * The function to call to unregister the `watchCollection` event on\n     * the root layer tree controller children.\n     * @type {?Function}\n     * @private\n     */\n    this.treeCtrlsUnregister_ = null;\n\n    // === Events ===\n\n    olEvents.listen(\n      this.ngeoBackgroundLayerMgr_,\n      'change',\n      this.handleNgeoBackgroundLayerChange_,\n      this\n    );\n    olEvents.listen(this.gmfThemes_, 'change', this.handleThemesChange_, this);\n  }\n\n\n  /**\n   * Set the map to use with your datasources.\n   * @param {!ol.Map} map The map to use.\n   * @export\n   */\n  setDatasourceMap(map) {\n    this.ngeoDataSources_.map = map;\n  }\n\n  /**\n   * @param {!ngeox.Dimensions} dimensions A reference to the dimensions\n   *     object to keep a reference of in this service.\n   */\n  setDimensions(dimensions) {\n    if (this.dimensionsWatcherUnregister) {\n      this.dimensionsWatcherUnregister();\n    }\n\n    this.dimensions_ = dimensions;\n\n    this.dimensionsWatcherUnregister = this.rootScope_.$watch(\n      () => this.dimensions_,\n      this.handleDimensionsChange_.bind(this),\n      true\n    );\n    this.handleDimensionsChange_();\n  }\n\n  /**\n   * Called when the dimensions change. Update all affected layer's filters.\n   * @private\n   */\n  handleDimensionsChange_() {\n\n    // Create a layer list to update each one only once\n    const layers = [];\n    const layerIds = [];\n\n    const dataSources = this.dataSources_.getArray();\n    for (const dataSource of dataSources) {\n      if (dataSource.dimensionsFiltersConfig) {\n        for (const key in dataSource.dimensionsFiltersConfig) {\n          if (dataSource.dimensionsFiltersConfig[key].value === null) {\n            const layer = this.getDataSourceLayer_(dataSource);\n            if (layer == undefined) {\n              return;\n            }\n            const id = olBase.getUid(layer);\n            if (layerIds.indexOf(id) == -1) {\n              layers.push(layer);\n              layerIds.push(id);\n            }\n          }\n        }\n      }\n    }\n\n    layers.forEach(this.updateLayerFilter_.bind(this));\n  }\n\n  /**\n   * Called when the themes change. Remove any existing data sources first,\n   * then create and add data sources from the loaded themes.\n   * @private\n   */\n  handleThemesChange_() {\n    // (1) Clear\n    this.clearDataSources_();\n    if (this.treeCtrlsUnregister_) {\n      this.treeCtrlsUnregister_();\n    }\n    this.clearTreeCtrlCache_();\n\n    // (2) Re-create data sources and event listeners\n    this.gmfThemes_.getOgcServersObject().then((ogcServers) => {\n      const promiseThemes = this.gmfThemes_.getThemesObject().then((themes) => {\n        // Create a DataSources for each theme\n        for (const theme of themes) {\n          for (const child of theme.children) {\n            googAsserts.assert(child);\n            this.createDataSource_(child, child, ogcServers);\n          }\n        }\n      });\n\n      const promiseBgLayers = this.gmfThemes_.getBackgroundLayersObject().then(\n        (backgroundLayers) => {\n          // Create a DataSource for each background layer\n          for (const backgroundLayer of backgroundLayers) {\n            this.createDataSource_(null, backgroundLayer, ogcServers);\n          }\n        }\n      );\n\n      // Then add the data sources that are active in the ngeo collection\n      this.q_.all([promiseThemes, promiseBgLayers]).then(() => {\n        this.treeCtrlsUnregister_ = this.rootScope_.$watchCollection(\n          () => {\n            if (this.gmfTreeManager_.rootCtrl) {\n              return this.gmfTreeManager_.rootCtrl.children;\n            }\n          },\n          this.handleTreeManagerRootChildrenChange_.bind(this)\n        );\n      });\n    });\n  }\n\n  /**\n   * Called when the list of tree controllers within the tree manager\n   * root controller changes. In other words, this method is called\n   * after nodes are being added added or removed from the tree,\n   * i.e. from the child nodes collection.\n   *\n   * A timeout is required  because the collection event is fired before\n   * the leaf nodes are created and they are the ones we're looking for here.\n   *\n   * This method handles the registration/unregistration of tree nodes that\n   * are added or removed, pushing it to the cache or removing it from the\n   * cache.\n   *\n   * @param {Array.<ngeo.layertree.Controller>|undefined} value List of tree\n   *     controllers.\n   * @private\n   */\n  handleTreeManagerRootChildrenChange_(value) {\n\n    this.timeout_(() => {\n\n      // (1) No need to do anything if the value is not set\n      if (!value) {\n        return;\n      }\n\n      // (2) Collect 'leaf' treeCtrls\n      const newTreeCtrls = [];\n      const visitor = (treeCtrls, treeCtrl) => {\n        const node = /** @type {!gmfThemes.GmfGroup|!gmfThemes.GmfLayer} */ (\n          treeCtrl.node);\n        const children = node.children;\n        if (!children) {\n          treeCtrls.push(treeCtrl);\n        }\n      };\n      for (let i = 0, ii = value.length; i < ii; i++) {\n        value[i].traverseDepthFirst(visitor.bind(this, newTreeCtrls));\n      }\n\n      // (3) Add new 'treeCtrls'\n      for (let i = 0, ii = newTreeCtrls.length; i < ii; i++) {\n        const newTreeCtrl = newTreeCtrls[i];\n        const cacheItem = this.getTreeCtrlCacheItem_(newTreeCtrl);\n        if (!cacheItem) {\n          this.addTreeCtrlToCache_(newTreeCtrl);\n        }\n      }\n\n      // (4) Remove treeCtrls that are no longer in the newTreeCtrl\n      const cache = this.treeCtrlCache_;\n      for (const id in this.treeCtrlCache_) {\n        const item = cache[id];\n        if (!newTreeCtrls.includes(item.treeCtrl)) {\n          this.removeTreeCtrlCacheItem_(item);\n        }\n      }\n    });\n  }\n\n  /**\n   * Remove the data sources from the ngeo collection that are in the cache,\n   * i.e. those created by this service, then clear the cache.\n   * @private\n   */\n  clearDataSources_() {\n\n    // (1) Remove data sources from ngeo collection\n    const dataSources = this.dataSources_.getArray();\n    for (let i = dataSources.length - 1, ii = 0; i >= ii; i--) {\n      if (this.dataSourcesCache_[dataSources[i].id]) {\n        // Use the `remove` method of the `ol.Collection` object for it\n        // to update its length accordingly and trigger the REMOVE event as\n        // well.\n        this.dataSources_.remove(dataSources[i]);\n      }\n    }\n\n    // (2) Clear the cache\n    olObj.clear(this.dataSourcesCache_);\n  }\n\n  /**\n   * Create a data source using the information on the node, group node\n   * and OGC servers. If the node has children, then we loop in those to get\n   * leaf nodes. Only leaf nodes end up creating a data source. If a data\n   * source with the same id already exists, then the node is skipped.\n   *\n   * Once a data source is created, it is added to the data sources cache.\n   *\n   * @param {gmfThemes.GmfGroup} firstLevelGroup The first level group node.\n   * @param {!gmfThemes.GmfGroup|!gmfThemes.GmfLayer} node The node, which\n   *     may have children or not.\n   * @param {!gmfThemes.GmfOgcServers} ogcServers OGC servers.\n   * @private\n   */\n  createDataSource_(firstLevelGroup, node, ogcServers) {\n\n    const children = node.children;\n\n    // (1) Group node (node that has children). Loop in the children\n    //     individually and create a data source for each one of them. The\n    //     group node itself is **skipped**.\n    if (children) {\n      for (const child of children) {\n        googAsserts.assert(child);\n        this.createDataSource_(firstLevelGroup, child, ogcServers);\n      }\n      return;\n    }\n\n    // From there on, the node is a layer node.\n    const gmfLayer = /** @type gmfThemes.GmfLayer */ (node);\n\n    // (2) Skip layer node if a data source with the same id exists\n    const id = olBase.getUid(gmfLayer);\n    if (this.dataSourcesCache_[id]) {\n      return;\n    }\n\n    // From there on, a data source will be created\n    const meta = gmfLayer.metadata;\n    const ogcType = gmfLayer.type;\n    let maxResolution;\n    let minResolution;\n    let ogcLayers;\n    let ogcServer;\n    let wmtsLayer;\n    let wmtsUrl;\n    let ogcImageType;\n    let timeProperty;\n\n    if (ogcType === gmfThemeThemes.NodeType.WMTS) {\n      // (3) Manage WMTS\n      const gmfLayerWMTS = /** @type {gmfThemes.GmfLayerWMTS} */ (gmfLayer);\n\n      // Common options for WMTS\n      wmtsLayer = gmfLayerWMTS.layer;\n      wmtsUrl = gmfLayerWMTS.url;\n      maxResolution = meta.maxResolution;\n      minResolution = meta.minResolution;\n\n      // OGC Layers\n      const layers = meta.queryLayers || meta.wmsLayers;\n      if (layers) {\n        ogcLayers = layers.split(',').map((layer) => {\n          return {\n            maxResolution: maxResolution,\n            minResolution: minResolution,\n            name: layer,\n            queryable: true\n          };\n        });\n      }\n\n      // OGC Server\n      if (meta.ogcServer && ogcServers[meta.ogcServer]) {\n        ogcServer = ogcServers[meta.ogcServer];\n      }\n      ogcImageType = gmfLayerWMTS.imageType;\n    } else if (ogcType === gmfThemeThemes.NodeType.WMS) {\n      // (4) Manage WMS\n      const gmfLayerWMS = /** @type {gmfThemes.GmfLayerWMS} */ (gmfLayer);\n\n      // Common options for WMS\n      maxResolution = gmfLayerWMS.maxResolutionHint;\n      minResolution = gmfLayerWMS.minResolutionHint;\n\n      // OGC Layers\n      ogcLayers = gmfLayerWMS.childLayers.map((childLayer) => {\n        return {\n          maxResolution: childLayer.maxResolutionHint,\n          minResolution: childLayer.minResolutionHint,\n          name: childLayer.name,\n          queryable: childLayer.queryable\n        };\n      });\n\n      // OGC Server\n      const ogcServerName = (!firstLevelGroup || firstLevelGroup.mixed) ?\n        gmfLayerWMS.ogcServer : firstLevelGroup.ogcServer;\n      googAsserts.assert(ogcServerName);\n      ogcServer = ogcServers[ogcServerName];\n      ogcImageType = ogcServer.imageType;\n\n      // Time property\n      if (gmfLayerWMS.time) {\n        timeProperty = gmfLayerWMS.time;\n      } else if (firstLevelGroup && firstLevelGroup.time) {\n        timeProperty = firstLevelGroup.time;\n      }\n    }\n\n    // (5) ogcServer\n    const ogcServerType = ogcServer ? ogcServer.type : undefined;\n    const wmsIsSingleTile = ogcServer ? ogcServer.isSingleTile : undefined;\n    const wfsUrl = ogcServer && ogcServer.wfsSupport ?\n      ogcServer.urlWfs : undefined;\n    const wmsUrl = ogcServer ? ogcServer.url : undefined;\n\n    let wfsOutputFormat = ngeoDatasourceOGC.WFSOutputFormat.GML3;\n    // qgis server only supports GML2 output\n    if (ogcServerType === ngeoDatasourceOGC.ServerType.QGISSERVER) {\n      wfsOutputFormat = ngeoDatasourceOGC.WFSOutputFormat.GML2;\n    }\n\n    // (6) Snapping\n    const snappable = !!meta.snappingConfig;\n    const snappingTolerance = meta.snappingConfig ?\n      meta.snappingConfig.tolerance : undefined;\n    const snappingToEdges = meta.snappingConfig ?\n      meta.snappingConfig.edge : undefined;\n    const snappingToVertice = meta.snappingConfig ?\n      meta.snappingConfig.vertex : undefined;\n\n    // (7) Dimensions\n    const dimensions = this.dimensions_;\n    const dimensionsConfig = node.dimensions || firstLevelGroup.dimensions;\n    const dimensionsFiltersConfig = node.dimensionsFilters;\n\n    // (8) Time values (lower or lower/upper)\n    let timeLowerValue;\n    let timeUpperValue;\n    if (timeProperty) {\n      const timeValues = this.ngeoWMSTime_.getOptions(timeProperty)['values'];\n      if (Array.isArray(timeValues)) {\n        timeLowerValue = timeValues[0];\n        timeUpperValue = timeValues[1];\n      } else {\n        timeLowerValue = timeValues;\n      }\n    }\n\n    // (9) Common options\n    const copyable = meta.copyable;\n    const identifierAttribute = meta.identifierAttributeField;\n    const name = gmfLayer.name;\n    const timeAttributeName = meta.timeAttribute;\n    const visible = meta.isChecked === true;\n\n    // Create the data source and add it to the cache\n    this.dataSourcesCache_[id] = new gmfDatasourceOGC({\n      copyable,\n      dimensions,\n      dimensionsConfig,\n      dimensionsFiltersConfig,\n      gmfLayer,\n      id,\n      identifierAttribute,\n      maxResolution,\n      minResolution,\n      name,\n      ogcImageType,\n      ogcLayers,\n      ogcServerType,\n      ogcType,\n      snappable,\n      snappingTolerance,\n      snappingToEdges,\n      snappingToVertice,\n      timeAttributeName,\n      timeLowerValue,\n      timeProperty,\n      timeUpperValue,\n      visible,\n      wfsOutputFormat,\n      wfsUrl,\n      wmsIsSingleTile,\n      wmsUrl,\n      wmtsLayer,\n      wmtsUrl\n    });\n  }\n\n  /**\n   * If the given Layertree controller is a 'leaf', add it to the cache.\n   * Also, set its according data source. Finally, add the data source to\n   * the ngeo collection.\n   *\n   * @param {ngeo.layertree.Controller} treeCtrl Layertree controller to add\n   * @private\n   */\n  addTreeCtrlToCache_(treeCtrl) {\n\n    const id = olBase.getUid(treeCtrl.node);\n    const dataSource = this.dataSourcesCache_[id];\n    googAsserts.assert(dataSource, 'DataSource should be set');\n    treeCtrl.setDataSource(dataSource);\n\n    const stateWatcherUnregister = this.rootScope_.$watch(\n      () => treeCtrl.getState(),\n      this.handleTreeCtrlStateChange_.bind(this, treeCtrl)\n    );\n\n    const filterRulesWatcherUnregister = this.rootScope_.$watch(\n      () => {\n        const hasFilters = dataSource.filterRules !== null;\n        const isVisible = dataSource.visible;\n        return hasFilters && isVisible;\n      },\n      this.handleDataSourceFilterRulesChange_.bind(this, dataSource)\n    );\n\n    // Watch for time values change to update the WMS layer\n    let timeLowerValueWatcherUnregister;\n    let timeUpperValueWatcherUnregister;\n    let wmsLayer;\n    if (dataSource.timeProperty &&\n        dataSource.ogcType === ngeoDatasourceOGC.Type.WMS\n    ) {\n      timeLowerValueWatcherUnregister = this.rootScope_.$watch(\n        () => dataSource.timeLowerValue,\n        this.handleDataSourceTimeValueChange_.bind(this, dataSource)\n      );\n\n      if (dataSource.timeProperty.mode === 'range') {\n        timeUpperValueWatcherUnregister = this.rootScope_.$watch(\n          () => dataSource.timeUpperValue,\n          this.handleDataSourceTimeValueChange_.bind(this, dataSource)\n        );\n      }\n\n      wmsLayer = googAsserts.assertInstanceof(\n        gmfLayertreeSyncLayertreeMap.getLayer(treeCtrl),\n        olLayerImage\n      );\n    }\n\n    this.treeCtrlCache_[id] = {\n      filterRulesWatcherUnregister,\n      stateWatcherUnregister,\n      timeLowerValueWatcherUnregister,\n      timeUpperValueWatcherUnregister,\n      treeCtrl,\n      wmsLayer\n    };\n\n    this.dataSources_.push(dataSource);\n\n    this.gmfWFSAliases_.describe(dataSource);\n  }\n\n  /**\n   * Remove a treeCtrl cache item. Unregister event listeners and remove the\n   * data source from the ngeo collection.\n   *\n   * @param {gmfx.datasource.ManagerTreeCtrlCacheItem} item Layertree\n   *     controller cache item\n   * @private\n   */\n  removeTreeCtrlCacheItem_(item) {\n\n    // (1) Remove data source\n    const dataSource = item.treeCtrl.getDataSource();\n    googAsserts.assert(dataSource, 'DataSource should be set');\n    this.dataSources_.remove(dataSource);\n\n    // (2) Remove item and clear event listeners\n    item.treeCtrl.setDataSource(null);\n    item.filterRulesWatcherUnregister();\n    item.stateWatcherUnregister();\n    if (item.timeLowerValueWatcherUnregister) {\n      item.timeLowerValueWatcherUnregister();\n    }\n    if (item.timeUpperValueWatcherUnregister) {\n      item.timeUpperValueWatcherUnregister();\n    }\n    delete this.treeCtrlCache_[olBase.getUid(item.treeCtrl.node)];\n  }\n\n  /**\n   * Clears the layer tree controller cache. At the same time, each item gets\n   * its data source reference unset and state watcher unregistered.\n   *\n   * The data source gets also removed from the ngeo data sources collection.\n   * @private\n   */\n  clearTreeCtrlCache_() {\n    for (const id in this.treeCtrlCache_) {\n      this.removeTreeCtrlCacheItem_(this.treeCtrlCache_[id]);\n    }\n  }\n\n  /**\n   * Called when the state of a 'leaf' layertree controller changes.\n   * Update the `visible` property of the data source according to the\n   * state of the layertree controller.\n   *\n   * Note: The possible states can only be 'on' or 'off', because the\n   * layertree controller being a 'leaf'.\n   *\n   * @param {ngeo.layertree.Controller} treeCtrl The layer tree controller\n   * @param {string|undefined} newVal New state value\n   * @private\n   */\n  handleTreeCtrlStateChange_(treeCtrl, newVal) {\n    const treeDataSource = treeCtrl.getDataSource();\n    googAsserts.assert(treeDataSource, 'DataSource should be set');\n    const visible = newVal === 'on';\n    treeDataSource.visible = visible;\n\n    // In GMF, multiple data sources can be combined into one ol.layer.Layer\n    // object. When changing the state of a data source, we need to make\n    // sure that the FILTER param match order of the current LAYERS param.\n    const layer = this.getDataSourceLayer_(treeDataSource);\n    if (layer == undefined) {\n      return;\n    }\n    this.updateLayerFilter_(layer);\n  }\n\n  /**\n   * Returns a layertree controller cache item, if it exists.\n   *\n   * @param {ngeo.layertree.Controller} treeCtrl The layer tree controller\n   * @return {gmfx.datasource.ManagerTreeCtrlCacheItem} Cache item\n   * @private\n   */\n  getTreeCtrlCacheItem_(treeCtrl) {\n    return this.treeCtrlCache_[olBase.getUid(treeCtrl.node)] || null;\n  }\n\n  /**\n   * Return the layer corresponding to the data source.\n   * @param {!ngeo.DataSource} dataSource The data source.\n   * @return {ol.layer.Base|undefined} The layer.\n   * @private\n   */\n  getDataSourceLayer_(dataSource) {\n    dataSource = /** @type {!gmf.DataSource} */ (dataSource);\n    if (dataSource.gmfLayer == undefined) {\n      return;\n    }\n    const id = olBase.getUid(dataSource.gmfLayer);\n    if (id == undefined) {\n      return;\n    }\n    const item = this.treeCtrlCache_[id];\n    if (item == undefined) {\n      return;\n    }\n    const treeCtrl = item.treeCtrl;\n    return gmfLayertreeSyncLayertreeMap.getLayer(treeCtrl);\n  }\n\n  /**\n   * Update layer filter parameter according to data sources filter rules\n   * and dimensions filters.\n   * @param {ol.layer.Base} layer The layer to update.\n   * @private\n   */\n  updateLayerFilter_(layer) {\n    googAsserts.assert(\n      layer instanceof olLayerImage ||\n      layer instanceof olLayerTile\n    );\n\n    const source = layer.getSource();\n    if (!(source instanceof olSourceImageWMS ||\n          source instanceof olSourceTileWMS)) {\n      return;\n    }\n\n    const params = source.getParams();\n    const layersParam = params['LAYERS'];\n    const layersList = layersParam.split(',');\n    googAsserts.assert(layersList.length >= 1);\n\n    const filterParam = 'FILTER';\n    const filterParamValues = [];\n    let hasFilter = false;\n    for (const wmsLayerName of layersList) {\n      let filterParamValue = '()';\n\n      const dataSources = this.dataSources_.getArray();\n      for (const dataSource of dataSources) {\n        const dsLayer = this.getDataSourceLayer_(dataSource);\n        if (dsLayer == undefined) {\n          continue;\n        }\n        if (olBase.getUid(dsLayer) == olBase.getUid(layer) &&\n            layer.get('querySourceIds').indexOf(dataSource.id) >= 0 &&\n            dataSource.gmfLayer.layers.split(',').indexOf(wmsLayerName) >= 0)  {\n\n          const id = olBase.getUid(dataSource.gmfLayer);\n          const item = this.treeCtrlCache_[id];\n          googAsserts.assert(item);\n          const treeCtrl = item.treeCtrl;\n          const projCode = treeCtrl.map.getView().getProjection().getCode();\n\n          const filterString = dataSource.visible ?\n            this.ngeoRuleHelper_.createFilterString({\n              dataSource: dataSource,\n              projCode: projCode,\n              incDimensions: true\n            }) :\n            null;\n          if (filterString) {\n            filterParamValue = `(${filterString})`;\n            hasFilter = true;\n          }\n        }\n      }\n\n      filterParamValues.push(filterParamValue);\n    }\n\n    source.updateParams({\n      [filterParam]: hasFilter ? filterParamValues.join('') : null\n    });\n  }\n\n  /**\n   * Called when both the 'visible' and 'filterRules' properties of a data\n   * source change.\n   *\n   * If the data source is filtrable, then make sure that when it gets rules\n   * set to apply them as OGC filters to the OpenLayers layer, more precisely\n   * as a `FILTER` parameter in the layer's source parameters.\n   *\n   * @param {!gmf.datasource.OGC} dataSource Data source.\n   * @private\n   */\n  handleDataSourceFilterRulesChange_(dataSource) {\n\n    // Skip data sources that are not filtrables OR those that do not have\n    // the WMS ogcType, i.e. those that do not have an OpenLayers layer\n    // to update\n    if (dataSource.filtrable !== true ||\n        dataSource.ogcType !== ngeoDatasourceOGC.Type.WMS\n    ) {\n      return;\n    }\n\n    const layer = this.getDataSourceLayer_(dataSource);\n    if (layer === undefined) {\n      return;\n    }\n    this.updateLayerFilter_(layer);\n  }\n\n  /**\n   * Called when either the `timeLowerValue` or `timeUpperValue` property of a\n   * data source changes.\n   *\n   * Get the range value from the data source, then update the WMS layer\n   * thereafter.\n   *\n   * @param {!gmf.datasource.OGC} dataSource Data source.\n   * @private\n   */\n  handleDataSourceTimeValueChange_(dataSource) {\n\n    const id = olBase.getUid(dataSource.gmfLayer);\n    const item = this.treeCtrlCache_[id];\n    googAsserts.assert(item);\n    const wmsLayer = googAsserts.assert(item.wmsLayer);\n    const wmsSource = googAsserts.assertInstanceof(\n      wmsLayer.getSource(),\n      olSourceImageWMS\n    );\n\n    const timeProperty = googAsserts.assert(dataSource.timeProperty);\n    let timeParam;\n    const range = dataSource.timeRangeValue;\n    if (range) {\n      timeParam = this.ngeoWMSTime_.formatWMSTimeParam(timeProperty, range);\n    }\n\n    // No need to update the TIME param if already the same value;\n    const params = wmsSource.getParams();\n    const currentTimeParam = params['TIME'];\n    if (currentTimeParam === timeParam) {\n      return;\n    }\n\n    // The `timeParam` can be undefined, which means that the TIME property\n    // gets reset.\n    this.ngeoLayerHelper_.updateWMSLayerState(\n      wmsLayer,\n      wmsSource.getParams()['LAYERS'],\n      timeParam\n    );\n  }\n\n  /**\n   * Called when the background layer changes. Add/Remove the according data\n   * sources to/from the ngeo data sources collection. Update the data source\n   * `visible` property as well.\n   *\n   * The `querySourceIds` property in the layer is used to determine the\n   * data sources that are bound to the layer.\n   *\n   * @param {!ngeox.BackgroundEvent} evt Event.\n   * @private\n   */\n  handleNgeoBackgroundLayerChange_(evt) {\n\n    const previousBackgroundLayer = evt.detail.previous;\n    const currentBackgroundLayer = evt.detail.current;\n    const cache = this.dataSourcesCache_;\n\n    // Remove data sources linked to previous background layer\n    if (previousBackgroundLayer) {\n      const ids = previousBackgroundLayer.get('querySourceIds');\n      if (Array.isArray(ids)) {\n        for (const id of ids) {\n          const dataSource = cache[id];\n          if (dataSource) {\n            dataSource.visible = false;\n            this.dataSources_.remove(dataSource);\n          }\n        }\n      }\n    }\n\n    // Add data sources linked to current background layer\n    if (currentBackgroundLayer) {\n      const ids = currentBackgroundLayer.get('querySourceIds');\n      if (Array.isArray(ids)) {\n        for (const id of ids) {\n          const dataSource = cache[id];\n          if (dataSource) {\n            dataSource.visible = true;\n            this.dataSources_.push(dataSource);\n          }\n        }\n      }\n    }\n  }\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfDataSourcesManager', [\n  gmfDatasourceWFSAliases.module.name,\n  gmfLayertreeSyncLayertreeMap.module.name,\n  gmfLayertreeTreeManager.module.name,\n  gmfThemeThemes.module.name,\n  ngeoFilterRuleHelper.module.name,\n  ngeoDatasourceDataSources.module.name,\n  ngeoMapBackgroundLayerMgr.module.name,\n  ngeoMapLayerHelper.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\nexports.module.service('gmfDataSourcesManager', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.datasource.module\n */\nimport gmfDatasourceDataSourceBeingFiltered from 'gmf/datasource/DataSourceBeingFiltered.js';\nimport gmfDatasourceExternalDataSourcesManager from 'gmf/datasource/ExternalDataSourcesManager.js';\nimport gmfDatasourceHelper from 'gmf/datasource/Helper.js';\nimport gmfDatasourceManager from 'gmf/datasource/Manager.js';\nimport gmfDatasourceWFSAliases from 'gmf/datasource/WFSAliases.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfDatasourceModule', [\n  gmfDatasourceDataSourceBeingFiltered.module.name,\n  gmfDatasourceExternalDataSourcesManager.module.name,\n  gmfDatasourceHelper.module.name,\n  gmfDatasourceManager.module.name,\n  gmfDatasourceWFSAliases.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.Disclaimer\n */\nimport 'bootstrap/js/alert.js';\nimport googAsserts from 'goog/asserts.js';\n\nimport ngeoMessagePopup from 'ngeo/message/Popup.js';\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\nimport * as olBase from 'ol/index.js';\nimport 'font-awesome/css/font-awesome.css';\n\n/**\n * Provides methods to display any sort of messages, disclaimers, errors,\n * etc. Requires Bootstrap library (both CSS and JS) to display the alerts\n * properly.\n *\n * @param {angular.$sce} $sce Angular sce service.\n * @param {angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {ngeox.PopupFactory} ngeoCreatePopup Popup service.\n * @constructor\n * @struct\n * @extends {ngeo.message.Message}\n * @ngdoc service\n * @ngname ngeoDisclaimer\n * @ngInject\n */\nconst exports = function($sce, gettextCatalog, ngeoCreatePopup) {\n\n  /**\n   * @private\n   * @type {angular.$sce}\n   */\n  this.sce_ = $sce;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @private\n   * @type {ngeox.PopupFactory}\n   */\n  this.createPopup_ = ngeoCreatePopup;\n\n  ngeoMessageMessage.call(this);\n\n  const container = angular.element('<div class=\"ngeo-disclaimer\"></div>');\n  angular.element(document.body).append(container);\n\n  /**\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.container_ = container;\n\n  /**\n   * Cache of messages.\n   * @type {Object.<string, angular.JQLite|ngeo.message.Popup>}\n   * @private\n   */\n  this.messages_ = {};\n\n};\n\nolBase.inherits(exports, ngeoMessageMessage);\n\n\n/**\n * Show disclaimer message string or object or list of disclamer message\n * strings or objects.\n * @param {string|Array.<string>|ngeox.Message|Array.<ngeox.Message>}\n *     object A message or list of messages as text or configuration objects.\n * @export\n */\nexports.prototype.alert = function(object) {\n  this.show(object);\n};\n\n\n/**\n * Close disclaimer message string or object or list of disclamer message\n * strings or objects.\n * @param {string|Array.<string>|ngeox.Message|Array.<ngeox.Message>}\n *     object A message or list of messages as text or configuration objects.\n * @export\n */\nexports.prototype.close = function(object) {\n  const msgObjects = this.getMessageObjects(object);\n  msgObjects.forEach(this.closeMessage_, this);\n};\n\n\n/**\n * Show the message.\n * @param {ngeox.Message} message Message.\n * @protected\n * @override\n */\nexports.prototype.showMessage = function(message) {\n  const gettextCatalog = this.gettextCatalog_;\n  const type = message.type;\n  googAsserts.assertString(type, 'Type should be set.');\n\n  // No need to do anything if message already exist.\n  const uid = this.getMessageUid_(message);\n  if (this.messages_[uid] !== undefined) {\n    return;\n  }\n\n  const showInPopup = message.popup === true;\n\n  if (showInPopup) {\n    // display the message in a popup, i.e. using the ngeo create popup\n    const popup = this.createPopup_();\n    const content = this.sce_.trustAsHtml(message.msg);\n    popup.open({\n      autoDestroy: true,\n      content: content,\n      title: '&nbsp;'\n    });\n\n    // Watch the open property\n    popup.scope.$watch('open', (newVal, oldVal) => {\n      if (!newVal) {\n        this.closeMessage_(message);\n      }\n    });\n\n    this.messages_[uid] =  popup;\n\n  } else {\n    // display the message using a boostrap dismissible alert\n    const classNames = ['alert', 'fade', 'alert-dismissible'];\n    switch (type) {\n      case ngeoMessageMessage.Type.ERROR:\n        classNames.push('alert-danger');\n        break;\n      case ngeoMessageMessage.Type.INFORMATION:\n        classNames.push('alert-info');\n        break;\n      case ngeoMessageMessage.Type.SUCCESS:\n        classNames.push('alert-success');\n        break;\n      case ngeoMessageMessage.Type.WARNING:\n        classNames.push('alert-warning');\n        break;\n      default:\n        break;\n    }\n\n    const el = angular.element(\n      `<div role=\"alert\" class=\"${classNames.join(' ')}\"></div>`);\n    const button = angular.element(\n      `<button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"${\n        gettextCatalog.getString('Close')\n      }\"><span aria-hidden=\"true\" class=\"fa fa-times\"></span></button>`);\n    const msg = angular.element('<span />').html(message.msg);\n    el.append(button).append(msg);\n\n    let container;\n\n    if (message.target) {\n      container = angular.element(message.target);\n    } else {\n      container = this.container_;\n    }\n\n    container.append(el);\n    el.addClass('in');\n\n    // Listen when the message gets closed to cleanup the cache of messages\n    el.on('closed.bs.alert', () => {\n      this.closeMessage_(message);\n    });\n\n    this.messages_[uid] =  el;\n  }\n};\n\n\n/**\n * @param {ngeox.Message} message Message.\n * @return {string} The uid.\n * @private\n */\nexports.prototype.getMessageUid_ = function(message) {\n  return `${message.msg}-${message.type}`;\n};\n\n\n/**\n * Close the message.\n * @param {ngeox.Message} message Message.\n * @protected\n */\nexports.prototype.closeMessage_ = function(message) {\n  const uid = this.getMessageUid_(message);\n  const obj = this.messages_[uid];\n\n  // (1) No need to do anything if message doesn't exist\n  if (obj === undefined) {\n    return;\n  }\n\n  // (2) Close message (popup or alert)\n  if (obj instanceof ngeoMessagePopup) {\n    // (2.1) Close popup, if not already closed\n    if (obj.getOpen()) {\n      obj.setOpen(false);\n    }\n  } else {\n    // (2.2) Check if the message hasn't been closed using the UI, i.e. by\n    //       clicking the close button. If not, then close it.\n    if (obj.hasClass('in')) {\n      obj.alert('close');\n    }\n  }\n\n  // (3) Remove message from cache since it's closed now.\n  delete this.messages_[uid];\n};\n\n\n/**\n * @type {angular.Module}\n */\nexports.module = angular.module('ngeoDisclaimer', [\n  ngeoMessagePopup.module.name,\n]);\n\nexports.module.service('ngeoDisclaimer', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.disclaimer.component\n */\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olLayerBase from 'ol/layer/Base.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport gmfBase from 'gmf/index.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\nimport ngeoMessageDisclaimer from 'ngeo/message/Disclaimer.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\n\nimport 'angular-sanitize';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('gmfDisclaimer', [\n  'ngSanitize',\n  ngeoMapLayerHelper.module.name,\n  ngeoMessageDisclaimer.module.name,\n  ngeoMiscEventHelper.module.name,\n]);\n\n\n/**\n * @constructor\n * @private\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!angular.$sce} $sce Angular sce service.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!ngeox.PopupFactory} ngeoCreatePopup Popup service.\n * @param {!ngeo.message.Disclaimer} ngeoDisclaimer Ngeo Disclaimer service.\n * @param {!ngeo.misc.EventHelper} ngeoEventHelper Ngeo Event Helper.\n * @param {!ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname GmfDisclaimerController\n */\nexports.Controller_ = function($element, $scope, $sce, $timeout,\n  gettextCatalog, ngeoCreatePopup, ngeoDisclaimer, ngeoEventHelper, ngeoLayerHelper) {\n\n  /**\n   * @type {?ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {boolean|undefined}\n   * @export\n   */\n  this.external;\n\n  /**\n   * @type {boolean|undefined}\n   * @export\n   */\n  this.popup;\n\n  /**\n   * Visibility that is set to true when a new msg is there.\n   * @type {boolean}\n   * @export\n   */\n  this.visibility = false;\n\n  /**\n   * Trusted html messages that can be displayed as html.\n   * @type {string|undefined}\n   * @export\n   */\n  this.msg;\n\n  /**\n   * @type {!Array<string>}\n   * @export\n   */\n  this.msgs_ = [];\n\n  /**\n   * @type {!angular.$sce}\n   * @private\n   */\n  this.sce_ = $sce;\n\n  /**\n   * @type {!angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {!angular.JQLite}\n   * @private\n   */\n  this.element_ = $element;\n\n  /**\n   * @type {!ngeox.PopupFactory}\n   * @private\n   */\n  this.createPopup_ = ngeoCreatePopup;\n\n  /**\n   * @type {!ngeo.message.Disclaimer}\n   * @private\n   */\n  this.disclaimer_ = ngeoDisclaimer;\n\n  /**\n   * @type {!ngeo.misc.EventHelper}\n   * @private\n   */\n  this.eventHelper_ = ngeoEventHelper;\n\n  /**\n   * @type {!ngeo.map.LayerHelper}\n   * @private\n   */\n  this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {?ol.layer.Group}\n   * @private\n   */\n  this.dataLayerGroup_ = null;\n};\n\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.dataLayerGroup_ = this.ngeoLayerHelper_.getGroupFromMap(this.map,\n    gmfBase.DATALAYERGROUP_NAME);\n  this.registerLayer_(this.dataLayerGroup_);\n};\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleLayersAdd_ = function(evt) {\n  this.timeout_(() => {\n    const layer = evt.element;\n    googAsserts.assertInstanceof(layer, olLayerBase);\n    this.registerLayer_(layer);\n  });\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleLayersRemove_ = function(evt) {\n  const layer = evt.element;\n  googAsserts.assertInstanceof(layer, olLayerBase);\n  this.unregisterLayer_(layer);\n};\n\n\n/**\n * @param {ol.layer.Base} layer Layer.\n * @private\n */\nexports.Controller_.prototype.registerLayer_ = function(layer) {\n\n  const layerUid = olBase.getUid(layer);\n\n  if (layer instanceof olLayerGroup) {\n\n    // (1) Listen to added/removed layers to this group\n    this.eventHelper_.addListenerKey(\n      layerUid,\n      olEvents.listen(\n        layer.getLayers(),\n        'add',\n        this.handleLayersAdd_,\n        this\n      )\n    );\n    this.eventHelper_.addListenerKey(\n      layerUid,\n      olEvents.listen(\n        layer.getLayers(),\n        'remove',\n        this.handleLayersRemove_,\n        this\n      )\n    );\n\n    // (2) Register existing layers in the group\n    layer.getLayers().forEach((layer) => {\n      this.registerLayer_(layer);\n    });\n\n  } else {\n\n    // Show disclaimer messages for this layer\n    const disclaimers = layer.get('disclaimers');\n    if (disclaimers && Array.isArray(disclaimers)) {\n      disclaimers.forEach((disclaimer) => {\n        this.showDisclaimerMessage_(disclaimer);\n      });\n    }\n  }\n};\n\n\n/**\n * @param {ol.layer.Base} layer Layer.\n * @private\n */\nexports.Controller_.prototype.unregisterLayer_ = function(layer) {\n\n  const layerUid = olBase.getUid(layer);\n\n  if (layer instanceof olLayerGroup) {\n\n    // (1) Clear event listeners\n    this.eventHelper_.clearListenerKey(layerUid);\n\n    // (2) Unregister existing layers in the group\n    layer.getLayers().forEach(layer => this.unregisterLayer_(layer));\n\n  } else {\n\n    // Close disclaimer messages for this layer\n    const disclaimers = layer.get('disclaimers');\n    if (disclaimers && Array.isArray(disclaimers)) {\n      disclaimers.forEach((disclaimer) => {\n        this.closeDisclaimerMessage_(disclaimer);\n      });\n    }\n  }\n\n};\n\n\nexports.Controller_.prototype.$onDestroy = function() {\n  this.unregisterLayer_(this.dataLayerGroup_);\n};\n\n\n/**\n * @param {string} msg Disclaimer message.\n * @private\n */\nexports.Controller_.prototype.showDisclaimerMessage_ = function(msg) {\n  msg = this.gettextCatalog_.getString(msg);\n  if (this.external) {\n    if (this.msgs_.indexOf(msg) < 0) {\n      this.msgs_.push(msg);\n    }\n    this.msg = `${this.sce_.trustAsHtml(this.msgs_.join('<br />'))}`;\n    this.visibility = true;\n  } else {\n    this.disclaimer_.alert({\n      popup: this.popup,\n      msg: msg,\n      target: this.element_,\n      type: ngeoMessageMessage.Type.WARNING\n    });\n  }\n};\n\n\n/**\n * @param {string} msg Disclaimer message.\n * @private\n */\nexports.Controller_.prototype.closeDisclaimerMessage_ = function(msg) {\n  msg = this.gettextCatalog_.getString(msg);\n  if (this.external) {\n    this.visibility = false;\n    this.msgs_.length = 0;\n    this.msg = '';\n  } else {\n    this.disclaimer_.close({\n      popup: this.popup,\n      msg: msg,\n      target: this.element_,\n      type: ngeoMessageMessage.Type.WARNING\n    });\n  }\n};\n\n\n/**\n * Provide a \"disclaimer\" component for GeoMapFish that is bound to the\n * layers added and removed from a map.\n *\n * Example:\n *\n *      <gmf-disclaimer\n *        gmf-disclaimer-map=\"::ctrl.map\">\n *      </gmf-disclaimer>\n *\n * You can also display the disclaimer messages in popups or use them in another\n * context. The example below show you how to display the disclaimer messages\n * in a ngeo-modal window (external case).\n *\n * Example:\n *\n *      <gmf-disclaimer\n *        gmf-disclaimer-map=\"::ctrl.map\"\n *        gmf-disclaimer-external=\"::true\"\n *        gmf-disclaimer-external-msg=\"disclaimerMsg\"\n *        gmf-disclaimer-external-visibility=\"disclaimerVisibility\">\n *      </gmf-disclaimer>\n *      <ngeo-modal ng-model=\"disclaimerVisibility\">\n *       <div class=\"modal-header\">\n *         <button type=\"button\" class=\"close\" data-dismiss=\"modal\"\n *                 aria-hidden=\"true\">&times;</button>\n *       </div>\n *       <div class=\"modal-body\">\n *         <div ng-bind-html=\"disclaimerMsg\"></div>\n *       </div>\n *     </ngeo-modal>\n *\n * @htmlAttribute {boolean} gmf-disclaimer-popup Whether to show the disclaimer\n *     messages in popups or not. Defaults to `false`.\n * @htmlAttribute {boolean?} gmf-disclaimer-external Whether to use disclaimer\n *     messages elsewhere or not. Default to `false`. If true, you should use\n *     the gmf-disclaimer-external-msg and the\n *     gmf-disclaimer-external-visibility too.\n * @htmlAttribute {boolean?} gmf-disclaimer-external-visibility variable that\n *     will be set to true if the disclaimers contain a new message. To uses it,\n *     you must set the gmf-disclaimer-external to true.\n * @htmlAttribute {string?} gmf-disclaimer-external-msg variable that will\n *     contains the disclaimer messages. To uses it, you must set the\n *     gmf-disclaimer-external to true.\n * @htmlAttribute {ol.Map=} gmf-disclaimer-map The map.\n *\n * @ngdoc component\n * @ngname gmfDisclaimer\n */\nexports.component_ = {\n  controller: exports.Controller_,\n  bindings: {\n    'popup': '<?gmfDisclaimerPopup',\n    'map': '=gmfDisclaimerMap',\n    'external': '<?gmfDisclaimerExternal',\n    'visibility': '=?gmfDisclaimerExternalVisibility',\n    'msg': '=?gmfDisclaimerExternalMsg'\n  }\n};\n\n\nexports.component('gmfDisclaimer', exports.component_);\n\n\nexport default exports;\n","/**\n * @module gmf.filters.SavedFilters\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olArray from 'ol/array.js';\n\nconst exports = class {\n\n  /**\n   * The GeoMapFish service responsible of storing filters that can be applied\n   * to data sources. A filter consists of:\n   *\n   * - a condition\n   * - a list of directed rules\n   * - a list of custom rules\n   * - a data source\n   * - a name\n   *\n   * The filters are saved in the browser local storage, if available.\n   * Otherwise, they are kept in this service for the duration of the visit.\n   *\n   * @param {!angular.Scope} $rootScope Angular rootScope.\n   * @struct\n   * @ngInject\n   * @ngdoc service\n   * @ngname gmfSavedFilters\n   */\n  constructor($rootScope) {\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.rootScope_ = $rootScope;\n\n    /**\n     * This service can have a data source id bound to it, which automatically\n     * populates an array of items that are only bound to this data source.\n     * @type {?number}\n     * @private\n     */\n    this.currentDataSourceId_ = null;\n\n    /**\n     * @type {!Array.<!gmf.filters.SavedFilters.Item>}\n     * @private\n     */\n    this.currentDataSourceItems_ = [];\n\n    /**\n     * The used by this service to save in the local storage.\n     * @type {string}\n     * @private\n     */\n    this.localStorageKey_ = 'gmf_savedfilters';\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.useLocalStorage_ = true;\n\n    try {\n      if ('localStorage' in window) {\n        window.localStorage['test'] = '';\n        delete window.localStorage['test'];\n      } else {\n        this.useLocalStorage_ = false;\n      }\n    } catch (err) {\n      console.error(err);\n      this.useLocalStorage_ = false;\n    }\n\n    /**\n     * @type {!Array.<!gmf.filters.SavedFilters.Item>}\n     * @private\n     */\n    this.items_ = [];\n\n    this.rootScope_.$watchCollection(\n      () => this.items,\n      () => {\n        this.rePopulateCurrentDataSourceItems_();\n      }\n    );\n\n    if (this.useLocalStorage_) {\n      this.loadItemsFromLocalStorage_();\n    }\n\n  }\n\n  /**\n   * @return {!Array.<!gmf.filters.SavedFilters.Item>} Items\n   * @export\n   */\n  get currentDataSourceItems() {\n    return this.currentDataSourceItems_;\n  }\n\n  /**\n   * @param {?number} id Current data source id.\n   * @export\n   */\n  set currentDataSourceId(id) {\n    this.currentDataSourceId_ = id;\n    this.rePopulateCurrentDataSourceItems_();\n  }\n\n  /**\n   * @return {!Array.<!gmf.filters.SavedFilters.Item>} Items\n   * @export\n   */\n  get items() {\n    return this.items_;\n  }\n\n  /**\n   * Read the filter items that are saved in the local storage and set them\n   * as this service's items.\n   * @private\n   */\n  loadItemsFromLocalStorage_() {\n    if (window.localStorage[this.localStorageKey_]) {\n      const items = JSON.parse(window.localStorage[this.localStorageKey_]);\n      googAsserts.assertArray(items);\n      this.items_ = items;\n    }\n  }\n\n  /**\n   * Search for an item using a given name and data source id. Returns the\n   * index if it exists, otherwise -1 is returned.\n   * @param {string} name Name.\n   * @param {number} id Data source id.\n   * @return {number} The index of the item, if it exists.\n   * @export\n   */\n  indexOfItem(name, id) {\n\n    let item;\n    let idx = -1;\n    for (let i = 0, ii = this.items_.length; i < ii; i++) {\n      item = this.items[i];\n      if (item.dataSourceId === id && item.name === name) {\n        idx = i;\n        break;\n      }\n    }\n\n    return idx;\n  }\n\n  /**\n   * @param {!gmf.filters.SavedFilters.Item} item Item.\n   * @export\n   */\n  save(item) {\n\n    // (1) Add or replace item\n    const idx = this.indexOfItem(item.name, item.dataSourceId);\n    if (idx !== -1) {\n      this.items[idx] = item;\n    } else {\n      this.items.push(item);\n    }\n\n    // (2) Update local storage\n    if (this.useLocalStorage_) {\n      this.saveItemsInLocalStorage_();\n    }\n  }\n\n  /**\n   * @param {!gmf.filters.SavedFilters.Item} item Item.\n   * @export\n   */\n  remove(item) {\n\n    // (1) Remove the item\n    const found = olArray.remove(this.items, item);\n\n    // (2) Update local storage\n    if (found && this.useLocalStorage_) {\n      this.saveItemsInLocalStorage_();\n    }\n  }\n\n  /**\n   * Save all items in the local storage.\n   * @private\n   */\n  saveItemsInLocalStorage_() {\n    window.localStorage[this.localStorageKey_] = JSON.stringify(this.items);\n  }\n\n  /**\n   * @private\n   */\n  rePopulateCurrentDataSourceItems_() {\n    // (1) Clear existing items\n    this.currentDataSourceItems_.length = 0;\n\n    // (2) Populate\n    if (this.currentDataSourceId_ !== null) {\n      for (const item of this.items) {\n        if (item.dataSourceId === this.currentDataSourceId_) {\n          this.currentDataSourceItems_.push(item);\n        }\n      }\n    }\n  }\n\n};\n\n\nexports.module = angular.module('gmfSavedFilters', []);\n\nexports.module.service('gmfSavedFilters', exports);\n\n\n/**\n * The definition of a saved filter item.\n * @constructor\n * @struct\n * @export\n */\nexports.Item = function() {};\n\n\n/**\n * The condition of the saved filter item.\n * @type {string}\n * @export\n */\nexports.Item.prototype.condition;\n\n\n/**\n * The list of custom rules of the saved filter item.\n * @type {!Array.<!ngeox.rule.AnyOptions>}\n * @export\n */\nexports.Item.prototype.customRules;\n\n\n/**\n * The data source id related to the filter.\n * @type {number}\n * @export\n */\nexports.Item.prototype.dataSourceId;\n\n\n/**\n * The list of directed rules of the saved filter item.\n * @type {!Array.<!ngeox.rule.AnyOptions>}\n * @export\n */\nexports.Item.prototype.directedRules;\n\n\n/**\n * A human-readable name given to the saved filter item.\n * @type {string}\n * @export\n */\nexports.Item.prototype.name;\n\n\nexport default exports;\n","/**\n * @module ngeo.filter.ruleComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMenu from 'ngeo/Menu.js';\nimport ngeoDrawComponent from 'ngeo/draw/component.js';\n\n/** @suppress {extraRequire} */\nimport ngeoFilterRuleHelper from 'ngeo/filter/RuleHelper.js';\n\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionModify from 'ngeo/interaction/Modify.js';\nimport ngeoInteractionRotate from 'ngeo/interaction/Rotate.js';\nimport ngeoInteractionTranslate from 'ngeo/interaction/Translate.js';\nimport ngeoMapFeatureOverlay from 'ngeo/map/FeatureOverlay.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscDatepickerComponent from 'ngeo/misc/datepickerComponent.js';\n\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\nimport ngeoRuleRule from 'ngeo/rule/Rule.js';\nimport ngeoRuleGeometry from 'ngeo/rule/Geometry.js';\nimport ngeoRuleSelect from 'ngeo/rule/Select.js';\nimport * as olBase from 'ol/index.js';\nimport olFeature from 'ol/Feature.js';\nimport olCollection from 'ol/Collection.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olArray from 'ol/array.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olGeomGeometry from 'ol/geom/Geometry.js';\nimport 'font-awesome/css/font-awesome.css';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('ngeoRule', [\n  ngeoDrawComponent.name,\n  ngeoFilterRuleHelper.module.name,\n  ngeoMapFeatureOverlay.module.name,\n  ngeoMiscDatepickerComponent.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscToolActivateMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/filter/rulecomponent', require('./rulecomponent.html'));\n});\n\n\nexports.value('ngeoRuleTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['ngeoRuleTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/filter/rulecomponent';\n  });\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} ngeoRuleTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoRuleTemplateUrl($attrs, ngeoRuleTemplateUrl) {\n  return ngeoRuleTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.RuleController_ = class {\n\n  /**\n   * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n   * @param {!angular.Scope} $scope Angular scope.\n   * @param {!angular.$timeout} $timeout Angular timeout service.\n   * @param {!ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n   * @param {!ngeo.filter.RuleHelper} ngeoRuleHelper Ngeo rule helper service.\n   * @param {!ngeo.misc.ToolActivateMgr} ngeoToolActivateMgr Ngeo ToolActivate\n   *     manager service.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname NgeoRuleController\n   */\n  constructor(gettextCatalog, $scope, $timeout, ngeoFeatureHelper,\n    ngeoRuleHelper, ngeoToolActivateMgr) {\n\n    // Binding properties\n\n    /**\n     * @type {!ngeo.map.FeatureOverlay}\n     * @export\n     */\n    this.featureOverlay;\n\n    /**\n     * @type {!ol.Map}\n     * @export\n     */\n    this.map;\n\n    /**\n     * The original rule.\n     * @type {!ngeo.rule.Rule}\n     * @export\n     */\n    this.rule;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.toolGroup;\n\n\n    // Injected properties\n\n    /**\n     * @type {angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {!angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {!ngeo.misc.FeatureHelper}\n     * @private\n     */\n    this.ngeoFeatureHelper_ = ngeoFeatureHelper;\n\n    /**\n     * @type {!ngeo.filter.RuleHelper}\n     * @private\n     */\n    this.ngeoRuleHelper_ = ngeoRuleHelper;\n\n    /**\n     * @type {!ngeo.misc.ToolActivateMgr}\n     * @private\n     */\n    this.ngeoToolActivateMgr_ = ngeoToolActivateMgr;\n\n\n    // Inner properties\n\n    /**\n     * The cloned rule. Changes in the UI are applied to the clone 'on-the-fly'.\n     * Changes in the clone are applied back in the original rule when the\n     * apply button is clicked.\n     * @type {!ngeo.rule.Rule}\n     * @export\n     */\n    this.clone;\n\n    const operatorType = ngeoRuleRule.OperatorType;\n    const spatialOperatorType = ngeoRuleRule.SpatialOperatorType;\n    const temporalOperatorType = ngeoRuleRule.TemporalOperatorType;\n\n    /**\n     * @type {Object.<string, string>}\n     * @export\n     */\n    this.operators = {\n      [operatorType.EQUAL_TO]: gettextCatalog.getString('Is equal to'),\n      [operatorType.GREATER_THAN]: gettextCatalog.getString('Is greater than'),\n      [operatorType.GREATER_THAN_OR_EQUAL_TO]: gettextCatalog.getString(\n        'Is greater than or equal to'),\n      [operatorType.LESSER_THAN]: gettextCatalog.getString('Is lesser than'),\n      [operatorType.LESSER_THAN_OR_EQUAL_TO]: gettextCatalog.getString(\n        'Is lesser than or equal to'),\n      [operatorType.NOT_EQUAL_TO]: gettextCatalog.getString('Is not equal to'),\n      [operatorType.LIKE]: gettextCatalog.getString('Contains'),\n      [spatialOperatorType.CONTAINS]: gettextCatalog.getString('Contains'),\n      [spatialOperatorType.INTERSECTS]: gettextCatalog.getString('Intersects'),\n      [spatialOperatorType.WITHIN]: gettextCatalog.getString('Is inside of'),\n      [temporalOperatorType.BEGINS]: gettextCatalog.getString('Begins at'),\n      [temporalOperatorType.DURING]: gettextCatalog.getString('During'),\n      [temporalOperatorType.ENDS]: gettextCatalog.getString('Ends at'),\n      [temporalOperatorType.EQUALS]: gettextCatalog.getString('Is equal to')\n    };\n\n    /**\n     * @type {Object.<string, string>}\n     * @export\n     */\n    this.operatorsShortFormat = {\n      [operatorType.EQUAL_TO]: '=',\n      [operatorType.GREATER_THAN]: '>',\n      [operatorType.GREATER_THAN_OR_EQUAL_TO]: '>=',\n      [operatorType.LESSER_THAN]: '<',\n      [operatorType.LESSER_THAN_OR_EQUAL_TO]: '<=',\n      [operatorType.NOT_EQUAL_TO]: '!=',\n      [operatorType.LIKE]: '~',\n      [temporalOperatorType.BEGINS]: '>=',\n      [temporalOperatorType.ENDS]: '<=',\n      [temporalOperatorType.EQUALS]: '='\n    };\n\n    /**\n     * Time property used when the rule is of type 'date|datetime' and uses\n     * a range of date.\n     * @type {!ngeox.TimeProperty}\n     * @export\n     */\n    this.timeRangeMode = {\n      widget: 'datepicker',\n      maxValue: null,\n      minValue: null,\n      maxDefValue: this.createDate_(),\n      minDefValue: this.createWeekAgoDate_(),\n      mode: 'range',\n      interval: [0, 1, 0, 0]\n    };\n\n    /**\n     * Time property used when the rule is of type 'date|datetime' and uses\n     * a single date.\n     * @type {!ngeox.TimeProperty}\n     * @export\n     */\n    this.timeValueMode = {\n      widget: 'datepicker',\n      maxValue: null,\n      minValue: null,\n      maxDefValue: this.createDate_(),\n      minDefValue: this.createDate_(),\n      mode: 'value',\n      interval: [0, 1, 0, 0]\n    };\n\n    /**\n     * @type {!ngeo.misc.ToolActivate}\n     * @private\n     */\n    this.toolActivate_;// = new ngeo.misc.ToolActivate(this.rule, 'active');\n\n    /**\n     * @type {!Array.<Function>}\n     * @private\n     */\n    this.unlisteners_ = [];\n\n\n    // Inner properties when dealing with a `ngeo.rule.Geometry`\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.drawActive = false;\n\n    /**\n     * @type {!ngeo.misc.ToolActivate}\n     * @export\n     */\n    this.drawToolActivate = new ngeoMiscToolActivate(this, 'drawActive');\n\n    /**\n     * @type {!ol.Collection.<!ol.Feature>}\n     * @export\n     */\n    this.drawnFeatures = new olCollection();\n\n    /**\n     * @type {?ngeo.Menu}\n     * @private\n     */\n    this.menu_ = null;\n\n    /**\n     * @type {!ol.Collection.<!ol.Feature>}\n     * @export\n     */\n    this.selectedFeatures = new olCollection();\n\n    /**\n     * @type {!ol.Collection.<!ol.interaction.Interaction>}\n     * @private\n     */\n    this.interactions_ = new olCollection();\n\n    /**\n     * @type {!ngeo.interaction.Modify}\n     * @private\n     */\n    this.modify_ = new ngeoInteractionModify({\n      features: this.selectedFeatures,\n      style: ngeoFeatureHelper.getVertexStyle(false)\n    });\n    this.interactions_.push(this.modify_);\n\n    /**\n     * @type {ngeo.interaction.Rotate}\n     * @private\n     */\n    this.rotate_ = new ngeoInteractionRotate({\n      features: this.selectedFeatures,\n      style: new olStyleStyle({\n        text: new olStyleText({\n          text: '\\uf01e',\n          font: 'normal 18px FontAwesome',\n          fill: new olStyleFill({\n            color: '#7a7a7a'\n          })\n        })\n      })\n    });\n    this.interactions_.push(this.rotate_);\n\n    /**\n     * @type {ngeo.interaction.Translate}\n     * @private\n     */\n    this.translate_ = new ngeoInteractionTranslate({\n      features: this.selectedFeatures,\n      style: new olStyleStyle({\n        text: new olStyleText({\n          text: '\\uf047',\n          font: 'normal 18px FontAwesome',\n          fill: new olStyleFill({\n            color: '#7a7a7a'\n          })\n        })\n      })\n    });\n    this.interactions_.push(this.translate_);\n\n    /**\n     * @type {!Array.<!ol.EventsKey>}\n     * @private\n     */\n    this.listenerKeys_ = [];\n\n    this.initializeInteractions_();\n\n    /**\n     * @type {!ngeo.misc.ToolActivate}\n     * @export\n     */\n    this.modifyToolActivate = new ngeoMiscToolActivate(\n      this.modify_,\n      'active'\n    );\n\n    /**\n     * @type {ngeo.misc.ToolActivate}\n     * @export\n     */\n    this.rotateToolActivate = new ngeoMiscToolActivate(\n      this.rotate_,\n      'active'\n    );\n\n    /**\n     * @type {ngeo.misc.ToolActivate}\n     * @export\n     */\n    this.translateToolActivate = new ngeoMiscToolActivate(\n      this.translate_,\n      'active'\n    );\n\n    /**\n     * The geometry type used by the clone feature.\n     * @type {?string}\n     * @export\n     */\n    this.geomType = null;\n  }\n\n  /**\n   * Called on initialization of the controller.\n   *\n   * Clone the rule to be able to work with the clone directly.\n   */\n  $onInit() {\n    this.clone = this.ngeoRuleHelper_.cloneRule(this.rule);\n\n    this.toolActivate_ = new ngeoMiscToolActivate(this.rule, 'active');\n\n    this.ngeoToolActivateMgr_.registerTool(\n      this.toolGroup, this.toolActivate_);\n\n    this.scope_.$watch(\n      () => this.rule.active,\n      this.handleActiveChange_.bind(this)\n    );\n\n    // If the rule is a DATE or DATETIME, then a datepicker directive is used.\n    // It is not possible to set the current values to the datepicker, but you\n    // can set the initial values. This is why it is created when the rule\n    // becomes active (see the partials/rule.html).\n    //\n    // This chunk of code ensures that the rule properties are synchronized\n    // with the TimeProperty objects required to build the datepickers.\n    if (this.clone.type === ngeoFormatAttributeType.DATE ||\n        this.clone.type === ngeoFormatAttributeType.DATETIME\n    ) {\n      // Watch 'expression'\n      this.unlisteners_.push(this.scope_.$watch(\n        () => this.clone.getExpression(),\n        (newVal) => {\n          this.timeValueMode.minDefValue = newVal || this.createDate_();\n        }\n      ));\n      // Watch 'lowerBoundary'\n      this.unlisteners_.push(this.scope_.$watch(\n        () => this.clone.lowerBoundary,\n        (newVal) => {\n          this.timeRangeMode.minDefValue = newVal || this.createWeekAgoDate_();\n        }\n      ));\n      // Watch 'upperBoundary'\n      this.unlisteners_.push(this.scope_.$watch(\n        () => this.clone.upperBoundary,\n        (newVal) => {\n          this.timeRangeMode.maxDefValue = newVal || this.createDate_();\n        }\n      ));\n    } else if (this.clone.type === ngeoFormatAttributeType.GEOMETRY) {\n\n      // Watch 'operator' of clone. Make sure any existing geometry is\n      // supported by the newly selected operator. If it doesn't, reset\n      // the expression, i.e. geometry.\n      this.unlisteners_.push(this.scope_.$watch(\n        () => this.clone.operator,\n        (newVal) => {\n          if (newVal &&\n              newVal === ngeoRuleRule.SpatialOperatorType.CONTAINS\n          ) {\n            const clone = googAsserts.assertInstanceof(\n              this.clone, ngeoRuleGeometry);\n            const geometry = clone.feature.getGeometry();\n            if (geometry) {\n              const geomType = this.ngeoFeatureHelper_.getType(clone.feature);\n              const supportedTypes = [\n                ngeoGeometryType.CIRCLE,\n                ngeoGeometryType.POLYGON,\n                ngeoGeometryType.RECTANGLE\n              ];\n              if (!olArray.includes(supportedTypes, geomType)) {\n                this.clone.setExpression(null);\n              }\n            }\n          }\n        }\n      ));\n\n      // Watch 'expression' of clone. Set 'geomType' property accordingly.\n      this.unlisteners_.push(this.scope_.$watch(\n        () => this.clone.expression,\n        (newVal) => {\n          if (newVal) {\n            const clone = googAsserts.assertInstanceof(\n              this.clone, ngeoRuleGeometry);\n            this.geomType = this.ngeoFeatureHelper_.getType(clone.feature);\n          } else {\n            this.geomType = null;\n          }\n        }\n      ));\n\n      // Watch both 'expression', 'active' and the modify control to be all\n      // thruthy. When that's the case, the clone feature is added to the\n      // selection collection.\n      this.unlisteners_.push(this.scope_.$watch(\n        () => {\n          const hasExpression = this.clone.getExpression() !== null;\n          const isActive = this.rule.active === true;\n          const editToolIsActive = this.modify_.getActive() ||\n                this.rotate_.getActive() ||\n                this.translate_.getActive();\n          return hasExpression && isActive && editToolIsActive;\n        },\n        (newVal) => {\n          if (newVal) {\n            const clone = googAsserts.assertInstanceof(\n              this.clone, ngeoRuleGeometry);\n            this.selectedFeatures.push(clone.feature);\n          } else {\n            this.selectedFeatures.clear();\n          }\n        }\n      ));\n    }\n  }\n\n  /**\n   * Called on destruction of the controller.\n   */\n  $onDestroy() {\n    if (this.rule.active) {\n      this.rule.active = false;\n      // in $onDestroy, setting active to false will not call the handler. Call\n      // it manually to let it do its magic\n      this.handleActiveChange_(false, true);\n    }\n    this.ngeoToolActivateMgr_.unregisterTool(\n      this.toolGroup, this.toolActivate_);\n    for (let i = 0, ii = this.unlisteners_.length; i < ii; i++) {\n      this.unlisteners_[i]();\n    }\n    this.unlisteners_.length = 0;\n    this.clone.destroy();\n  }\n\n  /**\n   * @export\n   */\n  toggle() {\n    if (this.rule.active) {\n      this.cancel();\n    } else {\n      this.rule.active = true;\n    }\n  }\n\n  /**\n   * Apply the changes that were made in the original rule.\n   * @export\n   */\n  apply() {\n    this.ngeoRuleHelper_.extendRule(this.clone, this.rule);\n    this.rule.active = false;\n  }\n\n  /**\n   * Revert the changes that were made in the clone rule.\n   * @export\n   */\n  cancel() {\n    this.ngeoRuleHelper_.extendRule(this.rule, this.clone);\n    this.rule.active = false;\n  }\n\n  /**\n   * Reset both original and clone rules.\n   * @export\n   */\n  reset() {\n    this.clone.reset();\n    this.rule.reset();\n  }\n\n  /**\n   * Called when a choice is clicked, when using a `ngeo.rule.Select` rule type.\n   * Add/remove the choice to/from the `expression` of the rule.\n   * @param {string|number} choice Choice that has been clicked.\n   * @export\n   */\n  toggleChoiceSelection(choice) {\n    const rule = googAsserts.assertInstanceof(this.clone, ngeoRuleSelect);\n    const choices = rule.getExpression() ? rule.getExpression().split(',') : [];\n    const idx = choices.indexOf(choice);\n    if (idx > -1) {\n      choices.splice(idx, 1);\n    } else {\n      choices.push(choice);\n    }\n    rule.setExpression(choices.length ? choices.join(',') : null);\n  }\n\n\n  /**\n   * @param {Object} date Date\n   * @export\n   */\n  onDateSelected(date) {\n    this.clone.setExpression(date['start']);\n  }\n\n  /**\n   * @param {Object} date Date\n   * @export\n   */\n  onDateRangeSelected(date) {\n    this.clone.lowerBoundary = date['start'];\n    this.clone.upperBoundary = date['end'];\n  }\n\n  /**\n   * @param {number=} opt_timeDelta Time delta to go back in the past.\n   * @return {string} ISO string of the date\n   * @private\n   */\n  createDate_(opt_timeDelta) {\n\n    const date = new Date();\n\n    if (opt_timeDelta !== undefined) {\n      const time = date.getTime() - opt_timeDelta;\n      date.setTime(time);\n    }\n\n    return date.toISOString();\n  }\n\n  /**\n   * @return {string} ISO string of the date\n   * @private\n   */\n  createWeekAgoDate_() {\n    return this.createDate_(1000 * 60 * 60 * 24 * 7); // A week ago date\n  }\n\n  /**\n   * @param {number} time Time.\n   * @return {string} Date\n   * @export\n   */\n  timeToDate(time) {\n    const date = new Date(time);\n    return date.toLocaleDateString();\n  }\n\n\n  // === Methods used when bound to a `ngeo.rule.Geometry`\n\n\n  /**\n   * Called when the active property of a rule changes. Only used when this\n   * component is bound to a geometry rule.\n   *\n   * Manage the activation/deactivation of the interactions.\n   *\n   * @param {boolean} active Whether the rule is active or not.\n   * @param {boolean} oldActive Whether the rule was active or not.\n   * @private\n   */\n  handleActiveChange_(active, oldActive) {\n\n    if (!(this.rule instanceof ngeoRuleGeometry) ||\n        !(this.clone instanceof ngeoRuleGeometry) ||\n        active === oldActive\n    ) {\n      return;\n    }\n\n    const keys = this.listenerKeys_;\n    const uid = ['ngeo-rule-', olBase.getUid(this)].join('-');\n    const toolMgr = this.ngeoToolActivateMgr_;\n\n    const ruleFeature = this.rule.feature;\n    const cloneFeature = this.clone.feature;\n\n    const mapDiv = this.map.getViewport();\n    googAsserts.assertElement(mapDiv);\n\n    if (active) {\n      keys.push(\n        olEvents.listen(\n          this.drawnFeatures,\n          'add',\n          this.handleFeaturesAdd_,\n          this\n        )\n      );\n\n      keys.push(\n        olEvents.listen(\n          mapDiv,\n          'contextmenu',\n          this.handleMapContextMenu_,\n          this\n        )\n      );\n\n      keys.push(\n        olEvents.listen(\n          this.translate_,\n          'translateend',\n          this.handleTranslateEnd_,\n          this\n        )\n      );\n\n      keys.push(\n        olEvents.listen(\n          this.rotate_,\n          'rotateend',\n          this.handleRotateEnd_,\n          this\n        )\n      );\n\n      this.featureOverlay.removeFeature(ruleFeature);\n      this.featureOverlay.addFeature(cloneFeature);\n\n      this.registerInteractions_();\n\n      toolMgr.registerTool(uid, this.drawToolActivate, false);\n      toolMgr.registerTool(uid, this.modifyToolActivate, true);\n      toolMgr.registerTool(uid, this.rotateToolActivate, false);\n      toolMgr.registerTool(uid, this.translateToolActivate, false);\n\n      this.modify_.setActive(true);\n\n      if (cloneFeature.getGeometry()) {\n        this.ngeoFeatureHelper_.setStyle(cloneFeature, true);\n      }\n\n    } else {\n      cloneFeature.setStyle(null);\n      keys.forEach(olEvents.unlistenByKey);\n      keys.length = 0;\n\n      this.drawActive = false;\n\n      toolMgr.unregisterTool(uid, this.drawToolActivate);\n      toolMgr.unregisterTool(uid, this.modifyToolActivate);\n      toolMgr.unregisterTool(uid, this.rotateToolActivate);\n      toolMgr.unregisterTool(uid, this.translateToolActivate);\n\n      this.modify_.setActive(false);\n\n      this.unregisterInteractions_();\n\n      if (this.selectedFeatures.getLength()) {\n        this.featureOverlay.removeFeature(cloneFeature);\n      }\n      this.featureOverlay.addFeature(ruleFeature);\n\n      this.selectedFeatures.clear();\n    }\n  }\n\n  /**\n   * Initialize interactions by setting them inactive and decorating them\n   * @private\n   */\n  initializeInteractions_() {\n    this.interactions_.forEach((interaction) => {\n      interaction.setActive(false);\n      ngeoMiscDecorate.interaction(interaction);\n    });\n  }\n\n  /**\n   * Register interactions by adding them to the map\n   * @private\n   */\n  registerInteractions_() {\n    this.interactions_.forEach((interaction) => {\n      this.map.addInteraction(interaction);\n    });\n  }\n\n  /**\n   * Register interactions by removing them to the map\n   * @private\n   */\n  unregisterInteractions_() {\n    this.interactions_.forEach((interaction) => {\n      this.map.removeInteraction(interaction);\n    });\n  }\n\n  /**\n   * @param {ol.Collection.Event} evt Event.\n   * @private\n   */\n  handleFeaturesAdd_(evt) {\n    // timeout to prevent double-click to zoom the map\n    this.timeout_(() => {\n\n      const clone = googAsserts.assertInstanceof(\n        this.clone, ngeoRuleGeometry);\n      const feature = clone.feature;\n\n      // (1) Apply geometry\n      const drawnFeature = googAsserts.assertInstanceof(\n        evt.element,\n        olFeature\n      );\n      const geometry = googAsserts.assertInstanceof(\n        drawnFeature.getGeometry(),\n        olGeomGeometry\n      );\n      clone.geometry = geometry;\n\n      // (2) Deactivate draw tools\n      this.drawActive = false;\n\n      // (3) Set properties, then style\n      const properties = this.ngeoFeatureHelper_.getNonSpatialProperties(\n        drawnFeature);\n      this.ngeoFeatureHelper_.clearNonSpatialProperties(feature);\n      feature.setProperties(properties);\n      this.ngeoFeatureHelper_.setStyle(feature, true);\n\n      this.scope_.$apply();\n    });\n  }\n\n  /**\n   * Return the type of geometry used by the rule feature. Used in the template.\n   * @return {string} Geometry type.\n   * @export\n   */\n  getRuleGeometryType() {\n    const rule = googAsserts.assertInstanceof(this.rule, ngeoRuleGeometry);\n    return this.ngeoFeatureHelper_.getType(rule.feature);\n  }\n\n  /**\n   * @param {Event} evt Event.\n   * @private\n   */\n  handleMapContextMenu_(evt) {\n\n    // (1) Remove previous menu, if any\n    this.removeMenu_();\n\n    // (2) Get feature at pixel\n    const pixel = this.map.getEventPixel(evt);\n    const coordinate = this.map.getCoordinateFromPixel(pixel);\n\n    let feature = this.map.forEachFeatureAtPixel(\n      pixel,\n      (feature) => {\n        let ret = false;\n        if (olArray.includes(this.selectedFeatures.getArray(), feature)) {\n          ret = feature;\n        }\n        return ret;\n      }\n    );\n\n    feature = feature ? feature : null;\n\n    // (3) If the clicked feature is the selected one, plus if it has a certain\n    //     type of geometry, then show the menu\n    const actions = [];\n    if (feature) {\n\n      const type = this.ngeoFeatureHelper_.getType(feature);\n      const  gettextCatalog = this.gettextCatalog_;\n\n      if (type == ngeoGeometryType.CIRCLE ||\n          type == ngeoGeometryType.LINE_STRING ||\n          type == ngeoGeometryType.POLYGON ||\n          type == ngeoGeometryType.RECTANGLE) {\n        actions.push({\n          cls: 'fa fa-arrows',\n          label: gettextCatalog.getString('Move'),\n          name: 'move'\n        });\n      }\n      if (type == ngeoGeometryType.LINE_STRING ||\n          type == ngeoGeometryType.POLYGON ||\n          type == ngeoGeometryType.RECTANGLE) {\n        actions.push({\n          cls: 'fa fa-rotate-right',\n          label: gettextCatalog.getString('Rotate'),\n          name: 'rotate'\n        });\n      }\n    }\n\n    if (actions.length) {\n      // (4) Create and show menu\n      this.menu_ = new ngeoMenu({\n        actions\n      });\n\n      olEvents.listen(\n        this.menu_,\n        'actionclick',\n        this.handleMenuActionClick_,\n        this\n      );\n      this.map.addOverlay(this.menu_);\n\n      this.menu_.open(coordinate);\n\n      evt.preventDefault();\n      evt.stopPropagation();\n\n      this.scope_.$apply();\n    }\n  }\n\n  /**\n   * Remove contextual menu, if any.\n   * @private\n   */\n  removeMenu_() {\n    if (this.menu_) {\n      olEvents.unlisten(\n        this.menu_,\n        'actionclick',\n        this.handleMenuActionClick_,\n        this\n      );\n      this.map.removeOverlay(this.menu_);\n      this.menu_ = null;\n    }\n  }\n\n  /**\n   * @param {ngeox.MenuEvent} evt Event.\n   * @private\n   */\n  handleMenuActionClick_(evt) {\n    const action = evt.detail.action;\n\n    switch (action) {\n      case 'move':\n        this.translate_.setActive(true);\n        this.scope_.$apply();\n        break;\n      case 'rotate':\n        this.rotate_.setActive(true);\n        this.scope_.$apply();\n        break;\n      default:\n        console.log(`FIXME - support: ${action}`);\n        break;\n    }\n  }\n\n  /**\n   * @param {ngeox.RotateEvent} evt Event.\n   * @private\n   */\n  handleRotateEnd_(evt) {\n    this.rotate_.setActive(false);\n    this.scope_.$apply();\n  }\n\n  /**\n   * @param {ol.interaction.Translate.Event} evt Event.\n   * @private\n   */\n  handleTranslateEnd_(evt) {\n    this.translate_.setActive(false);\n    this.scope_.$apply();\n  }\n\n};\n\n\n/**\n * The rule component is bound to a `ngeo.rule.Rule` object and shows UI\n * components to be able to edit its properties, such as: operator, expression,\n * etc. The actual properties depend on the type of rule.\n *\n * Also, changes are not made on-the-fly. A button must be clicked for the\n * changes to be applied to the rule.\n */\nexports.component('ngeoRule', {\n  bindings: {\n    'featureOverlay': '<',\n    'map': '<',\n    'rule': '<',\n    'toolGroup': '<'\n  },\n  controller: exports.RuleController_,\n  templateUrl: ngeoRuleTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module ngeo.filter.component\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\nimport ngeoFilterCondition from 'ngeo/filter/Condition.js';\n\n/** @suppress {extraRequire} */\nimport ngeoFilterRuleComponent from 'ngeo/filter/ruleComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoFilterRuleHelper from 'ngeo/filter/RuleHelper.js';\n\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\nimport ngeoRuleGeometry from 'ngeo/rule/Geometry.js';\nimport ngeoMapFeatureOverlay from 'ngeo/map/FeatureOverlay.js';\nimport * as olBase from 'ol/index.js';\nimport * as olArray from 'ol/array.js';\nimport 'font-awesome/css/font-awesome.css';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoFilter', [\n  ngeoFilterRuleHelper.module.name,\n  ngeoFilterRuleComponent.name,\n  ngeoMapFeatureOverlay.module.name,\n  ngeoQueryMapQuerent.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/filter', require('./component.html'));\n});\n\n\nexports.value('ngeoFilterTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['ngeoFilterTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/filter';\n  });\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} ngeoFilterTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoFilterTemplateUrl($attrs, ngeoFilterTemplateUrl) {\n  return ngeoFilterTemplateUrl($attrs);\n}\n\n\nexports.component('ngeoFilter', {\n  bindings: {\n    'aRuleIsActive': '=',\n    'customRules': '<',\n    // It's 'datasource' instead of 'dataSource', because that would require\n    // the attribute to be 'data-source', and Angular strips the 'data-'.\n    'datasource': '<',\n    'directedRules': '<',\n    'featureOverlay': '<',\n    'map': '<',\n    'toolGroup': '<'\n  },\n  controller: 'ngeoFilterController',\n  templateUrl: ngeoFilterTemplateUrl\n});\n\n/**\n * @private\n */\nexports.FilterController_ = class {\n\n  /**\n   * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n   * @param {!angular.Scope} $scope Angular scope.\n   * @param {!angular.$timeout} $timeout Angular timeout service.\n   * @param {!ngeo.query.MapQuerent} ngeoMapQuerent The ngeo map querent service.\n   * @param {!ngeo.filter.RuleHelper} ngeoRuleHelper Ngeo rule helper service.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname NgeoFilterController\n   */\n  constructor(gettextCatalog, $scope, $timeout, ngeoMapQuerent,\n    ngeoRuleHelper) {\n\n    // === Binding properties ===\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.aRuleIsActive;\n\n    /**\n     * @type {Array.<!ngeo.rule.Rule>}\n     * @export\n     */\n    this.customRules;\n\n    /**\n     * @type {!ngeo.datasource.OGC}\n     * @export\n     */\n    this.datasource;\n\n    /**\n     * @type {Array.<!ngeo.rule.Rule>}\n     * @export\n     */\n    this.directedRules;\n\n    /**\n     * @type {!ngeo.map.FeatureOverlay}\n     * @export\n     */\n    this.featureOverlay;\n\n    /**\n     * @type {!ol.Map}\n     * @export\n     */\n    this.map;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.toolGroup;\n\n\n    // === Injected properties ===\n\n    /**\n     * @type {!angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {!angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {!ngeo.query.MapQuerent}\n     * @private\n     */\n    this.ngeoMapQuerent_ = ngeoMapQuerent;\n\n    /**\n     * @type {!ngeo.filter.RuleHelper}\n     * @private\n     */\n    this.ngeoRuleHelper_ = ngeoRuleHelper;\n\n\n    // === Inner properties ===\n\n    /**\n     * @type {Array.<!ngeox.FilterCondition>}\n     * @export\n     */\n    this.conditions = [\n      {\n        text: gettextCatalog.getString('All'),\n        value: ngeoFilterCondition.AND\n      },\n      {\n        text: gettextCatalog.getString('At least one'),\n        value: ngeoFilterCondition.OR\n      },\n      {\n        text: gettextCatalog.getString('None'),\n        value: ngeoFilterCondition.NOT\n      }\n    ];\n\n    /**\n     * List of geometry attributes.\n     * @type {Array.<!ngeox.Attribute>}\n     * @export\n     */\n    this.geometryAttributes = [];\n\n    /**\n     * List of other attribute names.\n     * @type {Array.<!ngeox.Attribute>}\n     * @export\n     */\n    this.otherAttributes = [];\n\n    /**\n     * @type {!Object.<number, Function>}\n     * @private\n     */\n    this.ruleUnlisteners_ = {};\n  }\n\n\n  /**\n   * Called on initialization of the controller.\n   *\n   * Loop through the attributes of the data source and separated them in 2\n   * lists: geometry and the others. Then, apply the filters to the data source.\n   */\n  $onInit() {\n\n    this.scope_.$watch(\n      () => this.aRuleIsActive,\n      this.handleARuleIsActiveChange_.bind(this)\n    );\n\n    // (1) Separate the attributes in 2: geometry and the others.\n    const attributes = googAsserts.assert(this.datasource.attributes);\n    for (const attribute of attributes) {\n      if (attribute.type === ngeoFormatAttributeType.GEOMETRY) {\n        this.geometryAttributes.push(attribute);\n      } else {\n        this.otherAttributes.push(attribute);\n      }\n    }\n\n    // (2) All rules that have geometry are added in the featureOverlay\n    const rules = [].concat(this.customRules, this.directedRules);\n    for (const rule of rules) {\n      this.registerRule_(rule);\n    }\n\n    // (3) Apply the filters\n    this.apply();\n  }\n\n\n  /**\n   * Called on destruction of the controller.\n   *\n   * Reset the `filterRules` of the data source back to `null`.\n   * Clear the feature overlay.\n   */\n  $onDestroy() {\n    if (this.datasource.filterRules !== null) {\n      this.datasource.filterRules = null;\n    }\n    this.featureOverlay.clear();\n  }\n\n\n  /**\n   * @return {boolean} True if at least one rule is currently defined.\n   * @export\n   */\n  hasARule() {\n    return [].concat(this.customRules, this.directedRules).length > 0;\n  }\n\n\n  /**\n   * Loop in all directed and custom rules. Apply the rules that have a proper\n   * value inside the data source, in the `filterRules` property.\n   * @export\n   */\n  apply() {\n    // (1) Reset\n    this.datasource.filterRules = null;\n\n    // (2) Then set if there are filter rules with value.\n    this.timeout_(() => {\n      const filterRules = this.getRulesWithValue_();\n      if (filterRules.length) {\n        this.datasource.filterRules = filterRules;\n        // The current query results are cleared when we apply a filter.\n        this.ngeoMapQuerent_.clear();\n      }\n    });\n  }\n\n\n  /**\n   * Loop in all directed and custom rules. Issue a request to obtain the data\n   * and show the result.\n   * @export\n   */\n  getData() {\n    const filterRules = this.getRulesWithValue_();\n\n    // No need to do anything if there's no rules.\n    if (!filterRules.length) {\n      return;\n    }\n\n    const dataSource = this.datasource;\n    const limit = 1000;\n    const map = this.map;\n    const projCode = map.getView().getProjection().getCode();\n    const filter = this.ngeoRuleHelper_.createFilter({\n      dataSource: dataSource,\n      filterRules: filterRules,\n      srsName: projCode\n    });\n    googAsserts.assert(filter);\n\n    this.ngeoMapQuerent_.issue({\n      dataSources: [dataSource],\n      filter: filter,\n      limit: limit,\n      map: map\n    });\n  }\n\n\n  /**\n   * Loop in all directed and custom rules and collect those with a value.\n   * @return {Array.<!ngeo.rule.Rule>} Rules with value.\n   * @private\n   */\n  getRulesWithValue_() {\n    const filterRules = [];\n    const rules = [].concat(this.customRules, this.directedRules);\n    for (const rule of rules) {\n      if (rule.value) {\n        filterRules.push(rule);\n      }\n    }\n    return filterRules;\n  }\n\n\n  /**\n   * Create and add a new custom rule using an attribute. The rule is activated\n   * after being created.\n   * @param {!ngeox.Attribute} attribute Attribute to use to create the custom\n   * rule.\n   * @export\n   */\n  createAndAddCustomRule(attribute) {\n    const rule = this.ngeoRuleHelper_.createRuleFromAttribute(attribute, true);\n    this.registerRule_(rule);\n    this.customRules.push(rule);\n\n    // Activate asynchronously allows the toolActivate manager to do its magic,\n    this.timeout_(() => {\n      rule.active = true;\n    }, 1);\n  }\n\n\n  /**\n   * @param {!ngeox.FilterCondition} condition Condition to set.\n   * @export\n   */\n  setCondition(condition) {\n    if (this.datasource.filterCondition !== condition.value) {\n      this.datasource.filterCondition = condition.value;\n    }\n  }\n\n  /**\n   * Remove a custom rule. Deactivate it first, then give time to the\n   * `ngeo-rule` directive to manage the deactivation of the rule.\n   * @param {!ngeo.rule.Rule} rule Custom rule to remove.\n   * @export\n   */\n  removeCustomRule(rule) {\n    rule.active = false;\n    this.timeout_(() => {\n      olArray.remove(this.customRules, rule);\n      this.unregisterRule_(rule);\n      rule.destroy();\n    });\n  }\n\n  /**\n   * @param {!ngeo.rule.Rule} rule Rule.\n   * @export\n   */\n  registerRule_(rule) {\n    const uid = olBase.getUid(rule);\n    this.ruleUnlisteners_[uid] = this.scope_.$watch(\n      () => rule.active,\n      this.handleRuleActiveChange_.bind(this)\n    );\n\n    if (rule instanceof ngeoRuleGeometry) {\n      this.featureOverlay.addFeature(rule.feature);\n    }\n  }\n\n  /**\n   * @param {!ngeo.rule.Rule} rule Rule.\n   * @export\n   */\n  unregisterRule_(rule) {\n    const uid = olBase.getUid(rule);\n    const unlistener = this.ruleUnlisteners_[uid];\n    googAsserts.assert(unlistener);\n    unlistener();\n    delete this.ruleUnlisteners_[uid];\n\n    if (rule instanceof ngeoRuleGeometry) {\n      this.featureOverlay.removeFeature(rule.feature);\n    }\n  }\n\n  /**\n   * Called when the active property of a rule changes. Set the `aRuleIsActive`\n   * property accordingly.\n   * @private\n   */\n  handleRuleActiveChange_() {\n    let aRuleIsActive = false;\n    const rules = [].concat(this.customRules, this.directedRules);\n    for (const rule of rules) {\n      if (rule.active) {\n        aRuleIsActive = true;\n        break;\n      }\n    }\n    this.aRuleIsActive = aRuleIsActive;\n  }\n\n  /**\n   * Called when the `aRuleIsActive` property changes. Make sure that\n   * no rule is still active if the property is `false`.\n   * @private\n   */\n  handleARuleIsActiveChange_() {\n    if (this.aRuleIsActive) {\n      return;\n    }\n    const rules = [].concat(this.customRules, this.directedRules);\n    for (const rule of rules) {\n      if (rule.active) {\n        rule.active = false;\n        break;\n      }\n    }\n  }\n\n};\n\nexports.controller('ngeoFilterController', exports.FilterController_);\n\n\nexport default exports;\n","/**\n * @module gmf.filters.filterselectorComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfAuthenticationService from 'gmf/authentication/Service.js';\n\nimport gmfDatasourceDataSourceBeingFiltered from 'gmf/datasource/DataSourceBeingFiltered.js';\n\n/** @suppress {extraRequire} */\nimport gmfDatasourceHelper from 'gmf/datasource/Helper.js';\n\nimport gmfDatasourceOGC from 'gmf/datasource/OGC.js';\nimport gmfFiltersSavedFilters from 'gmf/filters/SavedFilters.js';\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessageModalComponent from 'ngeo/message/modalComponent.js';\n\nimport ngeoMessageNotification from 'ngeo/message/Notification.js';\nimport ngeoMessageMessage from 'ngeo/message/Message.js';\n\n/** @suppress {extraRequire} */\nimport ngeoFilterRuleHelper from 'ngeo/filter/RuleHelper.js';\n\nimport ngeoFilterComponent from 'ngeo/filter/component.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olArray from 'ol/array.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\nconst exports = angular.module('gmfFilterselector', [\n  gmfAuthenticationService.module.name,\n  gmfDatasourceDataSourceBeingFiltered.module.name,\n  gmfDatasourceHelper.module.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoMessageNotification.module.name,\n  ngeoMessageModalComponent.name,\n  ngeoFilterRuleHelper.module.name,\n  ngeoFilterComponent.name,\n  gmfFiltersSavedFilters.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/filters/filterselectorcomponent', require('./filterselectorcomponent.html'));\n});\n\nexports.value('gmfFilterselectorTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfFilterselectorTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/filters/filterselectorcomponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfFilterselectorTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfFilterselectorTemplateUrl($attrs, gmfFilterselectorTemplateUrl) {\n  return gmfFilterselectorTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!angular.Scope} $scope Angular scope.\n   * @param {!angular.$timeout} $timeout Angular timeout service.\n   * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n   * @param {gmfx.datasource.DataSourceBeingFiltered} gmfDataSourceBeingFiltered\n   *     The Gmf value service that determines the data source currently being\n   *     filtered.\n   * @param {gmf.datasource.Helper} gmfDataSourcesHelper Gmf data\n   *     sources helper service.\n   * @param {gmf.filters.SavedFilters} gmfSavedFilters Gmf saved filters service.\n   * @param {gmfx.User} gmfUser User.\n   * @param {ngeo.message.Notification} ngeoNotification Ngeo notification service.\n   * @param {!ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr Ngeo FeatureOverlay\n   *     manager\n   * @param {!ngeo.filter.RuleHelper} ngeoRuleHelper Ngeo rule helper service.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfFilterselectorController\n   */\n  constructor($scope, $timeout, gettextCatalog, gmfDataSourceBeingFiltered,\n    gmfDataSourcesHelper, gmfSavedFilters, gmfUser, ngeoNotification,\n    ngeoFeatureOverlayMgr, ngeoRuleHelper\n  ) {\n\n    // Binding properties\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.active;\n\n    $scope.$watch(\n      () => this.active,\n      this.handleActiveChange_.bind(this)\n    );\n\n    /**\n     * @type {!ol.Map}\n     * @export\n     */\n    this.map;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.toolGroup;\n\n\n    // Injected properties\n\n    /**\n     * @type {!angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * The data source that can either be selected from the list or have\n     * its value set from an external source (for example: the layertree)\n     * and that requires to be ready before it can be filtered.\n     * @type {gmfx.datasource.DataSourceBeingFiltered}\n     * @export\n     */\n    this.gmfDataSourceBeingFiltered = gmfDataSourceBeingFiltered;\n\n    $scope.$watch(\n      () => this.gmfDataSourceBeingFiltered.dataSource,\n      this.handleSelectedDataSourceChange_.bind(this)\n    );\n\n    /**\n     * @type {gmf.datasource.Helper}\n     * @private\n     */\n    this.gmfDataSourcesHelper_ = gmfDataSourcesHelper;\n\n    /**\n     * @type {gmf.filters.SavedFilters}\n     * @export\n     */\n    this.gmfSavedFilters = gmfSavedFilters;\n\n    // Close manage modal if the last item is removed.\n    $scope.$watchCollection(\n      () => this.gmfSavedFilters.currentDataSourceItems,\n      () => {\n        if (this.gmfSavedFilters.currentDataSourceItems.length === 0 &&\n           this.saveFilterManageModalShown) {\n          this.saveFilterManageModalShown = false;\n        }\n      }\n    );\n\n    /**\n     * @type {gmfx.User}\n     * @private\n     */\n    this.gmfUser_ = gmfUser;\n\n    $scope.$watch(\n      () => this.gmfUser_.functionalities,\n      this.handleGmfUserFunctionalitiesChange_.bind(this)\n    );\n\n    /**\n     * @type {ngeo.message.Notification}\n     * @private\n     */\n    this.ngeoNotification_ = ngeoNotification;\n\n    /**\n     * @type {!ngeo.map.FeatureOverlay}\n     * @export\n     */\n    this.featureOverlay = googAsserts.assert(\n      ngeoFeatureOverlayMgr.getFeatureOverlay()\n    );\n\n    /**\n     * @type {!ngeo.filter.RuleHelper}\n     * @private\n     */\n    this.ngeoRuleHelper_ = ngeoRuleHelper;\n\n\n    // Inner properties\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.aRuleIsActive = false;\n\n    /**\n     * @type {?Array.<!ngeo.rule.Rule>}\n     * @export\n     */\n    this.customRules = null;\n\n    /**\n     * @type {?Array.<!ngeo.rule.Rule>}\n     * @export\n     */\n    this.directedRules = null;\n\n    /**\n     * @type {Array.<gmf.datasource.OGC>}\n     * @export\n     */\n    this.filtrableDataSources = [];\n\n    /**\n     * @type {Array.<string>}\n     * @private\n     */\n    this.filtrableLayerNodeNames_ = null;\n\n    /**\n     * @type {gmfx.datasource.DataSources}\n     * @private\n     */\n    this.gmfDataSources_ = gmfDataSourcesHelper.collection;\n\n    /**\n     * @type {Array.<ol.EventsKey>}\n     * @private\n     */\n    this.listenerKeys_ = [];\n\n    /**\n     * The data source ready to be filtered, after it has been selected and\n     * prepared.\n     * @type {?gmf.datasource.OGC}\n     * @export\n     */\n    this.readyDataSource = null;\n\n    /**\n     * @type {!gmf.filters.filterselectorComponent.Controller_.RuleCache}\n     * @private\n     */\n    this.ruleCache_ = {};\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.saveFilterSaveModalShown = false;\n\n    // When the modal closes, reset name\n    $scope.$watch(\n      () => this.saveFilterSaveModalShown,\n      () => {\n        this.saveFilterName = '';\n      }\n    );\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.saveFilterName = '';\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.saveFilterManageModalShown = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.enableDataSourceRegistration_ = false;\n\n    $scope.$watch(\n      () => this.enableDataSourceRegistration_,\n      this.handleEnableDataSourceRegistrationChange_.bind(this)\n    );\n\n    /**\n     * The name of the data source that should be automatically selected\n     * by this component.\n     * @type {string|undefined}\n     * @private\n     */\n    this.defaultFiltrableDataSourceName_;\n\n    // Initialize the data sources registration\n    this.toggleDataSourceRegistration_();\n  }\n\n\n  /**\n   * @private\n   */\n  handleGmfUserFunctionalitiesChange_() {\n    const usrFunc = this.gmfUser_.functionalities;\n    if (usrFunc && usrFunc['filterable_layers']) {\n      this.filtrableLayerNodeNames_ = usrFunc['filterable_layers'];\n    } else {\n      this.filtrableLayerNodeNames_ = null;\n    }\n    if (usrFunc &&\n        usrFunc['preset_layer_filter'] &&\n        usrFunc['preset_layer_filter'][0]\n    ) {\n      this.defaultFiltrableDataSourceName_ = usrFunc['preset_layer_filter'][0];\n    } else {\n      this.defaultFiltrableDataSourceName_ = undefined;\n    }\n    this.toggleDataSourceRegistration_();\n  }\n\n\n  /**\n   * @private\n   */\n  toggleDataSourceRegistration_() {\n    const newDataSourceRegistration = !!this.filtrableLayerNodeNames_;\n    if (this.enableDataSourceRegistration_ !== newDataSourceRegistration) {\n      this.enableDataSourceRegistration_ = newDataSourceRegistration;\n    }\n  }\n\n\n  /**\n   * Called when the active property changes. Toggle data source registration.\n   * Also, when deactivated, deselect data source.\n   * @param {boolean} active Active.\n   * @private\n   */\n  handleActiveChange_(active) {\n    if (!active) {\n      this.aRuleIsActive = false;\n      this.timeout_(() => {\n        this.gmfDataSourceBeingFiltered.dataSource = null;\n      });\n    }\n  }\n\n\n  /**\n   * @param {boolean} register Whether register the data sources or not.\n   * @private\n   */\n  handleEnableDataSourceRegistrationChange_(register) {\n    const keys = this.listenerKeys_;\n\n    if (register) {\n      // Listen to data sources being added/removed\n      keys.push(\n        olEvents.listen(this.gmfDataSources_, 'add', this.handleDataSourcesAdd_, this),\n        olEvents.listen(this.gmfDataSources_, 'remove', this.handleDataSourcesRemove_, this)\n      );\n\n      // Manage the data sources that are already in the collection\n      this.gmfDataSources_.forEach(this.registerDataSource_.bind(this));\n\n    } else {\n      keys.forEach(olEvents.unlistenByKey);\n      keys.length = 0;\n\n      // Remove data sources that are in the collection\n      this.filtrableDataSources.length = 0;\n    }\n  }\n\n\n  /**\n   * Called when a data source is added to the collection of ngeo data sources.\n   * If the data source is 'valid', add it to the list of filtrable data\n   * sources.\n   *\n   * @param {ol.Collection.Event} evt Collection event.\n   * @private\n   */\n  handleDataSourcesAdd_(evt) {\n    const dataSource = evt.element;\n    if (dataSource instanceof gmfDatasourceOGC) {\n      this.registerDataSource_(dataSource);\n    }\n  }\n\n\n  /**\n   * Called when a data source is removed from the collection of ngeo data\n   * sources. If the data source is 'valid', remove it from the list of\n   * filtrable data sources.\n   *\n   * @param {ol.Collection.Event} evt Collection event.\n   * @private\n   */\n  handleDataSourcesRemove_(evt) {\n    const dataSource = evt.element;\n    if (dataSource instanceof gmfDatasourceOGC) {\n      this.unregisterDataSource_(dataSource);\n    }\n  }\n\n\n  /**\n   * Register a data source if filtrable.  If it's the first time that the\n   * data source is about to be registered, then the `filtrable` property\n   * is set. Otherwise, it's used.\n   *\n   * @param {gmf.datasource.OGC} dataSource Data source\n   * @private\n   */\n  registerDataSource_(dataSource) {\n    if (dataSource.filtrable === null) {\n      dataSource.filtrable = this.isDataSourceFiltrable_(dataSource);\n    }\n\n    if (dataSource.filtrable) {\n      this.filtrableDataSources.push(dataSource);\n\n      if (this.defaultFiltrableDataSourceName_ !== undefined &&\n          dataSource.name === this.defaultFiltrableDataSourceName_\n      ) {\n        this.gmfDataSourceBeingFiltered.dataSource = dataSource;\n      }\n    }\n  }\n\n\n  /**\n   * Unregister a data source if it's filtrable. Also, if it's the one\n   * that was currently selected, deselect it.\n   * @param {gmf.datasource.OGC} dataSource Data source\n   * @private\n   */\n  unregisterDataSource_(dataSource) {\n    if (dataSource.filtrable) {\n      olArray.remove(this.filtrableDataSources, dataSource);\n\n      if (this.gmfDataSourceBeingFiltered.dataSource === dataSource) {\n        this.gmfDataSourceBeingFiltered.dataSource = null;\n      }\n    }\n  }\n\n\n  /**\n   * Determines whether the data source is valid for addition (or removal) to\n   * the list of filtrable data sources or not.\n   *\n   * To be filtrable, the data source must:\n   *\n   *  1) have its name in the list of filtrable layer node names\n   *  2) support WFS\n   *  3) have only one ogcLayers defined\n   *  4) the ogcLayer must be queryable\n   *\n   * If 1) is true but not any of the others, then the server has not been\n   * configured properly. In this case, a warning notification can be shown.\n   *\n   * @param {gmf.datasource.OGC} dataSource GMF data source object\n   * @param {boolean=} opt_notify Whether to show a warning notification or not\n   *     in case of a data source that has its name is in the list of\n   *     filtrable layer node names but it doesn't match the other requirements.\n   *     Defaults to `true.`\n   * @return {boolean} Whether the data source is valid to add to the list or\n   *     not.\n   * @private\n   */\n  isDataSourceFiltrable_(dataSource, opt_notify) {\n    let filtrable = true;\n    const gettext = this.gettextCatalog_;\n    const notify = opt_notify !== false;\n    const names = googAsserts.assert(this.filtrableLayerNodeNames_);\n    const msgs = [];\n\n    // (1) The name of the DS must be in list of filtrable layer node names\n    if (olArray.includes(names, dataSource.name)) {\n\n      // (2) The DS must support WFS\n      if (!dataSource.supportsWFS) {\n        msgs.push(gettext.getString(\n          'The data source doesn\\'t support WFS, which is required ' +\n          'to fetch the attributes to build the filter rules.'\n        ));\n      }\n\n      // (3) The DS must have only one ogcLayer\n      if (!dataSource.ogcLayers || !dataSource.ogcLayers.length) {\n        msgs.push(gettext.getString(\n          'The data source must have only 1 ogcLayer defined.'\n        ));\n      } else if (!dataSource.ogcLayers[0].queryable) {\n        // (4) The ogcLayer must be queryable\n        msgs.push(gettext.getString(\n          'The ogcLayer within the data source must be queryable.'\n        ));\n      }\n\n      filtrable = !msgs.length;\n\n      // Notify if the name is in list of filtrable layer node names but\n      // there are missing requirements.\n      if (notify && !filtrable) {\n        const p1 = gettext.getString(\n          `The following data source is marked as being filtrable,\n          but is missing some requirements: `\n        );\n        const p2 = `${dataSource.name} (${dataSource.id}).`;\n        const p3 = gettext.getString(\n          `Please, contact your administrator about this.\n          Here are the reasons: `\n        );\n        msgs.unshift(`${p1} ${p2} ${p3}`);\n        console.warn(msgs.join(' '));\n        this.ngeoNotification_.notify({\n          msg: msgs.join(' '),\n          type: ngeoMessageMessage.Type.WARNING\n        });\n      }\n    } else {\n      filtrable = false;\n    }\n\n    return filtrable;\n  }\n\n  /**\n   * @param {?gmf.datasource.OGC} dataSource Newly selected data source\n   *     object.\n   * @private\n   */\n  handleSelectedDataSourceChange_(dataSource) {\n\n    this.aRuleIsActive = false;\n    this.customRules = null;\n    this.directedRules = null;\n    this.readyDataSource = null;\n    this.gmfSavedFilters.currentDataSourceId = null;\n\n    // No need to do anything if no data source is selected\n    if (!dataSource) {\n      return;\n    }\n\n    // A data source has been selected. Make sure the component is active.\n    if (!this.active) {\n      this.active = true;\n    }\n\n    this.gmfDataSourcesHelper_.prepareFiltrableDataSource(\n      dataSource\n    ).then((dataSource) => {\n\n      // Data source is ready. Get any existing rules or create new ones from\n      // the attributes\n      let item = this.getRuleCacheItem_(dataSource);\n      if (!item) {\n        item = {\n          customRules: [],\n          directedRules: []\n        };\n        this.setRuleCacheItem_(dataSource, item);\n        if (dataSource.gmfLayer.metadata &&\n            dataSource.gmfLayer.metadata.directedFilterAttributes &&\n            dataSource.gmfLayer.metadata.directedFilterAttributes.length\n        ) {\n          const directedAttributes =\n              dataSource.gmfLayer.metadata.directedFilterAttributes;\n          const attributes = googAsserts.assert(dataSource.attributes);\n          for (const attribute of attributes) {\n            if (olArray.includes(directedAttributes, attribute.name)) {\n              item.directedRules.push(\n                this.ngeoRuleHelper_.createRuleFromAttribute(attribute)\n              );\n            }\n          }\n        }\n      }\n\n      this.customRules = item.customRules;\n      this.directedRules = item.directedRules;\n      this.readyDataSource = dataSource;\n      this.gmfSavedFilters.currentDataSourceId = dataSource.id;\n\n    });\n  }\n\n  /**\n   * @param {ngeo.datasource.DataSource} dataSource Data source.\n   * @return {?gmf.filters.filterselectorComponent.Controller_.RuleCacheItem} Rule cache item.\n   * @private\n   */\n  getRuleCacheItem_(dataSource) {\n    return this.ruleCache_[dataSource.id] || null;\n  }\n\n  /**\n   * @param {ngeo.datasource.DataSource} dataSource Data source.\n   * @param {gmf.filters.filterselectorComponent.Controller_.RuleCacheItem} item Rule cache item.\n   * @private\n   */\n  setRuleCacheItem_(dataSource, item) {\n    this.ruleCache_[dataSource.id] = item;\n  }\n\n  /**\n   * @export\n   */\n  saveFilterShowModal() {\n    this.saveFilterSaveModalShown = true;\n  }\n\n  /**\n   * @export\n   */\n  saveFilterSave() {\n\n    const name = this.saveFilterName;\n    const dataSource = googAsserts.assert(this.readyDataSource);\n    const dataSourceId = dataSource.id;\n    const alreadyExist = (this.gmfSavedFilters.indexOfItem(\n      name, dataSourceId) !== -1);\n    const condition = dataSource.filterCondition;\n\n    const msg = this.gettextCatalog_.getString(\n      `A filter with the same name already exists.\n      Do you want to overwrite it?`\n    );\n    if (!alreadyExist || confirm(msg)) {\n      // (1) Serialize the existing custom and directed rules\n      const customRules = this.customRules ?\n        this.ngeoRuleHelper_.serializeRules(this.customRules) : [];\n      const directedRules = this.directedRules ?\n        this.ngeoRuleHelper_.serializeRules(this.directedRules) : [];\n\n      // (2) Ask the service to save it\n      const item = /** @type {!gmf.filters.SavedFilters.Item} */ ({\n        condition,\n        customRules,\n        dataSourceId,\n        directedRules,\n        name\n      });\n      this.gmfSavedFilters.save(item);\n\n      // (3) Close popup, which resets the name\n      this.saveFilterSaveModalShown = false;\n    }\n  }\n\n  /**\n   * Load a saved filter item, replacing the current rules.\n   * @param {!gmf.filters.SavedFilters.Item} filterItem Filter item.\n   * @export\n   */\n  saveFilterLoadItem(filterItem) {\n\n    const dataSource = googAsserts.assert(this.readyDataSource);\n\n    // (1) Reset current rules\n    this.customRules = null;\n    this.directedRules = null;\n\n    const customRules = this.ngeoRuleHelper_.createRules(\n      filterItem.customRules);\n    const directedRules = this.ngeoRuleHelper_.createRules(\n      filterItem.directedRules);\n\n    // Timeout, which ensures the destruction of the previous filter component\n    // and the creation of a new one\n    this.timeout_(() => {\n      // (2) Set rules\n      this.customRules = customRules;\n      this.directedRules = directedRules;\n\n      // (3) Set condition\n      dataSource.filterCondition = filterItem.condition;\n\n      // (4) Update cache item\n      const cacheItem = googAsserts.assert(this.getRuleCacheItem_(dataSource));\n      cacheItem.customRules = customRules;\n      cacheItem.directedRules = directedRules;\n    });\n  }\n\n  /**\n   * @export\n   */\n  saveFilterManage() {\n    this.saveFilterManageModalShown = true;\n  }\n\n  /**\n   * Remove a saved filter item.\n   * @param {!gmf.filters.SavedFilters.Item} item Filter item.\n   * @export\n   */\n  saveFilterRemoveItem(item) {\n    this.gmfSavedFilters.remove(item);\n  }\n\n};\n\n\n/**\n * @typedef {Object.<number, !gmf.filters.filterselectorComponent.Controller_.RuleCacheItem>}\n */\nexports.Controller_.RuleCache;\n\n\n/**\n * @typedef {{\n *     customRules: (Array.<ngeo.rule.Rule>),\n *     directedRules: (Array.<ngeo.rule.Rule>)\n * }}\n */\nexports.Controller_.RuleCacheItem;\n\n\nexports.component('gmfFilterselector', {\n  bindings: {\n    active: '=',\n    map: '<',\n    toolGroup: '<'\n  },\n  controller: exports.Controller_,\n  templateUrl: gmfFilterselectorTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module gmf.filters.module\n */\nimport gmfFiltersFilterselectorComponent from 'gmf/filters/filterselectorComponent.js';\nimport gmfFiltersSavedFilters from 'gmf/filters/SavedFilters.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfFiltersModule', [\n  gmfFiltersFilterselectorComponent.name,\n  gmfFiltersSavedFilters.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.layertree.timeSliderComponent\n */\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\n\nimport 'jquery-ui/ui/widgets/slider.js';\nimport 'angular-ui-slider';\nimport './timeslider.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfLayertreeTimeSliderComponent', [\n  ngeoMiscWMSTime.module.name,\n  'ui.slider',\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/layertree/timesliderComponent', require('./timesliderComponent.html'));\n});\n\n\n/**\n * Provide a directive to select a single date or a range of dates with a slider\n * Example:\n *\n *      <gmf-time-slider\n *          gmf-time-slider-time=\"{\n *            maxValue: '2013-12-31T00:00:00Z',\n *            minValue: '2006-01-01T00:00:00Z',\n *            mode: 'range'}\"\n *          gmf-time-slider-on-date-selected=\"ctrl.onDateSelected(time)\">\n *      </gmf-time-slider>\n *\n * @htmlAttribute {ngeox.TimeProperty} gmf-time-slider-time parameter for initialization.\n * @htmlAttribute {function()} gmf-time-slider-on-date-selected Expression evaluated after\n * date(s) changed\n * @param {angular.$timeout} $timeout angular timeout service\n * @param {angular.$filter} $filter angular filter service\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfTimeSlider\n */\nexports.directive_ = function($timeout, $filter) {\n  return {\n    scope: {\n      onDateSelected: '&gmfTimeSliderOnDateSelected',\n      time: '=gmfTimeSliderTime'\n    },\n    bindToController: true,\n    controller: 'gmfTimeSliderController as sliderCtrl',\n    restrict: 'AE',\n    templateUrl: 'gmf/layertree/timesliderComponent',\n    link: /** @type {!angular.LinkingFunctions} */ ({\n      pre: function preLink(scope, element, attrs, ctrl) {\n        ctrl.init();\n\n        ctrl.sliderOptions['stop'] = onSliderReleased_;\n        ctrl.sliderOptions['slide'] = computeDates_;\n\n        function onSliderReleased_(e, sliderUi) {\n          ctrl.onDateSelected({\n            time: computeDates_(e, sliderUi)\n          });\n          scope.$apply();\n        }\n\n        function computeDates_(e, sliderUi) {\n          let sDate, eDate, wmstime;\n          if (sliderUi.values) {\n            sDate = new Date(ctrl.getClosestValue_(sliderUi.values[0]));\n            eDate = new Date(ctrl.getClosestValue_(sliderUi.values[1]));\n            ctrl.dates = [sDate, eDate];\n            wmstime = {\n              start: sDate.getTime(),\n              end: eDate.getTime()\n            };\n          } else {\n            sDate = new Date(ctrl.getClosestValue_(sliderUi.value));\n            ctrl.dates = sDate;\n            wmstime = {\n              start: sDate.getTime()\n            };\n          }\n          scope.$apply();\n          return wmstime;\n        }\n      }\n    })\n  };\n};\n\n\nexports.directive('gmfTimeSlider', exports.directive_);\n\n\n/**\n * TimeSliderController - directive controller\n * @param {!angular.Scope} $scope Angular scope.\n * @param {ngeo.misc.WMSTime} ngeoWMSTime WMSTime service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname gmfTimeSliderController\n */\nexports.Controller_ = function($scope, ngeoWMSTime) {\n\n  /**\n   * @type {ngeo.misc.WMSTime}\n   * @private\n   */\n  this.ngeoWMSTime_ = ngeoWMSTime;\n\n  /**\n   * Function called after date(s) changed/selected\n   * @function\n   * @export\n   */\n  this.onDateSelected;\n\n\n  /**\n   * A time object for directive initialization\n   * @type {ngeox.TimeProperty}\n   * @export\n   */\n  this.time;\n\n  /**\n   * If the component is used to select a date range\n   * @type {boolean}\n   * @export\n   */\n  this.isModeRange;\n\n  /**\n   * Minimal value of the slider (time in ms)\n   * @type {number}\n   * @export\n   */\n  this.minValue;\n\n  /**\n   * Maximal value of the slider (time in ms)\n   * @type {number}\n   * @export\n   */\n  this.maxValue;\n\n  /**\n   * Used when WMS time object has a property 'values' instead of an interval\n   * @type (?Array<number>)\n   */\n  this.timeValueList;\n\n  /**\n   * Default Slider options (used by ui-slider directive)\n   * @type {{\n   *  range : boolean,\n   *  min : number,\n   *  max : number\n   * }}\n   * @export\n   */\n  this.sliderOptions;\n\n  /**\n   * Model for the ui-slider directive (date in ms format)\n   * @type {Array.<number>|number}\n   * @export\n   */\n  this.dates;\n};\n\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.init = function() {\n  this.timeValueList = this.getTimeValueList_();\n\n  // Fetch the initial options for the component\n  const initialOptions_ = this.ngeoWMSTime_.getOptions(this.time);\n  this.isModeRange = this.time.mode === 'range';\n  this.minValue = initialOptions_.minDate;\n  this.maxValue = initialOptions_.maxDate;\n  this.dates = this.isModeRange ? [initialOptions_.values[0], initialOptions_.values[1]] :\n    initialOptions_.values;\n  this.sliderOptions = {\n    range: this.isModeRange,\n    min: this.minValue,\n    max: this.maxValue\n  };\n};\n\n/**\n * TimeSliderController.prototype.getTimeValueList_ - Get a list of time value instead\n * of using the wmstime interval as a list of possibles values\n * @private\n * @return {Array<number>}  - List of timestamp representing possible values\n */\nexports.Controller_.prototype.getTimeValueList_ = function() {\n  const wmsTime = this.time;\n  let timeValueList = null;\n  const minDate = new Date(this.minValue);\n  const maxDate = new Date(this.maxValue);\n\n  if (wmsTime.values) {\n    timeValueList = [];\n    wmsTime.values.forEach((date) => {\n      timeValueList.push(new Date(date).getTime());\n    });\n  } else {\n    const maxNbValues = 1024;\n    const endDate = new Date(minDate.getTime());\n    endDate.setFullYear(minDate.getFullYear() + maxNbValues * wmsTime.interval[0]);\n    endDate.setMonth(minDate.getMonth() + maxNbValues * wmsTime.interval[1],\n      minDate.getDate() + maxNbValues * wmsTime.interval[2]);\n    endDate.setSeconds(minDate.getSeconds() + maxNbValues * wmsTime.interval[3]);\n\n    if (endDate > maxDate) {\n      // Transform interval to a list of values when the number\n      // of values is below a threshold (maxNbValues)\n      timeValueList = [];\n      for (let i = 0; ; i++) {\n        const nextDate = new Date(minDate.getTime());\n        nextDate.setFullYear(minDate.getFullYear() + i * wmsTime.interval[0]);\n        nextDate.setMonth(minDate.getMonth() + i * wmsTime.interval[1],\n          minDate.getDate() + i * wmsTime.interval[2]);\n        nextDate.setSeconds(minDate.getSeconds() + i * wmsTime.interval[3]);\n        if (nextDate <= maxDate) {\n          timeValueList.push(nextDate.getTime());\n        } else {\n          break;\n        }\n      }\n    }\n  }\n  return timeValueList;\n};\n\n\n/**\n * Compute the closest available date from the given timestamp\n * @param  {number} timestamp selected datetime (in ms format)\n * @return {number} the closest available datetime (in ms format) from the timestamp\n * @private\n */\nexports.Controller_.prototype.getClosestValue_ = function(timestamp) {\n  if (timestamp <= this.minValue) {\n    return this.minValue;\n  }\n\n  if (timestamp >= this.maxValue) {\n    return this.maxValue;\n  }\n\n  if (this.timeValueList) {\n    // Time stops are defined as a list of values\n    let index;\n    let leftIndex = 0;\n    let rightIndex = this.timeValueList.length - 1;\n\n    while ((rightIndex - leftIndex) > 1) {\n      index = Math.floor((leftIndex + rightIndex) / 2);\n      if (this.timeValueList[index] >= timestamp) {\n        rightIndex = index;\n      } else {\n        leftIndex = index;\n      }\n    }\n\n    const leftDistance = Math.abs(this.timeValueList[leftIndex] - timestamp);\n    const rightDistance = Math.abs(this.timeValueList[rightIndex] - timestamp);\n\n    return this.timeValueList[leftDistance < rightDistance ? leftIndex : rightIndex];\n  } else {\n    // Time stops are defined by a start date plus an interval\n    const targetDate = new Date(timestamp);\n    const startDate = new Date(this.minValue);\n    let bestDate = new Date(this.minValue);\n    const maxDate = new Date(this.maxValue);\n    let bestDistance = Math.abs(targetDate - bestDate);\n\n    for (let i = 1; ; i++) {\n      // The start date should always be used as a reference\n      // because adding a month twice could differ from adding\n      // two months at once\n      const next = new Date(startDate.getTime());\n      next.setFullYear(startDate.getFullYear() + i * this.time.interval[0]);\n      next.setMonth(startDate.getMonth() + i *  this.time.interval[1],\n        startDate.getDate() + i * this.time.interval[2]);\n      next.setSeconds(startDate.getSeconds() + i * this.time.interval[3]);\n\n      if (next > maxDate) {\n        break;\n      }\n\n      const distance = Math.abs(targetDate - next);\n      if (distance <= bestDistance) {\n        bestDate = next;\n        bestDistance = distance;\n      } else {\n        break;\n      }\n    }\n\n    return bestDate.getTime();\n  }\n};\n\n\n/**\n * Format and localize time regarding a resolution.\n * @param {number} time (in ms format) timestamp to format and localize.\n * @return {string} Localized date string regarding the resolution.\n * @export\n */\nexports.Controller_.prototype.getLocalizedDate = function(time) {\n  return this.ngeoWMSTime_.formatTimeValue(time, this.time.resolution);\n};\n\n\nexports.controller('gmfTimeSliderController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.layertree.module\n */\nimport gmfLayertreeComponent from 'gmf/layertree/component.js';\nimport gmfLayertreeDatasourceGroupTreeComponent from 'gmf/layertree/datasourceGroupTreeComponent.js';\nimport gmfLayertreeSyncLayertreeMap from 'gmf/layertree/SyncLayertreeMap.js';\nimport gmfLayertreeTimeSliderComponent from 'gmf/layertree/timeSliderComponent.js';\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\n\nimport './common.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfLayertreeModule', [\n  gmfLayertreeComponent.name,\n  gmfLayertreeDatasourceGroupTreeComponent.name,\n  gmfLayertreeSyncLayertreeMap.module.name,\n  gmfLayertreeTimeSliderComponent.name,\n  gmfLayertreeTreeManager.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.permalink.module\n */\nimport gmfPermalinkPermalink from 'gmf/permalink/Permalink.js';\nimport gmfPermalinkShareService from 'gmf/permalink/ShareService.js';\nimport gmfPermalinkShareComponent from 'gmf/permalink/shareComponent.js';\n\nimport './share.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfPermalinkModule', [\n  gmfPermalinkPermalink.module.name,\n  gmfPermalinkShareService.module.name,\n  gmfPermalinkShareComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.component\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olEvents from 'ol/events.js';\nimport olMap from 'ol/Map.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMap', []);\n\n\n/**\n * Provides a directive used to insert a user-defined OpenLayers\n * map in the DOM. The directive does not create an isolate scope.\n *\n * Examples:\n *\n *   Simple:\n *\n *      <div ngeo-map=\"ctrl.map\"></div>\n *\n *   Manage window resizing:\n *\n *      <div\n *        ngeo-map=\"ctrl.map\"\n *        ngeo-map-manage-resize=\"ctrl.manageResize\"\n *        ngeo-map-resize-transition=\"ctrl.resizeTransition\">\n *      </div>\n *\n * See our live examples:\n * [../examples/permalink.html](../examples/permalink.html)\n * [../examples/simple.html](../examples/simple.html)\n *\n * @htmlAttribute {ol.Map} ngeo-map The map.\n * @param {angular.$window} $window The Angular $window service.\n * @return {angular.Directive} Directive Definition Object.\n * @ngdoc directive\n * @ngname ngeoMap\n * @ngInject\n */\nexports.directive_ = function($window) {\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n      // Get the 'ol.Map' object from attributes and manage it accordingly\n      const attr = 'ngeoMap';\n      const prop = attrs[attr];\n\n      const map = scope.$eval(prop);\n      googAsserts.assertInstanceof(map, olMap);\n\n      map.setTarget(element[0]);\n\n      // Get the 'window resize' attributes, which are optional. If defined,\n      // the browser window 'resize' event is listened to update the size of\n      // the map when fired. A transition option is also available to let any\n      // animation that may occur on the div of the map to smootly resize the\n      // map while in progress.\n      const manageResizeAttr = 'ngeoMapManageResize';\n      const manageResizeProp = attrs[manageResizeAttr];\n      const manageResize = scope.$eval(manageResizeProp);\n\n      if (manageResize) {\n        const resizeTransitionAttr = 'ngeoMapResizeTransition';\n        const resizeTransitionProp = attrs[resizeTransitionAttr];\n\n        const resizeTransition = /** @type {number|undefined} */ (\n          scope.$eval(resizeTransitionProp));\n\n        olEvents.listen(\n          $window,\n          'resize',\n          () => {\n            if (resizeTransition) {\n              // Resize with transition\n              const start = Date.now();\n              let loop = true;\n              const adjustSize = function() {\n                map.updateSize();\n                map.renderSync();\n                if (loop) {\n                  $window.requestAnimationFrame(adjustSize);\n                }\n                if (Date.now() - start > resizeTransition) {\n                  loop = false;\n                }\n              };\n              adjustSize();\n            } else {\n              // A single plain resize\n              map.updateSize();\n            }\n          }\n        );\n      }\n    }\n  };\n};\n\n// Register the directive in the module\nexports.directive('ngeoMap', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.scaleselector\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olArray from 'ol/array.js';\nimport olMap from 'ol/Map.js';\nimport * as olEvents from 'ol/events.js';\nimport 'bootstrap/js/dropdown.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoScaleselector', []);\n\n\nexports.value('ngeoScaleselectorTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoScaleselectorTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/map/scaleselector';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/map/scaleselector', require('./scaleselector.html'));\n});\n\n\n/**\n * Provides the \"ngeoScaleselector\" directive, a widget for\n * selecting map scales.\n *\n * Example:\n *\n *     <div ngeo-scaleselector=\"ctrl.scales\" ngeo-scaleselector-map=\"ctrl.map\">\n *     </div>\n *\n * The expression passed to the ngeo-scaleselector attribute should return an\n * array of this form:\n *\n *    [20000, 10000, 5000, 2500]\n *\n * That directive's partial uses Bootstrap's `dropdown` and `dropdown-menu`\n * classes, and `data-toggle=\"dropdown\"`, so it is meant to be used with\n * Bootstrap's \"dropdown\" jQuery plugin.\n *\n * You can pass options to configure the behaviors of this element. Options is\n * a {@link ngeox.ScaleselectorOptions} object.\n *\n * Example:\n *\n *     <div ngeo-scaleselector=\"ctrl.scales\"\n *       ngeo-scaleselector-map=\"ctrl.map\"\n *       ngeo-scaleselector-options=\"ctrl.scaleSelectorOptions\">\n *     </div>\n *\n * By default the directive uses \"scaleselector.html\" as its templateUrl. This\n * can be changed by redefining the \"ngeoScaleselectorTemplateUrl\" value.\n *\n * The directive has its own scope, but it is not isolate scope. That scope\n * includes a reference to the directive's controller: the \"scaleselectorCtrl\"\n * scope property.\n *\n * The directive doesn't create any watcher. In particular the object including\n * the scales information is now watched.\n *\n * See our live example: [../examples/scaleselector.html](../examples/scaleselector.html)\n *\n * @htmlAttribute {!Array.<number>} ngeo-scaleselector The available scales.\n * @htmlAttribute {ol.Map} ngeo-scaleselector-map The map.\n * @htmlAttribute {ngeox.ScaleselectorOptions} ngeo-scaleselector-options\n *     Optional. The configuration options.\n * @param {string|function(!angular.JQLite=, !angular.Attributes=)}\n *     ngeoScaleselectorTemplateUrl Template URL for the directive.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoScaleselector\n */\nconst directive = function(ngeoScaleselectorTemplateUrl) {\n  return {\n    restrict: 'A',\n    scope: true,\n    controller: 'NgeoScaleselectorController',\n    templateUrl: ngeoScaleselectorTemplateUrl\n  };\n};\n\n\nexports.directive('ngeoScaleselector', directive);\n\n\n/**\n * @constructor\n * @private\n * @struct\n * @param {angular.Scope} $scope Directive scope.\n * @param {angular.JQLite} $element Element.\n * @param {angular.Attributes} $attrs Attributes.\n * @ngInject\n * @ngdoc controller\n * @ngname NgeoScaleselectorController\n */\nconst ScaleselectorController = function($scope, $element, $attrs) {\n\n  const scalesExpr = $attrs['ngeoScaleselector'];\n\n  /**\n   * The zoom level/scale map object.\n   * @type {!Array.<number>}\n   * @export\n   */\n  this.scales = /** @type {!Array.<number>} */\n    ($scope.$eval(scalesExpr));\n  googAsserts.assert(this.scales !== undefined);\n\n  /**\n   * @type {Array.<number>}\n   * @export\n   */\n  this.zoomLevels;\n\n  $scope.$watch(() => Object.keys(this.scales).length, (newLength) => {\n    this.zoomLevels = Object.keys(this.scales).map(Number);\n    this.zoomLevels.sort(olArray.numberSafeCompareFunction);\n  });\n\n  const mapExpr = $attrs['ngeoScaleselectorMap'];\n\n  /**\n   * @type {ol.Map}\n   * @private\n   */\n  this.map_ = /** @type {ol.Map} */ ($scope.$eval(mapExpr));\n  googAsserts.assertInstanceof(this.map_, olMap);\n\n  const optionsExpr = $attrs['ngeoScaleselectorOptions'];\n  const options = $scope.$eval(optionsExpr);\n\n  /**\n   * @type {!ngeox.ScaleselectorOptions}\n   * @export\n   */\n  this.options = ScaleselectorController.getOptions_(options);\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.$scope_ = $scope;\n\n  /**\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.resolutionChangeKey_ = null;\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.currentScale = undefined;\n\n  const view = this.map_.getView();\n  if (view !== null) {\n    const currentZoom = this.map_.getView().getZoom();\n    if (currentZoom !== undefined) {\n      this.currentScale = this.getScale(currentZoom);\n    }\n  }\n\n  olEvents.listen(this.map_, 'change:view', this.handleViewChange_, this);\n\n  this.registerResolutionChangeListener_();\n\n  $scope['scaleselectorCtrl'] = this;\n\n};\n\n\n/**\n * @param {?} options Options after expression evaluation.\n * @return {!ngeox.ScaleselectorOptions} Options object.\n * @private\n */\nScaleselectorController.getOptions_ = function(options) {\n  let dropup = false;\n  if (options !== undefined) {\n    dropup = options['dropup'] == true;\n  }\n  return /** @type {ngeox.ScaleselectorOptions} */ ({\n    dropup: dropup\n  });\n};\n\n\n/**\n * @param {number} zoom Zoom level.\n * @return {number} Scale.\n * @export\n */\nScaleselectorController.prototype.getScale = function(zoom) {\n  return this.scales[zoom];\n};\n\n\n/**\n * @param {number} zoom Zoom level.\n * @export\n */\nScaleselectorController.prototype.changeZoom = function(zoom) {\n  this.map_.getView().setZoom(zoom);\n};\n\n\n/**\n * @param {ol.Object.Event} e OpenLayers object event.\n * @private\n */\nScaleselectorController.prototype.handleResolutionChange_ = function(e) {\n  const view = this.map_.getView();\n  const currentScale = this.scales[/** @type {number} */ (view.getZoom())];\n\n  // handleResolutionChange_ is a change:resolution listener. The listener\n  // may be executed outside the Angular context, for example when the user\n  // double-clicks to zoom on the map.\n  //\n  // But it may also be executed inside the Angular context, when a function\n  // in Angular context calls setZoom or setResolution on the view, which\n  // is for example what happens when this controller's changeZoom function\n  // is called.\n  //\n  // For that reason we use $applyAsync instead of $apply here.\n\n  if (currentScale !== undefined) {\n    this.$scope_.$applyAsync(() => {\n      this.currentScale = currentScale;\n    });\n  }\n};\n\n\n/**\n * @param {ol.Object.Event} e OpenLayers object event.\n * @private\n */\nScaleselectorController.prototype.handleViewChange_ = function(e) {\n  this.registerResolutionChangeListener_();\n  this.handleResolutionChange_(null);\n};\n\n\n/**\n * @private\n */\nScaleselectorController.prototype.registerResolutionChangeListener_ = function() {\n  if (this.resolutionChangeKey_ !== null) {\n    olEvents.unlistenByKey(this.resolutionChangeKey_);\n  }\n  const view = this.map_.getView();\n  this.resolutionChangeKey_ = olEvents.listen(view,\n    'change:resolution', this.handleResolutionChange_,\n    this);\n};\n\n\nexports.controller('NgeoScaleselectorController', ScaleselectorController);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.module\n */\nimport ngeoMapBackgroundLayerMgr from 'ngeo/map/BackgroundLayerMgr.js';\nimport ngeoMapComponent from 'ngeo/map/component.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMapRecenter from 'ngeo/map/recenter.js';\nimport ngeoMapResizemap from 'ngeo/map/resizemap.js';\nimport ngeoMapScaleselector from 'ngeo/map/scaleselector.js';\n\n/**\n * Also related to the map but not included in the module:\n *  - ngeo.map.FeatureOverlay (already required by ngeo.map.FeatureOverlayMgr)\n *\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMapModule', [\n  ngeoMapBackgroundLayerMgr.module.name,\n  ngeoMapComponent.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoMapRecenter.name,\n  ngeoMapResizemap.name,\n  ngeoMapScaleselector.name\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.map.component\n */\nimport gmfPermalinkModule from 'gmf/permalink/module.js';\nimport gmfEditingSnapping from 'gmf/editing/Snapping.js';\nimport ngeoMapModule from 'ngeo/map/module.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfMapComponent', [\n  gmfPermalinkModule.name,\n  gmfEditingSnapping.module.name,\n  ngeoMapModule.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/map', require('./component.html'));\n});\n\n\n/**\n * A \"map\" directive for a GeoMapFish application.\n *\n * Example:\n *\n *      <gmf-map gmf-map-map=\"mainCtrl.map\"></gmf-map>\n *\n * @htmlAttribute {ol.Map} gmf-map-map The map.\n * @htmlAttribute {boolean|undefined} gmf-map-manage-resize Whether to update\n *     the size of the map on browser window resize.\n * @htmlAttribute {boolean|undefined} gmf-map-resize-transition The duration\n *     (milliseconds) of the animation that may occur on the div containing\n *     the map. Used to smoothly resize the map while the animation is in\n *     progress.\n * @return {angular.Directive} The Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfMap\n */\nexports.directive_ = function() {\n  return {\n    scope: {\n      'map': '<gmfMapMap',\n      'manageResize': '<gmfMapManageResize',\n      'resizeTransition': '<gmfMapResizeTransition'\n    },\n    controller: 'GmfMapController as ctrl',\n    bindToController: true,\n    templateUrl: 'gmf/map'\n  };\n};\n\nexports.directive('gmfMap', exports.directive_);\n\n\n/**\n * @param {!ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr The ngeo feature\n * @param {!gmf.permalink.Permalink} gmfPermalink The gmf permalink service.\n * @param {!gmf.editing.Snapping} gmfSnapping The gmf snapping service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfMapController\n */\nexports.Controller_ = function(ngeoFeatureOverlayMgr, gmfPermalink, gmfSnapping) {\n\n  // Scope properties\n\n  /**\n   * @type {!ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {boolean|undefined}\n   * @export\n   */\n  this.manageResize;\n\n  /**\n   * @type {boolean|undefined}\n   * @export\n   */\n  this.resizeTransition;\n\n\n  // Injected properties\n\n  /**\n   * @type {!ngeo.map.FeatureOverlayMgr}\n   * @private\n   */\n  this.ngeoFeatureOverlayMgr_ = ngeoFeatureOverlayMgr;\n\n  /**\n   * @type {!gmf.permalink.Permalink}\n   * @private\n   */\n  this.gmfPermalink_ = gmfPermalink;\n\n  /**\n   * @type {!gmf.editing.Snapping}\n   * @private\n   */\n  this.gmfSnapping_ = gmfSnapping;\n};\n\n\n/**\n * Called on initialization of the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.ngeoFeatureOverlayMgr_.init(this.map);\n  this.gmfPermalink_.setMap(this.map);\n  this.gmfSnapping_.setMap(this.map);\n};\n\n\nexports.controller('GmfMapController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.map.mousepositionComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport olControlMousePosition from 'ol/control/MousePosition.js';\nimport * as olProj from 'ol/proj.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfMapMouseposition', [\n  ngeoMiscFilters.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/map/mousepositionComponent', require('./mousepositionComponent.html'));\n});\n\n\nexports.value('gmfMapMousepositionTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfMapMousepositionTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/map/mousepositionComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfMapMousepositionTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfMapMousepositionTemplateUrl($attrs, gmfMapMousepositionTemplateUrl) {\n  return gmfMapMousepositionTemplateUrl($attrs);\n}\n\n/**\n * Provide a component to display the mouse position coordinates depending\n * on the chosen projection. The component also provides a projection picker\n * to choose how the coordinates are displayed.\n * service.\n *\n * Example:\n *  <gmf-mouseposition gmf-mouseposition-map=\"ctrl.map\"\n *     gmf-mouseposition-projections=\"ctrl.projections\">\n *  </gmf-mouseposition>\n *\n * @htmlAttribute {ol.Map} gmf-mouseposition-map The map.\n * @htmlAttribute {Array.<gmfx.MousePositionProjection>}\n *    gmf-mouseposition-projection The list of the projections.\n *\n * @ngdoc component\n * @ngname gmfMouseposition\n */\nexports.component_ = {\n  controller: 'gmfMousepositionController as ctrl',\n  bindings: {\n    'map': '<gmfMousepositionMap',\n    'projections': '<gmfMousepositionProjections'\n  },\n  templateUrl: gmfMapMousepositionTemplateUrl\n};\n\nexports.component('gmfMouseposition',\n  exports.component_);\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.$filter} $filter Angular filter.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname gmfMousepositionController\n */\nexports.Controller_ = function($element, $filter, $scope, gettextCatalog) {\n  /**\n   * @type {!ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {!Array.<!gmfx.MousePositionProjection>}\n   * @export\n   */\n  this.projections;\n\n  /**\n   * @type {!gmfx.MousePositionProjection}\n   * @export\n   */\n  this.projection;\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.$scope_ = $scope;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.$element_ = $element;\n\n  /**\n   * @type {angular.$filter}\n   * @private\n   */\n  this.$filter_ = $filter;\n\n  /**\n   * @type  {?ol.control.MousePosition}\n   * @private\n   */\n  this.control_ = null;\n};\n\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.$scope_.$on('gettextLanguageChanged', () => {\n    this.initOlControl_();\n  });\n\n  // Init control once, in case of applications that never set the language.\n  this.initOlControl_();\n};\n\n\n/**\n * Init the ol.control.MousePosition\n * @private\n */\nexports.Controller_.prototype.initOlControl_ = function() {\n  if (this.control_ !== null) {\n    this.map.removeControl(this.control_);\n  }\n\n  // function that apply the filter.\n  const formatFn = function(coordinates) {\n    const filterAndArgs = this.projection.filter.split(':');\n    const filter = this.$filter_(filterAndArgs.shift());\n    googAsserts.assertFunction(filter);\n    const args = filterAndArgs;\n    args.unshift(coordinates);\n    return filter.apply(this, args);\n  };\n\n  const gettextCatalog = this.gettextCatalog_;\n  this.control_ = new olControlMousePosition({\n    className: 'gmf-mouseposition-control',\n    coordinateFormat: formatFn.bind(this),\n    target: angular.element('.gmf-mouseposition-control-target', this.$element_)[0],\n    undefinedHTML: gettextCatalog.getString('Coordinates')\n  });\n\n  this.setProjection(this.projections[0]);\n\n  this.map.addControl(this.control_);\n};\n\n\n/**\n * @param {gmfx.MousePositionProjection} projection The new projection to use.\n * @export\n */\nexports.Controller_.prototype.setProjection = function(projection) {\n  this.control_.setProjection(olProj.get(projection.code));\n  this.projection = projection;\n};\n\nexports.controller('gmfMousepositionController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.map.module\n */\nimport gmfMapComponent from 'gmf/map/component.js';\nimport gmfMapMousepositionComponent from 'gmf/map/mousepositionComponent.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfMapModule', [\n  gmfMapComponent.name,\n  gmfMapMousepositionComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.grid.Config\n */\nimport * as olBase from 'ol/index.js';\n\n/**\n * @param {Array.<Object>|undefined} data Entries/objects to be shown in a grid.\n * @param {Array.<ngeox.GridColumnDef>|undefined} columnDefs Column definition of a grid.\n * @constructor\n * @struct\n * @export\n */\nconst exports = function(data, columnDefs) {\n  /**\n   * @type {Array.<Object>|undefined}\n   * @export\n   */\n  this.data = data;\n\n  /**\n   * @type {Array.<ngeox.GridColumnDef>|undefined}\n   * @export\n   */\n  this.columnDefs = columnDefs;\n\n  /**\n   * @type {!Object.<string, Object>}\n   * @export\n   */\n  this.selectedRows = {};\n};\n\n\n/**\n * Get an ID for a row.\n * @param {Object} attributes An entry/row.\n * @return {string} Unique id for this object.\n * @export\n */\nexports.getRowUid = function(attributes) {\n  return `${olBase.getUid(attributes)}`;\n};\n\n\n/**\n * Is the given row selected?\n * @param {Object} attributes An entry/row.\n * @return {boolean} True if already selected. False otherwise.\n * @export\n */\nexports.prototype.isRowSelected = function(attributes) {\n  return !!this.selectedRows[exports.getRowUid(attributes)];\n};\n\n\n/**\n * Returns the number of selected rows.\n * @return {number} Number of selected rows.\n * @export\n */\nexports.prototype.getSelectedCount = function() {\n  return Object.keys(this.selectedRows).length;\n};\n\n\n/**\n * Returns the selected rows.\n * @return {Array.<Object>} Selected rows in the current ordering.\n * @export\n */\nexports.prototype.getSelectedRows = function() {\n  return this.data.filter(row => this.isRowSelected(row));\n};\n\n\n/**\n * @param {Object} attributes An entry/row.\n * @public\n */\nexports.prototype.selectRow = function(attributes) {\n  const uid = exports.getRowUid(attributes);\n  this.selectedRows[uid] = attributes;\n};\n\n\n/**\n * @param {Object} attributes An entry/row.\n * @public\n */\nexports.prototype.toggleRow = function(attributes) {\n  const uid = exports.getRowUid(attributes);\n  const isSelected = this.isRowSelected(attributes);\n  if (isSelected) {\n    delete this.selectedRows[uid];\n  } else {\n    this.selectedRows[uid] = attributes;\n  }\n};\n\n\n/**\n * Select all rows.\n * @export\n */\nexports.prototype.selectAll = function() {\n  this.data.forEach((attributes) => {\n    this.selectRow(attributes);\n  });\n};\n\n\n/**\n * Deselect all rows.\n * @export\n */\nexports.prototype.unselectAll = function() {\n  for (const rowId in this.selectedRows) {\n    delete this.selectedRows[rowId];\n  }\n};\n\n\n/**\n * Invert selection.\n * @export\n */\nexports.prototype.invertSelection = function() {\n  this.data.forEach((attributes) => {\n    this.toggleRow(attributes);\n  });\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoGridConfig', []);\n\n\nexport default exports;\n","/**\n * @module ngeo.grid.component\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport ngeoGridConfig from 'ngeo/grid/Config.js';\nimport * as olHas from 'ol/has.js';\n\nimport 'floatthead';\nimport 'angular-float-thead';\nimport 'font-awesome/css/font-awesome.css';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoGrid', [\n  ngeoGridConfig.module.name,\n  ngeoMiscFilters.name,\n  'floatThead',\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/grid', require('./component.html'));\n});\n\n\nexports.value('ngeoGridTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template URL.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['ngeoGridTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/grid';\n  }\n);\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} ngeoGridTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoGridTemplateUrl($attrs, ngeoGridTemplateUrl) {\n  return ngeoGridTemplateUrl($attrs);\n}\n\n\n/**\n * A grid component for displaying tabular data. The columns of the grid\n * are sortable, rows can be selected with a single click (also in combination\n * with SHIFT and CTRL/Meta).\n *\n * Example:\n *\n *     <ngeo-grid\n *       ngeo-grid-configuration=\"::ctrl.gridConfiguration\"\n *     </ngeo-grid>\n *\n * @htmlAttribute {ngeo.grid.Config} ngeo-grid-configuration The\n * configuration to use.\n *\n * @ngdoc component\n * @ngname ngeoGrid\n */\nexports.component_ = {\n  controller: 'ngeoGridController as ctrl',\n  bindings: {\n    'configuration': '=ngeoGridConfiguration'\n  },\n  templateUrl: ngeoGridTemplateUrl\n};\n\nexports.component('ngeoGrid', exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoGridController\n */\nexports.Controller_ = function($scope) {\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {ngeo.grid.Config}\n   * @export\n   */\n  this.configuration;\n\n  /**\n   * @type {Object.<string, Object>}\n   * @export\n   */\n  this.selectedRows;\n\n  /**\n   * The name of the column used to sort the grid.\n   * @type {string}\n   * @export\n   */\n  this.sortedBy;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.sortAscending = true;\n\n  /**\n   * Configuration object for float-thead.\n   * @type {Object}\n   * @export\n   */\n  this.floatTheadConfig = {\n    'scrollContainer': function($table) {\n      return $table.closest('.ngeo-grid-table-container');\n    }\n  };\n};\n\n\n/**\n * Init the controller\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.selectedRows = this.configuration.selectedRows;\n};\n\n\n/**\n * Sort function that always puts undefined values to the bottom of the grid.\n * A new call will sort ascending. A next one will sort descending (and so\n * on).\n * @param {string} columnName The name of the column that should be used to\n *    sort the data.\n * @export\n */\nexports.Controller_.prototype.sort = function(columnName) {\n  this.sortAscending = this.sortedBy === columnName ? !this.sortAscending : true;\n  this.sortedBy = columnName;\n\n  const asc = this.sortAscending ? 1 : -1;\n  this.configuration.data.sort((attributes1, attributes2) => {\n    if (!attributes1[columnName]) {\n      return 1;\n    }\n    if (!attributes2[columnName]) {\n      return -1;\n    }\n    return attributes1[columnName] > attributes2[columnName] ? asc : -asc;\n  });\n};\n\n\n/**\n * Handler for clicks on a row.\n * @param {Object} attributes An entry/row.\n * @param {jQuery.Event} event Event.\n * @export\n */\nexports.Controller_.prototype.clickRow = function(attributes, event) {\n  const shiftKey = this.isShiftKeyOnly_(event);\n  const platformModifierKey = this.isPlatformModifierKeyOnly_(event);\n\n  this.clickRow_(attributes, shiftKey, platformModifierKey);\n};\n\n\n/**\n * @param {Object} attributes An entry/row.\n * @param {boolean} shiftKey Shift pressed?\n * @param {boolean} platformModifierKey CTRL/Meta pressed?\n * @private\n */\nexports.Controller_.prototype.clickRow_ = function(\n  attributes, shiftKey, platformModifierKey) {\n\n  if (shiftKey && !platformModifierKey) {\n    this.selectRange_(attributes);\n  } else if (!shiftKey && platformModifierKey) {\n    this.configuration.toggleRow(attributes);\n  } else {\n    const isSelected = this.configuration.isRowSelected(attributes);\n    this.configuration.unselectAll();\n    if (!isSelected) {\n      this.configuration.selectRow(attributes);\n    }\n  }\n};\n\n\n/**\n * Selects all rows between the given row and the closest already selected row.\n * @param {Object} attributes An entry/row.\n * @private\n */\nexports.Controller_.prototype.selectRange_ = function(attributes) {\n  const targetUid = ngeoGridConfig.getRowUid(attributes);\n  const data = this.configuration.data;\n\n  if (this.configuration.isRowSelected(attributes)) {\n    return;\n  }\n\n  // get the position of the clicked and all already selected rows\n  /** @type {number|undefined} */\n  let posClickedRow = undefined;\n  const posSelectedRows = [];\n  for (let i = 0; i < data.length; i++) {\n    const currentRow = data[i];\n    const currentUid = ngeoGridConfig.getRowUid(currentRow);\n\n    if (targetUid === currentUid) {\n      posClickedRow = i;\n    } else if (this.configuration.isRowSelected(currentRow)) {\n      posSelectedRows.push(i);\n    }\n  }\n  googAsserts.assert(posClickedRow !== undefined);\n\n  if (posSelectedRows.length == 0) {\n    // if no other row is selected, select the clicked one and stop\n    this.configuration.selectRow(attributes);\n  }\n\n  // find the selected row which is the closest to the clicked row\n  let distance = Infinity;\n  let posClosestRow = posSelectedRows[0];\n  for (let j = 0; j < posSelectedRows.length; j++) {\n    const currentPos = posSelectedRows[j];\n    const currentDistance = Math.abs(currentPos - posClickedRow);\n    if (distance > currentDistance) {\n      distance = currentDistance;\n      posClosestRow = currentPos;\n    }\n    // note: this could be optimized because `posSelectedRows` is ordered.\n  }\n\n  // then select all rows between the clicked one and the closest\n  const rangeStart = (posClickedRow < posClosestRow) ? posClickedRow : posClosestRow;\n  const rangeEnd = (posClickedRow > posClosestRow) ? posClickedRow : posClosestRow;\n\n  for (let l = rangeStart; l <= rangeEnd; l++) {\n    this.configuration.selectRow(data[l]);\n  }\n};\n\n\n/**\n * Prevent the default browser behaviour of selecting text\n * when selecting multiple rows with SHIFT or CTRL/Meta.\n * @param {jQuery.Event} event Event.\n * @export\n */\nexports.Controller_.prototype.preventTextSelection = function(event) {\n  const shiftKey = this.isShiftKeyOnly_(event);\n  const platformModifierKey = this.isPlatformModifierKeyOnly_(event);\n\n  if (shiftKey || platformModifierKey) {\n    event.preventDefault();\n  }\n};\n\n\n/**\n * Same as `ol.events.condition.platformModifierKeyOnly`.\n * @param {jQuery.Event} event Event.\n * @return {boolean} True if only the platform modifier key is pressed.\n * @private\n */\nexports.Controller_.prototype.isPlatformModifierKeyOnly_ = function(event) {\n  return !event.altKey &&\n    (olHas.MAC ? event.metaKey : event.ctrlKey) &&\n    !event.shiftKey;\n};\n\n\n/**\n * Same as `ol.events.condition.shiftKeyOnly`.\n * @param {jQuery.Event} event Event.\n * @return {boolean} True if only the shift key is pressed.\n * @private\n */\nexports.Controller_.prototype.isShiftKeyOnly_ = function(event) {\n  return (\n    !event.altKey &&\n      !(event.metaKey || event.ctrlKey) &&\n      event.shiftKey);\n};\n\n\nexports.controller('ngeoGridController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.query.gridComponent\n */\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDownloadCsv from 'ngeo/download/Csv.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDownloadService from 'ngeo/download/service.js';\n\n/** @suppress {extraRequire} */\nimport ngeoGridComponent from 'ngeo/grid/component.js';\n\nimport ngeoGridConfig from 'ngeo/grid/Config.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\n\n/** @suppress {extraRequire} - required for `ngeoQueryResult` */\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\n\nimport olCollection from 'ol/Collection.js';\nimport * as olExtent from 'ol/extent.js';\nimport olMap from 'ol/Map.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfQueryGridComponent', [\n  ngeoDownloadCsv.module.name,\n  ngeoDownloadService.name,\n  ngeoGridComponent.name,\n  ngeoGridConfig.module.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoQueryMapQuerent.module.name,\n]);\n\n\nexports.value('gmfDisplayquerygridTemplateUrl',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template URL.\n   */\n  ($element, $attrs) => {\n    const templateUrl = $attrs['gmfDisplayquerygridTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/query/gridComponent';\n  }\n);\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/query/gridComponent', require('./gridComponent.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfDisplayquerygridTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfDisplayquerygridTemplateUrl($element, $attrs, gmfDisplayquerygridTemplateUrl) {\n  return gmfDisplayquerygridTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provides a component to display results of the {@link ngeo.queryResult} in a\n * grid and shows related features on the map using\n * the {@link ngeo.map.FeatureOverlayMgr}.\n *\n * You can override the default component's template by setting the\n * value `gmfDisplayquerygridTemplateUrl`.\n *\n * Features displayed on the map use a default style but you can override these\n * styles by passing ol.style.Style objects as attributes of this component.\n *\n * Note: the following ng-class need to be present in the interface <body> element to display the footer\n * when the grid is active (initially there should be the code for the profile tool):\n *      <body ng-class=\"{'gmf-profile-chart-active': !!profileChartActive, 'gmf-query-grid-active': !!queryGridActive}\">\n *\n * Example:\n *\n *      <gmf-displayquerygrid\n *        gmf-displayquerygrid-map=\"ctrl.map\"\n *        gmf-displayquerygrid-featuresstyle=\"ctrl.styleForAllFeatures\"\n *        gmf-displayquerygrid-selectedfeaturestyle=\"ctrl.styleForTheCurrentFeature\">\n *      </gmf-displayquerygrid>\n *\n * @htmlAttribute {boolean} gmf-displayquerygrid-active The active state of the component.\n * @htmlAttribute {ol.style.Style} gmf-displayquerygrid-featuresstyle A style\n *     object for all features from the result of the query.\n * @htmlAttribute {ol.style.Style} gmf-displayquerygrid-selectedfeaturestyle A style\n *     object for the currently selected features.\n * @htmlAttribute {ol.Map} gmf-displayquerygrid-map The map.\n * @htmlAttribute {boolean?} gmf-displayquerygrid-removeemptycolumns Optional. Should\n *     empty columns be hidden? Default: `false`.\n * @htmlAttribute {number?} gmf-displayquerygrid-maxrecenterzoom Optional. Maximum\n *     zoom-level to use when zooming to selected features.\n * @htmlAttribute {gmfx.GridMergeTabs?} gmf-displayquerygrid-gridmergetabs Optional.\n *     Configuration to merge grids with the same attributes into a single grid.\n *\n * @ngdoc component\n * @ngname gmfDisplayquerygrid\n */\nexports.component_ = {\n  controller: 'GmfDisplayquerygridController as ctrl',\n  bindings: {\n    'active': '=?gmfDisplayquerygridActive',\n    'featuresStyleFn': '&gmfDisplayquerygridFeaturesstyle',\n    'selectedFeatureStyleFn': '&gmfDisplayquerygridSelectedfeaturestyle',\n    'getMapFn': '&gmfDisplayquerygridMap',\n    'removeEmptyColumnsFn': '&?gmfDisplayquerygridRemoveemptycolumns',\n    'maxResultsFn': '&?gmfDisplayquerygridMaxresults',\n    'maxRecenterZoomFn': '&?gmfDisplayquerygridMaxrecenterzoom',\n    'mergeTabs': '<?gmfDisplayquerygridMergetabs'\n  },\n  templateUrl: gmfDisplayquerygridTemplateUrl\n};\n\n\nexports.component('gmfDisplayquerygrid', exports.component_);\n\n\n/**\n * Controller for the query grid.\n *\n * @param {!angular.$injector} $injector Main injector.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!ngeox.QueryResult} ngeoQueryResult ngeo query result.\n * @param {!ngeo.query.MapQuerent} ngeoMapQuerent ngeo map querent service.\n * @param {!ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr The ngeo feature\n *     overlay manager service.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!ngeo.download.Csv} ngeoCsvDownload CSV download service.\n * @param {!angular.JQLite} $element Element.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfDisplayquerygridController\n */\nexports.Controller_ = function($injector, $scope, ngeoQueryResult, ngeoMapQuerent,\n  ngeoFeatureOverlayMgr, $timeout, ngeoCsvDownload, $element) {\n\n  const queryOptions = /** @type {ngeox.QueryOptions} */ (\n    $injector.has('ngeoQueryOptions') ?\n      $injector.get('ngeoQueryOptions') : {});\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.$scope_ = $scope;\n\n  /**\n   * @type {!angular.$timeout}\n   * @private\n   */\n  this.$timeout_ = $timeout;\n\n  /**\n   * @type {!ngeox.QueryResult}\n   * @export\n   */\n  this.ngeoQueryResult = ngeoQueryResult;\n\n  /**\n   * @type {!ngeo.query.MapQuerent}\n   * @private\n   */\n  this.ngeoMapQuerent_ = ngeoMapQuerent;\n\n  /**\n   * @type {!ngeo.download.Csv}\n   * @private\n   */\n  this.ngeoCsvDownload_ = ngeoCsvDownload;\n\n  /**\n   * @type {!angular.JQLite}\n   * @private\n   */\n  this.$element_ = $element;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.maxResults = queryOptions.limit !== undefined ? queryOptions.limit : 50;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.pending = false;\n\n  /**\n   * @type {!Object.<string, gmfx.GridSource>}\n   * @export\n   */\n  this.gridSources = {};\n\n  /**\n   * IDs of the grid sources in the order they were loaded.\n   * @type {!Array.<string>}\n   * @export\n   */\n  this.loadedGridSources = [];\n\n  /**\n   * The id of the currently shown query source.\n   * @type {string|number|null}\n   * @export\n   */\n  this.selectedTab = null;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.removeEmptyColumns_ = false;\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.maxRecenterZoom;\n\n  /**\n   * @type {!gmfx.GridMergeTabs}\n   * @export\n   */\n  this.mergeTabs = {};\n\n  /**\n   * A mapping between row uid and the corresponding feature for each\n   * source.\n   * @type {!Object.<string, Object.<string, ol.Feature>>}\n   * @private\n   */\n  this.featuresForSources_ = {};\n\n  // Styles for displayed features (features) and selected features\n  // (highlightFeatures_) (user can set both styles).\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.features_ = new olCollection();\n\n  /**\n   * @type {!ngeo.map.FeatureOverlayMgr}\n   * @private\n   */\n  this.ngeoFeatureOverlayMgr_ = ngeoFeatureOverlayMgr;\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.highlightFeatures_ = new olCollection();\n\n  /**\n   * Filename\n   * @type {string}\n   * @private\n   */\n  this.filename_ = $injector.has('gmfCsvFilename') ?\n    $injector.get('gmfCsvFilename') : 'query-results.csv';\n\n  /**\n   * @type {ol.Map}\n   * @private\n   */\n  this.map_ = null;\n\n  // Watch the ngeo query result service.\n  this.$scope_.$watchCollection(\n    () => ngeoQueryResult,\n    (newQueryResult, oldQueryResult) => {\n      if (newQueryResult !== oldQueryResult) {\n        this.updateData_();\n      }\n    });\n\n  /**\n   * An unregister function returned from `$scope.$watchCollection` for\n   * \"on-select\" changes (when rows are selected/unselected).\n   * @type {?function()}\n   * @private\n   */\n  this.unregisterSelectWatcher_ = null;\n};\n\n/**\n * Init the controller\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.removeEmptyColumns_ = this['removeEmptyColumnsFn'] ? this['removeEmptyColumnsFn']() === true : false;\n  this.maxRecenterZoom = this['maxRecenterZoomFn'] ? this['maxRecenterZoomFn']() : undefined;\n\n  const featuresOverlay = this.ngeoFeatureOverlayMgr_.getFeatureOverlay();\n  featuresOverlay.setFeatures(this.features_);\n  const featuresStyle = this['featuresStyleFn']();\n  if (featuresStyle !== undefined) {\n    googAsserts.assertInstanceof(featuresStyle, olStyleStyle);\n    featuresOverlay.setStyle(featuresStyle);\n  }\n\n  const highlightFeaturesOverlay = this.ngeoFeatureOverlayMgr_.getFeatureOverlay();\n  highlightFeaturesOverlay.setFeatures(this.highlightFeatures_);\n  let highlightFeatureStyle = this['selectedFeatureStyleFn']();\n  if (highlightFeatureStyle !== undefined) {\n    googAsserts.assertInstanceof(highlightFeatureStyle, olStyleStyle);\n  } else {\n    const fill = new olStyleFill({color: [255, 0, 0, 0.6]});\n    const stroke = new olStyleStroke({color: [255, 0, 0, 1], width: 2});\n    highlightFeatureStyle = new olStyleStyle({\n      fill: fill,\n      image: new olStyleCircle({\n        fill: fill,\n        radius: 5,\n        stroke: stroke\n      }),\n      stroke: stroke,\n      zIndex: 10\n    });\n  }\n  highlightFeaturesOverlay.setStyle(highlightFeatureStyle);\n\n  const mapFn = this['getMapFn'];\n  if (mapFn) {\n    const map = mapFn();\n    googAsserts.assertInstanceof(map, olMap);\n    this.map_ = map;\n  }\n};\n\n/**\n * Returns a list of grid sources in the order they were loaded.\n * @export\n * @return {Array.<gmfx.GridSource>} Grid sources.\n */\nexports.Controller_.prototype.getGridSources = function() {\n  return this.loadedGridSources.map(sourceLabel => this.gridSources[sourceLabel]);\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.updateData_ = function() {\n  // close if there are no results\n  if (this.ngeoQueryResult.total === 0 && !this.hasOneWithTooManyResults_()) {\n    const oldActive = this.active;\n    this.clear();\n    if (oldActive) {\n      // don't close if there are pending queries\n      this.active = this.ngeoQueryResult.pending;\n      this.pending = this.ngeoQueryResult.pending;\n    }\n    return;\n  }\n\n  this.active = true;\n  this.pending = false;\n  let sources = this.ngeoQueryResult.sources;\n  // merge sources if requested\n  if (Object.keys(this.mergeTabs).length > 0) {\n    sources = this.getMergedSources_(sources);\n  }\n\n  // create grids (only for source with features or with too many results)\n  sources.forEach((source) => {\n    if (source.tooManyResults) {\n      this.makeGrid_(null, source);\n    } else {\n      source.id = this.escapeValue(source.id);\n      const features = source.features;\n      if (features.length > 0) {\n        this.collectData_(source);\n      }\n    }\n  });\n\n  if (this.loadedGridSources.length === 0) {\n    // if no grids were created, do not show\n    this.active = false;\n    return;\n  }\n\n  // keep the first existing navigation tab open\n  if (this.selectedTab === null || !((`${this.selectedTab}`) in this.gridSources)) {\n    // selecting the tab is done in a timeout, because otherwise in rare cases\n    // `ng-class` might set the `active` class on multiple tabs.\n    this.$timeout_(() => {\n      const firstSourceId = this.loadedGridSources[0];\n      this.selectTab(this.gridSources[firstSourceId]);\n    }, 0);\n  }\n};\n\n\n/**\n * @private\n * @return {boolean} If one of the source has too many results.\n */\nexports.Controller_.prototype.hasOneWithTooManyResults_ = function() {\n  return this.ngeoQueryResult.sources.some(source => source.tooManyResults);\n};\n\n/**\n * Returns the value with all symbols and spaces replaced by an underscore.\n * @param {string|number} value A value to escape.\n * @returns {string|number} value An escaped value.\n * @export\n */\nexports.Controller_.prototype.escapeValue = function(value) {\n  // Work-around for Number.isInteger() when not always getting a number ...\n  if (Number.isInteger(/** @type {number} */ (value))) {\n    return value;\n  } else {\n    const toEscape = /[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\ |]/g;\n    if (value.match(toEscape) !== null) {\n      return value.replace(toEscape, '_');\n    } else {\n      return value;\n    }\n  }\n};\n\n\n/**\n * Returns if the given grid source is selected?\n * @export\n * @param {gmfx.GridSource} gridSource Grid source.\n * @return {boolean} Is selected?\n */\nexports.Controller_.prototype.isSelected = function(gridSource) {\n  return this.selectedTab === gridSource.source.label;\n};\n\n\n/**\n * Try to merge the mergable sources.\n * @param {Array.<ngeox.QueryResultSource>} sources Sources.\n * @return {Array.<ngeox.QueryResultSource>} The merged sources.\n * @private\n */\nexports.Controller_.prototype.getMergedSources_ = function(sources) {\n  const allSources = [];\n  /** @type {Object.<string, ngeox.QueryResultSource>} */\n  const mergedSources = {};\n\n  sources.forEach((source) => {\n    // check if this source can be merged\n    const mergedSource = this.getMergedSource_(source, mergedSources);\n\n    if (mergedSource === null) {\n      // this source should not be merged, add as is\n      allSources.push(source);\n    }\n  });\n\n  for (const mergedSourceId in mergedSources) {\n    allSources.push(mergedSources[mergedSourceId]);\n  }\n\n  return allSources;\n};\n\n\n/**\n * Check if the given source should be merged. If so, an artificial source\n * that will contain the features of all mergable sources is returned. If not,\n * `null` is returned.\n * @param {ngeox.QueryResultSource} source Source.\n * @param {Object.<string, ngeox.QueryResultSource>} mergedSources Merged sources.\n * @return {?ngeox.QueryResultSource} A merged source of null if the source should\n *    not be merged.\n * @private\n */\nexports.Controller_.prototype.getMergedSource_ = function(source, mergedSources) {\n  let mergeSourceId = null;\n\n  for (const currentMergeSourceId in this.mergeTabs) {\n    const sourceLabels = this.mergeTabs[currentMergeSourceId];\n    const containsSource = sourceLabels.some(sourceLabel => sourceLabel == source.label);\n    if (containsSource) {\n      mergeSourceId = currentMergeSourceId;\n      break;\n    }\n  }\n\n  if (mergeSourceId === null) {\n    // this source should not be merged\n    return null;\n  }\n\n  /** @type {ngeox.QueryResultSource} */\n  let mergeSource;\n  if (mergeSourceId in mergedSources) {\n    mergeSource = mergedSources[mergeSourceId];\n  } else {\n    mergeSource = {\n      features: [],\n      id: mergeSourceId,\n      label: mergeSourceId,\n      limit: this.maxResults,\n      pending: false,\n      queried: true,\n      tooManyResults: false,\n      totalFeatureCount: undefined\n    };\n    mergedSources[mergeSourceId] = mergeSource;\n  }\n\n  // add features of source to merge source\n  source.features.forEach((feature) => {\n    mergeSource.features.push(feature);\n  });\n\n  // if one of the source has too many results, the resulting merged source will\n  // also be marked with `tooManyResults` and will not contain any features.\n  mergeSource.tooManyResults = mergeSource.tooManyResults || source.tooManyResults;\n  if (mergeSource.tooManyResults) {\n    mergeSource.totalFeatureCount = (mergeSource.totalFeatureCount !== undefined) ?\n      mergeSource.totalFeatureCount + mergeSource.features.length : mergeSource.features.length;\n    mergeSource.features = [];\n  }\n  if (source.totalFeatureCount !== undefined) {\n    mergeSource.totalFeatureCount = (mergeSource.totalFeatureCount !== undefined) ?\n      mergeSource.totalFeatureCount + source.totalFeatureCount : source.totalFeatureCount;\n  }\n\n  return mergeSource;\n};\n\n\n/**\n * Collect all features in the queryResult object.\n * @param {ngeox.QueryResultSource} source Result source.\n * @private\n */\nexports.Controller_.prototype.collectData_ = function(source) {\n  const features = source.features;\n  const allProperties = [];\n  const featureGeometriesNames = [];\n  const featuresForSource = {};\n  let properties, featureGeometryName;\n  features.forEach((feature) => {\n    properties = feature.getProperties();\n    if (properties !== undefined) {\n      // Keeps distinct geometry names to remove theme later.\n      featureGeometryName = feature.getGeometryName();\n      if (featureGeometriesNames.indexOf(featureGeometryName) === -1) {\n        featureGeometriesNames.push(featureGeometryName);\n      }\n\n      allProperties.push(properties);\n      featuresForSource[ngeoGridConfig.getRowUid(properties)] = feature;\n    }\n  });\n\n  this.cleanProperties_(allProperties, featureGeometriesNames);\n  if (allProperties.length > 0) {\n    const gridCreated = this.makeGrid_(allProperties, source);\n    if (gridCreated) {\n      this.featuresForSources_[`${source.label}`] = featuresForSource;\n    }\n  }\n};\n\n\n/**\n * Remove all unwanted columns.\n * @param {Array.<Object>} allProperties A row.\n * @param {Array.<string>} featureGeometriesNames Geometry names.\n * @private\n */\nexports.Controller_.prototype.cleanProperties_ = function(\n  allProperties, featureGeometriesNames) {\n  allProperties.forEach((properties) => {\n    featureGeometriesNames.forEach((featureGeometryName) => {\n      delete properties[featureGeometryName];\n    });\n    delete properties['boundedBy'];\n    delete properties['ngeo_feature_type_'];\n  });\n\n  if (this.removeEmptyColumns_ === true) {\n    this.removeEmptyColumnsFn_(allProperties);\n  }\n};\n\n\n/**\n * Remove columns that will be completely empty between each properties.\n * @param {Array.<Object>} allProperties A row.\n * @private\n */\nexports.Controller_.prototype.removeEmptyColumnsFn_ = function(\n  allProperties) {\n  // Keep all keys that correspond to at least one value in a properties object.\n  const keysToKeep = [];\n  let i, key;\n  for (key in allProperties[0]) {\n    for (i = 0; i < allProperties.length; i++) {\n      if (allProperties[i][key] !== undefined) {\n        keysToKeep.push(key);\n        break;\n      }\n    }\n  }\n  // Get all keys that previously always refers always to an empty value.\n  let keyToRemove;\n  allProperties.forEach((properties) => {\n    keyToRemove = [];\n    for (key in properties) {\n      if (keysToKeep.indexOf(key) === -1) {\n        keyToRemove.push(key);\n      }\n    }\n    // Remove these keys.\n    keyToRemove.forEach((key) => {\n      delete properties[key];\n    });\n  });\n};\n\n\n/**\n * @param {?Array.<Object>} data Grid rows.\n * @param {ngeox.QueryResultSource} source Query source.\n * @return {boolean} Returns true if a grid was created.\n * @private\n */\nexports.Controller_.prototype.makeGrid_ = function(data, source) {\n  const sourceLabel = `${source.label}`;\n  let gridConfig = null;\n  if (data !== null) {\n    gridConfig = this.getGridConfiguration_(data);\n    if (gridConfig === null) {\n      return false;\n    }\n  }\n  if (this.loadedGridSources.indexOf(sourceLabel) == -1) {\n    this.loadedGridSources.push(sourceLabel);\n  }\n  this.gridSources[sourceLabel] = {\n    configuration: gridConfig,\n    source: source\n  };\n  return true;\n};\n\n\n/**\n * @param {Array.<!Object>} data Grid rows.\n * @return {?ngeo.grid.Config} Grid config.\n * @private\n */\nexports.Controller_.prototype.getGridConfiguration_ = function(\n  data) {\n  googAsserts.assert(data.length > 0);\n  const clone = {};\n  Object.assign(clone, data[0]);\n  delete clone.ol_uid;\n  const columns = Object.keys(clone);\n\n  /** @type {Array.<ngeox.GridColumnDef>} */\n  const columnDefs = [];\n  columns.forEach((column) => {\n    columnDefs.push(/** @type {ngeox.GridColumnDef} */ ({\n      name: column\n    }));\n  });\n\n  if (columnDefs.length > 0) {\n    return new ngeoGridConfig(data, columnDefs);\n  } else {\n    // no columns, do not show grid\n    return null;\n  }\n};\n\n\n/**\n * Remove the current selected feature and source and remove all features\n * from the map.\n * @export\n */\nexports.Controller_.prototype.clear = function() {\n  this.active = false;\n  this.pending = false;\n  this.gridSources = {};\n  this.loadedGridSources = [];\n  this.selectedTab = null;\n  this.tooManyResults = false;\n  this.features_.clear();\n  this.highlightFeatures_.clear();\n  this.ngeoMapQuerent_.clear();\n  this.featuresForSources_ = {};\n  if (this.unregisterSelectWatcher_) {\n    this.unregisterSelectWatcher_();\n  }\n};\n\n\n/**\n * Select the tab for the given grid source.\n * @param {gmfx.GridSource} gridSource Grid source.\n * @export\n */\nexports.Controller_.prototype.selectTab = function(gridSource) {\n  const source = gridSource.source;\n  this.selectedTab = source.label;\n\n  if (this.unregisterSelectWatcher_) {\n    this.unregisterSelectWatcher_();\n    this.unregisterSelectWatcher_ = null;\n  }\n\n  if (gridSource.configuration !== null) {\n    this.unregisterSelectWatcher_ = this.$scope_.$watchCollection(\n      () => gridSource.configuration.selectedRows,\n      (newSelected, oldSelectedRows) => {\n        if (Object.keys(newSelected) !== Object.keys(oldSelectedRows)) {\n          this.onSelectionChanged_();\n        }\n      });\n  }\n  this.updateFeatures_(gridSource);\n\n  this.reflowGrid_();\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.reflowGrid_ = function() {\n  // This is a \"work-around\" to make sure that the grid is rendered correctly.\n  // When a pane is activated by setting `this.selectedTab`, the class `active`\n  // is not yet set on the pane. That's why the class is set manually, and\n  // after the pane is shown (in the next digest loop), the grid table can\n  // be refreshed.\n  const id = this.escapeValue(this.selectedTab || '');\n  const activePane = this.$element_.find(`div.tab-pane#${id}`);\n  activePane.removeClass('active').addClass('active');\n  this.$timeout_(() => {\n    activePane.find('div.ngeo-grid-table-container table')['trigger']('reflow');\n  });\n};\n\n\n/**\n * Called when the row selection has changed.\n * @private\n */\nexports.Controller_.prototype.onSelectionChanged_ = function() {\n  if (this.selectedTab === null) {\n    return;\n  }\n\n  const gridSource = this.gridSources[`${this.selectedTab}`];\n  this.updateFeatures_(gridSource);\n};\n\n\n/**\n * @param {gmfx.GridSource} gridSource Grid source\n * @private\n */\nexports.Controller_.prototype.updateFeatures_ = function(gridSource) {\n  this.features_.clear();\n  this.highlightFeatures_.clear();\n\n  if (gridSource.configuration === null) {\n    return;\n  }\n\n  const sourceLabel = `${gridSource.source.label}`;\n  const featuresForSource = this.featuresForSources_[sourceLabel];\n  const selectedRows = gridSource.configuration.selectedRows;\n\n  for (const rowId in featuresForSource) {\n    const feature = featuresForSource[rowId];\n    if (rowId in selectedRows) {\n      this.highlightFeatures_.push(feature);\n    } else {\n      this.features_.push(feature);\n    }\n  }\n};\n\n\n/**\n * Get the currently shown grid source.\n * @export\n * @return {gmfx.GridSource|null} Grid source.\n */\nexports.Controller_.prototype.getActiveGridSource = function() {\n  if (this.selectedTab === null) {\n    return null;\n  } else {\n    return this.gridSources[`${this.selectedTab}`];\n  }\n};\n\n\n/**\n * Returns if a row of the currently active grid is selected?\n * @export\n * @return {boolean} Is one selected?\n */\nexports.Controller_.prototype.isOneSelected = function() {\n  const source = this.getActiveGridSource();\n  if (source === null || source.configuration === null) {\n    return false;\n  } else {\n    return source.configuration.getSelectedCount() > 0;\n  }\n};\n\n\n/**\n * Returns the number of selected rows of the currently active grid.\n * @export\n * @return {number} The number of selected rows.\n */\nexports.Controller_.prototype.getSelectedRowCount = function() {\n  const source = this.getActiveGridSource();\n  if (source === null || source.configuration === null) {\n    return 0;\n  } else {\n    return source.configuration.getSelectedCount();\n  }\n};\n\n\n/**\n * Select all rows of the currently active grid.\n * @export\n */\nexports.Controller_.prototype.selectAll = function() {\n  const source = this.getActiveGridSource();\n  if (source !== null) {\n    source.configuration.selectAll();\n  }\n};\n\n\n/**\n * Deselect all rows of the currently active grid.\n * @export\n */\nexports.Controller_.prototype.unselectAll = function() {\n  const source = this.getActiveGridSource();\n  if (source !== null) {\n    source.configuration.unselectAll();\n  }\n};\n\n\n/**\n * Invert the selection of the currently active grid.\n * @export\n */\nexports.Controller_.prototype.invertSelection = function() {\n  const source = this.getActiveGridSource();\n  if (source !== null) {\n    source.configuration.invertSelection();\n  }\n};\n\n\n/**\n * Zoom to the selected features.\n * @export\n */\nexports.Controller_.prototype.zoomToSelection = function() {\n  const source = this.getActiveGridSource();\n  if (source !== null) {\n    const extent = olExtent.createEmpty();\n    this.highlightFeatures_.forEach((feature) => {\n      olExtent.extend(extent, feature.getGeometry().getExtent());\n    });\n    const size = this.map_.getSize();\n    googAsserts.assert(size !== undefined);\n    const maxZoom = this.maxRecenterZoom;\n    this.map_.getView().fit(extent, {size, maxZoom});\n  }\n};\n\n\n/**\n * Start a CSV download for the selected features.\n * @export\n */\nexports.Controller_.prototype.downloadCsv = function() {\n  const source = this.getActiveGridSource();\n  if (source !== null) {\n    const columnDefs = source.configuration.columnDefs;\n    googAsserts.assert(columnDefs !== undefined);\n    const selectedRows = source.configuration.getSelectedRows();\n\n    this.ngeoCsvDownload_.startDownload(\n      selectedRows, columnDefs, this.filename_);\n  }\n};\n\n\nexports.controller('GmfDisplayquerygridController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.swipe\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMiscSwipe', []);\n\n\n/**\n * ===========================================\n * NOTE: It is an inversed copy of ngSwipe.\n * Angular ngSwipe assumes that vertical\n * swipe is a scroll.\n * For more details:\n * https://docs.angularjs.org/api/ngTouch/service/$swipe\n * ===========================================\n */\n\n/**\n * @ngdoc service\n * @name $verticalSwipe\n *\n * @description\n * The `$verticalSwipe` service is a service that abstracts the messier details of hold-and-drag swipe\n * behavior, to make implementing swipe-related directives more convenient.\n *\n * Requires the {@link ngTouch `ngTouch`} module to be installed.\n *\n * `$verticalSwipe` is used by the `ngeoSwipeUp` and `ngeoSwipeDown` directives.\n *\n * # Usage\n * The `$verticalSwipe` service is an object with a single method: `bind`. `bind` takes an element\n * which is to be watched for swipes, and an object with four handler functions. See the\n * documentation for `bind` below.\n */\n\nexports.factory('$verticalSwipe', [function() {\n  // The total distance in any direction before we make the call on swipe vs. scroll.\n  const MOVE_BUFFER_RADIUS = 10;\n\n  const POINTER_EVENTS = {\n    'mouse': {\n      start: 'mousedown',\n      move: 'mousemove',\n      end: 'mouseup'\n    },\n    'touch': {\n      start: 'touchstart',\n      move: 'touchmove',\n      end: 'touchend',\n      cancel: 'touchcancel'\n    },\n    'pointer': {\n      start: 'pointerdown',\n      move: 'pointermove',\n      end: 'pointerup',\n      cancel: 'pointercancel'\n    }\n  };\n\n  function getCoordinates(event) {\n    const originalEvent = event.originalEvent || event;\n    const touches = originalEvent.touches && originalEvent.touches.length ? originalEvent.touches : [originalEvent];\n    const e = (originalEvent.changedTouches && originalEvent.changedTouches[0]) || touches[0];\n\n    return {\n      x: e.clientX,\n      y: e.clientY\n    };\n  }\n\n  function getEvents(pointerTypes, eventType) {\n    const res = [];\n    angular.forEach(pointerTypes, (pointerType) => {\n      const eventName = POINTER_EVENTS[pointerType][eventType];\n      if (eventName) {\n        res.push(eventName);\n      }\n    });\n    return res.join(' ');\n  }\n\n  return {\n    /**\n     * @ngdoc method\n     * @name $verticalSwipe#bind\n     * @param {!angular.JQLite} element Element.\n     * @param {Object} eventHandlers - Event handlers object with `start`, `cancel` and `end` callbacks\n     * @param {Array<string>} pointerTypes - Types of pointer\n     *\n     * @description\n     * The main method of `$verticalSwipe`. It takes an element to be watched for swipe motions, and an\n     * object containing event handlers.\n     * The pointer types that should be used can be specified via the optional\n     * third argument, which is an array of strings `'mouse'`, `'touch'` and `'pointer'`. By default,\n     * `$verticalSwipe` will listen for `mouse`, `touch` and `pointer` events.\n     *\n     * The four events are `start`, `move`, `end`, and `cancel`. `start`, `move`, and `end`\n     * receive as a parameter a coordinates object of the form `{ x: 150, y: 310 }` and the raw\n     * `event`. `cancel` receives the raw `event` as its single parameter.\n     *\n     * `start` is called on either `mousedown`, `touchstart` or `pointerdown`. After this event, `$verticalSwipe` is\n     * watching for `touchmove`, `mousemove` or `pointermove` events. These events are ignored until the total\n     * distance moved in either dimension exceeds a small threshold.\n     *\n     * Once this threshold is exceeded, either the vertical or vertical delta is greater.\n     * - If the vertical distance is greater, this is a swipe and `move` and `end` events follow.\n     * - If the horizontal distance is greater, this is a scroll, and we let the browser take over.\n     *   A `cancel` event is sent.\n     *\n     * `move` is called on `mousemove`, `touchmove` and `pointermove` after the above logic has determined that\n     * a swipe is in progress.\n     *\n     * `end` is called when a swipe is successfully completed with a `touchend`, `mouseup` or `pointerup`.\n     *\n     * `cancel` is called either on a `touchcancel` or `pointercancel`  from the browser, or when we begin scrolling\n     * as described above.\n     *\n     */\n    bind(element, eventHandlers, pointerTypes) {\n      // Absolute total movement, used to control swipe vs. scroll.\n      let totalX, totalY;\n      // Coordinates of the start position.\n      let startCoords;\n      // Last event's position.\n      let lastPos;\n      // Whether a swipe is active.\n      let active = false;\n\n      pointerTypes = pointerTypes || ['mouse', 'touch', 'pointer'];\n      element.on(getEvents(pointerTypes, 'start'), (event) => {\n        startCoords = getCoordinates(event);\n        active = true;\n        totalX = 0;\n        totalY = 0;\n        lastPos = startCoords;\n        if (eventHandlers['start']) {\n          eventHandlers['start'](startCoords, event);\n        }\n      });\n      const events = getEvents(pointerTypes, 'cancel');\n      if (events) {\n        element.on(events, (event) => {\n          active = false;\n          if (eventHandlers['cancel']) {\n            eventHandlers['cancel'](event);\n          }\n        });\n      }\n\n      element.on(getEvents(pointerTypes, 'move'), (event) => {\n        if (!active) {\n          return;\n        }\n\n        // Android will send a touchcancel if it thinks we're starting to scroll.\n        // So when the total distance (+ or - or both) exceeds 10px in either direction,\n        // we either:\n        // - On totalX > totalY, we send preventDefault() and treat this as a swipe.\n        // - On totalY > totalX, we let the browser handle it as a scroll.\n\n        if (!startCoords) {\n          return;\n        }\n        const coords = getCoordinates(event);\n\n        totalX += Math.abs(coords.x - lastPos.x);\n        totalY += Math.abs(coords.y - lastPos.y);\n\n        lastPos = coords;\n\n        if (totalX < MOVE_BUFFER_RADIUS && totalY < MOVE_BUFFER_RADIUS) {\n          return;\n        }\n\n        // One of totalX or totalY has exceeded the buffer, so decide on swipe vs. scroll.\n        if (totalX > totalY) {\n          // Allow native scrolling to take over.\n          active = false;\n          if (eventHandlers['cancel']) {\n            eventHandlers['cancel'](event);\n          }\n          return;\n        } else {\n          // Prevent the browser from scrolling.\n          event.preventDefault();\n          if (eventHandlers['move']) {\n            eventHandlers['move'](coords, event);\n          }\n        }\n      });\n\n      element.on(getEvents(pointerTypes, 'end'), (event) => {\n        if (!active) {\n          return;\n        }\n        active = false;\n        if (eventHandlers['end']) {\n          eventHandlers['end'](getCoordinates(event), event);\n        }\n      });\n    }\n  };\n}]);\n\nexports.makeSwipeDirective_ = function(directiveName, direction, eventName) {\n  exports.directive(directiveName, ['$parse', '$verticalSwipe', function($parse, $verticalSwipe) {\n    // The maximum horizontal delta for a swipe should be less than 75px.\n    const MAX_HORIZONTAL_DISTANCE = 75;\n    // Horizontal distance should not be more than a fraction of the vertical distance.\n    const MAX_HORIZONTAL_RATIO = 0.3;\n    // At least a 30px lateral motion is necessary for a swipe.\n    const MIN_VERTICAL_DISTANCE = 30;\n\n    return function(scope, element, attr) {\n      const swipeHandler = $parse(attr[directiveName]);\n\n      let startCoords, valid;\n\n      function validSwipe(coords) {\n        // Check that it's within the coordinates.\n        // Absolute vertical distance must be within tolerances.\n        // Horizontal distance, we take the current X - the starting X.\n        // This is negative for downward swipes and positive for upward swipes.\n        // After multiplying by the direction (-1 for down, +1 for up), legal swipes\n        // (ie. same direction as the directive wants) will have a positive delta and\n        // illegal ones a negative delta.\n        // Therefore this delta must be positive, and larger than the minimum.\n        if (!startCoords) {\n          return false;\n        }\n        const deltaY = (coords.y - startCoords.y) * direction;\n        const deltaX = Math.abs(coords.x - startCoords.x);\n        return valid && // Short circuit for already-invalidated swipes.\n            deltaX < MAX_HORIZONTAL_DISTANCE &&\n            deltaY > 0 &&\n            deltaY > MIN_VERTICAL_DISTANCE &&\n            deltaX / deltaY < MAX_HORIZONTAL_RATIO;\n      }\n\n      const pointerTypes = ['touch'];\n      if (!angular.isDefined(attr['ngeoSwipeDisableMouse'])) {\n        pointerTypes.push('mouse');\n      }\n      $verticalSwipe.bind(element, {\n        'start': function(coords, event) {\n          startCoords = coords;\n          valid = true;\n        },\n        'cancel': function(event) {\n          valid = false;\n        },\n        'end': function(coords, event) {\n          if (validSwipe(coords)) {\n            scope.$apply(() => {\n              element.triggerHandler(eventName);\n              swipeHandler(scope, {$event: event});\n            });\n          }\n        }\n      }, pointerTypes);\n    };\n  }]);\n};\n\n// Down is negative Y-coordinate, up is positive.\nexports.makeSwipeDirective_('ngeoSwipeDown', 1, 'swipedown');\nexports.makeSwipeDirective_('ngeoSwipeUp', -1, 'swipeup');\n\n\nexport default exports;\n","/**\n * @module gmf.query.windowComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscSwipe from 'ngeo/misc/swipe.js';\n\n/** @suppress {extraRequire} - required for `ngeoQueryResult` */\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\n\nimport olCollection from 'ol/Collection.js';\nimport * as olObj from 'ol/obj.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\nimport 'jquery-ui/ui/widgets/resizable.js';\nimport 'angular-animate';\nimport 'angular-touch';\nimport 'bootstrap/js/collapse.js';\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfQueryWindowComponent', [\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscSwipe.name,\n  ngeoQueryMapQuerent.module.name,\n  'ngAnimate',\n  'ngTouch',\n]);\n\n\nexports.config(['$animateProvider',\n  /**\n   * For performance reason, only perform animation on elements that have the\n   * `gmf-animatable` css class.\n   * @param {angular.$animateProvider} $animateProvider animate provider.\n   */\n  function($animateProvider) {\n    $animateProvider.classNameFilter(/gmf-animatable/);\n  }\n]);\n\n\nexports.value('gmfDisplayquerywindowTemplateUrl',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template.\n   */\n  ($element, $attrs) => {\n    const templateUrl = $attrs['gmfDisplayquerywindowTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/query/windowComponent';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/query/windowComponent', require('./windowComponent.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfDisplayquerywindowTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfDisplayquerywindowTemplateUrl($element, $attrs, gmfDisplayquerywindowTemplateUrl) {\n  return gmfDisplayquerywindowTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provide a component to display results of the {@link ngeo.queryResult}\n * and shows related features on the map using the {@link ngeo.map.FeatureOverlayMgr}.\n *\n * You can override the default component's template by setting the\n * value `gmfDisplayquerywindowTemplateUrl`.\n *\n * Features displayed on the map use a default style but you can override these\n * styles by passing ol.style.Style objects as attributes of this component.\n *\n * Example:\n *\n *      <gmf-displayquerywindow\n *        gmf-displayquerywindow-featuresstyle=\"ctrl.styleForAllFeatures\"\n *        gmf-displayquerywindow-selectedfeaturestyle=\"ctrl.styleForTheCurrentFeature\">\n *      </gmf-displayquerywindow>\n *\n * @htmlAttribute {ol.style.Style} gmf-displayquerywindow-featuresstyle A style\n *     object for all features from the result of the query.\n * @htmlAttribute {ol.style.Style} selectedfeaturestyle A style\n *     object for the current displayed feature.\n * @htmlAttribute {boolean=} defaultcollapsed If the query result window is\n *     collapsed.\n * @htmlAttribute {boolean} desktop If the component is used in the desktop\n *     application.\n * @htmlAttribute {boolean} showunqueriedlayers If also layers, that have not\n *     been queried for the last query, should be shown in the filter.\n *\n * @ngdoc component\n * @ngname gmfDisplayquerywindow\n */\nexports.component_ = {\n  controller: 'GmfDisplayquerywindowController as ctrl',\n  bindings: {\n    'draggableContainment': '<?gmfDisplayquerywindowDraggableContainment',\n    'featuresStyleFn': '&gmfDisplayquerywindowFeaturesstyle',\n    'selectedFeatureStyleFn': '&gmfDisplayquerywindowSelectedfeaturestyle',\n    'defaultCollapsedFn': '&?gmfDisplayquerywindowDefaultcollapsed',\n    'desktop': '=gmfDisplayquerywindowDesktop',\n    'showUnqueriedLayers': '=gmfDisplayquerywindowShowunqueriedlayers'\n  },\n  templateUrl: gmfDisplayquerywindowTemplateUrl\n};\n\n\nexports.component('gmfDisplayquerywindow', exports.component_);\n\n\n/**\n * @param {!jQuery} $element Element.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!ngeox.QueryResult} ngeoQueryResult ngeo query result.\n * @param {!ngeo.query.MapQuerent} ngeoMapQuerent ngeo map querent service.\n * @param {!ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr The ngeo feature\n *     overlay manager service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfDisplayquerywindowController\n */\nexports.Controller_ = function($element, $scope, ngeoQueryResult, ngeoMapQuerent,\n  ngeoFeatureOverlayMgr) {\n\n  /**\n   * @type {Element|string}\n   * @export\n   */\n  this.draggableContainment;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.desktop = false;\n\n  /**\n   * Is the window currently collapsed?\n   * When used for Desktop, it is shown non-collapsed.\n   * @type {boolean}\n   * @export\n   */\n  this.collapsed = !this.desktop;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.showUnqueriedLayers_ = false;\n\n  /**\n   * Object that is used to filter the source list in the template.\n   * @type {Object}\n   * @export\n   */\n  this.sourcesFilter = {'queried': true};\n\n  /**\n   * @type {ngeox.QueryResult}\n   * @export\n   */\n  this.ngeoQueryResult = {\n    sources: [],\n    total: 0,\n    pending: false\n  };\n\n  /**\n   * @type {!ngeo.query.MapQuerent}\n   * @private\n   */\n  this.ngeoMapQuerent_ = ngeoMapQuerent;\n\n  /**\n   * @type {?ngeox.QueryResultSource}\n   * @export\n   */\n  this.selectedSource = null;\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.features_ = new olCollection();\n\n  /**\n   * @type {!ngeo.map.FeatureOverlayMgr}\n   * @private\n   */\n  this.ngeoFeatureOverlayMgr_ = ngeoFeatureOverlayMgr;\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.highlightFeatures_ = new olCollection();\n\n  /**\n   * @type {?ngeox.QueryResultSource}\n   * @export\n   */\n  this.source = null;\n\n  /**\n   * @type {?ol.Feature}\n   * @export\n   */\n  this.feature = null;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.currentResult = -1;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.isNext = true;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.animate = 0;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.open = false;\n\n  /**\n   * @const {!jQuery}\n   * @private\n   */\n  this.element_ = $element;\n\n  $scope.$watchCollection(\n    () => ngeoQueryResult,\n    (newQueryResult, oldQueryResult) => {\n      this.updateQueryResult_(newQueryResult);\n      if (newQueryResult.total > 0) {\n        this.show();\n      } else if (oldQueryResult !== newQueryResult) {\n        this.open = false;\n        this.clear();\n      }\n    });\n};\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.draggableContainment = this.draggableContainment || 'document';\n  this.desktop = this.desktop;\n  this.collapsed = this['defaultCollapsedFn'] ?\n    this['defaultCollapsedFn']() === true : !this.desktop;\n\n  this.showUnqueriedLayers_ = this['showUnqueriedLayers'] ?\n    this['showUnqueriedLayers'] === true : false;\n\n  this.sourcesFilter = this.showUnqueriedLayers_ ? {} : {'queried': true};\n\n  const featuresOverlay = this.ngeoFeatureOverlayMgr_.getFeatureOverlay();\n  featuresOverlay.setFeatures(this.features_);\n  const featuresStyle = this['featuresStyleFn']();\n  if (featuresStyle !== undefined) {\n    googAsserts.assertInstanceof(featuresStyle, olStyleStyle);\n    featuresOverlay.setStyle(featuresStyle);\n  }\n\n  const highlightFeaturesOverlay = this.ngeoFeatureOverlayMgr_.getFeatureOverlay();\n  highlightFeaturesOverlay.setFeatures(this.highlightFeatures_);\n  let highlightFeatureStyle = this['selectedFeatureStyleFn']();\n  if (highlightFeatureStyle !== undefined) {\n    googAsserts.assertInstanceof(highlightFeatureStyle, olStyleStyle);\n  } else {\n    const fill = new olStyleFill({color: [255, 0, 0, 0.6]});\n    const stroke = new olStyleStroke({color: [255, 0, 0, 1], width: 2});\n    highlightFeatureStyle = new olStyleStyle({\n      fill: fill,\n      image: new olStyleCircle({\n        fill: fill,\n        radius: 5,\n        stroke: stroke\n      }),\n      stroke: stroke\n    });\n  }\n  highlightFeaturesOverlay.setStyle(highlightFeatureStyle);\n\n  const windowContainer = this.element_.find('.gmf-displayquerywindow .windowcontainer');\n  if (this.desktop) {\n    windowContainer.draggable({\n      handle: '.header',\n      containment: this.draggableContainment\n    });\n    windowContainer.resizable({\n      minHeight: 240,\n      minWidth: 240\n    });\n  }\n};\n\n\n/**\n * Remove current displayed results then get new results from the\n * ngeoQueryResult service. Display all results on the map and display,\n * highlight the first feature.\n * @export\n */\nexports.Controller_.prototype.show = function() {\n  this.clear();\n  this.updateFeatures_();\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.updateFeatures_ = function() {\n  this.setCurrentResult_(0, false);\n  if (this.source !== null) {\n    this.collectFeatures_();\n    this.highlightCurrentFeature_();\n    this.open = true;\n  }\n};\n\n/**\n * Select a source and a feature depending of the given position.\n * @param {number} position The index of the feature. If the position is bigger\n * than the length of the first source, get it in the next source. Etc.\n * @param {boolean} setHighlight True to set the highlight automatically.\n * @return {boolean} True if result has changed. False else.\n * @private\n */\nexports.Controller_.prototype.setCurrentResult_ = function(\n  position, setHighlight) {\n  let hasChanged = false;\n  if (position !== this.currentResult) {\n    let i, source, features;\n    const lastFeature = this.feature;\n    const sources = this.ngeoQueryResult.sources;\n    this.currentResult = position;\n    for (i = 0; i < sources.length; i++) {\n      source = sources[i];\n      if (this.selectedSource !== null && this.selectedSource !== source) {\n        // when filtering on a source, only consider features of the selected source\n        continue;\n      }\n      features = source.features;\n      if (position >= features.length) {\n        position -= features.length;\n      } else {\n        this.source = source;\n        this.feature = source.features[position];\n        hasChanged = true;\n        break;\n      }\n    }\n    if (setHighlight) {\n      this.highlightCurrentFeature_(lastFeature);\n    }\n  }\n  return hasChanged;\n};\n\n\n/**\n * Select the logical previous source and feature then highlight this feature on\n * the map.\n * @export\n */\nexports.Controller_.prototype.previous = function() {\n  let position = this.currentResult - 1;\n  if (position < 0) {\n    position = this.getResultLength() - 1;\n  }\n  const hasChanged = this.setCurrentResult_(position, true);\n  if (hasChanged) {\n    this.animate_(false);\n  }\n};\n\n\n/**\n * Select the logical next source and feature then highlight this feature on\n * the map.\n * @export\n */\nexports.Controller_.prototype.next = function() {\n  let position = this.currentResult + 1;\n  const positionMax = this.getResultLength() - 1;\n  if (position > positionMax) {\n    position = 0;\n  }\n  const hasChanged = this.setCurrentResult_(position, true);\n  if (hasChanged) {\n    this.animate_(true);\n  }\n};\n\n\n/**\n * Remove features without properties from the query result.\n * @param {ngeox.QueryResult} queryResult ngeo query result.\n * @private\n */\nexports.Controller_.prototype.updateQueryResult_ = function(queryResult) {\n  this.ngeoQueryResult.total = 0;\n  this.ngeoQueryResult.sources.length = 0;\n  for (let i = 0; i < queryResult.sources.length; i++) {\n    const source = queryResult.sources[i];\n    source.features = source.features.filter((feature) => {\n      googAsserts.assert(feature);\n      return !olObj.isEmpty(ngeoMiscFeatureHelper.getFilteredFeatureValues(feature));\n    });\n    this.ngeoQueryResult.sources.push(source);\n    this.ngeoQueryResult.total += source.features.length;\n  }\n};\n\n/**\n * Get the total count of features in the result of the query. If a source\n * has been select, only the number of features of that source are returned.\n * @return {number} Total number of features.\n * @export\n */\nexports.Controller_.prototype.getResultLength = function() {\n  if (this.selectedSource === null) {\n    return this.ngeoQueryResult.total;\n  } else {\n    return this.selectedSource.features.length;\n  }\n};\n\n\n/**\n * @return {boolean} If the first result is active.\n * @export\n */\nexports.Controller_.prototype.isFirst = function() {\n  return this.currentResult == 0;\n};\n\n\n/**\n * @return {boolean} If the last result is active.\n * @export\n */\nexports.Controller_.prototype.isLast = function() {\n  return this.currentResult == this.getResultLength() - 1;\n};\n\n\n/**\n * Delete the unwanted ol3 properties from the current feature then return the\n * properties.\n * @return {Object?} Filtered properties of the current feature or null.\n * @export\n */\nexports.Controller_.prototype.getFeatureValues = function() {\n  if (!this.feature) {\n    return null;\n  }\n  return ngeoMiscFeatureHelper.getFilteredFeatureValues(this.feature);\n};\n\n\n/**\n * Special function that's used to set the \"animation\" value after to set the\n * \"isNext\" value. The aim is to wait on Angular to add a class (corresponding\n * to \"isNext\") on the DOM before to set the \"animation\" value and do the\n * animation.\n * @param {boolean} isNext used to indicate if the user wants to see the next\n * or the previous result.\n * @private\n */\nexports.Controller_.prototype.animate_ = function(isNext) {\n  this.isNext = isNext;\n  this.animate++;\n};\n\n\n/**\n * Collect all features in the queryResult object.\n * @private\n */\nexports.Controller_.prototype.collectFeatures_ = function() {\n  const sources = this.ngeoQueryResult.sources;\n  this.features_.clear();\n  for (let i = 0; i < sources.length; i++) {\n    const source = sources[i];\n    if (this.selectedSource !== null && this.selectedSource !== source) {\n      // when filtering on a source, only add features of the selected source\n      continue;\n    }\n    const features = source.features;\n    for (let ii = 0; ii < features.length; ii++) {\n      this.features_.push(features[ii]);\n    }\n  }\n};\n\n\n/**\n * Highlight the current displayed feature.\n * @param {ol.Feature=} opt_lastFeature last highlighted feature. Require if\n * it exists because it must be added to the 'non-selected' features collection.\n * @private\n */\nexports.Controller_.prototype.highlightCurrentFeature_ =\nfunction(opt_lastFeature) {\n  this.highlightFeatures_.clear();\n  this.features_.remove(this.feature);\n  this.highlightFeatures_.push(this.feature);\n  if (opt_lastFeature !== undefined) {\n    this.features_.push(opt_lastFeature);\n  }\n};\n\n\n/**\n * Remove the current selected feature and source and remove all features\n * from the map.\n * @export\n */\nexports.Controller_.prototype.close = function() {\n  this.open = false;\n  this.clear();\n  this.ngeoMapQuerent_.clear();\n};\n\n\n/**\n * Remove the current selected feature and source and remove all features\n * from the map.\n * @export\n */\nexports.Controller_.prototype.clear = function() {\n  this.feature = null;\n  this.source = null;\n  this.currentResult = -1;\n  this.features_.clear();\n  this.highlightFeatures_.clear();\n  this.selectedSource = null;\n};\n\n\n/**\n * @param {ngeox.QueryResultSource} source The source to select.\n * @export\n */\nexports.Controller_.prototype.setSelectedSource = function(source) {\n  if (source !== null && source.features.length <= 0) {\n    // sources with no results can not be selected\n    return;\n  }\n  this.clear();\n  this.selectedSource = source;\n  this.updateFeatures_();\n};\n\n\nexports.controller('GmfDisplayquerywindowController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.query.extraModule\n */\nimport gmfQueryGridComponent from 'gmf/query/gridComponent.js';\nimport gmfQueryWindowComponent from 'gmf/query/windowComponent.js';\n\nimport './grid.less';\nimport './window.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfQueryExtraModule', [\n  gmfQueryGridComponent.name,\n  gmfQueryWindowComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.search.module\n */\nimport gmfSearchComponent from 'gmf/search/component.js';\nimport gmfSearchFulltextSearch from 'gmf/search/FulltextSearch.js';\n\nimport './search.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfSearchModule', [\n  gmfSearchComponent.name,\n  gmfSearchFulltextSearch.module.name\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.theme.selectorComponent\n */\nimport gmfThemeManager from 'gmf/theme/Manager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport * as olEvents from 'ol/events.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfThemeSelectorComponent', [\n  gmfThemeManager.module.name,\n  gmfThemeThemes.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/theme/selectorComponent', require('./selectorComponent.html'));\n});\n\n\nexports.value('gmfThemeSelectorTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfThemeSelectorTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/theme/selectorComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfThemeSelectorTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfThemeSelectorTemplateUrl($attrs, gmfThemeSelectorTemplateUrl) {\n  return gmfThemeSelectorTemplateUrl($attrs);\n}\n\n\n/**\n * Note that this component works with the {@link gmf.layertree.TreeManager}.\n * Setting the theme will update the \"tree\" object of\n * this {@link gmf.layertree.TreeManager}.\n *\n * Example:\n *\n *      <a href class=\"btn btn-default btn-block btn-primary\" data-toggle=\"dropdown\">\n *          <span class=\"fa fa-grid\"></span>\n *          <span ng-if=\"mainCtrl.gmfThemeManager.modeFlush\">\n *            <span translate>Theme:</span>\n *            <b ng-if=\"!mainCtrl.gmfThemeManager.getThemeName()\" translate>Loading...</b>\n *            <b ng-if=\"mainCtrl.gmfThemeManager.getThemeName()\">{{mainCtrl.gmfThemeManager.getThemeName()|translate}}</b>\n *          </span>\n *          <span ng-if=\"!mainCtrl.gmfThemeManager.modeFlush\">\n *            <b ng-if=\"!mainCtrl.gmfThemeManager.themeName\" translate>Themes</b>\n *          </span>\n *          <span class=\"caret\"></span>\n *      </a>\n *      <gmf-themeselector\n *         id=\"themes\"\n *         data-header-title=\"Themes\"\n *         gmf-themeselector-filter=\"::mainCtrl.filter\">\n *      </gmf-themeselector>\n *\n * The theme selector can operate in a 'flush' (as above) or 'add' mode. For more information\n * about these modes, refer to the documentation of {@link gmf.layertree.TreeManager}.\n *\n * Example in 'add' mode:\n *\n *      <a href class=\"btn btn-default btn-block btn-primary\" data-toggle=\"dropdown\">\n *          <span class=\"fa fa-grid\"></span>\n *          <span translate>Themes</span>\n *          <span class=\"caret\"></span>\n *      </a>\n *      <gmf-themeselector\n *         id=\"themes\"\n *         data-header-title=\"Themes\"\n *         gmf-themeselector-filter=\"::mainCtrl.filter\">\n *      </gmf-themeselector>\n *      <script>\n *        (function() {\n *          let module = angular.module('app');\n *          module.value('gmfTreeManagerModeFlush', false);\n *        })();\n *      </script>\n *\n * @htmlAttribute {Function} gmf-themeselector-filter The themes filter.\n *\n * @type {!angular.Component}\n */\nexports.component_ = {\n  bindings: {\n    'filter': '<gmfThemeselectorFilter'\n  },\n  controller: 'gmfThemeselectorController',\n  templateUrl: gmfThemeSelectorTemplateUrl\n};\n\nexports.component('gmfThemeselector', exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {gmf.theme.Manager} gmfThemeManager Tree manager service.\n * @param {gmf.theme.Themes} gmfThemes Themes service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname gmfThemeselectorController\n */\nexports.Controller_ = function($scope, gmfThemeManager, gmfThemes) {\n\n  /**\n   * @type {gmf.theme.Manager}\n   * @export\n   */\n  this.gmfThemeManager = gmfThemeManager;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {Array.<Object>}\n   * @export\n   */\n  this.themes;\n\n  /**\n   * @type {Function|undefined}\n   * @export\n   */\n  this.filter;\n\n  /**\n   * @type {Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  this.listenerKeys_.push(olEvents.listen(this.gmfThemes_, 'change', this.setThemes_, this));\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n\n};\n\n/**\n * Store the loaded themes locally applying a filter (if any), then set the\n * current theme.\n * @private\n */\nexports.Controller_.prototype.setThemes_ = function() {\n  this.gmfThemes_.getThemesObject().then((themes) => {\n    // Keep only the themes dedicated to the theme switcher\n    this.themes = this.filter ? themes.filter(this.filter) : themes;\n  });\n};\n\n\n/**\n * @param {gmfThemes.GmfTheme} theme Theme.\n * @param {boolean=} opt_silent if true it will be no user message if\n *     the theme should be added but it's already added.\n * @export\n */\nexports.Controller_.prototype.setTheme = function(theme, opt_silent) {\n  if (theme) {\n    this.gmfThemeManager.addTheme(theme, opt_silent);\n  }\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  this.listenerKeys_.forEach(olEvents.unlistenByKey);\n  this.listenerKeys_.length = 0;\n};\n\n\nexports.controller('gmfThemeselectorController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.theme.module\n */\nimport gmfThemeManager from 'gmf/theme/Manager.js';\nimport gmfThemeSelectorComponent from 'gmf/theme/selectorComponent.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfThemeModule', [\n  gmfThemeSelectorComponent.name,\n  gmfThemeManager.module.name,\n  gmfThemeThemes.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.displaywindowComponent\n */\nimport googAsserts from 'goog/asserts.js';\n\nimport 'font-awesome/css/font-awesome.css';\nimport 'jquery-ui/ui/widgets/resizable.js';\nimport 'jquery-ui/ui/widgets/draggable.js';\nimport 'angular-sanitize';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMessageDisplaywindowComponent', [\n  'ngSanitize',\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/message/displaywindowComponent', require('./displaywindowComponent.html'));\n});\n\n\nexports.value('ngeoMessageDisplaywindowTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['ngeoMessageDisplaywindowTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/message/displaywindowComponent';\n  });\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} ngeoMessageDisplaywindowTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoMessageDisplaywindowTemplateUrl($attrs, ngeoMessageDisplaywindowTemplateUrl) {\n  return ngeoMessageDisplaywindowTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!jQuery} $element Element.\n   * @param {!angular.$sce} $sce Angular sce service.\n   * @param {!angular.Scope} $scope Scope.\n   * @param {!angular.$compile} $compile The compile provider.\n   * @private\n   * @ngInject\n   * @ngdoc controller\n   * @ngname ngeoDisplaywindowComponentController\n   */\n  constructor($element, $sce, $scope, $compile) {\n\n    // === Binding Properties ===\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.clearOnClose;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.content = null;\n\n    /**\n     * @type {?string}\n     */\n    this.contentTemplate = null;\n\n    /**\n     * @type {?angular.Scope}\n     */\n    this.contentScope = null;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.draggable;\n\n    /**\n     * @type {Element|string}\n     * @export\n     */\n    this.draggableContainment;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.desktop;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.height = null;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.open;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.resizable;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.title = null;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.url = null;\n\n    /**\n     * @type {?string}\n     * @export\n     */\n    this.width = null;\n\n\n    // === Injected Properties ===\n\n    /**\n     * @type {!jQuery}\n     * @private\n     */\n    this.element_ = $element;\n\n    /**\n     * @type {!angular.$sce}\n     * @private\n     */\n    this.sce_ = $sce;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {angular.$compile}\n     * @private\n     */\n    this.compile_ = $compile;\n  }\n\n  /**\n   * Called on initialization of the component.\n   */\n  $onInit() {\n\n    // Initialize binding properties\n    this.clearOnClose = this.clearOnClose !== false;\n    this.content = this.content || null;\n    this.contentTemplate = this.contentTemplate || null;\n    this.contentScope = this.contentScope || null;\n    this.desktop = this.desktop !== false;\n    this.draggableContainment = this.draggableContainment || 'document';\n    this.open = this.open === true;\n    this.height = this.height || '240px';\n    this.width = this.width || '240px';\n\n    this.draggable = this.draggable !== undefined ?\n      this.draggable : this.desktop;\n    this.resizable = this.resizable !== undefined ?\n      this.resizable : this.desktop;\n\n    // Draggable\n    if (this.draggable) {\n      this.element_.find('.ngeo-displaywindow .windowcontainer').draggable({\n        'containment': this.draggableContainment,\n        'handle': 'div.header'\n      });\n    }\n\n    // Resizable\n    if (this.resizable) {\n      this.element_.find('.ngeo-displaywindow .windowcontainer').resizable({\n        'minHeight': 240,\n        'minWidth': 240\n      });\n    }\n\n    if (this.contentTemplate) {\n      this.updateContentTemplate_();\n    }\n\n    this.scope_.$watch(\n      () => this.contentTemplate,\n      () => this.updateContentTemplate_()\n    );\n  }\n\n  /**\n   *  @private\n   */\n  updateContentTemplate_() {\n    const scope = googAsserts.assert(this.contentScope || this.scope_);\n    const compiled = this.compile_(this.contentTemplate)(scope);\n    const displayWindow = this.element_.find('.ngeo-displaywindow .windowcontainer .animation-container .content-template-container');\n    displayWindow.empty();\n    displayWindow.append(/** @type {?} */ (compiled));\n  }\n\n  /**\n   * @export\n   */\n  close() {\n    this.open = false;\n    if (this.clearOnClose) {\n      this.clear_();\n    }\n  }\n\n  /**\n   * @return {!Object.<string, string>} CSS style when using width/height\n   * @export\n   */\n  get style() {\n    return {\n      'height': this.height,\n      'width': this.width\n    };\n  }\n\n  /**\n   * @return {string|undefined} Trusted url.\n   * @export\n   */\n  get urlTrusted() {\n    if (this.url) {\n      return /** @type {string} */ (this.sce_.trustAsResourceUrl(this.url));\n    }\n  }\n\n  /**\n   * @export\n   */\n  clear_() {\n    this.content = null;\n    this.title = null;\n    this.url = null;\n  }\n};\n\n\n/**\n * The `ngeo-displaywindow` component is an alternative to the `ngeo.message.Popup`.\n * What they have in common:\n *\n * - support title\n * - support url to be shown in an iframe\n * - support plain HTML content\n * - support sizing, i.e. height and width.\n * - support being opened/closed\n *\n * The differences with the `ngeo.message.Popup` are:\n *\n * - it supports being dragged\n * - it supports being resized\n * - support angularjs template content\n *\n * Example:\n *      <ngeo-displaywindow\n *        class=\"window1\"\n *        url=\"::ctrl.window1Content\"\n *        desktop=\"::false\"\n *        open=\"::true\"\n *        title=\"'Window 1 - The simplest window (close kills it)'\">\n *      </ngeo-displaywindow>\n *\n * @htmlAttribute {boolean=} ngeo-displaywindow-clear-on-close Whether to clear the content on close or not.\n * @htmlAttribute {string=} ngeo-displaywindow-content The html content. If not provided, you must provide\n *     an url.\n * @htmlAttribute {string=} ngeo-displaywindow-content-template AngularJS template. It gets compiled during runtime\n * with the supplied scope (ngeo-displaywindow-content-scope).\n * @htmlAttribute {angular.Scope=} ngeo-displaywindow-content-scope Scope used for ngeo-displaywindow-content-template.\n * @htmlAttribute {boolean=} ngeo-displaywindow-desktop If true, the window is draggable and resizable. If\n *     not set, you must set manually both parameter.\n * @htmlAttribute {boolean=} ngeo-displaywindow-draggable Whether the window is draggable or not.\n * @htmlAttribute {string=} ngeo-displaywindow-draggable-containment The zone (CSS selector) where the window\n *     is authorized to be dragged.\n * @htmlAttribute {string=} ngeo-displaywindow-height The default height of the window.\n * @htmlAttribute {boolean=} ngeo-displaywindow-open Whether the window is open or not.\n * @htmlAttribute {string=} ngeo-displaywindow-title The html title of the window.\n * @htmlAttribute {string=} ngeo-displaywindow-url The URL to open in an iframe, in the window. The content\n *     attribute must not be provided.\n * @htmlAttribute {string=} ngeo-displaywindow-width The default width of the window.\n * @ngdoc component\n * @ngname ngeoDisplaywindow\n */\nexports.component('ngeoDisplaywindow', {\n  bindings: {\n    'clearOnClose': '<?',\n    'content': '=?',\n    'contentTemplate': '=?',\n    'contentScope': '<?',\n    'desktop': '<?',\n    'draggable': '<?',\n    'draggableContainment': '<?',\n    'height': '=?',\n    'open': '=?',\n    'resizable': '<?',\n    'title': '=?',\n    'url': '=?',\n    'width': '=?'\n  },\n  controller: exports.Controller_,\n  templateUrl: ngeoMessageDisplaywindowTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.controlComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport olMap from 'ol/Map.js';\nimport olControlControl from 'ol/control/Control.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoControl', []);\n\n\n/**\n * Provides a directive that can be used to add a control to the map\n * using a DOM element.\n *\n * Example:\n *\n *     <div ngeo-control=\"ctrl.control\" ngeo-control-map=\"ctrl.map\"></div>\n *\n * The expression passed to \"ngeo-control\" should evaluate to a control\n * instance, and the expression passed to \"ngeo-control-map\" should\n * evaluate to a map instance.\n *\n * See our live example: [../examples/control.html](../examples/control.html)\n *\n * @htmlAttribute {ol.Map} ngeo-control-map The map.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoControl\n */\nexports.component_ = function() {\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n\n      const control = /** @type {ol.control.Control} */\n              (scope.$eval(attrs['ngeoControl']));\n      googAsserts.assertInstanceof(control, olControlControl);\n\n      const map = /** @type {ol.Map} */\n              (scope.$eval(attrs['ngeoControlMap']));\n      googAsserts.assertInstanceof(map, olMap);\n\n      control.setTarget(element[0]);\n      map.addControl(control);\n    }\n  };\n};\n\n\nexports.directive('ngeoControl', exports.component_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.filereaderComponent\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoFilereader', []);\n\n/**\n * This directive is to used on an input file element. When a file is selected\n * the directive uses the browser `FileReader` API to read the file. The file\n * content is provided to the directive user through the assignable expression.\n * Only works for text files (`readAsText` used for reading the file). And does\n * not work in Internet Explorer 9.\n *\n * Example:\n *\n *      <input type=\"file\" ngeo-filereader=\"ctrl.fileContent\"\n *        ngeo-filereader-supported=\"ctrl.supported\"/>\n *\n * See our live example: [../examples/importfeatures.html](../examples/importfeatures.html)\n *\n * @htmlAttribute {string} ngeo-filereader The content of the file read.\n * @htmlAttribute {boolean=} ngeo-filereader-supported Whether the FileReader API is supported.\n * @param {angular.$window} $window The Angular $window service.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoFilereader\n */\nexports.component_ = function($window) {\n  return {\n    restrict: 'A',\n    scope: {\n      'fileContent': '=ngeoFilereader',\n      'supported': '=?ngeoFilereaderSupported'\n    },\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n      const supported = 'FileReader' in $window;\n      scope['supported'] = supported;\n      if (!supported) {\n        return;\n      }\n      element.on('change', (changeEvent) => {\n        /** @type {!FileReader} */\n        const fileReader = new $window.FileReader();\n        fileReader.onload = (\n          /**\n                 * @param {!ProgressEvent} evt Event.\n                 */\n          function(evt) {\n            scope.$apply(() => {\n              scope['fileContent'] = evt.target.result;\n            });\n          });\n        fileReader.readAsText(changeEvent.target.files[0]);\n      });\n    }\n  };\n};\n\n\nexports.directive('ngeoFilereader',\n  exports.component_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.getBrowserLanguage\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoGetBrowserLanguage', []);\n\n\n/**\n * Provides a function that returns the most appropriate 2-letter\n * language code depending on the list of available languages and the browser\n * languages settings.\n *\n * @param {angular.$window} $window Angular $window service.\n * @return {ngeox.miscGetBrowserLanguage} The \"GetBrowserLanguage\" function.\n *\n * @ngdoc service\n * @ngname ngeoGetBrowserLanguage\n * @ngInject\n */\nexports.factory_ = function($window) {\n  return (\n    /**\n     * @param {Array.<string>} availableLanguages Available languages.\n     * @return {string} The \"best\" language code.\n     */\n    function(availableLanguages) {\n      const nav = $window.navigator;\n      let browserLanguages = nav.languages || nav.language ||\n            nav.browserLanguage || nav.systemLanguage || nav.userLanguage;\n      if (!Array.isArray(browserLanguages)) {\n        browserLanguages = [browserLanguages];\n      }\n      browserLanguages = browserLanguages.map(item => item.substring(0, 2));\n      // remove duplicated language codes\n      browserLanguages = browserLanguages.filter((item, index, arr) => arr.indexOf(item) == index);\n      const supportedLanguages = browserLanguages.filter(item => availableLanguages.indexOf(item) != -1);\n      return supportedLanguages[0];\n    });\n};\n\nexports.factory('ngeoGetBrowserLanguage', exports.factory_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.extraModule\n */\nimport ngeoMiscAutoProjection from 'ngeo/misc/AutoProjection.js';\nimport ngeoMiscBtnComponent from 'ngeo/misc/btnComponent.js';\nimport ngeoMiscControlComponent from 'ngeo/misc/controlComponent.js';\nimport ngeoMiscDatepickerComponent from 'ngeo/misc/datepickerComponent.js';\nimport ngeoMiscDebounce from 'ngeo/misc/debounce.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscFile from 'ngeo/misc/File.js';\nimport ngeoMiscFilereaderComponent from 'ngeo/misc/filereaderComponent.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport ngeoMiscGetBrowserLanguage from 'ngeo/misc/getBrowserLanguage.js';\nimport ngeoMiscSortableComponent from 'ngeo/misc/sortableComponent.js';\nimport ngeoMiscTime from 'ngeo/misc/Time.js';\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMiscExtraModule', [\n  ngeoMiscAutoProjection.module.name,\n  ngeoMiscBtnComponent.name,\n  ngeoMiscControlComponent.name,\n  ngeoMiscDatepickerComponent.name,\n  ngeoMiscDebounce.name,\n  ngeoMiscEventHelper.module.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscFile.module.name,\n  ngeoMiscFilereaderComponent.name,\n  ngeoMiscFilters.name,\n  ngeoMiscGetBrowserLanguage.name,\n  ngeoMiscSortableComponent.name,\n  ngeoMiscTime.module.name,\n  ngeoMiscToolActivateMgr.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.query.mapQueryComponent\n */\n/** @suppress {extraRequire} */\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\n\nimport * as olEvents from 'ol/events.js';\n\nconst exports = angular.module('ngeoMapQuery', [\n  ngeoQueryMapQuerent.module.name,\n]);\n\n\n/**\n * Provides a \"map query\" directive.\n *\n * This directive is responsible of binding a map and the ngeo query service\n * together. While active, clicks made on the map are listened by the directive\n * and a request gets issued to the query service.\n *\n * This directive doesn't require to be rendered in a visible DOM element, but\n * it could be used with a ngeo-btn to manage the activation of the directive.\n * See below an example without any use of UI:\n *\n * Example:\n *\n *      <span\n *        ngeo-map-query=\"\"\n *        ngeo-map-query-map=\"::ctrl.map\"\n *        ngeo-map-query-active=\"ctrl.queryActive\"\n *        ngeo-map-query-autoclear=\"ctrl.queryAutoClear\">\n *      </span>\n *\n * See our live example: [../examples/mapquery.html](../examples/mapquery.html)\n *\n * @param {ngeo.query.MapQuerent} ngeoMapQuerent The ngeo map querent service.\n * @param {angular.$injector} $injector Main injector.\n * @return {angular.Directive} The Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoMapQuery\n */\nexports.directive_ = function(ngeoMapQuerent, $injector) {\n  return {\n    restrict: 'A',\n    scope: false,\n    link: (scope, elem, attrs) => {\n      const map = scope.$eval(attrs['ngeoMapQueryMap']);\n      let clickEventKey_ = null;\n      let pointerMoveEventKey_ = null;\n\n      /**\n       * Called when the map is clicked while this controller is active. Issue\n       * a request to the query service using the coordinate that was clicked.\n       * @param {ol.MapBrowserEvent} evt The map browser event being fired.\n       */\n      const handleMapClick_ = function(evt) {\n        const coordinate = evt.coordinate;\n        ngeoMapQuerent.issue({\n          coordinate,\n          map\n        });\n      };\n\n      /**\n       * Called when the pointer is moved while this controller is active.\n       * Change the mouse pointer when hovering a non-transparent pixel on the\n       * map.\n       * @param {ol.MapBrowserEvent} evt The map browser event being fired.\n       */\n      const handlePointerMove_ = function(evt) {\n        if (!evt.dragging) {\n          const pixel = map.getEventPixel(evt.originalEvent);\n          const queryable = function(layer) {\n            const visible = layer.get('visible');\n            const sourceids = layer.get('querySourceIds');\n            return visible && !!sourceids;\n          };\n          const hit = map.forEachLayerAtPixel(pixel, () => true, undefined, queryable);\n          map.getTargetElement().style.cursor = hit ? 'pointer' : '';\n        }\n      };\n\n      /**\n       * Listen to the map events.\n       */\n      const activate_ = function() {\n        clickEventKey_ = olEvents.listen(map, 'singleclick', handleMapClick_);\n        const queryOptions = /** @type {ngeox.QueryOptions} */ (\n          $injector.has('ngeoQueryOptions') ? $injector.get('ngeoQueryOptions') : {}\n        );\n        if (queryOptions.cursorHover) {\n          pointerMoveEventKey_ = olEvents.listen(map, 'pointermove', handlePointerMove_);\n        }\n      };\n\n      /**\n       * Unlisten the map events.\n       */\n      const deactivate_ = function() {\n        if (clickEventKey_ !== null) {\n          olEvents.unlistenByKey(clickEventKey_);\n          clickEventKey_ = null;\n        }\n        if (pointerMoveEventKey_ !== null) {\n          olEvents.unlistenByKey(pointerMoveEventKey_);\n          pointerMoveEventKey_ = null;\n        }\n        if (scope.$eval(attrs['ngeoMapQueryAutoclear']) !== false) {\n          ngeoMapQuerent.clear();\n        }\n      };\n\n      // watch 'active' property -> activate/deactivate accordingly\n      scope.$watch(attrs['ngeoMapQueryActive'],\n        (newVal, oldVal) => {\n          if (newVal) {\n            activate_();\n          } else {\n            deactivate_();\n          }\n        }\n      );\n    }\n  };\n};\n\nexports.directive('ngeoMapQuery', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.statemanager.WfsPermalink\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olExtent from 'ol/extent.js';\nimport * as olFormatFilter from 'ol/format/filter.js';\nimport olFormatWFS from 'ol/format/WFS.js';\n\n/**\n * WFS permalink service that can be used to load features with a WFS\n * GetFeature request given query parameters.\n *\n * Resulting features are then highlighted and\n * the map is zoomed to the nearest map extent.\n *\n * Parameters:\n *\n * - ``wfs_layer`` tells what layer will be queried\n * - ``wfs_showFeatures`` (boolean) tells if the features should be\n *   highlighted and listed (when true) or if the map should only be\n *   recentered on the features (when false). Default is true.\n * - other parameters will be considered as WFS attribute/values filters and\n *   must be of the form:\n *   ``wfs_<layer attribute name>=<a comma-separated list of values>``\n *\n * Example:\n * http://example.com?wfs_layer=parcels&wfs_city=Oslo&wfs_number=12,34,56\n * will load parcels #12, 34 and 56 of the city of Oslo.\n *\n * It is possible to define several groups of filtering parameters by:\n *\n * - adding a ``wfs_ngroups`` parameter telling how many groups are defined\n * - prefixing all filtering parameters by the number of each group,\n *   starting at 0. For instance ``wfs_0_<layer attribute name>``\n *\n * Example:\n * http://example.com?wfs_layer=parcels&wfs_ngroups=2\n * &wfs_0_city=Oslo&wfs_0_number=12,34,56&wfs_1_city=Paris&wfs_1_number=78,90\n * will load parcels #12, 34 and 56 of the city of Oslo as well as\n * parcels #78 and 90 of the city of Paris.\n *\n * @constructor\n * @struct\n * @param {angular.$http} $http Angular $http service.\n * @param {ngeox.QueryResult} ngeoQueryResult The ngeo query result service.\n * @param {ngeox.WfsPermalinkOptions} ngeoWfsPermalinkOptions The options to\n *     configure the ngeo wfs permalink service with.\n * @ngdoc service\n * @ngname ngeoWfsPermalink\n * @ngInject\n */\nconst WfsPermalinkService = function($http, ngeoQueryResult, ngeoWfsPermalinkOptions) {\n\n  const options = ngeoWfsPermalinkOptions;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.url_ = options.url;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.maxFeatures_ = options.maxFeatures !== undefined ? options.maxFeatures : 50;\n\n  /**\n   * @type {Object<string, ngeox.WfsType>}\n   * @private\n   */\n  this.wfsTypes_ = {};\n\n  googAsserts.assertArray(options.wfsTypes, 'wfsTypes is not correctly set');\n  options.wfsTypes.forEach((wfsType) => {\n    this.wfsTypes_[wfsType.featureType] = wfsType;\n  });\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.defaultFeatureNS_ = options.defaultFeatureNS;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.defaultFeaturePrefix_ = options.defaultFeaturePrefix;\n\n  /**\n   * @type {number|undefined}\n   * @private\n   */\n  this.pointRecenterZoom_ = options.pointRecenterZoom;\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {ngeox.QueryResult}\n   * @private\n   */\n  this.result_ = ngeoQueryResult;\n};\n\n\n/**\n * Clear the results.\n * @export\n */\nWfsPermalinkService.prototype.clear = function() {\n  this.clearResult_();\n};\n\n\n/**\n * Build a WFS GetFeature request for the given query parameter data, send the\n * request and add the received features to {@link ngeox.QueryResult}.\n *\n * @param {ngeox.WfsPermalinkData} queryData Query data for the WFS request.\n * @param {ol.Map} map The ol3 map object to get the current projection from.\n * @export\n */\nWfsPermalinkService.prototype.issue = function(queryData, map) {\n  googAsserts.assert(this.url_,\n    'url is not set. to use the wfs permalink service, ' +\n      'set the value `ngeoWfsPermalinkOptions`');\n  this.clearResult_();\n\n  const typeName = queryData.wfsType;\n  if (!this.wfsTypes_.hasOwnProperty(typeName)) {\n    return;\n  }\n  const wfsType = this.wfsTypes_[typeName];\n\n  const filters = this.createFilters_(queryData.filterGroups);\n  if (filters === null) {\n    return;\n  }\n\n  this.issueRequest_(wfsType, filters, map, queryData.showFeatures);\n};\n\n\n/**\n * @param {ngeox.WfsType} wfsType Type.\n * @param {ol.format.filter.Filter} filter Filter.\n * @param {ol.Map} map The ol3 map object to get the current projection from.\n * @param {boolean} showFeatures Show features or only zoom to feature extent?\n * @private\n */\nWfsPermalinkService.prototype.issueRequest_ = function(wfsType, filter, map, showFeatures) {\n  const wfsFormat = new olFormatWFS();\n  const featureRequestXml = wfsFormat.writeGetFeature({\n    srsName: map.getView().getProjection().getCode(),\n    featureNS: (wfsType.featureNS !== undefined) ?\n      wfsType.featureNS : this.defaultFeatureNS_,\n    featurePrefix: (wfsType.featurePrefix !== undefined) ?\n      wfsType.featurePrefix : this.defaultFeaturePrefix_,\n    featureTypes: [wfsType.featureType],\n    outputFormat: 'GML3',\n    filter: filter,\n    maxFeatures: this.maxFeatures_\n  });\n\n  const featureRequest = new XMLSerializer().serializeToString(featureRequestXml);\n  const config = {\n    headers: {'Content-Type': 'text/xml; charset=UTF-8'}\n  };\n  this.$http_.post(this.url_, featureRequest, config).then((response) => {\n    const features = wfsFormat.readFeatures(response.data);\n    if (features.length == 0) {\n      return;\n    }\n\n    // zoom to features\n    const size = map.getSize();\n    if (size !== undefined) {\n      const maxZoom = this.pointRecenterZoom_;\n      const padding = [10, 10, 10, 10];\n      map.getView().fit(this.getExtent_(features), {size, maxZoom, padding});\n    }\n\n    // then show if requested\n    if (showFeatures) {\n      const resultSource = /** @type {ngeox.QueryResultSource} */ ({\n        'features': features,\n        'id': wfsType.featureType,\n        'identifierAttributeField': wfsType.label,\n        'label': wfsType.featureType,\n        'pending': false\n      });\n\n      this.result_.sources.push(resultSource);\n      this.result_.total = features.length;\n    }\n  });\n};\n\n\n/**\n * @param {Array.<ol.Feature>} features Features.\n * @return {ol.Extent} The extent of all features.\n * @private\n */\nWfsPermalinkService.prototype.getExtent_ = function(features) {\n  return features.reduce((extent, feature) => olExtent.extend(extent, feature.getGeometry().getExtent()), olExtent.createEmpty());\n};\n\n/**\n * Create OGC filters for the filter groups extracted from the query params.\n *\n * @param {Array.<ngeox.WfsPermalinkFilterGroup>} filterGroups Filter groups.\n * @return {ol.format.filter.Filter} OGC filters.\n * @private\n */\nWfsPermalinkService.prototype.createFilters_ = function(filterGroups) {\n  if (filterGroups.length == 0) {\n    return null;\n  }\n  const f = olFormatFilter;\n  const createFiltersForGroup = function(filterGroup) {\n    const filters = filterGroup.filters.map((filterDef) => {\n      const condition = filterDef.condition;\n      if (Array.isArray(condition)) {\n        return WfsPermalinkService.or_(condition.map(cond => f.equalTo(filterDef.property, cond)));\n      } else {\n        return f.equalTo(filterDef.property, filterDef.condition);\n      }\n    });\n    return WfsPermalinkService.and_(filters);\n  };\n  return WfsPermalinkService.or_(filterGroups.map(createFiltersForGroup));\n};\n\n\n/**\n * Join a list of filters with `and(...)`.\n *\n * @param {Array.<ol.format.filter.Filter>} filters The filters to join.\n * @return {ol.format.filter.Filter} The joined filters.\n * @private\n */\nWfsPermalinkService.and_ = function(filters) {\n  return WfsPermalinkService.joinFilters_(filters, olFormatFilter.and);\n};\n\n\n/**\n * Join a list of filters with `or(...)`.\n *\n * @param {Array.<ol.format.filter.Filter>} filters The filters to join.\n * @return {ol.format.filter.Filter} The joined filters.\n * @private\n */\nWfsPermalinkService.or_ = function(filters) {\n  return WfsPermalinkService.joinFilters_(filters, olFormatFilter.or);\n};\n\n\n/**\n * Join a list of filters with a given join function.\n *\n * @param {Array.<ol.format.filter.Filter>} filters The filters to join.\n * @param {function(!ol.format.filter.Filter, !ol.format.filter.Filter):\n *    ol.format.filter.Filter} joinFn The function to join two filters.\n * @return {ol.format.filter.Filter} The joined filters.\n * @private\n */\nWfsPermalinkService.joinFilters_ = function(filters, joinFn) {\n  return filters.reduce((combinedFilters, currentFilter) => {\n    if (combinedFilters === null) {\n      return currentFilter;\n    } else {\n      googAsserts.assert(currentFilter !== null);\n      return joinFn(combinedFilters, currentFilter);\n    }\n  }, null);\n};\n\n\n/**\n * Clear every features for all result sources and reset the total counter\n * as well.\n * @private\n */\nWfsPermalinkService.prototype.clearResult_ = function() {\n  this.result_.total = 0;\n  this.result_.sources.forEach((source) => {\n    source.features.length = 0;\n  });\n};\n\n\n/**\n * @type {!angular.Module}\n */\nWfsPermalinkService.module = angular.module('ngeoWfsPermalink', [\n  // FIXME add dependencies\n]);\n\n\n/**\n * Value that is supposed to be set in applications to enable the WFS\n * permalink functionality.\n */\nWfsPermalinkService.module.value('ngeoWfsPermalinkOptions',\n  /** @type {ngeox.WfsPermalinkOptions} */ ({\n    url: '',\n    wfsTypes: [],\n    defaultFeatureNS: '',\n    defaultFeaturePrefix: ''\n  })\n);\n\n\nWfsPermalinkService.module.service('ngeoWfsPermalink', WfsPermalinkService);\n\n\nexport default WfsPermalinkService;\n","/**\n * @module gmf.controllers.AbstractAppController\n */\nimport 'jquery';\nimport 'angular';\nimport 'angular-gettext';\nimport 'angular-dynamic-locale';\nimport gmfAuthenticationModule from 'gmf/authentication/module.js';\n\nimport gmfBackgroundlayerselectorComponent from 'gmf/backgroundlayerselector/component.js';\nimport gmfDatasourceModule from 'gmf/datasource/module.js';\nimport gmfDisclaimerComponent from 'gmf/disclaimer/component.js';\nimport gmfFiltersModule from 'gmf/filters/module.js';\nimport gmfLayertreeModule from 'gmf/layertree/module.js';\nimport gmfMapModule from 'gmf/map/module.js';\nimport gmfQueryExtraModule from 'gmf/query/extraModule.js';\nimport gmfSearchModule from 'gmf/search/module.js';\nimport gmfThemeModule from 'gmf/theme/module.js';\nimport ngeoMessageDisplaywindowComponent from 'ngeo/message/displaywindowComponent.js';\nimport ngeoMiscExtraModule from 'ngeo/misc/extraModule.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\nimport ngeoQueryMapQueryComponent from 'ngeo/query/mapQueryComponent.js';\nimport ngeoStatemanagerModule from 'ngeo/statemanager/module.js';\nimport ngeoStatemanagerWfsPermalink from 'ngeo/statemanager/WfsPermalink.js';\nimport googAsserts from 'goog/asserts.js';\nimport * as olArray from 'ol/array.js';\nimport * as olEvents from 'ol/events.js';\nimport olMap from 'ol/Map.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport gmfThemeManager from 'gmf/theme/Manager.js';\n\n/**\n * Application abstract controller.\n *\n * This file includes `goog.require` for base components/directives used\n * by the HTML page and the controller to provide the configuration.\n *\n * @param {gmfx.Config} config A part of the application config.\n * @param {angular.Scope} $scope Scope.\n * @param {angular.$injector} $injector Main injector.\n * @constructor\n * @ngdoc controller\n * @ngInject\n * @export\n */\nconst exports = function(config, $scope, $injector) {\n\n  /**\n   * Location service\n   * @type {ngeo.statemanager.Location}\n   */\n  this.ngeoLocation = $injector.get('ngeoLocation');\n  if (this.ngeoLocation.hasParam('debug')) {\n    // make the injector globally available\n    window.injector = $injector;\n  }\n\n  googAsserts.assertInstanceof(this.map, olMap);\n\n  /**\n   * Ngeo FeatureHelper service\n   * @type {ngeo.misc.FeatureHelper}\n   */\n  const ngeoFeatureHelper = $injector.get('ngeoFeatureHelper');\n  ngeoFeatureHelper.setProjection(googAsserts.assert(this.map.getView().getProjection()));\n\n  /**\n   * @type {gmf.theme.Manager}\n   * @export\n   */\n  this.gmfThemeManager = $injector.get('gmfThemeManager');\n\n  /**\n   * @type {gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = $injector.get('gmfTreeManager');\n\n  /**\n   * Themes service\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = $injector.get('gmfThemes');\n\n  /**\n   * Permalink service\n   * @type {gmf.permalink.Permalink}\n   * @private\n   */\n  this.permalink_ = $injector.get('gmfPermalink');\n\n  /**\n   * Authentication service\n   * @type {gmf.authentication.Service}\n   */\n  const gmfAuthentication = $injector.get('gmfAuthenticationService');\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.hasEditableLayers = false;\n\n  /**\n   * @private\n   */\n  this.updateHasEditableLayers_ = function() {\n    this.gmfThemes_.hasEditableLayers().then((hasEditableLayers) => {\n      this.hasEditableLayers = hasEditableLayers;\n    });\n  };\n\n  /**\n   * Url to redirect to after login success.\n   * @type {?string}\n   */\n  this.loginRedirectUrl = null;\n\n  /**\n   * Information message for the login form.\n   * @type {?string}\n   */\n  this.loginInfoMessage = null;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.userMustChangeItsPassword = false;\n\n  $scope.$on('authenticationrequired', (event, args) => {\n    /** @type {angularGettext.Catalog} */\n    const gettextCatalog = $injector.get('gettextCatalog');\n    this.loginInfoMessage = gettextCatalog.getString(\n      'Some layers in this link are not accessible to unauthenticated users. ' +\n      'Please log in to see whole data.');\n    this.loginRedirectUrl = args.url;\n    this.loginActive = true;\n\n    const unbind = $scope.$watch(() => this.loginActive, () => {\n      if (!this.loginActive) {\n        this.loginInfoMessage = null;\n        this.loginRedirectUrl = null;\n        unbind();\n      }\n    });\n  });\n\n  /**\n   * @param {gmfx.AuthenticationEvent} evt Event.\n   */\n  const userChange = (evt) => {\n    if (this.loginRedirectUrl) {\n      window.location = this.loginRedirectUrl;\n      return;\n    }\n    const user = evt.detail.user;\n    const roleId = (user.username !== null) ? user.role_id : undefined;\n\n    const functionalities = this.gmfUser.functionalities;\n\n    // Enable filter tool in toolbar\n    if (functionalities &&\n        'filterable_layers' in functionalities &&\n        functionalities['filterable_layers'].length > 0) {\n      this.filterSelectorEnabled = true;\n    }\n\n    // Open filter panel if 'open_panel' is set in functionalities and\n    // has 'layer_filter' as first value\n    this.gmfThemes_.getThemesObject().then((themes) => {\n      if (functionalities &&\n          functionalities.open_panel &&\n          functionalities.open_panel[0] === 'layer_filter') {\n        this.filterSelectorActive = true;\n      }\n    });\n\n    // Reload theme when login status changes.\n    const previousThemeName = this.gmfThemeManager.getThemeName();\n    this.gmfThemeManager.setThemeName('', true);\n\n    // Reload themes and background layer when login status changes.\n    this.gmfThemes_.loadThemes(roleId);\n\n    if (evt.type !== 'ready') {\n      const themeName = this.permalink_.defaultThemeNameFromFunctionalities();\n      this.gmfThemeManager.updateCurrentTheme(themeName, previousThemeName, true);\n    }\n    this.setDefaultBackground_(null);\n    this.updateHasEditableLayers_();\n  };\n\n  olEvents.listen(gmfAuthentication, 'ready', userChange);\n  olEvents.listen(gmfAuthentication, 'login', userChange);\n  olEvents.listen(gmfAuthentication, 'logout', userChange);\n\n  /**\n   * @type {Array.<gmfx.SearchComponentDatasource>}\n   * @export\n   */\n  this.searchDatasources = [{\n    labelKey: 'label',\n    groupValues: /** @type {Array.<string>} **/ ($injector.get('gmfSearchGroups')),\n    groupActions: /** @type {Array.<string>} **/ ($injector.get('gmfSearchActions')),\n    projection: `EPSG:${config.srid || 21781}`,\n    url: /** @type {string} **/ ($injector.get('fulltextsearchUrl'))\n  }];\n\n  /**\n   * @type {!Object.<string, string>}\n   * @export\n   */\n  this.dimensions = {};\n\n  // watch any change on dimensions object to refresh the url\n  this.permalink_.setDimensions(this.dimensions);\n\n  // Injecting the gmfDataSourcesManager service creates the data sources\n  const gmfDataSourcesManager = $injector.get('gmfDataSourcesManager');\n  // Init the datasources with our map.\n  gmfDataSourcesManager.setDatasourceMap(this.map);\n  // Give the dimensions to the gmfDataSourcesManager\n  gmfDataSourcesManager.setDimensions(this.dimensions);\n\n  if ($injector.has('gmfDefaultDimensions')) {\n    // Set defaults\n    const defaultDimensions = $injector.get('gmfDefaultDimensions');\n    for (const dim in defaultDimensions) {\n      if (this.dimensions[dim] === undefined) {\n        this.dimensions[dim] = defaultDimensions[dim];\n      }\n    }\n  }\n\n  /**\n   * @type {ngeo.map.BackgroundLayerMgr}\n   * @private\n   */\n  this.backgroundLayerMgr_ = $injector.get('ngeoBackgroundLayerMgr');\n\n  // watch any change on dimensions object to refresh the background layer\n  $scope.$watchCollection(() => this.dimensions, () => {\n    this.backgroundLayerMgr_.updateDimensions(this.map, this.dimensions);\n  });\n\n  this.backgroundLayerMgr_.on('change', () => {\n    this.backgroundLayerMgr_.updateDimensions(this.map, this.dimensions);\n  });\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.leftNavVisible = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.rightNavVisible = false;\n\n  const queryFill = new olStyleFill({color: [255, 170, 0, 0.6]});\n  const queryStroke = new olStyleStroke({color: [255, 170, 0, 1], width: 2});\n\n  /**\n   * FeatureStyle used by the gmf.query.windowComponent\n   * @type {ol.style.Style}\n   * @export\n   */\n  this.queryFeatureStyle = new olStyleStyle({\n    fill: queryFill,\n    image: new olStyleCircle({\n      fill: queryFill,\n      radius: 5,\n      stroke: queryStroke\n    }),\n    stroke: queryStroke\n  });\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.filterSelectorEnabled = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.filterSelectorActive = false;\n\n  /**\n   * The active state of the ngeo query directive.\n   * @type {boolean}\n   * @export\n   */\n  this.queryActive = true;\n\n  /**\n   * Set the clearing of the ngeoQuery after the deactivation of the query\n   * @type {boolean}\n   * @export\n   */\n  this.queryAutoClear = true;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.printPanelActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.printActive = false;\n\n  /**\n   * @type {ngeo.query.MapQuerent}\n   * @private\n   */\n  this.ngeoMapQuerent_ = $injector.get('ngeoMapQuerent');\n\n  // Don't deactivate ngeoQuery on print activation\n  $scope.$watch(() => this.printPanelActive, (newVal) => {\n    // Clear queries if another panel is open but not if user go back to the\n    // map form the print.\n    if (!newVal && !this.queryActive) {\n      this.ngeoMapQuerent_.clear();\n    }\n    this.queryAutoClear = !newVal;\n    this.printActive = newVal;\n  });\n\n  /**\n   * The active state of the directive responsible of point measurements.\n   * @type {boolean}\n   * @export\n   */\n  this.measurePointActive = false;\n\n  /**\n   * The active state of the directive responsible of length measurements.\n   * @type {boolean}\n   * @export\n   */\n  this.measureLengthActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.drawFeatureActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.drawProfilePanelActive = false;\n\n  /**\n   * @type {gmfx.User}\n   * @export\n   */\n  this.gmfUser = $injector.get('gmfUser');\n  $scope.$watch(\n    () => this.gmfUser.is_password_changed,\n    (value) => {\n      this.userMustChangeItsPassword = value === false;\n    }\n  );\n\n  /**\n   * @type {ngeox.miscGetBrowserLanguage}\n   */\n  this.getBrowserLanguage = $injector.get('ngeoGetBrowserLanguage');\n\n  /**\n   * @type {ngeo.statemanager.Service}\n   */\n  this.stateManager = $injector.get('ngeoStateManager');\n\n  /**\n   * @type {tmhDynamicLocale}\n   */\n  this.tmhDynamicLocale = $injector.get('tmhDynamicLocale');\n\n  /**\n   * @type {angular.Scope}\n   */\n  this.$scope = $scope;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.lang;\n\n  /**\n   * Default language\n   * @type {string}\n   */\n  this.defaultLang = $injector.get('defaultLang');\n\n  /**\n   * Languages URL\n   * @type {!Object.<string, string>}\n   */\n  this.langUrls = $injector.get('langUrls');\n\n  /**\n   * The gettext catalog\n   * @type {angularGettext.Catalog}\n   */\n  this.gettextCatalog = $injector.get('gettextCatalog');\n\n  this.initLanguage();\n\n  const mapTools = 'mapTools';\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.mapToolsGroup = mapTools;\n\n  /**\n   * The ngeo feature overlay manager service\n   * @type {ngeo.map.FeatureOverlayMgr}\n   */\n  const ngeoFeatureOverlayMgr = $injector.get('ngeoFeatureOverlayMgr');\n  ngeoFeatureOverlayMgr.init(this.map);\n\n  /**\n   * The ngeo ToolActivate manager service.\n   * @type {ngeo.misc.ToolActivateMgr}\n   */\n  const ngeoToolActivateMgr = $injector.get('ngeoToolActivateMgr');\n\n  const queryToolActivate = new ngeoMiscToolActivate(this, 'queryActive');\n  ngeoToolActivateMgr.registerTool(mapTools, queryToolActivate, true);\n\n  const measurePointActivate = new ngeoMiscToolActivate(this, 'measurePointActive');\n  ngeoToolActivateMgr.registerTool(mapTools, measurePointActivate, false);\n\n  const measureLengthActivate = new ngeoMiscToolActivate(this, 'measureLengthActive');\n  ngeoToolActivateMgr.registerTool(mapTools, measureLengthActivate, false);\n\n  const drawFeatureActivate = new ngeoMiscToolActivate(this, 'drawFeatureActive');\n  ngeoToolActivateMgr.registerTool(mapTools, drawFeatureActivate, false);\n\n  const drawProfilePanelActivate = new ngeoMiscToolActivate(this, 'drawProfilePanelActive');\n  ngeoToolActivateMgr.registerTool(mapTools, drawProfilePanelActivate, false);\n\n  const printPanelActivate = new ngeoMiscToolActivate(this, 'printPanelActive');\n  ngeoToolActivateMgr.registerTool(mapTools, printPanelActivate, false);\n\n  $scope.$root.$on(gmfThemeManager.EventType.THEME_NAME_SET, (event, name) => {\n    this.gmfThemes_.getThemeObject(name).then((theme) => {\n      this.setDefaultBackground_(theme);\n    });\n  });\n\n  /**\n   * @param {boolean} skipPermalink If True, don't use permalink\n   * background layer.\n   * @private\n   */\n  this.updateCurrentBackgroundLayer_ = function(skipPermalink) {\n    this.gmfThemes_.getBgLayers().then((layers) => {\n      let background;\n      if (!skipPermalink) {\n        // get the background from the permalink\n        background = this.permalink_.getBackgroundLayer(layers);\n      }\n      if (!background) {\n        // get the background from the user settings\n        const functionalities = this.gmfUser.functionalities;\n        if (functionalities) {\n          const defaultBasemapArray = functionalities.default_basemap;\n          if (defaultBasemapArray.length > 0) {\n            const defaultBasemapLabel = defaultBasemapArray[0];\n            background = olArray.find(layers, layer => layer.get('label') === defaultBasemapLabel);\n          }\n        }\n      }\n      if (!background && layers[1]) {\n        // fallback to the layers list, use the second one because the first\n        // is the blank layer\n        background = layers[1];\n      }\n\n      if (background) {\n        this.backgroundLayerMgr_.set(this.map, background);\n      }\n    });\n  }.bind(this);\n\n  this.updateCurrentBackgroundLayer_(false);\n\n  // Static \"not used\" functions should be in the window because otherwise\n  // closure remove them. \"export\" tag doesn't work on static function below,\n  // we \"export\" them as externs in the gmfx options file.\n  const gmfx = window.gmfx || {};\n  /**\n   * @export\n   */\n  window.gmfx = gmfx;\n\n  /**\n   * Static function to create a popup with an iframe.\n   * @param {string} url an url.\n   * @param {string} title (text).\n   * @param {number=} opt_width CSS width.\n   * @param {number=} opt_height CSS height.\n   * @param {boolean=} opt_apply If true, trigger the Angular digest loop. Default to true.\n   * @export\n   */\n  gmfx.openIframePopup = (\n    url, title, opt_width, opt_height, opt_apply\n  ) => {\n    this.displaywindowUrl = url;\n    gmfx.openPopup_(title, opt_width, opt_height, opt_apply);\n  };\n\n  /**\n   * Static function to create a popup with html content.\n   * @param {string} content (text or html).\n   * @param {string} title (text).\n   * @param {number=} opt_width CSS width in pixel.\n   * @param {number=} opt_height CSS height in pixel.\n   * @param {boolean=} opt_apply If true, trigger the Angular digest loop. Default to true.\n   * @export\n   */\n  gmfx.openTextPopup = (\n    content, title, opt_width, opt_height, opt_apply\n  ) => {\n    this.displaywindowContent = content;\n    gmfx.openPopup_(title, opt_width, opt_height, opt_apply);\n  };\n\n  /**\n   * @param {string} title (text).\n   * @param {number=} opt_width CSS width in pixel.\n   * @param {number=} opt_height CSS height in pixel.\n   * @param {boolean=} opt_apply If true, trigger the Angular digest loop. Default to true.\n   */\n  gmfx.openPopup_ = (title, opt_width, opt_height, opt_apply) => {\n\n    this.displaywindowTitle = title;\n    this.displaywindowOpen = true;\n\n    if (opt_width) {\n      this.displaywindowWidth = `${opt_width}px`;\n    }\n    if (opt_height) {\n      this.displaywindowHeight = `${opt_height}px`;\n    }\n    if (opt_apply !== false) {\n      this.$scope.$apply();\n    }\n  };\n\n  /**\n   * Whether to update the size of the map on browser window resize.\n   * @type {boolean}\n   * @export\n   */\n  this.manageResize = false;\n\n  /**\n   * The duration (milliseconds) of the animation that may occur on the div\n   * containing the map. Used to smoothly resize the map while the animation\n   * is in progress.\n   * @type {number|undefined}\n   * @export\n   */\n  this.resizeTransition;\n\n  const cgxp = window.cgxp || {};\n  /**\n   * @export\n   */\n  window.cgxp = cgxp;\n  /**\n   * @export\n   */\n  cgxp.tools = window.cgxp.tools || {};\n  /**\n   * Static function to create a popup with an iframe.\n   * @param {string} url an url.\n   * @param {string} title (text).\n   * @param {number=} opt_width CSS width in pixel.\n   * @param {number=} opt_height CSS height in pixel.\n   * @param {boolean=} opt_apply If true, trigger the Angular digest loop. Default to true.\n   * @export\n   */\n  cgxp.tools.openInfoWindow = function(url, title, opt_width, opt_height, opt_apply) {\n    gmfx.openIframePopup(url, title, opt_width, opt_height, opt_apply);\n  };\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.displaywindowContent = null;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.displaywindowDraggableContainment = '.gmf-map';\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.displaywindowHeight = '50vh';\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.displaywindowOpen = false;\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.displaywindowTitle = null;\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.displaywindowUrl = null;\n\n  /**\n   * @type {?string}\n   * @export\n   */\n  this.displaywindowWidth = '50vw';\n};\n\n\n/**\n * @param {Array.<ol.layer.Base>} layers Layers list.\n * @param {Array.<string>} labels default_basemap list.\n * @return {ol.layer.Base} layer or null\n */\nexports.getLayerByLabels = function(layers, labels) {\n  if (labels && labels.length > 0) {\n    return olArray.find(layers, layer => layer.get('label') === labels[0]);\n  }\n  return null;\n};\n\n\n/**\n * @param {string} lang Language code.\n * @export\n */\nexports.prototype.switchLanguage = function(lang) {\n  googAsserts.assert(lang in this.langUrls);\n  this.gettextCatalog.setCurrentLanguage(lang);\n  this.gettextCatalog.loadRemote(this.langUrls[lang]);\n  this.tmhDynamicLocale.set(lang);\n  this.lang = lang;\n};\n\n\n/**\n */\nexports.prototype.initLanguage = function() {\n  this.$scope.$watch(() => this.lang, (newValue) => {\n    this.stateManager.updateState({\n      'lang': newValue\n    });\n  });\n\n  const browserLanguage = /** @type {string|undefined} */\n      (this.getBrowserLanguage(Object.keys(this.langUrls)));\n  const urlLanguage = /** @type {string|undefined} */\n      (this.stateManager.getInitialValue('lang'));\n\n  if (urlLanguage !== undefined && urlLanguage in this.langUrls) {\n    this.switchLanguage(urlLanguage);\n    return;\n  } else if (browserLanguage !== undefined && browserLanguage in this.langUrls) {\n    this.switchLanguage(browserLanguage);\n    return;\n  } else {\n    // if there is no information about language preference,\n    // fallback to default language\n\n    this.switchLanguage(this.defaultLang);\n    return;\n  }\n};\n\n\n/**\n * @param {gmfThemes.GmfTheme} theme Theme.\n * @private\n */\nexports.prototype.setDefaultBackground_ = function(theme) {\n  this.gmfThemes_.getBgLayers().then((layers) => {\n    let layer;\n\n    // get the background from the permalink\n    layer = this.permalink_.getBackgroundLayer(layers);\n\n    if (!layer && this.gmfUser.functionalities) {\n      // get the background from the user settings\n      layer = exports.getLayerByLabels(layers, this.gmfUser.functionalities.default_basemap);\n    }\n\n    if (!layer && theme) {\n      // get the background from the theme\n      layer = exports.getLayerByLabels(layers, theme.functionalities.default_basemap);\n    }\n\n    if (!layer) {\n      // fallback to the layers list, use the second one because the first is the blank layer.\n      layer = layers[layers.length > 1 ? 1 : 0];\n    }\n\n    googAsserts.assert(layer);\n    this.backgroundLayerMgr_.set(this.map, layer);\n  });\n};\n\n\n/**\n * @protected\n * @return {Element} Span element with font-awesome inside of it\n */\nexports.prototype.getLocationIcon = function() {\n  const arrow = document.createElement('span');\n  arrow.className = 'fa fa-location-arrow';\n  arrow.style.transform = 'rotate(-0.82rad)';\n  const arrowWrapper = document.createElement('span');\n  arrowWrapper.appendChild(arrow);\n  return arrowWrapper;\n};\n\n\nexports.module = angular.module('GmfAbstractAppControllerModule', [\n  'gettext',\n  'tmh.dynamicLocale',\n  gmfAuthenticationModule.name,\n  gmfBackgroundlayerselectorComponent.name,\n  gmfDatasourceModule.name,\n  gmfDisclaimerComponent.name,\n  gmfFiltersModule.name,\n  gmfLayertreeModule.name,\n  gmfMapModule.name,\n  gmfQueryExtraModule.name,\n  gmfSearchModule.name,\n  gmfThemeModule.name,\n  ngeoMessageDisplaywindowComponent.name,\n  ngeoMiscExtraModule.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoQueryMapQuerent.module.name,\n  ngeoQueryMapQueryComponent.name,\n  ngeoStatemanagerModule.name,\n  ngeoStatemanagerWfsPermalink.module.name,\n]);\n\n\nexports.module.controller('AbstractController', exports);\n\n\nexports.module.value('ngeoExportFeatureFormats', [\n  ngeoMiscFeatureHelper.FormatType.KML,\n  ngeoMiscFeatureHelper.FormatType.GPX\n]);\n\nexports.module.config(['tmhDynamicLocaleProvider', 'angularLocaleScript',\n  /**\n   * @param {tmhDynamicLocaleProvider} tmhDynamicLocaleProvider angular-dynamic-locale provider.\n   * @param {string} angularLocaleScript the script.\n   */\n  function(tmhDynamicLocaleProvider, angularLocaleScript) {\n    // configure the script URL\n    tmhDynamicLocaleProvider.localeLocationPattern(angularLocaleScript);\n  }\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.ModifyCircle\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoInteractionCommon from 'ngeo/interaction/common.js';\nimport ngeoInteractionMeasureAzimut from 'ngeo/interaction/MeasureAzimut.js';\nimport * as olBase from 'ol/index.js';\nimport olFeature from 'ol/Feature.js';\nimport olMapBrowserPointerEvent from 'ol/MapBrowserPointerEvent.js';\nimport * as olCoordinate from 'ol/coordinate.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olExtent from 'ol/extent.js';\nimport olGeomCircle from 'ol/geom/Circle.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport {fromCircle} from 'ol/geom/Polygon.js';\nimport olInteractionPointer, {handleEvent as pointerHandleEvent} from 'ol/interaction/Pointer.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olStructsRBush from 'ol/structs/RBush.js';\n\n/**\n * @classdesc\n * Interaction for modifying feature geometries.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Pointer}\n * @param {olx.interaction.ModifyOptions} options Options.\n * @fires ngeo.interaction.ModifyCircleEvent\n * @api\n */\nconst exports = function(options) {\n\n  googAsserts.assert(options.features);\n\n  olInteractionPointer.call(this, {\n    handleDownEvent: exports.handleDownEvent_,\n    handleDragEvent: exports.handleDragEvent_,\n    handleEvent: exports.handleEvent,\n    handleUpEvent: exports.handleUpEvent_\n  });\n\n  /**\n   * Editing vertex.\n   * @type {ol.Feature}\n   * @private\n   */\n  this.vertexFeature_ = null;\n\n  /**\n   * @type {ol.Pixel}\n   * @private\n   */\n  this.lastPixel_ = [0, 0];\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.modified_ = false;\n\n  /**\n   * Segment RTree for each layer\n   * @type {ol.structs.RBush.<ol.ModifySegmentDataType>}\n   * @private\n   */\n  this.rBush_ = new olStructsRBush();\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.pixelTolerance_ = options.pixelTolerance !== undefined ?\n    options.pixelTolerance : 10;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.snappedToVertex_ = false;\n\n  /**\n   * Indicate whether the interaction is currently changing a feature's\n   * coordinates.\n   * @type {boolean}\n   * @private\n   */\n  this.changingFeature_ = false;\n\n  /**\n   * @type {Array}\n   * @private\n   */\n  this.dragSegments_ = null;\n\n  /**\n   * Draw overlay where sketch features are drawn.\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.overlay_ = new olLayerVector({\n    source: new olSourceVector({\n      useSpatialIndex: false,\n      wrapX: !!options.wrapX\n    }),\n    style: options.style || ngeoInteractionCommon.getDefaultModifyStyleFunction(),\n    updateWhileAnimating: true,\n    updateWhileInteracting: true\n  });\n\n  /**\n   * @type {!ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features_ = options.features;\n\n  this.features_.forEach(feature => this.addFeature_(feature));\n  olEvents.listen(this.features_, 'add', this.handleFeatureAdd_, this);\n  olEvents.listen(this.features_, 'remove', this.handleFeatureRemove_, this);\n\n};\n\nolBase.inherits(exports, olInteractionPointer);\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addFeature_ = function(feature) {\n  if (feature.getGeometry().getType() === 'Polygon' &&\n      !!feature.get(ngeoFormatFeatureProperties.IS_CIRCLE)) {\n    const geometry = /** @type {ol.geom.Polygon}*/ (feature.getGeometry());\n    this.writeCircleGeometry_(feature, geometry);\n\n    const map = this.getMap();\n    if (map) {\n      this.handlePointerAtPixel_(this.lastPixel_, map);\n    }\n  }\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Map browser event\n * @private\n */\nexports.prototype.willModifyFeatures_ = function(evt) {\n  if (!this.modified_) {\n    this.modified_ = true;\n    /** @type {ngeox.ModifyEvent} */\n    const event = new ngeoCustomEvent('modifystart', {features: this.features_});\n    this.dispatchEvent(event);\n  }\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeature_ = function(feature) {\n  this.removeFeatureSegmentData_(feature);\n  // Remove the vertex feature if the collection of canditate features\n  // is empty.\n  if (this.vertexFeature_ && this.features_.getLength() === 0) {\n    this.overlay_.getSource().removeFeature(this.vertexFeature_);\n    this.vertexFeature_ = null;\n  }\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeatureSegmentData_ = function(feature) {\n  const rBush = this.rBush_;\n  const /** @type {Array.<ol.ModifySegmentDataType>} */ nodesToRemove = [];\n  rBush.forEach(\n    /**\n       * @param {ol.ModifySegmentDataType} node RTree node.\n       */\n    (node) => {\n      if (feature === node.feature) {\n        nodesToRemove.push(node);\n      }\n    });\n  for (let i = nodesToRemove.length - 1; i >= 0; --i) {\n    rBush.remove(nodesToRemove[i]);\n  }\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n  this.overlay_.setMap(map);\n  olInteractionPointer.prototype.setMap.call(this, map);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureAdd_ = function(evt) {\n  const feature = evt.element;\n  googAsserts.assertInstanceof(feature, olFeature,\n    'feature should be an ol.Feature');\n  this.addFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature_(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature\n * @param {ol.geom.Polygon} geometry Geometry.\n * @private\n */\nexports.prototype.writeCircleGeometry_ = function(feature, geometry) {\n  const rings = geometry.getCoordinates();\n  let coordinates, i, ii, j, jj, segment, segmentData;\n  for (j = 0, jj = rings.length; j < jj; ++j) {\n    coordinates = rings[j];\n    for (i = 0, ii = coordinates.length - 1; i < ii; ++i) {\n      segment = coordinates.slice(i, i + 2);\n      segmentData = /** @type {ol.ModifySegmentDataType} */ ({\n        feature: feature,\n        geometry: geometry,\n        depth: [j],\n        index: i,\n        segment: segment\n      });\n      this.rBush_.insert(olExtent.boundingExtent(segment), segmentData);\n    }\n  }\n};\n\n\n/**\n * @param {ol.Coordinate} coordinates Coordinates.\n * @return {ol.Feature} Vertex feature.\n * @private\n */\nexports.prototype.createOrUpdateVertexFeature_ = function(coordinates) {\n  let vertexFeature = this.vertexFeature_;\n  if (!vertexFeature) {\n    vertexFeature = new olFeature(new olGeomPoint(coordinates));\n    this.vertexFeature_ = vertexFeature;\n    this.overlay_.getSource().addFeature(vertexFeature);\n  } else {\n    const geometry = /** @type {ol.geom.Point} */ (vertexFeature.getGeometry());\n    geometry.setCoordinates(coordinates);\n  }\n  return vertexFeature;\n};\n\n\n/**\n * @param {ol.ModifySegmentDataType} a The first segment data.\n * @param {ol.ModifySegmentDataType} b The second segment data.\n * @return {number} The difference in indexes.\n * @private\n */\nexports.compareIndexes_ = function(a, b) {\n  return a.index - b.index;\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Start drag sequence?\n * @this {ngeo.interaction.ModifyCircle}\n * @private\n */\nexports.handleDownEvent_ = function(evt) {\n  this.handlePointerAtPixel_(evt.pixel, evt.map);\n  this.dragSegments_ = [];\n  this.modified_ = false;\n  const vertexFeature = this.vertexFeature_;\n  if (vertexFeature) {\n    const geometry = /** @type {ol.geom.Point} */ (vertexFeature.getGeometry());\n    const vertex = geometry.getCoordinates();\n    const vertexExtent = olExtent.boundingExtent([vertex]);\n    const segmentDataMatches = this.rBush_.getInExtent(vertexExtent);\n    const componentSegments = {};\n    segmentDataMatches.sort(exports.compareIndexes_);\n    for (let i = 0, ii = segmentDataMatches.length; i < ii; ++i) {\n      const segmentDataMatch = segmentDataMatches[i];\n      const segment = segmentDataMatch.segment;\n      let uid = olBase.getUid(segmentDataMatch.feature);\n      const depth = segmentDataMatch.depth;\n      if (depth) {\n        uid += `-${depth.join('-')}`; // separate feature components\n      }\n      if (!componentSegments[uid]) {\n        componentSegments[uid] = new Array(2);\n      }\n      if (olCoordinate.equals(segment[0], vertex) &&\n          !componentSegments[uid][0]) {\n        this.dragSegments_.push([segmentDataMatch, 0]);\n        componentSegments[uid][0] = segmentDataMatch;\n      } else if (olCoordinate.equals(segment[1], vertex) &&\n          !componentSegments[uid][1]) {\n        this.dragSegments_.push([segmentDataMatch, 1]);\n        componentSegments[uid][1] = segmentDataMatch;\n      }\n    }\n  }\n  return !!this.vertexFeature_;\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @this {ngeo.interaction.ModifyCircle}\n * @private\n */\nexports.handleDragEvent_ = function(evt) {\n  this.willModifyFeatures_(evt);\n  const vertex = evt.coordinate;\n  const geometry = /** @type {ol.geom.Polygon}*/ (this.dragSegments_[0][0].geometry);\n  const center = olExtent.getCenter(geometry.getExtent());\n\n  const line = new olGeomLineString([center, vertex]);\n\n\n  /**\n   * @type {ol.geom.Circle}\n   */\n  const circle = new olGeomCircle(center, line.getLength());\n  const coordinates = fromCircle(circle, 64).getCoordinates();\n  this.setGeometryCoordinates_(geometry, coordinates);\n\n\n  const azimut = ngeoInteractionMeasureAzimut.getAzimut(line);\n  this.features_.getArray()[0].set(ngeoFormatFeatureProperties.AZIMUT, azimut);\n\n  this.createOrUpdateVertexFeature_(vertex);\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Stop drag sequence?\n * @this {ngeo.interaction.ModifyCircle}\n * @private\n */\nexports.handleUpEvent_ = function(evt) {\n  this.rBush_.clear();\n  this.writeCircleGeometry_(this.dragSegments_[0][0].feature,\n    this.dragSegments_[0][0].geometry);\n\n  if (this.modified_) {\n    /** @type {ngeox.ModifyEvent} */\n    const event = new ngeoCustomEvent('modifyend', {features: this.features_});\n    this.dispatchEvent(event);\n    this.modified_ = false;\n  }\n  return false;\n};\n\n\n/**\n * Handles the {@link ol.MapBrowserEvent map browser event} and may modify the\n * geometry.\n * @param {ol.MapBrowserEvent} mapBrowserEvent Map browser event.\n * @return {boolean} `false` to stop event propagation.\n * @this {ngeo.interaction.ModifyCircle}\n * @api\n */\nexports.handleEvent = function(mapBrowserEvent) {\n  if (!(mapBrowserEvent instanceof olMapBrowserPointerEvent)) {\n    return true;\n  }\n\n  let handled;\n  if (!mapBrowserEvent.map.getView().getInteracting() &&\n      mapBrowserEvent.type == 'pointermove' && !this.handlingDownUpSequence) {\n    this.handlePointerMove_(mapBrowserEvent);\n  }\n\n  return pointerHandleEvent.call(this, mapBrowserEvent) &&\n      !handled;\n};\n\n\n/**\n * @param {ol.MapBrowserEvent} evt Event.\n * @private\n */\nexports.prototype.handlePointerMove_ = function(evt) {\n  this.lastPixel_ = evt.pixel;\n  this.handlePointerAtPixel_(evt.pixel, evt.map);\n};\n\n\n/**\n * @param {ol.Pixel} pixel Pixel\n * @param {ol.PluggableMap} map Map.\n * @private\n */\nexports.prototype.handlePointerAtPixel_ = function(pixel, map) {\n  const pixelCoordinate = map.getCoordinateFromPixel(pixel);\n  const sortByDistance = function(a, b) {\n    return olCoordinate.squaredDistanceToSegment(pixelCoordinate, a.segment) -\n        olCoordinate.squaredDistanceToSegment(pixelCoordinate, b.segment);\n  };\n\n  const lowerLeft = map.getCoordinateFromPixel(\n    [pixel[0] - this.pixelTolerance_, pixel[1] + this.pixelTolerance_]);\n  const upperRight = map.getCoordinateFromPixel(\n    [pixel[0] + this.pixelTolerance_, pixel[1] - this.pixelTolerance_]);\n  const box = olExtent.boundingExtent([lowerLeft, upperRight]);\n\n  const rBush = this.rBush_;\n  const nodes = rBush.getInExtent(box);\n  if (nodes.length > 0) {\n    nodes.sort(sortByDistance);\n    const node = nodes[0];\n    const closestSegment = node.segment;\n    let vertex = (olCoordinate.closestOnSegment(pixelCoordinate,\n      closestSegment));\n    const vertexPixel = map.getPixelFromCoordinate(vertex);\n    if (Math.sqrt(olCoordinate.squaredDistance(pixel, vertexPixel)) <=\n        this.pixelTolerance_) {\n      const pixel1 = map.getPixelFromCoordinate(closestSegment[0]);\n      const pixel2 = map.getPixelFromCoordinate(closestSegment[1]);\n      const squaredDist1 = olCoordinate.squaredDistance(vertexPixel, pixel1);\n      const squaredDist2 = olCoordinate.squaredDistance(vertexPixel, pixel2);\n      const dist = Math.sqrt(Math.min(squaredDist1, squaredDist2));\n      this.snappedToVertex_ = dist <= this.pixelTolerance_;\n      if (this.snappedToVertex_) {\n        vertex = squaredDist1 > squaredDist2 ?\n          closestSegment[1] : closestSegment[0];\n        this.createOrUpdateVertexFeature_(vertex);\n        const vertexSegments = {};\n        vertexSegments[olBase.getUid(closestSegment)] = true;\n        let segment;\n        for (let i = 1, ii = nodes.length; i < ii; ++i) {\n          segment = nodes[i].segment;\n          if ((olCoordinate.equals(closestSegment[0], segment[0]) &&\n              olCoordinate.equals(closestSegment[1], segment[1]) ||\n              (olCoordinate.equals(closestSegment[0], segment[1]) &&\n              olCoordinate.equals(closestSegment[1], segment[0])))) {\n            vertexSegments[olBase.getUid(segment)] = true;\n          } else {\n            break;\n          }\n        }\n        return;\n      }\n    }\n  }\n  if (this.vertexFeature_) {\n    this.overlay_.getSource().removeFeature(this.vertexFeature_);\n    this.vertexFeature_ = null;\n  }\n};\n\n\n/**\n * @param {ol.geom.SimpleGeometry} geometry Geometry.\n * @param {Array} coordinates Coordinates.\n * @private\n */\nexports.prototype.setGeometryCoordinates_ = function(geometry, coordinates) {\n  this.changingFeature_ = true;\n  geometry.setCoordinates(coordinates);\n  this.changingFeature_ = false;\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.ModifyRectangle\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoInteractionCommon from 'ngeo/interaction/common.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olEvents from 'ol/events.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olInteractionPointer from 'ol/interaction/Pointer.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\n\n/**\n * @classdesc\n * Interaction for modifying feature geometries.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Pointer}\n * @param {olx.interaction.ModifyOptions} options Options.\n * @fires ngeo.interaction.ModifyCircleEvent\n * @api\n */\nconst exports = function(options) {\n\n  googAsserts.assert(options.features);\n\n  olInteractionPointer.call(this, {\n    handleDownEvent: this.handleDown_,\n    handleDragEvent: this.handleDrag_,\n    handleUpEvent: this.handleUp_\n  });\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.modified_ = false;\n\n  /**\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.vectorPoints_ = new olLayerVector({\n    source: new olSourceVector({\n      wrapX: !!options.wrapX\n    }),\n    visible: this.getActive(),\n    style: options.style || ngeoInteractionCommon.getDefaultModifyStyleFunction(),\n    updateWhileAnimating: true,\n    updateWhileInteracting: true\n  });\n\n  /**\n   * @type {!ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features_ = options.features;\n\n  /**\n   * The feature currently modified.\n   * @type {ol.Feature}\n   * @private\n   */\n  this.feature_ = null;\n\n  /**\n   * @type {Object.<number, ngeo.interaction.ModifyRectangle.CacheItem>}\n   * @private\n   */\n  this.cache_ = {};\n\n  /**\n   * @type {?ngeo.interaction.ModifyRectangle.ModifyParams}\n   * @private\n   */\n  this.params_ = null;\n\n  olEvents.listen(this.features_, 'add', this.handleFeatureAdd_, this);\n  olEvents.listen(this.features_, 'remove', this.handleFeatureRemove_, this);\n\n  this.features_.forEach((feature) => {\n    this.addFeature_(feature);\n  });\n\n};\n\nolBase.inherits(exports, olInteractionPointer);\n\n\n/**\n * @param {boolean} active Active.\n * @override\n */\nexports.prototype.setActive = function(active) {\n  olInteractionPointer.prototype.setActive.call(this, active);\n  if (this.vectorPoints_) {\n    this.vectorPoints_.setVisible(active);\n  }\n};\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addFeature_ = function(feature) {\n  const featureGeom = feature.getGeometry();\n  if (featureGeom instanceof olGeomPolygon) {\n\n    // If the feature's corners are already set, no need to set them again\n    const uid = olBase.getUid(feature);\n    let item = this.cache_[uid];\n    if (item) {\n      return;\n    }\n\n    const pointSource = this.vectorPoints_.getSource();\n\n    // from each corners, create a point feature and add it to the point layer.\n    // each point is then associated with 2 siblings in order to update the\n    // siblings geometry at the same time when a point gets dragged around.\n    // mark each one as 'corner'\n    const corners = featureGeom.getCoordinates()[0];\n    while (corners.length > 4) {\n      if (corners[0][0] < corners[1][0] && corners[0][1] <= corners[1][1]) {\n        corners.pop();\n      } else {\n        corners.shift();\n      }\n    }\n    const pointFeatures = [];\n    let cornerPoint;\n    let cornerFeature;\n    corners.forEach((corner) => {\n      cornerPoint = new olGeomPoint(corner);\n      cornerFeature = new olFeature({\n        'corner': true,\n        'geometry': cornerPoint,\n        'siblingX': null,\n        'siblingY': null,\n        'boxFeature': feature\n      });\n\n      pointFeatures.push(cornerFeature);\n    }, this);\n    item = /** @type {ngeo.interaction.ModifyRectangle.CacheItem} */ ({\n      corners: pointFeatures\n    });\n    this.cache_[uid] = item;\n\n    let previousFeature;\n    let nextFeature;\n    pointFeatures.forEach((cornerFeature, index) => {\n      previousFeature = pointFeatures[index - 1];\n      if (!previousFeature) {\n        previousFeature = pointFeatures[pointFeatures.length - 1];\n      }\n\n      nextFeature = pointFeatures[index + 1];\n      if (!nextFeature) {\n        nextFeature = pointFeatures[0];\n      }\n\n      if (index % 2 === 0) {\n        cornerFeature.set('siblingX', nextFeature);\n        cornerFeature.set('siblingY', previousFeature);\n      } else {\n        cornerFeature.set('siblingX', previousFeature);\n        cornerFeature.set('siblingY', nextFeature);\n      }\n\n    }, this);\n    pointSource.addFeatures(pointFeatures);\n  }\n\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Map browser event\n * @private\n */\nexports.prototype.willModifyFeatures_ = function(evt) {\n  if (!this.modified_) {\n    this.modified_ = true;\n    /** @type {ngeox.ModifyEvent} */\n    const event = new ngeoCustomEvent('modifystart', {features: this.features_});\n    this.dispatchEvent(event);\n    this.params_ = this.initializeParams_();\n  }\n};\n\n\n/**\n * @return {ngeo.interaction.ModifyRectangle.ModifyParams} The initialised params\n * @private\n */\nexports.prototype.initializeParams_ = function() {\n  const feature = this.feature_;\n\n  // 1. Find the origin (opposite) point for the modify operation\n  // siblingY relative to the origin is siblingX relative to the opposite\n  const siblingY = feature.get('siblingX');\n  googAsserts.assertInstanceof(siblingY, olFeature);\n\n  const origin = siblingY.get('siblingY');\n  googAsserts.assertInstanceof(origin, olFeature);\n  const originPoint = origin.getGeometry();\n  googAsserts.assertInstanceof(originPoint, olGeomPoint);\n  const originCoordinate = originPoint.getCoordinates();\n  const originPixel = this.getMap().getPixelFromCoordinate(originCoordinate);\n\n  // 2. Find the origin's X sibling and the normal vector from the origin to it\n  const siblingX = origin.get('siblingX');\n  googAsserts.assertInstanceof(siblingX, olFeature);\n  const siblingXPoint = siblingX.getGeometry();\n  googAsserts.assertInstanceof(siblingXPoint, olGeomPoint);\n  const siblingXCoordinate = siblingXPoint.getCoordinates();\n  const siblingXPixel = this.getMap().getPixelFromCoordinate(siblingXCoordinate);\n  let vectorX = [\n    siblingXPixel[0] - originPixel[0],\n    siblingXPixel[1] - originPixel[1]\n  ];\n  const vectorXMagnitude = Math.sqrt(vectorX[0] * vectorX[0] + vectorX[1] * vectorX[1]);\n  vectorX[0] /= vectorXMagnitude;\n  vectorX[1] /= vectorXMagnitude;\n\n  // 3. Find the origin's Y sibling and the normal vector from the origin to it\n  const siblingYPoint = siblingY.getGeometry();\n  googAsserts.assertInstanceof(siblingYPoint, olGeomPoint);\n  const siblingYCoordinate = siblingYPoint.getCoordinates();\n  const siblingYPixel = this.getMap().getPixelFromCoordinate(siblingYCoordinate);\n  let vectorY = [\n    siblingYPixel[0] - originPixel[0],\n    siblingYPixel[1] - originPixel[1]\n  ];\n  const vectorYMagnitude = Math.sqrt(vectorY[0] * vectorY[0] + vectorY[1] * vectorY[1]);\n  vectorY[0] /= vectorYMagnitude;\n  vectorY[1] /= vectorYMagnitude;\n\n  // 4. Validate the vectors.\n  if (isNaN(vectorX[0]) && isNaN(vectorY[0])) {\n    // Both vector are invalid. Rotation information has already been lost\n    vectorX = [0, 1];\n    vectorY = [1, 0];\n  } else if (isNaN(vectorX[0])) {\n    vectorX = [vectorY[1], -vectorY[0]];\n  } else if (isNaN(vectorY[0])) {\n    vectorY = [vectorX[1], -vectorX[0]];\n  }\n\n  return {\n    originCoordinate,\n    originPixel,\n    siblingXPoint,\n    siblingYPoint,\n    vectorX,\n    vectorY\n  };\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeature_ = function(feature) {\n  const uid = olBase.getUid(feature);\n  const item = this.cache_[uid];\n  const corners = item.corners;\n  for (let i = 0; i < corners.length; i++) {\n    this.vectorPoints_.getSource().removeFeature(corners[i]);\n  }\n  this.feature_ = null;\n  corners.length = 0;\n  delete this.cache_[uid];\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n  this.vectorPoints_.setMap(map);\n  olInteractionPointer.prototype.setMap.call(this, map);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureAdd_ = function(evt) {\n  const feature = evt.element;\n  googAsserts.assertInstanceof(feature, olFeature,\n    'feature should be an ol.Feature');\n  this.addFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeatureRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature_(feature);\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Start drag sequence?\n * @this {ngeo.interaction.ModifyRectangle}\n * @private\n */\nexports.prototype.handleDown_ = function(evt) {\n  const map = evt.map;\n\n  const feature = map.forEachFeatureAtPixel(evt.pixel, feature =>\n    (feature.get('siblingX') && feature.get('siblingY') ? feature : undefined)\n  );\n\n  if (feature) {\n    this.feature_ = feature;\n\n    return true;\n  }\n\n  return false;\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @this {ngeo.interaction.ModifyRectangle}\n * @private\n */\nexports.prototype.handleDrag_ = function(evt) {\n  this.willModifyFeatures_(evt);\n  const feature = this.feature_;\n\n  const geometry = /** @type {ol.geom.SimpleGeometry} */\n      (feature.getGeometry());\n\n  if (geometry instanceof olGeomPoint) {\n    geometry.setCoordinates(evt.coordinate);\n\n    const destinationPixel = evt.pixel;\n\n    const originPixel = this.params_.originPixel;\n    const siblingXPoint = this.params_.siblingXPoint;\n    const siblingYPoint = this.params_.siblingYPoint;\n    const vectorX = this.params_.vectorX;\n    const vectorY = this.params_.vectorY;\n    const originCoordinate = this.params_.originCoordinate;\n\n    // Calculate new positions of siblings\n    const b2Pixel = this.calculateNewPixel_(\n      originPixel, destinationPixel, vectorX);\n    const b2Coordinate = this.getMap().getCoordinateFromPixel(b2Pixel);\n    siblingXPoint.setCoordinates(b2Coordinate);\n\n    const c2Pixel = this.calculateNewPixel_(\n      originPixel, destinationPixel, vectorY);\n    const c2Coordinate = this.getMap().getCoordinateFromPixel(c2Pixel);\n    siblingYPoint.setCoordinates(c2Coordinate);\n\n\n    // Resize the box\n    const boxFeature = feature.get('boxFeature');\n    const geom = boxFeature.getGeometry();\n    googAsserts.assertInstanceof(geom, olGeomPolygon);\n    geom.setCoordinates([[evt.coordinate, b2Coordinate, originCoordinate, c2Coordinate, evt.coordinate]]);\n  }\n};\n\n\n/**\n * Calculate the new position of a point as projected on a vector from origin to\n * destination.\n * @param {ol.Pixel} origin Pixel of origin (opposite of the drag handle)\n * @param {ol.Pixel} destination Pixel of destination (the handle we dragged)\n * @param {ol.Pixel} vector The normalized vector to the point\n * @return {ol.Pixel} The new pixel of the point\n * @private\n */\nexports.prototype.calculateNewPixel_ = function(\n  origin, destination, vector) {\n\n  const aVector = [destination[0] - origin[0], destination[1] - origin[1]];\n\n  const abScalarProduct = aVector[0] * vector[0] + aVector[1] * vector[1];\n\n  const deltaVector = [\n    (vector[0] * abScalarProduct),\n    (vector[1] * abScalarProduct)\n  ];\n\n  return [deltaVector[0] + origin[0], deltaVector[1] + origin[1]];\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} evt Event.\n * @return {boolean} Stop drag sequence?\n * @this {ngeo.interaction.ModifyRectangle}\n * @private\n */\nexports.prototype.handleUp_ = function(evt) {\n  if (this.modified_) {\n    /** @type {ngeox.ModifyEvent} */\n    const event = new ngeoCustomEvent('modifyend', {features: this.features_});\n    this.dispatchEvent(event);\n    this.params_ = null;\n    this.modified_ = false;\n  }\n  return false;\n};\n\n\n/**\n * @typedef {{\n *     corners: Array.<ol.Feature>\n * }}\n */\nexports.CacheItem;\n\n\n/**\n * @typedef {{\n *     originCoordinate: ol.Coordinate,\n *     originPixel: ol.Pixel,\n *     siblingXPoint: ol.geom.Point,\n *     siblingYPoint: ol.geom.Point,\n *     vectorX: Array.<number>,\n *     vectorY: Array.<number>\n * }}\n */\nexports.ModifyParams;\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.Modify\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoUtils from 'ngeo/utils.js';\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoInteractionModifyCircle from 'ngeo/interaction/ModifyCircle.js';\nimport ngeoInteractionModifyRectangle from 'ngeo/interaction/ModifyRectangle.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olFunctions from 'ol/functions.js';\nimport olInteractionInteraction from 'ol/interaction/Interaction.js';\nimport olCollection from 'ol/Collection.js';\nimport olInteractionModify from 'ol/interaction/Modify.js';\nimport olFeature from 'ol/Feature.js';\n\n/**\n * This interaction combines multiple kind of feature modification interactions\n * in order to be able to modify vector features depending on their geometry\n * type. The different kind of interactions supported are:\n *\n * - `ol.interaction.Modify`\n * - `ngeo.interaction.ModifyCircle`\n * - `ngeo.interaction.ModifyRectangle`\n *\n * This interaction receives a collection of features. Its job is to listen\n * to added/removed features to and from it and add them in the proper\n * collection that is uniquely used for each inner interaction. Those inner\n * interactions follow the `active` property of this interaction, i.e. when\n * this interaction is activated, so do the inner interactions. Since they will\n * never share the same feature, they don't collide with one an other.\n *\n * @constructor\n * @struct\n * @extends {ol.interaction.Interaction}\n * @param {olx.interaction.ModifyOptions} options Options.\n */\nconst exports = function(options) {\n\n  googAsserts.assert(options.features);\n\n  /**\n   * @type {!ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features_ = options.features;\n\n  /**\n   * @type {!Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {Array.<ol.interaction.Interaction>}\n   * @private\n   */\n  this.interactions_ = [];\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.otherFeatures_ = new olCollection();\n\n  this.interactions_.push(new olInteractionModify({\n    deleteCondition: ngeoUtils.deleteCondition,\n    features: this.otherFeatures_,\n    pixelTolerance: options.pixelTolerance,\n    style: options.style,\n    wrapX: options.wrapX\n  }));\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.circleFeatures_ = new olCollection();\n\n  this.interactions_.push(new ngeoInteractionModifyCircle({\n    features: this.circleFeatures_,\n    pixelTolerance: options.pixelTolerance,\n    style: options.style,\n    wrapX: options.wrapX\n  }));\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.rectangleFeatures_ = new olCollection();\n\n  this.interactions_.push(new ngeoInteractionModifyRectangle({\n    features: this.rectangleFeatures_,\n    pixelTolerance: options.pixelTolerance,\n    style: options.style,\n    wrapX: options.wrapX\n  }));\n\n\n  olInteractionInteraction.call(this, {\n    handleEvent: olFunctions.TRUE\n  });\n\n};\n\nolBase.inherits(exports, olInteractionInteraction);\n\n\n/**\n * Activate or deactivate the interaction.\n * @param {boolean} active Active.\n * @override\n */\nexports.prototype.setActive = function(active) {\n  olInteractionInteraction.prototype.setActive.call(this, active);\n  this.setState_();\n};\n\n\n/**\n * Remove the interaction from its current map and attach it to the new map.\n * Subclasses may set up event handlers to get notified about changes to\n * the map here.\n * @param {ol.PluggableMap} map Map.\n * @override\n */\nexports.prototype.setMap = function(map) {\n\n  const interactions = this.interactions_;\n\n  const currentMap = this.getMap();\n  if (currentMap) {\n    interactions.forEach((interaction) => {\n      currentMap.removeInteraction(interaction);\n    });\n  }\n\n  olInteractionInteraction.prototype.setMap.call(this, map);\n\n  if (map) {\n    interactions.forEach((interaction) => {\n      map.addInteraction(interaction);\n    });\n  }\n\n  this.setState_();\n};\n\n\n/**\n * Toggle interactions.\n * @private\n */\nexports.prototype.setState_ = function() {\n  const map = this.getMap();\n  const active = this.getActive();\n  const interactions = this.interactions_;\n  const keys = this.listenerKeys_;\n\n  interactions.forEach((interaction) => {\n    interaction.setActive(active && !!map);\n  });\n\n  if (active && map) {\n    this.features_.forEach(feature => this.addFeature_(feature));\n    keys.push(\n      olEvents.listen(this.features_, 'add', this.handleFeaturesAdd_, this),\n      olEvents.listen(this.features_, 'remove', this.handleFeaturesRemove_, this)\n    );\n  } else {\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n    this.features_.forEach(feature => this.removeFeature_(feature));\n  }\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeaturesAdd_ = function(evt) {\n  const feature = evt.element;\n  googAsserts.assertInstanceof(feature, olFeature,\n    'feature should be an ol.Feature');\n  this.addFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.prototype.handleFeaturesRemove_ = function(evt) {\n  const feature = /** @type {ol.Feature} */ (evt.element);\n  this.removeFeature_(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addFeature_ = function(feature) {\n  const collection = this.getFeatureCollection_(feature);\n  collection.push(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeFeature_ = function(feature) {\n  const collection = this.getFeatureCollection_(feature);\n  collection.remove(feature);\n};\n\n\n/**\n * @param {ol.Feature} feature Feature.\n * @return {ol.Collection.<ol.Feature>} Collection of features for this feature.\n * @private\n */\nexports.prototype.getFeatureCollection_ = function(feature) {\n  let features;\n  const isCircle = feature.get(ngeoFormatFeatureProperties.IS_CIRCLE);\n  const isRectangle = feature.get(ngeoFormatFeatureProperties.IS_RECTANGLE);\n  if (isCircle === true || isCircle === 'true') {\n    features = this.circleFeatures_;\n  } else if (isRectangle === true || isRectangle === 'true') {\n    features = this.rectangleFeatures_;\n  } else {\n    features = this.otherFeatures_;\n  }\n  return features;\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.Controller\n */\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawFeatures from 'ngeo/draw/features.js';\n\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoMiscBtnComponent from 'ngeo/misc/btnComponent.js';\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport olFeature from 'ol/Feature.js';\nimport {getUid} from 'ol/index.js';\nimport {listen} from 'ol/events.js';\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @param {angular.$sce} $sce Angular sce service.\n * @param {angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n * @param {ngeo.misc.EventHelper} ngeoEventHelper Ngeo event helper service\n * @param {ol.Collection.<ol.Feature>} ngeoFeatures Collection of features.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoDrawfeatureController\n */\nconst exports = function($scope, $sce, gettextCatalog,\n  ngeoFeatureHelper, ngeoEventHelper, ngeoFeatures) {\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  if (this.active === undefined) {\n    this.active = false;\n  }\n\n  /**\n   * Alternate collection of features in which to push the drawn features.\n   * If not defined, then `ngeoFeatures` is used instead.\n   * @type {!ol.Collection.<!ol.Feature>|undefined}\n   * @export\n   */\n  this.features;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.showMeasure;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n  // Fill the string collection\n  gettextCatalog.getString('Point');\n  gettextCatalog.getString('LineString');\n  gettextCatalog.getString('Polygon');\n  gettextCatalog.getString('Circle');\n  gettextCatalog.getString('Rectangle');\n  gettextCatalog.getString('Text');\n\n  /**\n   * @type {ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.featureHelper_ = ngeoFeatureHelper;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.ngeoFeatures_ = ngeoFeatures;\n\n  /**\n   * @type {Array.<ol.interaction.Interaction>}\n   * @private\n   */\n  this.interactions_ = [];\n\n  /**\n   * @type {ol.interaction.Draw}\n   * @export\n   */\n  this.drawPoint;\n\n  /**\n   * @type {ngeo.interaction.MeasureLength}\n   * @export\n   */\n  this.measureLength;\n\n  /**\n   * @type {ngeo.interaction.MeasureArea}\n   * @export\n   */\n  this.measureArea;\n\n  /**\n   * @type {ngeo.interaction.MeasureAzimut}\n   * @export\n   */\n  this.measureAzimut;\n\n  /**\n   * @type {ol.interaction.Draw}\n   * @export\n   */\n  this.drawRectangle;\n\n  /**\n   * @type {ol.interaction.Draw}\n   * @export\n   */\n  this.drawText;\n\n  this.ngeoEventHelper_ = ngeoEventHelper;\n\n  // Watch the \"active\" property, and disable the draw interactions\n  // when \"active\" gets set to false.\n  $scope.$watch(\n    () => this.active,\n    (newVal) => {\n      if (newVal === false) {\n        this.interactions_.forEach((interaction) => {\n          interaction.setActive(false);\n        });\n      }\n    }\n  );\n};\n\n\n/**\n * Called when escape key is pressed to reset drawing.\n * @param {ol.interaction.Draw.Event|ngeox.MeasureEvent} event Event.\n * @export\n */\nexports.prototype.handleEscapeKeyDown_ = function(event) {\n  const escPressed = event.keyCode === 27; // Escape key\n  if (escPressed && this.interaction_.getActive()) {\n    const interaction = this.interaction_;\n    interaction.setActive(false);\n    interaction.setActive(true);\n  }\n};\n\n\n/**\n * Register a draw|measure interaction by setting it inactive, decorating it\n * and adding it to the map\n * @param {ol.interaction.Interaction} interaction Interaction to register.\n * @export\n */\nexports.prototype.registerInteraction = function(\n  interaction) {\n  this.interactions_.push(interaction);\n  interaction.setActive(false);\n  ngeoMiscDecorate.interaction(interaction);\n  this.map.addInteraction(interaction);\n};\n\n\n/**\n * Called when any of the draw or measure interaction active property changes.\n * Set the active property of this directive accordingly, i.e. if at least\n * one of the draw or measure is active then the active property is set to true.\n * @param {ol.Object.Event} event Event.\n * @export\n */\nexports.prototype.handleActiveChange = function(event) {\n  this.active = this.interactions_.some(interaction => interaction.getActive(), this);\n  this.interaction_ = this.interactions_.find(interaction => interaction.getActive() === true);\n  const uid = getUid(this);\n\n  if (this.interaction_) {\n    this.ngeoEventHelper_.addListenerKey(\n      uid,\n      listen(\n        document.body,\n        'keydown',\n        this.handleEscapeKeyDown_,\n        this\n      )\n    );\n  } else {\n    this.ngeoEventHelper_.clearListenerKey(uid);\n  }\n};\n\n\n/**\n * Called when a feature is finished being drawn. Set the default properties\n * for its style, then set its style and add it to the features collection.\n * @param {string} type Type of geometry being drawn.\n * @param {ol.interaction.Draw.Event|ngeox.MeasureEvent} event Event.\n * @export\n */\nexports.prototype.handleDrawEnd = function(type, event) {\n  let sketch;\n  if (event.feature) {\n    // ol.interaction.Draw.Event\n    sketch = event.feature;\n  } else {\n    // ngeox.MeasureEvent\n    sketch = event.detail.feature;\n  }\n  googAsserts.assert(sketch);\n\n  const azimut = sketch.get('azimut');\n\n  const features = this.features || this.ngeoFeatures_;\n\n  const feature = new olFeature(sketch.getGeometry());\n\n  const prop = ngeoFormatFeatureProperties;\n\n  switch (type) {\n    case ngeoGeometryType.CIRCLE:\n      feature.set(prop.IS_CIRCLE, true);\n      if (azimut !== undefined) {\n        feature.set(prop.AZIMUT, azimut);\n      }\n      break;\n    case ngeoGeometryType.TEXT:\n      feature.set(prop.IS_TEXT, true);\n      break;\n    case ngeoGeometryType.RECTANGLE:\n      feature.set(prop.IS_RECTANGLE, true);\n      break;\n    default:\n      break;\n  }\n\n  /**\n   * @type {string}\n   */\n  const name = this.gettextCatalog_.getString(type);\n  feature.set(prop.NAME, `${name} ${features.getLength() + 1}`);\n\n  /**\n   * @type {string}\n   */\n  const color = type !== ngeoGeometryType.TEXT ? '#DB4436' : '#000000';\n  feature.set(prop.COLOR, color);\n\n  feature.set(prop.ANGLE, 0);\n  feature.set(prop.OPACITY, 0.2);\n  feature.set(prop.SHOW_MEASURE, this.showMeasure ? true : false);\n  feature.set(prop.SHOW_LABEL, false);\n  feature.set(prop.SIZE, 10);\n  feature.set(prop.STROKE, 2);\n\n  // set style\n  this.featureHelper_.setStyle(feature);\n\n  // push in collection\n  features.push(feature);\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoDrawfeatureController', [\n  ngeoDrawFeatures.name,\n  ngeoMiscBtnComponent.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscEventHelper.module.name,\n]);\nexports.module.controller('ngeoDrawfeatureController', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.point\n */\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport * as olEvents from 'ol/events.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDrawpoint', []);\n\n\n/**\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawpoint\n */\nexports.directive_ = function() {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const drawPoint = new olInteractionDraw({\n        type: /** @type {ol.geom.GeometryType} */ ('Point')\n      });\n\n      drawFeatureCtrl.registerInteraction(drawPoint);\n      drawFeatureCtrl.drawPoint = drawPoint;\n\n      olEvents.listen(\n        drawPoint,\n        'drawend',\n        drawFeatureCtrl.handleDrawEnd.bind(\n          drawFeatureCtrl, ngeoGeometryType.POINT),\n        drawFeatureCtrl\n      );\n      olEvents.listen(\n        drawPoint,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoDrawpoint', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.rectangle\n */\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport * as olEvents from 'ol/events.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDrawrectangle', []);\n\n\n/**\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawrectangle\n */\nexports.directive_ = function() {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const drawRectangle = new olInteractionDraw({\n        type: /** @type {ol.geom.GeometryType} */ ('LineString'),\n        geometryFunction: (coordinates, geometry) => {\n          if (!geometry) {\n            geometry = new olGeomPolygon(null);\n          }\n          const start = coordinates[0];\n          const end = coordinates[1];\n          geometry.setCoordinates([\n            [start, [start[0], end[1]], end, [end[0], start[1]], start]\n          ]);\n          return geometry;\n        },\n        maxPoints: 2\n      });\n\n      drawFeatureCtrl.registerInteraction(drawRectangle);\n      drawFeatureCtrl.drawRectangle = drawRectangle;\n\n      olEvents.listen(\n        drawRectangle,\n        'drawend',\n        drawFeatureCtrl.handleDrawEnd.bind(\n          drawFeatureCtrl, ngeoGeometryType.RECTANGLE),\n        drawFeatureCtrl\n      );\n      olEvents.listen(\n        drawRectangle,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoDrawrectangle', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.text\n */\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport * as olEvents from 'ol/events.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDrawtext', []);\n\n\n/**\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawtext\n */\nexports.directive_ = function() {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const drawText = new olInteractionDraw({\n        type: /** @type {ol.geom.GeometryType} */ ('Point')\n      });\n\n      drawFeatureCtrl.registerInteraction(drawText);\n      drawFeatureCtrl.drawText = drawText;\n\n      olEvents.listen(\n        drawText,\n        'drawend',\n        drawFeatureCtrl.handleDrawEnd.bind(\n          drawFeatureCtrl, ngeoGeometryType.TEXT),\n        drawFeatureCtrl\n      );\n      olEvents.listen(\n        drawText,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoDrawtext', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.measure.area\n */\nimport ngeoDrawController from 'ngeo/draw/Controller.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionMeasureArea from 'ngeo/interaction/MeasureArea.js';\nimport * as olEvents from 'ol/events.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMeasurearea', [\n  ngeoDrawController.module.name\n]);\n\n\n/**\n * @param {!angular.$compile} $compile Angular compile service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {!angular.$filter} $filter Angular filter\n * @param {!angular.$injector} $injector Main injector.\n * @return {!angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawpoint\n */\nexports.directive_ = function($compile, gettextCatalog, $filter, $injector) {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const helpMsg = gettextCatalog.getString('Click to start drawing polygon');\n      const contMsg = gettextCatalog.getString('Click to continue drawing<br>' +\n          'Double-click or click starting point to finish');\n\n      const measureArea = new ngeoInteractionMeasureArea($filter('ngeoUnitPrefix'), gettextCatalog, {\n        style: new olStyleStyle(),\n        startMsg: $compile(`<div translate>${helpMsg}</div>`)($scope)[0],\n        continueMsg: $compile(`<div translate>${contMsg}</div>`)($scope)[0],\n        precision: $injector.has('ngeoMeasurePrecision') ? $injector.get('ngeoMeasurePrecision') : undefined\n      });\n\n      drawFeatureCtrl.registerInteraction(measureArea);\n      drawFeatureCtrl.measureArea = measureArea;\n\n      olEvents.listen(\n        measureArea,\n        'measureend',\n        drawFeatureCtrl.handleDrawEnd.bind(\n          drawFeatureCtrl, ngeoGeometryType.POLYGON),\n        drawFeatureCtrl\n      );\n      olEvents.listen(\n        measureArea,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoMeasurearea', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.measure.azimut\n */\nimport ngeoDrawController from 'ngeo/draw/Controller.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionMeasureAzimut from 'ngeo/interaction/MeasureAzimut.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport {fromCircle} from 'ol/geom/Polygon.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMeasureazimut', [\n  ngeoDrawController.module.name,\n  ngeoMiscFilters.name,\n]);\n\n\n/**\n * @param {!angular.$compile} $compile Angular compile service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!angular.$filter} $filter Angular filter\n * @param {!angular.$injector} $injector Main injector.\n * @return {!angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawpoint\n */\nexports.directive_ = function($compile, gettextCatalog, $filter, $injector) {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const helpMsg = gettextCatalog.getString('Click to start drawing circle');\n      const contMsg = gettextCatalog.getString('Click to finish');\n\n      const measureAzimut = new ngeoInteractionMeasureAzimut(\n        $filter('ngeoUnitPrefix'), $filter('number'), {\n          style: new olStyleStyle(),\n          startMsg: $compile(`<div translate>${helpMsg}</div>`)($scope)[0],\n          continueMsg: $compile(`<div translate>${contMsg}</div>`)($scope)[0],\n          precision: $injector.has('ngeoMeasurePrecision') ? $injector.get('ngeoMeasurePrecision') : undefined,\n          decimals: $injector.has('ngeoMeasureDecimals') ? $injector.get('ngeoMeasureDecimals') : undefined\n        });\n\n      drawFeatureCtrl.registerInteraction(measureAzimut);\n      drawFeatureCtrl.measureAzimut = measureAzimut;\n\n      olEvents.listen(\n        measureAzimut,\n        'measureend',\n        /**\n         * @param {ngeox.MeasureEvent} event Event.\n         */\n        (event) => {\n          // In the case of azimut measure interaction, the feature's\n          // geometry is actually a collection (line + circle)\n          // For our purpose here, we only need the circle, which gets\n          // transformed into a polygon with 64 sides.\n          const geometry = /** @type {ol.geom.GeometryCollection} */\n                (event.detail.feature.getGeometry());\n          const circle = /** @type {ol.geom.Circle} */ (\n            geometry.getGeometries()[1]);\n          const polygon = fromCircle(circle, 64);\n          event.detail.feature = new olFeature(polygon);\n          const azimut = ngeoInteractionMeasureAzimut.getAzimut(\n            /** @type {ol.geom.LineString} */ (geometry.getGeometries()[0])\n          );\n          event.detail.feature.set('azimut', azimut);\n\n          drawFeatureCtrl.handleDrawEnd(ngeoGeometryType.CIRCLE, event);\n        },\n        drawFeatureCtrl\n      );\n\n      olEvents.listen(\n        measureAzimut,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoMeasureazimut', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.measure.length\n */\nimport ngeoDrawController from 'ngeo/draw/Controller.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionMeasureLength from 'ngeo/interaction/MeasureLength.js';\nimport * as olEvents from 'ol/events.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoMeasurelength', [\n  ngeoDrawController.module.name,\n  ngeoMiscFilters.name,\n]);\n\n\n/**\n * @param {!angular.$compile} $compile Angular compile service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!angular.$filter} $filter Angular filter.\n * @param {!angular.$injector} $injector Main injector.\n * @return {!angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawpoint\n */\nexports.directive_ = function($compile, gettextCatalog, $filter, $injector) {\n  return {\n    restrict: 'A',\n    require: '^^ngeoDrawfeature',\n    /**\n     * @param {!angular.Scope} $scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {ngeo.draw.Controller} drawFeatureCtrl Controller.\n     */\n    link: ($scope, element, attrs, drawFeatureCtrl) => {\n\n      const helpMsg = gettextCatalog.getString('Click to start drawing line');\n      const contMsg = gettextCatalog.getString('Click to continue drawing<br>' +\n          'Double-click or click last point to finish');\n\n      const measureLength = new ngeoInteractionMeasureLength($filter('ngeoUnitPrefix'), gettextCatalog, {\n        style: new olStyleStyle(),\n        startMsg: $compile(`<div translate>${helpMsg}</div>`)($scope)[0],\n        continueMsg: $compile(`<div translate>${contMsg}</div>`)($scope)[0],\n        precision: $injector.has('ngeoMeasurePrecision') ? $injector.get('ngeoMeasurePrecision') : undefined,\n        tolerance: $injector.has('ngeoSnappingTolerance') ? $injector.get('ngeoSnappingTolerance') : undefined,\n        source: $injector.has('ngeoSnappingSource') ? $injector.get('ngeoSnappingSource') : undefined,\n      });\n\n      drawFeatureCtrl.registerInteraction(measureLength);\n      drawFeatureCtrl.measureLength = measureLength;\n\n      olEvents.listen(\n        measureLength,\n        'measureend',\n        drawFeatureCtrl.handleDrawEnd.bind(\n          drawFeatureCtrl, ngeoGeometryType.LINE_STRING),\n        drawFeatureCtrl\n      );\n      olEvents.listen(\n        measureLength,\n        'change:active',\n        drawFeatureCtrl.handleActiveChange,\n        drawFeatureCtrl\n      );\n    }\n  };\n};\n\n\nexports.directive('ngeoMeasurelength', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.draw.component\n */\nimport ngeoDrawController from 'ngeo/draw/Controller.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawPoint from 'ngeo/draw/point.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawRectangle from 'ngeo/draw/rectangle.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawText from 'ngeo/draw/text.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMeasureArea from 'ngeo/measure/area.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMeasureAzimut from 'ngeo/measure/azimut.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMeasureLength from 'ngeo/measure/length.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDrawfeature', [\n  ngeoDrawController.module.name,\n  ngeoDrawPoint.name,\n  ngeoDrawRectangle.name,\n  ngeoDrawText.name,\n  ngeoMeasureArea.name,\n  ngeoMeasureAzimut.name,\n  ngeoMeasureLength.name,\n]);\n\n\n/**\n * Directive used to draw vector features on a map.\n * Example:\n *\n *     <ngeo-drawfeature\n *         ngeo-btn-group\n *         class=\"btn-group\"\n *         ngeo-drawfeature-active=\"ctrl.drawActive\"\n *         ngeo-drawfeature-map=\"::ctrl.map\">\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-drawpoint\n *         class=\"btn btn-default ngeo-drawfeature-point\"\n *         ng-class=\"{active: dfCtrl.drawPoint.active}\"\n *         ng-model=\"dfCtrl.drawPoint.active\"></a>\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-measurelength\n *         class=\"btn btn-default ngeo-drawfeature-linestring\"\n *         ng-class=\"{active: dfCtrl.measureLength.active}\"\n *         ng-model=\"dfCtrl.measureLength.active\"></a>\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-measurearea\n *         class=\"btn btn-default ngeo-drawfeature-polygon\"\n *         ng-class=\"{active: dfCtrl.measureArea.active}\"\n *         ng-model=\"dfCtrl.measureArea.active\"></a>\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-measureazimut\n *         class=\"btn btn-default ngeo-drawfeature-circle\"\n *         ng-class=\"{active: dfCtrl.measureAzimut.active}\"\n *         ng-model=\"dfCtrl.measureAzimut.active\"></a>\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-drawrectangle\n *         class=\"btn btn-default ngeo-drawfeature-rectangle\"\n *         ng-class=\"{active: dfCtrl.drawRectangle.active}\"\n *         ng-model=\"dfCtrl.drawRectangle.active\"></a>\n *       <a\n *         href\n *         translate\n *         ngeo-btn\n *         ngeo-drawtext\n *         class=\"btn btn-default ngeo-drawfeature-text\"\n *         ng-class=\"{active: dfCtrl.drawText.active}\"\n *         ng-model=\"dfCtrl.drawText.active\"></a>\n *     </ngeo-drawfeature>\n *\n * @htmlAttribute {boolean} ngeo-drawfeature-active Whether the directive is\n *     active or not.\n * @htmlAttribute {!ol.Collection=} ngeo-drawfeature-features The features\n *     collection in which to push the drawn features. If none is provided,\n *     then the `ngeoFeatures` collection is used.\n * @htmlAttribute {ol.Map} ngeo-drawfeature-map The map.\n * @htmlAttribute {boolean} ngeo-drawfeature-showmeasure. Checks the\n *      checkbox in order to display the feature measurements as a label.\n *      Default to false.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDrawfeature\n */\nexports.directive_ = function() {\n  return {\n    controller: 'ngeoDrawfeatureController as dfCtrl',\n    scope: true,\n    bindToController: {\n      'active': '=ngeoDrawfeatureActive',\n      'features': '=?ngeoDrawfeatureFeatures',\n      'map': '=ngeoDrawfeatureMap',\n      'showMeasure': '=?ngeoDrawfeatureShowmeasure'\n    }\n  };\n};\n\nexports.directive('ngeoDrawfeature', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.editing.createfeatureComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscFilters from 'ngeo/misc/filters.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoInteractionMeasureArea from 'ngeo/interaction/MeasureArea.js';\nimport ngeoInteractionMeasureLength from 'ngeo/interaction/MeasureLength.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoUtils from 'ngeo/utils.js';\nimport * as olBase from 'ol/index.js';\nimport olCollection from 'ol/Collection.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\nconst exports = angular.module('ngeoCreatefeature', [\n  ngeoMiscEventHelper.module.name,\n  ngeoMiscFilters.name,\n]);\n\n\n/**\n * A directive used to draw vector features of a single geometry type using\n * either a 'draw' or 'measure' interaction. Once a feature is finished being\n * drawn, it is added to a collection of features.\n *\n * The geometry types supported are:\n *  - Point\n *  - LineString\n *  - Polygon\n *\n * Example:\n *\n *     <a\n *       href\n *       translate\n *       ngeo-btn\n *       ngeo-createfeature\n *       ngeo-createfeature-active=\"ctrl.createPointActive\"\n *       ngeo-createfeature-features=\"ctrl.features\"\n *       ngeo-createfeature-geom-type=\"ctrl.pointGeomType\"\n *       ngeo-createfeature-map=\"::ctrl.map\"\n *       class=\"btn btn-default ngeo-createfeature-point\"\n *       ng-class=\"{active: ctrl.createPointActive}\"\n *       ng-model=\"ctrl.createPointActive\">\n *     </a>\n *\n * @htmlAttribute {boolean} ngeo-createfeature-active Whether the directive is\n *     active or not.\n * @htmlAttribute {ol.Collection} ngeo-createfeature-features The collection of\n *     features where to add those created by this directive.\n * @htmlAttribute {string} ngeo-createfeature-geom-type Determines the type\n *     of geometry this directive should draw.\n * @htmlAttribute {ol.Map} ngeo-createfeature-map The map.\n *\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname ngeoCreatefeature\n */\nexports.directive_ = function() {\n  return {\n    controller: 'ngeoCreatefeatureController',\n    bindToController: true,\n    scope: {\n      'active': '=ngeoCreatefeatureActive',\n      'features': '=ngeoCreatefeatureFeatures',\n      'geomType': '=ngeoCreatefeatureGeomType',\n      'map': '=ngeoCreatefeatureMap'\n    }\n  };\n};\n\nexports.directive('ngeoCreatefeature', exports.directive_);\n\n\n/**\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!angular.$compile} $compile Angular compile service.\n * @param {!angular.$filter} $filter Angular filter\n * @param {!angular.$injector} $injector Angular injector service.\n * @param {!angular.Scope} $scope Scope.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!ngeo.misc.EventHelper} ngeoEventHelper Ngeo event helper service\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoCreatefeatureController\n */\nexports.Controller_ = function(gettextCatalog, $compile, $filter, $injector, $scope,\n  $timeout, ngeoEventHelper) {\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  /**\n   * @type {ol.Collection.<!ol.Feature>|!ol.source.Vector}\n   * @export\n   */\n  this.features;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.geomType;\n\n  /**\n   * @type {!ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {!angular.$compile}\n   * @private\n   */\n  this.compile_ = $compile;\n\n  /**\n   * @type {!angular.$filter}\n   * @private\n   */\n  this.filter_ = $filter;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {!angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {!ngeo.misc.EventHelper}\n   * @private\n   */\n  this.ngeoEventHelper_ = ngeoEventHelper;\n\n  /**\n   * @type {!angular.$injector}\n   * @private\n   */\n  this.injector_ = $injector;\n\n  /**\n   * The draw or measure interaction responsible of drawing the vector feature.\n   * The actual type depends on the geometry type.\n   * @type {ol.interaction.Interaction}\n   * @private\n   */\n  this.interaction_;\n\n\n  // == Event listeners ==\n  $scope.$watch(\n    () => this.active,\n    (newVal) => {\n      this.interaction_.setActive(newVal);\n    }\n  );\n};\n\n\n/**\n * Initialize the directive.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.active = this.active === true;\n  const gettextCatalog = this.gettextCatalog_;\n\n  // Create the draw or measure interaction depending on the geometry type\n  let interaction;\n  if (this.geomType === ngeoGeometryType.POINT ||\n      this.geomType === ngeoGeometryType.MULTI_POINT\n  ) {\n    interaction = new olInteractionDraw({\n      type: /** @type {ol.geom.GeometryType} */ ('Point')\n    });\n  } else if (this.geomType === ngeoGeometryType.LINE_STRING ||\n      this.geomType === ngeoGeometryType.MULTI_LINE_STRING\n  ) {\n    const helpMsg = gettextCatalog.getString('Click to start drawing length');\n    const contMsg = gettextCatalog.getString(\n      'Click to continue drawing<br/>' +\n      'Double-click or click last point to finish'\n    );\n\n    interaction = new ngeoInteractionMeasureLength(\n      this.filter_('ngeoUnitPrefix'),\n      gettextCatalog,\n      {\n        style: new olStyleStyle(),\n        startMsg: this.compile_(`<div translate>${helpMsg}</div>`)(this.scope_)[0],\n        continueMsg: this.compile_(`<div translate>${contMsg}</div>`)(this.scope_)[0],\n        tolerance: this.injector_.has('ngeoSnappingTolerance') ? this.injector_.get('ngeoSnappingTolerance') : undefined,\n        source: this.injector_.has('ngeoSnappingSource') ? this.injector_.get('ngeoSnappingSource') : undefined,\n      }\n    );\n  } else if (this.geomType === ngeoGeometryType.POLYGON ||\n      this.geomType === ngeoGeometryType.MULTI_POLYGON\n  ) {\n    const helpMsg = gettextCatalog.getString('Click to start drawing area');\n    const contMsg = gettextCatalog.getString(\n      'Click to continue drawing<br/>' +\n      'Double-click or click starting point to finish'\n    );\n\n    interaction = new ngeoInteractionMeasureArea(\n      this.filter_('ngeoUnitPrefix'),\n      gettextCatalog,\n      {\n        style: new olStyleStyle(),\n        startMsg: this.compile_(`<div translate>${helpMsg}</div>`)(this.scope_)[0],\n        continueMsg: this.compile_(`<div translate>${contMsg}</div>`)(this.scope_)[0]\n      }\n    );\n  }\n\n  googAsserts.assert(interaction);\n\n  interaction.setActive(this.active);\n  this.interaction_ = interaction;\n  this.map.addInteraction(interaction);\n\n  const uid = olBase.getUid(this);\n\n  this.ngeoEventHelper_.addListenerKey(\n    uid,\n    olEvents.listen(\n      document.body,\n      'keydown',\n      this.handleEscapeKeyDown_,\n      this\n    )\n  );\n\n  if (interaction instanceof olInteractionDraw) {\n    this.ngeoEventHelper_.addListenerKey(\n      uid,\n      olEvents.listen(\n        interaction,\n        'drawend',\n        this.handleDrawEnd_,\n        this\n      )\n    );\n  } else if (interaction instanceof ngeoInteractionMeasureLength ||\n     interaction instanceof ngeoInteractionMeasureArea) {\n    this.ngeoEventHelper_.addListenerKey(\n      uid,\n      olEvents.listen(\n        interaction,\n        'measureend',\n        this.handleDrawEnd_,\n        this\n      )\n    );\n  }\n};\n\n/**\n * Called when escape key is pressed to reset drawing.\n * @param {ol.interaction.Draw.Event|ngeox.MeasureEvent} event Event.\n * @export\n */\nexports.Controller_.prototype.handleEscapeKeyDown_ = function(event) {\n  const interaction = this.interaction_;\n  const escPressed = event.keyCode === 27; // Escape key\n  if (escPressed && interaction.getActive()) {\n    interaction.setActive(false);\n    interaction.setActive(true);\n  }\n};\n\n/**\n * Called when a feature is finished being drawn. Add the feature to the\n * collection.\n * @param {ol.interaction.Draw.Event|ngeox.MeasureEvent} event Event.\n * @export\n */\nexports.Controller_.prototype.handleDrawEnd_ = function(event) {\n  let sketch;\n  if (event.feature) {\n    // ol.interaction.Draw.Event\n    sketch = event.feature;\n  } else {\n    // ngeox.MeasureEvent\n    sketch = event.detail.feature;\n  }\n  googAsserts.assert(sketch);\n\n  // convert to multi if geomType is multi and feature is not\n  let geometry = sketch.getGeometry();\n  const type = geometry.getType();\n  if (this.geomType.indexOf('Multi') != type.indexOf('Multi')) {\n    geometry = ngeoUtils.toMulti(geometry);\n  }\n  const feature = new olFeature(geometry);\n  if (this.features instanceof olCollection) {\n    this.features.push(feature);\n  } else {\n    this.features.addFeature(feature);\n  }\n};\n\n\n/**\n * Cleanup event listeners and remove the interaction from the map.\n */\nexports.Controller_.prototype.$onDestroy = function() {\n  this.timeout_(() => {\n    const uid = olBase.getUid(this);\n    this.ngeoEventHelper_.clearListenerKey(uid);\n    this.interaction_.setActive(false);\n    this.map.removeInteraction(this.interaction_);\n  }, 0);\n};\n\nexports.controller('ngeoCreatefeatureController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.editing.XSDAttributes\n */\nimport ngeoFormatXSDAttribute from 'ngeo/format/XSDAttribute.js';\n\n/**\n * An service used to fetch the XSD attribute definition of layers using their\n * id from a GeoMapFish server.\n *\n * @constructor\n * @struct\n * @param {angular.$http} $http Angular http service.\n * @param {string} gmfLayersUrl Url to the GeoMapFish layers service.\n * @ngInject\n */\nconst exports = function($http, gmfLayersUrl) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.http_ = $http;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.baseUrl_ = gmfLayersUrl;\n\n  /**\n   * @type {Object.<number, !angular.$q.Promise>}\n   * @private\n   */\n  this.promises_ = {};\n\n};\n\n\n/**\n * @param {number} id Layer id.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getAttributes = function(id) {\n  if (!this.promises_[id]) {\n    const url = `${this.baseUrl_}/${id}/md.xsd`;\n    this.promises_[id] = this.http_.get(url).then(\n      this.handleGetAttributes_.bind(this));\n  }\n  return this.promises_[id];\n};\n\n/**\n * @param {angular.$http.Response} resp Ajax response.\n * @return {Array.<ngeox.Attribute>} List of attributes.\n * @export\n */\nexports.prototype.handleGetAttributes_ = function(resp) {\n  return new ngeoFormatXSDAttribute().read(resp.data);\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfXSDAttributes', []);\nexports.module.service('gmfXSDAttributes', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.raster.RasterService\n */\n/**\n * The Raster service.\n * Uses the c2cgeoportal's raster to obtain different kinds of\n * information at a specific coordinate.\n * @constructor\n * @struct\n * @param {angular.$http} $http Angular http service.\n * @param {string} gmfRasterUrl URL to a the c2cgeoportal raster service.\n * @ngInject\n * @ngdoc service\n * @ngname gmfRaster\n */\nconst exports = function($http, gmfRasterUrl) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.url_ = gmfRasterUrl;\n};\n\n\n/**\n * @param {ol.Coordinate} coordinate Coordinate.\n * @param {Object=} opt_params Optional parameters for the request.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getRaster = function(coordinate, opt_params) {\n\n  const params = opt_params || {};\n  params[exports.Param.X] = coordinate[0];\n  params[exports.Param.Y] = coordinate[1];\n\n  return this.$http_.get(this.url_, {\n    params\n  }).then(this.handleGetRaster_.bind(this));\n};\n\n\n/**\n * @param {angular.$http.Response} resp Ajax response.\n * @return {Object.<string, number>} The response object.\n * @private\n */\nexports.prototype.handleGetRaster_ = function(resp) {\n  return resp.data;\n};\n\n\n/**\n * @enum {string}\n */\nexports.Param = {\n  X: 'lon',\n  Y: 'lat'\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfRaster', []);\nexports.module.service('gmfRaster', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.proj.somerc\n */\nimport proj4 from 'proj4';\nimport somerc from 'proj4/projections/somerc.js';\n\n\nproj4.Proj.projections.add(somerc);\nconst exports = 'somerc';\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.colorpickerComponent\n */\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoColorpicker', []);\n\n\nexports.value('ngeoColorpickerTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoColorpickerTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/misc/colorpickerComponent';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/misc/colorpickerComponent', require('./colorpickerComponent.html'));\n});\n\n\n/**\n * Provides the \"ngeoColorpicker\" directive, a widget for\n * selecting a color among predefined ones.\n *\n * Example:\n *\n *     <div ngeo-colorpicker=\"ctrl.colors\">\n *     </div>\n *\n *\n * @param {string|function(!angular.JQLite=, !angular.Attributes=)}\n *     ngeoColorpickerTemplateUrl Template URL for the directive.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoColorpicker\n */\nexports.component_ = function(ngeoColorpickerTemplateUrl) {\n  return {\n    restrict: 'A',\n    scope: {\n      colors: '<?ngeoColorpicker',\n      color: '=?ngeoColorpickerColor'\n    },\n    controller: 'NgeoColorpickerController as ctrl',\n    bindToController: true,\n    templateUrl: ngeoColorpickerTemplateUrl\n  };\n};\n\nexports.directive('ngeoColorpicker',\n  exports.component_);\n\n/**\n * Fefault colors for the colorpicker\n * @type {Array.<Array.<string>>}\n * @const\n * @export\n */\nexports.DEFAULT_COLORS = [\n  ['#F4EB37', '#CDDC39', '#62AF44', '#009D57', '#0BA9CC', '#4186F0', '#3F5BA9', '#7C3592', '#A61B4A', '#DB4436', '#F8971B', '#F4B400', '#795046'],\n  ['#F9F7A6', '#E6EEA3', '#B7DBAB', '#7CCFA9', '#93D7E8', '#9FC3FF', '#A7B5D7', '#C6A4CF', '#D698AD', '#EE9C96', '#FAD199', '#FFDD5E', '#B29189'],\n  ['#ffffff', '#CCCCCC', '#777', '#000000']\n];\n\n/**\n * @constructor\n * @private\n * @struct\n * @param {angular.Scope} $scope Directive scope.\n * @param {angular.JQLite} $element Element.\n * @param {angular.Attributes} $attrs Attributes.\n * @ngInject\n * @ngdoc controller\n * @ngname NgeoScaleselectorController\n */\nexports.Controller_ = function($scope, $element, $attrs) {\n\n  /**\n   * The set of color\n   * @type {Array.<Array.<string>>}\n   * @export\n   */\n  this.colors = this.colors || exports.DEFAULT_COLORS;\n\n  /**\n   * The selected color\n   * @type {undefined|string}\n   * @export\n   */\n  this.color;\n};\n\n/**\n * @param {string} color The color to select.\n * @export\n */\nexports.Controller_.prototype.setColor = function(color) {\n  this.color = color;\n};\n\nexports.controller('NgeoColorpickerController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.AutoProjection\n */\nimport * as olProj from 'ol/proj.js';\nimport * as olExtent from 'ol/extent.js';\n\n/**\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoAutoProjection\n */\nconst exports = function() {};\n\n\n/**\n * Parse a string and return a coordinate if the result is valid. Given string\n * must be a two numbers separated by a space.\n * @param {string} str the string to parse.\n * @return {?ol.Coordinate} A coordinate or null if the format is not valid.\n * @export\n */\nexports.prototype.stringToCoordinates = function(str) {\n  const coords = str.match(/([\\d\\.']+)[\\s,]+([\\d\\.']+)/);\n  if (coords) {\n    const x = parseFloat(coords[1].replace('\\'', ''));\n    const y = parseFloat(coords[2].replace('\\'', ''));\n    if (!isNaN(x) && !isNaN(y)) {\n      return [x, y];\n    }\n  }\n  return null;\n};\n\n\n/**\n * Get an array of projections corresponding to their EPSG codes. Log an error\n *     for each code that are not defined in ol projections.\n * @param {Array.<string>} projectionsCodes EPSG codes (e.g. 'EPSG:3857',\n *     'epsg:3857' or '3857').\n * @return {Array.<ol.proj.Projection>} An array of projections.\n * @export\n */\nexports.prototype.getProjectionList = function(projectionsCodes) {\n  let code, proj;\n  const projections = [];\n  projectionsCodes.forEach((projection) => {\n    code = projection.toUpperCase();\n    if (code.substr(0, 5) != 'EPSG:') {\n      code = `EPSG:${code}`;\n    }\n    proj = olProj.get(code);\n    if (proj !== null) {\n      projections.push(proj);\n    } else {\n      console.error(`The projection ${code} is not defined in ol.proj.`);\n    }\n  });\n  return projections;\n};\n\n\n/**\n * It projects the point using the projection array and finds the first one for\n * which it falls inside of the viewProjection extent.\n * @param {ol.Coordinate} coordinates The point to test.\n * @param {ol.Extent} extent Limits in which coordinates can be valid.\n * @param {ol.proj.Projection} viewProjection Target projection the point.\n * @param {Array.<ol.proj.Projection>=} opt_projections optional array of\n *     projections. The point is tested in each projection, in the order of\n *     the array.\n * @return {?ol.Coordinate} A coordinates in the view's projection if it matches\n *     in one of the given projections, or null else.\n * @export\n */\nexports.prototype.tryProjections = function(coordinates,\n  extent, viewProjection, opt_projections) {\n  let position;\n  if (opt_projections === undefined) {\n    opt_projections = [viewProjection];\n  }\n  opt_projections.some((projection) => {\n    try {\n      position = olProj.transform(coordinates, projection, viewProjection);\n      if (olExtent.containsCoordinate(extent, position)) {\n        return true;\n      }\n    } catch (e) {\n      // Wrong coordinate leads to a transform error and ol throw an exception that we won't log.\n    }\n    position = null;\n  });\n  return position;\n};\n\n\n/**\n * Same as AutoProjection.tryProjections but if tryProjections return null,\n * re-call it with coordinates in reverse order.\n * @param {ol.Coordinate} coordinates The point to test.\n * @param {ol.Extent} extent Limits in which coordinates can be valid.\n * @param {ol.proj.Projection} viewProjection Target projection the point.\n * @param {Array.<ol.proj.Projection>=} opt_projections optional array of\n *     projections. The point is tested in each projection, in the order of\n *     the array.\n * @return {?ol.Coordinate} A coordinates in the view's projection if it matches\n *     in one of the given projections, or null else.\n * @export\n */\nexports.prototype.tryProjectionsWithInversion = function(\n  coordinates, extent, viewProjection, opt_projections) {\n  let position = this.tryProjections(coordinates, extent, viewProjection,\n    opt_projections);\n  if (position === null) {\n    position = this.tryProjections(coordinates.reverse(), extent,\n      viewProjection, opt_projections);\n  }\n  return position;\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoAutoProjection', []);\nexports.module.service('ngeoAutoProjection', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.search.FulltextSearch\n */\nimport ngeoUtils from 'ngeo/utils.js';\n\n/**\n * Provides the c2c-geoportal full-text search.\n * @param {angular.$injector} $injector Main injector.\n * @param {angular.$http} $http Angular http service.\n * @constructor\n * @struct\n * @ngInject\n * @export\n * @ngname gmfFulltextSearch\n */\nconst exports = function($injector, $http) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.url_ = /** @type {string} **/ ($injector.get('fulltextsearchUrl'));\n\n  const url = this.url_.split('?');\n  /**\n   * @type {string}\n   * @private\n   */\n  this.baseUrl_ = url[0];\n\n  const queryString = (url.length == 2) ? `?${url[1]}` : '';\n  /**\n   * @type {Object.<string, string>}\n   * @private\n   */\n  this.defaultParams_ = ngeoUtils.decodeQueryString(queryString);\n};\n\n/**\n * Perform a search query on the c2c-geoportal full-text search.\n * @param {string} query Search query.\n * @param {Object.<string, string>} params Additional parameters.\n * @returns {Promise} Request promise with data array.\n */\nexports.prototype.search = function(query, params) {\n  const queryParams = Object.assign({}, this.defaultParams_, params);\n\n  queryParams['query'] = query;\n\n  const url = `${this.baseUrl_}?${ngeoUtils.encodeQueryString(queryParams)}`;\n\n  return new Promise((resolve, reject) => {\n    this.$http_.get(url)\n      .then(resp => resolve(resp['data']))\n      .catch(reject);\n  });\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfSearchFulltextSearch', []);\nexports.module.service('gmfSearchFulltextSearch', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.download.Csv\n */\nimport ngeoDownloadService from 'ngeo/download/service.js';\n\n/**\n * Service to generate and download a CSV file from tabular data.\n * Column headers are translated using {@link angularGettext.Catalog}.\n *\n * @param {angular.$injector} $injector Main injector.\n * @param {angularGettext.Catalog} gettextCatalog Gettext service.\n * @constructor\n * @struct\n * @ngdoc service\n * @ngname ngeoCsvDownload\n * @ngInject\n */\nconst exports = function($injector, gettextCatalog) {\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * File extension of the CSV file.\n   * @type {string}\n   * @private\n   */\n  this.encoding_ = $injector.has('ngeoCsvEncoding') ?\n    $injector.get('ngeoCsvEncoding') : 'utf-8';\n\n  /**\n   * File extension of the CSV file.\n   * @type {string}\n   * @private\n   */\n  this.extension_ = $injector.has('ngeoCsvExtension') ?\n    $injector.get('ngeoCsvExtension') : '.csv';\n\n  /**\n   * Whether to include the header in the exported file or not.\n   * @type {boolean}\n   * @private\n   */\n  this.includeHeader_ = $injector.has('ngeoCsvIncludeHeader') ?\n    $injector.get('ngeoCsvIncludeHeader') : true;\n\n  /**\n   * Quote character.\n   * @type {string}\n   * @private\n   */\n  this.quote_ = $injector.has('ngeoCsvQuote') ?\n    $injector.get('ngeoCsvQuote') : '\"';\n\n  /**\n   * Separator character.\n   * @type {string}\n   * @private\n   */\n  this.separator_ = $injector.has('ngeoCsvSeparator') ?\n    $injector.get('ngeoCsvSeparator') : ',';\n\n  /**\n   * Download service.\n   * @type {ngeox.Download}\n   * @private\n   */\n  this.download_ = $injector.get('ngeoDownload');\n};\n\n\n/**\n * Generate a CSV.\n *\n * @param {Array.<Object>} data Entries/objects to include in the CSV.\n * @param {Array.<ngeox.GridColumnDef>} columnDefs Column definitions.\n * @return {string} The CSV file as string.\n * @export\n */\nexports.prototype.generateCsv = function(data, columnDefs) {\n  if (data.length == 0 || columnDefs.length == 0) {\n    return '';\n  }\n\n  const translatedColumnHeaders = columnDefs.map(columnHeader => this.gettextCatalog_.getString(columnHeader.name));\n\n  const header = this.getRow_(translatedColumnHeaders);\n  const dataRows = data.map((values) => {\n    const rowValues = columnDefs.map(columnHeader => values[columnHeader.name]);\n    return this.getRow_(rowValues);\n  });\n\n  return this.includeHeader_ ? header + dataRows.join('') : dataRows.join('');\n};\n\n\n/**\n * @param {Array.<?>} values Values.\n * @return {string} CSV row.\n * @private\n */\nexports.prototype.getRow_ = function(values) {\n  const matchAllQuotesRegex = new RegExp(this.quote_, 'g');\n  const doubleQuote = this.quote_ + this.quote_;\n\n  const rowValues = values.map((value) => {\n    if (value !== undefined && value !== null) {\n      value = `${value}`;\n      // wrap each value into quotes and escape quotes with double quotes\n      return this.quote_ + value.replace(matchAllQuotesRegex, doubleQuote) + this.quote_;\n    } else {\n      return '';\n    }\n  });\n\n  return `${rowValues.join(this.separator_)}\\n`;\n};\n\n\n/**\n * Generate a CSV and start a download with the generated file.\n *\n * @param {Array.<Object>} data Entries/objects to include in the CSV.\n * @param {Array.<ngeox.GridColumnDef>} columnDefs Column definitions.\n * @param {string} fileName The CSV file name, without the extension.\n * @export\n */\nexports.prototype.startDownload = function(data, columnDefs, fileName) {\n  const fileContent = this.generateCsv(data, columnDefs);\n  this.download_(\n    fileContent, fileName, `text/csv;charset=${this.encoding_}`);\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoCsvDownload', [\n  ngeoDownloadService.name\n]);\nexports.module.service('ngeoCsvDownload', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.resizemap\n */\nimport googAsserts from 'goog/asserts.js';\nimport olMap from 'ol/Map.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoResizemap', []);\n\n/**\n * Provides a directive that resizes the map in an animation loop\n * during 1 second when the value of \"state\" changes. This is especially useful\n * when changing the size of other elements with a transition leads to a change\n * of the map size.\n *\n * Example:\n *\n *      <div ng-class=\"ctrl.open ? 'open' : 'close' ngeo-resizemap=\"ctrl.map\"\n *        ngeo-resizemap-state=\"open\">\n *      <div>\n *      <input type=\"checkbox\" ng-model=\"ctrl.open\" />\n *\n * See our live example: [../examples/animation.html](../examples/animation.html)\n *\n * @param {angular.$window} $window Angular window service.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoResizemap\n */\nexports.directive_ = function($window) {\n  const /** @type {number} */ duration = 1000;\n\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n      const attr = 'ngeoResizemap';\n      const prop = attrs[attr];\n      const map = scope.$eval(prop);\n      googAsserts.assertInstanceof(map, olMap);\n\n      const stateExpr = attrs['ngeoResizemapState'];\n      googAsserts.assert(stateExpr !== undefined);\n\n      let start;\n      let animationDelayKey;\n\n      const animationDelay = () => {\n        map.updateSize();\n        map.renderSync();\n\n        if (Date.now() - start < duration) {\n          animationDelayKey = $window.requestAnimationFrame(animationDelay);\n        }\n      };\n\n      // Make sure the map is resized when the animation ends.\n      // It may help in case the animation didn't start correctly.\n      element.on('transitionend', () => {\n        map.updateSize();\n        map.renderSync();\n      });\n\n      scope.$watch(stateExpr, (newVal, oldVal) => {\n        if (newVal != oldVal) {\n          start = Date.now();\n          $window.cancelAnimationFrame(animationDelayKey);\n          animationDelayKey = $window.requestAnimationFrame(animationDelay);\n        }\n      });\n    }\n  };\n};\n\n\nexports.directive('ngeoResizemap', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module gmf.permalink.shareComponent\n */\nimport gmfPermalinkShareService from 'gmf/permalink/ShareService.js';\nimport ngeoStatemanagerLocation from 'ngeo/statemanager/Location.js';\n\nconst exports = angular.module('gmfPermalinkShareComponent', [\n  gmfPermalinkShareService.module.name,\n  ngeoStatemanagerLocation.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/permalink/shareComponent', require('./shareComponent.html'));\n});\n\n\nexports.value('gmfPermalinkShareTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfPermalinkShareTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/permalink/shareComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfPermalinkShareTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfPermalinkShareTemplateUrl($attrs, gmfPermalinkShareTemplateUrl) {\n  return gmfPermalinkShareTemplateUrl($attrs);\n}\n\n\n/**\n * Component to display a shortened permalink and share it by email\n * Example:\n *\n *      <gmf-share\n *        gmf-share-email=\"true\">\n *      </gmf-share>\n *\n * @htmlAttribute {boolean} gmf-share-email Enable emailing capability.\n * @type {!angular.Component}\n */\nexports.component_ = {\n  bindings: {\n    'enableEmail': '<gmfShareEmail'\n  },\n  controller: 'GmfShareController',\n  templateUrl: gmfPermalinkShareTemplateUrl\n};\nexports.component('gmfShare', exports.component_);\n\n\nclass ShareComponentController {\n  /**\n   * The controller for the share component\n   * @param {angular.Scope} $scope Scope.\n   * @param {ngeo.statemanager.Location} ngeoLocation ngeo Location service.\n   * @param {gmf.permalink.ShareService} gmfShareService service for sharing map.\n   * @param {angular.$q} $q Angular q service\n   * @param {angular.Attributes} $attrs Attributes.\n   * @constructor\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfShareController\n   */\n  constructor($scope, ngeoLocation, gmfShareService, $q, $attrs) {\n    /**\n     * @type {angular.Scope}\n     * @private\n     */\n    this.$scope_ = $scope;\n\n    /**\n     * @type {gmf.permalink.ShareService}\n     * @private\n     */\n    this.gmfShareService_ = gmfShareService;\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.$q_ = $q;\n\n    /**\n     * @type {ngeo.statemanager.Location}\n     * @private\n     */\n    this.ngeoLocation_ = ngeoLocation;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.enableEmail;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.shortLink;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.email;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.message;\n\n    /**\n     * @type {string}\n     * @private\n     */\n    this.permalink_ = this.ngeoLocation_.getUriString();\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.showLengthWarning = this.permalink_.length > gmfPermalinkShareService.URL_MAX_LEN ||\n    ngeoLocation.getPath() > gmfPermalinkShareService.URL_PATH_MAX_LEN;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.successfullySent = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.errorOnsend = false;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.errorOnGetShortUrl = false;\n\n    this.getShortUrl();\n  }\n\n  /**\n   * Get the short version of the permalink if the email is not provided\n   * @export\n   */\n  getShortUrl() {\n    this.$q_.when(this.gmfShareService_.getShortUrl(this.permalink_))\n      .then((resp) => {\n        this.shortLink = resp.data.short_url;\n        this.errorOnGetShortUrl = false;\n      }, (resp) => {\n        this.shortLink = this.permalink;\n        this.errorOnGetShortUrl = true;\n      });\n  }\n\n  /**\n   * Send the short version of the permalink if the email is provided\n   * @export\n   */\n  sendShortUrl() {\n    if (this.$scope_['gmfShareForm'].$valid) {\n      this.$q_.when(this.gmfShareService_.sendShortUrl(this.permalink_, this.email, this.message))\n        .then((resp) => {\n          this.successfullySent = true;\n        }, (resp) => {\n          this.errorOnsend = true;\n        });\n    }\n  }\n}\n\nexports.controller('GmfShareController', ShareComponentController);\n\n\nexport default exports;\n","/**\n * @module gmf.layertree.datasourceGroupTreeComponent\n */\nimport ngeoDatasourceDataSources from 'ngeo/datasource/DataSources.js';\nimport * as olBase from 'ol/index.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfLayertreeDatasourceGroupTreeComponent', [\n  ngeoDatasourceDataSources.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/layertree/datasourceGroupTreeComponent', require('./datasourceGroupTreeComponent.html'));\n});\n\n\nexports.value('gmfLayertreeDatasourceGroupTreeTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfLayertreeDatasourceGroupTreeTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/layertree/datasourceGroupTreeComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfLayertreeDatasourceGroupTreeTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfLayertreeDatasourceGroupTreeTemplateUrl($attrs, gmfLayertreeDatasourceGroupTreeTemplateUrl) {\n  return gmfLayertreeDatasourceGroupTreeTemplateUrl($attrs);\n}\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!angular.Scope} $scope Angular scope.\n   * @param {!ngeo.datasource.DataSources} ngeoDataSources Ngeo data sources\n   *     service.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfDatasourcegrouptreeController\n   */\n  constructor($scope, ngeoDataSources) {\n\n    // Binding properties\n\n    /**\n     * @type {!ngeo.datasource.Group}\n     * @export\n     */\n    this.group;\n\n\n    // Injected properties\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {!ngeox.datasource.DataSources}\n     * @private\n     */\n    this.dataSources_ = ngeoDataSources.collection;\n  }\n\n  /**\n   * @return {string} Group uid.\n   * @export\n   */\n  getGroupUid() {\n    return `datasourcegrouptree-${olBase.getUid(this.group)}`;\n  }\n\n  /**\n   * Toggle visibility of the group itself, i.e. its visibility state.\n   * @export\n   */\n  toggle() {\n    this.group.toggleVisibilityState();\n  }\n\n  /**\n   * Toggle visible property of a data source.\n   * @param {ngeo.datasource.DataSource} dataSource Data source to toggle the\n   * visibility\n   * @export\n   */\n  toggleDataSource(dataSource) {\n    dataSource.visible = !dataSource.visible;\n  }\n\n  /**\n   * Remove all data sources from the `ngeo.datasource.DataSources` collection, which\n   * will automatically remove them from the Group. The group itself\n   * is going to be removed as well, destroying this component in the process.\n   * @export\n   */\n  remove() {\n    for (let i = this.group.dataSources.length - 1, ii = 0; i >= ii; i--) {\n      this.dataSources_.remove(this.group.dataSources[i]);\n    }\n  }\n\n  /**\n   * @param {!ngeo.datasource.DataSource} dataSource Data source to remove from\n   *     the `ngeo.DataSources` collection.\n   * @export\n   */\n  removeDataSource(dataSource) {\n    this.dataSources_.remove(dataSource);\n  }\n};\n\n\nexports.component('gmfDatasourcegrouptree', {\n  bindings: {\n    'group': '<'\n  },\n  controller: exports.Controller_,\n  templateUrl: gmfLayertreeDatasourceGroupTreeTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module ngeo.statemanager.module\n */\nimport ngeoStatemanagerLocation from 'ngeo/statemanager/Location.js';\nimport ngeoStatemanagerService from 'ngeo/statemanager/Service.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoStatemanagerModule', [\n  ngeoStatemanagerLocation.module.name,\n  ngeoStatemanagerService.module.name\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.permalink.Permalink\n */\nimport gmfBase from 'gmf/index.js';\n\n/** @suppress {extraRequire} */\nimport gmfThemeManager from 'gmf/theme/Manager.js';\n\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport ngeoPopover from 'ngeo/Popover.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawFeatures from 'ngeo/draw/features.js';\n\nimport ngeoDatasourceGroup from 'ngeo/datasource/Group.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\nimport ngeoOlcsConstants from 'ngeo/olcs/constants.js';\nimport ngeoFormatFeatureHash from 'ngeo/format/FeatureHash.js';\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscDebounce from 'ngeo/misc/debounce.js';\n\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoStatemanagerModule from 'ngeo/statemanager/module.js';\nimport ngeoStatemanagerService from 'ngeo/statemanager/Service.js';\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\nimport googAsserts from 'goog/asserts.js';\nimport * as olBase from 'ol/index.js';\nimport * as olArray from 'ol/array.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport olGeomMultiPoint from 'ol/geom/MultiPoint.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olStyleIcon from 'ol/style/Icon.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olLayerGroup from 'ol/layer/Group.js';\n\n/**\n * The Permalink service for GMF, which uses the `ngeo.statemanager.Service` to\n * manage the GMF application state. Here's the list of states are are managed:\n *\n * - the map center and zoom level\n * - the current background layer selected\n * - whether to add a crosshair feature in the map or not\n * - the dimensions value\n *\n * To have the whole possibilities offer by the permalink, these services\n * should be instantiated: ngeoBackgroundLayerMgr, ngeoFeatureOverlayMgr,\n * ngeoFeatureHelper, gmfPermalinkOptions, gmfThemes, gmfObjectEditingManager,\n * gmfThemeManager, defaultTheme, gmfTreeManager, ngeoWfsPermalink,\n * ngeoAutoProjection and ngeoFeatures.\n *\n * @constructor\n * @struct\n * @param {!angular.$q} $q The Angular $q service.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {angular.Scope} $rootScope Angular rootScope.\n * @param {angular.$injector} $injector Main injector.\n * @param {ngeox.miscDebounce} ngeoDebounce ngeo Debounce factory.\n * @param {angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {ngeo.misc.EventHelper} ngeoEventHelper Ngeo event helper service\n * @param {ngeo.statemanager.Service} ngeoStateManager The ngeo statemanager service.\n * @param {ngeo.statemanager.Location} ngeoLocation ngeo location service.\n * @param {gmfx.User} gmfUser User.\n * @ngInject\n * @ngdoc service\n * @ngname gmfPermalink\n */\nconst exports = function($q, $timeout, $rootScope, $injector, ngeoDebounce, gettextCatalog,  ngeoEventHelper,\n  ngeoStateManager, ngeoLocation, gmfUser) {\n\n  /**\n   * @type {!angular.$q}\n   * @private\n   */\n  this.q_ = $q;\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.rootScope_ = $rootScope;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.$timeout_ = $timeout;\n\n  // == listener keys ==\n\n  /**\n   * The key for map view 'propertychange' event.\n   * @type {?ol.EventsKey}\n   * @private\n   */\n  this.mapViewPropertyChangeEventKey_ = null;\n\n  // == properties from params ==\n\n  /**\n   * @type {ngeox.miscDebounce}\n   * @private\n   */\n  this.ngeoDebounce_ = ngeoDebounce;\n\n  /**\n   * @type {ngeo.misc.EventHelper}\n   * @private\n   */\n  this.ngeoEventHelper_ = ngeoEventHelper;\n\n  /**\n   * @type {ngeo.statemanager.Service}\n   * @private\n   */\n  this.ngeoStateManager_ = ngeoStateManager;\n\n  /**\n   * @type {?ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.ngeoFeatures_ = $injector.has('ngeoFeatures') ?\n    $injector.get('ngeoFeatures') : null;\n\n  /**\n   * @type {?ngeo.map.BackgroundLayerMgr}\n   * @private\n   */\n  this.ngeoBackgroundLayerMgr_ = $injector.has('ngeoBackgroundLayerMgr') ?\n    $injector.get('ngeoBackgroundLayerMgr') : null;\n\n  /**\n   * @type {?ngeo.map.FeatureOverlayMgr}\n   */\n  const ngeoFeatureOverlayMgr = $injector.has('ngeoFeatureOverlayMgr') ?\n    $injector.get('ngeoFeatureOverlayMgr') : null;\n\n  /**\n   * @type {?ngeo.map.FeatureOverlay}\n   * @private\n   */\n  this.featureOverlay_ = ngeoFeatureOverlayMgr ?\n    ngeoFeatureOverlayMgr.getFeatureOverlay() : null;\n\n  /**\n   * @type {?ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.featureHelper_ = $injector.has('ngeoFeatureHelper') ?\n    $injector.get('ngeoFeatureHelper') : null;\n\n  /**\n   * @type {?ngeo.query.Querent}\n   * @private\n   */\n  this.ngeoQuerent_ = $injector.has('ngeoQuerent') ?\n    $injector.get('ngeoQuerent') : null;\n\n  /**\n   * The options to configure the gmf permalink service with.\n   * @type {!gmfx.PermalinkOptions}\n   */\n  const gmfPermalinkOptions = $injector.has('gmfPermalinkOptions') ?\n    $injector.get('gmfPermalinkOptions') : {};\n  if (gmfPermalinkOptions.useLocalStorage === true) {\n    // localStorage is deactivated by default\n    this.ngeoStateManager_.setUseLocalStorage(true);\n  }\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.crosshairEnabledByDefault_ = !!gmfPermalinkOptions.crosshairEnabledByDefault;\n\n  /**\n   * @type {number|undefined}\n   * @private\n   */\n  this.pointRecenterZoom_ = gmfPermalinkOptions.pointRecenterZoom;\n\n  /**\n   * @type {?gmf.datasource.ExternalDataSourcesManager}\n   * @private\n   */\n  this.gmfExternalDataSourcesManager_ =\n    $injector.has('gmfExternalDataSourcesManager') ?\n      $injector.get('gmfExternalDataSourcesManager') : null;\n\n  /**\n   * @type {?gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = $injector.has('gmfThemes') ? $injector.get('gmfThemes') : null;\n\n  /**\n   * @type {?gmf.objectediting.Manager}\n   * @private\n   */\n  this.gmfObjectEditingManager_ = $injector.has('gmfObjectEditingManager') ?\n    $injector.get('gmfObjectEditingManager') : null;\n\n  /**\n   * @type {?gmf.theme.Manager}\n   * @private\n   */\n  this.gmfThemeManager_ = $injector.has('gmfThemeManager') ?\n    $injector.get('gmfThemeManager') : null;\n\n  /**\n   * @type {string|undefined}\n   * @private\n   */\n  this.defaultTheme_ = $injector.has('defaultTheme') ?\n    $injector.get('defaultTheme') : undefined;\n\n  /**\n   * @type {?gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = $injector.has('gmfTreeManager') ?\n    $injector.get('gmfTreeManager') : null;\n\n  /**\n   * @type {gmfx.User}\n   * @private\n   */\n  this.user_ = gmfUser;\n\n  // == other properties ==\n\n  /**\n   * @type {ngeo.statemanager.Location}\n   * @private\n   */\n  this.ngeoLocation_ = ngeoLocation;\n\n  /**\n   * @type {?ngeo.statemanager.WfsPermalink}\n   * @private\n   */\n  this.ngeoWfsPermalink_ = $injector.has('ngeoWfsPermalink') ?\n    $injector.get('ngeoWfsPermalink') : null;\n\n  /**\n   * @type {?gmfx.User}\n   * @export\n   */\n  this.gmfUser_ = $injector.has('gmfUser') ?\n    $injector.get('gmfUser') : null;\n\n  /**\n   * @type {?ol.Map}\n   * @private\n   */\n  this.map_ = null;\n\n  /**\n   * @type {?ngeo.misc.AutoProjection}\n   * @private\n   */\n  this.ngeoAutoProjection_ = $injector.has('ngeoAutoProjection') ?\n    $injector.get('ngeoAutoProjection') : null;\n\n  /**\n   * A list of projections that the coordinates in the permalink can be in.\n   * @type {?Array.<ol.proj.Projection>}\n   * @private\n   */\n  this.sourceProjections_ = null;\n  if (gmfPermalinkOptions.projectionCodes !== undefined && this.ngeoAutoProjection_) {\n    const projections = this.ngeoAutoProjection_.getProjectionList(gmfPermalinkOptions.projectionCodes);\n    if (projections.length > 0) {\n      this.sourceProjections_ = projections;\n    }\n  }\n\n  /**\n   * @type {?ol.Feature}\n   * @private\n   */\n  this.crosshairFeature_ = null;\n\n  /**\n   * @type {Array<(null|ol.style.Style)>|null|ol.FeatureStyleFunction|ol.style.Style}\n   * @private\n   */\n  this.crosshairStyle_;\n\n  if (gmfPermalinkOptions.crosshairStyle !== undefined) {\n    this.crosshairStyle_ = gmfPermalinkOptions.crosshairStyle;\n  } else {\n    this.crosshairStyle_ = [new olStyleStyle({\n      image: new olStyleIcon({\n        src: require('gmf/permalink/crosshair.svg')\n      })\n    })];\n  }\n\n  /**\n   * @type {?ngeo.Popover}\n   * @private\n   */\n  this.mapTooltip_ = null;\n\n  /**\n   * @type {ngeo.format.FeatureHash}\n   * @private\n   */\n  this.featureHashFormat_ = new ngeoFormatFeatureHash({\n    setStyle: false,\n    encodeStyles: false,\n    propertiesType: {\n      'fillColor': ngeoFormatFeatureProperties.COLOR,\n      'fillOpacity': ngeoFormatFeatureProperties.OPACITY,\n      'fontColor': ngeoFormatFeatureProperties.COLOR,\n      'fontSize': ngeoFormatFeatureProperties.SIZE,\n      'isBox': ngeoFormatFeatureProperties.IS_RECTANGLE,\n      'isCircle': ngeoFormatFeatureProperties.IS_CIRCLE,\n      'isLabel': ngeoFormatFeatureProperties.IS_TEXT,\n      'name': ngeoFormatFeatureProperties.NAME,\n      'pointRadius': ngeoFormatFeatureProperties.SIZE,\n      'showLabel': ngeoFormatFeatureProperties.SHOW_LABEL,\n      'showMeasure': ngeoFormatFeatureProperties.SHOW_MEASURE,\n      'strokeColor': ngeoFormatFeatureProperties.COLOR,\n      'strokeWidth': ngeoFormatFeatureProperties.STROKE\n    },\n    defaultValues: {\n      'name': feature => gettextCatalog.getString(feature.getGeometry().getType()),\n      'fillOpacity': () => 0.5,\n      'showLabel': () => false,\n      'showMeasure': () => false\n    }\n  });\n\n  // == event listeners ==\n\n  if (this.ngeoBackgroundLayerMgr_) {\n    olEvents.listen(\n      this.ngeoBackgroundLayerMgr_,\n      'change',\n      this.handleBackgroundLayerManagerChange_,\n      this\n    );\n  }\n\n  // visibility\n  this.rootScope_.$on('ngeo-layertree-state', (event, treeCtrl, firstParent) => {\n    const newState = {};\n    if (firstParent.node.mixed) {\n      const state = treeCtrl.getState();\n      googAsserts.assert(state === 'on' || state === 'off');\n      const visible = state === 'on';\n      treeCtrl.traverseDepthFirst((ctrl) => {\n        if (ctrl.node.children === undefined) {\n          const param = exports.ParamPrefix.TREE_ENABLE + ctrl.node.name;\n          newState[param] = visible;\n        }\n      });\n    } else {\n      const gmfLayerNames = [];\n      firstParent.traverseDepthFirst((ctrl) => {\n        if (ctrl.node.children === undefined && ctrl.getState() === 'on') {\n          gmfLayerNames.push(ctrl.node.name);\n        }\n      });\n      newState[exports.ParamPrefix.TREE_GROUP_LAYERS + firstParent.node.name] = gmfLayerNames.join(',');\n    }\n    this.ngeoStateManager_.updateState(newState);\n  });\n  this.rootScope_.$on('ngeo-layertree-opacity', (event, treeCtrl) => {\n    const newState = {};\n    const opacity = treeCtrl.layer.getOpacity();\n    const stateName = (treeCtrl.parent.node.mixed ?\n      exports.ParamPrefix.TREE_OPACITY : exports.ParamPrefix.TREE_GROUP_OPACITY\n    ) + treeCtrl.node.name;\n    newState[stateName] = opacity;\n    this.ngeoStateManager_.updateState(newState);\n  });\n\n  // ngeoFeatures\n  //   (1) read from features from the state manager first, add them\n  //   (2) listen for further features added/removed\n  const features = this.getFeatures();\n  if (this.ngeoFeatures_) {\n    features.forEach((feature) => {\n      if (this.featureHelper_) {\n        this.featureHelper_.setStyle(feature);\n      }\n      this.addNgeoFeature_(feature);\n    });\n\n    this.ngeoFeatures_.extend(features);\n    olEvents.listen(this.ngeoFeatures_, 'add', this.handleNgeoFeaturesAdd_, this);\n    olEvents.listen(this.ngeoFeatures_, 'remove', this.handleNgeoFeaturesRemove_, this);\n  }\n\n  if (this.featureHelper_) {\n    this.rootScope_.$on('$localeChangeSuccess', () => {\n      features.forEach((feature) => {\n        this.featureHelper_.setStyle(feature);\n      });\n    });\n  }\n\n  if (this.gmfThemeManager_) {\n    this.rootScope_.$on(gmfThemeManager.EventType.THEME_NAME_SET, (event, name) => {\n      this.setThemeInUrl_(name);\n    });\n  }\n\n  // External DataSources\n\n  /**\n   * @type {?angular.$q.Promise}\n   * @private\n   */\n  this.setExternalDataSourcesStatePromise_ = null;\n\n  if (this.ngeoQuerent_ && this.gmfExternalDataSourcesManager_) {\n    // First, load the external data sources that are defined in the url\n    this.initExternalDataSources_().then(() => {\n      // Then, listen to the changes made to the external data sources to\n      // update the url accordingly.\n      olEvents.listen(\n        this.gmfExternalDataSourcesManager_.wmsGroupsCollection,\n        'add',\n        this.handleExternalDSGroupCollectionAdd_,\n        this\n      );\n      olEvents.listen(\n        this.gmfExternalDataSourcesManager_.wmsGroupsCollection,\n        'remove',\n        this.handleExternalDSGroupCollectionRemove_,\n        this\n      );\n      olEvents.listen(\n        this.gmfExternalDataSourcesManager_.wmtsGroupsCollection,\n        'add',\n        this.handleExternalDSGroupCollectionAdd_,\n        this\n      );\n      olEvents.listen(\n        this.gmfExternalDataSourcesManager_.wmtsGroupsCollection,\n        'remove',\n        this.handleExternalDSGroupCollectionRemove_,\n        this\n      );\n\n      // We also need to 'register' the existing groups as well, i.e. those\n      // that were created by the Permalink\n      for (const wmsGroup of this.gmfExternalDataSourcesManager_.wmsGroups) {\n        this.registerExternalDSGroup_(wmsGroup);\n      }\n      for (const wmtsGroup of this.gmfExternalDataSourcesManager_.wmtsGroups) {\n        this.registerExternalDSGroup_(wmtsGroup);\n      }\n    });\n  }\n\n  this.initLayers_();\n};\n\n\n// === Map X, Y, Z ===\n\n/**\n * Get the coordinate to use to initialize the map view from the state manager.\n * @return {?ol.Coordinate} The coordinate for the map view center.\n * @export\n */\nexports.prototype.getMapCenter = function() {\n  const x = this.ngeoStateManager_.getInitialNumberValue(gmfBase.PermalinkParam.MAP_X);\n  const y = this.ngeoStateManager_.getInitialNumberValue(gmfBase.PermalinkParam.MAP_Y);\n\n  if (!isNaN(x) && !isNaN(y)) {\n    const center = [x, y];\n    if (this.sourceProjections_ !== null && this.ngeoAutoProjection_) {\n      const targetProjection = this.map_.getView().getProjection();\n      const reprojectedCenter = this.ngeoAutoProjection_.tryProjectionsWithInversion(\n        center, targetProjection.getExtent(), targetProjection,\n        this.sourceProjections_);\n      if (reprojectedCenter) {\n        return reprojectedCenter;\n      }\n    }\n    return center;\n  }\n  return null;\n};\n\n\n/**\n * Get the zoom level to use to initialize the map view from the state manager.\n * @return {number|undefined} The zoom for the map view.\n * @export\n */\nexports.prototype.getMapZoom = function() {\n  const zoom = this.ngeoStateManager_.getInitialNumberValue(gmfBase.PermalinkParam.MAP_Z);\n  return isNaN(zoom) ? undefined : zoom;\n};\n\n\n// === Map crosshair ===\n\n\n/**\n * Get the map crosshair property from the state manager, if defined.\n * @return {boolean} Whether map crosshair property is set or not.\n * @export\n */\nexports.prototype.getMapCrosshair = function() {\n  const crosshair = this.ngeoStateManager_.getInitialBooleanValue(gmfBase.PermalinkParam.MAP_CROSSHAIR);\n  return crosshair === undefined ? this.crosshairEnabledByDefault_ : crosshair;\n};\n\n\n/**\n * Sets the map crosshair to the center (or the map center if nothing provided).\n * Overwrites an existing map crosshair.\n * @param {?ol.Coordinate=} opt_center Optional center coordinate.\n */\nexports.prototype.setMapCrosshair = function(opt_center) {\n  let crosshairCoordinate;\n  if (opt_center) {\n    crosshairCoordinate = opt_center;\n  } else {\n    crosshairCoordinate = this.map_.getView().getCenter();\n  }\n  googAsserts.assertArray(crosshairCoordinate);\n\n  // remove existing crosshair first\n  if (this.crosshairFeature_) {\n    this.featureOverlay_.removeFeature(this.crosshairFeature_);\n  }\n  // set new crosshair\n  this.crosshairFeature_ = new olFeature(\n    new olGeomPoint(crosshairCoordinate));\n  this.crosshairFeature_.setStyle(this.crosshairStyle_);\n\n  // add to overlay\n  this.featureOverlay_.addFeature(this.crosshairFeature_);\n};\n\n\n// === Map tooltip ===\n\n\n/**\n * Get the tooltip text from the state manager.\n * @return {string|undefined} Tooltip text.\n * @export\n */\nexports.prototype.getMapTooltip = function() {\n  return this.ngeoStateManager_.getInitialStringValue(gmfBase.PermalinkParam.MAP_TOOLTIP);\n};\n\n/**\n * Sets the map tooltip to the center (or the map center if nothing provided).\n * Overwrites an existing map tooltip.\n * @param {string} tooltipText Text to display in tooltip.\n * @param {?ol.Coordinate=} opt_center Optional center coordinate.\n */\nexports.prototype.setMapTooltip = function(tooltipText, opt_center) {\n  let tooltipPosition;\n  if (opt_center) {\n    tooltipPosition = opt_center;\n  } else {\n    tooltipPosition = this.map_.getView().getCenter();\n  }\n  googAsserts.assertArray(tooltipPosition);\n\n  const div = $('<div/>', {\n    'class': 'gmf-permalink-tooltip',\n    'text': tooltipText\n  })[0];\n\n  if (this.mapTooltip_ !== null) {\n    this.map_.removeOverlay(this.mapTooltip_);\n  }\n\n  this.mapTooltip_ = new ngeoPopover({\n    element: div,\n    position: tooltipPosition\n  });\n\n  this.map_.addOverlay(this.mapTooltip_);\n};\n\n\n// === NgeoFeatures (A.K.A. DrawFeature, RedLining) ===\n\n\n/**\n * Get the ngeo features from the state manager for initialization purpose\n * @return {!Array.<!ol.Feature>} The features read from the state manager.\n * @export\n */\nexports.prototype.getFeatures = function() {\n  const f = this.ngeoStateManager_.getInitialStringValue(gmfBase.PermalinkParam.FEATURES);\n  if (f !== undefined && f !== '') {\n    return googAsserts.assert(this.featureHashFormat_.readFeatures(f));\n  }\n  return [];\n};\n\n\n/**\n * @param {!Object.<string, string>} dimensions The global dimensions object.\n * @export\n */\nexports.prototype.setDimensions = function(dimensions) {\n  // apply initial state\n  const keys = this.ngeoLocation_.getParamKeysWithPrefix(exports.ParamPrefix.DIMENSIONS);\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i];\n    const value = this.ngeoLocation_.getParam(key);\n    googAsserts.assert(value);\n    dimensions[key.slice(exports.ParamPrefix.DIMENSIONS.length)] = value;\n  }\n\n  this.rootScope_.$watchCollection(() => dimensions, (dimensions) => {\n    const params = {};\n    for (const key in dimensions) {\n      params[exports.ParamPrefix.DIMENSIONS + key] = dimensions[key];\n    }\n    this.ngeoLocation_.updateParams(params);\n  });\n};\n\n\n/**\n * Bind an ol3 map object to this service. The service will, from there on,\n * listen to the properties changed within the map view and update the following\n * state properties: map_x, map_y and map_zoom.\n *\n * If the service is already bound to a map, those events are unlistened first.\n *\n * @param {?ol.Map} map The ol3 map object.\n * @export\n */\nexports.prototype.setMap = function(map) {\n\n  if (map === this.map_) {\n    return;\n  }\n\n  if (this.map_) {\n    this.unregisterMap_();\n    this.map_ = null;\n  }\n\n  if (map) {\n    this.map_ = map;\n    if (this.gmfObjectEditingManager_) {\n      this.gmfObjectEditingManager_.getFeature().then((feature) => {\n        this.registerMap_(map, feature);\n      });\n    } else {\n      this.registerMap_(map, null);\n    }\n  }\n};\n\n\n/**\n * Listen to the map view property change and update the state accordingly.\n * @param {ol.Map} map The ol3 map object.\n * @param {?ol.Feature} oeFeature ObjectEditing feature\n * @private\n */\nexports.prototype.registerMap_ = function(map, oeFeature) {\n\n  const view = map.getView();\n  let center;\n\n  // (1) Initialize the map view with either:\n  //     a) the given ObjectEditing feature\n  //     b) the X, Y and Z available within the permalink service, if available\n  const geom = typeof oeFeature !== 'undefined' && oeFeature !== null ? oeFeature.getGeometry() : undefined;\n  if (geom) {\n    const size = map.getSize();\n    googAsserts.assert(size);\n    let maxZoom;\n    if (geom instanceof olGeomPoint || geom instanceof olGeomMultiPoint) {\n      maxZoom = this.pointRecenterZoom_;\n    }\n    view.fit(geom.getExtent(), {\n      size,\n      maxZoom\n    });\n  } else {\n    const enabled3d = this.ngeoStateManager_.getInitialBooleanValue(ngeoOlcsConstants.Permalink3dParam.ENABLED);\n    if (!enabled3d) {\n      center = this.getMapCenter();\n      if (center) {\n        view.setCenter(center);\n      }\n      const zoom = this.getMapZoom();\n      if (zoom !== undefined) {\n        view.setZoom(zoom);\n      }\n    }\n  }\n\n\n  // (2) Listen to any property changes within the view and apply them to\n  //     the permalink service\n  this.mapViewPropertyChangeEventKey_ = olEvents.listen(\n    view,\n    'propertychange',\n    this.ngeoDebounce_(() => {\n      const center = view.getCenter();\n      const zoom = view.getZoom();\n      const object = {};\n      object[gmfBase.PermalinkParam.MAP_X] = Math.round(center[0]);\n      object[gmfBase.PermalinkParam.MAP_Y] = Math.round(center[1]);\n      object[gmfBase.PermalinkParam.MAP_Z] = zoom;\n      this.ngeoStateManager_.updateState(object);\n    }, 300, /* invokeApply */ true),\n    this);\n\n  // (3) Add map crosshair, if set\n  if (this.getMapCrosshair() && this.featureOverlay_) {\n    this.setMapCrosshair(center);\n  }\n\n  // (4) Add map tooltip, if set\n  const tooltipText = this.getMapTooltip();\n  if (tooltipText) {\n    this.setMapTooltip(tooltipText, center);\n  }\n\n  // (6) check for a wfs permalink\n  const wfsPermalinkData = this.getWfsPermalinkData_();\n  if (wfsPermalinkData !== null && this.ngeoWfsPermalink_) {\n    this.ngeoWfsPermalink_.issue(wfsPermalinkData, map);\n  }\n};\n\n\n/**\n * Remove any event listeners from the current map.\n * @private\n */\nexports.prototype.unregisterMap_ = function() {\n  googAsserts.assert(\n    this.mapViewPropertyChangeEventKey_, 'Key should be thruthy');\n  olEvents.unlistenByKey(this.mapViewPropertyChangeEventKey_);\n  this.mapViewPropertyChangeEventKey_ = null;\n};\n\n\n// === Background layer ===\n\n\n/**\n * Get the background layer object to use to initialize the map from the state manager.\n * @param {!Array.<!ol.layer.Base>} layers Array of background layer objects.\n * @return {?ol.layer.Base} Background layer.\n * @export\n */\nexports.prototype.getBackgroundLayer = function(layers) {\n  const layerName = this.ngeoStateManager_.getInitialStringValue(gmfBase.PermalinkParam.BG_LAYER);\n  if (layerName !== undefined) {\n    for (const layer of layers) {\n      if (layer.get('label') === layerName) {\n        return layer;\n      }\n    }\n  }\n  return null;\n};\n\n\n/**\n * Get the background layer opacity to use to initialize the map from the state manager.\n * @return {number} Opacity.\n */\nexports.prototype.getBackgroundLayerOpacity = function() {\n  const opacity_ = this.ngeoStateManager_.getInitialNumberValue(gmfBase.PermalinkParam.BG_LAYER_OPACITY);\n  return opacity_ === undefined ? undefined : opacity_ / 100;\n};\n\n\n/**\n * Called when the background layer changes. Update the state using the\n * background layer label, i.e. its name.\n * @private\n */\nexports.prototype.handleBackgroundLayerManagerChange_ = function() {\n  if (!this.map_ || !this.ngeoBackgroundLayerMgr_) {\n    return;\n  }\n\n  // get layer label, i.e its name\n  const layer = this.ngeoBackgroundLayerMgr_.get(this.map_);\n  const layerName = layer.get('label');\n  googAsserts.assertString(layerName);\n\n  // set it in state\n  const object = {};\n  object[gmfBase.PermalinkParam.BG_LAYER] = layerName;\n  this.ngeoStateManager_.updateState(object);\n\n  const backgroundLayer = this.ngeoBackgroundLayerMgr_.getOpacityBgLayer(this.map_);\n  if (backgroundLayer) {\n    const opacity = this.getBackgroundLayerOpacity();\n    if (opacity !== undefined) {\n      backgroundLayer.setOpacity(opacity);\n    } else {\n      const opacity = backgroundLayer.getOpacity();\n      /** @type {Object<string, string>} */\n      const object = {};\n      object[gmfBase.PermalinkParam.BG_LAYER_OPACITY] = `${opacity * 100}`;\n      this.ngeoStateManager_.updateState(object);\n    }\n    olEvents.listen(\n      backgroundLayer,\n      'change:opacity',\n      () => {\n        const opacity = backgroundLayer.getOpacity();\n        /** @type {Object<string, string>} */\n        const object = {};\n        object[gmfBase.PermalinkParam.BG_LAYER_OPACITY] = `${opacity * 100}`;\n        this.ngeoStateManager_.updateState(object);\n      }\n    );\n  }\n};\n\n\n// === Layers (layer tree) ===\n\n\n/**\n * Get the current first level node names in the tree manager and update the\n * correspondent state of the permalink.\n * @export\n */\nexports.prototype.refreshFirstLevelGroups = function() {\n  if (!this.gmfTreeManager_) {\n    return;\n  }\n  // Get first-level-groups order\n  const groupNodes = this.gmfTreeManager_.rootCtrl.node.children;\n  const orderedNames = groupNodes.map(node => node.name);\n\n  // set it in state\n  const object = {};\n  object[gmfBase.PermalinkParam.TREE_GROUPS] = orderedNames.join(',');\n  this.ngeoStateManager_.updateState(object);\n};\n\n\n/**\n * Return true if there is a theme specified in the URL path.\n * @private\n * @param {Array.<string>} pathElements Array of path elements.\n * @return {boolean} theme in path.\n */\nexports.prototype.themeInUrl_ = function(pathElements) {\n  const indexOfTheme = pathElements.indexOf('theme');\n  return indexOfTheme != -1 && indexOfTheme == pathElements.length - 2;\n};\n\n\n/**\n * @param {string} themeName Theme name.\n * @private\n */\nexports.prototype.setThemeInUrl_ = function(themeName) {\n  if (themeName) {\n    const pathElements = this.ngeoLocation_.getPath().split('/');\n    googAsserts.assert(pathElements.length > 1);\n    if (pathElements[pathElements.length - 1] === '') {\n      // case where the path is just \"/\"\n      pathElements.splice(pathElements.length - 1);\n    }\n    if (this.themeInUrl_(pathElements)) {\n      pathElements[pathElements.length - 1] = themeName;\n    } else {\n      pathElements.push('theme', themeName);\n    }\n    this.ngeoLocation_.setPath(pathElements.join('/'));\n  }\n};\n\n\n/**\n * Get the default theme from url, local storage, user functionalities or\n * defaultTheme constant.\n * @return {?string} default theme name.\n * @export\n */\nexports.prototype.defaultThemeName = function() {\n\n  // check if we have a theme in url\n  const pathElements = this.ngeoLocation_.getPath().split('/');\n  if (this.themeInUrl_(pathElements)) {\n    return decodeURI(pathElements[pathElements.length - 1]);\n  }\n\n  // check if we have a theme in the local storage\n  const tn = this.ngeoStateManager_.getInitialStringValue('theme');\n  if (tn) {\n    return tn;\n  }\n\n  const defaultTheme = this.defaultThemeNameFromFunctionalities();\n  if (defaultTheme !== null) {\n    return defaultTheme;\n  }\n\n  // fallback to the defaultTheme constant\n  if (this.defaultTheme_) {\n    return this.defaultTheme_;\n  }\n\n  return null;\n};\n\n\n/**\n * Get the default theme from user functionalities.\n * @return {?string} default theme name.\n * @export\n */\nexports.prototype.defaultThemeNameFromFunctionalities = function() {\n  //check if we have a theme in the user functionalities\n  if (!this.gmfUser_) {\n    return null;\n  }\n  const functionalities = this.gmfUser_.functionalities;\n  if (functionalities && 'default_theme' in functionalities) {\n    const defaultTheme = functionalities.default_theme;\n    if (defaultTheme.length > 0) {\n      return defaultTheme[0];\n    }\n  }\n  return null;\n};\n\n\n/**\n * @private\n */\nexports.prototype.initLayers_ = function() {\n  const initialUri = window.location.href;\n  let authenticationRequired = false;\n\n  if (!this.gmfThemes_) {\n    return;\n  }\n  this.gmfThemes_.getThemesObject().then((themes) => {\n    const themeName = this.defaultThemeName();\n    googAsserts.assert(themeName !== null);\n\n    if (this.gmfThemeManager_) {\n      this.gmfThemeManager_.setThemeName(this.gmfThemeManager_.modeFlush ? themeName : '');\n    }\n\n    /**\n     * @type {Array<(gmfThemes.GmfGroup)>}\n     */\n    let firstLevelGroups = [];\n    let theme;\n    // Check if we have the groups in the permalink\n    const groupsNames = this.ngeoLocation_.getParam(gmfBase.PermalinkParam.TREE_GROUPS);\n    if (groupsNames === undefined) {\n      googAsserts.assertString(themeName);\n      theme = gmfThemeThemes.findThemeByName(themes, themeName);\n      if (theme) {\n        firstLevelGroups = theme.children;\n      }\n    } else {\n      groupsNames.split(',').forEach((groupName) => {\n        const group = gmfThemeThemes.findGroupByName(themes, groupName);\n        if (group) {\n          firstLevelGroups.push(group);\n        } else {\n          authenticationRequired = true;\n        }\n      });\n    }\n\n    if (this.gmfTreeManager_) {\n      this.gmfTreeManager_.setFirstLevelGroups(firstLevelGroups);\n    }\n\n    this.$timeout_(() => {\n      if (!this.gmfTreeManager_ || !this.gmfTreeManager_.rootCtrl) {\n        // we don't have any layertree\n        if (authenticationRequired && this.user_.role_id === null) {\n          this.rootScope_.$broadcast('authenticationrequired', {url: initialUri});\n        }\n        return;\n      }\n      // Enable the layers and set the opacity\n      this.gmfTreeManager_.rootCtrl.traverseDepthFirst((treeCtrl) => {\n        if (treeCtrl.isRoot) {\n          return;\n        }\n\n        const opacity = this.ngeoStateManager_.getInitialNumberValue((\n          treeCtrl.parent.node.mixed ?\n            exports.ParamPrefix.TREE_OPACITY :\n            exports.ParamPrefix.TREE_GROUP_OPACITY\n        ) + treeCtrl.node.name);\n        if (opacity !== undefined && treeCtrl.layer) {\n          treeCtrl.layer.setOpacity(opacity);\n        }\n        if (treeCtrl.parent.node && treeCtrl.parent.node.mixed && treeCtrl.node.children == undefined) {\n          // Layer of a mixed group\n          const enable = this.ngeoStateManager_.getInitialBooleanValue(\n            exports.ParamPrefix.TREE_ENABLE + treeCtrl.node.name\n          );\n          if (enable !== undefined) {\n            treeCtrl.setState(enable ? 'on' : 'off', false);\n          }\n        } else if (!treeCtrl.node.mixed && treeCtrl.depth == 1) {\n          // First level non mixed group\n          const groupLayers = this.ngeoStateManager_.getInitialStringValue(\n            exports.ParamPrefix.TREE_GROUP_LAYERS + treeCtrl.node.name\n          );\n          if (groupLayers !== undefined) {\n            const groupLayersArray = groupLayers == '' ? [] : groupLayers.split(',');\n            treeCtrl.traverseDepthFirst((treeCtrl) => {\n              if (treeCtrl.node.children === undefined) {\n                const enable = olArray.includes(groupLayersArray, treeCtrl.node.name);\n                if (enable) {\n                  groupLayersArray.splice(groupLayersArray.indexOf(treeCtrl.node.name), 1);\n                }\n                treeCtrl.setState(enable ? 'on' : 'off', false);\n              }\n            });\n            if (groupLayersArray.length > 0) {\n              authenticationRequired = true;\n            }\n          }\n        }\n      });\n      const firstParents = this.gmfTreeManager_.rootCtrl.children;\n      firstParents.forEach((firstParent) => {\n        firstParent.traverseDepthFirst((treeCtrl) => {\n          if (treeCtrl.getState() !== 'indeterminate') {\n            this.rootScope_.$broadcast('ngeo-layertree-state', treeCtrl, firstParent);\n            return ngeoLayertreeController.VisitorDecision.STOP;\n          }\n        });\n      });\n\n      if (authenticationRequired && this.user_.role_id === null) {\n        this.rootScope_.$broadcast('authenticationrequired', {url: initialUri});\n      }\n    });\n  });\n};\n\n\n// === ngeoFeatures, A.K.A features from the DrawFeature, RedLining  ===\n\n\n/**\n * @param {ol.Collection.Event} event Collection event.\n * @private\n */\nexports.prototype.handleNgeoFeaturesAdd_ = function(event) {\n  const feature = event.element;\n  googAsserts.assertInstanceof(feature, olFeature);\n  this.addNgeoFeature_(feature);\n};\n\n\n/**\n * @param {ol.Collection.Event} event Collection event.\n * @private\n */\nexports.prototype.handleNgeoFeaturesRemove_ = function(event) {\n  const feature = event.element;\n  googAsserts.assertInstanceof(feature, olFeature);\n  this.removeNgeoFeature_(feature);\n};\n\n\n/**\n * Listen to any changes that may occur within the feature in order to\n * update the state of the permalink accordingly.\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.addNgeoFeature_ = function(feature) {\n  const uid = olBase.getUid(feature);\n  this.ngeoEventHelper_.addListenerKey(\n    uid,\n    olEvents.listen(feature, 'change',\n      this.ngeoDebounce_(this.handleNgeoFeaturesChange_, 250, true), this)\n  );\n};\n\n\n/**\n * Unregister any event listener from the feature.\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.prototype.removeNgeoFeature_ = function(feature) {\n  const uid = olBase.getUid(feature);\n  this.ngeoEventHelper_.clearListenerKey(uid);\n  this.handleNgeoFeaturesChange_();\n};\n\n\n/**\n * Called once upon initialization of the permalink service if there's at\n * least one feature in the ngeoFeatures collection, then called every time\n * the collection changes or any of the features within the collection changes.\n * @private\n */\nexports.prototype.handleNgeoFeaturesChange_ = function() {\n  if (!this.ngeoFeatures_) {\n    return;\n  }\n  const features = this.ngeoFeatures_.getArray();\n  const data = this.featureHashFormat_.writeFeatures(features);\n\n  const object = {};\n  object[gmfBase.PermalinkParam.FEATURES] = data;\n  this.ngeoStateManager_.updateState(object);\n};\n\n\n/**\n * Get the query data for a WFS permalink.\n * @return {?ngeox.WfsPermalinkData} The query data.\n * @private\n */\nexports.prototype.getWfsPermalinkData_ = function() {\n  const wfsLayer = this.ngeoLocation_.getParam(gmfBase.PermalinkParam.WFS_LAYER);\n  if (!wfsLayer) {\n    return null;\n  }\n\n  const numGroups = this.ngeoLocation_.getParamAsInt(gmfBase.PermalinkParam.WFS_NGROUPS);\n  const paramKeys = this.ngeoLocation_.getParamKeysWithPrefix(exports.ParamPrefix.WFS);\n\n  const filterGroups = [];\n  let filterGroup;\n  if (numGroups === undefined) {\n    // no groups are used, e.g. '?wfs_layer=fuel&wfs_osm_id=123\n    filterGroup = this.createFilterGroup_(exports.ParamPrefix.WFS, paramKeys);\n    if (filterGroup !== null) {\n      filterGroups.push(filterGroup);\n    }\n  } else {\n    // filter groups are used, e.g. '?wfs_layer=osm_scale&wfs_ngroups=2&wfs_0_ele=380&\n    // wfs_0_highway=bus_stop&&wfs_1_name=Grand-Pont'\n    for (let i = 0; i < numGroups; i++) {\n      filterGroup = this.createFilterGroup_(`${exports.ParamPrefix.WFS + i}_`, paramKeys);\n      if (filterGroup !== null) {\n        filterGroups.push(filterGroup);\n      }\n    }\n  }\n\n  if (filterGroups.length == 0) {\n    return null;\n  }\n\n  const showFeaturesParam = this.ngeoLocation_.getParam(gmfBase.PermalinkParam.WFS_SHOW_FEATURES);\n  const showFeatures = !(showFeaturesParam === '0' || showFeaturesParam === 'false');\n\n  return {\n    wfsType: wfsLayer,\n    showFeatures: showFeatures,\n    filterGroups: filterGroups\n  };\n};\n\n\n/**\n * Create a filter group for a given prefix from the query params.\n * @param {string} prefix E.g. `wfs_` or `wfs_0_`.\n * @param {Array.<string>} paramKeys All param keys starting with `wfs_`.\n * @return {ngeox.WfsPermalinkFilterGroup|null} A filter group.\n * @private\n */\nexports.prototype.createFilterGroup_ = function(prefix, paramKeys) {\n  /**\n   * @type {Array.<ngeox.WfsPermalinkFilter>}\n   */\n  const filters = [];\n\n  paramKeys.forEach((paramKey) => {\n    if (paramKey == gmfBase.PermalinkParam.WFS_LAYER || paramKey == gmfBase.PermalinkParam.WFS_SHOW_FEATURES ||\n        paramKey == gmfBase.PermalinkParam.WFS_NGROUPS || paramKey.indexOf(prefix) != 0) {\n      return;\n    }\n    const value = this.ngeoLocation_.getParam(paramKey);\n    if (!value) {\n      return;\n    }\n\n    let condition = value;\n    if (value.indexOf(',') > -1) {\n      condition = value.split(',');\n    }\n\n    const filter = {\n      property: paramKey.replace(prefix, ''),\n      condition: condition\n    };\n    filters.push(filter);\n  });\n\n  return (filters.length > 0) ? {filters} : null;\n};\n\n\n// === External Data Sources management ===\n\n\n/**\n * @return {!angular.$q.Promise} Promise\n * @private\n */\n\nexports.prototype.initExternalDataSources_ = function() {\n\n  const ngeoQuerent = googAsserts.assert(this.ngeoQuerent_);\n  const gmfExtDSManager = googAsserts.assert(\n    this.gmfExternalDataSourcesManager_);\n\n  const promises = [];\n\n  const layerNamesString = this.ngeoStateManager_.getInitialValue(\n    gmfBase.PermalinkParam.EXTERNAL_DATASOURCES_NAMES);\n  const urlsString = this.ngeoStateManager_.getInitialValue(\n    gmfBase.PermalinkParam.EXTERNAL_DATASOURCES_URLS);\n\n  if (layerNamesString && urlsString) {\n\n    const layerNames = layerNamesString.split(exports.ExtDSSeparator.LIST);\n    const urls = urlsString.split(exports.ExtDSSeparator.LIST);\n\n    for (let i = 0, ii = urls.length; i < ii; i++) {\n      // Stop iterating if we do not have the same number of urls and layer\n      // names\n      const groupLayerNamesString = layerNames[i];\n\n      if (!groupLayerNamesString) {\n        break;\n      }\n\n      const groupLayerNames = groupLayerNamesString.split(\n        exports.ExtDSSeparator.NAMES);\n      const url = urls[i];\n\n      const serviceType = ngeoDatasourceOGC.guessServiceTypeByUrl(url);\n\n      const getCapabilitiesDefer = this.q_.defer();\n      promises.push(getCapabilitiesDefer.promise);\n\n      if (serviceType === ngeoDatasourceOGC.Type.WMS) {\n        ngeoQuerent.wmsGetCapabilities(url).then(\n          (capabilities) => {\n            getCapabilitiesDefer.resolve({\n              capabilities,\n              groupLayerNames,\n              serviceType,\n              url\n            });\n          },\n          () => {\n            // Query to the WMS service didn't work\n            getCapabilitiesDefer.reject({\n              groupLayerNames,\n              serviceType,\n              url\n            });\n          }\n        );\n      } else if (serviceType === ngeoDatasourceOGC.Type.WMTS) {\n        ngeoQuerent.wmtsGetCapabilities(url).then(\n          (capabilities) => {\n            getCapabilitiesDefer.resolve({\n              capabilities,\n              groupLayerNames,\n              serviceType,\n              url\n            });\n          },\n          () => {\n            // Query to the WMTS service didn't work\n            getCapabilitiesDefer.reject({\n              groupLayerNames,\n              serviceType,\n              url\n            });\n          }\n        );\n      } else {\n        // Wrong service type\n        getCapabilitiesDefer.reject({\n          groupLayerNames,\n          serviceType,\n          url\n        });\n      }\n    }\n  }\n\n  return this.q_.all(promises).then(\n    (responses) => {\n      for (const response of responses) {\n\n        // WMS - For each layer name, find its layer capability object, then\n        //       create the data source\n        if (response.serviceType === ngeoDatasourceOGC.Type.WMS) {\n          for (const layerName of response.groupLayerNames) {\n            const layerCap = ngeoQuerent.wmsFindLayerCapability(\n              response.capabilities['Capability']['Layer']['Layer'],\n              layerName\n            );\n            if (layerCap) {\n              gmfExtDSManager.createAndAddDataSourceFromWMSCapability(\n                layerCap,\n                response.capabilities,\n                response.url\n              );\n            } else {\n              // TODO - handle 'not found' layer in capabilities\n            }\n          }\n\n        } else if (response.serviceType === ngeoDatasourceOGC.Type.WMTS) {\n\n          // WMTS - For each layer name, find its layer capability object, then\n          //        create the data source\n          for (const layerName of response.groupLayerNames) {\n            const layerCap = ngeoQuerent.wmtsFindLayerCapability(\n              response.capabilities['Contents']['Layer'],\n              layerName\n            );\n            if (layerCap) {\n              gmfExtDSManager.createAndAddDataSourceFromWMTSCapability(\n                layerCap,\n                response.capabilities,\n                response.url\n              );\n            } else {\n              // TODO - handle 'not found' layer in capabilities\n            }\n          }\n        }\n      }\n    },\n    (rejections) => {\n      // TODO - handle rejections\n    }\n  );\n};\n\n\n/**\n * @param {!ol.Collection.Event} evt Collection event.\n * @private\n */\nexports.prototype.handleExternalDSGroupCollectionAdd_ = function(evt) {\n  const group = evt.element;\n  googAsserts.assertInstanceof(group, ngeoDatasourceGroup);\n  this.registerExternalDSGroup_(group);\n  this.setExternalDataSourcesState_();\n};\n\n\n/**\n * @param {!ngeo.datasource.Group} group Data source group.\n * @private\n */\nexports.prototype.registerExternalDSGroup_ = function(group) {\n  olEvents.listen(\n    group.dataSourcesCollection,\n    'add',\n    this.setExternalDataSourcesState_,\n    this\n  );\n  olEvents.listen(\n    group.dataSourcesCollection,\n    'remove',\n    this.setExternalDataSourcesState_,\n    this\n  );\n};\n\n\n/**\n * Contains the layer name\n * @param {!ol.layer.Base} layer The layer to inspect\n * @param {string} name The layer name to find\n * @return {boolean} The containing status\n */\nexports.prototype.containsLayerName = function(layer, name) {\n  if (layer instanceof olLayerGroup) {\n    for (const l of layer.getLayers().getArray()) {\n      googAsserts.assert(l);\n      if (this.containsLayerName(l, name)) {\n        return true;\n      }\n    }\n    return false;\n  } else {\n    return layer.get('layerNodeName') == name;\n  }\n};\n\n\n/**\n * @param {!ol.Collection.Event} evt Collection event.\n * @private\n */\nexports.prototype.handleExternalDSGroupCollectionRemove_ = function(evt) {\n  const group = evt.element;\n  googAsserts.assertInstanceof(group, ngeoDatasourceGroup);\n  this.unregisterExternalDSGroup_(group);\n  this.setExternalDataSourcesState_();\n};\n\n\n/**\n * @param {!ngeo.datasource.Group} group Data source group.\n * @private\n */\nexports.prototype.unregisterExternalDSGroup_ = function(group) {\n  olEvents.unlisten(\n    group.dataSourcesCollection,\n    'add',\n    this.setExternalDataSourcesState_,\n    this\n  );\n  olEvents.unlisten(\n    group.dataSourcesCollection,\n    'remove',\n    this.setExternalDataSourcesState_,\n    this\n  );\n};\n\n\n/**\n * Set the External Data Sources parameters in the url.\n * @private\n */\nexports.prototype.setExternalDataSourcesState_ = function() {\n\n  if (this.setExternalDataSourcesStatePromise_) {\n    this.$timeout_.cancel(this.setExternalDataSourcesStatePromise_);\n  }\n\n  this.setExternalDataSourcesStatePromise_ = this.$timeout_(() => {\n    const names = [];\n    const urls = [];\n\n    // (1) Collect WMS Groups and their layer names\n    for (const wmsGroup of this.gmfExternalDataSourcesManager_.wmsGroups) {\n\n      // (1a) url\n      urls.push(wmsGroup.url);\n\n      // (1b) layer names\n      const wmsGroupLayerNames = [];\n      for (const wmsDataSource of wmsGroup.dataSources) {\n        googAsserts.assertInstanceof(wmsDataSource, ngeoDatasourceOGC);\n\n        // External WMS data sources always have only one OGC layer name,\n        // as they are created using a single Capability Layer object that\n        // has only 1 layer name\n        const layerName = wmsDataSource.getOGCLayerNames()[0];\n        wmsGroupLayerNames.push(layerName);\n      }\n      names.push(wmsGroupLayerNames.join(exports.ExtDSSeparator.NAMES));\n    }\n\n    // (2) Collect WMTS Groups and their layer names\n    for (const wmtsGroup of this.gmfExternalDataSourcesManager_.wmtsGroups) {\n\n      // (2a) url\n      urls.push(wmtsGroup.url);\n\n      // (2b) layer names\n      const wmtsGroupLayerNames = [];\n      for (const wmtsDataSource of wmtsGroup.dataSources) {\n        googAsserts.assert(wmtsDataSource.wmtsLayer);\n        wmtsGroupLayerNames.push(wmtsDataSource.wmtsLayer);\n      }\n      names.push(wmtsGroupLayerNames.join(exports.ExtDSSeparator.NAMES));\n    }\n\n    // (3) Update state\n    this.ngeoStateManager_.updateState({\n      [gmfBase.PermalinkParam.EXTERNAL_DATASOURCES_NAMES]: names.join(\n        exports.ExtDSSeparator.LIST\n      ),\n      [gmfBase.PermalinkParam.EXTERNAL_DATASOURCES_URLS]: urls.join(\n        exports.ExtDSSeparator.LIST\n      )\n    });\n\n    // (4) Reset promise\n    this.setExternalDataSourcesStatePromise_ = null;\n  });\n};\n\n\n/**\n * Clean the permalink parameters\n * @param {!Array.<gmfThemes.GmfGroup>} groups firstlevel groups of the tree\n */\nexports.prototype.cleanParams = function(groups) {\n  const keys = googAsserts.assert(this.ngeoLocation_.getParamKeys());\n  for (const key of keys) {\n    if (key.startsWith(exports.ParamPrefix.TREE_GROUP_LAYERS)) {\n      const value = key.substring(exports.ParamPrefix.TREE_GROUP_LAYERS.length);\n      for (const group of groups) {\n        if (group.name == value) {\n          this.ngeoStateManager_.deleteParam(key);\n          break;\n        }\n      }\n    }\n    if (key.startsWith(exports.ParamPrefix.TREE_GROUP_OPACITY)) {\n      const value = key.substring(exports.ParamPrefix.TREE_GROUP_OPACITY.length);\n      for (const group of groups) {\n        if (group.name == value) {\n          this.ngeoStateManager_.deleteParam(key);\n          break;\n        }\n      }\n    }\n  }\n  this.$timeout_(() => {\n    if (!this.map_) {\n      return;\n    }\n    const layer = this.map_.getLayerGroup();\n    googAsserts.assert(layer);\n    for (const key of keys) {\n      if (key.startsWith(exports.ParamPrefix.TREE_ENABLE)) {\n        const value = key.substring(exports.ParamPrefix.TREE_ENABLE.length);\n        if (!this.containsLayerName(layer, value)) {\n          this.ngeoStateManager_.deleteParam(key);\n        }\n      }\n      if (key.startsWith(exports.ParamPrefix.TREE_OPACITY)) {\n        const value = key.substring(exports.ParamPrefix.TREE_OPACITY.length);\n        if (!this.containsLayerName(layer, value)) {\n          this.ngeoStateManager_.deleteParam(key);\n        }\n      }\n    }\n  });\n};\n\n\nexports.module = angular.module('gmfPermalink', [\n  gmfThemeManager.module.name,\n  gmfThemeThemes.module.name,\n  ngeoDrawFeatures.name,\n  ngeoLayertreeController.module.name,\n  ngeoMiscDebounce.name,\n  ngeoMiscEventHelper.module.name,\n  ngeoStatemanagerModule.name,\n]);\n\nexports.module.service('gmfPermalink', exports);\n\n\n/**\n * @enum {string}\n */\nexports.OpenLayersLayerProperties = {\n  OPACITY: 'opacity'\n};\n\n/**\n * @enum {string}\n */\nexports.ParamPrefix = {\n  DIMENSIONS: 'dim_',\n  TREE_ENABLE: 'tree_enable_',\n  TREE_GROUP_LAYERS: 'tree_group_layers_',\n  TREE_GROUP_OPACITY: 'tree_group_opacity_',\n  TREE_OPACITY: 'tree_opacity_',\n  WFS: 'wfs_'\n};\n\n\n/**\n * External data source separators\n * @enum {string}\n */\nexports.ExtDSSeparator = {\n  LIST: ',',\n  NAMES: ';'\n};\n\n\nexports.module.value('gmfPermalinkOptions',\n  /** @type {gmfx.PermalinkOptions} */ ({}));\n\n\n/** Configure the ngeo state manager */\n(function() {\n  const regexp = [];\n  for (const key1 in exports.ParamPrefix) {\n    regexp.push(new RegExp(`${exports.ParamPrefix[key1]}.*`));\n  }\n  for (const key2 in gmfBase.PermalinkParam) {\n    regexp.push(new RegExp(exports.ParamPrefix[key2]));\n  }\n  ngeoStatemanagerService.module.value('ngeoUsedKeyRegexp', regexp);\n})();\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.datepickerComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMiscTime from 'ngeo/misc/Time.js';\n\nimport 'angular-ui-date';\nimport 'jquery-ui/themes/base/all.css';\n\n// FIXME: import the locales in the applications\nimport 'jquery-ui/ui/i18n/datepicker-fr.js';\nimport 'jquery-ui/ui/i18n/datepicker-en-GB.js';\nimport 'jquery-ui/ui/i18n/datepicker-de.js';\nimport 'jquery-ui/ui/i18n/datepicker-it.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDatePicker', [\n  ngeoMiscTime.module.name,\n  'ui.date',\n]);\n\n\nexports.value('ngeoDatePickerTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoDatePickerTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/misc/datepickerComponent';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/misc/datepickerComponent', require('./datepickerComponent.html'));\n});\n\n\n/**\n * Provide a directive to select a single date or a range of dates. Requires\n * jQuery UI for the 'datepicker' widget.\n *\n * @param {string|function(!angular.JQLite=, !angular.Attributes=)}\n * ngeoDatePickerTemplateUrl Template for the directive.\n * @param  {angular.$timeout} $timeout angular timeout service\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoDatePicker\n */\nexports.component_ = function(ngeoDatePickerTemplateUrl,  $timeout) {\n  return {\n    scope: {\n      onDateSelected: '&',\n      time: '='\n    },\n    bindToController: true,\n    controller: 'ngeoDatePickerController as datepickerCtrl',\n    restrict: 'AE',\n    templateUrl: ngeoDatePickerTemplateUrl,\n    link: (scope, element, attrs, ctrl) => {\n      ctrl.init();\n\n      const lang =  ctrl.gettextCatalog_.getCurrentLanguage();\n      $['datepicker']['setDefaults']($['datepicker']['regional'][lang]);\n\n      ctrl.sdateOptions = angular.extend({}, ctrl.sdateOptions, {\n        'minDate': ctrl.initialMinDate,\n        'maxDate': ctrl.initialMaxDate,\n        'onClose': (selectedDate) => {\n          if (selectedDate) {\n            $(element[0]).find('input[name=\"edate\"]').datepicker('option', 'minDate', selectedDate);\n          }\n        }\n      });\n\n      ctrl.edateOptions = angular.extend({}, ctrl.edateOptions, {\n        'minDate': ctrl.initialMinDate,\n        'maxDate': ctrl.initialMaxDate,\n        'onClose': (selectedDate) => {\n          if (selectedDate) {\n            $(element[0]).find('input[name=\"sdate\"]').datepicker('option', 'maxDate', selectedDate);\n          }\n        }\n      });\n\n      angular.element('body').on('hidden.bs.popover', () => {\n        const dp = angular.element('#ui-datepicker-div');\n        if (dp && dp.css('display') === 'block') {\n          $(element[0]).find('input[name$=\"date\"]').datepicker('hide');\n        }\n      });\n\n      $timeout(() => {\n        angular.element('#ui-datepicker-div').on('mousedown', (e) => {\n          e.stopPropagation();\n        });\n      });\n    }\n  };\n};\n\nexports.directive('ngeoDatePicker', exports.component_);\n\n\n/**\n * DatePickerController - directive conttroller\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!angular.$injector} $injector injector.\n * @param {!ngeo.misc.Time} ngeoTime time service.\n * @param {!angularGettext.Catalog} gettextCatalog service.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoDatePickerController\n */\nexports.Controller_ = function($scope, $injector,\n  ngeoTime, gettextCatalog) {\n\n  /**\n   * @type {!ngeo.misc.Time}\n   * @private\n   */\n  this.ngeoTime_ = ngeoTime;\n\n  /**\n   * @type {!ngeox.TimeProperty}\n   * @export\n   */\n  this.time;\n\n  /**\n   * The gettext catalog\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n\n  /**\n   * If the component is used to select a date range\n   * @type {boolean}\n   * @export\n   */\n  this.isModeRange;\n\n\n  /**\n   * Function called after date(s) changed/selected\n   * @type {function({time: {start: number, end: number}})}\n   * @export\n   */\n  this.onDateSelected;\n\n\n  /**\n   * Initial min date for the datepicker\n   * @type {!Date}\n   */\n  this.initialMinDate;\n\n  /**\n   * Initial max date for the datepickeronDateSelected\n   * @type {!Date}\n   */\n  this.initialMaxDate;\n\n  /**\n   * Datepicker options for the second datepicker (only for range mode)\n   * @type {Object}\n   * @export\n   */\n  this.edateOptions = {\n    'changeMonth': true,\n    'changeYear': true\n  };\n\n  /**\n   * Datepicker options for the first datepicker\n   * @type {Object}\n   * @export\n   */\n  this.sdateOptions = {\n    'changeMonth': true,\n    'changeYear': true\n  };\n\n  /**\n   * Start date model for the first date picker\n   * @type {Date}\n   * @export\n   */\n  this.sdate;\n\n  /**\n   * End date model for the second datepicker (only for range mode)\n   * @type {Date}\n   * @export\n   */\n  this.edate;\n\n  $scope.$watchGroup(['datepickerCtrl.sdate', 'datepickerCtrl.edate'], (newDates, oldDates) => {\n    const sDate = newDates[0];\n    const eDate = newDates[1];\n\n    if (angular.isDate(sDate) && (!this.isModeRange || angular.isDate(eDate))) {\n      this.onDateSelected({\n        time: {\n          start: this.ngeoTime_.getTime(sDate),\n          end: this.ngeoTime_.getTime(eDate)\n        }\n      });\n    }\n  });\n};\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.init = function() {\n  //fetch the initial options for the component\n  const initialOptions_ = this.ngeoTime_.getOptions(this.time);\n  this.initialMinDate = this.ngeoTime_.createDate(initialOptions_.minDate);\n  this.initialMaxDate = this.ngeoTime_.createDate(initialOptions_.maxDate);\n  this.isModeRange = this.time.mode === 'range';\n\n  if (this.isModeRange) {\n    googAsserts.assertArray(initialOptions_.values);\n    this.sdate = this.ngeoTime_.createDate(initialOptions_.values[0]);\n    this.edate = this.ngeoTime_.createDate(initialOptions_.values[1]);\n  } else {\n    googAsserts.assertNumber(initialOptions_.values);\n    this.sdate = this.ngeoTime_.createDate(initialOptions_.values);\n  }\n};\n\nexports.controller('ngeoDatePickerController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.format.Attribute\n */\nconst exports = {};\nimport ngeoFormatAttributeType from 'ngeo/format/AttributeType.js';\n\n\n/**\n * Set the `type` and `geomType` properties of an attribute if the given\n * type is a geometry one.\n *\n * @param {ngeox.AttributeBase} attribute Attribute.\n * @param {string} type Type.\n * @return {boolean} Whether both attribute type and geomType were set.\n */\nexports.setGeometryType = function(attribute, type) {\n  const geomRegex =\n    /gml:((Multi)?(Point|Line|Polygon|Curve|Surface|Geometry)).*/;\n  if (geomRegex.exec(type)) {\n    attribute.type = ngeoFormatAttributeType.GEOMETRY;\n    if (/^gml:Point/.exec(type)) {\n      attribute.geomType = 'Point';\n    } else if (/^gml:LineString|^gml:Curve/.exec(type)) {\n      attribute.geomType = 'LineString';\n    } else if (/^gml:Polygon|^gml:Surface/.exec(type)) {\n      attribute.geomType = 'Polygon';\n    } else if (/^gml:MultiPoint/.exec(type)) {\n      attribute.geomType = 'MultiPoint';\n    } else if (/^gml:MultiLineString|^gml:MultiCurve/.exec(type)) {\n      attribute.geomType = 'MultiLineString';\n    } else if (/^gml:MultiPolygon|^gml:MultiSurface/.exec(type)) {\n      attribute.geomType = 'MultiPolygon';\n    }\n  }\n  return !!attribute.type && !!attribute.geomType;\n};\n\n\nexport default exports;\n","/**\n * @module gmf.editing.EnumerateAttribute\n */\nconst exports = class {\n\n  /**\n   * The EnumerateAttribute is responsible of fetching all possible of a given\n   * attribute of a given data source (gmf layer).\n   *\n   * @struct\n   * @param {angular.$http} $http Angular $http service.\n   * @param {string} gmfLayersUrl Url to the GeoMapFish layers service.\n   * @ngInject\n   * @ngdoc service\n   * @ngname gmfEnumerateAttribute\n   */\n  constructor($http, gmfLayersUrl) {\n\n    // === Injected services ===\n\n    /**\n     * @type {angular.$http}\n     * @private\n     */\n    this.http_ = $http;\n\n    /**\n     * @type {string}\n     * @private\n     */\n    this.baseUrl_ = gmfLayersUrl;\n\n    /**\n     * @type {Object.<string, !angular.$q.Promise>}\n     * @private\n     */\n    this.promises_ = {};\n  }\n\n  /**\n   * @param {gmf.datasource.OGC} dataSource Data source.\n   * @param {string} attribute Attribute name.\n   * @return {angular.$q.Promise} Promise.\n   */\n  getAttributeValues(dataSource, attribute) {\n    const promiseId = `${dataSource.id}_${attribute}`;\n    const name = dataSource.name;\n    if (!this.promises_[promiseId]) {\n      const url = `${this.baseUrl_}/${name}/values/${attribute}`;\n      this.promises_[promiseId] = this.http_.get(url).then(\n        this.handleGetAttributeValues_.bind(this));\n    }\n    return this.promises_[promiseId];\n  }\n\n  /**\n   * @param {angular.$http.Response} resp Ajax response.\n   * @return {Array.<gmfThemes.GmfLayerAttributeValue>} List of the attribute\n   *     values.\n   * @export\n   */\n  handleGetAttributeValues_(resp) {\n    const data = /** @type {gmfThemes.GmfLayerAttributeValuesResponse} */ (\n      resp.data);\n    return data.items;\n  }\n\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfEnumerateAttribute', []);\nexports.module.service('gmfEnumerateAttribute', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.File\n */\n/**\n * @constructor\n * @param {angular.$q} $q .\n * @param {angular.$http} $http .\n * @param {gettext} gettext .\n * @ngInject\n */\nconst exports = function($q, $http, gettext) {\n  let fileReader, canceler;\n\n  // Test the validity of the file size\n  this.isValidFileSize = function(fileSize) {\n    return !(fileSize > 20000000); // 20 Mo\n  };\n\n  this.isWmsGetCap = function(fileContent) {\n    return /<(WMT_MS_Capabilities|WMS_Capabilities)/.test(fileContent);\n  };\n\n  this.isWmtsGetCap = function(fileContent) {\n    return /<Capabilities/.test(fileContent);\n  };\n\n  this.isKml = function(fileContent) {\n    return /<kml/.test(fileContent) && /<\\/kml>/.test(fileContent);\n  };\n\n  this.isGpx = function(fileContent) {\n    return /<gpx/.test(fileContent) && /<\\/gpx>/.test(fileContent);\n  };\n\n  /**\n   * @param {!Blob} file .\n   * @return {angular.$q.Promise<string>} .\n   */\n  this.read = function(file) {\n    const defer = $q.defer();\n    if (fileReader && fileReader.readyState === FileReader.LOADING) {\n      fileReader.abort();\n    }\n    fileReader = new FileReader();\n    fileReader.onload = function(evt) {\n      defer.resolve(evt.target.result);\n    };\n    fileReader.onerror = function(evt) {\n      const err = evt.target.error;\n      console.error('Reading file failed: ', err);\n      defer.reject({\n        'message': err.code == 20 ? gettext('Operation canceled') : gettext('Read failed'),\n        'reason': err.message\n      });\n    };\n    fileReader.onprogress = function(evt) {\n      defer.notify(evt);\n    };\n    // Read the file\n    fileReader.readAsText(file);\n    return defer.promise;\n  };\n\n  /**\n   * @param {string} url .\n   * @param {angular.$q.Deferred=} opt_cancelP .\n   * @return {angular.$q.Promise<Blob>} .\n   */\n  this.load = function(url, opt_cancelP) {\n\n    if (canceler) {\n      canceler.resolve();\n    }\n    canceler = opt_cancelP || $q.defer();\n\n    // Angularjs doesn't handle onprogress event\n    const defer = $q.defer();\n    $http.get(url, {\n      timeout: canceler.promise\n    }).then((response) => {\n      defer.resolve(response.data);\n    }, (reason) => {\n      console.error('Uploading file failed: ', reason);\n      defer.reject({\n        'message': gettext('Upload failed'),\n        'reason': reason\n      });\n    });\n    return defer.promise;\n  };\n};\n\nexports.module = angular.module('ngeoFile', []);\n\nexports.module.service('ngeoFile', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.controllers.AbstractDesktopController\n */\nimport gmfControllersAbstractAppController from 'gmf/controllers/AbstractAppController.js';\nimport gmfContextualdataModule from 'gmf/contextualdata/module.js';\nimport gmfDrawingModule from 'gmf/drawing/module.js';\nimport gmfEditingModule from 'gmf/editing/module.js';\nimport gmfPermalinkShareComponent from 'gmf/permalink/shareComponent.js';\nimport gmfPrintComponent from 'gmf/print/component.js';\nimport gmfProfileModule from 'gmf/profile/module.js';\nimport gmfRasterComponent from 'gmf/raster/component.js';\nimport ngeoDrawFeatures from 'ngeo/draw/features.js';\nimport ngeoMapResizemap from 'ngeo/map/resizemap.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoQueryBboxQueryComponent from 'ngeo/query/bboxQueryComponent.js';\nimport gmfImportModule from 'gmf/import/module.js';\nimport * as olBase from 'ol/index.js';\nimport * as olProj from 'ol/proj.js';\nimport * as olObj from 'ol/obj.js';\nimport olCollection from 'ol/Collection.js';\nimport olMap from 'ol/Map.js';\nimport olView from 'ol/View.js';\nimport olControlScaleLine from 'ol/control/ScaleLine.js';\nimport olControlZoom from 'ol/control/Zoom.js';\nimport olControlRotate from 'ol/control/Rotate.js';\nimport * as olInteraction from 'ol/interaction.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\n\n/**\n * Desktop application abstract controller.\n *\n * This file includes `goog.require`'s for desktop components/directives used\n * by the HTML page and the controller to provide the configuration.\n *\n * @param {gmfx.Config} config A part of the application config.\n * @param {angular.Scope} $scope Scope.\n * @param {angular.$injector} $injector Main injector.\n * @constructor\n * @extends {gmf.controllers.AbstractAppController}\n * @ngdoc controller\n * @ngInject\n * @export\n */\nconst exports = function(config, $scope, $injector) {\n\n  const viewConfig = {\n    projection: olProj.get(`EPSG:${config.srid || 21781}`)\n  };\n  olObj.assign(viewConfig, config.mapViewConfig || {});\n\n  const arrow = gmfControllersAbstractAppController.prototype.getLocationIcon();\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map = new olMap({\n    pixelRatio: config.mapPixelRatio,\n    layers: [],\n    view: new olView(viewConfig),\n    controls: config.mapControls || [\n      new olControlScaleLine({\n        target: document.getElementById('scaleline')\n      }),\n      new olControlZoom({\n        zoomInTipLabel: '',\n        zoomOutTipLabel: ''\n      }),\n      new olControlRotate({\n        label: arrow,\n        tipLabel: ''\n      })\n    ],\n    interactions: config.mapInteractions || olInteraction.defaults({\n      pinchRotate: true,\n      altShiftDragRotate: true\n    }),\n    loadTilesWhileAnimating: true,\n    loadTilesWhileInteracting: true\n  });\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.loginActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.toolsActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.modalShareShown = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.editFeatureActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.routingfeatureActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.googleStreetViewActive = false;\n\n  /**\n   * @type {!ol.style.Style}\n   * @export\n   */\n  this.googleStreetViewStyle = new olStyleStyle({\n    text: new olStyleText({\n      fill: new olStyleFill({color: '#279B61'}),\n      font: 'normal 30px FontAwesome',\n      offsetY: -15,\n      stroke: new olStyleStroke({color: '#ffffff', width: 3}),\n      text: '\\uf041'\n    })\n  });\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.importDataSourceActive = false;\n\n  const body = $('body');\n\n  // initialize tooltips\n  body.tooltip({\n    container: 'body',\n    trigger: 'hover',\n    selector: '[data-toggle=\"tooltip\"]'\n  });\n\n  // deactivate tooltips on touch device\n  body.on('touchstart.detectTouch', () => {\n    body.tooltip('destroy');\n    body.off('touchstart.detectTouch');\n  });\n\n  /**\n   * Collection of features for the draw interaction\n   * @type {ol.Collection.<ol.Feature>}\n   */\n  const ngeoFeatures = $injector.get('ngeoFeatures');\n\n  /**\n   * @type {ngeo.map.FeatureOverlay}\n   * @export\n   */\n  this.drawFeatureLayer = $injector.get('ngeoFeatureOverlayMgr')\n    .getFeatureOverlay();\n  this.drawFeatureLayer.setFeatures(ngeoFeatures);\n\n  const ngeoFeatureHelper = $injector.get('ngeoFeatureHelper');\n\n  /**\n   * @type {ol.layer.Vector}\n   * @export\n   */\n  this.editFeatureVectorLayer = new olLayerVector({\n    source: new olSourceVector({\n      wrapX: false,\n      features: new olCollection()\n    }),\n    style: (feature, resolution) => ngeoFeatureHelper.createEditingStyles(feature)\n    // style: ngeoFeatureHelper.createEditingStyles.bind(ngeoFeatureHelper)\n  });\n  this.editFeatureVectorLayer.setMap(this.map);\n\n  /**\n   * The ngeo ToolActivate manager service.\n   * @type {ngeo.misc.ToolActivateMgr}\n   */\n  const ngeoToolActivateMgr = $injector.get('ngeoToolActivateMgr');\n\n  const editFeatureActivate = new ngeoMiscToolActivate(this, 'editFeatureActive');\n  ngeoToolActivateMgr.registerTool('mapTools', editFeatureActivate, false);\n\n  const googleStreetViewActivate = new ngeoMiscToolActivate(\n    this,\n    'googleStreetViewActive'\n  );\n  ngeoToolActivateMgr.registerTool('mapTools', googleStreetViewActivate, false);\n\n  /**\n   * @type {ngeox.ScaleselectorOptions}\n   * @export\n   */\n  this.scaleSelectorOptions = {\n    dropup: true\n  };\n\n  /**\n   * @type {ol.geom.LineString}\n   * @export\n   */\n  this.profileLine = null;\n\n  gmfControllersAbstractAppController.call(this, config, $scope, $injector);\n\n  // Close the login panel on successful login.\n  $scope.$watch(() => this.gmfUser.username, (newVal) => {\n    if (newVal !== null && this.loginActive) {\n      this.loginActive = false;\n    }\n  });\n};\n\nolBase.inherits(exports, gmfControllersAbstractAppController);\n\nexports.module = angular.module('GmfAbstractDesktopControllerModule', [\n  gmfControllersAbstractAppController.module.name,\n  gmfContextualdataModule.name,\n  gmfDrawingModule.name,\n  gmfEditingModule.name,\n  gmfPermalinkShareComponent.name,\n  gmfPrintComponent.name,\n  gmfProfileModule.name,\n  gmfRasterComponent.name,\n  ngeoDrawFeatures.name,\n  ngeoMapResizemap.name,\n  ngeoQueryBboxQueryComponent.name,\n  gmfImportModule.name,\n]);\n\nexports.module.controller(\n  'AbstractDesktopController',\n  exports);\n\nexports.module.value('isDesktop', true);\n\nexports.module.value('ngeoQueryOptions', {\n  'limit': 20\n});\n\nexports.module.value('ngeoSnappingTolerance', 20);\nexports.module.value('ngeoSnappingSource', new olSourceVector());\n\nexports.module.value('ngeoMeasurePrecision', 3);\nexports.module.value('ngeoMeasureDecimals', 0);\n\nexport default exports;\n","/**\n * @module gmf.contextualdata.component\n */\nimport gmfRasterRasterService from 'gmf/raster/RasterService.js';\nimport googAsserts from 'goog/asserts.js';\nimport olOverlay from 'ol/Overlay.js';\nimport * as olProj from 'ol/proj.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olObj from 'ol/obj.js';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('gmfContextualdata', [\n  gmfRasterRasterService.module.name,\n]);\n\n\n/**\n * Provide a directive responsible of displaying contextual data after a right\n * click on the map.\n *\n * This directive doesn't require being rendered in a visible DOM element.\n * It's usually added to the element where the map directive is also added.\n *\n * Example:\n *\n *     <gmf-map gmf-map-map=\"mainCtrl.map\"\n *         gmf-contextualdata\n *         gmf-contextualdata-map=\"::mainCtrl.map\"\n *         gmf-contextualdata-projections=\"::[21781,4326]\">\n *\n * The content of the popover is managed in a partial that must be defined\n * using the `gmfContextualdatacontentTemplateUrl` value. See\n * {@link gmf.contextualdatacontentDirective} for more details.\n *\n * One can also provide a `gmf-contextualdata-callback` attribute in order to\n * do some additional computing on the coordinate or the values received for\n * the raster service. The callback function is called with the coordinate of\n * the clicked point and the response data from the server. It is intended to\n * return an object of additional properties to add to the scope.\n *\n * See the [../examples/contribs/gmf/contextualdata.html](../examples/contribs/gmf/contextualdata.html) example for a usage sample.\n *\n * @htmlAttribute {ol.Map} map The map.\n * @htmlAttribute {Array<number>} projections The list of projections.\n * @htmlAttribute {Function} callback A function called after server\n *    (raster) data is received in case some additional computing is required.\n *    Optional.\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname gmfContextualdata\n */\nexports.directive_ = function() {\n  return {\n    restrict: 'A',\n    scope: false,\n    controller: 'GmfContextualdataController as cdCtrl',\n    bindToController: {\n      'map': '<gmfContextualdataMap',\n      'projections': '<gmfContextualdataProjections',\n      'callback': '<gmfContextualdataCallback'\n    },\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     * @param {gmf.contextualdata.component.Controller_} controller Controller.\n     */\n    link: (scope, element, attrs, controller) => {\n      controller.init();\n    }\n  };\n};\n\nexports.directive('gmfContextualdata',\n  exports.directive_);\n\n\n/**\n *\n * @param {angular.$compile} $compile Angular compile service.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {!angular.Scope} $scope Scope.\n * @param {gmf.raster.RasterService} gmfRaster Gmf Raster service\n * @param {angular.$injector} $injector Angular injector service.\n *\n * @constructor\n * @private\n * @ngdoc controller\n * @ngInject\n */\nexports.Controller_ = function($compile, $timeout, $scope, gmfRaster, $injector) {\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {Array<number>}\n   * @export\n   */\n  this.projections;\n\n  /**\n   * @type {function(ol.Coordinate, Object):Object}\n   * @export\n   */\n  this.callback;\n\n  /**\n   * @type {ol.Overlay}\n   * @private\n   */\n  this.overlay_;\n\n  /**\n   * @type {angular.$compile}\n   * @private\n   */\n  this.$compile_ = $compile;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.$scope_ = $scope;\n\n  /**\n   * @type {gmf.raster.RasterService}\n   * @private\n   */\n  this.gmfRaster_ = gmfRaster;\n\n  /**\n   * @type {Object}\n   * @private\n   */\n  this.gmfContextualdataOptions_ = $injector.has('gmfContextualdataOptions') ?\n    $injector.get('gmfContextualdataOptions') : {};\n\n  angular.element('body').on('mousedown', this.hidePopover.bind(this));\n};\n\n/**\n *\n */\nexports.Controller_.prototype.init = function() {\n  this.preparePopover_();\n\n  const mapDiv = this.map.getTargetElement();\n  googAsserts.assertElement(mapDiv);\n\n  olEvents.listen(mapDiv, 'contextmenu',\n    this.handleMapContextMenu_, this);\n};\n\n/**\n * @param {!Event} event Event.\n * @private\n */\nexports.Controller_.prototype.handleMapContextMenu_ = function(event) {\n  this.$scope_.$apply(() => {\n    const pixel = this.map.getEventPixel(event);\n    const coordinate = this.map.getCoordinateFromPixel(pixel);\n    this.setContent_(coordinate);\n    event.preventDefault();\n    this.hidePopover();\n    this.showPopover();\n\n    // Use timeout to let the popover content to be rendered before displaying it.\n    this.timeout_(() => {\n      this.overlay_.setPosition(coordinate);\n    });\n  });\n};\n\nexports.Controller_.prototype.setContent_ = function(coordinate) {\n  const scope = this.$scope_.$new(true);\n  this.$compile_(this.content_)(scope);\n\n  const mapProjection = this.map.getView().getProjection().getCode();\n  this.projections.forEach((proj) => {\n    const coord = olProj.transform(coordinate, mapProjection, `EPSG:${proj}`);\n    scope[`coord_${proj}`] = coord;\n    scope[`coord_${proj}_eastern`] = coord[0];\n    scope[`coord_${proj}_northern`] = coord[1];\n  });\n\n  const getRasterSuccess = function(resp) {\n    olObj.assign(scope, resp);\n    if (this.callback) {\n      olObj.assign(scope, this.callback.call(this, coordinate, resp));\n    }\n  }.bind(this);\n  const getRasterError = function(resp) {\n    console.error('Error on getting the raster.');\n  };\n  this.gmfRaster_.getRaster(coordinate, this.gmfContextualdataOptions_.rasterParams).then(\n    getRasterSuccess,\n    getRasterError\n  );\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.preparePopover_ = function() {\n\n  const container = document.createElement('DIV');\n  container.classList.add('popover');\n  container.classList.add('bottom');\n  container.classList.add('gmf-contextualdata');\n  angular.element(container).css('position', 'relative');\n  const arrow = document.createElement('DIV');\n  arrow.classList.add('arrow');\n  container.appendChild(arrow);\n  this.content_ = document.createElement('DIV');\n  this.content_.setAttribute('gmf-contextualdatacontent', '');\n  this.content_.classList.add('popover-content');\n  container.appendChild(this.content_);\n\n  this.overlay_ = new olOverlay({\n    element: container,\n    stopEvent: true,\n    autoPan: true,\n    autoPanAnimation: /** @type {olx.animation.PanOptions} */ ({\n      duration: 250\n    }),\n    positioning: 'top-center'\n  });\n  this.map.addOverlay(this.overlay_);\n};\n\nexports.Controller_.prototype.showPopover = function() {\n  const element = /** @type {Object} */ (this.overlay_.getElement());\n  angular.element(element).css('display', 'block');\n};\n\nexports.Controller_.prototype.hidePopover = function() {\n  const element = /** @type {Object} */ (this.overlay_.getElement());\n  angular.element(element).css('display', 'none');\n};\n\nexports.controller('GmfContextualdataController', exports.Controller_);\n\n\n/**\n * Provide a directive responsible of formatting the content of the popover for\n * the contextual data directive.\n *\n * Its main purpose is to configure the template to be used.\n * Integrators should ensure that the template values match the configuration\n * of the contextual data directive.\n *\n * For each projection the following expressions can be used (replace xxxx by\n * the relevant projection code:\n *  - {{coord_xxxx}},\n *  - {{coord_xxxx_eastern}},\n *  - {{coord_xxxx_northern}}\n *\n * Tip: one should use the `ngeoNumberCoordinates` and `ngeoDMSCoordinates`.\n *\n * The raster service is requested to query additional information. The\n * integrators can also use `{{xxxx}}` where `xxxx` will be replaced by\n * the name of the raster layers (for example 'srtm').\n *\n * See the [../examples/contribs/gmf/contextualdata.html](../examples/contribs/gmf/contextualdata.html) example for a usage sample.\n *\n * @param {string} gmfContextualdatacontentTemplateUrl Url to template.\n * @return {angular.Directive} The Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfContextualdatacontent\n */\nexports.contentDirective_ = function(\n  gmfContextualdatacontentTemplateUrl) {\n  return {\n    restrict: 'A',\n    scope: true,\n    templateUrl: gmfContextualdatacontentTemplateUrl\n  };\n};\n\nexports.directive('gmfContextualdatacontent', exports.contentDirective_);\n\n\nexport default exports;\n","/**\n * @module gmf.contextualdata.module\n */\nimport gmfContextualdataComponent from 'gmf/contextualdata/component.js';\n\nimport './contextualdata.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfContextualdataModule', [\n  gmfContextualdataComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.format.FeatureHashStyleType\n */\n/**\n * @enum {string}\n * @export\n */\nconst exports = {\n  LINE_STRING: 'LineString',\n  POINT: 'Point',\n  POLYGON: 'Polygon'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.format.FeatureHash\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoFormatFeatureHashStyleType from 'ngeo/format/FeatureHashStyleType.js';\nimport ngeoUtils from 'ngeo/utils.js';\nimport * as olBase from 'ol/index.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olColor from 'ol/color.js';\nimport * as olArray from 'ol/array.js';\nimport * as olFormatFeature from 'ol/format/Feature.js';\nimport olFormatTextFeature from 'ol/format/TextFeature.js';\nimport olGeomGeometryLayout from 'ol/geom/GeometryLayout.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomMultiLineString from 'ol/geom/MultiLineString.js';\nimport olGeomMultiPoint from 'ol/geom/MultiPoint.js';\nimport olGeomMultiPolygon from 'ol/geom/MultiPolygon.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\n\n/**\n * @classdesc\n * Provide an OpenLayers format for encoding and decoding features for use\n * in permalinks.\n *\n * The code is based on Stéphane Brunner's URLCompressed format.\n *\n * TODOs:\n *\n * - The OpenLayers-URLCompressed format has options where the user\n *   can define attribute and style transformers. This is currently\n *   not supported by this format.\n * - The OpenLayers-URLCompressed format has a \"simplify\" option.\n *   This format does not have it.\n * - ol.style.Icon styles are not supported.\n * - Transformation of coordinates during encoding and decoding is\n *   not supported.\n *\n * @see https://github.com/sbrunner/OpenLayers-URLCompressed\n * @constructor\n * @struct\n * @extends {ol.format.TextFeature}\n * @param {ngeox.format.FeatureHashOptions=} opt_options Options.\n */\nconst exports = function(opt_options) {\n\n  olFormatTextFeature.call(this);\n\n  const options = opt_options !== undefined ? opt_options : {};\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.accuracy_ = options.accuracy !== undefined ?\n    options.accuracy : exports.ACCURACY_;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.encodeStyles_ = options.encodeStyles !== undefined ?\n    options.encodeStyles : true;\n\n  /**\n   * @type {function(ol.Feature):Object.<string, (string|number)>}\n   * @private\n   */\n  this.propertiesFunction_ = options.properties !== undefined ?\n    options.properties : exports.defaultPropertiesFunction_;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.setStyle_ = options.setStyle !== undefined ? options.setStyle : true;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.prevX_ = 0;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.prevY_ = 0;\n\n  /**\n   * @type {Object.<string, string>}\n   * @private\n   */\n  exports.LegacyProperties_ = (options.propertiesType !== undefined) &&  options.propertiesType;\n\n  /**\n   * @type {Object.<string, function(ol.Feature)>}\n   * @private\n   */\n  this.defaultValues_ = options.defaultValues !== undefined ? options.defaultValues : {};\n\n};\n\nolBase.inherits(exports, olFormatTextFeature);\n\n\n/**\n * @type {Object.<ol.geom.GeometryType, ngeo.format.FeatureHashStyleType>}\n * @private\n */\nexports.StyleTypes_ = {\n  'LineString': ngeoFormatFeatureHashStyleType.LINE_STRING,\n  'Point': ngeoFormatFeatureHashStyleType.POINT,\n  'Polygon': ngeoFormatFeatureHashStyleType.POLYGON,\n  'MultiLineString': ngeoFormatFeatureHashStyleType.LINE_STRING,\n  'MultiPoint': ngeoFormatFeatureHashStyleType.POINT,\n  'MultiPolygon': ngeoFormatFeatureHashStyleType.POLYGON\n};\n\n/**\n * @type {Object.<string, string>}\n * @private\n */\nexports.LegacyProperties_ = {};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.readFeature;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.readFeatures;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.readGeometry;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.writeFeature;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.writeFeatures;\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.writeGeometry;\n\n\n/**\n * Characters used to encode the coordinates. The characters \"~\", \"'\", \"(\"\n * and \")\" are not part of this character set, and used as separators (for\n * example to separate the coordinates from the feature properties).\n * @const\n * @private\n */\nexports.CHAR64_ =\n    '.-_!*ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghjkmnpqrstuvwxyz';\n\n\n/**\n * @const\n * @private\n */\nexports.ACCURACY_ = 0.1;\n\n\n/**\n * Get features's properties.\n * @param {ol.Feature} feature Feature.\n * @return {Object.<string, (string|number)>} The feature properties to\n * serialize.\n * @private\n */\nexports.defaultPropertiesFunction_ = function(feature) {\n  return feature.getProperties();\n};\n\n\n/**\n * Sign then encode a number.\n * @param {number} num Number.\n * @return {string} String.\n * @private\n */\nexports.encodeSignedNumber_ = function(num) {\n  let signedNum = num << 1;\n  if (num < 0) {\n    signedNum = ~(signedNum);\n  }\n  return exports.encodeNumber_(signedNum);\n};\n\n\n/**\n * Transform a number into a logical sequence of characters.\n * @param {number} num Number.\n * @return {string} String.\n * @private\n */\nexports.encodeNumber_ = function(num) {\n  let encodedNumber = '';\n  while (num >= 0x20) {\n    encodedNumber += exports.CHAR64_.charAt(\n      0x20 | (num & 0x1f));\n    num >>= 5;\n  }\n  encodedNumber += exports.CHAR64_.charAt(num);\n  return encodedNumber;\n};\n\n\n/**\n * For a type of geometry, transforms an array of {@link ol.style.Style} into\n * a logical sequence of characters and put the result into the given encoded\n * styles's array.\n * @param {Array.<ol.style.Style>} styles Styles.\n * @param {ol.geom.GeometryType} geometryType Geometry type.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStyles_ = function(styles, geometryType, encodedStyles) {\n  const styleType = exports.StyleTypes_[geometryType];\n  googAsserts.assert(styleType !== undefined);\n  for (let i = 0; i < styles.length; ++i) {\n    const style = styles[i];\n    const fillStyle = style.getFill();\n    const imageStyle = style.getImage();\n    const strokeStyle = style.getStroke();\n    const textStyle = style.getText();\n    if (styleType == ngeoFormatFeatureHashStyleType.POLYGON) {\n      if (fillStyle !== null) {\n        exports.encodeStylePolygon_(\n          fillStyle, strokeStyle, encodedStyles);\n      }\n    } else if (styleType == ngeoFormatFeatureHashStyleType.LINE_STRING) {\n      if (strokeStyle !== null) {\n        exports.encodeStyleLine_(strokeStyle, encodedStyles);\n      }\n    } else if (styleType == ngeoFormatFeatureHashStyleType.POINT) {\n      if (imageStyle !== null) {\n        exports.encodeStylePoint_(imageStyle, encodedStyles);\n      }\n    }\n    if (textStyle !== null) {\n      exports.encodeStyleText_(textStyle, encodedStyles);\n    }\n  }\n};\n\n\n/**\n * Transform an {@link ol.style.Stroke} into a logical sequence of\n * characters and put the result into the given encoded styles's array.\n * @param {ol.style.Stroke} strokeStyle Stroke style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStyleLine_ = function(strokeStyle, encodedStyles) {\n  exports.encodeStyleStroke_(strokeStyle, encodedStyles);\n};\n\n\n/**\n * Transform an {@link ol.style.Circle} into a logical sequence of\n * characters and put the result into the given encoded styles's array.\n * @param {ol.style.Image} imageStyle Image style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStylePoint_ = function(imageStyle, encodedStyles) {\n  if (imageStyle instanceof olStyleCircle) {\n    const radius = imageStyle.getRadius();\n    if (encodedStyles.length > 0) {\n      encodedStyles.push('\\'');\n    }\n    encodedStyles.push(encodeURIComponent(`pointRadius*${radius}`));\n    const fillStyle = imageStyle.getFill();\n    if (fillStyle !== null) {\n      exports.encodeStyleFill_(fillStyle, encodedStyles);\n    }\n    const strokeStyle = imageStyle.getStroke();\n    if (strokeStyle !== null) {\n      exports.encodeStyleStroke_(strokeStyle, encodedStyles);\n    }\n  }\n};\n\n\n/**\n * Transform an {@link ol.style.Fill} and an {@link ol.style.Stroke} into\n * a logical sequence of characters and put the result into the given\n * encoded styles's array.\n * @param {ol.style.Fill} fillStyle Fill style.\n * @param {ol.style.Stroke} strokeStyle Stroke style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStylePolygon_ = function(fillStyle, strokeStyle, encodedStyles) {\n  exports.encodeStyleFill_(fillStyle, encodedStyles);\n  if (strokeStyle !== null) {\n    exports.encodeStyleStroke_(strokeStyle, encodedStyles);\n  }\n};\n\n\n/**\n * Transform an {@link ol.style.Fill} and optionally its properties into\n * a logical sequence of characters and put the result into the given encoded\n * styles's array.\n * @param {ol.style.Fill} fillStyle Fill style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @param {string=} opt_propertyName Property name.\n * @private\n */\nexports.encodeStyleFill_ = function(fillStyle, encodedStyles, opt_propertyName) {\n  const propertyName = opt_propertyName !== undefined ?\n    opt_propertyName : 'fillColor';\n  const fillColor = fillStyle.getColor();\n  if (fillColor !== null) {\n    googAsserts.assert(Array.isArray(fillColor), 'only supporting fill colors');\n    const fillColorRgba = olColor.asArray(fillColor);\n    googAsserts.assert(Array.isArray(fillColorRgba), 'fill color must be an array');\n    const fillColorHex = ngeoUtils.rgbArrayToHex(fillColorRgba);\n    if (encodedStyles.length > 0) {\n      encodedStyles.push('\\'');\n    }\n    encodedStyles.push(\n      encodeURIComponent(`${propertyName}*${fillColorHex}`));\n  }\n};\n\n\n/**\n * Transform an {@link ol.style.Stroke} into a logical sequence of\n * characters and put the result into the given encoded styles's array.\n * @param {ol.style.Stroke} strokeStyle Stroke style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStyleStroke_ = function(strokeStyle, encodedStyles) {\n  const strokeColor = strokeStyle.getColor();\n  if (strokeColor !== null) {\n    googAsserts.assert(Array.isArray(strokeColor));\n    const strokeColorRgba = olColor.asArray(strokeColor);\n    googAsserts.assert(Array.isArray(strokeColorRgba), 'only supporting stroke colors');\n    const strokeColorHex = ngeoUtils.rgbArrayToHex(strokeColorRgba);\n    if (encodedStyles.length > 0) {\n      encodedStyles.push('\\'');\n    }\n    encodedStyles.push(encodeURIComponent(`strokeColor*${strokeColorHex}`));\n  }\n  const strokeWidth = strokeStyle.getWidth();\n  if (strokeWidth !== undefined) {\n    if (encodedStyles.length > 0) {\n      encodedStyles.push('\\'');\n    }\n    encodedStyles.push(encodeURIComponent(`strokeWidth*${strokeWidth}`));\n  }\n};\n\n\n/**\n * Transform an {@link ol.style.Text} into a logical sequence of characters and\n * put the result into the given encoded styles's array.\n * @param {ol.style.Text} textStyle Text style.\n * @param {Array.<string>} encodedStyles Encoded styles array.\n * @private\n */\nexports.encodeStyleText_ = function(textStyle, encodedStyles) {\n  const fontStyle = textStyle.getFont();\n  if (fontStyle !== undefined) {\n    const font = fontStyle.split(' ');\n    if (font.length >= 3) {\n      if (encodedStyles.length > 0) {\n        encodedStyles.push('\\'');\n      }\n      encodedStyles.push(encodeURIComponent(`fontSize*${font[1]}`));\n    }\n  }\n  const fillStyle = textStyle.getFill();\n  if (fillStyle !== null) {\n    exports.encodeStyleFill_(\n      fillStyle, encodedStyles, 'fontColor');\n  }\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.LineString}.\n * @param {string} text Text.\n * @return {ol.geom.LineString} Line string.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readLineStringGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'l(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  const flatCoordinates = this.decodeCoordinates_(text);\n  const lineString = new olGeomLineString(null);\n  lineString.setFlatCoordinates(olGeomGeometryLayout.XY, flatCoordinates);\n  return lineString;\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.MultiLineString}.\n * @param {string} text Text.\n * @return {ol.geom.MultiLineString} Line string.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readMultiLineStringGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'L(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  let flatCoordinates = [];\n  const ends = [];\n  const lineStrings = text.split('\\'');\n  for (let i = 0, ii = lineStrings.length; i < ii; ++i) {\n    flatCoordinates = this.decodeCoordinates_(lineStrings[i], flatCoordinates);\n    ends[i] = flatCoordinates.length;\n  }\n  const multiLineString = new olGeomMultiLineString(null);\n  multiLineString.setFlatCoordinates(\n    olGeomGeometryLayout.XY, flatCoordinates, ends);\n  return multiLineString;\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.Point}.\n * @param {string} text Text.\n * @return {ol.geom.Point} Point.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readPointGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'p(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  const flatCoordinates = this.decodeCoordinates_(text);\n  googAsserts.assert(flatCoordinates.length === 2);\n  const point = new olGeomPoint(null);\n  point.setFlatCoordinates(olGeomGeometryLayout.XY, flatCoordinates);\n  return point;\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.MultiPoint}.\n * @param {string} text Text.\n * @return {ol.geom.MultiPoint} MultiPoint.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readMultiPointGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'P(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  const flatCoordinates = this.decodeCoordinates_(text);\n  const multiPoint = new olGeomMultiPoint(null);\n  multiPoint.setFlatCoordinates(olGeomGeometryLayout.XY, flatCoordinates);\n  return multiPoint;\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.Polygon}.\n * @param {string} text Text.\n * @return {ol.geom.Polygon} Polygon.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readPolygonGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'a(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  let flatCoordinates = [];\n  const ends = [];\n  const rings = text.split('\\'');\n  for (let i = 0, ii = rings.length; i < ii; ++i) {\n    flatCoordinates = this.decodeCoordinates_(rings[i], flatCoordinates);\n    let end = flatCoordinates.length;\n    if (i === 0) {\n      flatCoordinates[end++] = flatCoordinates[0];\n      flatCoordinates[end++] = flatCoordinates[1];\n    } else {\n      flatCoordinates[end++] = flatCoordinates[ends[i - 1]];\n      flatCoordinates[end++] = flatCoordinates[ends[i - 1] + 1];\n    }\n    ends[i] = end;\n  }\n  const polygon = new olGeomPolygon(null);\n  polygon.setFlatCoordinates(olGeomGeometryLayout.XY, flatCoordinates, ends);\n  return polygon;\n};\n\n\n/**\n * Read a logical sequence of characters and return a corresponding\n * {@link ol.geom.MultiPolygon}.\n * @param {string} text Text.\n * @return {ol.geom.MultiPolygon} MultiPolygon.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.readMultiPolygonGeometry_ = function(text) {\n  googAsserts.assert(text.substring(0, 2) === 'A(');\n  googAsserts.assert(text[text.length - 1] == ')');\n  text = text.substring(2, text.length - 1);\n  let flatCoordinates = [];\n  const endss = [];\n  const polygons = text.split(')(');\n  for (let i = 0, ii = polygons.length; i < ii; ++i) {\n    const rings = polygons[i].split('\\'');\n    const ends = endss[i] = [];\n    for (let j = 0, jj = rings.length; j < jj; ++j) {\n      flatCoordinates = this.decodeCoordinates_(rings[j], flatCoordinates);\n      let end = flatCoordinates.length;\n      if (j === 0) {\n        flatCoordinates[end++] = flatCoordinates[0];\n        flatCoordinates[end++] = flatCoordinates[1];\n      } else {\n        flatCoordinates[end++] = flatCoordinates[ends[j - 1]];\n        flatCoordinates[end++] = flatCoordinates[ends[j - 1] + 1];\n      }\n      ends[j] = end;\n    }\n  }\n  const multipolygon = new olGeomMultiPolygon(null);\n  multipolygon.setFlatCoordinates(\n    olGeomGeometryLayout.XY, flatCoordinates, endss);\n  return multipolygon;\n};\n\n\n/**\n * DEPRECATED - Use the `ngeo.misc.FeatureHelper` instead in combination with the\n * `setStyle: false` option.\n *\n * Read a logical sequence of characters and apply the decoded style on the\n * given feature.\n * @param {string} text Text.\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.setStyleInFeature_ = function(text, feature) {\n  if (text == '') {\n    return;\n  }\n  const properties = exports.getStyleProperties_(text, feature);\n  const fillColor = properties['fillColor'];\n  const fontSize = properties['fontSize'];\n  const fontColor = properties['fontColor'];\n  const pointRadius = properties['pointRadius'];\n  const strokeColor = properties['strokeColor'];\n  const strokeWidth = properties['strokeWidth'];\n\n  let fillStyle = null;\n  if (fillColor !== undefined) {\n    fillStyle = new olStyleFill({\n      color: /** @type {Array<number>|string} */ (fillColor)\n    });\n  }\n  let strokeStyle = null;\n  if (strokeColor !== undefined && strokeWidth !== undefined) {\n    strokeStyle = new olStyleStroke({\n      color: /** @type {Array<number>|string} */ (strokeColor),\n      width: /** @type {number} */ (strokeWidth)\n    });\n  }\n  let imageStyle = null;\n  if (pointRadius !== undefined) {\n    imageStyle = new olStyleCircle({\n      radius: /** @type {number} */ (pointRadius),\n      fill: fillStyle,\n      stroke: strokeStyle\n    });\n    fillStyle = strokeStyle = null;\n  }\n  let textStyle = null;\n  if (fontSize !== undefined && fontColor !== undefined) {\n    textStyle = new olStyleText({\n      font: `${fontSize} sans-serif`,\n      fill: new olStyleFill({\n        color: /** @type {Array<number>|string} */ (fontColor)\n      })\n    });\n  }\n  const style = new olStyleStyle({\n    fill: fillStyle,\n    image: imageStyle,\n    stroke: strokeStyle,\n    text: textStyle\n  });\n  feature.setStyle(style);\n};\n\n\n/**\n * Read a logical sequence of characters and apply the decoded result as\n * style properties for the feature. Legacy keys are converted to the new ones\n * for compatibility.\n * @param {string} text Text.\n * @param {ol.Feature} feature Feature.\n * @private\n */\nexports.setStyleProperties_ = function(text, feature) {\n\n  const properties = exports.getStyleProperties_(text, feature);\n  const geometry = feature.getGeometry();\n\n  // Deal with legacy properties\n  if (geometry instanceof olGeomPoint) {\n    if (properties['isLabel'] ||\n        properties[ngeoFormatFeatureProperties.IS_TEXT]) {\n      delete properties['strokeColor'];\n      delete properties['fillColor'];\n    } else {\n      delete properties['fontColor'];\n      delete properties['fontSize'];\n    }\n  } else {\n    delete properties['fontColor'];\n\n    if (geometry instanceof olGeomLineString) {\n      delete properties['fillColor'];\n      delete properties['fillOpacity'];\n    }\n  }\n\n  // Convert font size from px to pt\n  if (properties['fontSize']) {\n    let fontSize = parseFloat(properties['fontSize']);\n    if (properties['fontSize'].indexOf('px') !== -1) {\n      fontSize = Math.round(fontSize / 1.333333);\n    }\n    properties['fontSize'] = fontSize;\n  }\n\n  // Convert legacy properties\n  const clone = {};\n  for (const key in properties) {\n    const value = properties[key];\n    if (exports.LegacyProperties_[key]) {\n      clone[exports.LegacyProperties_[key]] = value;\n    } else {\n      clone[key] = value;\n    }\n  }\n\n  feature.setProperties(clone);\n};\n\n\n/**\n * Cast values in the correct type depending on the property.\n * @param {string} key Key.\n * @param {string} value Value.\n * @return {number|boolean|string} The casted value corresponding to the key.\n * @private\n */\nexports.castValue_ = function(key, value) {\n  const numProperties = [\n    ngeoFormatFeatureProperties.ANGLE,\n    ngeoFormatFeatureProperties.OPACITY,\n    ngeoFormatFeatureProperties.SIZE,\n    ngeoFormatFeatureProperties.STROKE,\n    'pointRadius',\n    'strokeWidth'\n  ];\n  const boolProperties = [\n    ngeoFormatFeatureProperties.IS_CIRCLE,\n    ngeoFormatFeatureProperties.IS_RECTANGLE,\n    ngeoFormatFeatureProperties.IS_TEXT,\n    ngeoFormatFeatureProperties.SHOW_MEASURE,\n    ngeoFormatFeatureProperties.SHOW_LABEL,\n    'isCircle',\n    'isRectangle',\n    'isLabel',\n    'showMeasure',\n    'showLabel'\n  ];\n\n  if (olArray.includes(numProperties, key)) {\n    return +value;\n  } else if (olArray.includes(boolProperties, key)) {\n    return (value === 'true') ? true : false;\n  } else {\n    return value;\n  }\n};\n\n\n/**\n * From a logical sequence of characters, create and return an object of\n * style properties for a feature. The values are cast in the correct type\n * depending on the property. Some properties are also deleted when they don't\n * match the geometry of the feature.\n * @param {string} text Text.\n * @param {ol.Feature} feature Feature.\n * @return {Object.<string, boolean|number|string>} The style properties for\n *     the feature.\n * @private\n */\nexports.getStyleProperties_ = function(text, feature) {\n  const parts = text.split('\\'');\n  const properties = {};\n\n  for (let i = 0; i < parts.length; ++i) {\n    const part = decodeURIComponent(parts[i]);\n    const keyVal = part.split('*');\n    googAsserts.assert(keyVal.length === 2);\n    const key = keyVal[0];\n    const val = keyVal[1];\n\n    properties[key] = exports.castValue_(key, val);\n  }\n\n  return properties;\n};\n\n\n/**\n * Encode a {@link ol.geom.LineString} geometry into a logical sequence of\n * characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writeLineStringGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomLineString);\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  const end = flatCoordinates.length;\n  return `l(${this.encodeCoordinates_(flatCoordinates, stride, 0, end)})`;\n};\n\n\n/**\n * Encode a {@link ol.geom.MultiLineString} geometry into a logical sequence\n * of characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writeMultiLineStringGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomMultiLineString);\n  const ends = geometry.getEnds();\n  const lineStringCount = ends.length;\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  let offset = 0;\n  const textArray = ['L('];\n  for (let i = 0; i < lineStringCount; ++i) {\n    const end = ends[i];\n    const text = this.encodeCoordinates_(flatCoordinates, stride, offset, end);\n    if (i !== 0) {\n      textArray.push('\\'');\n    }\n    textArray.push(text);\n    offset = end;\n  }\n  textArray.push(')');\n  return textArray.join('');\n};\n\n\n/**\n * Encode a {@link ol.geom.Point} geometry into a logical sequence of\n * characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writePointGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomPoint);\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  const end = flatCoordinates.length;\n  return `p(${this.encodeCoordinates_(flatCoordinates, stride, 0, end)})`;\n};\n\n\n/**\n * Encode an {@link ol.geom.MultiPoint} geometry into a logical sequence\n * of characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writeMultiPointGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomMultiPoint);\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  const end = flatCoordinates.length;\n  return `P(${this.encodeCoordinates_(flatCoordinates, stride, 0, end)})`;\n};\n\n\n/**\n * Helper to encode an {@link ol.geom.Polygon} geometry.\n * @param {Array.<number>} flatCoordinates Flat coordinates.\n * @param {number} stride Stride.\n * @param {number} offset Offset.\n * @param {Array.<number>} ends Ends.\n * @param {Array.<string>} textArray Text array.\n * @return {number} The new offset.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.encodeRings_ = function(flatCoordinates, stride, offset, ends, textArray) {\n  const linearRingCount = ends.length;\n  for (let i = 0; i < linearRingCount; ++i) {\n    // skip the \"closing\" point\n    const end = ends[i] - stride;\n    const text = this.encodeCoordinates_(flatCoordinates, stride, offset, end);\n    if (i !== 0) {\n      textArray.push('\\'');\n    }\n    textArray.push(text);\n    offset = ends[i];\n  }\n  return offset;\n};\n\n\n/**\n * Encode an {@link ol.geom.Polygon} geometry into a logical sequence\n * of characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writePolygonGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomPolygon);\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  const ends = geometry.getEnds();\n  const offset = 0;\n  const textArray = ['a('];\n  exports.encodeRings_.call(this,\n    flatCoordinates, stride, offset, ends, textArray);\n  textArray.push(')');\n  return textArray.join('');\n};\n\n\n/**\n * Encode an {@link ol.geom.MultiPoligon} geometry into a logical sequence of\n * characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @return {string} Encoded geometry.\n * @this {ngeo.format.FeatureHash}\n * @private\n */\nexports.writeMultiPolygonGeometry_ = function(geometry) {\n  googAsserts.assertInstanceof(geometry, olGeomMultiPolygon);\n  const flatCoordinates = geometry.getFlatCoordinates();\n  const stride = geometry.getStride();\n  const endss = geometry.getEndss();\n  const polygonCount = endss.length;\n  let offset = 0;\n  const textArray = ['A'];\n  for (let i = 0; i < polygonCount; ++i) {\n    const ends = endss[i];\n    textArray.push('(');\n    offset = exports.encodeRings_.call(this,\n      flatCoordinates, stride, offset, ends, textArray);\n    textArray.push(')');\n  }\n  return textArray.join('');\n};\n\n\n/**\n * @const\n * @private\n * @type {Object.<string, function(string):ol.geom.Geometry>}\n */\nexports.GEOMETRY_READERS_ = {\n  'P': exports.readMultiPointGeometry_,\n  'L': exports.readMultiLineStringGeometry_,\n  'A': exports.readMultiPolygonGeometry_,\n  'l': exports.readLineStringGeometry_,\n  'p': exports.readPointGeometry_,\n  'a': exports.readPolygonGeometry_\n};\n\n\n/**\n * @const\n * @private\n * @type {Object.<string, function(ol.geom.Geometry):string>}\n */\nexports.GEOMETRY_WRITERS_ = {\n  'MultiLineString': exports.writeMultiLineStringGeometry_,\n  'MultiPoint': exports.writeMultiPointGeometry_,\n  'MultiPolygon': exports.writeMultiPolygonGeometry_,\n  'LineString': exports.writeLineStringGeometry_,\n  'Point': exports.writePointGeometry_,\n  'Polygon': exports.writePolygonGeometry_\n};\n\n\n/**\n * Read a logical sequence of characters and return (or complete then return)\n * an array of numbers. The coordinates are assumed to be in\n * two dimensions and in latitude, longitude order.\n * corresponding to a geometry's coordinates.\n * @param {string} text Text.\n * @param {Array.<number>=} opt_flatCoordinates Flat coordinates array.\n * @return {Array.<number>} Flat coordinates.\n * @private\n */\nexports.prototype.decodeCoordinates_ = function(text, opt_flatCoordinates) {\n  const len = text.length;\n  let index = 0;\n  const flatCoordinates = opt_flatCoordinates !== undefined ?\n    opt_flatCoordinates : [];\n  let i = flatCoordinates.length;\n  while (index < len) {\n    let b;\n    let shift = 0;\n    let result = 0;\n    do {\n      b = exports.CHAR64_.indexOf(text.charAt(index++));\n      result |= (b & 0x1f) << shift;\n      shift += 5;\n    } while (b >= 32);\n    const dx = ((result & 1) ? ~(result >> 1) : (result >> 1));\n    this.prevX_ += dx;\n    shift = 0;\n    result = 0;\n    do {\n      b = exports.CHAR64_.indexOf(text.charAt(index++));\n      result |= (b & 0x1f) << shift;\n      shift += 5;\n    } while (b >= 32);\n    const dy = ((result & 1) ? ~(result >> 1) : (result >> 1));\n    this.prevY_ += dy;\n    flatCoordinates[i++] = this.prevX_ * this.accuracy_;\n    flatCoordinates[i++] = this.prevY_ * this.accuracy_;\n  }\n  return flatCoordinates;\n};\n\n\n/**\n * Encode an array of number (corresponding to some coordinates) into a\n * logical sequence of characters. The coordinates are assumed to be in\n * two dimensions and in latitude, longitude order.\n * @param {Array.<number>} flatCoordinates Flat coordinates.\n * @param {number} stride Stride.\n * @param {number} offset Offset.\n * @param {number} end End.\n * @return {string} String.\n * @private\n */\nexports.prototype.encodeCoordinates_ = function(flatCoordinates, stride, offset, end) {\n  let encodedCoordinates = '';\n  for (let i = offset; i < end; i += stride) {\n    let x = flatCoordinates[i];\n    let y = flatCoordinates[i + 1];\n    x = Math.floor(x / this.accuracy_);\n    y = Math.floor(y / this.accuracy_);\n    const dx = x - this.prevX_;\n    const dy = y - this.prevY_;\n    this.prevX_ = x;\n    this.prevY_ = y;\n    encodedCoordinates += exports.encodeSignedNumber_(dx) +\n        exports.encodeSignedNumber_(dy);\n  }\n  return encodedCoordinates;\n};\n\n\n/**\n * Read a feature from a logical sequence of characters.\n * @param {string} text Text.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {ol.Feature} Feature.\n * @protected\n * @override\n */\nexports.prototype.readFeatureFromText = function(text, opt_options) {\n  googAsserts.assert(text.length > 2);\n  googAsserts.assert(text[1] === '(');\n  googAsserts.assert(text[text.length - 1] === ')');\n  let splitIndex = text.indexOf('~');\n  const geometryText = splitIndex >= 0 ?\n    `${text.substring(0, splitIndex)})` : text;\n  const geometry = this.readGeometryFromText(geometryText, opt_options);\n  const feature = new olFeature(geometry);\n  if (splitIndex >= 0) {\n    const attributesAndStylesText = text.substring(\n      splitIndex + 1, text.length - 1);\n    splitIndex = attributesAndStylesText.indexOf('~');\n    const attributesText = splitIndex >= 0 ?\n      attributesAndStylesText.substring(0, splitIndex) :\n      attributesAndStylesText;\n    if (attributesText != '') {\n      const parts = attributesText.split('\\'');\n      for (let i = 0; i < parts.length; ++i) {\n        const part = decodeURIComponent(parts[i]);\n        const keyVal = part.split('*');\n        googAsserts.assert(keyVal.length === 2);\n        let key = keyVal[0];\n        const value = keyVal[1];\n        if (!this.setStyle_ && exports.LegacyProperties_[key]) {\n          key = exports.LegacyProperties_[key];\n        }\n        feature.set(key, exports.castValue_(key, value));\n      }\n    }\n    if (splitIndex >= 0) {\n      const stylesText = attributesAndStylesText.substring(splitIndex + 1);\n      if (this.setStyle_) {\n        exports.setStyleInFeature_(stylesText, feature);\n      } else {\n        exports.setStyleProperties_(stylesText, feature);\n      }\n    }\n  }\n  return feature;\n};\n\n\n/**\n * Read multiple features from a logical sequence of characters.\n * @param {string} text Text.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {Array.<ol.Feature>} Features.\n * @protected\n * @override\n */\nexports.prototype.readFeaturesFromText = function(text, opt_options) {\n  googAsserts.assert(text[0] === 'F');\n  this.prevX_ = 0;\n  this.prevY_ = 0;\n  /** @type {Array.<ol.Feature>} */\n  const features = [];\n  text = text.substring(1);\n  while (text.length > 0) {\n    const index = text.indexOf(')');\n    googAsserts.assert(index >= 0);\n    const feature = this.readFeatureFromText(\n      text.substring(0, index + 1), opt_options);\n    features.push(feature);\n    text = text.substring(index + 1);\n  }\n\n  // set default values\n  features.forEach((feature) => {\n    for (const key in this.defaultValues_) {\n      const property = exports.LegacyProperties_[key];\n      if (feature.get(property) === undefined) {\n        feature.set(property, this.defaultValues_[key].call(null, feature));\n      }\n    }\n  });\n  return features;\n};\n\n\n/**\n * Read a geometry from a logical sequence of characters.\n * @param {string} text Text.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {ol.geom.Geometry} Geometry.\n * @protected\n * @override\n */\nexports.prototype.readGeometryFromText = function(text, opt_options) {\n  const geometryReader = exports.GEOMETRY_READERS_[text[0]];\n  googAsserts.assert(geometryReader !== undefined);\n  return geometryReader.call(this, text);\n};\n\n\n/**\n * Encode a feature into a logical sequence of characters.\n * @param {ol.Feature} feature Feature.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {string} Encoded feature.\n * @protected\n * @override\n */\nexports.prototype.writeFeatureText = function(feature, opt_options) {\n  const /** @type {Array.<string>} */ encodedParts = [];\n\n  // encode geometry\n\n  let encodedGeometry = '';\n  const geometry = feature.getGeometry();\n  if (geometry) {\n    encodedGeometry = this.writeGeometryText(geometry, opt_options);\n  }\n\n  if (encodedGeometry.length > 0) {\n    // remove the final bracket\n    googAsserts.assert(encodedGeometry[encodedGeometry.length - 1] === ')');\n    encodedGeometry = encodedGeometry.substring(0, encodedGeometry.length - 1);\n    encodedParts.push(encodedGeometry);\n  }\n\n  // encode properties\n\n  const /** @type {Array.<string>} */ encodedProperties = [];\n  const propFunction = this.propertiesFunction_(feature);\n  for (const key in propFunction) {\n    const value = propFunction[key];\n    if (value !== undefined && value !== null && key !== feature.getGeometryName()) {\n      if (encodedProperties.length !== 0) {\n        encodedProperties.push('\\'');\n      }\n      const encoded = encodeURIComponent(\n        `${key.replace(/[()'*]/g, '_')}*${\n          value.toString().replace(/[()'*]/g, '_')}`);\n      encodedProperties.push(encoded);\n    }\n  }\n\n  if (encodedProperties.length > 0) {\n    encodedParts.push('~');\n    Array.prototype.push.apply(encodedParts, encodedProperties);\n  }\n\n  // encode styles\n\n  if (this.encodeStyles_) {\n    const styleFunction = feature.getStyleFunction();\n    if (styleFunction !== undefined) {\n      let styles = styleFunction.call(feature, 0);\n      if (styles !== null) {\n        const encodedStyles = [];\n        styles = Array.isArray(styles) ? styles : [styles];\n        exports.encodeStyles_(\n          styles, geometry.getType(), encodedStyles);\n        if (encodedStyles.length > 0) {\n          encodedParts.push('~');\n          Array.prototype.push.apply(encodedParts, encodedStyles);\n        }\n      }\n    }\n  }\n\n  // append the closing bracket and return the encoded feature\n\n  encodedParts.push(')');\n  return encodedParts.join('');\n};\n\n\n/**\n * Encode an array of features into a logical sequence of characters.\n * @param {Array.<ol.Feature>} features Feature.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {string} Encoded features.\n * @protected\n * @override\n */\nexports.prototype.writeFeaturesText = function(features, opt_options) {\n  this.prevX_ = 0;\n  this.prevY_ = 0;\n  const textArray = [];\n  if (features.length > 0) {\n    textArray.push('F');\n    for (let i = 0, ii = features.length; i < ii; ++i) {\n      textArray.push(this.writeFeatureText(features[i], opt_options));\n    }\n  }\n  return textArray.join('');\n};\n\n\n/**\n * Encode a geometry into a logical sequence of characters.\n * @param {ol.geom.Geometry} geometry Geometry.\n * @param {olx.format.ReadOptions=} opt_options Read options.\n * @return {string} Encoded geometry.\n * @protected\n * @override\n */\nexports.prototype.writeGeometryText = function(geometry, opt_options) {\n  const geometryWriter = exports.GEOMETRY_WRITERS_[\n    geometry.getType()];\n  googAsserts.assert(geometryWriter !== undefined);\n  const transformedGeometry = /** @type {ol.geom.Geometry} */\n      (olFormatFeature.transformWithOptions(geometry, true, opt_options));\n  return geometryWriter.call(this, transformedGeometry);\n};\n\n\nexport default exports;\n","/**\n * @module gmf.editing.editFeatureSelectorComponent\n */\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport gmfEditingEditFeatureComponent from 'gmf/editing/editFeatureComponent.js';\n\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('GmfEditingFeatureSelectorComponent', [\n  gmfEditingEditFeatureComponent.name,\n  gmfLayertreeTreeManager.module.name,\n  gmfThemeThemes.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/editing/editFeatureSelectorComponent', require('./editFeatureSelectorComponent.html'));\n});\n\n\n/**\n * Directive that uses the GMF Theme service to collect the editable layers\n * and create a drop-down list out of them. When the user selects one of the\n * layer from the list, a `gmf-editfeature` directive is created and shown,\n * which allows the user to edit that layer.\n *\n * Example:\n *\n *     <gmf-editfeatureselector\n *         gmf-editfeatureselector-active=\"ctrl.editFeatureSelectorActive\"\n *         gmf-editfeatureselector-map=\"::ctrl.map\"\n *         gmf-editfeatureselector-tolerance=\"::ctrl.tolerance\"\n *         gmf-editfeatureselector-vector=\"::ctrl.vectorLayer\"\n *         gmf-editfeatureselector-tree=\"ctrl.selectedEditableTreeCtrl\"\n *         gmf-editfeatureselector-closeaftersave=\"::true\">\n *     </gmf-editfeatureselector>\n *\n * @htmlAttribute {boolean} gmf-editfeatureselector-active Whether the\n *     directive is active or not.\n * @htmlAttribute {ol.Map} gmf-editfeatureselector-map The map.\n * @htmlAttribute {number|undefined} gmf-editfeatureselector-tolerance The\n *     buffer in pixels to use when making queries to get the features.\n * @htmlAttribute {ol.layer.Vector} gmf-editfeatureselector-vector The vector\n *     layer where the selected or created features are drawn.\n * @htmlAttribute {ngeo.layertree.Controller} gmf-editfeatureselector-tree The\n *     layertree controller handling the selectable editable layers list.\n * @htmlAttribute {boolean} gmf-editfeatureselector-closeaftersave If true,\n *     immediately return to the main edit panel after save. Default is false.\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname gmfEditfeatureselector\n */\nexports.component_ = function() {\n  return {\n    controller: 'GmfEditfeatureselectorController as efsCtrl',\n    scope: {\n      'active': '=gmfEditfeatureselectorActive',\n      'map': '<gmfEditfeatureselectorMap',\n      'tolerance': '<?gmfEditfeatureselectorTolerance',\n      'vectorLayer': '<gmfEditfeatureselectorVector',\n      'selectedEditableTreeCtrl': '=?gmfEditfeatureselectorTree',\n      'closeAfterSave': '=?gmfEditfeatureselectorCloseaftersave'\n    },\n    bindToController: true,\n    templateUrl: 'gmf/editing/editFeatureSelectorComponent'\n  };\n};\n\n\nexports.directive('gmfEditfeatureselector', exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @param {gmf.theme.Themes} gmfThemes The gmf Themes service.\n * @param {gmf.layertree.TreeManager} gmfTreeManager The gmf TreeManager service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfEditfeatureselectorController\n */\nexports.Controller_ = function($scope, $timeout, gmfThemes, gmfTreeManager) {\n\n  // === Directive options ===\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active = this.active === true;\n\n  $scope.$watch(\n    () => this.active,\n    this.handleActiveChange_.bind(this)\n  );\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.tolerance;\n\n  /**\n   * @type {ol.layer.Vector}\n   * @export\n   */\n  this.vectorLayer;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.closeAfterSave;\n\n  // === Injected services ===\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {angular.$timeout}\n   * @private\n   */\n  this.$timeout_ = $timeout;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = gmfTreeManager;\n\n  /**\n   * @param {Array.<ngeo.layertree.Controller>} value First level controllers.\n   */\n  const updateEditableTreeCtrls = function(value) {\n    // Timeout required, because the collection event is fired before the\n    // leaf nodes are created and they are the ones we're looking for here.\n    this.$timeout_(() => {\n      if (value) {\n        const editables = this.editableTreeCtrls;\n\n        editables.length = 0;\n        this.gmfTreeManager_.rootCtrl.traverseDepthFirst((treeCtrl) => {\n          if (treeCtrl.node.editable) {\n            googAsserts.assert(treeCtrl.children.length === 0);\n            editables.push(treeCtrl);\n          }\n        });\n      }\n    }, 0);\n  };\n\n  /**\n   * @type {function()}\n   * @private\n   */\n  this.treeCtrlsWatcherUnregister_ = $scope.$watchCollection(() => {\n    if (gmfTreeManager.rootCtrl) {\n      return gmfTreeManager.rootCtrl.children;\n    }\n  }, updateEditableTreeCtrls.bind(this));\n\n\n  // === Other inner properties ===\n\n  /**\n   * Flag shared with the `gmf-editfeature` directive used to determine if it\n   * has unsaved changes or not.\n   * @type {boolean}\n   * @export\n   */\n  this.dirty = false;\n\n  /**\n   * List of editable Layertree controllers.\n   * @type {Array.<ngeo.layertree.Controller>}\n   * @export\n   */\n  this.editableTreeCtrls = [];\n\n  /**\n   * The currently selected Layertree controller.\n   * @type {?ngeo.layertree.Controller}\n   * @export\n   */\n  this.selectedEditableTreeCtrl = null;\n\n  $scope.$watch(\n    () => this.selectedEditableTreeCtrl,\n    (newValue, oldValue) => {\n      this.dirty = false;\n      this.state = gmfEditingEditFeatureComponent.State.IDLE;\n    }\n  );\n\n  /**\n   * The state of this directive shared with the `gmf-editfeature` directive.\n   * This property allows the proper management of the \"stop editing\" button.\n   * When clicked, the according state is set and the `gmf-editfeature`\n   * directive checks if it has unsaved changes and allow this directive to\n   * continue the action that was made or not.\n   * @type {string}\n   * @export\n   */\n  this.state = gmfEditingEditFeatureComponent.State.IDLE;\n\n  $scope.$watch(\n    () => this.state,\n    (newValue, oldValue) => {\n      if (newValue === gmfEditingEditFeatureComponent.State.STOP_EDITING_EXECUTE ||\n          newValue === gmfEditingEditFeatureComponent.State.DEACTIVATE_EXECUTE) {\n        this.selectedEditableTreeCtrl = null;\n      }\n      if (newValue === gmfEditingEditFeatureComponent.State.DEACTIVATE_EXECUTE) {\n        this.active = false;\n      }\n    }\n  );\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n\n};\n\n\n/**\n * Called when the 'stop editing' button is clicked. Set the 'state'\n * variable to 'pending' allow the editfeature directive to check if it can\n * stop or if it requires confirmation due to unsaved modifications.\n * @export\n */\nexports.Controller_.prototype.stopEditing = function() {\n  this.state = gmfEditingEditFeatureComponent.State.STOP_EDITING_PENDING;\n};\n\n\n/**\n * Called when the active property of the this directive changes. Manage\n * the activation/deactivation accordingly.\n * @param {boolean} active Whether the directive is active or not.\n * @private\n */\nexports.Controller_.prototype.handleActiveChange_ = function(active) {\n  if (!active) {\n    if (!this.dirty) {\n      this.stopEditing();\n    } else {\n      // There are unsaved modifications. Prevent the deactivation and\n      // set the state accordingly for the `gmf-editfeature` directive\n      // to manage the unsaved modifications.\n      // The changes are made inside a $timeout to be taken into account\n      // in the next digest cycle.\n      this.$timeout_(() => {\n        this.active = true;\n        this.stopEditing();\n      });\n    }\n  }\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  this.treeCtrlsWatcherUnregister_();\n};\n\n\nexports.controller('GmfEditfeatureselectorController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.editing.module\n */\nimport gmfEditingEditFeature from 'gmf/editing/EditFeature.js';\nimport gmfEditingEditFeatureComponent from 'gmf/editing/editFeatureComponent.js';\nimport gmfEditingEditFeatureSelectorComponent from 'gmf/editing/editFeatureSelectorComponent.js';\nimport gmfEditingEnumerateAttribute from 'gmf/editing/EnumerateAttribute.js';\nimport gmfEditingSnapping from 'gmf/editing/Snapping.js';\nimport gmfEditingXSDAttributes from 'gmf/editing/XSDAttributes.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfEditingModule', [\n  gmfEditingEditFeature.module.name,\n  gmfEditingEditFeatureComponent.name,\n  gmfEditingEditFeatureSelectorComponent.name,\n  gmfEditingEnumerateAttribute.module.name,\n  gmfEditingSnapping.module.name,\n  gmfEditingXSDAttributes.module.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.print.VectorEncoder\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoUtils from 'ngeo/utils.js';\nimport * as olBase from 'ol/index.js';\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olStyleRegularShape from 'ol/style/RegularShape.js';\nimport * as olMath from 'ol/math.js';\nimport olStyleIcon from 'ol/style/Icon.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport * as olColor from 'ol/color.js';\n\n/**\n * @constructor\n */\nconst exports = function() {\n  /**\n   * @type {ol.format.GeoJSON}\n   */\n  this.geojsonFormat = new olFormatGeoJSON();\n};\n\n\n/**\n * @enum {string}\n */\nexports.PrintStyleType = {\n  LINE_STRING: 'LineString',\n  POINT: 'Point',\n  POLYGON: 'Polygon'\n};\n\n\n/**\n * @type {Object.<ol.geom.GeometryType, ngeo.print.VectorEncoder.PrintStyleType>}\n * @private\n */\nexports.PrintStyleTypes_ = {\n  'LineString': exports.PrintStyleType.LINE_STRING,\n  'Point': exports.PrintStyleType.POINT,\n  'Polygon': exports.PrintStyleType.POLYGON,\n  'MultiLineString': exports.PrintStyleType.LINE_STRING,\n  'MultiPoint': exports.PrintStyleType.POINT,\n  'MultiPolygon': exports.PrintStyleType.POLYGON\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Vector} layer Layer.\n * @param {number} resolution Resolution.\n */\nexports.prototype.encodeVectorLayer = function(arr, layer, resolution) {\n  const source = layer.getSource();\n  googAsserts.assertInstanceof(source, olSourceVector);\n\n  const features = source.getFeatures();\n\n  const /** @type {Array.<GeoJSONFeature>} */ geojsonFeatures = [];\n  const mapfishStyleObject = /** @type {MapFishPrintVectorStyle} */ ({\n    version: 2\n  });\n\n  for (let i = 0, ii = features.length; i < ii; ++i) {\n    const originalFeature = features[i];\n\n    let styleData = null;\n    const styleFunction = originalFeature.getStyleFunction() || layer.getStyleFunction();\n    if (styleFunction !== undefined) {\n      styleData = styleFunction.call(layer, originalFeature, resolution);\n    }\n    const origGeojsonFeature = this.geojsonFormat.writeFeatureObject(originalFeature);\n    /**\n     * @type {Array<ol.style.Style>}\n     */\n    const styles = (styleData !== null && !Array.isArray(styleData)) ? [styleData] : styleData;\n    googAsserts.assert(Array.isArray(styles));\n\n    if (styles !== null && styles.length > 0) {\n      let isOriginalFeatureAdded = false;\n      for (let j = 0, jj = styles.length; j < jj; ++j) {\n        const style = styles[j];\n        let geometry = style.getGeometry();\n        let geojsonFeature;\n        if (!geometry) {\n          geojsonFeature = origGeojsonFeature;\n          geometry = originalFeature.getGeometry();\n          // no need to encode features with no geometry\n          if (!geometry) {\n            continue;\n          }\n          if (!isOriginalFeatureAdded) {\n            geojsonFeatures.push(geojsonFeature);\n            isOriginalFeatureAdded = true;\n          }\n        } else {\n          let styledFeature = originalFeature.clone();\n          styledFeature.setGeometry(geometry);\n          geojsonFeature = this.geojsonFormat.writeFeatureObject(styledFeature);\n          geometry = styledFeature.getGeometry();\n          styledFeature = null;\n          geojsonFeatures.push(geojsonFeature);\n        }\n\n        const geometryType = geometry.getType();\n        if (geojsonFeature.properties === null) {\n          geojsonFeature.properties = {};\n        }\n\n        const featureStyleProp = `_ngeo_style_${j}`;\n        const styleId = `${olBase.getUid(style).toString()}-${geometryType}`;\n        this.encodeVectorStyle(mapfishStyleObject, geometryType, style, styleId, featureStyleProp);\n        geojsonFeature.properties[featureStyleProp] = styleId;\n      }\n    }\n  }\n\n  // MapFish Print fails if there are no style rules, even if there are no\n  // features either. To work around this we just ignore the layer if the\n  // array of GeoJSON features is empty.\n  // See https://github.com/mapfish/mapfish-print/issues/279\n\n  if (geojsonFeatures.length > 0) {\n    const geojsonFeatureCollection = /** @type {GeoJSONFeatureCollection} */ ({\n      type: 'FeatureCollection',\n      features: geojsonFeatures\n    });\n    const object = /** @type {MapFishPrintVectorLayer} */ ({\n      geoJson: geojsonFeatureCollection,\n      opacity: layer.getOpacity(),\n      style: mapfishStyleObject,\n      type: 'geojson'\n    });\n    arr.push(object);\n  }\n};\n\n\n/**\n * @param {MapFishPrintVectorStyle} object MapFish style object.\n * @param {ol.geom.GeometryType} geometryType Type of the GeoJSON geometry\n * @param {ol.style.Style} style Style.\n * @param {string} styleId Style id.\n * @param {string} featureStyleProp Feature style property name.\n */\nexports.prototype.encodeVectorStyle = function(object, geometryType, style, styleId, featureStyleProp) {\n  if (!(geometryType in exports.PrintStyleTypes_)) {\n    // unsupported geometry type\n    return;\n  }\n  const styleType = exports.PrintStyleTypes_[geometryType];\n  const key = `[${featureStyleProp} = '${styleId}']`;\n  if (key in object) {\n    // do nothing if we already have a style object for this CQL rule\n    return;\n  }\n  const styleObject = /** @type {MapFishPrintSymbolizers} */ ({\n    symbolizers: []\n  });\n  object[key] = styleObject;\n  const fillStyle = style.getFill();\n  const imageStyle = style.getImage();\n  const strokeStyle = style.getStroke();\n  const textStyle = style.getText();\n  if (styleType === exports.PrintStyleType.POLYGON) {\n    if (fillStyle !== null) {\n      this.encodeVectorStylePolygon(\n        styleObject.symbolizers, fillStyle, strokeStyle);\n    }\n  } else if (styleType === exports.PrintStyleType.LINE_STRING) {\n    if (strokeStyle !== null) {\n      this.encodeVectorStyleLine(styleObject.symbolizers, strokeStyle);\n    }\n  } else if (styleType === exports.PrintStyleType.POINT) {\n    if (imageStyle !== null) {\n      this.encodeVectorStylePoint(styleObject.symbolizers, imageStyle);\n    }\n  }\n  if (textStyle !== null) {\n    this.encodeTextStyle(styleObject.symbolizers, textStyle);\n  }\n};\n\n\n/**\n * @param {MapFishPrintSymbolizerPoint|MapFishPrintSymbolizerPolygon} symbolizer MapFish Print symbolizer.\n * @param {!ol.style.Fill} fillStyle Fill style.\n * @protected\n */\nexports.prototype.encodeVectorStyleFill = function(symbolizer, fillStyle) {\n  let fillColor = fillStyle.getColor();\n  if (fillColor !== null) {\n    googAsserts.assert(typeof fillColor === 'string' || Array.isArray(fillColor));\n    fillColor = olColor.asArray(fillColor);\n    googAsserts.assert(Array.isArray(fillColor), 'only supporting fill colors');\n    symbolizer.fillColor = ngeoUtils.rgbArrayToHex(fillColor);\n    symbolizer.fillOpacity = fillColor[3];\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintSymbolizer>} symbolizers Array of MapFish Print\n *     symbolizers.\n * @param {!ol.style.Stroke} strokeStyle Stroke style.\n * @protected\n */\nexports.prototype.encodeVectorStyleLine = function(symbolizers, strokeStyle) {\n  const symbolizer = /** @type {MapFishPrintSymbolizerLine} */ ({\n    type: 'line'\n  });\n  this.encodeVectorStyleStroke(symbolizer, strokeStyle);\n  symbolizers.push(symbolizer);\n};\n\n\n/**\n * @param {Array.<MapFishPrintSymbolizer>} symbolizers Array of MapFish Print\n *     symbolizers.\n * @param {!ol.style.Image} imageStyle Image style.\n * @protected\n */\nexports.prototype.encodeVectorStylePoint = function(symbolizers, imageStyle) {\n  let symbolizer;\n  if (imageStyle instanceof olStyleCircle) {\n    symbolizer = /** @type {MapFishPrintSymbolizerPoint} */ ({\n      type: 'point'\n    });\n    symbolizer.pointRadius = imageStyle.getRadius();\n    const fillStyle = imageStyle.getFill();\n    if (fillStyle !== null) {\n      this.encodeVectorStyleFill(symbolizer, fillStyle);\n    }\n    const strokeStyle = imageStyle.getStroke();\n    if (strokeStyle !== null) {\n      this.encodeVectorStyleStroke(symbolizer, strokeStyle);\n    }\n  } else if (imageStyle instanceof olStyleIcon) {\n    const src = new URL(imageStyle.getSrc(), window.location.href).href;\n    if (src !== undefined) {\n      symbolizer = /** @type {MapFishPrintSymbolizerPoint} */ ({\n        type: 'point',\n        externalGraphic: src\n      });\n      const opacity = imageStyle.getOpacity();\n      if (opacity !== null) {\n        symbolizer.graphicOpacity = opacity;\n      }\n      const size = imageStyle.getSize();\n      if (size !== null) {\n        let scale = imageStyle.getScale();\n        if (isNaN(scale)) {\n          scale = 1;\n        }\n        symbolizer.graphicWidth = size[0] * scale;\n        symbolizer.graphicHeight = size[1] * scale;\n      }\n      let rotation = imageStyle.getRotation();\n      if (isNaN(rotation)) {\n        rotation = 0;\n      }\n      symbolizer.rotation = olMath.toDegrees(rotation);\n    }\n  } else if (imageStyle instanceof olStyleRegularShape) {\n    /**\n     * Mapfish Print does not support image defined with ol.style.RegularShape.\n     * As a workaround, I try to map the image on a well-known image name.\n     */\n    const points = /** @type {ol.style.RegularShape} */ (imageStyle).getPoints();\n    if (points !== null) {\n      symbolizer = /** @type {MapFishPrintSymbolizerPoint} */ ({\n        type: 'point'\n      });\n      if (points === 4) {\n        symbolizer.graphicName = 'square';\n      } else if (points === 3) {\n        symbolizer.graphicName = 'triangle';\n      } else if (points === 5) {\n        symbolizer.graphicName = 'star';\n      } else if (points === 8) {\n        symbolizer.graphicName = 'cross';\n      }\n      const sizeShape = imageStyle.getSize();\n      if (sizeShape !== null) {\n        symbolizer.graphicWidth = sizeShape[0];\n        symbolizer.graphicHeight = sizeShape[1];\n      }\n      const rotationShape = imageStyle.getRotation();\n      if (!isNaN(rotationShape) && rotationShape !== 0) {\n        symbolizer.rotation = olMath.toDegrees(rotationShape);\n      }\n      const opacityShape = imageStyle.getOpacity();\n      if (opacityShape !== null) {\n        symbolizer.graphicOpacity = opacityShape;\n      }\n      const strokeShape = imageStyle.getStroke();\n      if (strokeShape !== null) {\n        this.encodeVectorStyleStroke(symbolizer, strokeShape);\n      }\n      const fillShape = imageStyle.getFill();\n      if (fillShape !== null) {\n        this.encodeVectorStyleFill(symbolizer, fillShape);\n      }\n    }\n  }\n  if (symbolizer !== undefined) {\n    symbolizers.push(symbolizer);\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintSymbolizer>} symbolizers Array of MapFish Print\n *     symbolizers.\n * @param {!ol.style.Fill} fillStyle Fill style.\n * @param {ol.style.Stroke} strokeStyle Stroke style.\n * @protected\n */\nexports.prototype.encodeVectorStylePolygon = function(symbolizers, fillStyle, strokeStyle) {\n  const symbolizer = /** @type {MapFishPrintSymbolizerPolygon} */ ({\n    type: 'polygon'\n  });\n  this.encodeVectorStyleFill(symbolizer, fillStyle);\n  if (strokeStyle !== null) {\n    this.encodeVectorStyleStroke(symbolizer, strokeStyle);\n  }\n  symbolizers.push(symbolizer);\n};\n\n\n/**\n * @param {MapFishPrintSymbolizerPoint|MapFishPrintSymbolizerLine|MapFishPrintSymbolizerPolygon}\n *      symbolizer MapFish Print symbolizer.\n * @param {!ol.style.Stroke} strokeStyle Stroke style.\n * @protected\n */\nexports.prototype.encodeVectorStyleStroke = function(symbolizer, strokeStyle) {\n  const strokeColor = strokeStyle.getColor();\n  if (strokeColor !== null) {\n    googAsserts.assert(typeof strokeColor === 'string' || Array.isArray(strokeColor));\n    const strokeColorRgba = olColor.asArray(strokeColor);\n    googAsserts.assert(Array.isArray(strokeColorRgba), 'only supporting stroke colors');\n    symbolizer.strokeColor = ngeoUtils.rgbArrayToHex(strokeColorRgba);\n    symbolizer.strokeOpacity = strokeColorRgba[3];\n  }\n  const strokeDashstyle = strokeStyle.getLineDash();\n  if (strokeDashstyle !== null) {\n    symbolizer.strokeDashstyle = strokeDashstyle.join(' ');\n  }\n  const strokeWidth = strokeStyle.getWidth();\n  if (strokeWidth !== undefined) {\n    symbolizer.strokeWidth = strokeWidth;\n  }\n  const strokeLineCap = strokeStyle.getLineCap();\n  if (strokeLineCap) {\n    symbolizer.strokeLinecap = strokeStyle.getLineCap();\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintSymbolizerText>} symbolizers Array of MapFish Print\n *     symbolizers.\n * @param {!ol.style.Text} textStyle Text style.\n * @protected\n */\nexports.prototype.encodeTextStyle = function(symbolizers, textStyle) {\n  const symbolizer = /** @type {MapFishPrintSymbolizerText} */ ({\n    type: 'Text'\n  });\n  const label = textStyle.getText();\n  if (label !== undefined) {\n    symbolizer.label = label;\n    let xAlign = 'c';\n    let yAlign = 'm';\n\n    const olTextAlign = textStyle.getTextAlign();\n    // 'left', 'right', 'center', 'end' or 'start'.\n    if (olTextAlign === 'left' || olTextAlign === 'start') {\n      xAlign = 'l';\n    } else if (olTextAlign === 'right' || olTextAlign === 'end') {\n      xAlign = 'r';\n    }\n\n    const olTextBaseline = textStyle.getTextBaseline();\n    // 'bottom', 'top', 'middle', 'alphabetic', 'hanging' or 'ideographic'\n    if (olTextBaseline === 'bottom') {\n      yAlign = 'l';\n    } else if (olTextBaseline === 'top') {\n      yAlign = 't';\n    }\n    symbolizer.labelAlign = `${xAlign}${yAlign}`;\n\n    const labelRotation = textStyle.getRotation();\n    if (labelRotation !== undefined) {\n      // Mapfish Print expects a string, not a number to rotate text\n      symbolizer.labelRotation = (labelRotation * 180 / Math.PI).toString();\n      // rotate around the vertical/horizontal center\n      symbolizer.labelAlign = 'cm';\n    }\n\n    const fontStyle = textStyle.getFont();\n    if (fontStyle !== undefined) {\n      const font = fontStyle.split(' ');\n      if (font.length >= 3) {\n        symbolizer.fontWeight = font[0];\n        symbolizer.fontSize = font[1];\n        symbolizer.fontFamily = font.splice(2).join(' ');\n      }\n    }\n\n    const strokeStyle = textStyle.getStroke();\n    if (strokeStyle !== null) {\n      const strokeColor = strokeStyle.getColor();\n      googAsserts.assert(typeof strokeColor === 'string' || Array.isArray(strokeColor));\n      const strokeColorRgba = olColor.asArray(strokeColor);\n      googAsserts.assert(Array.isArray(strokeColorRgba), 'only supporting stroke colors');\n      symbolizer.haloColor = ngeoUtils.rgbArrayToHex(strokeColorRgba);\n      symbolizer.haloOpacity = strokeColorRgba[3];\n      const width = strokeStyle.getWidth();\n      if (width !== undefined) {\n        // Width is a stroke, radius a radius, so divide by 2\n        symbolizer.haloRadius = width / 2;\n      }\n    }\n\n    const fillStyle = textStyle.getFill();\n    if (fillStyle !== null) {\n      const fillColor = fillStyle.getColor();\n      googAsserts.assert(typeof fillColor === 'string' || Array.isArray(fillColor));\n      const fillColorRgba = olColor.asArray(fillColor);\n      googAsserts.assert(Array.isArray(fillColorRgba), 'only supporting fill colors');\n      symbolizer.fontColor = ngeoUtils.rgbArrayToHex(fillColorRgba);\n    }\n\n    // Mapfish Print allows offset only if labelAlign is defined.\n    if (symbolizer.labelAlign !== undefined) {\n      symbolizer.labelXOffset = textStyle.getOffsetX();\n      // Mapfish uses the opposite direction of OpenLayers for y axis, so the\n      // minus sign is required for the y offset to be identical.\n      symbolizer.labelYOffset = -textStyle.getOffsetY();\n    }\n\n    symbolizers.push(symbolizer);\n  }\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.print.Service\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoPrintVectorEncoder from 'ngeo/print/VectorEncoder.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport * as olArray from 'ol/array.js';\nimport * as olObj from 'ol/obj.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport * as olMath from 'ol/math.js';\nimport * as olSize from 'ol/size.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport olSourceWMTS from 'ol/source/WMTS.js';\nimport olTilegridWMTS from 'ol/tilegrid/WMTS.js';\n\n/**\n * Provides a function to create ngeo.print.Service objects used to\n * interact with MapFish Print v3 services.\n *\n * ngeo.print.Service objects expose the following methods:\n *\n * - createSpec: create a report specification object\n * - createReport: send a create report request\n * - getStatus: get the status of a report\n * - getReportUrl: get the URL of a report\n * - getCapabilities: get the capabilities of the server\n *\n *\n *     let printBaseUrl = 'http://example.com/print';\n *     let print = new ngeo.print.Service(printBaseUrl);\n *\n *     let scale = 5000;\n *     let dpi = 72;\n *     let layout = 'A4 portrait';\n *     let format = 'pdf';\n *     let reportSpec = print.createSpec(map, scale, dpi, layout, format, {\n *       'title': 'A title for my report',\n *       'rotation': 45 // degree\n *     });\n *\n * See our live example: [../examples/mapfishprint.html](../examples/mapfishprint.html)\n *\n * TODO and limitations:\n *\n * - createSpec should also accept a bbox instead of a center and a scale.\n * - Add support for ol.style.RegularShape. MapFish Print supports symbols\n *   like crosses, stars and squares, so printing regular shapes should be\n *   possible.\n * - ol.style.Icon may use a sprite image, and offsets to define to rectangle\n *   to use within the sprite. This type of icons won't be printed correctly\n *   as MapFish Print does not support sprite icons.\n *\n * @constructor\n * @struct\n * @param {string} url URL to MapFish print web service.\n * @param {angular.$http} $http Angular $http service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper service.\n */\nconst exports = function(url, $http, gettextCatalog, ngeoLayerHelper) {\n  /**\n   * @type {string}\n   * @private\n   */\n  this.url_ = url;\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {ngeo.map.LayerHelper}\n   * @private\n   */\n  this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {ngeo.print.VectorEncoder}\n   * @protected\n   */\n  this.vectorEncoder = new ngeoPrintVectorEncoder();\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.printNativeAngle_ = true;\n};\n\n\n/**\n * Cancel a report.\n * @param {string} ref Print report reference.\n * @param {angular.$http.Config=} opt_httpConfig $http config object.\n * @return {angular.$http.HttpPromise} HTTP promise.\n * @export\n */\nexports.prototype.cancel = function(ref, opt_httpConfig) {\n  const httpConfig = opt_httpConfig !== undefined ? opt_httpConfig :\n    /** @type {angular.$http.Config} */ ({});\n  const url = `${this.url_}/cancel/${ref}`;\n  // \"delete\" is a reserved word, so use ['delete']\n  return this.$http_['delete'](url, httpConfig);\n};\n\n\n/**\n * Create a report specification.\n * @param {ol.Map} map Map.\n * @param {number} scale Scale.\n * @param {number} dpi DPI.\n * @param {string} layout Layout.\n * @param {string} format Formats.\n * @param {Object.<string, *>} customAttributes Custom attributes.\n * @return {MapFishPrintSpec} The print spec.\n * @export\n */\nexports.prototype.createSpec = function(\n  map, scale, dpi, layout, format, customAttributes) {\n\n  const specMap = /** @type {MapFishPrintMap} */ ({\n    dpi: dpi,\n    rotation: /** number */ (customAttributes['rotation'])\n  });\n\n  this.encodeMap_(map, scale, specMap);\n\n  const attributes = /** @type {!MapFishPrintAttributes} */ ({\n    map: specMap\n  });\n  olObj.assign(attributes, customAttributes);\n\n  const lang = this.gettextCatalog_.currentLanguage;\n\n  const spec = /** @type {MapFishPrintSpec} */ ({\n    attributes,\n    format,\n    lang,\n    layout\n  });\n\n  return spec;\n};\n\n\n/**\n * @param {ol.Map} map Map.\n * @param {number} scale Scale.\n * @param {MapFishPrintMap} object Object.\n * @private\n */\nexports.prototype.encodeMap_ = function(map, scale, object) {\n  const view = map.getView();\n  const viewCenter = view.getCenter();\n  const viewProjection = view.getProjection();\n  const viewResolution = view.getResolution();\n  const viewRotation = object.rotation || olMath.toDegrees(view.getRotation());\n\n  googAsserts.assert(viewCenter !== undefined);\n  googAsserts.assert(viewProjection !== undefined);\n\n  object.center = viewCenter;\n  object.projection = viewProjection.getCode();\n  object.rotation = viewRotation;\n  object.scale = scale;\n  object.layers = [];\n\n  const mapLayerGroup = map.getLayerGroup();\n  googAsserts.assert(mapLayerGroup);\n  this.printNativeAngle_ = !(mapLayerGroup.get('printNativeAngle') === false);\n  let layers = this.ngeoLayerHelper_.getFlatLayers(mapLayerGroup);\n\n  // Sort the layer by ZIndex\n  olArray.stableSort(layers, (layer_a, layer_b) => layer_a.getZIndex() - layer_b.getZIndex());\n  layers = layers.slice().reverse();\n\n  layers.forEach((layer) => {\n    if (layer.getVisible()) {\n      googAsserts.assert(viewResolution !== undefined);\n      this.encodeLayer(object.layers, layer, viewResolution);\n    }\n  });\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Base} layer Layer.\n * @param {number} resolution Resolution.\n */\nexports.prototype.encodeLayer = function(arr, layer, resolution) {\n  if (layer instanceof olLayerImage) {\n    this.encodeImageLayer_(arr, layer);\n  } else if (layer instanceof olLayerTile) {\n    this.encodeTileLayer_(arr, layer);\n  } else if (layer instanceof olLayerVector) {\n    this.encodeVectorLayer(arr, layer, resolution);\n  }\n};\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Vector} layer Layer.\n * @param {number} resolution Resolution.\n */\nexports.prototype.encodeVectorLayer = function(arr, layer, resolution) {\n  this.vectorEncoder.encodeVectorLayer(arr, layer, resolution);\n};\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Image} layer Layer.\n * @private\n */\nexports.prototype.encodeImageLayer_ = function(arr, layer) {\n  googAsserts.assertInstanceof(layer, olLayerImage);\n  const source = layer.getSource();\n  if (source instanceof olSourceImageWMS) {\n    this.encodeImageWmsLayer_(arr, layer);\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Image} layer Layer.\n * @private\n */\nexports.prototype.encodeImageWmsLayer_ = function(arr, layer) {\n  const source = layer.getSource();\n\n  googAsserts.assertInstanceof(layer, olLayerImage);\n  googAsserts.assertInstanceof(source, olSourceImageWMS);\n\n  const url = source.getUrl();\n  if (url !== undefined) {\n    this.encodeWmsLayer_(\n      arr, layer, url, source.getParams());\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Image} layer The layer.\n * @param {string} url Url of the WMS server.\n * @param {Object} params Url parameters\n * @private\n */\nexports.prototype.encodeWmsLayer_ = function(arr, layer, url, params) {\n  if (url.startsWith('//')) {\n    url = window.location.protocol  + url;\n  }\n  const url_url = new URL(url);\n  const customParams = {'TRANSPARENT': true};\n  if (url_url.searchParams) {\n    /** @type {Object} */ (url_url.searchParams).forEach((value, key) => {\n      customParams[key] = value;\n    });\n  }\n  for (const key in params) {\n    const value = params[key];\n    // remove empty params\n    if (value !== null && value !== undefined) {\n      customParams[key] = value;\n    }\n  }\n  delete customParams['LAYERS'];\n  delete customParams['FORMAT'];\n  delete customParams['SERVERTYPE'];\n  delete customParams['VERSION'];\n\n  const object = /** @type {MapFishPrintWmsLayer} */ ({\n    baseURL: exports.getAbsoluteUrl_(url_url.origin + url_url.pathname),\n    imageFormat: 'FORMAT' in params ? params['FORMAT'] : 'image/png',\n    layers: params['LAYERS'].split(','),\n    customParams: customParams,\n    serverType: params['SERVERTYPE'],\n    type: 'wms',\n    opacity: this.getOpacityOrInherited_(layer),\n    version: params['VERSION'],\n    useNativeAngle: this.printNativeAngle_,\n  });\n  arr.push(object);\n};\n\n\n/**\n * @param {string} url URL.\n * @return {string} Absolute URL.\n * @private\n */\nexports.getAbsoluteUrl_ = function(url) {\n  const a = document.createElement('a');\n  a.href = encodeURI(url);\n  return decodeURI(a.href);\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Tile} layer Layer.\n * @private\n */\nexports.prototype.encodeTileLayer_ = function(arr, layer) {\n  googAsserts.assertInstanceof(layer, olLayerTile);\n  const source = layer.getSource();\n  if (source instanceof olSourceWMTS) {\n    this.encodeTileWmtsLayer_(arr, layer);\n  } else if (source instanceof olSourceTileWMS) {\n    this.encodeTileWmsLayer_(arr, layer);\n  }\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Tile} layer Layer.\n * @private\n */\nexports.prototype.encodeTileWmtsLayer_ = function(arr, layer) {\n  googAsserts.assertInstanceof(layer, olLayerTile);\n  const source = layer.getSource();\n  googAsserts.assertInstanceof(source, olSourceWMTS);\n\n  const projection = source.getProjection();\n  const tileGrid = source.getTileGrid();\n  googAsserts.assertInstanceof(tileGrid, olTilegridWMTS);\n  const matrixIds = tileGrid.getMatrixIds();\n\n  /** @type {Array.<MapFishPrintWmtsMatrix>} */\n  const matrices = [];\n\n  for (let i = 0, ii = matrixIds.length; i < ii; ++i) {\n    const tileRange = tileGrid.getFullTileRange(i);\n    matrices.push(/** @type {MapFishPrintWmtsMatrix} */ ({\n      identifier: matrixIds[i],\n      scaleDenominator: tileGrid.getResolution(i) *\n          projection.getMetersPerUnit() / 0.28E-3,\n      tileSize: olSize.toSize(tileGrid.getTileSize(i)),\n      topLeftCorner: tileGrid.getOrigin(i),\n      matrixSize: [\n        tileRange.maxX - tileRange.minX,\n        tileRange.maxY - tileRange.minY\n      ]\n    }));\n  }\n\n  const dimensions = source.getDimensions();\n  const dimensionKeys = Object.keys(dimensions);\n\n  const object = /** @type {MapFishPrintWmtsLayer} */ ({\n    baseURL: this.getWmtsUrl_(source),\n    dimensions: dimensionKeys,\n    dimensionParams: dimensions,\n    imageFormat: source.getFormat(),\n    layer: source.getLayer(),\n    matrices: matrices,\n    matrixSet: source.getMatrixSet(),\n    opacity: this.getOpacityOrInherited_(layer),\n    requestEncoding: source.getRequestEncoding(),\n    style: source.getStyle(),\n    type: 'WMTS',\n    version: source.getVersion()\n  });\n\n  arr.push(object);\n};\n\n\n/**\n * @param {Array.<MapFishPrintLayer>} arr Array.\n * @param {ol.layer.Tile} layer Layer.\n * @private\n */\nexports.prototype.encodeTileWmsLayer_ = function(arr, layer) {\n  const source = layer.getSource();\n\n  googAsserts.assertInstanceof(layer, olLayerTile);\n  googAsserts.assertInstanceof(source, olSourceTileWMS);\n\n  this.encodeWmsLayer_(\n    arr, layer, source.getUrls()[0], source.getParams());\n};\n\n\n/**\n * Return the WMTS URL to use in the print spec.\n * @param {ol.source.WMTS} source The WMTS source.\n * @return {string} URL.\n * @private\n */\nexports.prototype.getWmtsUrl_ = function(source) {\n  const urls = source.getUrls();\n  googAsserts.assert(urls.length > 0);\n  return exports.getAbsoluteUrl_(urls[0]);\n};\n\n/**\n * Return an opacity value for the specified layer.\n * @param {ol.layer.Base} layer Layer.\n * @returns {number} opacity Opacity value.\n * @private\n */\nexports.prototype.getOpacityOrInherited_ = function(layer) {\n  if (layer.get('inheritedOpacity') !== undefined) {\n    return layer.get('inheritedOpacity');\n  }\n  return layer.getOpacity();\n};\n\n/**\n * Send a create report request to the MapFish Print service.\n * @param {MapFishPrintSpec} printSpec Print specification.\n * @param {angular.$http.Config=} opt_httpConfig $http config object.\n * @return {angular.$http.HttpPromise} HTTP promise.\n * @export\n */\nexports.prototype.createReport = function(printSpec, opt_httpConfig) {\n  const format = printSpec.format || 'pdf';\n  const url = `${this.url_}/report.${format}`;\n  const httpConfig = /** @type {!angular.$http.Config} */ ({\n    headers: {\n      'Content-Type': 'application/json; charset=UTF-8'\n    }\n  });\n  olObj.assign(httpConfig,\n    opt_httpConfig !== undefined ? opt_httpConfig : {});\n  return this.$http_.post(url, printSpec, httpConfig);\n};\n\n\n/**\n * Get the status of a report.\n * @param {string} ref Print report reference.\n * @param {angular.$http.Config=} opt_httpConfig $http config object.\n * @return {angular.$http.HttpPromise} HTTP promise.\n * @export\n */\nexports.prototype.getStatus = function(ref, opt_httpConfig) {\n  const httpConfig = opt_httpConfig !== undefined ? opt_httpConfig :\n    /** @type {angular.$http.Config} */ ({});\n  const url = `${this.url_}/status/${ref}.json`;\n  return this.$http_.get(url, httpConfig);\n};\n\n\n/**\n * Get the URL of a report.\n * @param {string} ref Print report reference.\n * @return {string} The report URL for this ref.\n * @export\n */\nexports.prototype.getReportUrl = function(ref) {\n  return `${this.url_}/report/${ref}`;\n};\n\n\n/**\n * Get the print capabilities from MapFish Print.\n * @param {angular.$http.Config=} opt_httpConfig $http config object.\n * @return {angular.$http.HttpPromise} HTTP promise.\n */\nexports.prototype.getCapabilities = function(opt_httpConfig) {\n  const httpConfig =\n    opt_httpConfig !== undefined ? opt_httpConfig : /** @type {angular.$http.Config} */ ({\n      withCredentials: true\n    });\n  const url = `${this.url_}/capabilities.json`;\n  return this.$http_.get(url, httpConfig);\n};\n\n\n/**\n * @param {angular.$http} $http Angular $http service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext service.\n * @param {ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @return {ngeox.CreatePrint} The function to create a print service.\n * @ngInject\n * @ngdoc service\n * @ngname ngeoCreatePrint\n */\nexports.createPrintServiceFactory = function($http, gettextCatalog, ngeoLayerHelper) {\n  return (\n    /**\n     * @param {string} url URL to MapFish print service.\n     */\n    function(url) {\n      return new exports(url, $http, gettextCatalog, ngeoLayerHelper);\n    }\n  );\n};\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoPrint', [\n  ngeoMapLayerHelper.module.name\n]);\nexports.module.service('ngeoPrintService', exports);\nexports.module.factory('ngeoCreatePrint', exports.createPrintServiceFactory);\n\n\nexport default exports;\n","/**\n * @module gmf.drawing.featureStyleComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olEvents from 'ol/events.js';\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscColorpickerComponent from 'ngeo/misc/colorpickerComponent.js';\n\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfDrawingFeatureStyle', [\n  ngeoMiscColorpickerComponent.name,\n  ngeoMiscFeatureHelper.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/drawing/featureStyleComponent', require('./featureStyleComponent.html'));\n});\n\n\n/**\n * Directive used to set the style of a vector feature. The options depend\n * on the type of geometry.\n * Example:\n *\n *     <gmf-featurestyle\n *         gmf-featurestyle-feature=\"ctrl.selectedFeature\">\n *     </gmf-featurestyle>\n *\n * @htmlAttribute {ol.Feature} gmf-featurestyle-feature The feature.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfFeaturestyle\n */\nexports.directive_ = function() {\n  return {\n    controller: 'GmfFeaturestyleController as fsCtrl',\n    scope: {\n      'feature': '=gmfFeaturestyleFeature'\n    },\n    bindToController: true,\n    templateUrl: 'gmf/drawing/featureStyleComponent'\n  };\n};\n\n\nexports.directive('gmfFeaturestyle',\n  exports.directive_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {ngeo.misc.FeatureHelper} ngeoFeatureHelper Gmf feature helper service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfFeaturestyleController\n */\nexports.Controller_ = function($scope, ngeoFeatureHelper) {\n\n  /**\n   * @type {?ol.Feature}\n   * @export\n   */\n  this.feature;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.featureHelper_ = ngeoFeatureHelper;\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.color = undefined;\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.label = undefined;\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.measure = undefined;\n\n  $scope.$watch(\n    () => this.color,\n    this.handleColorSet_.bind(this)\n  );\n\n  /**\n   * @type {Array.<ol.EventsKey>}\n   * @private\n   */\n  this.featureListenerKeys_ = [];\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.type;\n\n  $scope.$watch(\n    () => this.feature,\n    this.handleFeatureSet_.bind(this)\n  );\n\n};\n\n\n/**\n * Called when a new feature is set, which can also be null.\n * @param {?ol.Feature} newFeature New feature or null value.\n * @param {?ol.Feature} previousFeature Previous feature or null value.\n * @private\n */\nexports.Controller_.prototype.handleFeatureSet_ = function(\n  newFeature, previousFeature) {\n\n  const keys = this.featureListenerKeys_;\n\n  if (previousFeature) {\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n    this.type = undefined;\n    this.color = undefined;\n    this.measure = undefined;\n    this.label = undefined;\n  }\n\n  if (newFeature) {\n    [\n      ngeoFormatFeatureProperties.ANGLE,\n      ngeoFormatFeatureProperties.COLOR,\n      ngeoFormatFeatureProperties.NAME,\n      ngeoFormatFeatureProperties.SHOW_LABEL,\n      ngeoFormatFeatureProperties.OPACITY,\n      ngeoFormatFeatureProperties.SHOW_MEASURE,\n      ngeoFormatFeatureProperties.SIZE,\n      ngeoFormatFeatureProperties.STROKE\n    ].forEach(function(propName) {\n      keys.push(\n        olEvents.listen(\n          newFeature,\n          `change:${propName}`,\n          this.handleFeatureChange_,\n          this\n        )\n      );\n    }, this);\n\n    const geometry = newFeature.getGeometry();\n    googAsserts.assert(geometry, 'Geometry should be thruthy');\n\n    keys.push(\n      olEvents.listen(\n        geometry,\n        'change',\n        this.handleGeometryChange_,\n        this\n      )\n    );\n\n    this.type = this.featureHelper_.getType(newFeature);\n    this.color = this.featureHelper_.getColorProperty(newFeature);\n    this.measure = this.featureHelper_.getMeasure(newFeature);\n  }\n};\n\n\n/**\n * @param {string|undefined} newColor Color.\n * @private\n */\nexports.Controller_.prototype.handleColorSet_ = function(\n  newColor) {\n  if (this.feature && newColor) {\n    const currentColor = this.feature.get(ngeoFormatFeatureProperties.COLOR);\n    if (currentColor !== newColor) {\n      this.feature.set(ngeoFormatFeatureProperties.COLOR, newColor);\n    }\n  }\n};\n\n\n/**\n * @param {number|undefined} value A name value to set or undefined to get.\n * @return {number} The angle of the feature.\n * @export\n */\nexports.Controller_.prototype.getSetAngle = function(value) {\n  return googAsserts.assertNumber(this.getSetProperty_(ngeoFormatFeatureProperties.ANGLE, value));\n};\n\n\n/**\n * @param {string|undefined} value A name value to set or undefined to get.\n * @return {string} The name of the feature.\n * @export\n */\nexports.Controller_.prototype.getSetName = function(value) {\n  return googAsserts.assertString(this.getSetProperty_(ngeoFormatFeatureProperties.NAME, value));\n};\n\n/**\n * @param {boolean|undefined} value A value to set or undefined for the\n *     purpose of showing the attribute labels or not.\n * @return {boolean} Whether to show the labels or not.\n * @export\n */\nexports.Controller_.prototype.getSetShowLabel = function(value) {\n  return googAsserts.assertBoolean(this.getSetProperty_(ngeoFormatFeatureProperties.SHOW_LABEL, value));\n};\n\n/**\n * @param {number|undefined} value A stroke value to set or undefined to get.\n * @return {number} The stroke of the feature.\n * @export\n */\nexports.Controller_.prototype.getSetOpacity = function(value) {\n  return googAsserts.assertNumber(this.getSetProperty_(ngeoFormatFeatureProperties.OPACITY, value));\n};\n\n\n/**\n * @param {boolean|undefined} value A value to set or undefined to get for the\n *     purpose of showing the geometry measurements or not.\n * @return {boolean} Whether to show the measurements or not.\n * @export\n */\nexports.Controller_.prototype.getSetShowMeasure = function(value) {\n  return googAsserts.assertBoolean(this.getSetProperty_(ngeoFormatFeatureProperties.SHOW_MEASURE, value));\n};\n\n\n/**\n * @param {number|undefined} value A size value to set or undefined to get.\n * @return {number} The size of the feature.\n * @export\n */\nexports.Controller_.prototype.getSetSize = function(value) {\n  return googAsserts.assertNumber(this.getSetProperty_(ngeoFormatFeatureProperties.SIZE, value));\n};\n\n\n/**\n * @param {number|undefined} value A stroke value to set or undefined to get.\n * @return {number} The stroke of the feature.\n * @export\n */\nexports.Controller_.prototype.getSetStroke = function(value) {\n  return googAsserts.assertNumber(this.getSetProperty_(ngeoFormatFeatureProperties.STROKE, value));\n};\n\n\n/**\n * @param {string} key The property name.\n * @param {boolean|number|string|undefined} value A value to set or undefined\n *     to get.\n * @return {boolean|number|string} The property value of the feature.\n * @private\n */\nexports.Controller_.prototype.getSetProperty_ = function(key, value) {\n  if (value !== undefined) {\n    this.feature.set(key, value);\n  }\n  return /** @type {boolean|number|string} */ (this.feature.get(key));\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleFeatureChange_ = function() {\n  const feature = this.feature;\n\n  if (!feature) {\n    return;\n  }\n\n  this.featureHelper_.setStyle(feature, true);\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleGeometryChange_ = function() {\n  googAsserts.assert(this.feature);\n  this.measure = this.featureHelper_.getMeasure(this.feature);\n\n  const showMeasure = this.featureHelper_.getShowMeasureProperty(this.feature);\n  if (showMeasure) {\n    this.handleFeatureChange_();\n  }\n\n  this.scope_.$apply();\n};\n\n\nexports.controller('GmfFeaturestyleController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.drawing.drawFeatureComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfDrawingFeatureStyleComponent from 'gmf/drawing/featureStyleComponent.js';\n\nimport googAsserts from 'goog/asserts.js';\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\nimport ngeoMenu from 'ngeo/Menu.js';\n\n/** @suppress {extraRequire} */\nimport ngeoEditingExportfeaturesComponent from 'ngeo/editing/exportfeaturesComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscBtnComponent from 'ngeo/misc/btnComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDrawComponent from 'ngeo/draw/component.js';\n\nimport ngeoFormatFeatureProperties from 'ngeo/format/FeatureProperties.js';\nimport ngeoInteractionModify from 'ngeo/interaction/Modify.js';\nimport ngeoInteractionRotate from 'ngeo/interaction/Rotate.js';\nimport ngeoInteractionTranslate from 'ngeo/interaction/Translate.js';\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\nimport * as olBase from 'ol/index.js';\nimport * as olArray from 'ol/array.js';\nimport * as olEvents from 'ol/events.js';\nimport olCollection from 'ol/Collection.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleText from 'ol/style/Text.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('GmfDrawFeatureComponent', [\n  gmfDrawingFeatureStyleComponent.name,\n  ngeoEditingExportfeaturesComponent.name,\n  ngeoMiscBtnComponent.name,\n  ngeoDrawComponent.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscToolActivateMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/drawing/drawFeatureComponent', require('./drawFeatureComponent.html'));\n});\n\n\n/**\n * Directive used to create, modify and delete vector features on a map with\n * the addition of changing their style.\n * Example:\n *\n *     <gmf-drawfeature\n *         gmf-drawfeature-active=\"ctrl.drawFeatureActive\"\n *         gmf-drawfeature-map=\"::ctrl.map\">\n *     </gmf-drawfeature>\n *\n * @htmlAttribute {boolean} gmf-drawfeature-active Whether the directive is\n *     active or not.\n * @htmlAttribute {ol.Map} gmf-drawfeature-map The map.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfDrawfeature\n */\nexports.component_ = function() {\n  return {\n    controller: 'GmfDrawfeatureController as efCtrl',\n    scope: {\n      'active': '=gmfDrawfeatureActive',\n      'map': '<gmfDrawfeatureMap',\n      'showMeasure': '=?gmfDrawfeatureShowmeasure'\n    },\n    bindToController: true,\n    templateUrl: 'gmf/drawing/drawFeatureComponent'\n  };\n};\n\n\nexports.directive('gmfDrawfeature',\n  exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n * @param {!ol.Collection.<!ol.Feature>} ngeoFeatures Collection of features.\n * @param {!ngeo.misc.ToolActivateMgr} ngeoToolActivateMgr Ngeo ToolActivate manager\n *     service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfDrawfeatureController\n */\nexports.Controller_ = function($scope, $timeout, gettextCatalog,\n  ngeoFeatureHelper, ngeoFeatures, ngeoToolActivateMgr) {\n\n  /**\n   * @type {!ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  if (this.active === undefined) {\n    this.active = false;\n  }\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.drawActive = false;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.drawToolActivate = new ngeoMiscToolActivate(this, 'drawActive');\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.mapSelectActive = true;\n\n  /**\n   * @type {number?}\n   * @private\n   */\n  this.longPressTimeout_ = null;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.mapSelectToolActivate = new ngeoMiscToolActivate(this, 'mapSelectActive');\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {!angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {!ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.featureHelper_ = ngeoFeatureHelper;\n\n  /**\n   * @type {!ol.Collection.<!ol.Feature>}\n   * @export\n   */\n  this.features = ngeoFeatures;\n\n  /**\n   * @type {!ngeo.misc.ToolActivateMgr}\n   * @private\n   */\n  this.ngeoToolActivateMgr_ = ngeoToolActivateMgr;\n\n  /**\n   * @type {?ol.Feature}\n   * @export\n   */\n  this.selectedFeature = null;\n\n  /**\n   * @type {!ol.Collection.<!ol.Feature>}\n   * @export\n   */\n  this.selectedFeatures = new olCollection();\n\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.interactions_ = new olCollection();\n\n  /**\n   * @type {!ngeo.interaction.Modify}\n   * @private\n   */\n  this.modify_ = new ngeoInteractionModify({\n    features: this.selectedFeatures,\n    style: ngeoFeatureHelper.getVertexStyle(false)\n  });\n  this.interactions_.push(this.modify_);\n\n  /**\n   * @type {?ngeo.Menu}\n   * @private\n   */\n  this.menu_ = null;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.modifyToolActivate = new ngeoMiscToolActivate(this.modify_, 'active');\n\n  /**\n   * @type {!ngeo.interaction.Translate}\n   * @private\n   */\n  this.translate_ = new ngeoInteractionTranslate({\n    features: this.selectedFeatures,\n    style: new olStyleStyle({\n      text: new olStyleText({\n        text: '\\uf047',\n        font: 'normal 18px FontAwesome',\n        fill: new olStyleFill({\n          color: '#7a7a7a'\n        })\n      })\n    })\n  });\n  this.interactions_.push(this.translate_);\n\n  /**\n   * @type {!ngeo.interaction.Rotate}\n   * @private\n   */\n  this.rotate_ = new ngeoInteractionRotate({\n    features: this.selectedFeatures,\n    style: new olStyleStyle({\n      text: new olStyleText({\n        text: '\\uf01e',\n        font: 'normal 18px FontAwesome',\n        fill: new olStyleFill({\n          color: '#7a7a7a'\n        })\n      })\n    })\n  });\n  this.interactions_.push(this.rotate_);\n\n  this.initializeInteractions_();\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.rotateToolActivate = new ngeoMiscToolActivate(this.rotate_, 'active');\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @export\n   */\n  this.translateToolActivate = new ngeoMiscToolActivate(this.translate_, 'active');\n\n  /**\n   * @type {!Array.<!ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * Flag used to determine whether the selection of a feature was made\n   * from the selection of an item from the list or not (the map, contextual\n   * menu, etc.)\n   * @type {boolean}\n   * @private\n   */\n  this.listSelectionInProgress_ = false;\n\n  $scope.$watch(\n    () => this.active,\n    this.handleActiveChange_.bind(this)\n  );\n\n  $scope.$watch(\n    () => this.drawActive,\n    (active) => {\n      if (active) {\n        this.selectedFeature = null;\n      }\n    }\n  );\n\n  $scope.$watch(\n    () => this.selectedFeature,\n    (newFeature, previousFeature) => {\n      this.selectedFeatures.clear();\n      if (previousFeature) {\n        this.featureHelper_.setStyle(previousFeature);\n        this.unregisterInteractions_();\n      }\n      if (newFeature) {\n        this.featureHelper_.setStyle(newFeature, true);\n        this.selectedFeatures.push(newFeature);\n        this.registerInteractions_();\n        if (this.listSelectionInProgress_) {\n          this.featureHelper_.panMapToFeature(newFeature, this.map);\n          this.listSelectionInProgress_ = false;\n        }\n      } else if (this.menu_) {\n        this.map.removeOverlay(this.menu_);\n        this.menu_ = null;\n      }\n    }\n  );\n\n  $scope.$watch(\n    () => this.mapSelectActive,\n    this.handleMapSelectActiveChange_.bind(this)\n  );\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.nameProperty = ngeoFormatFeatureProperties.NAME;\n\n  /**\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n};\n\n\n/**\n * Initialize interactions by setting them inactive and decorating them\n * @private\n */\nexports.Controller_.prototype.initializeInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    interaction.setActive(false);\n    ngeoMiscDecorate.interaction(interaction);\n  });\n};\n\n\n/**\n * Register interactions by adding them to the map\n * @private\n */\nexports.Controller_.prototype.registerInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.addInteraction(interaction);\n  });\n};\n\n\n/**\n * Register interactions by removing them to the map\n * @private\n */\nexports.Controller_.prototype.unregisterInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.removeInteraction(interaction);\n  });\n};\n\n\n/**\n * Called when the active property of the this directive changes. Manage\n * the activation/deactivation accordingly (event management, etc.)\n * @param {boolean} active Whether the directive is active or not.\n * @private\n */\nexports.Controller_.prototype.handleActiveChange_ = function(active) {\n\n  const keys = this.listenerKeys_;\n  const drawUid = ['draw-', olBase.getUid(this)].join('-');\n  const otherUid = ['other-', olBase.getUid(this)].join('-');\n  const toolMgr = this.ngeoToolActivateMgr_;\n\n  if (active) {\n    // when activated\n\n    keys.push(\n      olEvents.listen(this.features, 'add', this.handleFeaturesAdd_, this),\n      olEvents.listen(this.features, 'remove', this.handleFeaturesRemove_, this)\n    );\n\n    keys.push(olEvents.listen(this.translate_,\n      'translateend',\n      this.handleTranslateEnd_, this));\n\n    keys.push(olEvents.listen(this.rotate_, 'rotateend', this.handleRotateEnd_, this));\n\n    toolMgr.registerTool(drawUid, this.drawToolActivate, false);\n    toolMgr.registerTool(drawUid, this.mapSelectToolActivate, true);\n\n    toolMgr.registerTool(otherUid, this.drawToolActivate, false);\n    toolMgr.registerTool(otherUid, this.modifyToolActivate, true);\n    toolMgr.registerTool(otherUid, this.translateToolActivate, false);\n    toolMgr.registerTool(otherUid, this.rotateToolActivate, false);\n\n    this.mapSelectActive = true;\n    this.modify_.setActive(true);\n  } else {\n    // when deactivated\n\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n\n    toolMgr.unregisterTool(drawUid, this.drawToolActivate);\n    toolMgr.unregisterTool(drawUid, this.mapSelectToolActivate);\n\n    toolMgr.unregisterTool(otherUid, this.drawToolActivate);\n    toolMgr.unregisterTool(otherUid, this.modifyToolActivate);\n    toolMgr.unregisterTool(otherUid, this.translateToolActivate);\n    toolMgr.unregisterTool(otherUid, this.rotateToolActivate);\n\n    this.drawActive = false;\n    this.modify_.setActive(false);\n    this.mapSelectActive = false;\n    this.selectedFeature = null;\n\n    if (this.menu_) {\n      this.map.removeOverlay(this.menu_);\n      this.menu_ = null;\n    }\n  }\n};\n\n\n/**\n * Method called when a selection occurs from the list, i.e. when an item in\n * the list of features is clicked. Called from the template, so no need to\n * update Angular's scope.\n * @param {!ol.Feature} feature Feature to select.\n * @export\n */\nexports.Controller_.prototype.selectFeatureFromList = function(feature) {\n  this.listSelectionInProgress_ = true;\n  this.selectedFeature = feature;\n  this.drawActive = false;\n};\n\n\n/**\n * @return {!Array.<!ol.Feature>} Array.\n * @export\n */\nexports.Controller_.prototype.getFeaturesArray = function() {\n  return this.features.getArray();\n};\n\n\n/**\n * @export\n */\nexports.Controller_.prototype.clearFeatures = function() {\n  const gettextCatalog = this.gettextCatalog_;\n  const msg = gettextCatalog.getString(\n    'Do you really want to delete all the features?');\n  if (confirm(msg)) {\n    this.features.clear();\n  }\n};\n\n\n/**\n * @param {!ol.Feature} feature The feature to remove from the selection.\n * @export\n */\nexports.Controller_.prototype.removeFeature = function(feature) {\n  const gettextCatalog = this.gettextCatalog_;\n  const msg = gettextCatalog.getString(\n    'Do you really want to delete the selected feature?');\n  if (confirm(msg)) {\n    this.features.remove(feature);\n  }\n};\n\n\n/**\n * @param {!ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleFeaturesAdd_ = function(evt) {\n  // timeout to prevent double-click to zoom the map\n  this.timeout_(() => {\n    this.selectedFeature = /** @type {ol.Feature} */ (evt.element);\n    this.drawActive = false;\n    this.scope_.$apply();\n  });\n};\n\n\n/**\n * @param {!ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleFeaturesRemove_ = function(evt) {\n  this.selectedFeature = null;\n};\n\n\n/**\n * Called when the mapSelectActive property changes.\n * @param {boolean} active Whether the map select is active or not.\n * @private\n */\nexports.Controller_.prototype.handleMapSelectActiveChange_ = function(\n  active) {\n\n  const mapDiv = this.map.getViewport();\n  googAsserts.assertElement(mapDiv);\n\n  if (active) {\n    olEvents.listen(this.map, 'click',\n      this.handleMapClick_, this);\n\n    olEvents.listen(mapDiv, 'contextmenu',\n      this.handleMapContextMenu_, this);\n\n    olEvents.listen(mapDiv, 'touchstart',\n      this.handleMapTouchStart_, this);\n\n    olEvents.listen(mapDiv, 'touchmove',\n      this.handleMapTouchEnd_, this);\n\n    olEvents.listen(mapDiv, 'touchend',\n      this.handleMapTouchEnd_, this);\n\n    olEvents.listen(document.body, 'keydown',\n      this.handleCancelKeyEvent_, this);\n\n  } else {\n    olEvents.unlisten(this.map, 'click',\n      this.handleMapClick_, this);\n\n    olEvents.unlisten(mapDiv, 'contextmenu',\n      this.handleMapContextMenu_, this);\n\n    olEvents.unlisten(mapDiv, 'touchstart',\n      this.handleMapTouchStart_, this);\n\n    olEvents.unlisten(mapDiv, 'touchmove',\n      this.handleMapTouchEnd_, this);\n\n    olEvents.unlisten(mapDiv, 'touchend',\n      this.handleMapTouchEnd_, this);\n\n    olEvents.unlisten(document.body, 'keydown',\n      this.handleCancelKeyEvent_, this);\n  }\n};\n\n\n/**\n * @param {!ol.MapBrowserEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapClick_ = function(evt) {\n\n  const pixel = evt.pixel;\n\n  let feature = this.map.forEachFeatureAtPixel(\n    pixel,\n    (feature) => {\n      let ret = false;\n      if (olArray.includes(this.features.getArray(), feature)) {\n        ret = feature;\n      }\n      return ret;\n    },\n    {\n      hitTolerance: 5\n    }\n  );\n\n  feature = feature ? feature : null;\n\n  // do not do any further action if feature is null or already selected\n  if (feature === this.selectedFeature) {\n    return;\n  }\n\n  this.selectedFeature = feature;\n\n  this.scope_.$apply();\n};\n\n\nexports.Controller_.prototype.handleCancelKeyEvent_ = function() {\n  olEvents.listen(document.body, 'keydown', (event) => {\n    const escPressed = event.keyCode === 27; // Escape key\n    if (escPressed && this.selectedFeature) {\n      this.selectedFeature = null;\n      this.scope_.$apply();\n    }\n  });\n};\n\n/**\n * @param {!Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapTouchStart_ = function(evt) {\n  this.longPressTimeout_ = setTimeout(() => {\n    this.handleMapContextMenu_(evt);\n  }, 500);\n};\n\n\n/**\n * @param {!Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapTouchEnd_ = function(evt) {\n  clearTimeout(this.longPressTimeout_);\n};\n\n\n/**\n * @param {!Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapContextMenu_ = function(evt) {\n  const gettextCatalog = this.gettextCatalog_;\n  const pixel = this.map.getEventPixel(evt);\n  const coordinate = this.map.getCoordinateFromPixel(pixel);\n\n  let feature = this.map.forEachFeatureAtPixel(\n    pixel,\n    (feature) => {\n      let ret = false;\n      if (olArray.includes(this.features.getArray(), feature)) {\n        ret = feature;\n      }\n      return ret;\n    },\n    {\n      hitTolerance: 7\n    }\n  );\n\n  feature = feature ? feature : null;\n\n  // show contextual menu when clicking on certain types of features\n  if (feature) {\n    let actions = [];\n\n    const type = this.featureHelper_.getType(feature);\n    if (type == ngeoGeometryType.CIRCLE ||\n        type == ngeoGeometryType.LINE_STRING ||\n        type == ngeoGeometryType.POLYGON ||\n        type == ngeoGeometryType.RECTANGLE) {\n      actions = actions.concat([{\n        cls: 'fa fa-arrows',\n        label: gettextCatalog.getString('Move'),\n        name: 'move'\n      }, {\n        cls: 'fa fa-rotate-right',\n        label: gettextCatalog.getString('Rotate'),\n        name: 'rotate'\n      }]);\n    }\n\n    actions = actions.concat([{\n      cls: 'fa fa-trash-o',\n      label: gettextCatalog.getString('Delete'),\n      name: 'delete'\n    }]);\n\n    this.menu_ = new ngeoMenu({\n      actions\n    });\n\n    olEvents.listen(this.menu_, 'actionclick',\n      this.handleMenuActionClick_, this);\n    this.map.addOverlay(this.menu_);\n\n    this.menu_.open(coordinate);\n\n    evt.preventDefault();\n    evt.stopPropagation();\n  }\n\n  // do not do any further action if feature is null or already selected\n  if (feature === this.selectedFeature) {\n    return;\n  }\n\n  this.modify_.setActive(true);\n\n  this.selectedFeature = feature;\n\n  this.scope_.$apply();\n};\n\n\n/**\n * @param {!ngeox.MenuEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMenuActionClick_ = function(evt) {\n  const action = evt.detail.action;\n\n  switch (action) {\n    case 'delete':\n      googAsserts.assert(\n        this.selectedFeature, 'Selected feature should be truthy');\n      this.removeFeature(this.selectedFeature);\n      this.scope_.$apply();\n      break;\n    case 'move':\n      this.translate_.setActive(true);\n      this.scope_.$apply();\n      break;\n    case 'rotate':\n      this.rotate_.setActive(true);\n      this.scope_.$apply();\n      break;\n    default:\n      // FIXME\n      console.log(`FIXME - support: ${action}`);\n      break;\n  }\n};\n\n\n/**\n * @param {!ol.interaction.Translate.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleTranslateEnd_ = function(evt) {\n  this.translate_.setActive(false);\n  this.scope_.$apply();\n};\n\n\n/**\n * @param {!ngeox.RotateEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleRotateEnd_ = function(evt) {\n  this.rotate_.setActive(false);\n  this.scope_.$apply();\n};\n\n\nexports.controller('GmfDrawfeatureController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.drawing.module\n */\nimport gmfDrawingDrawFeatureComponent from 'gmf/drawing/drawFeatureComponent.js';\nimport gmfDrawingFeatureStyleComponent from 'gmf/drawing/featureStyleComponent.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfDrawingModule', [\n  gmfDrawingDrawFeatureComponent.name,\n  gmfDrawingFeatureStyleComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module gmf.import.wmsCapabilityLayertreeComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfDatasourceExternalDataSourcesManager from 'gmf/datasource/ExternalDataSourcesManager.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessagePopup from 'ngeo/message/Popup.js';\n\nimport * as olBase from 'ol/index.js';\n\nimport 'bootstrap/js/collapse.js';\n\n\nconst exports = angular.module('gmfWmscapabilitylayertreenode', [\n  gmfDatasourceExternalDataSourcesManager.module.name,\n  ngeoMessagePopup.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/import/wmsCapabilityLayertreeComponent', require('./wmsCapabilityLayertreeComponent.html'));\n});\n\n\nexports.value('gmfWmscapabilitylayertreenodeTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfWmscapabilitylayertreenodeTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/import/wmsCapabilityLayertreeComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfWmscapabilitylayertreenodeTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfWmscapabilitylayertreenodeTemplateUrl($attrs, gmfWmscapabilitylayertreenodeTemplateUrl) {\n  return gmfWmscapabilitylayertreenodeTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!gmf.datasource.ExternalDataSourcesManager}\n   *     gmfExternalDataSourcesManager GMF service responsible of managing\n   *     external data sources.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfWmscapabilitylayertreenodeController\n   */\n  constructor(gmfExternalDataSourcesManager) {\n\n    // Binding properties\n\n    /**\n     * WMS Capabilities definition\n     * @type {!Object}\n     * @export\n     */\n    this.capabilities;\n\n    /**\n     * WMS Capability Layer object.\n     * @type {!Object}\n     * @export\n     */\n    this.layer;\n\n    /**\n     * The original server url that was used to build the WMS GetCapabilities\n     * request.\n     * @type {string}\n     * @export\n     */\n    this.url;\n\n\n    // Injected properties\n\n    /**\n     * @type {!gmf.datasource.ExternalDataSourcesManager}\n     * @private\n     */\n    this.gmfExternalDataSourcesManager_ = gmfExternalDataSourcesManager;\n  }\n\n  /**\n   * @param {!Object} layer WMS Capability Layer object\n   * @export\n   */\n  createAndAddDataSource(layer) {\n    this.gmfExternalDataSourcesManager_.createAndAddDataSourceFromWMSCapability(\n      layer,\n      this.capabilities,\n      this.url\n    );\n  }\n\n  /**\n   * @param {!Object} layer WMS Capability Layer object\n   * @return {number} Unique id for the Capability Layer.\n   * @export\n   */\n  getUid(layer) {\n    return olBase.getUid(layer);\n  }\n};\n\n\nexports.component('gmfWmscapabilitylayertreenode', {\n  bindings: {\n    'capabilities': '<',\n    'layer': '<',\n    'url': '<'\n  },\n  controller: exports.Controller_,\n  templateUrl: gmfWmscapabilitylayertreenodeTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module gmf.import.wmtsCapabilityLayertreeComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfDatasourceExternalDataSourcesManager from 'gmf/datasource/ExternalDataSourcesManager.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessagePopup from 'ngeo/message/Popup.js';\n\nimport * as olBase from 'ol/index.js';\n\nconst exports = angular.module('gmfWmtscapabilitylayertree', [\n  gmfDatasourceExternalDataSourcesManager.module.name,\n  ngeoMessagePopup.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/import/wmtsCapabilityLayertreeComponent', require('./wmtsCapabilityLayertreeComponent.html'));\n});\n\n\nexports.value('gmfWmtscapabilitylayertreTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfWmtscapabilitylayertreTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/import/wmtsCapabilityLayertreeComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfWmtscapabilitylayertreTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfWmtscapabilitylayertreTemplateUrl($attrs, gmfWmtscapabilitylayertreTemplateUrl) {\n  return gmfWmtscapabilitylayertreTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!gmf.datasource.ExternalDataSourcesManager}\n   *     gmfExternalDataSourcesManager GMF service responsible of managing\n   *     external data sources.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfWmtscapabilitylayertreeController\n   */\n  constructor(gmfExternalDataSourcesManager) {\n\n    // Binding properties\n\n    /**\n     * WMS Capabilities definition\n     * @type {!Object}\n     * @export\n     */\n    this.capabilities;\n\n    /**\n     * List of WMTS Capability Layer objects.\n     * @type {!Array.<!Object>}\n     * @export\n     */\n    this.layers;\n\n    /**\n     * The original WMTS GetCapabilities url that was used to fetch the\n     * capability layers.\n     * @type {string}\n     * @export\n     */\n    this.url;\n\n\n    // Injected properties\n\n    /**\n     * @type {!gmf.datasource.ExternalDataSourcesManager}\n     * @private\n     */\n    this.gmfExternalDataSourcesManager_ = gmfExternalDataSourcesManager;\n  }\n\n  /**\n   * @param {!Object} layer WMTS Capability Layer object\n   * @export\n   */\n  createAndAddDataSource(layer) {\n    const manager = this.gmfExternalDataSourcesManager_;\n    manager.createAndAddDataSourceFromWMTSCapability(\n      layer,\n      this.capabilities,\n      this.url\n    );\n  }\n\n  /**\n   * @param {!Object} layer WMTS Capability Layer object\n   * @return {number} Unique id for the Capability Layer.\n   * @export\n   */\n  getUid(layer) {\n    return olBase.getUid(layer);\n  }\n};\n\n\nexports.component('gmfWmtscapabilitylayertree', {\n  bindings: {\n    'capabilities': '<',\n    'layers': '<',\n    'url': '<'\n  },\n  controller: exports.Controller_,\n  templateUrl: gmfWmtscapabilitylayertreTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module gmf.import.importdatasourceComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfDatasourceExternalDataSourcesManager from 'gmf/datasource/ExternalDataSourcesManager.js';\n\n/** @suppress {extraRequire} */\nimport gmfImportWmsCapabilityLayertreeComponent from 'gmf/import/wmsCapabilityLayertreeComponent.js';\n\n/** @suppress {extraRequire} */\nimport gmfImportWmtsCapabilityLayertreeComponent from 'gmf/import/wmtsCapabilityLayertreeComponent.js';\n\nimport googAsserts from 'goog/asserts.js';\nimport ngeoQueryQuerent from 'ngeo/query/Querent.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\n\nconst exports = angular.module('gmfImportdatasource', [\n  gmfDatasourceExternalDataSourcesManager.module.name,\n  gmfImportWmsCapabilityLayertreeComponent.name,\n  gmfImportWmtsCapabilityLayertreeComponent.name,\n  ngeoQueryQuerent.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/import/importdatasourceComponent', require('./importdatasourceComponent.html'));\n});\n\n\nexports.value('gmfImportdatasourceTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfImportdatasourceTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/import/importdatasourceComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfImportdatasourceTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfImportdatasourceTemplateUrl($attrs, gmfImportdatasourceTemplateUrl) {\n  return gmfImportdatasourceTemplateUrl($attrs);\n}\n\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {!jQuery} $element Element.\n   * @param {!angular.$filter} $filter Angular filter.\n   * @param {!angular.$injector} $injector Main injector.\n   * @param {!angular.Scope} $scope Angular scope.\n   * @param {!angular.$timeout} $timeout Angular timeout service.\n   * @param {!gmf.datasource.ExternalDataSourcesManager}\n   *     gmfExternalDataSourcesManager GMF service responsible of managing\n   *     external data sources.\n   * @param {!ngeo.query.Querent} ngeoQuerent Ngeo querent service.\n   * @private\n   * @struct\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfImportdatasourceController\n   */\n  constructor($element, $filter, $injector, $scope, $timeout,\n    gmfExternalDataSourcesManager, ngeoQuerent) {\n\n    // Binding properties\n\n    /**\n     * @type {!ol.Map}\n     * @export\n     */\n    this.map;\n\n\n    // Injected properties\n\n    /**\n     * @type {!jQuery}\n     * @private\n     */\n    this.element_ = $element;\n\n    /**\n     * @type {!angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {!angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {!gmf.datasource.ExternalDataSourcesManager}\n     * @private\n     */\n    this.gmfExternalDataSourcesManager_ = gmfExternalDataSourcesManager;\n\n    /**\n     * @type {!ngeo.query.Querent}\n     * @private\n     */\n    this.ngeoQuerent_ = ngeoQuerent;\n\n\n    // Model properties\n\n    /**\n     * @type {File|undefined}\n     * @export\n     */\n    this.file;\n\n    /**\n     * @type {string|undefined}\n     * @export\n     */\n    this.url;\n\n\n    // Inner properties\n\n    /**\n     * @type {!jQuery}\n     * @private\n     */\n    this.fileInput_ = $element.find('input[type=file]');\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.hasError = false;\n\n    /**\n     * @type {?angular.$q.Promise}\n     * @private\n     */\n    this.hasErrorPromise_ = null;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.mode = exports.Controller_.Mode.ONLINE;\n\n    /**\n     * @type {!Array.<string>}\n     * @export\n     */\n    this.modes = [\n      exports.Controller_.Mode.LOCAL,\n      exports.Controller_.Mode.ONLINE\n    ];\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.pending = false;\n\n    /**\n     * @type {!ngeox.unitPrefix}\n     * @private\n     */\n    this.unitPrefixFormat_ = /** @type {ngeox.unitPrefix} */ (\n      $filter('ngeoUnitPrefix'));\n\n    /**\n     * Current WMS Capabilities that were connected.\n     * @type {?Object}\n     * @export\n     */\n    this.wmsCapabilities = null;\n\n    /**\n     * Current WTMS Capabilities that were connected.\n     * @type {?Object}\n     * @export\n     */\n    this.wmtsCapabilities = null;\n\n    /**\n     * @type {Bloodhound|undefined}\n     * @private\n     */\n    this.serversEngine_;\n\n    const servers = $injector.has('gmfExternalOGCServers') ?\n      /** @type {Array.<!gmfx.ExternalOGCServer>|undefined} */ (\n        $injector.get('gmfExternalOGCServers')\n      ) : undefined;\n\n    if (servers) {\n      const serverUrls = servers.map(server => server['url']);\n      this.serversEngine_ = new Bloodhound({\n        /**\n         * Allows search queries to match from string from anywhere within\n         * the url, and not only from the beginning of the string (which is\n         * the default, non-configurable behaviour of bloodhound).\n         *\n         * Borrowed from:\n         * https://stackoverflow.com/questions/22059933/twitter-typeahead-js-how-to-return-all-matched-elements-within-a-string\n         *\n         * @param {BloodhoundDatum} datum Datum.\n         * @return {Array.<string>} List of datum tokenizers.\n         */\n        datumTokenizer: (datum) => {\n          googAsserts.assertString(datum);\n          const originalDatumTokenizers = Bloodhound.tokenizers.whitespace(\n            datum);\n          googAsserts.assert(originalDatumTokenizers);\n          const datumTokenizers = [];\n          for (const originalDatumTokenizer of originalDatumTokenizers) {\n            let i = 0;\n            while ((i + 1) < originalDatumTokenizer.length) {\n              datumTokenizers.push(\n                originalDatumTokenizer.substr(\n                  i,\n                  originalDatumTokenizer.length\n                )\n              );\n              i++;\n            }\n          }\n          return datumTokenizers;\n        },\n        queryTokenizer: Bloodhound.tokenizers.whitespace,\n        identify: false,\n        local: serverUrls\n      });\n    }\n\n    // Register input[type=file] onchange event, use HTML5 File api\n    this.fileInput_.on('change', () => {\n      this.file = this.fileInput_[0].files && this.fileInput_[0].files[0] ?\n        this.fileInput_[0].files[0] : undefined;\n      this.scope_.$apply();\n    });\n  }\n\n  /**\n   * Called on initialization of the component.\n   */\n  $onInit() {\n    this.gmfExternalDataSourcesManager_.map = this.map;\n\n\n    if (this.serversEngine_) {\n      // Timeout to let Angular render the placeholder of the input properly,\n      // otherwise typeahead would copy the string with {{}} in it...\n      this.timeout_(() => {\n        googAsserts.assert(this.serversEngine_);\n        const $urlInput = this.element_.find('input[name=url]');\n        const $connectBtn = this.element_.find('button.gmf-importdatasource-connect-btn');\n        $urlInput.typeahead({\n          hint: true,\n          highlight: true,\n          minLength: 1\n        }, {\n          name: 'url',\n          source: this.serversEngine_.ttAdapter()\n        }).bind('typeahead:select', (ev, suggestion) => {\n          this.timeout_(() => {\n            this.url = suggestion;\n            this.scope_.$apply();\n            $connectBtn.focus();\n          });\n        });\n      });\n    }\n  }\n\n  /**\n   * Triggers a 'click' on the \"Browse\" button.\n   * @export\n   */\n  browse() {\n    this.hasError = false;\n    this.element_.find('input[type=file][name=file]').click();\n  }\n\n  /**\n   * Connect to given online resource URL.\n   * @export\n   */\n  connect() {\n    const url = googAsserts.assertString(this.url);\n    const serviceType = ngeoDatasourceOGC.guessServiceTypeByUrl(url);\n\n    this.startWorking_();\n    if (serviceType === ngeoDatasourceOGC.Type.WMS) {\n      this.ngeoQuerent_.wmsGetCapabilities(url).then(\n        (wmsCapabilities) => {\n          this.wmsCapabilities = wmsCapabilities;\n          this.stopWorking_();\n        },\n        () => {\n          // Something went wrong...\n          this.stopWorking_(true);\n        }\n      );\n    } else if (serviceType === ngeoDatasourceOGC.Type.WMTS) {\n      this.ngeoQuerent_.wmtsGetCapabilities(url).then(\n        (wmtsCapabilities) => {\n          this.wmtsCapabilities = wmtsCapabilities;\n          this.stopWorking_();\n        },\n        () => {\n          // Something went wrong...\n          this.stopWorking_(true);\n        }\n      );\n    } else {\n      // Could not determine the type of url\n      this.timeout_(() => {\n        this.stopWorking_(true);\n      });\n    }\n  }\n\n  /**\n   * Create data source from file.\n   * @export\n   */\n  load() {\n    const file = googAsserts.assert(this.file);\n    this.gmfExternalDataSourcesManager_.createAndAddDataSourceFromFile(file, (success) => {\n      if (!success) {\n        this.hasError = true;\n      }\n    });\n  }\n\n  /**\n   * @return {string} The name of the file and human-readable size.\n   * @export\n   */\n  get fileNameAndSize() {\n    let nameAndSize = '';\n\n    const file = this.file;\n    if (file !== undefined) {\n      const fileSize = this.unitPrefixFormat_(file.size, 'o');\n      nameAndSize = `${file.name}, ${fileSize}`;\n    }\n\n    return nameAndSize;\n  }\n\n\n  // === Private methods ===\n\n  /**\n   * @private\n   */\n  startWorking_() {\n    this.pending = true;\n    this.hasError = false;\n\n    // Clear any previous objects\n    this.wmsCapabilities = null;\n    this.wmtsCapabilities = null;\n  }\n\n  /**\n   * @param {boolean=} opt_hasError Whether we stopped working because of after\n   *     an error.\n   * @private\n   */\n  stopWorking_(opt_hasError = false) {\n    this.pending = false;\n    if (opt_hasError) {\n      this.hasError = true;\n      if (this.hasErrorPromise_) {\n        this.timeout_.cancel(this.hasErrorPromise_);\n      }\n      this.hasErrorPromise_ = this.timeout_(() => {\n        this.hasError = false;\n        this.hasErrorPromise_ = null;\n      }, 3000);\n    }\n  }\n};\n\n\n/**\n * @enum {string}\n */\nexports.Controller_.Mode = {\n  LOCAL: 'Local',\n  ONLINE: 'Online'\n};\n\n\nexports.component('gmfImportdatasource', {\n  bindings: {\n    'map': '<'\n  },\n  controller: exports.Controller_,\n  templateUrl: gmfImportdatasourceTemplateUrl\n});\n\n\nexport default exports;\n","/**\n * @module gmf.import.module\n */\nimport gmfImportImportdatasourceComponent from 'gmf/import/importdatasourceComponent.js';\nimport gmfImportWmsCapabilityLayertreeComponent from 'gmf/import/wmsCapabilityLayertreeComponent.js';\nimport gmfImportWmtsCapabilityLayertreeComponent from 'gmf/import/wmtsCapabilityLayertreeComponent.js';\n\nimport './import.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfImportModule', [\n  gmfImportImportdatasourceComponent.name,\n  gmfImportWmsCapabilityLayertreeComponent.name,\n  gmfImportWmtsCapabilityLayertreeComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.search.searchDirective\n */\n\n/**\n * Provides the \"ngeoSearch\" directive, which uses Twitter's\n * typeahead component to change an input text into a search field.\n *\n * Example:\n *\n *      <input type=\"text\"\n *        ngeo-search=\"ctrl.typeaheadOptions\"\n *        ngeo-search-datasets=\"ctrl.typeaheadDatasets\"\n *        ngeo-search-listeners=\"crtl.typeaheadListeners\">\n *\n * See our live example: [../examples/search.html](../examples/search.html)\n *\n * @htmlAttribute {TypeaheadOptions} ngeo-search The options.\n * @htmlAttribute {Array.<TypeaheadDataset>} ngeo-search-datasets The sources datasets.\n * @htmlAttribute {ngeox.SearchDirectiveListeners} ngeo-search-listeners The listeners.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoSearch\n */\nconst exports = function() {\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n\n      const typeaheadOptionsExpr = attrs['ngeoSearch'];\n      const typeaheadOptions = /** @type {TypeaheadOptions} */\n              (scope.$eval(typeaheadOptionsExpr));\n\n      const typeaheadDatasetsExpr = attrs['ngeoSearchDatasets'];\n      const typeaheadDatasets = /** @type {Array.<TypeaheadDataset>} */\n              (scope.$eval(typeaheadDatasetsExpr));\n\n      const args = typeaheadDatasets.slice();\n      args.unshift(typeaheadOptions);\n\n      element.typeahead(...args);\n\n      const typeaheadListenersExpr = attrs['ngeoSearchListeners'];\n      const typeaheadListeners_ =\n              /** @type {ngeox.SearchDirectiveListeners} */\n              (scope.$eval(typeaheadListenersExpr));\n\n      /**\n       * @type {ngeox.SearchDirectiveListeners}\n       */\n      const typeaheadListeners = exports.adaptListeners_(\n        typeaheadListeners_);\n\n      element.on('typeahead:open', () => {\n        scope.$apply(() => {\n          typeaheadListeners.open();\n        });\n      });\n\n      element.on('typeahead:close', () => {\n        scope.$apply(() => {\n          typeaheadListeners.close();\n        });\n      });\n\n      element.on('typeahead:cursorchange',\n        /**\n         * @param {jQuery.Event} event Event.\n         * @param {Object} suggestion Suggestion.\n         * @param {TypeaheadDataset} dataset Dataset.\n         */\n        (event, suggestion, dataset) => {\n          scope.$apply(() => {\n            typeaheadListeners.cursorchange(event, suggestion, dataset);\n          });\n        });\n\n      element.on('typeahead:select',\n        /**\n         * @param {jQuery.Event} event Event.\n         * @param {Object} suggestion Suggestion.\n         * @param {TypeaheadDataset} dataset Dataset.\n         */\n        (event, suggestion, dataset) => {\n          scope.$apply(() => {\n            typeaheadListeners.select(event, suggestion, dataset);\n          });\n        });\n\n      element.on('typeahead:autocomplete',\n        /**\n         * @param {jQuery.Event} event Event.\n         * @param {Object} suggestion Suggestion.\n         * @param {TypeaheadDataset} dataset Dataset.\n         */\n        (event, suggestion, dataset) => {\n          scope.$apply(() => {\n            typeaheadListeners.autocomplete(event, suggestion, dataset);\n          });\n        });\n\n      element.on('typeahead:asyncreceive',\n        /**\n         * @param {jQuery.Event} event Event.\n         * @param {TypeaheadDataset} dataset Dataset.\n         * @param {string} query Query.\n         */\n        (event, dataset, query) => {\n          scope.$apply(() => {\n            const empty = element.data('tt-typeahead')['menu']['_allDatasetsEmpty']();\n            typeaheadListeners.datasetsempty(event, query, empty);\n          });\n        });\n\n    }\n  };\n};\n\n\n/**\n * Create a real ngeox.SearchDirectiveListeners object out of the object\n * returned by $eval.\n * @param {ngeox.SearchDirectiveListeners} object Object.\n * @return {ngeox.SearchDirectiveListeners} The listeners object.\n * @private\n */\nexports.adaptListeners_ = function(object) {\n  /** @type {ngeox.SearchDirectiveListeners} */\n  let typeaheadListeners;\n  if (object === undefined) {\n    typeaheadListeners = {\n      open() {},\n      close() {},\n      cursorchange() {},\n      datasetsempty() {},\n      select() {},\n      autocomplete() {}\n    };\n  } else {\n    typeaheadListeners = {\n      open: object.open !== undefined ?\n        object.open : () => {},\n      close: object.close !== undefined ?\n        object.close : () => {},\n      cursorchange: object.cursorchange !== undefined ?\n        object.cursorchange : () => {},\n      datasetsempty: object.datasetsempty !== undefined ?\n        object.datasetsempty : () => {},\n      select: object.select !== undefined ?\n        object.select : () => {},\n      autocomplete: object.autocomplete !== undefined ?\n        object.autocomplete : () => {}\n    };\n  }\n  return typeaheadListeners;\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoSearchDirective', []);\n\n\n// Register the directive in the module\nexports.module.directive('ngeoSearch', exports);\n\n\nexport default exports;\n","/**\n * @module ngeo.search.createGeoJSONBloodhound\n */\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport * as olObj from 'ol/obj.js';\n\nimport 'corejs-typeahead';\n\n/**\n * @param {string} url an URL to a search service.\n * @param {(function(GeoJSONFeature): boolean)=} opt_filter function to filter\n *     results.\n * @param {ol.proj.Projection=} opt_featureProjection Feature projection.\n * @param {ol.proj.Projection=} opt_dataProjection Data projection.\n * @param {BloodhoundOptions=} opt_options optional Bloodhound options. If\n *     undefined, the default Bloodhound config will be used.\n * @param {BloodhoundRemoteOptions=} opt_remoteOptions optional Bloodhound\n * remote options. Effective only if `remote` is not defined in `opt_options`.\n * @return {Bloodhound} The Bloodhound object.\n */\nconst exports = function(url, opt_filter, opt_featureProjection,\n  opt_dataProjection, opt_options, opt_remoteOptions) {\n  const geojsonFormat = new olFormatGeoJSON();\n  const bloodhoundOptions = /** @type {BloodhoundOptions} */ ({\n    remote: {\n      url,\n      prepare(query, settings) {\n        settings.url = settings.url.replace('%QUERY', query);\n        return settings;\n      },\n      transform(parsedResponse) {\n        /** @type {GeoJSONFeatureCollection} */\n        let featureCollection = /** @type {GeoJSONFeatureCollection} */\n            (parsedResponse);\n        if (opt_filter !== undefined) {\n          featureCollection = /** @type {GeoJSONFeatureCollection} */ ({\n            type: 'FeatureCollection',\n            features: featureCollection.features.filter(opt_filter)\n          });\n        }\n\n        return geojsonFormat.readFeatures(featureCollection, {\n          featureProjection: opt_featureProjection,\n          dataProjection: opt_dataProjection\n        });\n      }\n    },\n    // datumTokenizer is required by the Bloodhound constructor but it\n    // is not used when only a remote is passsed to Bloodhound.\n    datumTokenizer: () => {},\n    queryTokenizer: Bloodhound.tokenizers.whitespace\n  });\n\n  // the options objects are cloned to avoid updating the passed object\n  const options = olObj.assign({}, opt_options || {});\n  const remoteOptions = olObj.assign({}, opt_remoteOptions || {});\n\n  if (options.remote) {\n    // move the remote options to opt_remoteOptions\n    olObj.assign(remoteOptions, options.remote);\n    delete options.remote;\n  }\n\n  olObj.assign(bloodhoundOptions, options);\n  olObj.assign(bloodhoundOptions.remote, remoteOptions);\n\n  return new Bloodhound(bloodhoundOptions);\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoSearchCreategeojsonbloodhound', []);\n\nexports.module.value(\n  'ngeoSearchCreateGeoJSONBloodhound',\n  exports);\n\n\n/**\n * Provides a function that creates a Bloodhound engine\n * expecting GeoJSON responses from the search web service, which creates\n * `ol.Feature` objects as suggestions.\n *\n * Example:\n *\n *     let bloodhound = createGeoJSONBloodhound(\n *       'http://example.com/fulltextsearch?query=%QUERY',\n *       aFilterFunction,\n *       ol.proj.get('EPSG:3857'));\n *     bloodhound.initialize();\n *\n *     let bloodhound = createGeoJSONBloodhound(\n *       '',\n *       undefined,\n *       ol.proj.get('EPSG:3857'),\n *       ol.proj.get('EPSG:21781'),\n *       {\n *         remote: {\n *           url: mySearchEngineUrl,\n *           replace: function(url, query) {\n *             return url +\n *                 '?qtext=' + encodeURIComponent(query) +\n *                 '&lang=' + gettextCatalog.currentLanguage;\n *           }\n *         }\n *       }\n *     );\n *     bloodhound.initialize();\n *\n * @typedef {function(string, (function(GeoJSONFeature): boolean)=,\n * ol.proj.Projection=, ol.proj.Projection=, BloodhoundOptions=,\n * BloodhoundRemoteOptions=):Bloodhound}\n * @ngdoc service\n * @ngname search.createGeoJSONBloodhound\n */\nexports.Function;\n\n\nexport default exports;\n","/**\n * @module ngeo.search.createLocationSearchBloodhound\n */\nimport * as olObj from 'ol/obj.js';\nimport * as olProj from 'ol/proj.js';\n\n/** @suppress {extraRequire} */\nimport ngeoProjEPSG21781 from 'ngeo/proj/EPSG21781.js';\n\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olFeature from 'ol/Feature.js';\n\nimport 'corejs-typeahead';\n\n\n/**\n * @param {ngeox.search.LocationSearchOptions=} opt_options Options.\n * @return {Bloodhound} The Bloodhound object.\n */\nconst exports = function(opt_options) {\n  const options = opt_options || {};\n\n  const sourceProjection = olProj.get(ngeoProjEPSG21781);\n  const targetProjection = options.targetProjection;\n\n  /**\n   * @param {string} bbox Bbox string.\n   * @return {?ol.Extent} Parsed extent.\n   */\n  const parseBbox = (bbox) => {\n    const regex = /BOX\\((.*?) (.*?),(.*?) (.*?)\\)/g;\n    const match = regex.exec(bbox);\n    if (match !== null) {\n      return [\n        parseFloat(match[1]),\n        parseFloat(match[2]),\n        parseFloat(match[3]),\n        parseFloat(match[4])\n      ];\n    } else {\n      return null;\n    }\n  };\n\n  const removeHtmlTags = label => label.replace(/<\\/?[ib]>/g, '');\n\n  const extractName = (label) => {\n    const regex = /<b>(.*?)<\\/b>/g;\n    const match = regex.exec(label);\n    if (match !== null) {\n      return match[1];\n    } else {\n      return label;\n    }\n  };\n\n  const bloodhoundOptions = /** @type {BloodhoundOptions} */ ({\n    remote: {\n      url: 'https://api3.geo.admin.ch/rest/services/api/SearchServer?type=locations&searchText=%QUERY',\n      prepare: (query, settings) => {\n        settings.url = settings.url.replace('%QUERY', query);\n        if (options.limit !== undefined) {\n          settings.url += `&limit=${options.limit}`;\n        }\n        if (options.origins !== undefined) {\n          settings.url += `&origins=${options.origins}`;\n        }\n\n        return (options.prepare !== undefined) ?\n          options.prepare(query, settings) : settings;\n      },\n      transform: (/** @type {geoAdminx.SearchLocationResponse} */ parsedResponse) => {\n        const features = parsedResponse.results.map((/** @type {geoAdminx.SearchLocationResult} */ result) => {\n          const attrs = result.attrs;\n\n          // note that x and y are switched!\n          const point = new olGeomPoint([attrs.y, attrs.x]);\n          let bbox = parseBbox(attrs.geom_st_box2d);\n          if (targetProjection !== undefined) {\n            point.transform(sourceProjection, targetProjection);\n            if (bbox !== null) {\n              bbox = olProj.transformExtent(bbox, sourceProjection, targetProjection);\n            }\n          }\n\n          attrs['geometry'] = point;\n          attrs['bbox'] = bbox;\n\n          // create a label without HTML tags\n          const label = attrs.label;\n          attrs['label_no_html'] = removeHtmlTags(label);\n          attrs['label_simple'] = extractName(label);\n\n          const feature = new olFeature(attrs);\n          feature.setId(attrs.featureId);\n\n          return feature;\n        });\n\n        return features;\n      }\n    },\n    // datumTokenizer is required by the Bloodhound constructor but it\n    // is not used when only a remote is passsed to Bloodhound.\n    datumTokenizer: () => {},\n    queryTokenizer: Bloodhound.tokenizers.whitespace\n  });\n\n  // the options objects are cloned to avoid updating the passed object\n  const bhOptions = olObj.assign({}, options.options || {});\n  const remoteOptions = olObj.assign({}, options.remoteOptions || {});\n\n  if (bhOptions.remote) {\n    // move the remote options to opt_remoteOptions\n    olObj.assign(remoteOptions, bhOptions.remote);\n    delete bhOptions.remote;\n  }\n\n  olObj.assign(bloodhoundOptions, bhOptions);\n  olObj.assign(bloodhoundOptions.remote, remoteOptions);\n\n  return new Bloodhound(bloodhoundOptions);\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('ngeoCreateLocationSearchBloodhound', []);\n\nexports.module.value(\n  'ngeoCreateLocationSearchBloodhound',\n  exports);\n\n\n/**\n * Provides a function that creates a Bloodhound engine\n * for the GeoAdmin Location Search API, which creates `ol.Feature` objects\n * as suggestions.\n *\n * See: http://api3.geo.admin.ch/services/sdiservices.html#search\n *\n * Example:\n *\n *     let bloodhound = ngeoCreateLocationSearchBloodhound({\n *       targetProjection: ol.proj.get('EPSG:3857'),\n *       limit: 10\n *     });\n *     bloodhound.initialize();\n *\n * @typedef {function(ngeox.search.LocationSearchOptions=):Bloodhound}\n * @ngdoc service\n * @ngname search.createLocationSearchBloodhound\n */\nexports.Function;\n\n\nexport default exports;\n","/**\n * @module ngeo.search.module\n */\nimport ngeoSearchSearchDirective from 'ngeo/search/searchDirective.js';\nimport ngeoSearchCreateGeoJSONBloodhound from 'ngeo/search/createGeoJSONBloodhound.js';\nimport ngeoSearchCreateLocationSearchBloodhound from 'ngeo/search/createLocationSearchBloodhound.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoSearchModule', [\n  ngeoSearchSearchDirective.module.name,\n  ngeoSearchCreateGeoJSONBloodhound.module.name,\n  ngeoSearchCreateLocationSearchBloodhound.module.name\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.profile.d3Elevation\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olObj from 'ol/obj.js';\n\nimport 'd3-transition';\nimport {bisector, extent} from 'd3-array';\nimport {axisBottom, axisLeft} from 'd3-axis';\nimport {scaleLinear} from 'd3-scale';\nimport {mouse, select, selectAll} from 'd3-selection';\nimport {area, line} from 'd3-shape';\nconst d3 = {\n  bisector,\n  extent,\n  axisBottom,\n  axisLeft,\n  scaleLinear,\n  mouse,\n  select,\n  selectAll,\n  area,\n  line,\n};\n\n\n/**\n * Provides a D3js component to be used to draw an elevation\n * profile chart.\n *\n *     let selection = d3.select('#element_id');\n *     let profile = ngeo.profile.d3Elevation({\n *       distanceExtractor: function (item) {return item['dist'];},\n *       linesConfiguration: {\n *         'lineZ1': {\n *           zExtractor: function (item) {return item['values']['z1'];}\n *         },\n *         'lineZ2': {\n *           color: '#00F',\n *           zExtractor: function (item) {return item['values']['z2'];}\n *         }\n *       },\n *       hoverCallback: function(point, dist, xUnits, elevations, yUnits) {\n *         console.log(point.x, point.y);\n *       },\n *       outCallback: function() {\n *         console.log(\"out\");\n *       }\n *     });\n *     selection.datum(data).call(profile);\n *\n * The selection data must be an array.\n * The layout for the items of this array is unconstrained: the distance values\n * is extracted using the distanceExtractor config option and multiples z values\n * can be displayed by providing multiple linesConfiguration with its specific\n * zExtractor.\n * Optionally you can provide a color in your linesConfiguration. A line without\n * color will be red. Each linesConfiguration name is used as class for its\n * respective line. So you can pass a styleDefs config option (inline css) to\n * customize the line or all the chart.\n * Optionally, POIs can be displayed and depend on a poiExtractor\n * config option.\n *\n * The data below will work for the above example:\n *\n *     [\n *         {\n *             \"y\": 199340,\n *             \"values\": {\"z1\": 788.7, \"z2\": 774.2},\n *             \"dist\": 0.0,\n *             \"x\": 541620\n *         }, ...\n *     ]\n *\n * @return {Object} D3js component.\n * @param {ngeox.profile.ProfileOptions} options Profile options.\n * @export\n */\nconst exports = function(options) {\n  /**\n   * Whether the simplified profile should be shown.\n   * @type {boolean}\n   */\n  const light = options.light !== undefined ? options.light : false;\n\n\n  /**\n   * The values for margins around the chart defined in pixels.\n   */\n  const margin = light ? {top: 0, right: 0, bottom: 0, left: 0} :\n    {top: 10, right: 20, bottom: 30, left: 40};\n\n  /**\n   * Hover callback function.\n   * @type {function(Object, number, string, Object.<string, number>, string)}\n   */\n  const hoverCallback = options.hoverCallback !== undefined ?\n    options.hoverCallback : () => {};\n\n  /**\n   * Out callback function.\n   * @type {function()}\n   */\n  const outCallback = options.outCallback !== undefined ?\n    options.outCallback : () => {};\n\n  /**\n   * Distance data extractor used to get the dist values.\n   */\n  const distanceExtractor = options.distanceExtractor;\n\n  /**\n   * Line configuration object.\n   */\n  const linesConfiguration = options.linesConfiguration;\n\n  /**\n   * Number of different configurations for the line.\n   */\n  const numberOfLines = Object.keys(linesConfiguration).length;\n\n  /**\n   * Method to get the coordinate in pixels from a distance.\n   */\n  const bisectDistance = d3.bisector(d => distanceExtractor(d)).left;\n\n  /**\n   * POI data extractor.\n   */\n  const poiExtractor = options.poiExtractor;\n\n  /**\n   * Optional SVG inline style.\n   */\n  const styleDefs = options.styleDefs;\n\n  /**\n   * @type {number}\n   */\n  const poiLabelAngle = options.poiLabelAngle !== undefined ?\n    options.poiLabelAngle : -60;\n\n  /**\n   * @type {Object.<string, string>}\n   */\n  const i18n = options.i18n || {};\n\n  /**\n   * @type {string}\n   */\n  const xAxisLabel = (i18n.xAxis || 'Distance');\n\n  /**\n   * @type {string}\n   */\n  const yAxisLabel = (i18n.yAxis || 'Elevation');\n\n  /**\n   * @type {ngeox.profile.ProfileFormatter}\n   */\n  const formatter = {\n    /**\n     * @param {number} dist Distance.\n     * @param {string} units Units.\n     * @return {string} Distance.\n     */\n    xhover(dist, units) {\n      return `${parseFloat(dist.toPrecision(3))} ${units}`;\n    },\n    /**\n     * @param {number} ele Elevation.\n     * @param {string} units Units.\n     * @return {string} Elevation.\n     */\n    yhover(ele, units) {\n      return ele !== null ? `${Math.round(ele)} m` : '';\n    },\n    /**\n     * @param {number} dist Distance.\n     * @param {string} units Units.\n     * @return {string|number} Distance.\n     */\n    xtick(dist, units) {\n      return dist;\n    },\n    /**\n     * @param {number} ele Elevation.\n     * @param {string} units Units.\n     * @return {string|number} Elevation.\n     */\n    ytick(ele, units) {\n      return ele;\n    }\n  };\n\n  if (options.formatter !== undefined) {\n    olObj.assign(formatter, options.formatter);\n  }\n\n  /**\n   * @type {boolean}\n   */\n  const lightXAxis = options.lightXAxis !== undefined ? options.lightXAxis : false;\n\n  // Objects shared with the showPois function\n  /**\n   * @type {Object}\n   */\n  let svg;\n\n  /**\n   * D3 x scale.\n   */\n  let x;\n\n  /**\n   * D3 y scale.\n   */\n  let y;\n\n  /**\n   * Scale modifier to allow customizing the x and y scales.\n   */\n  const scaleModifier = options.scaleModifier;\n\n  let g;\n\n  /**\n   * Height of the chart in pixels\n   */\n  let height;\n\n  /**\n   * Width of the chart in pixels\n   */\n  let width;\n\n  /**\n  * Factor to determine whether to use 'm' or 'km'.\n  */\n  let xFactor;\n\n  /**\n  * Distance units. Either 'm' or 'km'.\n  */\n  let xUnits;\n\n  /**\n   * D3 extent of the distance.\n   */\n  let xDomain;\n\n\n  const profile = function(selection) {\n    selection.each(function(data) {\n      d3.select(this).selectAll('svg').remove();\n      if (data === undefined) {\n        return;\n      }\n\n      width = Math.max(this.clientWidth - margin.right - margin.left, 0);\n      x = d3.scaleLinear().range([0, width]);\n\n      height = Math.max(this.clientHeight - margin.top - margin.bottom, 0);\n      y = d3.scaleLinear().range([height, 0]);\n\n      const xAxis = d3.axisBottom(x);\n      const yAxis = d3.axisLeft(y);\n\n      let area;\n      if (numberOfLines === 1) {\n        area = d3.area()\n          .x(d => x(distanceExtractor(d)))\n          .y0(height)\n          .y1((d) => {\n            const firstLineName =  Object.keys(linesConfiguration)[0];\n            return y(linesConfiguration[firstLineName].zExtractor(d));\n          });\n      }\n\n      // Select the svg element, if it exists.\n      svg = d3.select(this).selectAll('svg').data([data]);\n      // Otherwise, create the skeletal chart.\n      const svgEnter = svg.enter().append('svg');\n      // Then select it again to get the complete object.\n      svg = d3.select(this).selectAll('svg').data([data]);\n\n      if (styleDefs !== undefined) {\n        svgEnter.append('defs').append('style')\n          .attr('type', 'text/css')\n          .text(styleDefs);\n      }\n      const gEnter = svgEnter.append('g');\n\n      clearPois();\n\n      gEnter.style('font', '11px Arial');\n\n      if (numberOfLines === 1) {\n        gEnter.append('path').attr('class', 'area')\n          .style('fill', 'rgba(222, 222, 222, 0.5)');\n      }\n\n      gEnter.insert('g', ':first-child')\n        .attr('class', 'grid-y');\n\n      if (!light) {\n        gEnter.append('g')\n          .attr('class', 'x axis')\n          .attr('transform', `translate(0,${height})`);\n\n        gEnter.append('text')\n          .attr('class', 'x label')\n          .attr('text-anchor', 'end')\n          .attr('x', width - 4)\n          .attr('y', height - 4);\n\n        gEnter.append('g')\n          .attr('class', 'y axis');\n\n        gEnter.append('text')\n          .attr('class', 'y label')\n          .attr('text-anchor', 'end')\n          .attr('y', 6)\n          .attr('dy', '.75em')\n          .attr('transform', 'rotate(-90)')\n          .style('fill', 'grey')\n          .text(`${yAxisLabel} [m]`);\n\n        gEnter.append('g')\n          .attr('class', 'metas')\n          .attr('transform', `translate(${width + 3}, 0)`);\n      }\n\n      gEnter.append('g').attr('class', 'pois');\n\n      const xHover = gEnter.append('g').attr('class', 'x grid-hover');\n      xHover.append('svg:line').attr('stroke-dasharray', '5,5');\n      xHover.append('text');\n\n      gEnter.append('rect')\n        .attr('class', 'overlay')\n        .attr('width', width)\n        .attr('height', height)\n        .style('fill', 'none')\n        .style('pointer-events', 'all');\n\n      // Update the outer dimensions.\n      svg.attr('width', width + margin.left + margin.right)\n        .attr('height', height + margin.top + margin.bottom);\n\n      // Update the inner dimensions.\n      g = svg.select('g')\n        .attr('transform', `translate(${margin.left},${\n          margin.top})`);\n\n      xDomain = d3.extent(data, d => distanceExtractor(d));\n      x.domain(xDomain);\n\n      // Return an array with the min and max value of the min/max values of\n      // each lines.\n      const yDomain = function() {\n        let elevationsValues = [];\n        // Get min/max values (extent) of each lines.\n        for (const name in linesConfiguration) {\n          const extent = d3.extent(data, d => linesConfiguration[name].zExtractor(d));\n          // only include defined extent\n          if (extent.every(Number.isFinite)) {\n            elevationsValues = elevationsValues.concat(extent);\n          }\n        }\n        return [\n          Math.min.apply(null, elevationsValues),\n          Math.max.apply(null, elevationsValues)\n        ];\n      }();\n\n      y.domain(yDomain);\n\n      // set the ratio according to the horizontal distance\n      if (scaleModifier !== undefined) {\n        scaleModifier(x, y, width, height);\n      } else {\n        // By default, add a small padding so that it looks nicer\n        const padding = (yDomain[1] - yDomain[0]) * 0.1;\n        y.domain([yDomain[0] - padding, yDomain[1] + padding]);\n      }\n\n      // Update the area path.\n      if (numberOfLines === 1) {\n        g.select('.area')\n          .transition()\n          .attr('d', area);\n      }\n\n      // Set style and update the lines paths and y hover guides for each lines.\n      let line, name, yHover;\n      for (name in linesConfiguration) {\n        // Set style of each line and add a class with its respective name.\n        gEnter.append('path').attr('class', `line ${name}`)\n          .style('stroke', linesConfiguration[name].color || '#F00')\n          .style('fill', 'none');\n\n        // Set y hover guides\n        yHover = gEnter.append('g').attr('class', `y grid-hover ${name}`);\n        yHover.append('svg:line').attr('stroke-dasharray', '5,5');\n        yHover.append('text');\n\n        // Configure the d3 line.\n        line = d3.line()\n          .x(d => x(distanceExtractor(d)))\n          .y(d => y(linesConfiguration[name].zExtractor(d)))\n          .defined(d => linesConfiguration[name].zExtractor(d) !== null);\n\n\n        // Update path for the line.\n        g.select(`.line.${name}`)\n          .transition()\n          .attr('d', line);\n      }\n\n      if (xDomain[1] > 2000) {\n        xFactor = 1000;\n        xUnits = 'km';\n      } else {\n        xFactor = 1;\n        xUnits = 'm';\n      }\n\n      if (!light) {\n        xAxis.tickFormat(d => formatter.xtick(d / xFactor, xUnits));\n        if (lightXAxis) {\n          xAxis.tickValues([0, x.domain()[1]]);\n        }\n\n        yAxis.tickFormat(d => formatter.ytick(d, 'm'));\n\n        g.select('.x.axis')\n          .transition()\n          .call(xAxis);\n\n        g.select('.x.label')\n          .text(`${xAxisLabel} [${xUnits}]`)\n          .style('fill', 'grey')\n          .style('shape-rendering', 'crispEdges');\n\n        // Avoid too much lines with overlapping labels in small profiles\n        if (height / 15 < 10) {\n          yAxis.ticks(height / 15);\n        }\n\n        g.select('.y.axis')\n          .transition()\n          .call(yAxis);\n      }\n\n      g.select('.grid-y')\n        .transition()\n        .call(yAxis.tickSize(-width, 0).tickFormat(''))\n        .selectAll('.tick line')\n        .style('stroke', '#ccc')\n        .style('opacity', 0.7);\n\n      g.selectAll('.axis').selectAll('path, line')\n        .style('fill', 'none')\n        .style('stroke', '#000')\n        .style('shape-rendering', 'crispEdges');\n\n      g.select('.grid-y').select('path')\n        .style('stroke', 'none');\n\n      g.selectAll('.grid-hover line')\n        .style('stroke', '#222')\n        .style('opacity', 0.8);\n\n      g.select('.overlay')\n        .on('mouseout', mouseout)\n        .on('mousemove', mousemove);\n\n      function mousemove() {\n        const mouseX = d3.mouse(this)[0];\n        const x0 = x.invert(mouseX);\n\n        profile.highlight(x0);\n      }\n\n      function mouseout() {\n        profile.clearHighlight();\n      }\n    });\n  };\n\n  /**\n   * Remove any highlight.\n   * Fire the outCallback callback.\n   */\n  profile.clearHighlight = function() {\n    g.selectAll('.grid-hover')\n      .style('display', 'none');\n    outCallback.call(null);\n  };\n\n  /**\n   * Highlight the given distance and corresponding elevation on chart.\n   * Fire the hoverCallback callback with corresponding point.\n   * @param {number} distance Distance.\n   */\n  profile.highlight = function(distance) {\n    const data = svg.datum();\n    const i = bisectDistance(data, distance);\n    if (i >= data.length) {\n      return;\n    }\n\n    const point = data[i];\n    const dist = distanceExtractor(point);\n    let elevation;\n    const elevations = [];\n    const elevationsRef = {};\n    let lineName;\n\n    for (lineName in linesConfiguration) {\n      elevation = linesConfiguration[lineName].zExtractor(point);\n      if (Number.isFinite(elevation)) {\n        elevations.push(elevation);\n        elevationsRef[lineName] = elevation;\n        g.select(`.y.grid-hover.${lineName}`)\n          .style('display', 'inline')\n          .select('line')\n          .attr('x1', x(0))\n          .attr('y1', y(elevation))\n          .attr('x2', width)\n          .attr('y2', y(elevation));\n      } else {\n        // no data for this line: hide it\n        g.select(`.y.grid-hover.${lineName}`)\n          .style('display', 'none');\n      }\n    }\n\n    const y2 = y(Math.max.apply(null, elevations));\n    g.select('.x.grid-hover')\n      .style('display', 'inline')\n      .select('line')\n      .attr('x1', x(dist))\n      .attr('y1', height)\n      .attr('x2', x(dist))\n      .attr('y2', Number.isFinite(y2) ? y2 : 0);\n\n    const right = dist > xDomain[1] / 2;\n    let xtranslate = x(dist);\n    xtranslate += right ? -10 : 10;\n\n    g.select('.x.grid-hover text')\n      .text(formatter.xhover(dist / xFactor, xUnits))\n      .style('text-anchor', right ? 'end' : 'start')\n      .attr('transform', `translate(${xtranslate},${height - 10})`);\n\n    const yUnits = 'm';\n    // Display altitude on guides only if there is one line.\n    if (numberOfLines === 1) {\n      const text = elevations[0] === null ? 'no value' : formatter.yhover(elevations[0], 'm');\n      g.select('.y.grid-hover text')\n        .text(text)\n        .style('text-anchor', right ? 'end' : 'start')\n        .attr('transform', `translate(${xtranslate},${y(elevations[0]) - 10})`);\n    }\n    hoverCallback.call(null, point, dist / xFactor, xUnits, elevationsRef, yUnits);\n  };\n\n\n  profile.showPois = function(pois) {\n    pois = pois !== undefined ? pois : [];\n    googAsserts.assert(pois.length === 0 || poiExtractor !== undefined);\n\n    const pe = poiExtractor;\n    const g = svg.select('g');\n    const profileData = svg.datum();\n    const ps = g.select('.pois');\n\n    const p = ps.selectAll('.poi').data(pois, (d) => {\n      const i = bisectDistance(profileData, Math.round(pe.dist(d) * 10) / 10, 1);\n      const point = profileData[i];\n      if (point) {\n        let lineName;\n        const elevations = [];\n        for (lineName in linesConfiguration) {\n          elevations.push(linesConfiguration[lineName].zExtractor(point));\n        }\n        const z = Math.max.apply(null, elevations);\n        pe.z(d, z);\n      }\n      return pe.id(d);\n    });\n\n    const poiEnterG = p.enter()\n      .append('g')\n      .attr('class', 'poi');\n\n    poiEnterG.append('text')\n      .attr('x', light ? 0 : 9)\n      .attr('dy', '.35em')\n      .attr('text-anchor', light ? 'middle' : 'start');\n\n    poiEnterG.append('line')\n      .style('shape-rendering', 'crispEdges');\n\n    poiEnterG.style('opacity', 0)\n      .transition()\n      .duration(1000)\n      .delay(100)\n      .style('opacity', 1);\n\n    poiEnterG.selectAll('text')\n      .attr('transform', (d) => {\n        if (light) {\n          return [`translate(${x(pe.dist(d))},${y(pe.z(d)) - 10})`];\n        } else {\n          return [`translate(${x(pe.dist(d))},${y(pe.z(d)) - 20}) rotate(${poiLabelAngle})`];\n        }\n      })\n      .text(d => pe.sort(d) + (light ? '' : (` - ${pe.title(d)}`)));\n\n    poiEnterG.selectAll('line')\n      .style('stroke', 'grey')\n      .attr('x1', d => x(pe.dist(d)))\n      .attr('y1', d => y(y.domain()[0]))\n      .attr('x2', d => x(pe.dist(d)))\n      .attr('y2', d => y(pe.z(d)));\n\n    // remove unused pois\n    poiEnterG.exit().remove();\n  };\n\n  function clearPois() {\n    profile.showPois([]);\n  }\n\n\n  return profile;\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.profile.elevationComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olEvents from 'ol/events.js';\nimport * as olObj from 'ol/obj.js';\nimport ngeoMiscDebounce from 'ngeo/misc/debounce.js';\nimport ngeoProfileD3Elevation from 'ngeo/profile/d3Elevation.js';\n\nimport {select} from 'd3-selection';\nconst d3 = {\n  select,\n};\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoProfile', [\n  ngeoMiscDebounce.name\n]);\n\n\n/**\n * Provides a directive used to insert an elevation profile chart\n * in the DOM.\n *\n * Example:\n *\n *      <div ngeo-profile=\"ctrl.profileData\"\n *        ngeo-profile-options=\"ctrl.profileOptions\"\n *        ngeo-profile-pois=\"ctrl.profilePois\">\n *      </div>\n *\n * Where \"ctrl.profileOptions\" is of type {@link ngeox.profile.ProfileOptions};\n * \"ctrl.profileData\" and \"ctrl.profilePois\" are arrays which will be\n * processed by {@link ngeox.profile.ElevationExtractor} and\n * {@link ngeox.profile.PoiExtractor}.\n *\n * See our live example: [../examples/profile.html](../examples/profile.html)\n *\n * @htmlAttribute {?Object} ngeo-profile The profile data.\n * @htmlAttribute {ngeox.profile.ProfileOptions} ngeo-profile-options The options.\n * @htmlAttribute {?Array} ngeo-profile-pois The data for POIs.\n * @htmlAttribute {*} ngeo-profile-highlight Any property on the scope which\n * evaluated value may correspond to distance from origin.\n * @param {ngeox.miscDebounce} ngeoDebounce ngeo Debounce factory.\n * @return {angular.Directive} Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoProfile\n */\nexports.directive_ = function(ngeoDebounce) {\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n\n      const optionsAttr = attrs['ngeoProfileOptions'];\n      googAsserts.assert(optionsAttr !== undefined);\n\n      const selection = d3.select(element[0]);\n      let profile, elevationData, poiData;\n\n      scope.$watchCollection(optionsAttr, (newVal) => {\n\n        const options = /** @type {ngeox.profile.ProfileOptions} */\n                (olObj.assign({}, newVal));\n\n        if (options !== undefined) {\n\n          // proxy the hoverCallback and outCallbackin order to be able to\n          // call $applyAsync\n          //\n          // We're using $applyAsync here because the callback may be\n          // called inside the Angular context. For example, it's the case\n          // when the user hover's the line geometry on the map and the\n          // profileHighlight property is changed.\n          //\n          // For that reason we use $applyAsync instead of $apply here.\n          if (options.hoverCallback !== undefined) {\n            const origHoverCallback = options.hoverCallback;\n            options.hoverCallback = function(...args) {\n              origHoverCallback(...args);\n              scope.$applyAsync();\n            };\n          }\n\n          if (options.outCallback !== undefined) {\n            const origOutCallback = options.outCallback;\n            options.outCallback = function() {\n              origOutCallback();\n              scope.$applyAsync();\n            };\n          }\n\n          profile = ngeoProfileD3Elevation(options);\n          refreshData();\n        }\n      });\n\n      scope.$watch(attrs['ngeoProfile'], (newVal, oldVal) => {\n        elevationData = newVal;\n        refreshData();\n      });\n\n      scope.$watch(attrs['ngeoProfilePois'], (newVal, oldVal) => {\n        poiData = newVal;\n        refreshData();\n      });\n\n      scope.$watch(attrs['ngeoProfileHighlight'],\n        (newVal, oldVal) => {\n          if (newVal === undefined) {\n            return;\n          }\n          if (newVal > 0) {\n            profile.highlight(newVal);\n          } else {\n            profile.clearHighlight();\n          }\n        });\n\n      olEvents.listen(window, 'resize', ngeoDebounce(refreshData, 50, true));\n\n      function refreshData() {\n        if (profile !== undefined) {\n          selection.datum(elevationData).call(profile);\n          if (elevationData !== undefined) {\n            profile.showPois(poiData);\n          }\n        }\n      }\n    }\n  };\n};\n\nexports.directive('ngeoProfile', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module gmf.profile.component\n */\nimport googAsserts from 'goog/asserts.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport olOverlay from 'ol/Overlay.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport * as olObj from 'ol/obj.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\n/** @suppress {extraRequire} */\nimport ngeoDownloadCsv from 'ngeo/download/Csv.js';\n\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\n\n/** @suppress {extraRequire} */\nimport ngeoProfileElevationComponent from 'ngeo/profile/elevationComponent.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfProfile', [\n  ngeoDownloadCsv.module.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoProfileElevationComponent.name,\n]);\n\n\nexports.value('gmfProfileTemplateUrl',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template.\n   */\n  ($element, $attrs) => {\n    const templateUrl = $attrs['gmfProfileTemplateurl'];\n    return templateUrl !== undefined ? templateUrl : 'gmf/profile';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/profile', require('./component.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfProfileTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfProfileTemplateUrl($element, $attrs, gmfProfileTemplateUrl) {\n  return gmfProfileTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provide a component that display a profile panel. This profile use the given\n * LineString geometry to request the c2cgeoportal profile.json service. The\n * raster used in the request are the keys of the 'linesconfiguration' object.\n * The 'map' attribute is optional and are only used to display on the map the\n * information that concern the hovered point (in the profile and on the map)\n * of the line.\n * This profile relies on the ngeo.profile (d3) and ngeo.ProfileComponent.\n *\n * Example:\n *\n *      <gmf-profile\n *        gmf-profile-active=\"ctrl.profileActive\"\n *        gmf-profile-line=\"ctrl.profileLine\"\n *        gmf-profile-map=\"::ctrl.map\"\n *        gmf-profile-linesconfiguration=\"::ctrl.profileLinesconfiguration\">\n *      </gmf-profile>\n *\n *\n * @htmlAttribute {boolean} gmf-profile-active Active the component.\n * @htmlAttribute {ol.geom.LineString} gmf-profile-line The linestring geometry\n *     to use to draw the profile.\n * @htmlAttribute {ol.Map?} gmf-profile-map An optional map.\n * @htmlAttribute {Object.<string, gmfx.ProfileLineConfiguration>}\n *     gmf-profile-linesconfiguration The configuration of the lines. Each keys\n *     will be used to request elevation layers.\n * @htmlAttribute {ol.style.Style?} gmf-profile-hoverpointstyle Optional style\n *     for the 'on Hover' point on the line.\n * @htmlAttribute {number?} gmf-profile-numberofpoints Optional maximum limit of\n *     points to request. Default to 100.\n * @htmlAttribute {Object.<string, *>?} gmf-profile-options Optional options\n *     object like {@link ngeox.profile.ProfileOptions} but without any\n *     mandatory value. Will be passed to the ngeo profile component. Providing\n *     'linesConfiguration', 'distanceExtractor', hoverCallback, outCallback\n *     or i18n will override native gmf profile values.\n *\n * @ngdoc component\n * @ngname gmfProfile\n */\nexports.component_ = {\n  controller: 'GmfProfileController as ctrl',\n  bindings: {\n    'active': '=gmfProfileActive',\n    'line': '=gmfProfileLine',\n    'getMapFn': '&?gmfProfileMap',\n    'getLinesConfigurationFn': '&gmfProfileLinesconfiguration',\n    'getHoverPointStyleFn': '&?gmfProfileHoverpointstyle',\n    'getNbPointsFn': '&?gmfProfileNumberofpoints',\n    'getOptionsFn': '&?gmfProfileOptions'\n  },\n  templateUrl: gmfProfileTemplateUrl\n};\n\nexports.component('gmfProfile', exports.component_);\n\n\n/**\n * @param {angular.Scope} $scope Angular scope.\n * @param {angular.$http} $http Angular http service.\n * @param {angular.JQLite} $element Element.\n * @param {angular.$filter} $filter Angular filter\n * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr Feature overlay\n *     manager.\n * @param {string} gmfProfileJsonUrl URL of GMF service JSON profile.\n * @param {ngeo.download.Csv} ngeoCsvDownload CSV Download service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfProfileController\n */\nexports.Controller_ = function($scope, $http, $element, $filter,\n  gettextCatalog, ngeoFeatureOverlayMgr, gmfProfileJsonUrl,\n  ngeoCsvDownload) {\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.$scope_ = $scope;\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.$http_ = $http;\n\n  /**\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.$element_ = $element;\n\n  /**\n   * @type {angular.$filter}\n   * @export\n   */\n  this.$filter_ = $filter;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {ngeo.map.FeatureOverlay}\n   * @private\n   */\n  this.pointHoverOverlay_ = ngeoFeatureOverlayMgr.getFeatureOverlay();\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.gmfProfileJsonUrl_ = gmfProfileJsonUrl;\n\n  /**\n   * @type {ngeo.download.Csv}\n   * @private\n   */\n  this.ngeoCsvDownload_ = ngeoCsvDownload;\n\n  /**\n   * @type {ol.Map}\n   * @private\n   */\n  this.map_ = null;\n\n  /**\n   * @type {?Object<string, !gmfx.ProfileLineConfiguration>}\n   * @private\n   */\n  this.linesConfiguration_ = null;\n\n  /**\n   * @type {!Array.<string>}\n   * @private\n   */\n  this.layersNames_ = [];\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.nbPoints_ = 100;\n\n  /**\n   * @type {ol.geom.LineString}\n   * @export\n   */\n  this.line;\n\n  /**\n   * @type {Array.<Object>}\n   * @export\n   */\n  this.profileData = [];\n\n  /**\n   * @type {gmfx.ProfileHoverPointInformations}\n   * @export\n   */\n  this.currentPoint = {\n    coordinate: undefined,\n    distance: undefined,\n    elevations: {},\n    xUnits: undefined,\n    yUnits: undefined\n  };\n\n  /**\n   * Distance to highlight on the profile. (Property used in ngeo.Profile.)\n   * @type {number}\n   * @export\n   */\n  this.profileHighlight = -1;\n\n  /**\n   * Overlay to show the measurement.\n   * @type {ol.Overlay}\n   * @private\n   */\n  this.measureTooltip_ = null;\n\n  /**\n   * The measure tooltip element.\n   * @type {Element}\n   * @private\n   */\n  this.measureTooltipElement_ = null;\n\n  /**\n   * @type {ol.Feature}\n   * @private\n   */\n  this.snappedPoint_ = new olFeature();\n  this.pointHoverOverlay_.addFeature(this.snappedPoint_);\n\n  /**\n   * @type {ngeox.profile.I18n}\n   * @private\n   */\n  this.profileLabels_ = {\n    xAxis: gettextCatalog.getString('Distance'),\n    yAxis: gettextCatalog.getString('Elevation')\n  };\n\n\n  /**\n   * @type {?ngeox.profile.ProfileOptions}\n   * @export\n   */\n  this.profileOptions = null;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active = false;\n\n  /**\n   * @type {ol.EventsKey}\n   * @private\n   */\n  this.pointerMoveKey_;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.isErrored = false;\n\n\n  // Watch the active value to activate/deactive events listening.\n  $scope.$watch(\n    () => this.active,\n    (newValue, oldValue) => {\n      if (oldValue !== newValue) {\n        this.updateEventsListening_();\n      }\n    });\n\n  // Watch the line to update the profileData (data for the chart).\n  $scope.$watch(\n    () => this.line,\n    (newLine, oldLine) => {\n      if (oldLine !== newLine) {\n        this.update_();\n      }\n    });\n\n  this.updateEventsListening_();\n};\n\n\n/**\n * Init the controller\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.map_ = this['getMapFn'] ? this['getMapFn']() : null;\n  this.nbPoints_ = this['getNbPointsFn'] ? this['getNbPointsFn']() : 100;\n\n  let hoverPointStyle;\n  const hoverPointStyleFn = this['getHoverPointStyleFn'];\n  if (hoverPointStyleFn) {\n    hoverPointStyle = hoverPointStyleFn();\n    googAsserts.assertInstanceof(hoverPointStyle, olStyleStyle);\n  } else {\n    hoverPointStyle = new olStyleStyle({\n      image: new olStyleCircle({\n        fill: new olStyleFill({color: '#ffffff'}),\n        radius: 3\n      })\n    });\n  }\n  this.pointHoverOverlay_.setStyle(hoverPointStyle);\n\n  const linesConfiguration = this['getLinesConfigurationFn']();\n  googAsserts.assertInstanceof(linesConfiguration, Object);\n\n  this.linesConfiguration_ = linesConfiguration;\n\n  for (const name in this.linesConfiguration_) {\n    // Keep an array of all layer names.\n    this.layersNames_.push(name);\n    // Add generic zExtractor to lineConfiguration object that doesn't have one.\n    const lineConfig = this.linesConfiguration_[name];\n    if (!lineConfig.zExtractor) {\n      this.linesConfiguration_[name].zExtractor = this.getZFactory_(name);\n    }\n  }\n\n  this.profileOptions = /** @type {ngeox.profile.ProfileOptions} */ ({\n    linesConfiguration: this.linesConfiguration_,\n    distanceExtractor: this.getDist_,\n    hoverCallback: this.hoverCallback_.bind(this),\n    outCallback: this.outCallback_.bind(this),\n    i18n: this.profileLabels_\n  });\n\n  const optionsFn = this['getOptionsFn'];\n  if (optionsFn) {\n    const options = optionsFn();\n    googAsserts.assertObject(options);\n    olObj.assign(this.profileOptions, options);\n  }\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.update_ = function() {\n  this.isErrored = false;\n  if (this.line) {\n    this.getJsonProfile_();\n  } else {\n    this.profileData = [];\n  }\n  this.active = !!this.line;\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.updateEventsListening_ = function() {\n  if (this.active && this.map_ !== null) {\n    this.pointerMoveKey_ = olEvents.listen(this.map_, 'pointermove',\n      this.onPointerMove_.bind(this));\n  } else {\n    olEvents.unlistenByKey(this.pointerMoveKey_);\n  }\n};\n\n\n/**\n * @param {ol.MapBrowserPointerEvent} e An ol map browser pointer event.\n * @private\n */\nexports.Controller_.prototype.onPointerMove_ = function(e) {\n  if (e.dragging || !this.line) {\n    return;\n  }\n  const coordinate = this.map_.getEventCoordinate(e.originalEvent);\n  const closestPoint = this.line.getClosestPoint(coordinate);\n  // compute distance to line in pixels\n  const eventToLine = new olGeomLineString([closestPoint, coordinate]);\n  const pixelDist = eventToLine.getLength() / this.map_.getView().getResolution();\n\n  if (pixelDist < 16) {\n    this.profileHighlight = this.getDistanceOnALine_(closestPoint, this.line);\n  } else {\n    this.profileHighlight = -1;\n  }\n  this.$scope_.$apply();\n};\n\n\n/**\n * Return the distance between the beginning of the line and the given point.\n * The point must be on the line. If not, this function will return the total\n * length of the line.\n * @param {ol.Coordinate} pointOnLine A point on the given line.\n * @param {ol.geom.LineString} line A line.\n * @return {number} A distance.\n * @private\n */\nexports.Controller_.prototype.getDistanceOnALine_ = function(pointOnLine,\n  line) {\n  let segment;\n  let distOnLine = 0;\n  const fakeExtent = [\n    pointOnLine[0] - 0.5,\n    pointOnLine[1] - 0.5,\n    pointOnLine[0] + 0.5,\n    pointOnLine[1] + 0.5\n  ];\n  this.line.forEachSegment((firstPoint, lastPoint) => {\n    segment = new olGeomLineString([firstPoint, lastPoint]);\n    // Is the pointOnLine on this swegement ?\n    if (segment.intersectsExtent(fakeExtent)) {\n      // If the closestPoint is on the line, add the distance between the first\n      // point of this segment and the pointOnLine.\n      segment.setCoordinates([firstPoint, pointOnLine]);\n      return distOnLine += segment.getLength(); // Assign value and break;\n    } else {\n      // Do the sum of the length of each eventual previous segment.\n      distOnLine += segment.getLength();\n    }\n  });\n  return distOnLine;\n};\n\n\n/**\n * @param {Object} point Point.\n * @param {number} dist distance on the line.\n * @param {string} xUnits X units label.\n * @param {Object.<string, number>} elevationsRef Elevations references.\n *  @param {string} yUnits Y units label.\n * @private\n */\nexports.Controller_.prototype.hoverCallback_ = function(point, dist, xUnits, elevationsRef, yUnits) {\n  // Update information point.\n  const coordinate = [point.x, point.y];\n\n  this.currentPoint.elevations = elevationsRef;\n  this.currentPoint.distance = dist;\n  this.currentPoint.xUnits = xUnits;\n  this.currentPoint.yUnits = yUnits;\n  this.currentPoint.coordinate = coordinate;\n\n  // Update hover.\n  const geom = new olGeomPoint(coordinate);\n  this.createMeasureTooltip_();\n  this.measureTooltipElement_.innerHTML = this.getTooltipHTML_();\n  this.measureTooltip_.setPosition(coordinate);\n  this.snappedPoint_.setGeometry(geom);\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.outCallback_ = function() {\n  // Reset information point.\n  this.currentPoint.coordinate = undefined;\n  this.currentPoint.distance = undefined;\n  this.currentPoint.elevations = {};\n  this.currentPoint.xUnits = undefined;\n  this.currentPoint.yUnits = undefined;\n\n  // Reset hover.\n  this.removeMeasureTooltip_();\n  this.snappedPoint_.setGeometry(null);\n};\n\n\n/**\n * @return {string} A text formatted to a tooltip.\n * @private\n */\nexports.Controller_.prototype.getTooltipHTML_ = function() {\n  const gettextCatalog = this.gettextCatalog_;\n  const separator = '&nbsp;: ';\n  let elevationName, translatedElevationName;\n  const innerHTML = [];\n  const number = this.$filter_('number');\n  const DistDecimal = this.currentPoint.xUnits === 'm' ? 0 : 2;\n  const value = number(this.currentPoint.distance, DistDecimal);\n  innerHTML.push(`${this.profileLabels_.xAxis} ${separator} ${value}&nbsp;${this.currentPoint.xUnits}`);\n  for (elevationName in this.currentPoint.elevations) {\n    translatedElevationName = gettextCatalog.getString(elevationName);\n    const int_value = this.currentPoint.elevations[elevationName];\n    const value = int_value === null ?\n      gettextCatalog.getString('no value') :\n      `${number(int_value, 0)}&nbsp;${this.currentPoint.yUnits}`;\n    innerHTML.push(`${translatedElevationName} ${separator} ${value}`);\n  }\n  return innerHTML.join('</br>');\n};\n\n\n/**\n * Creates a new 'hover' tooltip\n * @private\n */\nexports.Controller_.prototype.createMeasureTooltip_ = function() {\n  this.removeMeasureTooltip_();\n  this.measureTooltipElement_ = document.createElement('div');\n  this.measureTooltipElement_.className += 'tooltip ngeo-tooltip-measure';\n  this.measureTooltip_ = new olOverlay({\n    element: this.measureTooltipElement_,\n    offset: [0, -15],\n    positioning: 'bottom-center'\n  });\n  this.map_.addOverlay(this.measureTooltip_);\n};\n\n\n/**\n * Destroy the 'hover' tooltip\n * @private\n */\nexports.Controller_.prototype.removeMeasureTooltip_ = function() {\n  if (this.measureTooltipElement_ !== null) {\n    this.measureTooltipElement_.parentNode.removeChild(this.measureTooltipElement_);\n    this.measureTooltipElement_ = null;\n    this.map_.removeOverlay(this.measureTooltip_);\n  }\n};\n\n\n/**\n * Return the styler value of a gmfx.ProfileLineConfiguration.\n * @param {string} layerName name of the elevation layer.\n * @return {object} The object representation of the style.\n * @export\n */\nexports.Controller_.prototype.getStyle = function(layerName) {\n  const lineConfiguration = this.linesConfiguration_[layerName];\n  if (!lineConfiguration) {\n    return {};\n  }\n  return {\n    'color': lineConfiguration.color || '#F00'\n  };\n};\n\n\n/**\n * Return a copy of the existing layer names.\n * @return {Array.<string>} The names of layers.\n * @export\n */\nexports.Controller_.prototype.getLayersNames = function() {\n  return this.layersNames_.slice(0);\n};\n\n\n/**\n * @param {string} layerName name of the elevation layer.\n * @return {function(Object):number} Z extractor function.\n * @private\n */\nexports.Controller_.prototype.getZFactory_ = function(layerName) {\n  /**\n   * Generic GMF extractor for the 'given' value in 'values' in profileData.\n   * @param {Object} item The item.\n   * @return {number} The elevation.\n   * @private\n   */\n  const getZFn = function(item) {\n    if ('values' in item && layerName in item['values'] && item['values'][layerName]) {\n      return parseFloat(item['values'][layerName]);\n    }\n    return null;\n  };\n  return getZFn;\n};\n\n\n/**\n * Extractor for the 'dist' value in profileData.\n * @param {Object} item The item.\n * @return {number} The distance.\n * @private\n */\nexports.Controller_.prototype.getDist_ = function(item) {\n  if ('dist' in item) {\n    return item['dist'];\n  }\n  return 0;\n};\n\n\n/**\n * Request the profile.\n * @private\n */\nexports.Controller_.prototype.getJsonProfile_ = function() {\n  const geom = {\n    'type': 'LineString',\n    'coordinates': this.line.getCoordinates()\n  };\n\n  const params = {\n    'layers': this.layersNames_.join(','),\n    'geom': JSON.stringify(geom),\n    'nbPoints': this.nbPoints_\n  };\n\n  /** @type {Function} */ (this.$http_)({\n    url: this.gmfProfileJsonUrl_,\n    method: 'POST',\n    params: params,\n    paramSerializer: '$httpParamSerializerJQLike',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded'\n    }\n  }).then(\n    this.getProfileDataSuccess_.bind(this),\n    this.getProfileDataError_.bind(this)\n  );\n};\n\n\n/**\n * @param {!angular.$http.Response} resp Response.\n * @private\n */\nexports.Controller_.prototype.getProfileDataSuccess_ = function(resp) {\n  const profileData = resp.data['profile'];\n  if (profileData instanceof Array) {\n    this.profileData = profileData;\n  }\n};\n\n\n/**\n * @param {!angular.$http.Response} resp Response.\n * @private\n */\nexports.Controller_.prototype.getProfileDataError_ = function(resp) {\n  this.isErrored = true;\n  console.error('Can not get JSON profile.');\n};\n\n\n/**\n * Request the csv profile with the current profile data.\n * @export\n */\nexports.Controller_.prototype.downloadCsv = function() {\n  if (this.profileData.length === 0) {\n    return;\n  }\n\n  /** @type {Array.<ngeox.GridColumnDef>} */\n  const headers = [];\n  let hasDistance = false;\n  const firstPoint = this.profileData[0];\n  if ('dist' in firstPoint) {\n    headers.push({name: 'distance'});\n    hasDistance = true;\n  }\n  const layers = [];\n  for (const layer in firstPoint['values']) {\n    headers.push({'name': layer});\n    layers.push(layer);\n  }\n  headers.push({name: 'x'});\n  headers.push({name: 'y'});\n\n  const rows = this.profileData.map((point) => {\n    const row = {};\n    if (hasDistance) {\n      row['distance'] = point['dist'];\n    }\n\n    layers.forEach((layer) => {\n      row[layer] = point['values'][layer];\n    });\n\n    row['x'] = point['x'];\n    row['y'] = point['y'];\n\n    return row;\n  });\n\n  this.ngeoCsvDownload_.startDownload(rows, headers, 'profile.csv');\n};\n\n\nexports.controller('GmfProfileController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.profile.drawLineComponent\n */\nimport googAsserts from 'goog/asserts.js';\nimport olCollection from 'ol/Collection.js';\nimport olInteractionDraw from 'ol/interaction/Draw.js';\nimport olMap from 'ol/Map.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfDrawProfileLine', [\n  ngeoMapFeatureOverlayMgr.module.name,\n]);\n\n\n/**\n * Simple directive that can be put on any element. The directive listen on\n * clicks events to allow/disallow to draw one line (and only one) on the\n * map. Typically used to draw the line that will serve the gmf.Profile.\n *\n * Example:\n *\n *      <gmf-drawprofileline\n *        gmf-drawprofileline-active=\"mainCtrl.drawProfileActive\"\n *        gmf-drawprofileline-map=\"mainCtrl.map\"\n *        gmf-drawprofileline-line=\"mainCtrl.line\"\n *      </gmf-drawprofileline>\n *\n *\n * @htmlAttribute {ol.Map} gmf-drawprofileline-map The map.\n * @htmlAttribute {ol.geom.LineString} gmf-drawprofileline-line The variable to\n *     connect with the drawed line.\n * @htmlAttribute {boolean=} gmf-drawprofileline-active Active the component.\n * @htmlAttribute {ol.style.Style=} gmf-drawprofileline-style Optional style\n *     for the drawed line.\n * @return {angular.Directive} Directive Definition Object.\n * @ngdoc directive\n * @ngname gmfDrawprofileline\n */\nexports.directive_ = function() {\n  return {\n    scope: true,\n    controller: 'GmfDrawprofilelineController as ctrl',\n    restrict: 'A',\n    bindToController: {\n      'getMapFn': '&gmfDrawprofilelineMap',\n      'line': '=gmfDrawprofilelineLine',\n      'active': '=gmfDrawprofilelineActive',\n      'getStyleFn': '&?gmfDrawprofilelineStyle'\n    }\n  };\n};\n\n\nexports.directive('gmfDrawprofileline',\n  exports.directive_);\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr Feature overlay\n *     manager.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname gmfDrawprofilelineController\n */\nexports.Controller_ = function($scope, $element, $timeout,\n  ngeoFeatureOverlayMgr) {\n\n  /**\n   * @type {?ol.geom.LineString}\n   * @export\n   */\n  this.line;\n\n  /**\n   * @type {?ol.Map}\n   * @private\n   */\n  this.map_ = null;\n\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.features_ = new olCollection();\n\n  const overlay = ngeoFeatureOverlayMgr.getFeatureOverlay();\n  overlay.setFeatures(this.features_);\n\n  let style;\n  const styleFn = this['getStyleFn'];\n  if (styleFn) {\n    style = styleFn();\n    googAsserts.assertInstanceof(style, olStyleStyle);\n  } else {\n    style = new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: '#ffcc33',\n        width: 2\n      })\n    });\n  }\n  overlay.setStyle(style);\n\n  /**\n   * @type {!ol.interaction.Draw}\n   * @export\n   */\n  this.interaction = new olInteractionDraw({\n    type: /** @type {ol.geom.GeometryType} */ ('LineString'),\n    features: this.features_\n  });\n\n  ngeoMiscDecorate.interaction(this.interaction);\n\n  // Clear the line as soon as the interaction is activated.\n  this.interaction.on('change:active', () => {\n    if (this.interaction.getActive()) {\n      this.clear_();\n    }\n  });\n\n  // Update the profile with the new geometry.\n  this.interaction.on('drawend', (event) => {\n    this.line = event.feature.getGeometry();\n    // using timeout to prevent double click to zoom the map\n    $timeout(() => {\n      this.interaction.setActive(false);\n    }, 0);\n  });\n\n  // Line may be removed from an other component\n  // for example closing the chart panel\n  $scope.$watch(\n    () => this.line,\n    (newLine, oldLine) => {\n      if (newLine === null) {\n        this.clear_();\n      }\n    });\n\n  $scope.$watch(\n    () => this.active,\n    (newValue) => {\n      if (newValue === false) {\n        this.clear_();\n      }\n      // Will activate the interaction automatically the first time\n      this.interaction.setActive(this.active);\n    }\n  );\n};\n\n\n/**\n * Initialise the controller.\n */\nexports.Controller_.prototype.$onInit = function() {\n  const map = this['getMapFn']();\n  googAsserts.assertInstanceof(map, olMap);\n  this.map_ = map;\n  this.map_.addInteraction(this.interaction);\n};\n\n\n/**\n * Clear the overlay and profile line.\n * @private\n */\nexports.Controller_.prototype.clear_ = function() {\n  this.features_.clear();\n  this.line = null;\n};\n\n\nexports.controller('GmfDrawprofilelineController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module gmf.profile.module\n */\nimport gmfProfileComponent from 'gmf/profile/component.js';\nimport gmfProfileDrawLineComponent from 'gmf/profile/drawLineComponent.js';\n\nimport './profile.less';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfProfileModule', [\n  gmfProfileComponent.name,\n  gmfProfileDrawLineComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.query.bboxQueryComponent\n */\n/** @suppress {extraRequire} */\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\n\nimport olInteractionDragBox from 'ol/interaction/DragBox.js';\nimport * as olEventsCondition from 'ol/events/condition.js';\n\nconst exports = angular.module('ngeoBboxQuery', [\n  ngeoQueryMapQuerent.module.name,\n]);\n\n\n/**\n * Provides a \"bbox query\" directive.\n *\n * This directive is responsible of binding a map and the ngeo query service\n * together. While active, drawing a bbox while CTRL or the 'meta' key is pressed\n * issues a request to the query service.\n *\n * This directive doesn't require to be rendered in a visible DOM element, but\n * it could be used with a ngeo-btn to manage the activation of the directive.\n * See below an example without any use of UI:\n *\n * Example:\n *\n *      <span\n *        ngeo-bbox-query=\"\"\n *        ngeo-bbox-query-map=\"::ctrl.map\"\n *        ngeo-bbox-query-limit=\"50\"\n *        ngeo-bbox-query-active=\"ctrl.queryActive\">\n *        ngeo-bbox-query-autoclear=\"ctrl.queryAutoClear\">\n *      </span>\n *\n * See the live example: [../examples/bboxquery.html](../examples/bboxquery.html)\n *\n * @param {ngeo.query.MapQuerent} ngeoMapQuerent The ngeo map querent service.\n * @return {angular.Directive} The Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoBboxQuery\n */\nexports.directive_ = function(ngeoMapQuerent) {\n  return {\n    restrict: 'A',\n    scope: false,\n    link: (scope, elem, attrs) => {\n      /**\n       * @type {ol.Map}\n       */\n      const map = scope.$eval(attrs['ngeoBboxQueryMap']);\n\n      const interaction = new olInteractionDragBox({\n        condition: olEventsCondition.platformModifierKeyOnly\n      });\n\n      /**\n       * Called when a bbox is drawn while this controller is active. Issue\n       * a request to the query service using the extent that was drawn.\n       * @param {ol.interaction.DragBox.Event} evt Event.\n       */\n      const handleBoxEnd = function(evt) {\n        const extent = interaction.getGeometry().getExtent();\n        ngeoMapQuerent.issue({\n          limit: scope.$eval(attrs['ngeoBboxQueryLimit']),\n          extent: extent,\n          map: map\n        });\n      };\n      interaction.on('boxend', handleBoxEnd);\n\n      // watch 'active' property -> activate/deactivate accordingly\n      scope.$watch(attrs['ngeoBboxQueryActive'],\n        (newVal, oldVal) => {\n          if (newVal) {\n            // activate\n            map.addInteraction(interaction);\n          } else {\n            // deactivate\n            map.removeInteraction(interaction);\n            if (scope.$eval(attrs['ngeoBboxQueryAutoclear']) !== false) {\n              ngeoMapQuerent.clear();\n            }\n          }\n        }\n      );\n    }\n  };\n};\n\nexports.directive('ngeoBboxQuery', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module gmf.raster.component\n */\nimport gmfRasterRasterService from 'gmf/raster/RasterService.js';\nimport googAsserts from 'goog/asserts.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscDebounce from 'ngeo/misc/debounce.js';\n\nimport * as olEvents from 'ol/events.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfRasterComponent', [\n  gmfRasterRasterService.module.name,\n  ngeoMiscDebounce.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/raster/widgetComponent', require('./widgetComponent.html'));\n});\n\n\nexports.value('gmfElevationwidgetTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['gmfElevationwidgetTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/raster/widgetComponent';\n  });\n\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} gmfElevationwidgetTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfElevationwidgetTemplateUrl($attrs, gmfElevationwidgetTemplateUrl) {\n  return gmfElevationwidgetTemplateUrl($attrs);\n}\n\n\n/**\n * Provide a directive that set a value each 500ms with the elevation under the\n * mouse cursor position on the map. The value must come from the elevation\n * service of a c2cgeoportal server. The server's URL must be defined as\n * config value of the application.\n *\n * Example:\n *\n *      <span gmf-elevation\n *            gmf-elevation-active=\"elevationActive\"\n *            gmf-elevation-elevation=\"elevationValue\"\n *            gmf-elevation-layer=\"mainCtrl.elevationLayer\"\n *            gmf-elevation-layersconfig=\"::mainCtrl.elevationLayersConfig\"\n *            gmf-elevation-map=\"::mainCtrl.map\">\n *            {{elevationValue}}\n *      </span>\n *\n *  For value in meter `elevationLayersConfig` can be an empty object, complex example:\n *\n *      elevationLayersConfig = {\n *          '<layer>': {\n *              'filter': 'ngeoUnitPrefix',\n *              'args': ['m²', 'square'],\n *              'postfix': '<notice>',\n *              'separator': ''\n *          }\n *      };\n *\n *\n * @htmlAttribute {boolean} gmf-elevation-active A boolean to set active or\n *     deactive the component.\n * @htmlAttribute {number} gmf-elevation-elevation The value to set with the\n *     elevation value.\n * @htmlAttribute {string} gmf-elevation-layer Elevation layer to use.\n * @htmlAttribute {Object.<string, gmf.raster.component.LayerConfig>} gmf-elevation-layersconfig Elevation layer configurations.\n * @htmlAttribute {ol.Map} gmf-elevation-map The map.\n * @return {angular.Directive} Directive Definition Object.\n * @ngdoc directive\n * @ngname gmfElevation\n */\nexports.component_ = function() {\n  return {\n    restrict: 'A',\n    controller: 'GmfElevationController as ctrl',\n    bindToController: true,\n    scope: {\n      'active': '<gmfElevationActive',\n      'elevation': '=gmfElevationElevation',\n      'layersconfig': '=gmfElevationLayersconfig',\n      'loading': '=?gmfElevationLoading',\n      'layer': '<gmfElevationLayer',\n      'map': '=gmfElevationMap'\n    },\n    link: (scope, element, attr) => {\n      const ctrl = scope['ctrl'];\n\n      // Watch active or not.\n      scope.$watch(() => ctrl.active, function(active) {\n        this.toggleActive_(active);\n      }.bind(ctrl));\n\n      // Watch current layer.\n      scope.$watch(() => ctrl.layer, function(layer) {\n        this.layer = layer;\n        this.elevation = null;\n      }.bind(ctrl));\n    }\n  };\n};\n\n\nexports.directive('gmfElevation', exports.component_);\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @param {!angular.$filter} $filter Angular filter.\n * @param {!ngeox.miscDebounce} ngeoDebounce Ngeo debounce factory\n * @param {!gmf.raster.RasterService} gmfRaster Gmf Raster service\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname gmfElevationController\n */\nexports.Controller_ = function($scope, $filter, ngeoDebounce, gmfRaster, gettextCatalog) {\n\n  /**\n   * @type {!angular.$filter}\n   * @private\n   */\n  this.filter_ = $filter;\n\n  /**\n   * @type {ngeox.miscDebounce}\n   * @private\n   */\n  this.ngeoDebounce_ = ngeoDebounce;\n\n  /**\n   * @type {gmf.raster.RasterService}\n   * @private\n   */\n  this.gmfRaster_ = gmfRaster;\n\n  /**\n   * @type {angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog = gettextCatalog;\n\n  /**\n   * @type {!Object.<string, gmf.raster.component.LayerConfig>}\n   * @private\n   */\n  this.layersConfig;\n\n  /**\n   * @type {boolean}\n   */\n  this.active;\n\n  /**\n   * @type {!string|undefined}\n   * @export\n   */\n  this.elevation;\n\n  /**\n   * @type {string}\n   */\n  this.layer;\n\n  /**\n   * @type {ol.Map}\n   */\n  this.map;\n\n  /**\n   * @type {Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.inViewport_ = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.loading = false;\n};\n\n/**\n * Active or deactive the request of the raster each 500 ms on pointermove.\n * @param {boolean} active true to make requests.\n * @private\n */\nexports.Controller_.prototype.toggleActive_ = function(active) {\n  this.elevation = undefined;\n  if (active) {\n    googAsserts.assert(this.listenerKeys_.length === 0);\n\n    // Moving the mouse clears previously displayed elevation\n    this.listenerKeys_.push(olEvents.listen(this.map, 'pointermove',\n      function(e) {\n        this.scope_.$apply(() => {\n          this.inViewport_ = true;\n          this.elevation = undefined;\n          this.loading = false;\n        });\n      }, this));\n\n    // Launch the elevation service request when the user stops moving the\n    // mouse for less short delay\n    this.listenerKeys_.push(olEvents.listen(this.map, 'pointermove',\n      this.ngeoDebounce_(this.pointerStop_.bind(this), 500, true)\n    ));\n\n    this.listenerKeys_.push(olEvents.listen(this.map.getViewport(), 'mouseout', () => {\n      this.scope_.$apply(() => {\n        this.elevation = undefined;\n        this.inViewport_ = false;\n        this.loading = false;\n      });\n    }));\n  } else {\n    this.elevation = undefined;\n    this.listenerKeys_.forEach(olEvents.unlistenByKey);\n    this.listenerKeys_.length = 0;\n  }\n};\n\n\n/**\n * Request data from a raster from a MapBrowserPointerEvent's coordinates.\n * Called when the user stopped moving the mouse for 500ms.\n * @param {ol.MapBrowserPointerEvent} e An ol map browser pointer event.\n * @private\n */\nexports.Controller_.prototype.pointerStop_ = function(e) {\n  if (this.inViewport_) {\n    this.loading = true;\n    const params = {\n      'layers': this.layer\n    };\n    this.gmfRaster_.getRaster(e.coordinate, params).then(\n      this.getRasterSuccess_.bind(this),\n      this.getRasterError_.bind(this)\n    );\n  }\n};\n\n\n/**\n * @param {Object.<string, number>} resp Response of the get Raster service.\n * @private\n */\nexports.Controller_.prototype.getRasterSuccess_ = function(resp) {\n  googAsserts.assert(this.layer, 'A layer should be selected');\n  const value = resp[this.layer];\n  if (value !== undefined && value !== null) {\n    const options = this.layersconfig[this.layer] || {};\n    const filter = options.filter || 'number';\n    const custom_args = options.args || [];\n    const postfix = options.hasOwnProperty('postfix') ? options.postfix : 'm';\n    const separator = postfix.length > 0 ?\n      (options.hasOwnProperty('separator') ? options.separator : '\\u00a0') : '';\n    const args = Array.prototype.concat([value], custom_args);\n    this.elevation = this.filter_(filter)(...args) + separator + postfix;\n  } else {\n    const gettextCatalog = this.gettextCatalog;\n    this.elevation = gettextCatalog.getString('No value');\n  }\n  this.loading = false;\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.getRasterError_ = function() {\n  console.error('Error on getting the raster.');\n  this.elevation = undefined;\n  this.loading = false;\n};\n\n\nexports.controller('GmfElevationController', exports.Controller_);\n\n\n/**\n * Provides a component which encapsulates the elevation component (see above)\n * in a button with dropdown menu to be included in a application directly.\n *\n * Example:\n *  <gmf-elevationwidget\n *      gmf-elevationwidget-map=\"::mainCtrl.map\"\n *      gmf-elevationwidget-layers=\"::mainCtrl.elevationLayers\"\n *      gmf-elevationwidget-layersconfig=\"::mainCtrl.elevationLayersConfig\"\n *      gmf-elevationwidget-active=\"mainCtrl.showInfobar\">\n *  </gmf-elevationwidget>\n *\n * @htmlAttribute {ol.Map} gmf-elevationwidget-map The map.\n * @htmlAttribute {Array.<string>} gmf-elevationwidget-layers The list of\n *     layers.\n * @htmlAttribute {boolean} gmf-elevationwidget-active Whether to activate the\n *     elevation component.\n *\n * @ngdoc component\n * @ngname gmfElevationwidget\n */\nexports.widgetComponent_ = {\n  controller: 'gmfElevationwidgetController as ctrl',\n  bindings: {\n    'map': '<gmfElevationwidgetMap',\n    'layers': '<gmfElevationwidgetLayers',\n    'layersconfig': '=gmfElevationwidgetLayersconfig',\n    'active': '<gmfElevationwidgetActive'\n  },\n  templateUrl: gmfElevationwidgetTemplateUrl\n};\nexports.component('gmfElevationwidget', exports.widgetComponent_);\n\n\n/**\n * @constructor\n * @private\n * @ngdoc controller\n */\nexports.WidgetController_ = function() {\n  /**\n   * @type {!ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {!Array.<string>}\n   * @export\n   */\n  this.layers;\n\n  /**\n   * @type {!Object.<string, gmf.raster.component.LayerConfig>}\n   * @private\n   */\n  this.layersconfig;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.selectedElevationLayer;\n};\n\n\nexports.WidgetController_.prototype.$onInit = function() {\n  this.selectedElevationLayer = this.layers[0];\n};\n\n\nexports.controller('gmfElevationwidgetController', exports.WidgetController_);\n\n/**\n * @typedef {{\n *     filter: (string|undefined),\n *     args: (Array.<string>|undefined),\n *     postfix: (string|undefined),\n *     separator: (string|undefined)\n * }}\n */\nexports.LayerConfig;\n\nexport default exports;\n","/**\n * @module gmf.print.component\n */\nimport gmfBase from 'gmf/index.js';\n\n/** @suppress {extraRequire} */\nimport gmfAuthenticationService from 'gmf/authentication/Service.js';\n\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoPrintService from 'ngeo/print/Service.js';\nimport ngeoPrintUtils from 'ngeo/print/Utils.js';\nimport ngeoQueryMapQuerent from 'ngeo/query/MapQuerent.js';\nimport * as olArray from 'ol/array.js';\nimport * as olEvents from 'ol/events.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport olMap from 'ol/Map.js';\nimport * as olMath from 'ol/math.js';\n\nimport 'bootstrap/js/dropdown.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfPrintComponent', [\n  gmfAuthenticationService.module.name,\n  gmfThemeThemes.module.name,\n  ngeoMapLayerHelper.module.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoPrintService.module.name,\n  ngeoPrintUtils.module.name,\n  ngeoQueryMapQuerent.module.name,\n]);\n\n\nexports.value('gmfPrintTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['gmfPrintTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/print';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/print', require('./component.html'));\n});\n\n\n/**\n * @enum {string}\n * @export\n */\nexports.PrintStateEnum = {\n\n  /**\n   * @type {string}\n   * @export\n   */\n  NOT_IN_USE: 'notInUse',\n\n  /**\n   * @type {string}\n   * @export\n   */\n  PRINTING: 'printing',\n\n  /**\n   * @type {string}\n   * @export\n   */\n  ERROR_ON_REPORT: 'errorOnReport',\n\n  /**\n   * @type {string}\n   * @export\n   */\n  CAPABILITIES_NOT_LOADED: 'capabilitiesNotLoaded',\n\n  /**\n   * @type {string}\n   * @export\n   */\n  ERROR_ON_GETCAPABILITIES: 'errorOnGetCapabilities'\n};\n\n\nexports.value('gmfPrintState', {\n  'state': exports.PrintStateEnum.CAPABILITIES_NOT_LOADED\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfPrintTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfPrintTemplateUrl($element, $attrs, gmfPrintTemplateUrl) {\n  return gmfPrintTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provide a component that display a print panel. This panel is populated with\n * a form corresponding to the capabilities delivered by a GMF print v3 server.\n * If you want to use another template for your print panel, you can see the\n * available layout information in the 'gmfx.PrintLayoutInfo' classes.\n *\n * Simple example:\n *\n *      <gmf-print\n *        gmf-print-map=\"::mainCtrl.map\"\n *        gmf-print-active=\"printActive\"\n *        gmf-print-rotatemask=\"::true\">\n *      </gmf-print>\n *\n * Example with user defined attribute:\n *\n *      <gmf-print\n *        gmf-print-map=\"::mainCtrl.map\"\n *        gmf-print-active=\"printActive\"\n *        gmf-print-rotatemask=\"::true\"\n *        gmf-print-hiddenattributes=\"::['name']\"\n *        gmf-print-attributes-out=\"::attributes\">\n *        <div ng-repeat=\"attribute in ::attributes\">\n *          <div ng-if=\"attribute.name == 'name'\">\n *            <input ng-model=\"attribute.value\" placeholder=\"name\" />\n *          </div>\n *        </div>\n *      </gmf-print>\n *\n * Note: The 'print' and 'cancel' functions can also be called via globals\n * events 'gmfStartPrint' and 'gmfCancelPrint'.\n *\n * @htmlAttribute {ol.Map} gmf-print-map The map.\n * @htmlAttribute {boolean} gmf-print-active A boolean that informs if the\n *     panel is open or not.\n * @htmlAttribute {boolean} gmf-print-rotatemask Optional. True to apply\n *     rotation on the mask instead of the map. By default, the map rotates.\n * @htmlAttribute {Object.<string, string|number|boolean>}\n *     gmf-print-fieldvalues optional. Key, value object to define default\n *     value in each of your print panel field. The key refers to the\n *     property's name of the field.\n *     Example: {'comments': 'demo', 'legend': false}. Doesn't work for the dpi\n *     and the scale. Server's values are used in priority.\n * @htmlAttribute {Array.<string>} gmf-print-hiddenattributes The list of attributes that should be hidden.\n * @ngdoc component\n * @ngname gmfPrint\n */\nexports.component_ = {\n  bindings: {\n    'map': '<gmfPrintMap',\n    'active': '=gmfPrintActive',\n    'rotateMask': '<?gmfPrintRotatemask',\n    'fieldValues': '<?gmfPrintFieldvalues',\n    'hiddenAttributeNames': '<?gmfPrintHiddenattributes',\n    'attributesOut': '=?gmfPrintAttributesOut'\n  },\n  controller: 'GmfPrintController',\n  templateUrl: gmfPrintTemplateUrl,\n  transclude: true\n};\n\n\nexports.component('gmfPrint', exports.component_);\n\n/**\n * @typedef {{\n *     useBbox: (boolean|undefined),\n *     label: (Object.<string, boolean>),\n *     params: (Object.<string, Object.<string, string>>)\n * }}\n */\nexports.optionsLegendType;\n\n/**\n * @typedef {{\n *     scaleInput: (boolean|undefined),\n *     legend: (optionsLegendType|undefined)\n * }}\n */\nexports.optionsType;\n\n/**\n * @private\n */\nexports.Controller_ = class {\n\n  /**\n   * @param {angular.JQLite} $element Element.\n   * @param {angular.Scope} $rootScope Angular root scope.\n   * @param {angular.Scope} $scope Angular scope.\n   * @param {angular.$timeout} $timeout Angular timeout service.\n   * @param {angular.$q} $q The Angular $q service.\n   * @param {angular.$injector} $injector Main injector.\n   * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n   * @param {ngeo.map.LayerHelper} ngeoLayerHelper The ngeo Layer Helper service.\n   * @param {ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr Ngeo Feature Overlay\n   *     Manager service.\n   * @param {ngeo.print.Utils} ngeoPrintUtils The ngeo PrintUtils service.\n   * @param {ngeox.CreatePrint} ngeoCreatePrint The ngeo Create Print function.\n   * @param {string} gmfPrintUrl A MapFishPrint url.\n   * @param {gmf.authentication.Service} gmfAuthenticationService The authentication service.\n   * @param {ngeox.QueryResult} ngeoQueryResult ngeo query result.\n   * @param {angular.$filter} $filter Angular $filter service.\n   * @param {gmf.print.component.PrintStateEnum} gmfPrintState GMF print state.\n   * @param {gmf.theme.Themes} gmfThemes The gmf Themes service.\n   * @private\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfPrintController\n   */\n  constructor($element, $rootScope, $scope, $timeout, $q, $injector,\n    gettextCatalog, ngeoLayerHelper, ngeoFeatureOverlayMgr,  ngeoPrintUtils,\n    ngeoCreatePrint, gmfPrintUrl, gmfAuthenticationService, ngeoQueryResult,\n    $filter, gmfPrintState, gmfThemes) {\n\n    /**\n     * @type {gmf.print.component.PrintStateEnum}\n     * @private\n     */\n    this.gmfPrintState_ = gmfPrintState;\n\n    /**\n     * @type {function(string): string}\n     * @private\n     */\n    this.translate_ = $filter('translate');\n\n    /**\n     * @type {ol.Map}\n     * @export\n     */\n    this.map;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.active;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.rotateMask = false;\n\n    /**\n     * @type {Object.<string, string|number|boolean>!}\n     * @export\n     */\n    this.fieldValues = {};\n\n    /**\n     * @type {Array.<string>}\n     * @export\n     */\n    this.attributesOut;\n\n    /**\n     * @type {angular.Scope}\n     * @private\n     */\n    this.$rootScope_ = $rootScope;\n\n    /**\n     * @type {angular.Scope}\n     * @private\n     */\n    this.$scope_ = $scope;\n\n    /**\n     * @type {angular.$timeout}\n     * @private\n     */\n    this.$timeout_ = $timeout;\n\n    /**\n     * @type {angular.$q}\n     * @private\n     */\n    this.$q_ = $q;\n\n    /**\n     * @type {angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * @type {ngeo.map.LayerHelper}\n     * @private\n     */\n    this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n    /**\n     * @type {ol.layer.Vector}\n     * @private\n     */\n    this.featureOverlayLayer_ = ngeoFeatureOverlayMgr.getLayer();\n\n    /**\n     * @type {ngeo.print.Utils}\n     * @private\n     */\n    this.ngeoPrintUtils_ = ngeoPrintUtils;\n\n    /**\n     * @type {ngeo.print.Service}\n     * @private\n     */\n    this.ngeoPrint_ = ngeoCreatePrint(gmfPrintUrl);\n\n    /**\n     * @type {ngeox.QueryResult}\n     * @private\n     */\n    this.ngeoQueryResult_ = ngeoQueryResult;\n\n    /**\n     * @type {gmf.authentication.Service}\n     * @private\n     */\n    this.gmfAuthenticationService_ = gmfAuthenticationService;\n\n    /**\n     * @type {gmf.theme.Themes}\n     * @private\n     */\n    this.gmfThemes_ = gmfThemes;\n\n    this.cacheVersion_ = '0';\n    if ($injector.has('cacheVersion')) {\n      this.cacheVersion_ = $injector.get('cacheVersion');\n    }\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.scaleInput = false;\n\n    /**\n     * @type optionsLegendType\n     * @private\n     */\n    this.gmfLegendOptions_ = {\n      useBbox: true,\n      label: {},\n      params: {},\n    };\n\n    if ($injector.has('gmfPrintOptions')) {\n      /**\n       * @type optionsType\n       */\n      const options = $injector.get('gmfPrintOptions');\n      if (options.scaleInput) {\n        this.scaleInput = options.scaleInput;\n      }\n      if (options.legend) {\n        Object.assign(this.gmfLegendOptions_, options.legend);\n      }\n    }\n\n    /**\n     * @type {?angular.$q.Deferred}\n     * @private\n     */\n    this.requestCanceler_ = null;\n\n    /**\n     * @type {?angular.$q.Promise}\n     * @private\n     */\n    this.statusTimeoutPromise_ = null;\n\n    /**\n     * @type {Array.<number>|null}\n     * @private\n     */\n    this.onDragPreviousMousePosition_ = null;\n\n    /**\n     * @type {?angular.$q.Promise|null}\n     * @private\n     */\n    this.rotationTimeoutPromise_ = null;\n\n    /**\n     * @type {ol.EventsKey}\n     * @private\n     */\n    this.postComposeListenerKey_;\n\n    /**\n     * @type {ol.EventsKey}\n     * @private\n     */\n    this.pointerDragListenerKey_;\n\n    /**\n     * @type {ol.EventsKey}\n     * @private\n     */\n    this.mapViewResolutionChangeKey_;\n\n    /**\n     * Current report reference id.\n     * @type {string}\n     * @private\n     */\n    this.curRef_ = '';\n\n    /**\n     * Formats availables in capabilities.\n     * @type {Array.<string>}\n     * @private\n     */\n    this.formats_ = [];\n\n    /**\n     * An array of attributes objects from capabilities.\n     * @type {Array.<Object>}\n     * @private\n     */\n    this.layouts_ = [];\n\n    /**\n     * An attributes object from capabilities.\n     * @type {Object}\n     * @private\n     */\n    this.layout_ = {};\n\n    /**\n     * @type {Array.<number>}\n     * @private\n     */\n    this.paperSize_ = [];\n\n    /**\n     * @type {gmfx.PrintLayoutInfo}\n     * @export\n     */\n    this.layoutInfo = {};\n\n    /**\n     * @type {number}\n     * @export\n     */\n    this.rotation = 0;\n\n    /**\n     * @type {Array.<string>}\n     * @export\n     */\n    this.hiddenAttributeNames;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.scaleManuallySelected_ = false;\n\n    /**\n     * @type {angular.JQLite}\n     * @export\n     */\n    this.rotationInput_ = $element.find('.gmf-print-rotation-input');\n\n    this.rotationInput_.on('input', (event) => {\n      const rotation = $(event.target).val();\n      if (rotation !== '') {\n        this.setRotation(/** @type {number} */ (rotation));\n      }\n    });\n    // Workaround for IE11\n    this.rotationInput_.on('change', (event) => {\n      const rotation = $(event.target).val();\n      if (rotation !== '') {\n        this.setRotation(/** @type {number} */ (rotation));\n      }\n    });\n\n    /**\n     * @type {function(ol.render.Event)}\n     */\n    this.postcomposeListener_;\n\n    /**\n     * @type {angular.$http.HttpPromise}\n     * @private\n     */\n    this.capabilities_;\n\n    /**\n     * @type {gmfThemes.GmfOgcServers}\n     * @private\n     */\n    this.ogcServers_;\n\n    /**\n     * @type {Array.<gmfThemes.GmfTheme>}\n     * @private\n     */\n    this.currentThemes_;\n  }\n\n\n  /**\n   * Init the controller\n   */\n  $onInit() {\n\n    olEvents.listen(this.map.getView(), 'change:rotation', (event) => {\n      this.updateRotation_(Math.round(olMath.toDegrees(event.target.getRotation())));\n    });\n\n    // Clear the capabilities if the roleId changes\n    this.$scope_.$watch(() => this.gmfAuthenticationService_.getRoleId(), () => {\n      this.gmfPrintState_.state = exports.PrintStateEnum.CAPABILITIES_NOT_LOADED;\n      this.capabilities_ = null;\n    });\n\n    this.$scope_.$watch(() => this.active, (active) => {\n      this.togglePrintPanel_(active);\n    });\n\n    // Print on event.\n    this.$rootScope_.$on('gmfStartPrint', (event, format) => {\n      this.print(`${format}`);\n    });\n\n    // Cancel print task on event.\n    this.$rootScope_.$on('gmfCancelPrint', () => {\n      this.cancel();\n    });\n\n    this.gmfThemes_.getOgcServersObject().then((ogcServersObject) => {\n      this.ogcServers_ = ogcServersObject;\n    });\n\n    this.gmfThemes_.getThemesObject().then((currentThemes) => {\n      this.currentThemes_ = currentThemes;\n    });\n\n    /**\n     * @return {ol.Size} Size in dots of the map to print.\n     */\n    const getSizeFn = () => this.paperSize_;\n\n    let getRotationFn;\n    if (this.rotateMask) {\n      /**\n       * @return {number} rotation to apply.\n       */\n      getRotationFn = () => this.rotation;\n    }\n\n    this.postcomposeListener_ = this.ngeoPrintUtils_.createPrintMaskPostcompose(\n      getSizeFn, this.getScaleFn.bind(this), getRotationFn);\n  }\n\n\n  /**\n   * @param {olx.FrameState} frameState Frame state.\n   * @return {number} Scale of the map to print.\n   */\n  getScaleFn(frameState) {\n    // Don't compute an optimal scale if the user manually choose a value not in\n    // the pre-defined scales. (`scaleInput` in `gmfPrintOptions`).\n    googAsserts.assert(this.layoutInfo.scales);\n    googAsserts.assert(this.layoutInfo.scale !== undefined);\n    if (!this.scaleManuallySelected_ &&\n        (this.layoutInfo.scale === -1 || olArray.includes(this.layoutInfo.scales, this.layoutInfo.scale))) {\n      const mapSize = frameState.size;\n      const viewResolution = frameState.viewState.resolution;\n      this.layoutInfo.scale = this.getOptimalScale_(mapSize, viewResolution);\n    }\n    return this.layoutInfo.scale;\n  }\n\n\n  /**\n   * @param {boolean} active True to listen events related to the print and get\n   *     capabilities. False to stop listen them and set rotation to 0.\n   * @private\n   */\n  togglePrintPanel_(active) {\n    if (active) {\n      if (!this.capabilities_) {\n        this.getCapabilities_();\n      }\n      this.capabilities_.then((resp) => {\n        // make sure the panel is still open\n        if (!this.active) {\n          return;\n        }\n        this.gmfPrintState_.state = exports.PrintStateEnum.NOT_IN_USE;\n        // Get capabilities - On success\n        this.parseCapabilities_(resp);\n        this.postComposeListenerKey_ = olEvents.listen(this.map, 'postcompose', this.postcomposeListener_);\n        this.pointerDragListenerKey_ = olEvents.listen(this.map, 'pointerdrag', this.onPointerDrag_, this);\n        this.mapViewResolutionChangeKey_ = olEvents.listen(this.map.getView(), 'change:resolution', () => {\n          this.scaleManuallySelected_ = false;\n        });\n        this.map.render();\n      }, (resp) => {\n        // Get capabilities - On error\n        this.gmfPrintState_.state = exports.PrintStateEnum.ERROR_ON_GETCAPABILITIES;\n        this.capabilities_ = null;\n      });\n    } else {\n      olEvents.unlistenByKey(this.postComposeListenerKey_);\n      olEvents.unlistenByKey(this.pointerDragListenerKey_);\n      olEvents.unlistenByKey(this.mapViewResolutionChangeKey_);\n      this.setRotation(0);\n      this.map.render(); // Redraw (remove) post compose mask;\n    }\n  }\n\n\n  /**\n   * Gets the print capabilities.\n   * @param {number|null=} opt_roleId The role id.\n   * @private\n   */\n  getCapabilities_(opt_roleId) {\n    this.capabilities_ = this.ngeoPrint_.getCapabilities(\n      /** @type {angular.$http.Config} */ ({\n        withCredentials: true,\n        params: opt_roleId ? {\n          'role': opt_roleId,\n          'cache_version': this.cacheVersion_\n        } : {\n          'cache_version': this.cacheVersion_\n        }\n      }));\n  }\n\n\n  /**\n   * Create the list of layouts, get the formats, get the first layout in\n   * gmf print v3 capabilities and then update the print panel layout information.\n   * @param {!angular.$http.Response} resp Response.\n   * @private\n   */\n  parseCapabilities_(resp) {\n    const data = resp['data'];\n    this.formats_ = data['formats'] || [];\n    this.layouts_ = data['layouts'];\n    this.layout_ = data['layouts'][0];\n\n    this.layoutInfo.layouts = [];\n    this.layouts_.forEach((layout) => {\n      this.layoutInfo.layouts.push(layout.name);\n    });\n\n    this.updateFields_();\n  }\n\n\n  /**\n   * Update layout information with the user values if there are always available in the\n   * current layout otherwise use the defaults values of the layout.\n   * If a field doesn't exist in the current layout, set it to undefined so the\n   * view can hide it. Update also the paper size.\n   * custom print templates).\n   * @private\n   */\n  updateFields_() {\n    this.layoutInfo.layout = this.layout_.name;\n\n    const mapInfo = this.isAttributeInCurrentLayout_('map');\n    googAsserts.assertObject(mapInfo);\n    const clientInfo = mapInfo['clientInfo'];\n    googAsserts.assertObject(clientInfo);\n    this.paperSize_ = [clientInfo['width'], clientInfo['height']];\n\n    this.updateCustomFields_();\n\n    this.layoutInfo.legend = this.fieldValues['legend'] !== false;\n    this.layoutInfo.scales = clientInfo['scales'] || [];\n    this.layoutInfo.dpis = clientInfo['dpiSuggestions'] || [];\n\n    const mapSize = this.map.getSize();\n    const viewResolution = this.map.getView().getResolution();\n    this.layoutInfo.scale = this.getOptimalScale_(mapSize, viewResolution);\n\n    this.layoutInfo.dpi =\n        (this.layoutInfo.dpi && this.layoutInfo.dpis.indexOf(this.layoutInfo.dpi) > 0) ?\n          this.layoutInfo.dpi : this.layoutInfo.dpis[0];\n\n    this.layoutInfo.formats = {};\n    this.formats_.forEach((format) => {\n      this.layoutInfo.formats[format] = true;\n    });\n\n    this.attributesOut = this.layoutInfo['simpleAttributes'];\n\n    // Force the update of the mask\n    this.map.render();\n  }\n\n\n  /**\n   * Update simple attributes information with gmfx.Customfield to be able to generate a form\n   * from a custom GMF print v3 configuration.\n   * @private\n   */\n  updateCustomFields_() {\n    let name, rawType, value, type;\n    if (!this.layoutInfo.simpleAttributes) {\n      this.layoutInfo.simpleAttributes = [];\n    }\n    if (!this.layoutInfo.attributes) {\n      this.layoutInfo.attributes = [];\n    }\n    const simpleAttributes = this.layoutInfo.simpleAttributes;\n    const previousAttributes = simpleAttributes.splice(0, simpleAttributes.length);\n\n    // The attributes without 'clientParams' are the custom layout information (defined by end user).\n    this.layout_.attributes.forEach((attribute) => {\n      this.layoutInfo.attributes.push(attribute.name);\n      if (!attribute['clientParams']) {\n        name = `${attribute.name}`;\n        const defaultValue = attribute.default;\n        value = (defaultValue !== undefined && defaultValue !== '') ?\n          defaultValue : this.fieldValues[name];\n\n        // Try to use existing form field type\n        rawType = `${attribute.type}`;\n        switch (rawType) {\n          case 'String':\n            type = (name === 'comments') ? 'textarea' : 'text';\n            break;\n          case 'Boolean':\n            type = 'checkbox';\n            break;\n          case 'Number':\n            type = 'number';\n            value = parseFloat(value);\n            value = isNaN(value) ? 0 : value;\n            break;\n          default:\n            type = rawType;\n        }\n\n        // If it exists use the value of previous same field.\n        previousAttributes.forEach((c) => {\n          if (c.name === name && c.type === type) {\n            return value = c.value;\n          }\n        });\n\n        this.layoutInfo.simpleAttributes.push(/** gmfx.PrintSimpleAttributes */ ({\n          name,\n          type,\n          value\n        }));\n      }\n    });\n  }\n\n\n  /**\n   * Return a capabilities 'attribute' object corresponding to the given name.\n   * @param {string} name Name of the attribute to get.\n   * @return {Object|null} corresponding attribute or null.\n   * @private\n   */\n  isAttributeInCurrentLayout_(name) {\n    let attr = null;\n    this.layout_.attributes.forEach((attribute) => {\n      if (attribute.name === name) {\n        return attr = attribute;\n      }\n    });\n    return attr;\n  }\n\n\n  /**\n   * Set the current rotation value.\n   * Updating the rotation will redraw the mask or rotate the map (depending on the configuration).\n   * @param {number} rotation The optional new rotation value in degrees.\n   */\n  setRotation(rotation) {\n    this.updateRotation_(rotation);\n    // Render the map to update the postcompose mask or rotate the map.\n    if (this.rotateMask) {\n      this.map.render();\n    } else {\n      this.map.getView().setRotation(olMath.toRadians(this.rotation));\n    }\n  }\n\n  /**\n   * Set the current rotation value.\n   * @param {number} rotation The optional new rotation value in degrees.\n   */\n  updateRotation_(rotation) {\n    this.rotation = olMath.clamp(rotation, -180, 180);\n    // sync all the inputs\n    this.rotationInput_.val(this.rotation.toString());\n  }\n\n  /**\n   * Calculate the angle and the sense of rotation between two lines. One from the\n   * center of the map and the point of the last call to this function and one\n   * from the same center and the point of the current call.\n   * @param {ol.MapBrowserPointerEvent} e An ol map browser pointer event.\n   * @private\n   */\n  onPointerDrag_(e) {\n    const originalEvent = e.originalEvent;\n    const mapCenter = this.map.getView().getCenter();\n    if (this.active && originalEvent.altKey && originalEvent.shiftKey && mapCenter) {\n      const center = this.map.getPixelFromCoordinate(mapCenter);\n      const pixel = e.pixel;\n      // Reset previous position between two different sessions of drags events.\n      if (this.rotationTimeoutPromise_ === null) {\n        this.onDragPreviousMousePosition_ = null;\n      } else {\n        // Cancel the timeout to keep this session of drags event\n        this.$timeout_.cancel(this.rotationTimeoutPromise_);\n        // Calculate angle and sense of rotation.\n        const p0x = this.onDragPreviousMousePosition_[0] - center[0];\n        const p0y = this.onDragPreviousMousePosition_[1] - center[1];\n        const p1x = pixel[0] - center[0];\n        const p1y = pixel[1] - center[1];\n        const centerToP0 = Math.sqrt(Math.pow(p0x, 2) + Math.pow(p0y, 2));\n        const centerToP1 = Math.sqrt(Math.pow(p1x, 2) + Math.pow(p1y, 2));\n        const sense = (p0x * p1y - p0y * p1x) > 0 ? 1 : -1;\n        let angle = (p0x * p1x + p0y * p1y) / (centerToP0 * centerToP1);\n        angle = angle <= 1 ? sense * Math.acos(angle) : 0;\n        const boost = centerToP1 / 200;\n        const increment = Math.round(olMath.toDegrees(angle) * boost);\n\n        // Set rotation then update the view.\n        this.setRotation(this.rotation + increment);\n        this.$scope_.$digest();\n      }\n      // Prepare the removal of this session of drags events\n      this.rotationTimeoutPromise_ = this.$timeout_(() => {\n        this.rotationTimeoutPromise_ = null;\n      }, 500);\n      // Keep the current position for the next calculation.\n      this.onDragPreviousMousePosition_ = pixel;\n    }\n  }\n\n\n  /**\n   * Create a print report based on the values of the 'layoutInfo' values.\n   * @param {string} format An output format corresponding to one format in the\n   *     capabilities document ('pdf', 'png', etc).\n   * @export\n   */\n  print(format) {\n    // Do not print if a print task is already processing.\n    if (this.gmfPrintState_.state === exports.PrintStateEnum.PRINTING) {\n      return;\n    }\n    this.requestCanceler_ = this.$q_.defer();\n    this.gmfPrintState_.state = exports.PrintStateEnum.PRINTING;\n\n    const mapSize = this.map.getSize();\n    const viewResolution = this.map.getView().getResolution() || 0;\n    const scale = this.layoutInfo.scale || this.getOptimalScale_(mapSize, viewResolution);\n    const datasource = this.getDataSource_();\n\n    const customAttributes = {};\n\n    if (this.layoutInfo.attributes.indexOf('datasource') >= 0) {\n      customAttributes['datasource'] = datasource;\n    }\n\n    if (this.layoutInfo.simpleAttributes) {\n      this.layoutInfo.simpleAttributes.forEach((field) => {\n        customAttributes[field.name] = field.value;\n      });\n    }\n\n    if (this.layoutInfo.legend) {\n      const center = this.map.getView().getCenter();\n      const deltaX = this.paperSize_[0] * scale / 2 / ngeoPrintUtils.INCHES_PER_METER_ / ngeoPrintUtils.DOTS_PER_INCH_;\n      const deltaY = this.paperSize_[1] * scale / 2 / ngeoPrintUtils.INCHES_PER_METER_ / ngeoPrintUtils.DOTS_PER_INCH_;\n      const bbox = [\n        center[0] - deltaX,\n        center[1] - deltaY,\n        center[0] + deltaX,\n        center[1] + deltaY,\n      ];\n      const legend = this.getLegend_(scale, this.layoutInfo.dpi, bbox);\n      if (legend !== null) {\n        customAttributes['legend'] = legend;\n      }\n    }\n\n    googAsserts.assertNumber(this.layoutInfo.dpi);\n    googAsserts.assertString(this.layoutInfo.layout);\n\n    // convert the WMTS layers to WMS\n    const map = new olMap({});\n    map.setView(this.map.getView());\n    const ol_layers = this.ngeoLayerHelper_.getFlatLayers(this.map.getLayerGroup());\n    const new_ol_layers = [];\n    let print_native_angle = true;\n    for (let i = 0, ii = ol_layers.length; i < ii; i++) {\n      let layer = ol_layers[i];\n      const metadata = layer.get('metadata');\n      if (metadata) {\n        const server_name = metadata.ogcServer;\n        const layer_names = metadata.printLayers || metadata.layers;\n        if (server_name && layer_names) {\n          const server = this.ogcServers_[server_name];\n          if (server) {\n            layer = this.ngeoLayerHelper_.createBasicWMSLayer(\n              server.url,\n              layer_names,\n              server.imageType,\n              server.type,\n              undefined,\n              undefined,\n              undefined,\n              undefined,\n              {opacity: ol_layers.opacity}\n            );\n            layer.setZIndex(-200);\n          } else {\n            console.error('Missing ogcServer:', server_name);\n          }\n        }\n      }\n\n      // Get the print native angle parameter for WMS layers when set to not use default value\n      // Is applied only once when the value is overridden with a metadata from administration\n      if (layer instanceof olLayerImage && layer.get('printNativeAngle') === false) {\n        print_native_angle = false;\n      }\n\n      new_ol_layers.push(layer);\n    }\n    map.setLayerGroup(new olLayerGroup({\n      layers: new_ol_layers,\n      'printNativeAngle': print_native_angle\n    }));\n\n    const spec = this.ngeoPrint_.createSpec(map, scale, this.layoutInfo.dpi,\n      this.layoutInfo.layout, format, customAttributes);\n\n    // Add feature overlay layer to print spec.\n    const layers = [];\n    this.ngeoPrint_.encodeLayer(layers, this.featureOverlayLayer_,\n      viewResolution);\n    if (layers.length > 0) {\n      spec.attributes.map.layers.unshift(layers[0]);\n    }\n\n    this.ngeoPrint_.createReport(spec, /** @type {angular.$http.Config} */ ({\n      timeout: this.requestCanceler_.promise\n    })).then(\n      this.handleCreateReportSuccess_.bind(this),\n      this.handleCreateReportError_.bind(this)\n    );\n\n    // remove temporary map\n    map.setTarget(null);\n  }\n\n\n  /**\n   * Cancel the current print and reset its state.\n   * @export\n   */\n  cancel() {\n    // Cancel the latest request, if it's not finished yet.\n    if (this.requestCanceler_ !== null) {\n      this.requestCanceler_.resolve();\n    }\n\n    // Cancel the status timeout if there's one set, to make sure no other\n    // status request is sent.\n    if (this.statusTimeoutPromise_ !== null) {\n      this.$timeout_.cancel(this.statusTimeoutPromise_);\n    }\n\n    if (this.curRef_.length > 0) {\n      this.ngeoPrint_.cancel(this.curRef_);\n    }\n\n    this.resetPrintStates_();\n  }\n\n\n  /**\n   * @param {gmf.print.component.PrintStateEnum=} opt_printState the print state.\n   * @private\n   */\n  resetPrintStates_(opt_printState) {\n    this.gmfPrintState_.state = opt_printState || exports.PrintStateEnum.NOT_IN_USE;\n    this.curRef_ = '';\n  }\n\n\n  /**\n   * Get datasource object for print report\n   * @private\n   * @return {Array.<gmfx.datasource.DataSourcePrintReportObject>} the data\n   *     source objet for the print report\n   */\n  getDataSource_() {\n    let datasourceObj, data, columns;\n    const datasourceArr = [];\n    const sources = this.ngeoQueryResult_.sources;\n    sources.forEach(function(source) {\n      data = [];\n      columns = [];\n      source.features.forEach(function(feature, i) {\n        googAsserts.assert(feature);\n        const properties = ngeoMiscFeatureHelper.getFilteredFeatureValues(feature);\n        if (i === 0) {\n          columns = Object.keys(properties).map(function tanslateColumns(prop) {\n            return this.translate_(prop);\n          }, this);\n        }\n        data.push(Object.keys(properties).map(key => properties[key]));\n      }, this);\n      if (columns.length) {\n        datasourceObj =\n          /** @type {gmfx.datasource.DataSourcePrintReportObject} */({\n            title: this.translate_(source.label),\n            table: {\n              columns,\n              data\n            }\n          });\n        datasourceArr.push(datasourceObj);\n      }\n    }, this);\n    return datasourceArr;\n  }\n\n\n  /**\n   * Get the optimal scale to display the print mask. Return the first scale if\n   * no scale matches.\n   * @param {ol.Size|undefined} mapSize Size of the map on the screen (px).\n   * @param {number|undefined} viewResolution Resolution of the map on the screen.\n   * @return {number} The best scale. -1 is returned if there is no optimal\n   *     scale, that is the optimal scale is lower than or equal to the first\n   *     value in printMapScales.\n   * @private\n   */\n  getOptimalScale_(mapSize, viewResolution) {\n    const scales = this.layoutInfo.scales.slice();\n    if (mapSize !== undefined && viewResolution !== undefined) {\n      return this.ngeoPrintUtils_.getOptimalScale(mapSize, viewResolution,\n        this.paperSize_, scales.reverse());\n    }\n    return this.layoutInfo.scales[0];\n  }\n\n\n  /**\n   * @param {!angular.$http.Response} resp Response.\n   * @private\n   */\n  handleCreateReportSuccess_(resp) {\n    const mfResp = /** @type {MapFishPrintReportResponse} */ (resp.data);\n    const ref = mfResp.ref;\n    googAsserts.assert(ref.length > 0);\n    this.curRef_ = ref;\n    this.getStatus_(ref);\n  }\n\n\n  /**\n   * @param {string} ref Ref.\n   * @private\n   */\n  getStatus_(ref) {\n    this.requestCanceler_ = this.$q_.defer();\n    this.ngeoPrint_.getStatus(ref, /** @type {angular.$http.Config} */ ({\n      timeout: this.requestCanceler_.promise\n    })).then(\n      this.handleGetStatusSuccess_.bind(this, ref),\n      this.handleCreateReportError_.bind(this)\n    );\n  }\n\n\n  /**\n   * @param {string} ref Ref.\n   * @param {!angular.$http.Response} resp Response.\n   * @private\n   */\n  handleGetStatusSuccess_(ref, resp) {\n    const mfResp = /** @type {MapFishPrintStatusResponse} */ (resp.data);\n    const done = mfResp.done;\n    if (done) {\n      if (mfResp.status != 'error') {\n        // The report is ready. Open it by changing the window location.\n        window.location.href = this.ngeoPrint_.getReportUrl(ref);\n        this.resetPrintStates_();\n      } else {\n        console.error(mfResp.error);\n        this.handleCreateReportError_();\n      }\n    } else {\n      // The report is not ready yet. Check again in 1s.\n      this.statusTimeoutPromise_ = this.$timeout_(() => {\n        this.getStatus_(ref);\n      }, 1000, false);\n    }\n  }\n\n\n  /**\n   * @private\n   */\n  handleCreateReportError_() {\n    this.resetPrintStates_(exports.PrintStateEnum.ERROR_ON_REPORT);\n  }\n\n\n  /**\n   * @param {number} scale The scale to get the legend (for wms layers only).\n   * @param {number} dpi The DPI.\n   * @param {Array.number} bbox The bbox.\n   * @return {Object?} Legend object for print report or null.\n   * @private\n   */\n  getLegend_(scale, dpi, bbox) {\n    const legend = {'classes': []};\n    const gettextCatalog = this.gettextCatalog_;\n\n    // Get layers from layertree only.\n    const dataLayerGroup = this.ngeoLayerHelper_.getGroupFromMap(this.map,\n      gmfBase.DATALAYERGROUP_NAME);\n    const layers = this.ngeoLayerHelper_.getFlatLayers(dataLayerGroup);\n\n    // For each visible layer in reverse order, get the legend url.\n    layers.reverse().forEach((layer) => {\n      const classes = [];\n      if (layer.getVisible() && layer.getSource()) {\n        // For WMTS layers.\n        if (layer instanceof olLayerTile) {\n          const layerName = `${layer.get('layerNodeName')}`;\n          let icons = this.getMetadataLegendImage_(layerName);\n          if (!icons) {\n            icons = this.ngeoLayerHelper_.getWMTSLegendURL(layer);\n          }\n          // Don't add classes without legend url.\n          if (icons) {\n            classes.push({\n              'name': gettextCatalog.getString(layerName),\n              'icons': [icons]\n            });\n          }\n        } else {\n          const source = /** @type ol.source.ImageWMS */ (layer.getSource());\n          // For each name in a WMS layer.\n          const layerNames = source.getParams()['LAYERS'].split(',');\n          layerNames.forEach((name) => {\n            let icons = this.getMetadataLegendImage_(name);\n            if (!icons) {\n              icons = this.ngeoLayerHelper_.getWMSLegendURL(source.getUrl(), name,\n                scale, undefined, undefined, undefined, source.serverType_, dpi,\n                this.gmfLegendOptions_.useBbox ? bbox : undefined,\n                this.map.getView().getProjection().getCode(),\n                this.gmfLegendOptions_.params[layer.getSource().serverType_]\n              );\n            }\n            const type = icons ? 'image' : source.serverType_;\n\n            // Don't add classes without legend url or from layers without any\n            // active name.\n            if (icons && name.length !== 0) {\n              classes.push(Object.assign({\n                'name': this.gmfLegendOptions_.label[type] === false ? '' :\n                  gettextCatalog.getString(name),\n                'icons': [icons]\n              }, type === 'qgis' ? {\n                'dpi': dpi,\n              } : {}));\n            }\n          });\n        }\n      }\n\n      // Add classes object only if it contains something.\n      if (classes.length > 0) {\n        legend['classes'].push({'classes': classes});\n      }\n\n    });\n\n    return legend['classes'].length > 0 ?  legend : null;\n  }\n\n\n  /**\n   * Return the metadata legendImage of a layer from the found corresponding node\n   * or undefined.\n   * @param {string} layerName a layer name.\n   * @return {string|undefined} The legendImage or undefined.\n   * @private\n   */\n  getMetadataLegendImage_(layerName) {\n    const groupNode = gmfThemeThemes.findGroupByLayerNodeName(this.currentThemes_, layerName);\n    let node;\n    if (groupNode && groupNode.children) {\n      node = gmfThemeThemes.findObjectByName(groupNode.children, layerName);\n    }\n    let legendImage;\n    if (node && node.metadata) {\n      legendImage = node.metadata.legendImage;\n    }\n    return legendImage;\n  }\n\n\n  /**\n   * Set the current layout and update all layout information with this new layout parameters.\n   * @param {string!} layoutName A layout name as existing in the list of\n   *     existing layouts.\n   * @export\n   */\n  setLayout(layoutName) {\n    let layout;\n    this.layouts_.forEach((l) => {\n      if (l.name === layoutName) {\n        layout = l;\n        return true; // break;\n      }\n    });\n    this.layout_ = layout;\n    this.updateFields_();\n  }\n\n\n  /**\n   * Get or set the print scale value and adapt the zoom to match with this new scale.\n   * @param {number=} opt_scale A scale value as existing in the scales list field.\n   * @return {number|undefined} New scale.\n   * @export\n   */\n  getSetScale(opt_scale) {\n    if (opt_scale !== undefined) {\n      const mapSize = this.map.getSize() || [0, 0];\n      this.layoutInfo.scale = opt_scale;\n      const res = this.ngeoPrintUtils_.getOptimalResolution(mapSize, this.paperSize_, opt_scale);\n      const contrainRes = this.map.getView().constrainResolution(res, 0, 1);\n      this.map.getView().setResolution(contrainRes);\n      // Render the map to update the postcompose mask manually\n      this.map.render();\n      this.scaleManuallySelected_ = true;\n    }\n    return this.layoutInfo.scale;\n  }\n\n\n  /**\n   * Set the print dpi value.\n   * @param {number} dpi A dpi value as existing in the dpis list field.\n   * @export\n   */\n  setDpi(dpi) {\n    this.layoutInfo.dpi = dpi;\n  }\n\n\n  /**\n   * Check the current state of the print.\n   * @param {string} stateEnumKey An enum key from gmf.print.component.PrintStateEnum.\n   * @return {boolean} True if the given state matches with the current print\n   *     state. False otherwise.\n   * @export\n   */\n  isState(stateEnumKey) {\n    return this.gmfPrintState_.state === exports.PrintStateEnum[stateEnumKey];\n  }\n};\n\nexports.controller('GmfPrintController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.datetimepickerComponent\n */\nimport DateFormatter from 'ngeo/misc/php-date-formatter.js';\nimport 'jquery-datetimepicker/jquery.datetimepicker.js';\nimport 'jquery-datetimepicker/jquery.datetimepicker.css';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoDateTimePicker', ['gettext']);\n\n/**\n * A directive used to display a date or time picker\n *\n * Example:\n *\n *      <input ngeo-datetimepicker\n *          ngeo-datetimepicker-options=\"{timepicker: false}\"\n *\n * @htmlAttribute {Object} ngeo-datetimepicker-options The options.\n *\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname ngeoDatetimepicker\n */\nexports.component_ = function() {\n  return {\n    restrict: 'A',\n    controller: exports.Controller_,\n    bindToController: true,\n    scope: {\n      'options': '<ngeoDatetimepickerOptions'\n    }\n  };\n};\n\nexports.directive('ngeoDatetimepicker', exports.component_);\n\n\n/**\n * @param {!jQuery} $element Element.\n * @param {!angularGettext.Catalog} gettextCatalog service.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoDatetimepickerController\n */\nexports.Controller_ = function($element, gettextCatalog) {\n  /**\n   * @const {!jQuery}\n   * @private\n   */\n  this.element_ = $element;\n\n  /**\n   * The gettext catalog\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * The options\n   * @type {Object|String}\n   * @private\n   */\n  this.options;\n};\n\n\n/**\n * Initialize the directive.\n */\nexports.Controller_.prototype.$onInit = function() {\n  const lang = this.gettextCatalog_.getCurrentLanguage();\n  $.datetimepicker.setLocale(lang);\n  $.datetimepicker.setDateFormatter(new DateFormatter());\n  if (typeof this.options === 'string') {\n    this.options = angular.fromJson(this.options);\n  }\n  this.element_.datetimepicker(this.options);\n};\n\nexports.controller('ngeoDateTimePickerController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.editing.attributesComponent\n */\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport ngeoMiscEventHelper from 'ngeo/misc/EventHelper.js';\nimport ngeoMiscDatetimepickerComponent from 'ngeo/misc/datetimepickerComponent.js';\n\nconst exports = angular.module('ngeoAttributes', [\n  ngeoMiscDatetimepickerComponent.name,\n  ngeoMiscEventHelper.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/editing/attributescomponent', require('./attributescomponent.html'));\n});\n\n\nexports.value('ngeoAttributesTemplateUrl',\n  /**\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} The template url.\n   */\n  ($attrs) => {\n    const templateUrl = $attrs['ngeoAttributesTemplateUrl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/editing/attributescomponent';\n  });\n\n/**\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.Attributes): string} ngeoAttributesTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoAttributesTemplateUrl($attrs, ngeoAttributesTemplateUrl) {\n  return ngeoAttributesTemplateUrl($attrs);\n}\n\n\n/**\n * Component used to render the attributes of a feature into a form.\n * Example:\n *\n *     <ngeo-attributes\n *       ngeo-attributes-attributes=\"::ctrl.attributes\"\n *       ngeo-attributes-disabled=\"ctrl.attributesDisabled\"\n *       ngeo-attributes-feature=\"::ctrl.feature\">\n *     </ngeo-attributes>\n *\n * @htmlAttribute {Array.<ngeox.Attribute>} ngeo-attributes-attributes The\n *     list of attributes to use.\n * @htmlAttribute {boolean} ngeo-attributes-disabled Whether the fieldset should\n *     be disabled or not.\n * @htmlAttribute {ol.Feature} ngeo-attributes-feature The feature.\n *\n * @ngdoc component\n * @ngname ngeoAttributes\n */\nexports.component_ = {\n  controller: 'ngeoAttributesController as attrCtrl',\n  bindings: {\n    'attributes': '=ngeoAttributesAttributes',\n    'disabled': '<ngeoAttributesDisabled',\n    'feature': '=ngeoAttributesFeature'\n  },\n  require: {\n    'form': '^'\n  },\n  templateUrl: ngeoAttributesTemplateUrl\n};\n\nexports.component('ngeoAttributes', exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!ngeo.misc.EventHelper} ngeoEventHelper Ngeo event helper service\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoAttributesController\n */\nexports.Controller_ = function($scope, ngeoEventHelper) {\n\n  /**\n   * The list of attributes to create the form with.\n   * @type {Array.<ngeox.Attribute>}\n   * @export\n   */\n  this.attributes;\n\n  /**\n   * Whether the fieldset should be disabled or not.\n   * @type {boolean}\n   * @export\n   */\n  this.disabled = false;\n\n  /**\n   * The feature containing the values.\n   * @type {ol.Feature}\n   * @export\n   */\n  this.feature;\n\n  /**\n   * The properties bound to the form, initialized with the inner properties\n   * of the feature.\n   * @type {?Object.<string, *>}\n   * @export\n   */\n  this.properties;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {!ngeo.misc.EventHelper}\n   * @private\n   */\n  this.ngeoEventHelper_ = ngeoEventHelper;\n\n  /**\n   * While changes happen from the form (from the template), they are applied\n   * to the feature inner properties. The 'propertychange' event registered\n   * above does the opposite, i.e. it listens to the feature inner properties\n   * changes and apply them to the form. To prevent circular issues, while\n   * applying changes coming from the form, this flag is set. While set, changes\n   * from the feature inner properties are ignored.\n   * @type {boolean}\n   * @private\n   */\n  this.updating_ = false;\n};\n\n\n/**\n * Initialise the component.\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.properties = this.feature.getProperties();\n\n  // Listen to the feature inner properties change and apply them to the form\n  const uid = olBase.getUid(this);\n  this.ngeoEventHelper_.addListenerKey(\n    uid,\n    olEvents.listen(this.feature, 'propertychange', this.handleFeaturePropertyChange_, this)\n  );\n};\n\n\n/**\n * Called when an input node value changes\n * @param {string} name Attribute name\n * @export\n */\nexports.Controller_.prototype.handleInputChange = function(name) {\n  this.updating_ = true;\n  const value = this.properties[name];\n  this.feature.set(name, value);\n  this.updating_ = false;\n};\n\n\n/**\n * Cleanup event listeners.\n */\nexports.Controller_.prototype.$onDestroy = function() {\n  const uid = olBase.getUid(this);\n  this.ngeoEventHelper_.clearListenerKey(uid);\n};\n\n\n/**\n * @param {ol.Object.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleFeaturePropertyChange_ = function(evt) {\n  if (this.updating_) {\n    return;\n  }\n  this.properties[evt.key] = evt.target.get(evt.key);\n  this.scope_.$apply();\n};\n\n\nexports.controller('ngeoAttributesController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.editing.exportfeaturesComponent\n */\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport * as olBase from 'ol/index.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\n\nconst exports = angular.module('ngeoExportfeatures', [\n  ngeoMiscFeatureHelper.module.name\n]);\n\n/**\n * Directive used to export vector features in different types of format.\n * To configure which formats to use, define the `ngeoExportFeatureFormats`\n * value, as such:\n *\n *     app.module.value('ngeoExportFeatureFormats', [\n *         ngeo.misc.FeatureHelper.FormatType.KML,\n *         ngeo.misc.FeatureHelper.FormatType.GPX\n *     ]);\n *\n * Example:\n *\n *     <button\n *       ngeo-exportfeatures\n *       ngeo-exportfeatures-features=\"ctrl.features\"\n *       class=\"btn btn-link\">Export</button>\n *\n * @htmlAttribute {ol.Collection.<ol.Feature>} ngeo-exportfeatures-features The\n *     features to export\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoExportfeatures\n */\nexports.directive_ = function() {\n  return {\n    controller: 'ngeoExportfeaturesController as efCtrl',\n    scope: true,\n    bindToController: {\n      'features': '=ngeoExportfeaturesFeatures'\n    }\n  };\n};\n\n\nexports.directive('ngeoExportfeatures', exports.directive_);\n\n\n/**\n * @param {angular.JQLite} $element Element.\n * @param {angular.$injector} $injector Main injector.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoExportfeaturesController\n */\nexports.Controller_ = function($element, $injector, $scope,\n  ngeoFeatureHelper) {\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @private\n   */\n  this.features;\n\n  /**\n   * @type {angular.JQLite}\n   * @private\n   */\n  this.element_ = $element;\n\n  const uid = olBase.getUid(this);\n  const id = ['ngeo-exportfeature', uid].join('-');\n\n  /**\n   * @type {string}\n   * @private\n   */\n  this.id_ = id;\n\n  /**\n   * @type {ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.featureHelper_ = ngeoFeatureHelper;\n\n  let formats;\n  if ($injector.has('ngeoExportFeatureFormats')) {\n    formats = $injector.get('ngeoExportFeatureFormats');\n  } else {\n    formats = [ngeoMiscFeatureHelper.FormatType.KML];\n  }\n\n  /**\n   * @type {?jQuery}\n   * @private\n   */\n  this.menu_ = null;\n\n  /**\n   * @type {Array.<jQuery>}\n   * @private\n   */\n  this.items_ = [];\n\n  // build the drop-down menu and items if there's more than one format\n  if (formats.length > 1) {\n    $element.attr('id', id);\n    const $menu = $('<ul />', {\n      'class': 'dropdown-menu',\n      'aria-labelledby': id\n    }).appendTo($element.parent()[0]);\n\n    this.menu_ = $menu;\n    let $item;\n\n    formats.forEach((format) => {\n      $item = $('<li />')\n        .appendTo($menu)\n        .append($('<a />', {\n          'href': '#',\n          'text': format\n        })\n          .on(\n            ['click', id].join('.'),\n            this.handleMenuItemClick_.bind(this, format)\n          )\n        );\n      this.items_.push($item);\n    });\n  }\n\n  /**\n   * @type {Array.<string>}\n   * @private\n   */\n  this.formats_ = formats;\n\n  $element.on(['click', id].join('.'), this.handleElementClick_.bind(this));\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n};\n\n\n/**\n * Called when the element bound to this directive is clicked. Use the feature\n * helper to export the feature(s) depending on the format(s) available(s).\n * If there's only one, the call to the export method is direct, otherwise\n * a drop-down menu is show to let the user choose the format of the export.\n * Finally, if there's only one feature in the collection to export and there's\n * more than one format set, some formats may not support the type of geometry.\n * If that's the case, then disable each format item in the drop-down menu\n * that doesn't support the type of geometry.\n * @private\n */\nexports.Controller_.prototype.handleElementClick_ = function() {\n\n  const features = this.features.getArray();\n\n  if (this.formats_.length === 1) {\n    this.featureHelper_.export(features, this.formats_[0]);\n  } else if (features.length === 1) {\n    const feature = features[0];\n    const geom = feature.getGeometry();\n    let $item;\n    this.formats_.forEach((format, i) => {\n      $item = this.items_[i];\n      if (format === ngeoMiscFeatureHelper.FormatType.GPX) {\n        if (geom instanceof olGeomPoint ||\n            geom instanceof olGeomLineString) {\n          $item.removeClass('disabled');\n        } else {\n          $item.addClass('disabled');\n        }\n      }\n    });\n  }\n};\n\n\n/**\n * Called when a menu item is clicked. Export the features to the selected\n * format.\n * @param {string} format Format.\n * @param {jQuery.Event} event Event.\n * @private\n */\nexports.Controller_.prototype.handleMenuItemClick_ = function(format, event) {\n  if (!$(event.target.parentElement).hasClass('disabled')) {\n    const features = this.features.getArray();\n    this.featureHelper_.export(features, format);\n  }\n};\n\n\n/**\n * Cleanup event listeners and remove the menu from DOM, if any.\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  const id = this.id_;\n\n  this.element_.off(['click', id].join('.'));\n\n  if (this.menu_) {\n    this.menu_.remove();\n    this.items_.forEach(($item) => {\n      $item.off(['click', id].join('.'));\n    });\n    this.items_.length = 0;\n    this.menu_ = null;\n  }\n};\n\n\nexports.controller(\n  'ngeoExportfeaturesController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.sortableComponent\n */\nimport 'jquery-ui/ui/widgets/sortable.js';\nimport 'jquery-ui-touch-punch';\nimport googAsserts from 'goog/asserts.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoSortable', []);\n\n\n/**\n * Provides a directive that allows drag-and-dropping DOM items between them.\n * It also changes the order of elements in the given array.\n *\n * It is typically used together with `ng-repeat`, for example for re-ordering\n * layers in a map.\n *\n * Example:\n *\n *     <ul ngeo-sortable=\"ctrl.layers\"\n *         ngeo-sortable-options=\"{handleClassName: 'ngeo-sortable-handle'}\">\n *       <li ng-repeat=\"layer in ctrl.layers\">\n *         <span class=\"ngeo-sortable-handle\">handle</span>{{layer.get('name')}}\n *       </li>\n *     </ul>\n *\n * The value of the \"ngeo-sortable\" attribute is an expression which evaluates\n * to an array (an array of layers in the above example). This is the array\n * that is re-ordered after a drag-and-drop.\n *\n * The element with the class \"ngeo-sortable-handle\" is the \"drag handle\".\n * It is required.\n *\n * This directives uses `$watchCollection` to watch the \"sortable\" array. So\n * if some outside code adds/removes elements to/from the \"sortable\" array,\n * the \"ngeoSortable\" directive will pick it up.\n *\n * See our live example: [../examples/layerorder.html](../examples/layerorder.html)\n *\n * @htmlAttribute {Array.<ol.layer.Base>} ngeo-sortable The layers to sort.\n * @htmlAttribute {!ngeox.miscSortableOptions} ngeo-sortable-options The options.\n * @htmlAttribute {Function(angular.JQLite, Array)?} ngeo-sortable-callback\n *     Callback function called after the move end. The Function will be called\n *     with the element and the sort array as arguments.\n * @htmlAttribute {Object?} ngeo-sortable-callback-ctx Context to apply at\n *     the call of the callback function.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoSortable\n */\nexports.component_ = function($timeout) {\n  return {\n    restrict: 'A',\n    /**\n     * @param {angular.Scope} scope Scope.\n     * @param {angular.JQLite} element Element.\n     * @param {angular.Attributes} attrs Attributes.\n     */\n    link: (scope, element, attrs) => {\n\n      const sortable = /** @type {Array} */\n              (scope.$eval(attrs['ngeoSortable'])) || [];\n      googAsserts.assert(Array.isArray(sortable));\n\n      scope.$watchCollection(() => sortable, () => {\n        sortable.length && $timeout(resetUpDragDrop, 0);\n      });\n\n      const optionsObject = scope.$eval(attrs['ngeoSortableOptions']);\n      const options = getOptions(optionsObject);\n\n      const callbackFn = scope.$eval(attrs['ngeoSortableCallback']);\n      const callbackCtx = scope.$eval(attrs['ngeoSortableCallbackCtx']);\n\n      /**\n       * This function resets drag&drop for the list. It is called each\n       * time the sortable array changes (see $watchCollection above).\n       */\n      function resetUpDragDrop() {\n        // Add an index to the sortable to allow sorting of the\n        // underlying data.\n        const children = element.children();\n        for (let i = 0; i < children.length; ++i) {\n          angular.element(children[i]).data('idx', i);\n        }\n\n        const sortableElement = $(element);\n\n        // the element is already sortable; reset it.\n        if (sortableElement.data('ui-sortable')) {\n          sortableElement.off('sortupdate');\n          sortableElement.sortable('destroy');\n        }\n\n        const sortableOptions = {\n          'axis': 'y',\n          'classes': {\n            'ui-sortable-helper': options['draggerClassName']\n          }\n        };\n\n        // CSS class of the handle\n        if (options['handleClassName']) {\n          sortableOptions['handle'] = `.${options['handleClassName']}`;\n        }\n\n        // Placeholder for the item being dragged in the sortable list\n        if (options['placeholderClassName']) {\n          sortableOptions['placeholder'] = options['placeholderClassName'];\n          sortableOptions['forcePlaceholderSize'] = true;\n        }\n\n        sortableElement.sortable(sortableOptions);\n\n        // This event is triggered when the user stopped sorting and\n        // the DOM position (i.e. order in the sortable list) has changed.\n        sortableElement.on('sortupdate', (event, ui) => {\n          const oldIndex = $(ui.item[0]).data('idx');\n          const newIndex = ui.item.index();\n\n          // Update (data)-index on dom element to its new position\n          $(ui.item[0]).data('idx', newIndex);\n\n          // Move dragged item to new position\n          scope.$apply(() => {\n            sortable.splice(newIndex, 0, sortable.splice(oldIndex, 1)[0]);\n          });\n\n          // Call the callback function if it exists.\n          if (callbackFn instanceof Function) {\n            callbackFn.apply(callbackCtx, [element, sortable]);\n          }\n        });\n      }\n\n      /**\n       * @param {?} options Options after expression evaluation.\n       * @return {!ngeox.miscSortableOptions} Options object.\n       * @private\n       */\n      function getOptions(options) {\n        let ret;\n        const defaultHandleClassName = 'ngeo-sortable-handle';\n        if (options === undefined) {\n          ret = {'handleClassName': defaultHandleClassName};\n        } else {\n          if (options['handleClassName'] === undefined) {\n            options['handleClassName'] = defaultHandleClassName;\n          }\n          ret = /** @type {ngeox.miscSortableOptions} */ (options);\n        }\n        return ret;\n      }\n\n    }\n  };\n};\n\nexports.directive('ngeoSortable', exports.component_);\n\n\nexport default exports;\n","/**\n * @module ngeo.message.popoverComponent\n */\nimport 'bootstrap/js/tooltip.js';\nimport 'bootstrap/js/popover.js';\n\n/**\n * @type {angular.Module}\n */\nconst exports = angular.module('ngeoPopover', []);\n\n\n/**\n * Provides a directive used to display a Bootstrap popover.\n *\n *<div ngeo-popover>\n *  <a ngeo-popover-anchor class=\"btn btn-info\">anchor 1</a>\n *  <div ngeo-popover-content>\n *    <ul>\n *      <li>action 1:\n *        <input type=\"range\"/>\n *      </li>\n *    </ul>\n *  </div>\n *</div>\n * @ngdoc directive\n * @ngInject\n * @ngname ngeoPopover\n * @return {angular.Directive} The Directive Definition Object.\n */\nexports.component_ = function() {\n  return {\n    restrict: 'A',\n    scope: true,\n    controller: 'NgeoPopoverController as popoverCtrl',\n    link: (scope, elem, attrs, ngeoPopoverCtrl) => {\n      ngeoPopoverCtrl.anchorElm.on('hidden.bs.popover', () => {\n        /**\n         * @type {{inState : Object}}\n         */\n        const popover = ngeoPopoverCtrl.anchorElm.data('bs.popover');\n        popover['inState'].click = false;\n      });\n\n      ngeoPopoverCtrl.anchorElm.on('inserted.bs.popover', () => {\n        ngeoPopoverCtrl.bodyElm.show();\n        ngeoPopoverCtrl.shown = true;\n      });\n\n      ngeoPopoverCtrl.anchorElm.popover({\n        container: 'body',\n        html: true,\n        content: ngeoPopoverCtrl.bodyElm,\n        placement: attrs['ngeoPopoverPlacement'] || 'right'\n      });\n\n      if (attrs['ngeoPopoverDismiss']) {\n        $(attrs['ngeoPopoverDismiss']).on('scroll', () => {\n          ngeoPopoverCtrl.dismissPopover();\n        });\n      }\n\n      scope.$on('$destroy', () => {\n        ngeoPopoverCtrl.anchorElm.popover('destroy');\n        ngeoPopoverCtrl.anchorElm.unbind('inserted.bs.popover');\n        ngeoPopoverCtrl.anchorElm.unbind('hidden.bs.popover');\n      });\n    }\n  };\n};\n\n/**\n * @ngdoc directive\n * @ngInject\n * @ngname ngeoPopoverAnchor\n * @return {angular.Directive} The Directive Definition Object\n */\nexports.anchorComponent = function() {\n  return {\n    restrict: 'A',\n    require: '^^ngeoPopover',\n    link: (scope, elem, attrs, ngeoPopoverCtrl) => {\n      ngeoPopoverCtrl.anchorElm = elem;\n    }\n  };\n};\n\n/**\n * @ngdoc directive\n * @ngInject\n * @ngname ngeoPopoverContent\n * @return {angular.Directive} The Directive Definition Object\n */\nexports.contentComponent = function() {\n  return {\n    restrict: 'A',\n    require: '^^ngeoPopover',\n    link: (scope, elem, attrs, ngeoPopoverCtrl) => {\n      ngeoPopoverCtrl.bodyElm = elem;\n      elem.hide();\n    }\n  };\n};\n\n/**\n * The controller for the 'popover' directive.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname NgeoPopoverController\n * @param {angular.Scope} $scope Scope.\n */\nexports.PopoverController_ = function($scope) {\n  /**\n   * The state of the popover (displayed or not)\n   * @type {boolean}\n   * @export\n   */\n  this.shown = false;\n\n  /**\n   * @type {angular.JQLite|undefined}\n   * @export\n   */\n  this.anchorElm = undefined;\n\n  /**\n   * @type {angular.JQLite|undefined}\n   * @export\n   */\n  this.bodyElm = undefined;\n\n  function onMouseDown(clickEvent) {\n    if (this.anchorElm[0] !== clickEvent.target &&\n      this.bodyElm.parent()[0] !== clickEvent.target &\n      this.bodyElm.parent().find(clickEvent.target).length === 0 && this.shown) {\n      this.dismissPopover();\n    }\n  }\n\n  angular.element('body').on('mousedown', onMouseDown.bind(this));\n\n  $scope.$on('$destroy', () => {\n    angular.element('body').off('mousedown', onMouseDown);\n  });\n};\n\n\n/**\n * Dissmiss popover function\n * @export\n */\nexports.PopoverController_.prototype.dismissPopover = function() {\n  this.shown = false;\n  this.anchorElm.popover('hide');\n};\n\n\nexports.controller('NgeoPopoverController', exports.PopoverController_);\nexports.directive('ngeoPopover', exports.component_);\nexports.directive('ngeoPopoverAnchor', exports.anchorComponent);\nexports.directive('ngeoPopoverContent', exports.contentComponent);\n\n\nexport default exports;\n","/**\n * @module gmf.search.component\n */\nimport gmfBase from 'gmf/index.js';\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfSearchFulltextSearch from 'gmf/search/FulltextSearch.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMiscAutoProjection from 'ngeo/misc/AutoProjection.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscColorpickerComponent from 'ngeo/misc/colorpickerComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMessagePopoverComponent from 'ngeo/message/popoverComponent.js';\n\nimport ngeoSearchModule from 'ngeo/search/module.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olColor from 'ol/color.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport * as olObj from 'ol/obj.js';\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport * as olProj from 'ol/proj.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleRegularShape from 'ol/style/RegularShape.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\nimport * as olUri from 'ol/uri.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfSearch', [\n  gmfLayertreeTreeManager.module.name,\n  gmfSearchFulltextSearch.module.name,\n  gmfThemeThemes.module.name,\n  ngeoMiscAutoProjection.module.name,\n  ngeoMiscColorpickerComponent.name,\n  ngeoSearchModule.name,\n  ngeoMapFeatureOverlayMgr.module.name,\n  ngeoMessagePopoverComponent.name,\n]);\n\n\n/**\n * @param {angular.JQLite} element Element.\n * @param {angular.Attributes} attrs Attributes.\n * @return {string} Template URL.\n */\nexports.gmfSearchTemplateUrl_ = (element, attrs) => {\n  const templateUrl = attrs['gmfSearchTemplateurl'];\n  return templateUrl !== undefined ? templateUrl :\n    'gmf/search';\n};\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/search', require('./component.html'));\n});\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfSearchTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfSearchTemplateUrl($element, $attrs, gmfSearchTemplateUrl) {\n  return gmfSearchTemplateUrl($element, $attrs);\n}\n\n\n/**\n * A component that allows to search and recenter on a selected\n * result's feature.\n * It can search in multiple GeoJSON datasources.\n * It can filter and group results by a feature's property.\n *\n * This component uses the {@link ngeo.map.FeatureOverlayMgr} to create a\n * feature overlay for drawing features on the map. The application\n * is responsible to initialize the {@link ngeo.map.FeatureOverlayMgr}\n * with the map.\n *\n * Example flat results:\n *\n *      <gmf-search gmf-search-map=\"::ctrl.map\"\n *        gmf-search-options=\"::ctrl.searchOptions\"\n *        gmf-search-styles=\"::ctrl.searchStyles\"\n *        gmf-search-datasources=\"::ctrl.searchDatasources\"\n *        gmf-search-coordinatesprojections=\"::ctrl.searchCoordinatesProjections\">\n *      </gmf-search>\n *      <script>\n *        (function() {\n *          let module = angular.module('app');\n *          module.value('fulltextsearchUrl', '${request.route_url('fulltextsearch', _query={\"limit\": 20}) | n}');\n *          module.value('gmfSearchGroups', []);\n *          module.constant('gmfSearchActions', [\n *                {action: 'add_theme', title: 'Add a theme'},\n *                {action: 'add_group', title: 'Add a sub theme'},\n *                {action: 'add_layer', title: 'Add a layer'}\n *          ]);\n *        })();\n *      </script>\n *\n * Example with categories:\n *\n *      <gmf-search gmf-search-map=\"::ctrl.map\"\n *        gmf-search-options=\"::ctrl.searchOptions\"\n *        gmf-search-styles=\"::ctrl.searchStyles\"\n *        gmf-search-datasources=\"::ctrl.searchDatasources\"\n *        gmf-search-coordinatesprojections=\"::ctrl.searchCoordinatesProjections\">\n *      </gmf-search>\n *      <script>\n *        (function() {\n *          let module = angular.module('app');\n *          module.value('fulltextsearchUrl', '${request.route_url('fulltextsearch', _query={\"limit\": 30, \"partitionlimit\": 5}) | n}');\n *          module.value('gmfSearchGroups', ${dumps(fulltextsearch_groups) | n});\n *          module.value('gmfSearchActions', []);\n *        })();\n *     </scriptrchUrl' value in the examples above set three \"_query\" parameters: \"limit\",\n *\n * The 'fulltextsearchUrl' value in the examples above set three \"_query\" parameters: \"limit\",\n * \"partitionlimit\" and \"ranksystem\". For this last one \"ts_rank_cd\" is the only effective value. It's used to\n * order your search results with the \"ts_rank_cd\" ranking system from PostgreSQL module pg_trgm. Without\n * this value, the PostgreSQL function \"similarity\" (module pg_trgm) is used for the ranking. Read the\n * full-text search c2cgeoportal documentation to know more.\n * You can also add these parameters to the \"url\" variable of one (or more) of the\n * gmfx.SearchDirectiveDatasource given to this component (here within the \"ctrl.searchDatasources\"). That\n * allows you to have multiples configurations on one search component.\n *\n * @htmlAttribute {string} gmf-search-input-value The input value (read only).\n * @htmlAttribute {ol.Map} gmf-search-map The map.\n * @htmlAttribute {TypeaheadOptions|undefined} gmf-search-options Addition Typeahead options.\n * @htmlAttribute {gmfx.SearchComponentDatasource} gmf-search-datasource\n *      The datasources.\n * @htmlAttribute {Object.<string, ol.style.Style>}\n *      gmf-search-styles A map of styles to apply on searched features. Keys\n *      must be the 'layer_name' property of features except for coordinates\n *      where the key ifor its style is the value of the constant\n *      'gmf.COORDINATES_LAYER_NAME'. The 'default' key is used to apply the\n *      default style.\n * @htmlAttribute {Array.<string>} gmf-search-coordinatesprojections codes\n *      of supported projections for coordinates search (projections must be\n *      defined in ol3). If not provided, only the map's view projection\n *      format will be supported.\n * @htmlAttribute {ngeox.SearchComponentListeners} gmf-search-listeners\n *      The listeners.\n * @htmlAttribute {boolean=} gmf-search-clearbutton Optional clear button in the input search. Default to true.\n * @htmlAttribute {number=} gmf-search-delay Optional bloodhound request delay in ms. Default to 50 ms.\n * @htmlAttribute {boolean=} gmf-search-colorchooser Optional. Whether to let the user\n *      change the style of the feature on the map. Default is false.\n * @htmlAttribute {number=} gmf-search-maxzoom Optional maximum zoom we will zoom on result, default is 16.\n * @htmlAttribute {function=} gmf-search-on-init Optional function called when the component is initialized.\n * @ngdoc component\n * @ngname gmfSearch\n */\nexports.component_ = {\n  bindings: {\n    'inputValue': '=?gmfSearchInputValue',\n    'placeholder': '@?gmfSearchPlaceholder',\n    'map': '<gmfSearchMap',\n    'datasources': '<gmfSearchDatasources',\n    'typeaheadOptions': '<?gmfSearchOptions',\n    'featuresStyles': '<?gmfSearchStyles',\n    'clearButton': '=?gmfSearchClearbutton',\n    'colorChooser': '<?gmfSearchColorchooser',\n    'coordinatesProjections': '<?gmfSearchCoordinatesprojections',\n    'additionalListeners': '<gmfSearchListeners',\n    'maxZoom': '<?gmfSearchMaxzoom',\n    'delay': '<?gmfSearchDelay',\n    'onInitCallback': '<?gmfSearchOnInit'\n  },\n  controller: 'gmfSearchController',\n  templateUrl: gmfSearchTemplateUrl\n};\n\n\nexports.value('gmfSearchTemplateUrl', exports.gmfSearchTemplateUrl_);\n\n\n// Register the controller in the module\nexports.component('gmfSearch', exports.component_);\n\n\n/**\n * @private\n */\nexports.SearchController_ = class {\n\n  /**\n   * @private\n   * @param {jQuery} $element Element.\n   * @param {angular.Scope} $scope The component's scope.\n   * @param {angular.$compile} $compile Angular compile service.\n   * @param {angular.$timeout} $timeout Angular timeout service.\n   * @param {angular.$injector} $injector Main injector.\n   * @param {angularGettext.Catalog} gettextCatalog Gettext catalog.\n   * @param {ngeo.misc.AutoProjection} ngeoAutoProjection The ngeo coordinates service.\n   * @param {ngeo.search.createGeoJSONBloodhound.Function} ngeoSearchCreateGeoJSONBloodhound The ngeo\n   *     create GeoJSON Bloodhound service.\n   * @param {ngeo.map.FeatureOverlayMgr} ngeoFeatureOverlayMgr The ngeo feature\n   *     overlay manager service.\n   * @param {gmf.theme.Themes} gmfThemes gmf Themes service.\n   * @param {gmf.layertree.TreeManager} gmfTreeManager gmf Tree Manager service.\n   * @param {gmf.search.FulltextSearch} gmfSearchFulltextSearch gmf Full text search service.\n   * @ngInject\n   * @ngdoc controller\n   * @ngname GmfSearchController\n   */\n  constructor($element, $scope, $compile, $timeout, $injector,\n    gettextCatalog, ngeoAutoProjection, ngeoSearchCreateGeoJSONBloodhound,\n    ngeoFeatureOverlayMgr, gmfThemes, gmfTreeManager, gmfSearchFulltextSearch) {\n\n\n    /**\n     * @type {jQuery}\n     * @private\n     */\n    this.element_ = $element;\n\n    /**\n     * @type {angular.Scope}\n     * @private\n     */\n    this.scope_ = $scope;\n\n    /**\n     * @type {angular.$compile}\n     * @private\n     */\n    this.compile_ = $compile;\n\n    /**\n     * @type {angular.$timeout}\n     * @private\n     */\n    this.timeout_ = $timeout;\n\n    /**\n     * @type {angularGettext.Catalog}\n     * @private\n     */\n    this.gettextCatalog_ = gettextCatalog;\n\n    /**\n     * @type {gmf.theme.Themes}\n     * @private\n     */\n    this.gmfThemes_ = gmfThemes;\n\n    /**\n     * @type {gmf.layertree.TreeManager}\n     * @private\n     */\n    this.gmfTreeManager_ = gmfTreeManager;\n\n    /**\n     * @type {gmf.search.FulltextSearch}\n     * @private\n     */\n    this.fullTextSearch_ = gmfSearchFulltextSearch;\n\n    /**\n     * @type {ngeo.search.createGeoJSONBloodhound.Function}\n     * @private\n     */\n    this.ngeoSearchCreateGeoJSONBloodhound_ = ngeoSearchCreateGeoJSONBloodhound;\n\n    /**\n     * @type {ngeo.map.FeatureOverlayMgr}\n     * @private\n     */\n    this.ngeoFeatureOverlayMgr = ngeoFeatureOverlayMgr;\n\n    /**\n     * @type {ngeo.statemanager.Location|undefined}\n     * @private\n     */\n    this.ngeoLocation_;\n\n    if ($injector.has('ngeoLocation')) {\n      this.ngeoLocation_ = $injector.get('ngeoLocation');\n    }\n\n    /**\n     * @type {ngeo.misc.AutoProjection}\n     * @private\n     */\n    this.ngeoAutoProjection_ = ngeoAutoProjection;\n\n    /**\n     * @type {!ol.Map}\n     * @export\n     */\n    this.map;\n\n    /**\n     * @type {Object}\n     * @private\n     */\n    this.styles_ = {};\n\n    /**\n     * @type {function()}\n     * @export\n     */\n    this.onInitCallback;\n\n    /**\n     * Whether or not to show a button to clear the search text.\n     * Default to true.\n     * @type {boolean}\n     * @export\n     */\n    this.clearButton;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.colorChooser;\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.placeholder;\n\n    /**\n     * @type {number}\n     * @export\n     */\n    this.delay;\n\n    /**\n     * The maximum zoom we will zoom on result.\n     * @type {number}\n     * @export\n     */\n    this.maxZoom = 16;\n\n    /**\n     * Supported projections for coordinates search.\n     * @type {Array.<ol.proj.Projection>}\n     * @export\n     */\n    this.coordinatesProjections;\n\n    /**\n     * @type {ngeo.map.FeatureOverlay}\n     * @private\n     */\n    this.featureOverlay_ = ngeoFeatureOverlayMgr.getFeatureOverlay();\n\n    /**\n     * @type {Array.<gmfx.SearchComponentDatasource>}\n     * @export\n     */\n    this.datasources = [];\n\n    /**\n     * @type {TypeaheadOptions}\n     * @export\n     */\n    this.typeaheadOptions;\n\n    /**\n     * @type {TypeaheadOptions}\n     * @export\n     */\n    this.options = /** @type {TypeaheadOptions} */ ({\n      highlight: true\n    });\n\n    /**\n     * @type {Object.<string, ol.style.Style>}\n     * @export\n     */\n    this.featuresStyles;\n\n    /**\n     * @type {Array.<TypeaheadDataset>}\n     * @export\n     */\n    this.datasets = [];\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.inputValue = '';\n\n    /**\n     * @type {string}\n     * @export\n     */\n    this.color;\n\n    /**\n     * @type {boolean}\n     * @export\n     */\n    this.displayColorPicker = false;\n\n    /**\n     * @type {ngeox.SearchDirectiveListeners}\n     * @export\n     */\n    this.listeners;\n\n    /**\n     * @type {ngeox.SearchDirectiveListeners}\n     * @export\n     */\n    this.additionalListeners;\n  }\n\n\n  /**\n   * Called on initialization of the controller.\n   */\n  $onInit() {\n    const gettextCatalog = this.gettextCatalog_;\n    this.clearButton = this.clearButton !== false;\n    this.colorChooser = this.colorChooser === true;\n    if (this.delay === undefined) {\n      this.delay = 50;\n    }\n    this.placeholder = this.placeholder !== undefined ? this.placeholder :\n      gettextCatalog.getString('Search…');\n\n    // Init coordinates projections\n    let coordProj = this.coordinatesProjections;\n    if (coordProj === undefined) {\n      coordProj = [this.map.getView().getProjection()];\n    } else {\n      coordProj = this.ngeoAutoProjection_.getProjectionList(\n        /** @type {Array.<string>} */ (coordProj)\n      );\n    }\n    this.coordinatesProjections = coordProj;\n\n    if (!this.clearButton) {\n      // Empty the search field on focus and blur.\n      this.element_.find('input').on('focus blur', () => {\n        this.clear();\n      });\n    }\n\n    if (this.onInitCallback) {\n      this.onInitCallback();\n    }\n\n    this.initStyles_();\n\n    this.featureOverlay_.setStyle(this.getSearchStyle_.bind(this));\n\n    if (this.typeaheadOptions) {\n      olObj.assign(this.options, this.typeaheadOptions);\n    }\n\n    this.initDatasets_();\n\n    this.scope_.$watch(\n      () => this.color,\n      this.setStyleColor.bind(this)\n    );\n\n    this.listeners = this.mergeListeners_(\n      this.additionalListeners,\n      /** @type {ngeox.SearchDirectiveListeners} */ ({\n        select: this.select_.bind(this),\n        close: this.close_.bind(this),\n        datasetsempty: this.datasetsempty_.bind(this)\n      })\n    );\n\n    if (this.ngeoLocation_) {\n      const searchQuery = this.ngeoLocation_.getParam('search');\n      if (searchQuery) {\n        let resultIndex = 1;\n        if (this.ngeoLocation_.getParam('search-select-index')) {\n          resultIndex = parseInt(this.ngeoLocation_.getParam('search-select-index'), 10);\n        }\n        let mapZoom;\n        if (this.ngeoLocation_.getParam('search-maxzoom')) {\n          mapZoom = parseInt(this.ngeoLocation_.getParam('search-maxzoom'), 10);\n        } else if (this.ngeoLocation_.getParam('map_zoom')) {\n          mapZoom = parseInt(this.ngeoLocation_.getParam('map_zoom'), 10);\n        }\n        this.fulltextsearch_(searchQuery, resultIndex, mapZoom);\n      }\n    }\n  }\n\n\n  /**\n   * Merges the custom listeners received via the component attributes and the\n   * listeners that are needed for this controller to function (close and select).\n   * @param {ngeox.SearchDirectiveListeners} additionalListeners Custom provided\n   *    listeners.\n   * @param {ngeox.SearchDirectiveListeners} listeners Default listeners.\n   * @return {ngeox.SearchDirectiveListeners} Merged listeners.\n   * @private\n   */\n  mergeListeners_(additionalListeners, listeners) {\n    if (additionalListeners === undefined) {\n      return listeners;\n    }\n    return {\n      open: additionalListeners.open,\n      close: additionalListeners.close === undefined ?\n        listeners.close : function() {\n          listeners.close();\n          additionalListeners.close();\n        },\n      cursorchange: additionalListeners.cursorchange,\n      datasetsempty: additionalListeners.datasetsempty,\n      select: additionalListeners.select === undefined ?\n        listeners.select : function(evt, obj, dataset) {\n          listeners.select(evt, obj, dataset);\n          additionalListeners.select(evt, obj, dataset);\n        },\n      autocomplete: additionalListeners.autocomplete\n    };\n  }\n\n\n  /**\n   * Initialize datasets for the search\n   * @private\n   */\n  initDatasets_() {\n    const gettextCatalog = this.gettextCatalog_;\n    for (let i = 0; i < this.datasources.length; i++) {\n      const datasource = this.datasources[i];\n\n      /** @type {Array.<string>} */\n      const groupValues = datasource.groupValues !== undefined ? datasource.groupValues : [];\n      /** @type {Array.<string>} */\n      const groupActions = datasource.groupActions ? datasource.groupActions : [];\n      const filters = [];\n\n      if (groupValues.length === 0) {\n        filters.push({\n          'title': '',\n          'filter': this.filterLayername_()\n        });\n      } else {\n        groupValues.forEach(function(layerName) {\n          filters.push({\n            'title': layerName,\n            'filter': this.filterLayername_(layerName)\n          });\n        }, this);\n      }\n\n      groupActions.forEach(function(action) {\n        filters.push({\n          'title': gettextCatalog.getString(action['title']),\n          'filter': this.filterAction_(action['action'])\n        });\n      }, this);\n\n      filters.forEach(function(filter) {\n        this.datasets.push(this.createDataset_({\n          bloodhoundOptions: datasource.bloodhoundOptions,\n          datasetTitle: filter['title'],\n          groupsKey: 'layer_name',\n          labelKey: datasource.labelKey,\n          projection: datasource.projection,\n          typeaheadDatasetOptions: datasource.typeaheadDatasetOptions,\n          url: datasource.url\n        }, filter['filter']));\n      }, this);\n    }\n\n    // For searching coordinates\n    this.datasets.push({\n      source: this.createSearchCoordinates_(this.map.getView()),\n      name: 'coordinates',\n      display: 'label',\n      templates: {\n        header: () => {\n          const header = gettextCatalog.getString('Recenter to');\n          return `<div class=\"gmf-search-header\" translate>${header}</div>`;\n        },\n        suggestion: (suggestion) => {\n          const coordinates = suggestion['label'];\n\n          let html = `<p class=\"gmf-search-label\">${coordinates}</p>`;\n          html = `<div class=\"gmf-search-datum\">${html}</div>`;\n          return html;\n        }\n      }\n    });\n  }\n\n\n  /**\n   * @param {gmfx.SearchComponentDatasource} config The config of the dataset.\n   * @param {(function(GeoJSONFeature): boolean)=} opt_filter A filter function\n   *     based on a GeoJSONFeaturesCollection's array.\n   * @return {TypeaheadDataset} A typeahead dataset.\n   * @private\n   */\n  createDataset_(config, opt_filter) {\n    const gettextCatalog = this.gettextCatalog_;\n    const componentScope = this.scope_;\n    const compile = this.compile_;\n    const bloodhoundEngine = this.createAndInitBloodhound_(config, opt_filter);\n    const typeaheadDataset = /** @type {TypeaheadDataset} */ ({\n      limit: Infinity,\n      source: bloodhoundEngine.ttAdapter(),\n      display: (suggestion) => {\n        const feature = /** @type {ol.Feature} */ (suggestion);\n        return feature.get(config.labelKey);\n      },\n      templates: /* TypeaheadTemplates */ ({\n        header: () => {\n          if (config.datasetTitle === undefined) {\n            return '';\n          } else {\n            const header = gettextCatalog.getString(config.datasetTitle);\n            return `<div class=\"gmf-search-header\">${header}</div>`;\n          }\n        },\n        suggestion: (suggestion) => {\n          const feature = /** @type {ol.Feature} */ (suggestion);\n\n          const scope = componentScope.$new(true);\n          scope['feature'] = feature;\n\n          let html = `<p class=\"gmf-search-label\" translate>${\n            feature.get(config.labelKey)}</p>`;\n          html += `<p class=\"gmf-search-group\" translate>${feature.get('layer_name') ||\n                  config.datasetTitle}</p>`;\n          html = `<div class=\"gmf-search-datum\">${html}</div>`;\n          return compile(html)(scope);\n        }\n      })\n    });\n    if (config.typeaheadDatasetOptions) {\n      olObj.assign(typeaheadDataset, config.typeaheadDatasetOptions);\n    }\n    return typeaheadDataset;\n  }\n\n\n  /**\n   * @param {string} action The action to keep.\n   * @return {(function(GeoJSONFeature): boolean)} A filter function based on a\n   *     GeoJSONFeaturesCollection's array.\n   * @private\n   */\n  filterAction_(action) {\n    return (\n    /**\n         * @param {GeoJSONFeature} feature\n         * @return {boolean}\n         */\n      function(feature) {\n        const properties = feature['properties'];\n        if (properties['actions']) {\n          // result is an action (add_theme, add_group, ...)\n          // add it to the corresponding group\n          return !properties['layer_name'] && properties['actions'].some(act => act.action === action);\n        } else {\n          return false;\n        }\n      }\n    );\n  }\n\n\n  /**\n   * @param {string=} opt_layerName The layerName to keep. If null, keep all layers\n   *     (In all cases, except actions layers).\n   * @return {(function(GeoJSONFeature): boolean)} A filter function based on a\n   *     GeoJSONFeaturesCollection's array.\n   * @private\n   */\n  filterLayername_(opt_layerName) {\n    return (\n    /**\n         * @param {GeoJSONFeature} feature\n         * @return {boolean}\n         */\n      function(feature) {\n        const featureLayerName = feature['properties']['layer_name'];\n        // Keep only layers with layer_name (don't keep action layers).\n        if (featureLayerName === undefined) {\n          return false;\n        }\n        if (opt_layerName === undefined) {\n          return true;\n        }\n        return featureLayerName === opt_layerName;\n      }\n    );\n  }\n\n\n  /**\n   * @param {gmfx.SearchComponentDatasource} config The config of the dataset.\n   * @param {(function(GeoJSONFeature): boolean)=} opt_filter Afilter function\n   *     based on a GeoJSONFeaturesCollection's array.\n   * @return {Bloodhound} The bloodhound engine.\n   * @private\n   */\n  createAndInitBloodhound_(config, opt_filter) {\n    const mapProjectionCode = this.map.getView().getProjection().getCode();\n    const remoteOptions = this.getBloodhoudRemoteOptions_();\n    const bloodhound = this.ngeoSearchCreateGeoJSONBloodhound_(config.url, opt_filter,\n      olProj.get(mapProjectionCode), olProj.get(config.projection),\n      config.bloodhoundOptions, remoteOptions);\n    bloodhound.initialize();\n    return bloodhound;\n  }\n\n\n  /**\n   * @return {BloodhoundRemoteOptions} Options.\n   * @private\n   */\n  getBloodhoudRemoteOptions_() {\n    const gettextCatalog = this.gettextCatalog_;\n    return {\n      rateLimitWait: this.delay,\n      prepare: (query, settings) => {\n        const url = settings.url;\n        const lang = gettextCatalog.currentLanguage;\n        settings.xhrFields = {\n          withCredentials: true\n        };\n        settings.url = olUri.appendParams(url, {\n          'query': query,\n          'lang': lang,\n        });\n        return settings;\n      }\n    };\n  }\n\n\n  /**\n   * @param {ol.View} view View.\n   * @return {function(string, function(Object))} function defining parameters for the search suggestions.\n   * @private\n   */\n  createSearchCoordinates_(view) {\n    const viewProjection = view.getProjection();\n    const extent = viewProjection.getExtent();\n    return function(query, callback) {\n      const suggestions = [];\n      const coordinates = this.ngeoAutoProjection_.stringToCoordinates(query);\n      if (coordinates === null) {\n        return;\n      }\n      const position = this.ngeoAutoProjection_.tryProjectionsWithInversion(coordinates,\n        extent, viewProjection, this.coordinatesProjections);\n      if (position === null) {\n        return;\n      }\n      suggestions.push({\n        label: coordinates.join(' '),\n        position: position,\n        'tt_source': 'coordinates'\n      });\n      callback(suggestions);\n    }.bind(this);\n  }\n\n\n  /**\n   * Init the style object for the search results. It set defaults for the\n   * coordinates and the polygon styles, and both can be overloaded from component\n   * attributes. The styles from component attributes can specify custom styles\n   * for each search group.\n   * @private\n   */\n  initStyles_() {\n    this.styles_[gmfBase.COORDINATES_LAYER_NAME] = new olStyleStyle({\n      image: new olStyleRegularShape({\n        stroke: new olStyleStroke({color: [0, 0, 0, 0.7], width: 2}),\n        points: 4,\n        radius: 8,\n        radius2: 0,\n        angle: 0\n      })\n    });\n    const fill = new olStyleFill({\n      color: [65, 134, 240, 0.5]\n    });\n    const stroke = new olStyleStroke({\n      color: [65, 134, 240, 1],\n      width: 2\n    });\n    this.styles_['default'] = new olStyleStyle({\n      fill: fill,\n      image: new olStyleCircle({\n        fill: fill,\n        radius: 5,\n        stroke: stroke\n      }),\n      stroke: stroke\n    });\n    const customStyles = this.featuresStyles || {};\n    olObj.assign(this.styles_, customStyles);\n  }\n\n  /**\n   * Style for search results.\n   * @param {null|ol.Feature|ol.render.Feature} feature The searched feature.\n   * @param {number} resolution The current resolution of the map.\n   * @return {ol.style.Style} A style for this kind of features.\n   * @private\n   */\n  getSearchStyle_(feature, resolution) {\n    googAsserts.assert(feature);\n    const style = this.styles_[feature.get('layer_name')] || this.styles_['default'];\n    if (this.color) {\n      const color = olColor.asArray(this.color);\n\n      const strokeColor = color.slice();\n      // 100% opacity for the stroke color\n      strokeColor[3] = 1;\n\n      const fillColor = color.slice();\n      // 50% opacity for the fill color\n      fillColor[3] = 0.5;\n\n      const strokeStyle = style.getStroke();\n      if (strokeStyle) {\n        strokeStyle.setColor(strokeColor);\n      }\n      const fillStyle = style.getFill();\n      if (fillStyle) {\n        fillStyle.setColor(fillColor);\n      }\n      // the image style can't be changed in place, the colors are updated on a clone.\n      let imageStyle = style.getImage();\n      if (imageStyle) {\n        imageStyle = imageStyle.clone();\n        const imageStrokeStyle = imageStyle.getStroke();\n        if (imageStrokeStyle) {\n          imageStrokeStyle.setColor(strokeColor);\n        }\n        const imageFillStyle = imageStyle.getFill();\n        if (imageFillStyle) {\n          imageFillStyle.setColor(fillColor);\n        }\n        style.setImage(imageStyle);\n      }\n    }\n    return style;\n  }\n\n  /**\n   * Set a new color for the search feature style.\n   * @param {string} color The color to set.\n   * @export\n   */\n  setStyleColor(color) {\n    if (color) {\n      this.color = color;\n      this.ngeoFeatureOverlayMgr.getLayer().changed();\n    }\n  }\n\n  /**\n   * @private\n   */\n  setTTDropdownVisibility_() {\n    if (this.clearButton) {\n      const ttDropdown = this.element_.find('.twitter-typeahead .tt-menu');\n      (this.inputValue) ? ttDropdown.show() : ttDropdown.hide();\n    }\n  }\n\n\n  /**\n   * @export\n   */\n  onClearButton() {\n    this.featureOverlay_.clear();\n    this.clear();\n  }\n\n\n  /**\n   * @export\n   */\n  clear() {\n    const typeahead = this.element_.find('.twitter-typeahead');\n    const ttmenu = typeahead.children('.tt-menu');\n    const inputs = typeahead.children('input');\n    // clear model value, the 'real' input value and tt's suggestions\n    this.inputValue = '';\n    $(inputs[1]).typeahead('val', '');\n    ttmenu.children('.tt-dataset').empty();\n    this.setTTDropdownVisibility_();\n    this.displayColorPicker = false;\n  }\n\n\n  /**\n   * @export\n   */\n  blur() {\n    const typeahead = this.element_.find('.twitter-typeahead');\n    const inputs = typeahead.children('input');\n    // Blur as soon as possible in digest loops\n    this.timeout_(() => {\n      $(inputs[1]).blur();\n    });\n  }\n\n\n  /**\n   * @param {jQuery.Event} event Event.\n   * @param {Object|ol.Feature} suggestion Suggestion.\n   * @param {TypeaheadDataset} dataset Dataset.\n   * @private\n   */\n  select_(event, suggestion, dataset) {\n    if (suggestion['tt_source'] === 'coordinates') {\n      const geom = new olGeomPoint(suggestion['position']);\n\n      this.featureOverlay_.clear();\n      this.featureOverlay_.addFeature(new olFeature({\n        geometry: geom,\n        'layer_name': gmfBase.COORDINATES_LAYER_NAME\n      }));\n      this.map.getView().setCenter(suggestion['position']);\n      this.leaveSearch_();\n    } else {\n      googAsserts.assertInstanceof(suggestion, olFeature);\n      this.selectFromGMF_(event, suggestion, dataset);\n    }\n  }\n\n\n  /**\n   * @param {jQuery.Event} event Event.\n   * @param {ol.Feature} feature Feature.\n   * @param {TypeaheadDataset} dataset Dataset.\n   * @private\n   */\n  selectFromGMF_(event, feature, dataset) {\n    const actions = feature.get('actions');\n    const featureGeometry = /** @type {ol.geom.SimpleGeometry} */\n        (feature.getGeometry());\n    if (actions) {\n      for (let i = 0, ii = actions.length; i < ii; i++) {\n        const action = actions[i];\n        const actionName = action['action'];\n        const actionData = action['data'];\n        if (actionName == 'add_theme') {\n          this.gmfThemes_.getThemesObject().then((themes) => {\n            const theme = gmfThemeThemes.findThemeByName(themes, actionData);\n            if (theme) {\n              this.gmfTreeManager_.addFirstLevelGroups(theme.children);\n            }\n          });\n        } else if (actionName == 'add_group') {\n          this.gmfTreeManager_.addGroupByName(actionData, true);\n        } else if (actionName == 'add_layer') {\n          const groupActions = /** @type {Array.<string>} */ (\n            this.datasources[0].groupActions);\n          let datasourcesActionsHaveAddLayer;\n          groupActions.forEach((groupAction) => {\n            if (groupAction['action'] === 'add_layer') {\n              return datasourcesActionsHaveAddLayer = true;\n            }\n          });\n          if (datasourcesActionsHaveAddLayer) {\n            const silent = !!featureGeometry;\n            this.gmfTreeManager_.addGroupByLayerName(actionData, true, silent);\n          }\n        }\n      }\n    }\n\n    const size = this.map.getSize();\n    if (featureGeometry && size) {\n      const view = this.map.getView();\n      this.featureOverlay_.clear();\n      this.featureOverlay_.addFeature(feature);\n      this.displayColorPicker = true;\n      const fitArray = featureGeometry.getType() === 'GeometryCollection' ?\n        featureGeometry.getExtent() : featureGeometry;\n      view.fit(fitArray, {\n        size: size,\n        maxZoom: this.maxZoom\n      });\n    }\n    this.leaveSearch_();\n  }\n\n\n  /**\n   * @private\n   */\n  leaveSearch_() {\n    if (!this.clearButton) {\n      this.clear();\n    }\n    this.blur();\n  }\n\n\n  /**\n   * @param {jQuery.Event} event Event.\n   * @private\n   */\n  close_(event) {\n    if (!this.clearButton) {\n      this.setTTDropdownVisibility_();\n    }\n  }\n\n\n  /**\n   * @param {jQuery.Event} event Event.\n   * @param {string} query Query.\n   * @param {boolean} empty Empty.\n   * @private\n   */\n  datasetsempty_(event, query, empty) {\n    // workaround to display a 'no result found' in the search result when all of\n    // the datasets are empty.\n    // based on https://github.com/twitter/typeahead.js/issues/780#issuecomment-251554452\n    // FIXME: remove this workaround when https://github.com/corejavascript/typeahead.js/issues/60 is fixed\n\n    const menu = this.element_.find('.twitter-typeahead .tt-menu');\n    const message = menu.children('.gmf-search-no-results');\n    if (message.length == 0) {\n      const div = $('<div class=\"gmf-search-no-results\" translate>No result found</div>');\n      menu.append(div);\n    }\n    if (empty) {\n      message.show();\n      menu.addClass('gmf-search-no-results');\n    } else {\n      menu.removeClass('gmf-search-no-results');\n      message.hide();\n    }\n  }\n\n\n  /**\n   * Performs a full-text search and centers the map on the first search result.\n   * @param {string} query Search query.\n   * @param {number} resultIndex Return nth result instead.\n   * @param {number=} opt_zoom Optional zoom level.\n   * @private\n   */\n  fulltextsearch_(query, resultIndex, opt_zoom) {\n    if (resultIndex < 1) { // can't be lower than one\n      resultIndex = 1;\n    }\n    this.fullTextSearch_.search(query, {'limit': resultIndex})\n      .then((data) => {\n        if (data && data.features[resultIndex - 1]) {\n          const format = new olFormatGeoJSON();\n          const feature = format.readFeature(data.features[resultIndex - 1]);\n          this.featureOverlay_.addFeature(feature);\n          const fitOptions = /** @type {olx.view.FitOptions} */ ({});\n          if (opt_zoom !== undefined) {\n            fitOptions.maxZoom = opt_zoom;\n            fitOptions.size = this.map.getSize();\n          }\n          this.map.getView().fit(feature.getGeometry().getExtent(), fitOptions);\n          this.inputValue = /** @type {string} */ (feature.get('label'));\n        }\n      });\n  }\n};\n\n\n// Register the controller in the module\nexports.controller('gmfSearchController', exports.SearchController_);\n\n\nexport default exports;\n","/**\n * @module ngeo.map.recenter\n */\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoRecenter', []);\n\n/**\n * Provides the \"ngeoRecenter\" directive, a widget for recentering a map\n * to a specific extent (by using `ngeo-extent`) or a specific zoom level\n * (by using `ngeo-zoom`).\n *\n * Example:\n *\n *      <div ngeo-recenter ngeo-recenter-map=\"::ctrl.map\">\n *        <a href=\"#\" ngeo-extent=\"[-1898084, 4676723, 3972279, 8590299]\">A</a>\n *        <a href=\"#\" ngeo-extent=\"[727681, 5784754, 1094579, 6029353]\">B</a>\n *        <a href=\"#\" ngeo-zoom=\"1\">Zoom to level 1</a>\n *      </div>\n *\n * Or with a select:\n *\n *      <select ngeo-recenter ngeo-recenter-map=\"::ctrl.map\">\n *        <option ngeo-extent=\"[-1898084, 4676723, 3972279, 8590299]\">A</option>\n *        <option ngeo-extent=\"[727681, 5784754, 1094579, 6029353]\">B</option>\n *      </select>\n *\n * See our live example: [../examples/recenter.html](../examples/recenter.html)\n *\n * @htmlAttribute {ol.Map} ngeo-recenter-map The map.\n * @return {angular.Directive} Directive Definition Object.\n * @ngdoc directive\n * @ngname ngeoRecenter\n */\nexports.directive_ = function() {\n  return {\n    restrict: 'A',\n    link: ($scope, $element, $attrs) => {\n      const mapExpr = $attrs['ngeoRecenterMap'];\n      const map = /** @type {ol.Map} */ ($scope.$eval(mapExpr));\n\n      function recenter(element) {\n        const extent = element.attr('ngeo-extent');\n        if (extent !== undefined) {\n          const size = /** @type {ol.Size} */ (map.getSize());\n          map.getView().fit($scope.$eval(extent), {size});\n        }\n        const zoom = element.attr('ngeo-zoom');\n        if (zoom !== undefined) {\n          map.getView().setZoom($scope.$eval(zoom));\n        }\n      }\n\n      // if the children is a link or button\n      $element.on('click', '*', function(event) {\n        recenter(angular.element($(this)));\n      });\n\n      // if the children is an option inside a select\n      $element.on('change', (event) => {\n        const selected = event.target.options[event.target.selectedIndex];\n        recenter(angular.element(selected));\n      });\n\n    }\n  };\n};\n\n// Register the directive in the module\nexports.directive('ngeoRecenter', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.misc.syncArrays\n */\nimport googAsserts from 'goog/asserts.js';\n\n/**\n * Provides a function that synchronizes two arrays, arr1 and\n * arr2. arr2 is a subset of arr1, it includes the elements of arr1 that passes\n * the filter. When elements are added to/removed from arr1, arr2 is updated to\n * include the elements of arr1 that pass the filter. When the order of\n * elements in arr2 changes, arr1 is reordered to have the same order as arr2.\n *\n * This can for example be used to synchronize the array of layers in the map\n * with the array of selected layers, where layers may be added to/removed from\n * the map, and the order of selected layers may change.\n *\n *     let dereg = ngeoSyncArrays(map.getLayers().getArray(), selectedLayers,\n *         true, scope, function(layer) {\n *           // exclude the layer at index 0 in the map\n *           return map.getLayers().indexOf(layer) !== 0;\n *         });\n *\n * This will return a function that can be called to cancel synchronization.\n *\n * @param {Array.<T>} arr1 Array 1.\n * @param {Array.<T>} arr2 Array 2.\n * @param {boolean} reverse `true` if arr2 is in reverse order, `false`\n *     otherwise.\n * @param {angular.Scope} scope Angular scope. Used to watch arr1 and arr2\n *     using $watchCollection.\n * @param {function(T):boolean} filter Filter function.\n * @return {function()} Function to call to stop synchronization\n * @template T\n */\nconst exports = function(arr1, arr2, reverse, scope, filter) {\n\n\n  // Update arr2 when elements are added to, or removed from, arr1.\n\n  const dereg1 = scope.$watchCollection(() => arr1, () => {\n    let i, ii, j;\n    if (reverse) {\n      for (i = arr1.length - 1, j = 0; i >= 0; --i) {\n        if (filter(arr1[i])) {\n          arr2[j++] = arr1[i];\n        }\n      }\n    } else {\n      for (i = 0, ii = arr1.length, j = 0; i < ii; ++i) {\n        if (filter(arr1[i])) {\n          arr2[j++] = arr1[i];\n        }\n      }\n    }\n    arr2.length = j;\n  });\n\n\n  // Update arr1 when the order of elements changes in arr2.\n\n  const dereg2 = scope.$watchCollection(() => arr2, () => {\n    let i, ii, j;\n    if (reverse) {\n      for (i = 0, ii = arr1.length, j = arr2.length - 1; i < ii; ++i) {\n        if (filter(arr1[i])) {\n          arr1[i] = arr2[j--];\n        }\n      }\n      googAsserts.assert(j == -1);\n    } else {\n      for (i = 0, ii = arr1.length, j = 0; i < ii; ++i) {\n        if (filter(arr1[i])) {\n          arr1[i] = arr2[j++];\n        }\n      }\n      googAsserts.assert(j == arr2.length);\n    }\n  });\n\n  return function() {\n    dereg1();\n    dereg2();\n  };\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.layertree.component\n */\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\n\nimport 'bootstrap/js/collapse.js'; // needed to collapse a layertree\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('ngeoLayertree', [\n  ngeoLayertreeController.module.name\n]);\n\n\nexports.value('ngeoLayertreeTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoLayertreeTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/layertree';\n  });\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('ngeo/layertree', require('./component.html'));\n});\n\n\n/**\n * Provides the \"ngeoLayertree\" directive, a directive for\n * creating layer trees in application.\n *\n * The directive assumes that tree nodes that are not leaves have a \"children\"\n * property referencing an array of child nodes.\n *\n * Example:\n *\n *      <div ngeo-layertree=\"ctrl.tree\"\n *        ngeo-layertree-map=\"ctrl.map\"\n *        ngeo-layertree-nodelayer=\"ctrl.getLayer(node)\"\n *        ngeo-layertree-listeners=\"ctrl.listeners(treeScope, treeCtrl)\">\n *      </div>\n *\n * The \"ngeo-layertree\", \"ngeo-layertree-map\" and\n * \"ngeo-layertree-nodelayer\" attributes are mandatory attributes.\n *\n * - \"ngeo-layertree\" specifies an expression providing the tree. The\n *   directive watches that expression, making it possible to retrieve\n *   the tree data through Ajax.\n *\n * - \"ngeo-layertree-map\" specifies an expression providing the OpenLayers\n *   map. The directive doesn't watch that expression.\n *\n * - The \"ngeo-layertree-nodelayer\" specifies an expression providing the\n *   layer for a given node. In most cases that expression will be function\n *   call with \"node\" as the argument to the function call. E.g.\n *   \"ngeo-layertree-nodelayer=\"ctrl.getLayer(node)\".\n *\n * - The \"ngeo-layertree-listeners\" specifies an expression providing a function\n *   to bind scope events to customs functions. You'll must set the listener on\n *   the \"treeScope\" and probably use \"treeCtrl\" as context. E.g.\n *   \"ngeo-layertree-listeners=\"ctrl.listeners(treeScope, treeCtrl)\".\n *\n * The directive comes with a default template. That template assumes that\n * tree nodes that are not leaves have a \"children\" property referencing an\n * array of child nodes. It also assumes that nodes have a \"name\" property.\n *\n * By default the directive uses \"layertree.html\" as its templateUrl. This\n * can be changed by redefining the \"ngeoLayertreeTemplateUrl\" value (using\n * app.module.value('ngeoLayertreeTemplateUrl', 'path/layertree.html'), or\n * by adding an \"ngeo-layertree-templateurl\" attribute to the element.\n *\n * Example:\n *\n *      <div ngeo-layertree=\"ctrl.tree\"\n *        ngeo-layertree-templateurl=\"path/to/layertree.html\"\n *        ngeo-layertree-map=\"ctrl.map\"\n *        ngeo-layertree-nodelayer=\"ctrl.getLayer(node)\"\n *        ngeo-layertree-listeners=\"ctrl.listeners(treeScope, treeCtrl)\"\n *      </div>\n *\n * The directive has its own scope, but it is not an isolate scope. That scope\n * has a \"layertreeCtrl\" property which is a reference to the directive's\n * controller: \"layertreeCtrl\". You can refer to that property in a custom\n * template for example.\n *\n * See our live example: [../examples/layertree.html](../examples/layertree.html)\n *\n * @htmlAttribute {Object} ngeo-layertree One theme (JSON).\n * @htmlAttribute {string} ngeo-layertree-templateurl The template URL.\n * @htmlAttribute {ol.Map} ngeo-layertree-map The map.\n * @htmlAttribute {string} ngeo-layertree-nodelayer Expression that will be parsed\n *      to be a {@link Function} that return a {@link ol.layer.Layer}\n *      with the argument:\n *      {\n *          'node': {@link Object}|undefined,\n *          'depth': {@link number}\n *      }\n * @htmlAttribute {string} ngeo-layertree-nodelayerexpr Expression that will be parsed\n *      to be a {@link ngeo-layertree-nodelayer}.\n * @htmlAttribute {string} ngeo-layertree-listeners Expression that will be parsed\n *      to be a {@link Function} with the argument:\n *      {\n *          'treeScope': !{@link angular.Scope},\n *          'treeCtrl': {@link ngeo.layertree.Controller}\n *      }\n * @htmlAttribute {string} ngeo-layertree-listenersexpr Expression that will be parsed\n *      to be a {@link ngeo-layertree-listeners}.\n * @param {string|function(!angular.JQLite=, !angular.Attributes=)}\n *     ngeoLayertreeTemplateUrl Template URL for the directive.\n * @return {angular.Directive} The Directive Definition Object.\n * @ngInject\n * @ngdoc directive\n * @ngname ngeoLayertree\n */\nexports.directive_ = function(ngeoLayertreeTemplateUrl) {\n  return {\n    restrict: 'A',\n    scope: true,\n    templateUrl: ngeoLayertreeTemplateUrl,\n    controller: ngeoLayertreeController\n  };\n};\n\n\nexports.directive('ngeoLayertree', exports.directive_);\n\n\nexport default exports;\n","/**\n * @module ngeo.olcs.constants\n */\nconst exports = {};\n\n/**\n * @enum {string}\n * @export\n */\nexports.Permalink3dParam = {\n  /**\n   * @type {string}\n   * @export\n   */\n  ENABLED: '3d_enabled',\n  /**\n   * @type {string}\n   * @export\n   */\n  LON: '3d_lon',\n  /**\n   * @type {string}\n   * @export\n   */\n  LAT: '3d_lat',\n  /**\n   * @type {string}\n   * @export\n   */\n  ELEVATION: '3d_elevation',\n  /**\n   * @type {string}\n   * @export\n   */\n  HEADING: '3d_heading',\n  /**\n   * @type {string}\n   * @export\n   */\n  PITCH: '3d_pitch',\n  /**\n   * @type {string}\n   * @export\n   */\n  PREFIX: '3d_'\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.Popover\n */\nimport * as olBase from 'ol/index.js';\nimport olOverlay from 'ol/Overlay.js';\n\n/**\n * @classdesc\n * An openlayers overlay that uses bootstrap popover to produce a popup\n * for maps.\n *\n * @constructor\n * @extends {ol.Overlay}\n * @param {olx.OverlayOptions=} opt_options Overlay options.\n */\nconst exports = function(opt_options) {\n\n  const options = opt_options !== undefined ? opt_options : {};\n\n  let originalEl;\n  if (options.element) {\n    originalEl = options.element;\n    delete options.element;\n  } else {\n    originalEl = $('<div />')[0];\n  }\n\n  /**\n   * @type {jQuery}\n   * @private\n   */\n  this.closeEl_ = $('<button>', {\n    'class': 'close',\n    'html': '&times;'\n  });\n\n  /**\n   * @type {jQuery}\n   * @private\n   */\n  this.contentEl_ = $('<div/>')\n    .append(this.closeEl_)\n    .append(originalEl);\n\n  options.element = $('<div />')[0];\n\n  olOverlay.call(this, options);\n\n};\n\nolBase.inherits(exports, olOverlay);\n\n\n/**\n * @override\n */\nexports.prototype.setMap = function(map) {\n\n  const element = this.getElement();\n\n  const currentMap = this.getMap();\n  if (currentMap) {\n    $(element).popover('destroy');\n  }\n\n  olOverlay.prototype.setMap.call(this, map);\n\n  if (map) {\n    const contentEl = this.contentEl_;\n    // wait for the overlay to be rendered in the map before poping over\n    window.setTimeout(() => {\n      $(element)\n        .popover({\n          'content': contentEl,\n          'html': true,\n          'placement': 'top',\n          'template': [\n            '<div class=\"popover ngeo-popover\" role=\"tooltip\">',\n            '  <div class=\"arrow\"></div>',\n            '  <h3 class=\"popover-title\"></h3>',\n            '  <div class=\"popover-content\"></div>',\n            '</div>'\n          ].join('')\n        })\n        .popover('show');\n    }, 0);\n\n    this.closeEl_.one('click', () => {\n      const map = this.getMap();\n      if (map) {\n        map.removeOverlay(this);\n      }\n    });\n  }\n};\n\n\nexport default exports;\n","/**\n * @module gmf.layertree.component\n */\nimport gmfBase from 'gmf/index.js';\nimport gmfDatasourceDataSourceBeingFiltered from 'gmf/datasource/DataSourceBeingFiltered.js';\nimport gmfDatasourceExternalDataSourcesManager from 'gmf/datasource/ExternalDataSourcesManager.js';\nimport gmfPermalinkPermalink from 'gmf/permalink/Permalink.js';\n\n/** @suppress {extraRequire} */\nimport gmfLayertreeDatasourceGroupTreeComponent from 'gmf/layertree/datasourceGroupTreeComponent.js';\n\nimport gmfLayertreeSyncLayertreeMap from 'gmf/layertree/SyncLayertreeMap.js';\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport googAsserts from 'goog/asserts.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\n\n/** @suppress {extraRequire} */\nimport ngeoLayertreeComponent from 'ngeo/layertree/component.js';\n\nimport ngeoLayertreeController from 'ngeo/layertree/Controller.js';\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMiscSyncArrays from 'ngeo/misc/syncArrays.js';\nimport ngeoMiscWMSTime from 'ngeo/misc/WMSTime.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\nimport * as olObj from 'ol/obj.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport olSourceWMTS from 'ol/source/WMTS.js';\n\nimport 'bootstrap/js/collapse.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfLayertreeComponent', [\n  gmfDatasourceDataSourceBeingFiltered.module.name,\n  gmfDatasourceExternalDataSourcesManager.module.name,\n  gmfPermalinkPermalink.module.name,\n  gmfLayertreeDatasourceGroupTreeComponent.name,\n  gmfLayertreeSyncLayertreeMap.module.name,\n  gmfLayertreeTreeManager.module.name,\n  gmfThemeThemes.module.name,\n  ngeoLayertreeComponent.name,\n  ngeoLayertreeController.module.name,\n  ngeoMapLayerHelper.module.name,\n  ngeoMiscWMSTime.module.name,\n]);\n\n\n// Overrides the path to the layertree template (used by each node, except\n// the root node that path is defined by the gmfLayertreeTemplate value.\nexports.value('ngeoLayertreeTemplateUrl',\n  /**\n   * @param {angular.JQLite} element Element.\n   * @param {angular.Attributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => 'gmf/layertree');\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/layertree', require('./component.html'));\n});\n\n\nexports.value('gmfLayertreeTemplate',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template.\n   */\n  ($element, $attrs) => {\n    const subTemplateUrl = 'gmf/layertree';\n    return '<div ngeo-layertree=\"gmfLayertreeCtrl.root\" ' +\n          'ngeo-layertree-map=\"gmfLayertreeCtrl.map\" ' +\n          'ngeo-layertree-nodelayer=\"gmfLayertreeCtrl.getLayer(treeCtrl)\" ' +\n          'ngeo-layertree-listeners=\"gmfLayertreeCtrl.listeners(treeScope, treeCtrl)\" ' +\n          `ngeo-layertree-templateurl=\"${subTemplateUrl}\">` +\n          '</div>';\n  }\n);\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfLayertreeTemplate Template function.\n * @return {string} Template.\n * @ngInject\n */\nfunction gmfLayertreeTemplate($element, $attrs, gmfLayertreeTemplate) {\n  return gmfLayertreeTemplate($element, $attrs);\n}\n\n\n/**\n * This component creates a layertree based on the c2cgeoportal JSON themes\n * source and a {@link ngeo.layertreeComponent}. The controller used by this\n * component defines some functions for each node that are created by a default\n * template. This default template can be overridden by setting the value\n * 'gmf.layertreeTemplateUrl' but you will have to adapt the\n * ngeoLayertreeTemplateUrl value too (to define the children's nodes template\n * path).\n *\n * Example:\n *\n *      <gmf-layertree\n *        gmf-layertree-dimensions=\"ctrl.dimensions\"\n *        gmf-layertree-map=\"ctrl.map\">\n *      </gmf-layertree>\n *\n * You can add an attribute 'gmf-layertree-openlinksinnewwindow=\"::true\"' to open\n * metadata URLs in a new window. By default, and in the default template,\n * links will be opened in a popup (The window.gmfx.openIframePopup function must be available !)\n *\n * Used UI metadata:\n *\n *  * isChecked: if 'false' the layer visibility will be set to false.\n *  * iconUrl: layer icon full URL.\n *  * legendRule: WMS rule used to get a layer icon.\n *  * isLegendExpanded: if 'true' the legend is expanded by default.\n *  * metadataUrl: Display a popup with the content of the given URL if\n *    possible also open a new window.\n *\n * @htmlAttribute {ol.Map} gmf-layertree-map The map.\n * @htmlAttribute {Object<string, string>|undefined} gmf-layertree-dimensions Global dimensions object.\n * @htmlAttribute {boolean|undefined} gmf-layertree-openlinksinnewwindow if true, open\n *     metadataURLs in a new window. Otherwise open them in a popup.\n *\n * @ngdoc component\n * @ngname gmfLayertreeComponent\n */\nexports.component_ = {\n  controller: 'GmfLayertreeController as gmfLayertreeCtrl',\n  bindings: {\n    'map': '=gmfLayertreeMap',\n    'dimensions': '=?gmfLayertreeDimensions',\n    'openLinksInNewWindow': '<?gmfLayertreeOpenlinksinnewwindow',\n  },\n  template: gmfLayertreeTemplate\n};\n\nexports.component('gmfLayertree', exports.component_);\n\n\n/**\n * @param {angular.JQLite} $element Element.\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {gmfx.datasource.DataSourceBeingFiltered} gmfDataSourceBeingFiltered\n *     The Gmf value service that determines the data source currently being\n *     filtered.\n * @param {!gmf.datasource.ExternalDataSourcesManager}\n *     gmfExternalDataSourcesManager The Gmf external data sources manager\n *     service. Used here to fetch the external WMS groups.\n * @param {!gmf.permalink.Permalink} gmfPermalink The gmf permalink service.\n * @param {!gmf.layertree.TreeManager} gmfTreeManager gmf Tree Manager service.\n * @param {!gmf.layertree.SyncLayertreeMap} gmfSyncLayertreeMap gmfSyncLayertreeMap service.\n * @param {!ngeo.misc.WMSTime} ngeoWMSTime wms time service.\n * @param {!gmf.theme.Themes} gmfThemes The gmf Themes service.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname gmfLayertreeController\n */\nexports.Controller_ = function($element, $scope, ngeoLayerHelper, gmfDataSourceBeingFiltered,\n  gmfExternalDataSourcesManager, gmfPermalink, gmfTreeManager, gmfSyncLayertreeMap, ngeoWMSTime, gmfThemes) {\n\n  /**\n   * @type {?ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {?Object<string, string>}\n   * @export\n   */\n  this.dimensions;\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {!ngeo.map.LayerHelper}\n   * @private\n   */\n  this.layerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {gmfx.datasource.DataSourceBeingFiltered}\n   * @export\n   */\n  this.gmfDataSourceBeingFiltered = gmfDataSourceBeingFiltered;\n\n  /**\n   * @type {!gmf.datasource.ExternalDataSourcesManager}\n   * @export\n   */\n  this.gmfExternalDataSourcesManager = gmfExternalDataSourcesManager;\n\n  /**\n   * @type {!gmf.permalink.Permalink}\n   * @private\n   */\n  this.gmfPermalink_ = gmfPermalink;\n\n  /**\n   * @type {!gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = gmfTreeManager;\n\n  const root = gmfTreeManager.root;\n  googAsserts.assert(root);\n\n  /**\n   * @type {!gmfThemes.GmfRootNode}\n   * @export\n   */\n  this.root = root;\n\n  /**\n   * @type {!gmf.layertree.SyncLayertreeMap}\n   * @private\n   */\n  this.gmfSyncLayertreeMap_ = gmfSyncLayertreeMap;\n\n  /**\n   * @type {!ngeo.misc.WMSTime}\n   * @private\n   */\n  this.ngeoWMSTime_ = ngeoWMSTime;\n\n  /**\n   * @type {!Object.<number, !Array.<string>>}\n   * @private\n   */\n  this.groupNodeStates_ = {};\n\n  /**\n   * @type {boolean|undefined}\n   * @export\n   */\n  this.openLinksInNewWindow;\n\n  /**\n   * @type {?ol.layer.Group}\n   * @private\n   */\n  this.dataLayerGroup_ = null;\n\n  /**\n   * @type {!Array.<!ol.layer.Base>}\n   * @export\n   */\n  this.layers = [];\n\n  /**\n   * @type {!gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  // enter digest cycle on node collapse\n  $element.on('shown.bs.collapse', () => {\n    this.scope_.$apply();\n  });\n};\n\n\n/**\n * Init the controller,\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.openLinksInNewWindow = this.openLinksInNewWindow === true;\n  this.dataLayerGroup_ = this.layerHelper_.getGroupFromMap(this.map,\n    gmfBase.DATALAYERGROUP_NAME);\n\n  ngeoMiscSyncArrays(this.dataLayerGroup_.getLayers().getArray(), this.layers, true, this.scope_, () => true);\n\n  // watch any change on layers array to refresh the map\n  this.scope_.$watchCollection(() => this.layers,\n    () => {\n      this.map.render();\n    });\n\n  // watch any change on dimensions object to refresh the layers\n  this.scope_.$watchCollection(() => {\n    if (this.gmfTreeManager_.rootCtrl) {\n      return this.dimensions;\n    }\n  }, (dimensions) => {\n    if (dimensions) {\n      this.updateDimensions_(this.gmfTreeManager_.rootCtrl);\n    }\n  });\n};\n\n\n/**\n * @param {ngeo.layertree.Controller} treeCtrl Layer tree controller.\n * @private\n */\nexports.Controller_.prototype.updateDimensions_ = function(treeCtrl) {\n  treeCtrl.traverseDepthFirst((ctrl) => {\n    if (ctrl.node.dimensions) {\n      const layer = ctrl.layer;\n      googAsserts.assertInstanceof(layer, olLayerLayer);\n      this.updateLayerDimensions_(layer, /** @type gmfThemes.GmfGroup|gmfThemes.GmfLayer */ (ctrl.node));\n    }\n  });\n};\n\n\n/**\n * @param {ol.layer.Layer} layer Layer to update.\n * @param {gmfThemes.GmfGroup|gmfThemes.GmfLayer} node Layer tree node.\n * @private\n */\nexports.Controller_.prototype.updateLayerDimensions_ = function(layer, node) {\n  if (this.dimensions && node.dimensions) {\n    const dimensions = {};\n    for (const key in node.dimensions) {\n      if (node.dimensions[key] === null) {\n        const value = this.dimensions[key];\n        if (value !== undefined) {\n          dimensions[key] = value;\n        }\n      } else {\n        dimensions[key] = node.dimensions[key];\n      }\n    }\n    if (!olObj.isEmpty(dimensions)) {\n      const source = layer.getSource();\n      if (source instanceof olSourceWMTS) {\n        source.updateDimensions(dimensions);\n      } else if (source instanceof olSourceTileWMS || source instanceof olSourceImageWMS) {\n        source.updateParams(dimensions);\n      } else {\n        // the source is not ready yet\n        layer.once('change:source', () => {\n          googAsserts.assertInstanceof(layer, olLayerLayer);\n          this.updateLayerDimensions_(layer, node);\n        });\n      }\n    }\n  }\n};\n\n\n/**\n * Use the gmfSyncLayertreeMap_ to create and get layer corresponding to this\n * treeCtrl. The layer will be inserted into the map. The layer can be null\n * if the treeCtrl is based on a node inside a mixed node. It this case, the\n * layer will be in the first parent declared as a mixed node.\n * @param {ngeo.layertree.Controller} treeCtrl tree controller of the node\n * @return {ol.layer.Base|ol.layer.Group|null} The OpenLayers layer or group\n *     for the node.\n * @export\n */\nexports.Controller_.prototype.getLayer = function(treeCtrl) {\n  let opt_position;\n  if (treeCtrl.parent.isRoot) {\n    this.gmfTreeManager_.rootCtrl = treeCtrl.parent;\n    // Precise the index to add first level groups.\n    opt_position = this.gmfTreeManager_.root.children.length -\n        this.gmfTreeManager_.numberOfGroupsToAddInThisDigestLoop || 0;\n  }\n\n  const layer = this.gmfSyncLayertreeMap_.createLayer(treeCtrl, this.map,\n    this.dataLayerGroup_, opt_position);\n\n  if (layer instanceof olLayerLayer) {\n    const node = /** @type {gmfThemes.GmfGroup|gmfThemes.GmfLayer} */ (treeCtrl.node);\n    this.updateLayerDimensions_(layer, node);\n  }\n\n  return layer;\n};\n\n\n/**\n * Remove layer from this component's layergroup (and then, from the map) on\n * a ngeo layertree destroy event.\n * @param {angular.Scope} scope treeCtrl scope.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @export\n */\nexports.Controller_.prototype.listeners = function(scope, treeCtrl) {\n  const dataLayerGroup = this.dataLayerGroup_;\n  scope.$on('$destroy', () => {\n    // Remove the layer from the map.\n    dataLayerGroup.getLayers().remove(treeCtrl.layer);\n  });\n};\n\n/**\n * Toggle the state of treeCtrl's node.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @export\n */\nexports.Controller_.prototype.toggleActive = function(treeCtrl) {\n  treeCtrl.setState(treeCtrl.getState() === 'on' ? 'off' : 'on');\n};\n\n\n/**\n * Return the current state of the given treeCtrl's node.\n * Return a class name that match with the current node activation state.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @return {string} 'on' or 'off' or 'indeterminate'.\n * @export\n */\nexports.Controller_.prototype.getNodeState = function(treeCtrl) {\n  return treeCtrl.getState();\n};\n\n\n/**\n * Update the `timeRangeValue` property of the data source bound to the\n * given tree controller using the given time. If the tree controller has\n * no data source, it means that it has children and they might have\n * data sources.\n *\n * The setting of the TIME parameter on the layer occurs in the\n * `gmf.datasource.Manager` service\n *\n * LayertreeController.prototype.updateWMSTimeLayerState - description\n * @param {ngeo.layertree.Controller} layertreeCtrl ngeo layertree controller\n * @param {{start : number, end : number}} time The start\n * and optionally the end datetime (for time range selection) selected by user\n * @export\n */\nexports.Controller_.prototype.updateWMSTimeLayerState = function(\n  layertreeCtrl, time) {\n  if (!time) {\n    return;\n  }\n  const dataSource = layertreeCtrl.getDataSource();\n  if (dataSource) {\n    googAsserts.assertInstanceof(dataSource, ngeoDatasourceOGC);\n    dataSource.timeRangeValue = time;\n  } else if (layertreeCtrl.children) {\n    for (let i = 0, ii = layertreeCtrl.children.length; i < ii; i++) {\n      this.updateWMSTimeLayerState(layertreeCtrl.children[i], time);\n    }\n  }\n};\n\n\n/**\n * Get the icon image URL for the given treeCtrl's layer. It can only return a\n * string for internal WMS layers without multiple childlayers in the node.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @return {string|undefined} The icon legend URL or undefined.\n * @export\n */\nexports.Controller_.prototype.getLegendIconURL = function(treeCtrl) {\n  const iconUrl = treeCtrl.node.metadata.iconUrl;\n\n  if (iconUrl !== undefined) {\n    return iconUrl;\n  }\n\n  if (treeCtrl.node.children !== undefined) {\n    return undefined;\n  }\n\n  const gmfLayer = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n  if (gmfLayer.type !== 'WMS') {\n    return undefined;\n  }\n\n  const gmfLayerWMS = /** @type {gmfThemes.GmfLayerWMS} */ (gmfLayer);\n\n  const legendRule = gmfLayerWMS.metadata.legendRule;\n\n  if (legendRule === undefined) {\n    return undefined;\n  }\n\n  //In case of multiple layers for a gmfLayerWMS, always take the first layer\n  //name to get the icon\n  const layerName = gmfLayerWMS.layers.split(',')[0];\n  const gmfOgcServer = this.gmfTreeManager_.getOgcServer(treeCtrl);\n  return this.layerHelper_.getWMSLegendURL(\n    gmfOgcServer.url, layerName, undefined, legendRule, 20, 20\n  );\n};\n\n\n/**\n * Get the legends object (<LayerName: url> for each layer) for the given treeCtrl.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @return {Object.<string, string>} A <layerName: url> object that provides a\n *     layer for each layer.\n * @export\n */\nexports.Controller_.prototype.getLegendsObject = function(treeCtrl) {\n  const legendsObject = {};\n  if (/** @type gmfThemes.GmfGroup */ (treeCtrl.node).children !== undefined) {\n    return null;\n  }\n\n  const gmfLayer = /** @type {gmfThemes.GmfLayer} */ (treeCtrl.node);\n  const gmfLayerDefaultName = gmfLayer.name;\n  if (gmfLayer.metadata.legendImage) {\n    legendsObject[gmfLayerDefaultName] = gmfLayer.metadata.legendImage;\n    return legendsObject;\n  }\n\n  const layer = treeCtrl.layer;\n  if (gmfLayer.type === 'WMTS') {\n    googAsserts.assertInstanceof(layer, olLayerTile);\n    const wmtsLegendURL = this.layerHelper_.getWMTSLegendURL(layer);\n    legendsObject[gmfLayerDefaultName] = wmtsLegendURL;\n    return wmtsLegendURL ? legendsObject : null;\n  } else {\n    const gmfLayerWMS = /** @type {gmfThemes.GmfLayerWMS} */ (gmfLayer);\n    let layersNames = gmfLayerWMS.layers;\n    const gmfOgcServer = this.gmfTreeManager_.getOgcServer(treeCtrl);\n    const scale = this.getScale_();\n    // QGIS can handle multiple layers natively. Use Multiple URLs for other map\n    // servers\n    if (gmfOgcServer.type === ngeoDatasourceOGC.ServerType.QGISSERVER) {\n      layersNames = [layersNames];\n    } else {\n      layersNames = layersNames.split(',');\n    }\n    layersNames.forEach((layerName) => {\n      legendsObject[layerName] = this.layerHelper_.getWMSLegendURL(gmfOgcServer.url, layerName, scale);\n    });\n    return legendsObject;\n  }\n};\n\n\n/**\n * Get the number of legends object for this layertree controller.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @return {number} The number of Legends object.\n * @export\n */\nexports.Controller_.prototype.getNumberOfLegendsObject = function(treeCtrl) {\n  const legendsObject = this.getLegendsObject(treeCtrl);\n  return legendsObject ? Object.keys(legendsObject).length : 0;\n};\n\n\n/**\n * Return the current scale of the map.\n * @return {number} Scale.\n * @private\n */\nexports.Controller_.prototype.getScale_ = function() {\n  const view = this.map.getView();\n  const resolution = view.getResolution();\n  const mpu = view.getProjection().getMetersPerUnit();\n  const dpi = 25.4 / 0.28;\n  return resolution * mpu * 39.37 * dpi;\n};\n\n\n/**\n * Opens a gmfx.openIframePopup with the content of the metadata url of a node.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @export\n */\nexports.Controller_.prototype.displayMetadata = function(treeCtrl) {\n  const node = treeCtrl.node;\n  const metadataURL = node.metadata['metadataUrl'];\n  if (metadataURL !== undefined) {\n    // FIXME layertree should not rely on a window function.\n    const gmfx = window.gmfx;\n    if (gmfx.openIframePopup) {\n      gmfx.openIframePopup(metadataURL, node.name, undefined, undefined, false);\n    }\n  }\n};\n\n\n/**\n * Update the layers order in the map and the treeCtrl in the treeManager after\n * a reorder of the first-level groups. Then update the permalink.\n * @export\n */\nexports.Controller_.prototype.afterReorder = function() {\n  const groupNodes = this.gmfTreeManager_.rootCtrl.node.children;\n  const currentTreeCtrls = this.gmfTreeManager_.rootCtrl.children;\n  const treeCtrls = [];\n\n  // Get order of first-level groups for treectrl and layers;\n  groupNodes.forEach((node) => {\n    currentTreeCtrls.some((treeCtrl) => {\n      if (treeCtrl.node === node) {\n        treeCtrls.push(treeCtrl);\n        return;\n      }\n    });\n  });\n\n  // Update gmfTreeManager rootctrl children order\n  this.gmfTreeManager_.rootCtrl.children = treeCtrls;\n\n  // Update map 'data' groupe layers order\n  this.layers.length = 0;\n  this.gmfTreeManager_.rootCtrl.children.forEach((child) => {\n    this.layers.push(child.layer);\n  });\n\n  // Update the permalink order\n  this.gmfPermalink_.refreshFirstLevelGroups();\n};\n\n\n/**\n * @param {gmfThemes.GmfGroup} node Layer tree node to remove.\n * @export\n */\nexports.Controller_.prototype.removeNode = function(node) {\n  this.gmfTreeManager_.removeGroup(node);\n};\n\n\n/**\n * @export\n */\nexports.Controller_.prototype.removeAllNodes = function() {\n  this.gmfTreeManager_.removeAll();\n};\n\n\n/**\n * @return {number} first level node count.\n * @export\n */\nexports.Controller_.prototype.nodesCount = function() {\n  return this.gmfTreeManager_.root.children.length;\n};\n\n/**\n * Return 'out-of-resolution' if the current resolution of the map is out of\n * the min/max resolution in the node.\n * @param {gmfThemes.GmfLayerWMS} gmfLayer the GeoMapFish Layer. WMTS layer is\n *     also allowed (the type is defined as GmfLayerWMS only to avoid some\n *     useless tests to know if a minResolutionHint property can exist\n *     on the node).\n * @return {string|undefined} 'out-of-resolution' or undefined.\n * @export\n */\nexports.Controller_.prototype.getResolutionStyle = function(gmfLayer) {\n  const resolution = this.map.getView().getResolution();\n  const minResolution = gmfThemeThemes.getNodeMinResolution(gmfLayer);\n  if (minResolution !== undefined && resolution < minResolution) {\n    return 'out-of-resolution';\n  }\n  const maxResolution = gmfThemeThemes.getNodeMaxResolution(gmfLayer);\n  if (maxResolution !== undefined && resolution > maxResolution) {\n    return 'out-of-resolution';\n  }\n  return undefined;\n};\n\n\n/**\n * Set the resolution of the map with the max or min resolution of the node.\n * @param {ngeo.layertree.Controller} treeCtrl ngeo layertree controller, from\n *     the current node.\n * @export\n */\nexports.Controller_.prototype.zoomToResolution = function(treeCtrl) {\n  const gmfLayer = /** @type {gmfThemes.GmfLayerWMS} */ (treeCtrl.node);\n  const view = this.map.getView();\n  const resolution = view.getResolution();\n  const minResolution = gmfThemeThemes.getNodeMinResolution(gmfLayer);\n  if (minResolution !== undefined && resolution < minResolution) {\n    view.setResolution(view.constrainResolution(minResolution, 0, 1));\n  } else {\n    const maxResolution = gmfThemeThemes.getNodeMaxResolution(gmfLayer);\n    if (maxResolution !== undefined && resolution > maxResolution) {\n      view.setResolution(view.constrainResolution(maxResolution, 0, -1));\n    }\n  }\n};\n\n\n/**\n * Toggle the legend for a node\n * @param {string} legendNodeId The DOM node legend id to toggle\n * @export\n */\nexports.Controller_.prototype.toggleNodeLegend = function(legendNodeId) {\n  $(legendNodeId).toggle({\n    toggle: true\n  });\n};\n\n\n/**\n * @param {gmf.datasource.OGC} ds Data source to filter.\n * @export\n */\nexports.Controller_.prototype.toggleFiltrableDataSource = function(ds) {\n  this.gmfDataSourceBeingFiltered.dataSource = ds;\n};\n\n\n/**\n * @param {string} legendNodeId The DOM node legend id\n * @return {boolean} Whenever the legend is currently displayed.\n * @export\n */\nexports.Controller_.prototype.isNodeLegendVisible = function(legendNodeId) {\n  return $(legendNodeId).is(':visible');\n};\n\n\n/**\n * Determines whether the layer tree controller supports being customized.\n * For example, having its layer opacity changed, displaying its legend, etc.\n *\n * If any requirement is met, then the treeCtrl is considered supporting\n * \"customization\", regardless of what it actually is.\n *\n * The requirements are:\n *\n * - must not be the root controller, any of the following:\n *   - it supports legend\n *   - it supports having the layer opacity being changed\n *\n * @param {!ngeo.layertree.Controller} treeCtrl Ngeo tree controller.\n * @return {boolean} Whether the layer tree controller supports being\n *     \"customized\" or not.\n * @export\n */\nexports.Controller_.prototype.supportsCustomization = function(treeCtrl) {\n  return !treeCtrl.isRoot &&\n    (\n      this.supportsLegend(treeCtrl) ||\n      this.supportsOpacityChange(treeCtrl)\n    );\n};\n\n\n/**\n * @param {!ngeo.layertree.Controller} treeCtrl Ngeo tree controller.\n * @return {boolean} Whether the layer tree controller supports having a\n *     legend being shown.\n * @export\n */\nexports.Controller_.prototype.supportsLegend = function(treeCtrl) {\n  const node = /** @type {!gmfThemes.GmfGroup} */ (treeCtrl.node);\n  return !!node.metadata &&\n    !!node.metadata.legend &&\n    !!this.getLegendsObject(treeCtrl);\n};\n\n\n/**\n * @param {!ngeo.layertree.Controller} treeCtrl Ngeo tree controller.\n * @return {boolean} Whether the layer tree controller supports having its\n *     layer opacity being changed or not.\n * @export\n */\nexports.Controller_.prototype.supportsOpacityChange = function(treeCtrl) {\n  const node = /** @type {!gmfThemes.GmfGroup} */ (treeCtrl.node);\n  const parentNode = /** @type {!gmfThemes.GmfGroup} */ (treeCtrl.parent.node);\n  return !!treeCtrl.layer &&\n    (\n      (\n        treeCtrl.depth === 1 && !node.mixed\n      ) ||\n      (\n        treeCtrl.depth > 1 && parentNode.mixed\n      )\n    );\n};\n\nexports.controller('GmfLayertreeController', exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module app\n */\nconst exports = {};\n\n/**\n * This file provides the \"app\" namespace, which is the\n * application's main namespace. And it defines the application's Angular\n * module.\n */\n\nimport ngeoUtils from 'ngeo/utils.js';\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('app', []);\n\nexports.module.config(['$compileProvider', function($compileProvider) {\n  if (!('debug' in ngeoUtils.decodeQueryString(window.location.search))) {\n    // Disable the debug info\n    $compileProvider.debugInfoEnabled(false);\n  }\n}]);\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.coordinate\n */\nconst exports = {};\n\n\n/**\n * Convert a given coordinate or list of coordinates of any 'nesting' level\n * to XY, i.e. remove any extra dimensions to the coordinates and keep only 2.\n *\n * @param {Array.<ol.Coordinate>|ol.Coordinate} coordinates Coordinates\n * @param {number} nesting Nesting level.\n * @return {Array.<ol.Coordinate>|ol.Coordinate} Converted coordinates.\n */\nexports.toXY = function(coordinates, nesting) {\n  if (nesting === 0) {\n    if (coordinates.length > 2) {\n      coordinates = [coordinates[0], coordinates[1]];\n    }\n  } else {\n    for (let i = 0, ii = coordinates.length; i < ii; i++) {\n      coordinates[i] = exports.toXY(coordinates[i], nesting - 1);\n    }\n  }\n  return coordinates;\n};\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.geom\n */\nconst exports = {};\nimport gmfObjecteditingCoordinate from 'gmf/objectediting/coordinate.js';\nimport olGeomLineString from 'ol/geom/LineString.js';\nimport olGeomMultiLineString from 'ol/geom/MultiLineString.js';\nimport olGeomMultiPoint from 'ol/geom/MultiPoint.js';\nimport olGeomMultiPolygon from 'ol/geom/MultiPolygon.js';\nimport olGeomPoint from 'ol/geom/Point.js';\nimport olGeomPolygon from 'ol/geom/Polygon.js';\nimport olGeomSimpleGeometry from 'ol/geom/SimpleGeometry.js';\n\n\n/**\n * Determines whether a given geometry is empty or not. A null or undefined\n * value can be given for convenience, i.e. when using methods than can\n * return a geometry or not, for example:\n * `gmf.objectediting.geom.isEmpty(feature.getGeometry())`.\n *\n * @param {?ol.geom.Geometry|undefined} geom Geometry.\n * @return {boolean} Whether the given geometry is empty or not. A null or\n *     undefined geometry is considered empty.\n */\nexports.isEmpty = function(geom) {\n  let isEmpty = true;\n  if (geom && geom instanceof olGeomSimpleGeometry) {\n    isEmpty = geom.getFlatCoordinates().length === 0;\n  }\n  return isEmpty;\n};\n\n\n/**\n * Convert all coordinates within a geometry object to XY, i.e. remove any\n * extra dimension other than X and Y to the coordinates of a geometry.\n *\n * @param {ol.geom.Geometry} geom Geometry\n */\nexports.toXY = function(geom) {\n  if (geom instanceof olGeomPoint) {\n    geom.setCoordinates(\n      gmfObjecteditingCoordinate.toXY(geom.getCoordinates(), 0)\n    );\n  } else if (geom instanceof olGeomMultiPoint ||\n             geom instanceof olGeomLineString\n  ) {\n    geom.setCoordinates(\n      gmfObjecteditingCoordinate.toXY(geom.getCoordinates(), 1)\n    );\n  } else if (geom instanceof olGeomMultiLineString ||\n             geom instanceof olGeomPolygon\n  ) {\n    geom.setCoordinates(\n      gmfObjecteditingCoordinate.toXY(geom.getCoordinates(), 2)\n    );\n  } else if (geom instanceof olGeomMultiPolygon) {\n    geom.setCoordinates(\n      gmfObjecteditingCoordinate.toXY(geom.getCoordinates(), 3)\n    );\n  } else {\n    throw 'gmf.objectediting.geom.toXY - unsupported geometry type';\n  }\n};\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.Query\n */\nimport gmfThemeThemes from 'gmf/theme/Themes.js';\nimport ngeoDatasourceOGC from 'ngeo/datasource/OGC.js';\nimport olFormatWMSGetFeatureInfo from 'ol/format/WMSGetFeatureInfo.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\n\n/**\n * A service that collects all queryable layer nodes from all themes, stores\n * them and use them to make WMS GetFeatureInfo queries. Queries can be made\n * regardless of the associated layer visibility. The layer nodes are also\n * loaded only once.\n *\n * @param {angular.$http} $http Angular $http service.\n * @param {angular.$q} $q Angular $q service.\n * @param {gmf.theme.Themes} gmfThemes The gmf themes service.\n * @constructor\n * @struct\n * @ngInject\n */\nconst exports = function($http, $q, gmfThemes) {\n\n  /**\n   * @type {angular.$http}\n   * @private\n   */\n  this.http_ = $http;\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.q_ = $q;\n\n  /**\n   * @type {gmf.theme.Themes}\n   * @private\n   */\n  this.gmfThemes_ = gmfThemes;\n\n  /**\n   * @type {?angular.$q.Deferred}\n   * @private\n   */\n  this.getQueryableLayerNodesDefered_ = null;\n\n};\n\n\n/**\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getQueryableLayersInfo = function() {\n\n  if (!this.getQueryableLayerNodesDefered_) {\n    this.getQueryableLayerNodesDefered_ = this.q_.defer();\n    this.gmfThemes_.getOgcServersObject().then((ogcServers) => {\n      this.gmfThemes_.getThemesObject().then((themes) => {\n        if (!themes) {\n          return;\n        }\n\n        // Get all queryable nodes\n        const allQueryableLayersInfo =\n            exports.getQueryableLayersInfoFromThemes(\n              themes,\n              ogcServers\n            );\n\n        // Narrow down to only those that have the 'copyable' metadata set\n        const queryableLayersInfo = [];\n        for (let i = 0, ii = allQueryableLayersInfo.length; i < ii; i++) {\n          if (allQueryableLayersInfo[i].layerNode.metadata.copyable) {\n            queryableLayersInfo.push(allQueryableLayersInfo[i]);\n          }\n        }\n\n        this.getQueryableLayerNodesDefered_.resolve(queryableLayersInfo);\n      });\n    });\n  }\n\n  return this.getQueryableLayerNodesDefered_.promise;\n\n};\n\n\n/**\n * From a list of theme nodes, collect all WMS layer nodes that are queryable.\n * A list of OGC servers is given in order to bind each queryable layer node\n * to its associated server and be able to build requests.\n *\n * @param {Array.<gmfThemes.GmfTheme>} themes List of theme nodes.\n * @param {gmfThemes.GmfOgcServers} ogcServers List of ogc servers\n * @return {Array.<gmfx.ObjectEditingQueryableLayerInfo>} List of\n *     queryable layers information.\n * @export\n */\nexports.getQueryableLayersInfoFromThemes = function(\n  themes, ogcServers\n) {\n  const queryableLayersInfo = [];\n  let theme;\n  let group;\n  let nodes;\n  let node;\n\n  for (let i = 0, ii = themes.length; i < ii; i++) {\n    theme = /** @type {gmfThemes.GmfTheme} */ (themes[i]);\n    for (let j = 0, jj = theme.children.length; j < jj; j++) {\n      group = /** @type {gmfThemes.GmfGroup} */ (theme.children[j]);\n\n      // Skip groups that don't have an ogcServer set\n      if (!group.ogcServer) {\n        continue;\n      }\n\n      nodes = [];\n      gmfThemeThemes.getFlatNodes(group, nodes);\n\n      for (let k = 0, kk = nodes.length; k < kk; k++) {\n        node = /** @type {gmfThemes.GmfGroup|gmfThemes.GmfLayerWMS} */ (\n          nodes[k]);\n\n        // Skip groups within groups\n        if (node.children && node.children.length) {\n          continue;\n        }\n\n        if (node.childLayers &&\n          node.childLayers[0] &&\n          node.childLayers[0].queryable\n        ) {\n          queryableLayersInfo.push({\n            layerNode: node,\n            ogcServer: ogcServers[group.ogcServer]\n          });\n        }\n      }\n    }\n  }\n\n  return queryableLayersInfo;\n};\n\n\n/**\n * From a queryable layer (WMS layer node), use its associated OGC server\n * to issue a single WMS GetFeatureInfo request at a specific location on a\n * specific map to fetch a single feature. If no feature is found, a `null`\n * value is returned.\n *\n * @param {gmfx.ObjectEditingQueryableLayerInfo} layerInfo Queryable layer\n *     information.\n * @param {ol.Coordinate} coordinate Coordinate.\n * @param {ol.Map} map Map.\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getFeatureInfo = function(layerInfo, coordinate, map) {\n  const view = map.getView();\n  const projCode = view.getProjection().getCode();\n  const resolution = /** @type {number} */(view.getResolution());\n  const infoFormat = ngeoDatasourceOGC.WMSInfoFormat.GML;\n  const layerNode = layerInfo.layerNode;\n  const layersParam = layerNode.layers.split(',');\n  const ogcServer = layerInfo.ogcServer;\n\n  const format = new olFormatWMSGetFeatureInfo({\n    layers: layersParam\n  });\n\n  const wmsSource = new olSourceImageWMS({\n    url: ogcServer.url,\n    params: {\n      layers: layersParam\n    }\n  });\n\n  const url = /** @type {string} */ (\n    wmsSource.getGetFeatureInfoUrl(coordinate, resolution, projCode, {\n      'INFO_FORMAT': infoFormat,\n      'FEATURE_COUNT': 1,\n      'QUERY_LAYERS': layersParam\n    })\n  );\n\n  return this.http_.get(url).then(\n    (response) => {\n      const features = format.readFeatures(response.data);\n      return (features && features[0]) ? features[0] : null;\n    }\n  );\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfObjectEditingQuery', [\n  gmfThemeThemes.module.name,\n]);\nexports.module.service('gmfObjectEditingQuery', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.getWMSFeatureComponent\n */\nimport gmfObjecteditingQuery from 'gmf/objectediting/Query.js';\nimport * as olEvents from 'ol/events.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfObjecteditingGetWMSFeatureComponent', [\n  gmfObjecteditingQuery.module.name,\n]);\n\n\n/**\n * When activated, this directive registers clicks on an OL3 map and use the\n * clicked coordinate to fetch a feature using the ObjectEditing query service.\n * A feature returned is pushed to a collection.\n *\n * Example:\n *\n *     <gmf-objecteditinggetwmsfeature\n *         gmf-objecteditinggetwmsfeature-active=\"ctrl.active\"\n *         gmf-objecteditinggetwmsfeature-features=\"ctrl.features\"\n *         gmf-objecteditinggetwmsfeature-layerinfo=\"ctrl.layerInfo\"\n *         gmf-objecteditinggetwmsfeature-map=\"::ctrl.map\">\n *     </gmf-objecteditinggetwmsfeature>\n *\n * @htmlAttribute {boolean} gmf-objecteditinggetwmsfeature-active Whether the\n *     directive is active or not.\n * @htmlAttribute {ol.Collection} gmf-objecteditinggetwmsfeature-features\n *     The collection of features where to add those created by this directive.\n * @htmlAttribute {gmfx.ObjectEditingQueryableLayerInfo} gmf-objecteditinggetwmsfeature-layerinfo Queryable layer info.\n * @htmlAttribute {ol.Map} gmf-objecteditinggetwmsfeature-map The map.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfObjecteditinggetwmsfeature\n */\nexports.directive_ = function() {\n  return {\n    controller: 'gmfObjecteditinggetwmsfeatureController',\n    scope: {\n      'active': '=gmfObjecteditinggetwmsfeatureActive',\n      'features': '<gmfObjecteditinggetwmsfeatureFeatures',\n      'layerInfo': '=gmfObjecteditinggetwmsfeatureLayerinfo',\n      'map': '<gmfObjecteditinggetwmsfeatureMap'\n    },\n    bindToController: true\n  };\n};\n\nexports.directive('gmfObjecteditinggetwmsfeature',\n  exports.directive_);\n\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @param {gmf.objectediting.Query} gmfObjectEditingQuery GMF ObjectEditing\n *     query service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfObjecteditinggetwmsfeatureController\n */\nexports.Controller_ = function($scope,\n  gmfObjectEditingQuery) {\n\n  // Scope properties\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  $scope.$watch(\n    () => this.active,\n    this.handleActiveChange_.bind(this)\n  );\n\n  /**\n   * @type {ol.Collection}\n   * @export\n   */\n  this.features;\n\n  /**\n   * @type {gmfx.ObjectEditingQueryableLayerInfo}\n   * @export\n   */\n  this.layerInfo;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n\n  // Injected properties\n\n  /**\n   * @type {gmf.objectediting.Query}\n   * @private\n   */\n  this.gmfObjectEditingQuery_ = gmfObjectEditingQuery;\n\n};\n\n\n/**\n * @param {boolean} active Active.\n * @private\n */\nexports.Controller_.prototype.handleActiveChange_ = function(active) {\n  if (active) {\n    olEvents.listen(\n      this.map,\n      'click',\n      this.handleMapClick_,\n      this\n    );\n  } else {\n    olEvents.unlisten(\n      this.map,\n      'click',\n      this.handleMapClick_,\n      this\n    );\n  }\n};\n\n\n/**\n * @param {ol.MapBrowserEvent} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleMapClick_ = function(evt) {\n  this.gmfObjectEditingQuery_.getFeatureInfo(\n    this.layerInfo,\n    evt.coordinate,\n    this.map\n  ).then((feature) => {\n    if (feature) {\n      this.features.push(feature);\n    }\n  });\n};\n\nexports.controller('gmfObjecteditinggetwmsfeatureController',\n  exports.Controller_);\n\n\nexport default exports;\n","/**\n * @module ngeo.interaction.DrawRegularPolygonFromClick\n */\nimport googAsserts from 'goog/asserts.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport * as olBase from 'ol/index.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\nimport * as olFunctions from 'ol/functions.js';\nimport olGeomCircle from 'ol/geom/Circle.js';\nimport {fromCircle, makeRegular} from 'ol/geom/Polygon.js';\nimport olInteractionInteraction from 'ol/interaction/Interaction.js';\n\n/**\n * @classdesc\n * This interactions allows drawing regular polygons of a pre-determined number\n * of sides and size a a clicked location on the map.\n *\n * @constructor\n * @struct\n * @fires ngeox.DrawEvent\n * @extends {ol.interaction.Interaction}\n * @param {ngeox.interaction.DrawRegularPolygonFromClickOptions} options Options\n */\nconst exports = function(options) {\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.angle_ = options.angle !== undefined ? options.angle : 0;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.radius_ = options.radius;\n\n  /**\n   * @type {number}\n   * @private\n   */\n  this.sides_ = options.sides !== undefined ? options.sides : 3;\n\n  /**\n   * @type {!Array.<ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  olInteractionInteraction.call(this, {\n    handleEvent: olFunctions.TRUE\n  });\n\n};\n\nolBase.inherits(\n  exports, olInteractionInteraction);\n\n\n/**\n * Activate or deactivate the interaction.\n * @param {boolean} active Active.\n * @override\n */\nexports.prototype.setActive = function(active) {\n  olInteractionInteraction.prototype.setActive.call(this, active);\n\n  if (this.getMap()) {\n    if (active) {\n      this.enable_();\n    } else {\n      this.disable_();\n    }\n  }\n};\n\n\n/**\n * @inheritDoc\n */\nexports.prototype.setMap = function(map) {\n\n  const active = this.getActive();\n\n  const currentMap = this.getMap();\n  if (currentMap && active) {\n    this.disable_();\n  }\n\n  olInteractionInteraction.prototype.setMap.call(this, map);\n\n  if (map && active) {\n    this.enable_();\n  }\n\n};\n\n\n/**\n * Enable the interaction. Called when added to a map AND active.\n * @private\n */\nexports.prototype.enable_ = function() {\n  const map = this.getMap();\n  googAsserts.assert(map, 'Map should be set.');\n  this.listenerKeys_.push(\n    olEvents.listen(map, 'click', this.handleMapClick_, this)\n  );\n};\n\n\n/**\n * Disable the interaction. Called when removed from a map or deactivated.\n * @private\n */\nexports.prototype.disable_ = function() {\n  const map = this.getMap();\n  googAsserts.assert(map, 'Map should be set.');\n  this.listenerKeys_.forEach(olEvents.unlistenByKey);\n  this.listenerKeys_.length = 0;\n};\n\n\n/**\n * Called the the map is clicked. Create a regular polygon at the clicked\n * location using the configuration\n * @param {ol.MapBrowserEvent} evt Map browser event.\n * @private\n */\nexports.prototype.handleMapClick_ = function(evt) {\n  const center = evt.coordinate;\n  const geometry = fromCircle(\n    new olGeomCircle(center), this.sides_\n  );\n\n  makeRegular(geometry, center, this.radius_, this.angle_);\n\n\n  /** @type {ngeox.DrawEvent} */\n  const event = new ngeoCustomEvent('drawend', {feature: new olFeature(geometry)});\n  this.dispatchEvent(event);\n};\n\n\nexport default exports;\n","/**\n * @module ngeo.editing.createregularpolygonfromclickComponent\n */\nimport ngeoInteractionDrawRegularPolygonFromClick from 'ngeo/interaction/DrawRegularPolygonFromClick.js';\nimport * as olEvents from 'ol/events.js';\nimport olFeature from 'ol/Feature.js';\n\nconst exports = angular.module('ngeoCreateregularpolygonfromclick', [\n]);\n\n\n/**\n * A directive used to draw vector features of a single geometry type using\n * either a 'draw' or 'measure' interaction. Once a feature is finished being\n * drawn, it is added to a collection of features.\n *\n * The geometry types supported are:\n *  - Point\n *  - LineString\n *  - Polygon\n *\n * Example:\n *\n *     <a\n *       href\n *       translate\n *       ngeo-btn\n *       ngeo-createregularpolygonfromclick\n *       ngeo-createregularpolygonfromclick-active=\"ctrl.active\"\n *       ngeo-createregularpolygonfromclick-angle=\"::ctrl.angle\"\n *       ngeo-createregularpolygonfromclick-features=\"ctrl.features\"\n *       ngeo-createregularpolygonfromclick-map=\"::ctrl.map\"\n *       ngeo-createregularpolygonfromclick-radius=\"::ctrl.radius\"\n *       ngeo-createregularpolygonfromclick-sides=\"::ctrl.sides\"\n *       class=\"btn btn-default ngeo-createregularpolygonfromclick\"\n *       ng-class=\"{active: ctrl.active}\"\n *       ng-model=\"ctrl.active\">\n *     </a>\n *\n * @htmlAttribute {boolean} ngeo-createregularpolygonfromclick-active Whether\n *     the directive is active or not.\n * @htmlAttribute {number|undefined} ngeo-createregularpolygonfromclick-angle\n *     Angle in radians. A value of 0 will have one of the shape's point\n *     facing up. Default value is 0.\n * @htmlAttribute {ol.Collection} ngeo-createregularpolygonfromclick-features\n *     The collection of features where to add those created by this directive.\n * @htmlAttribute {ol.Map} ngeo-createregularpolygonfromclick-map The map.\n * @htmlAttribute {number} ngeo-createregularpolygonfromclick-radius Radius\n *     size in map units.\n * @htmlAttribute {number|undefined} ngeo-createregularpolygonfromclick-sides\n *     The number of sides for the regular polygon. Default value is 3.\n *\n * @return {angular.Directive} The directive specs.\n * @ngdoc directive\n * @ngname ngeoCreateregularpolygonfromclick\n */\nexports.directive_ = function() {\n  return {\n    controller: 'ngeoCreateregularpolygonfromclickController',\n    bindToController: true,\n    scope: {\n      'active': '=ngeoCreateregularpolygonfromclickActive',\n      'angle': '<?ngeoCreateregularpolygonfromclickAngle',\n      'features': '=ngeoCreateregularpolygonfromclickFeatures',\n      'map': '=ngeoCreateregularpolygonfromclickMap',\n      'radius': '<ngeoCreateregularpolygonfromclickRadius',\n      'sides': '<?ngeoCreateregularpolygonfromclickSides'\n    }\n  };\n};\n\nexports.directive(\n  'ngeoCreateregularpolygonfromclick',\n  exports.directive_\n);\n\n\n/**\n * @param {!angular.Scope} $scope Scope.\n * @constructor\n * @private\n * @struct\n * @ngInject\n * @ngdoc controller\n * @ngname ngeoCreateregularpolygonfromclickController\n */\nexports.Controller_ = function($scope) {\n\n  // == Scope properties ==\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active = false;\n\n  $scope.$watch(\n    () => this.active,\n    (newVal) => {\n      this.interaction_.setActive(newVal);\n    }\n  );\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.angle;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @export\n   */\n  this.features;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.radius;\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.sides;\n\n\n  // == Other properties ==\n\n  /**\n   * @type {ngeo.interaction.DrawRegularPolygonFromClick}\n   * @private\n   */\n  this.interaction_;\n\n  /**\n   * @type {ol.EventsKey}\n   * @private\n   */\n  this.interactionListenerKey_;\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n};\n\n\n/**\n * Initialize the directive.\n */\nexports.Controller_.prototype.$onInit = function() {\n\n  this.interaction_ = new ngeoInteractionDrawRegularPolygonFromClick({\n    angle: this.angle,\n    radius: this.radius,\n    sides: this.sides\n  });\n  this.interaction_.setActive(this.active);\n\n  this.interactionListenerKey_ = olEvents.listen(\n    this.interaction_,\n    'drawend',\n    this.handleDrawEnd_,\n    this\n  );\n\n  this.map.addInteraction(this.interaction_);\n};\n\n\n/**\n * Called when a feature is finished being drawn. Add the feature to the\n * collection.\n * @param {ol.interaction.Draw.Event} evt Event.\n * @private\n */\nexports.Controller_.prototype.handleDrawEnd_ = function(evt) {\n  const feature = new olFeature(evt.detail.feature.getGeometry());\n  this.features.push(feature);\n};\n\n\n/**\n * Cleanup event listeners and remove the interaction from the map.\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {\n  olEvents.unlistenByKey(this.interactionListenerKey_);\n  this.interaction_.setActive(false);\n  this.map.removeInteraction(this.interaction_);\n};\n\n\nexports.controller(\n  'ngeoCreateregularpolygonfromclickController',\n  exports.Controller_\n);\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.toolsComponent\n */\n\n/** @suppress {extraRequire} */\nimport gmfObjecteditingGetWMSFeatureComponent from 'gmf/objectediting/getWMSFeatureComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoEditingCreatefeatureComponent from 'ngeo/editing/createfeatureComponent.js';\n\n/** @suppress {extraRequire} */\nimport ngeoEditingCreateregularpolygonfromclickComponent from 'ngeo/editing/createregularpolygonfromclickComponent.js';\n\nimport ngeoGeometryType from 'ngeo/GeometryType.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscBtnComponent from 'ngeo/misc/btnComponent.js';\n\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\nimport * as olBase from 'ol/index.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfObjecteditingToolsComponent', [\n  gmfObjecteditingGetWMSFeatureComponent.name,\n  ngeoEditingCreatefeatureComponent.name,\n  ngeoEditingCreateregularpolygonfromclickComponent.name,\n  ngeoMiscBtnComponent.name,\n  ngeoMiscToolActivateMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/objectediting/toolsComponent', require('./toolsComponent.html'));\n});\n\n\n/**\n * A list of additional options for this directive that are not defined as\n * html attributes. All keys of this hash are optional. For the complete list\n * of keys and their possible values, see in gmfx.js, under:\n * `gmfx.ObjectEditingToolsOptions`.\n */\nexports.value('gmfObjectEditingToolsOptions', {});\n\n\n/**\n * Directive used to edit the geometry of a single feature using advanced\n * tools.\n *\n * Example:\n *\n *     <gmf-objecteditingtools\n *         gmf-objecteditingtools-active=\"ctrl.objectEditingActive\"\n *         gmf-objecteditingtools-copyfromactive=\"ctrl.objectEditingCopyFromActive\"\n *         gmf-objecteditingtools-deletefromactive=\"ctrl.objectEditingDeleteFromActive\"\n *         gmf-objecteditingtools-feature=\"ctrl.objectEditingFeature\"\n *         gmf-objecteditingtools-geomtype=\"ctrl.objectEditingGeomType\"\n *         gmf-objecteditingtools-map=\"::ctrl.map\"\n *         gmf-objecteditingtools-process=\"::ctrl.process\"\n *         gmf-objecteditingtools-queryablelayerinfo=\"::ctrl.queryableLayerInfo\"\n *         gmf-objecteditingtools-requireslayer=\"ctrl.requiresLayer\"\n *         gmf-objecteditingtools-sketchfeatures=\"::ctrl.sketchFeatures\">\n *     </gmf-objecteditingtools>\n *\n * @htmlAttribute {boolean} gmf-objecteditingtools-active Whether the\n *     directive is active or not.\n * @htmlAttribute {boolean} gmf-objecteditingtools-copyfromactive Whether the\n *     'Copy from' tool is active or not.\n * @htmlAttribute {boolean} gmf-objecteditingtools-deletefromactive Whether the\n *     'Delete from' tool is active or not.\n * @htmlAttribute {ol.Feature} gmf-objecteditingtools-feature The feature to\n *     edit.\n * @htmlAttribute {string} gmf-objecteditingtools-geomtype The geometry type.\n * @htmlAttribute {ol.Map} gmf-objecteditingtools-map The map.\n * @htmlAttribute {string} gmf-objectediting-process Determines the\n *     behavior to adopt when sketch features are added.\n * @htmlAttribute {gmfx.ObjectEditingQueryableLayerInfo} gmf-objectediting-queryablelayerinfo\n *     Queryable layer information.\n * @htmlAttribute {boolean} gmf-objectediting-requireslayer Flag that determines\n *     if the currently active tool requires a queryable layer or not.\n * @htmlAttribute {ol.Collection.<ol.Feature>} gmf-objectediting-sketchfeatures\n *     Collection of temporary features being drawn by the tools.\n * @return {angular.Directive} The directive specs.\n * @ngInject\n * @ngdoc directive\n * @ngname gmfObjecteditingtools\n */\nexports.directive_ = function() {\n  return {\n    controller: 'GmfObjecteditingtoolsController as oetCtrl',\n    scope: {\n      'active': '=gmfObjecteditingtoolsActive',\n      'copyFromActive': '=gmfObjecteditingtoolsCopyfromactive',\n      'deleteFromActive': '=gmfObjecteditingtoolsDeletefromactive',\n      'feature': '<gmfObjecteditingtoolsFeature',\n      'geomType': '<gmfObjecteditingtoolsGeomtype',\n      'map': '<gmfObjecteditingtoolsMap',\n      'process': '=gmfObjecteditingtoolsProcess',\n      'queryableLayerInfo': '=gmfObjecteditingtoolsQueryablelayerinfo',\n      'requiresLayer': '=gmfObjecteditingtoolsRequireslayer',\n      'sketchFeatures': '<gmfObjecteditingtoolsSketchfeatures'\n    },\n    bindToController: true,\n    templateUrl: 'gmf/objectediting/toolsComponent'\n  };\n};\n\nexports.directive('gmfObjecteditingtools',\n  exports.directive_);\n\n\n/**\n * @param {angular.$injector} $injector Main injector.\n * @param {!angular.Scope} $scope Scope.\n * @param {ngeo.misc.ToolActivateMgr} ngeoToolActivateMgr Ngeo ToolActivate manager\n *     service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfObjecteditingtoolsController\n */\nexports.Controller_ = function($injector, $scope, ngeoToolActivateMgr) {\n\n  // == Scope properties ==\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.copyFromActive;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.deleteFromActive;\n\n  /**\n   * @type {ol.Feature}\n   * @export\n   */\n  this.feature;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.geomType;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {gmfx.ObjectEditingQueryableLayerInfo}\n   * @export\n   */\n  this.queryableLayerInfo;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.process;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.requiresLayer;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @export\n   */\n  this.sketchFeatures;\n\n\n  // == Injected properties ==\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {ngeo.misc.ToolActivateMgr}\n   * @private\n   */\n  this.ngeoToolActivateMgr_ = ngeoToolActivateMgr;\n\n  // == Other properties ==\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.geomTypePolygon = ngeoGeometryType.POLYGON;\n\n  /**\n   * @type {Array.<string>}\n   * @private\n   */\n  this.toolActiveNames_ = [];\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.drawActive = false;\n\n  this.registerTool_('drawActive',\n    exports.ProcessType.ADD);\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.eraseActive = false;\n\n  this.registerTool_('eraseActive',\n    exports.ProcessType.DELETE);\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.drawTriangleActive = false;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.triangleAngle = Math.PI / 180 * 90; // 90 degrees\n\n  const oeToolsOptions = /** @type {gmfx.ObjectEditingToolsOptions} */ (\n    $injector.get('gmfObjectEditingToolsOptions'));\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.triangleRadius = oeToolsOptions.regularPolygonRadius !== undefined ?\n    oeToolsOptions.regularPolygonRadius : 100;\n\n  this.registerTool_('drawTriangleActive',\n    exports.ProcessType.ADD);\n\n  this.registerTool_('copyFromActive',\n    exports.ProcessType.ADD, true);\n\n  this.registerTool_('deleteFromActive',\n    exports.ProcessType.DELETE, true);\n\n  $scope.$on('$destroy', this.handleDestroy_.bind(this));\n};\n\n/**\n * Init the controller\n */\nexports.Controller_.prototype.$onInit = function() {\n  this.scope_.$watch(\n    () => this.active,\n    (newVal, oldVal) => {\n      // if it's not active, deactive tools\n      if (!this.active) {\n        this.requiresLayer = false;\n        for (let i = 0, ii = this.toolActiveNames_.length; i < ii; i++) {\n          this[this.toolActiveNames_[i]] = false;\n        }\n      }\n    }\n  );\n};\n\n\n/**\n * Register a tool using its `active` property name and what behavior it should\n * have when it is active and a sketch feature is added\n *\n * This method:\n *  - registers a watcher on the tool active property to manage this directive\n *    main active property, i.e the directive is considered active when one\n *    of the tools is active,  otherwise it's not active.\n *\n *  - creates a `ngeo.misc.ToolActivate` object and registers it in a group so\n *    that only one tool can be active at a time\n *\n * @param {string} toolActiveName The name of the active property for the tool.\n * @param {string} process The behavior the tool should use when active\n *     and when sketch features are added.\n * @param {boolean=} opt_requiresLayer Whether the tool requires the queryable\n *     layer or not. Defaults to `false`.\n * @private\n */\nexports.Controller_.prototype.registerTool_ = function(\n  toolActiveName, process, opt_requiresLayer\n) {\n\n  const requiresLayer = opt_requiresLayer === true;\n\n  this.scope_.$watch(\n    () => this[toolActiveName],\n    this.handleToolActiveChange_.bind(this, process, requiresLayer)\n  );\n\n  const group = `${exports.Controller_.NAMESPACE_}-${olBase.getUid(this)}`;\n  const toolActivate = new ngeoMiscToolActivate(this, toolActiveName);\n  this.ngeoToolActivateMgr_.registerTool(group, toolActivate, false);\n\n  this.toolActiveNames_.push(toolActiveName);\n\n};\n\n\n/**\n * Called when any of the tool 'active' property changes.\n * @param {string} process The behavior the tool should use when active.\n * @param {boolean} requiresLayer Whether the tool requires the queryable\n *     layer or not.\n * @param {boolean|undefined} newVal New value.\n * @private\n */\nexports.Controller_.prototype.handleToolActiveChange_ = function(\n  process, requiresLayer, newVal\n) {\n\n  // Update process if a tool was activated.\n  if (newVal) {\n    this.process = process;\n    this.requiresLayer = requiresLayer;\n  }\n\n  // If one tool is active, update active property to true.\n  let active = false;\n  for (let i = 0, ii = this.toolActiveNames_.length; i < ii; i++) {\n    active = this[this.toolActiveNames_[i]];\n    if (active) {\n      break;\n    }\n  }\n  this.active = active;\n};\n\n\n/**\n * @private\n */\nexports.Controller_.prototype.handleDestroy_ = function() {};\n\n\nexports.controller('GmfObjecteditingtoolsController', exports.Controller_);\n\n\n/**\n * @const\n * @private\n */\nexports.Controller_.NAMESPACE_ = 'oet';\n\n\n/**\n * @enum {string}\n */\nexports.ProcessType = {\n  ADD: 'add',\n  DELETE: 'delete'\n};\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.component\n */\nimport gmfEditingEditFeature from 'gmf/editing/EditFeature.js';\nimport gmfLayertreeSyncLayertreeMap from 'gmf/layertree/SyncLayertreeMap.js';\nimport gmfLayertreeTreeManager from 'gmf/layertree/TreeManager.js';\nimport gmfObjecteditingGeom from 'gmf/objectediting/geom.js';\nimport gmfObjecteditingQuery from 'gmf/objectediting/Query.js';\n\n/** @suppress {extraRequire} */\nimport gmfObjecteditingToolsComponent from 'gmf/objectediting/toolsComponent.js';\n\nimport googAsserts from 'goog/asserts.js';\n\n\nimport ngeoMapLayerHelper from 'ngeo/map/LayerHelper.js';\nimport ngeoMiscDecorate from 'ngeo/misc/decorate.js';\nimport ngeoMiscFeatureHelper from 'ngeo/misc/FeatureHelper.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\n\n/** @suppress {extraRequire} */\nimport ngeoMiscToolActivateMgr from 'ngeo/misc/ToolActivateMgr.js';\n\nimport ngeoUtils from 'ngeo/utils.js';\nimport * as olBase from 'ol/index.js';\nimport olCollection from 'ol/Collection.js';\nimport * as olEvents from 'ol/events.js';\nimport olFormatGeoJSON from 'ol/format/GeoJSON.js';\nimport Point from 'ol/geom/Point.js';\nimport LineString from 'ol/geom/LineString.js';\nimport LinearRing from 'ol/geom/LinearRing.js';\nimport Polygon from 'ol/geom/Polygon.js';\nimport MultiPoint from 'ol/geom/MultiPoint.js';\nimport MultiLineString from 'ol/geom/MultiLineString.js';\nimport MultiPolygon from 'ol/geom/MultiPolygon.js';\nimport GeometryCollection from 'ol/geom/GeometryCollection.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olInteractionModify from 'ol/interaction/Modify.js';\nimport olStyleCircle from 'ol/style/Circle.js';\nimport olStyleFill from 'ol/style/Fill.js';\nimport olStyleStroke from 'ol/style/Stroke.js';\nimport olStyleStyle from 'ol/style/Style.js';\n\nimport OL3Parser from 'jsts/io/OL3Parser.js';\nimport 'jsts/monkey.js';\n\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfObjectEditingComponent', [\n  gmfEditingEditFeature.module.name,\n  gmfLayertreeSyncLayertreeMap.module.name,\n  gmfLayertreeTreeManager.module.name,\n  gmfObjecteditingQuery.module.name,\n  gmfObjecteditingToolsComponent.name,\n  ngeoMapLayerHelper.module.name,\n  ngeoMiscFeatureHelper.module.name,\n  ngeoMiscToolActivateMgr.module.name,\n]);\n\n\nexports.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/objectediting', require('./component.html'));\n});\n\n\nexports.value('gmfObjecteditingTemplateUrl',\n  /**\n   * @param {!angular.JQLite} $element Element.\n   * @param {!angular.Attributes} $attrs Attributes.\n   * @return {string} Template URL.\n   */\n  ($element, $attrs) => {\n    const templateUrl = $attrs['gmfObjecteditingTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'gmf/objectediting';\n  }\n);\n\n\n/**\n * @param {!angular.JQLite} $element Element.\n * @param {!angular.Attributes} $attrs Attributes.\n * @param {!function(!angular.JQLite, !angular.Attributes): string} gmfObjecteditingTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction gmfObjecteditingTemplateUrl($element, $attrs, gmfObjecteditingTemplateUrl) {\n  return gmfObjecteditingTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Component used to edit the geometry of a single feature using advanced\n * tools. The geometry must be Multi.\n *\n * Example:\n *\n *     <gmf-objectediting\n *         gmf-objectediting-active=\"ctrl.objectEditingActive\"\n *         gmf-objectediting-feature=\"ctrl.objectEditingFeature\"\n *         gmf-objectediting-geomtype=\"ctrl.objectEditingGeomType\"\n *         gmf-objectediting-layernodeid=\"ctrl.objectEditingLayerNodeId\"\n *         gmf-objectediting-map=\"::ctrl.map\"\n *         gmf-objectediting-sketchfeatures=\"::ctrl.sketchFeatures\">\n *     </gmf-objectediting>\n *\n * @htmlAttribute {boolean} gmf-objectediting-active Whether the component is\n *     active or not.\n * @htmlAttribute {ol.Feature} gmf-objectediting-feature The feature to edit.\n * @htmlAttribute {string} gmf-objectediting-geomtype The geometry type.\n * @htmlAttribute {number} gmf-objectediting-layernodeid The GMF layer node id.\n * @htmlAttribute {ol.Map} gmf-objectediting-map The map.\n * @htmlAttribute {ol.Collection.<ol.Feature>} gmf-objectediting-sketchfeatures\n *     Collection of temporary features being drawn by the tools.\n * @ngdoc component\n * @ngname gmfObjectediting\n */\nexports.component_ = {\n  controller: 'GmfObjecteditingController as oeCtrl',\n  bindings: {\n    'active': '=gmfObjecteditingActive',\n    'feature': '<gmfObjecteditingFeature',\n    'geomType': '<gmfObjecteditingGeomtype',\n    'layerNodeId': '<gmfObjecteditingLayernodeid',\n    'map': '<gmfObjecteditingMap',\n    'sketchFeatures': '<gmfObjecteditingSketchfeatures'\n  },\n  templateUrl: gmfObjecteditingTemplateUrl\n};\n\nexports.component('gmfObjectediting', exports.component_);\n\n\n/**\n * @param {!angular.Scope} $scope Angular scope.\n * @param {!angular.$timeout} $timeout Angular timeout service.\n * @param {!angularGettext.Catalog} gettextCatalog Gettext catalog.\n * @param {!gmf.editing.EditFeature} gmfEditFeature Gmf edit feature service.\n * @param {!gmf.objectediting.Query} gmfObjectEditingQuery Gmf ObjectEditing\n *     query service.\n * @param {!gmf.layertree.TreeManager} gmfTreeManager The gmf TreeManager service.\n * @param {!ngeo.misc.FeatureHelper} ngeoFeatureHelper Ngeo feature helper service.\ngoog.require('ngeo.map.LayerHelper');\n * @param {!ngeo.map.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.\n * @param {!ngeo.misc.ToolActivateMgr} ngeoToolActivateMgr Ngeo ToolActivate manager\n *     service.\n * @constructor\n * @private\n * @ngInject\n * @ngdoc controller\n * @ngname GmfObjecteditingController\n */\nexports.Controller = function($scope, $timeout, gettextCatalog,\n  gmfEditFeature, gmfObjectEditingQuery, gmfTreeManager,\n  ngeoFeatureHelper, ngeoLayerHelper, ngeoToolActivateMgr) {\n\n  // == Scope properties ==\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.active;\n\n  /**\n   * @type {ol.Feature}\n   * @export\n   */\n  this.feature;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.geomType;\n\n  /**\n   * @type {number}\n   * @export\n   */\n  this.layerNodeId;\n\n  /**\n   * @type {ol.Map}\n   * @export\n   */\n  this.map;\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @export\n   */\n  this.sketchFeatures;\n\n\n  // == Injected properties ==\n\n  /**\n   * @type {!angular.Scope}\n   * @private\n   */\n  this.scope_ = $scope;\n\n  /**\n   * @type {!angular.$timeout}\n   * @private\n   */\n  this.timeout_ = $timeout;\n\n  /**\n   * @type {!angularGettext.Catalog}\n   * @private\n   */\n  this.gettextCatalog_ = gettextCatalog;\n\n  /**\n   * @type {!gmf.editing.EditFeature}\n   * @private\n   */\n  this.gmfEditFeature_ = gmfEditFeature;\n\n  /**\n   * @type {!gmf.objectediting.Query}\n   * @private\n   */\n  this.gmfObjectEditingQuery_ = gmfObjectEditingQuery;\n\n  /**\n   * @type {Array.<!gmfx.ObjectEditingQueryableLayerInfo>}\n   * @export\n   */\n  this.queryableLayersInfo;\n\n  /**\n   * @type {gmfx.ObjectEditingQueryableLayerInfo}\n   * @export\n   */\n  this.selectedQueryableLayerInfo;\n\n  /**\n   * Whether to show or hide the queryable list of layers. It is shown only\n   * when a tool requires it, which is managed in the `gmf-objecteditingtools`\n   * component.\n   * @type {boolean}\n   * @export\n   */\n  this.queryableLayerListShown = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.copyFromActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.deleteFromActive = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.featureHasGeom;\n\n  /**\n   * @type {!ngeo.map.LayerHelper}\n   * @private\n   */\n  this.ngeoLayerHelper_ = ngeoLayerHelper;\n\n  /**\n   * @type {!gmf.layertree.TreeManager}\n   * @private\n   */\n  this.gmfTreeManager_ = gmfTreeManager;\n\n  /**\n   * @type {!ngeo.misc.FeatureHelper}\n   * @private\n   */\n  this.ngeoFeatureHelper_ = ngeoFeatureHelper;\n\n  /**\n   * @type {!ngeo.misc.ToolActivateMgr}\n   * @private\n   */\n  this.ngeoToolActivateMgr_ = ngeoToolActivateMgr;\n\n\n  // == Other properties ==\n\n  /**\n   * @type {boolean}\n   * @private\n   */\n  this.skipGeometryChange_ = false;\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.process = gmfObjecteditingToolsComponent.ProcessType.ADD;\n\n  /**\n   * @type {?ol.layer.Image|ol.layer.Tile}\n   * @private\n   */\n  this.editableWMSLayer_ = null;\n\n  /**\n   * @type {!jsts.io.OL3Parser}\n   * @private\n   */\n  this.jstsOL3Parser_ = new OL3Parser(undefined, {\n    geom: {\n      Point, LineString, LinearRing, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeometryCollection\n    }\n  });\n\n  /**\n   * The state of the feature determines whether the next 'save' request\n   * should be an 'insert' or 'update' one.\n   * @type {string|undefined}\n   * @private\n   */\n  this.state_;\n\n  /**\n   * @type {!Array.<?ol.geom.Geometry>}\n   * @private\n   */\n  this.geometryChanges_ = [];\n\n  /**\n   * @type {!gmfx.StylesObject}\n   * @private\n   */\n  this.defaultStyles_ = {};\n\n  /**\n   * @type {!gmfx.StylesObject}\n   * @private\n   */\n  this.defaultStylesWoVertice_ = {};\n\n  /**\n   * @type {!gmfx.StylesObject}\n   * @private\n   */\n  this.dirtyStyles_ = {};\n\n  /**\n   * @type {!gmfx.StylesObject}\n   * @private\n   */\n  this.dirtyStylesWoVertice_ = {};\n\n  /**\n   * Flag that is toggled while a request is pending.\n   * @type {boolean}\n   * @export\n   */\n  this.pending = false;\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.dirty = false;\n\n  /**\n   * @type {!Array.<!ol.EventsKey>}\n   * @private\n   */\n  this.listenerKeys_ = [];\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.features_ = new olCollection();\n\n  /**\n   * @type {!ol.Collection}\n   * @private\n   */\n  this.interactions_ = new olCollection();\n\n  /**\n   * @type {!ol.interaction.Modify}\n   * @private\n   */\n  this.modify_ = new olInteractionModify({\n    deleteCondition: ngeoUtils.deleteCondition,\n    features: this.features_,\n    style: ngeoFeatureHelper.getVertexStyle(false)\n  });\n  this.interactions_.push(this.modify_);\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @private\n   */\n  this.modifyToolActivate_ = new ngeoMiscToolActivate(this.modify_, 'active');\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.toolsActive = false;\n\n  /**\n   * @type {!ngeo.misc.ToolActivate}\n   * @private\n   */\n  this.toolsToolActivate_ = new ngeoMiscToolActivate(this, 'toolsActive');\n};\n\n/**\n * Init the controller\n */\nexports.Controller.prototype.$onInit = function() {\n  this.gmfObjectEditingQuery_.getQueryableLayersInfo().then(\n    this.handleGetQueryableLayersInfo_.bind(this)\n  );\n\n  this.scope_.$watch(\n    () => this.active,\n    (newVal, oldVal) => {\n      if (newVal != oldVal) {\n        this.toggle_(newVal);\n      }\n    }\n  );\n\n  this.scope_.$watchCollection(\n    () => {\n      if (this.gmfTreeManager_.rootCtrl) {\n        return this.gmfTreeManager_.rootCtrl.children;\n      }\n    },\n    (value) => {\n      // Timeout required, because the collection event is fired before the\n      // leaf nodes are created and they are the ones we're looking for here.\n      this.timeout_(() => {\n        if (value) {\n          this.unregisterAllTreeCtrl_();\n          this.gmfTreeManager_.rootCtrl.traverseDepthFirst(\n            this.registerTreeCtrl_.bind(this)\n          );\n        }\n      });\n    }\n  );\n\n  const geometry = this.feature.getGeometry();\n  this.state_ = geometry ? exports.Controller.State.UPDATE :\n    exports.Controller.State.INSERT;\n\n  this.scope_.$watchCollection(\n    () => this.geometryChanges_,\n    (newVal, oldVal) => {\n      if (newVal.length) {\n        if (newVal.length === 1) {\n          this.dirty = false;\n        } else {\n          this.dirty = true;\n        }\n      }\n    }\n  );\n\n  const defaultColor = [39, 155, 145];\n  const dirtyColor = [153, 51, 51];\n  this.initializeStyles_(this.defaultStyles_, defaultColor);\n  this.initializeStyles_(this.defaultStylesWoVertice_, defaultColor, false);\n  this.initializeStyles_(this.dirtyStyles_, dirtyColor);\n  this.initializeStyles_(this.dirtyStylesWoVertice_, dirtyColor, false);\n\n  this.scope_.$watch(\n    () => this.dirty,\n    this.setFeatureStyle_.bind(this)\n  );\n\n  this.features_.push(this.feature);\n\n  this.featureHasGeom = !gmfObjecteditingGeom.isEmpty(geometry);\n\n  // Toggle on\n  this.initializeInteractions_();\n  this.toggle_(true);\n  this.resetGeometryChanges_();\n\n  this.scope_.$on('$destroy', this.handleDestroy_.bind(this));\n};\n\n\n// == API methods ==\n\n\n/**\n * Delete the feature after asking for a confirmation.\n * @export\n */\nexports.Controller.prototype.delete = function() {\n  const gettextCatalog = this.gettextCatalog_;\n  const msg = gettextCatalog.getString(\n    'Do you really want to delete the feature?');\n  // Confirm deletion first\n  if (confirm(msg)) {\n    this.dirty = false;\n    this.pending = true;\n\n    this.gmfEditFeature_.deleteFeature(\n      this.layerNodeId,\n      this.feature\n    ).then(\n      this.handleDeleteFeature_.bind(this)\n    );\n  }\n\n};\n\n\n/**\n * Save the current modifications.\n * @export\n */\nexports.Controller.prototype.save = function() {\n\n  this.pending = true;\n\n  // The geometry of the feature may contain Z in its coordinates, which\n  // GMF doesn't support.  This section ensures that the geometry gets purged\n  // of all Z from the coordinates before saving.\n  //\n  // Also, this is only done before saving on a clone of the feature. Doing\n  // it directly on the feature makes JSTS complain.\n  const feature = this.feature.clone();\n  feature.setId(this.feature.getId());\n  const geometry = feature.getGeometry();\n  if (geometry) {\n    gmfObjecteditingGeom.toXY(geometry);\n  }\n\n  if (this.state_ === exports.Controller.State.INSERT) {\n    this.gmfEditFeature_.insertFeatures(\n      this.layerNodeId,\n      [feature]\n    ).then(\n      this.handleEditFeature_.bind(this)\n    );\n  } else if (this.state_ === exports.Controller.State.UPDATE) {\n    this.gmfEditFeature_.updateFeature(\n      this.layerNodeId,\n      feature\n    ).then(\n      this.handleEditFeature_.bind(this)\n    );\n  }\n};\n\n\n/**\n * Undo the latest modifications.\n * @export\n */\nexports.Controller.prototype.undo = function() {\n\n  if (this.geometryChanges_.length <= 1) {\n    return;\n  }\n\n  this.skipGeometryChange_ = true;\n\n  this.geometryChanges_.pop();\n  const clone = exports.Controller.cloneGeometry_(\n    this.geometryChanges_[this.geometryChanges_.length - 1]);\n\n  this.feature.setGeometry(clone);\n\n  this.skipGeometryChange_ = false;\n};\n\n\n/**\n * @return {boolean} Whether the state is INSERT or not.\n * @export\n */\nexports.Controller.prototype.isStateInsert = function() {\n  return this.state_ === exports.Controller.State.INSERT;\n};\n\n\n// == Private methods ==\n\n\n/**\n * Called after a delete request.\n * @param {angular.$http.Response} resp Ajax response.\n * @private\n */\nexports.Controller.prototype.handleDeleteFeature_ = function(resp) {\n  this.feature.setGeometry(null);\n  this.resetGeometryChanges_();\n  this.state_ = exports.Controller.State.INSERT;\n  this.pending = false;\n  this.refreshWMSLayer_();\n};\n\n\n/**\n * Called after an 'insert' or 'update' request.\n * @param {angular.$http.Response} resp Ajax response.\n * @private\n */\nexports.Controller.prototype.handleEditFeature_ = function(resp) {\n  // (1) Update the id\n  const features = new olFormatGeoJSON().readFeatures(resp.data);\n  if (features.length) {\n    this.feature.setId(features[0].getId());\n  }\n  // (2) Reset geometry changes\n  this.resetGeometryChanges_();\n  // (3) Update state\n  if (this.feature.getGeometry()) {\n    this.state_ = exports.Controller.State.UPDATE;\n  } else {\n    this.state_ = exports.Controller.State.INSERT;\n  }\n  // (4) No longer pending\n  this.pending = false;\n  // (5) Refresh WMS layer\n  this.refreshWMSLayer_();\n};\n\n\n/**\n * Initialize interactions by setting them inactive and decorating them\n * @private\n */\nexports.Controller.prototype.initializeInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    interaction.setActive(false);\n    ngeoMiscDecorate.interaction(interaction);\n  });\n};\n\n\n/**\n * Register interactions by adding them to the map\n * @private\n */\nexports.Controller.prototype.registerInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.addInteraction(interaction);\n  });\n};\n\n\n/**\n * Unregister interactions, i.e. remove them from the map\n * @private\n */\nexports.Controller.prototype.unregisterInteractions_ = function() {\n  this.interactions_.forEach((interaction) => {\n    this.map.removeInteraction(interaction);\n  });\n};\n\n\n/**\n * Activate or deactivate this component.\n * @param {boolean} active Whether to activate this component or not.\n * @private\n */\nexports.Controller.prototype.toggle_ = function(active) {\n\n  const keys = this.listenerKeys_;\n  const uid = `${exports.Controller.NAMESPACE_}-${olBase.getUid(this)}`;\n  const toolMgr = this.ngeoToolActivateMgr_;\n\n  if (active) {\n\n    keys.push(\n      olEvents.listen(\n        this.feature,\n        `change:${this.feature.getGeometryName()}`,\n        this.handleFeatureGeometryChange_,\n        this\n      )\n    );\n\n    keys.push(\n      olEvents.listen(\n        this.modify_,\n        'change:active',\n        this.setFeatureStyle_,\n        this\n      )\n    );\n\n    keys.push(\n      olEvents.listen(\n        this.modify_,\n        'modifyend',\n        this.handleModifyInteractionModifyEnd_,\n        this\n      )\n    );\n\n    keys.push(\n      olEvents.listen(\n        window,\n        'beforeunload',\n        this.handleWindowBeforeUnload_,\n        this\n      )\n    );\n\n    keys.push(\n      olEvents.listen(\n        this.sketchFeatures,\n        'add',\n        this.handleSketchFeaturesAdd_,\n        this\n      )\n    );\n\n    toolMgr.registerTool(uid, this.modifyToolActivate_, true);\n    toolMgr.registerTool(uid, this.toolsToolActivate_, false);\n\n    this.registerInteractions_();\n\n  } else {\n\n    this.unregisterInteractions_();\n\n    keys.forEach(olEvents.unlistenByKey);\n    keys.length = 0;\n\n    toolMgr.unregisterTool(uid, this.modifyToolActivate_);\n    toolMgr.unregisterTool(uid, this.toolsToolActivate_);\n\n  }\n\n  this.toolsActive = active;\n  this.modify_.setActive(active);\n};\n\n\n/**\n * Undo all current changes.\n * @private\n */\nexports.Controller.prototype.undoAllChanges_ = function() {\n  const clone = exports.Controller.cloneGeometry_(\n    this.geometryChanges_[0]);\n  this.feature.setGeometry(clone);\n\n  this.resetGeometryChanges_();\n  this.dirty = false;\n  this.setFeatureStyle_();\n};\n\n\n/**\n * Reset the array of geometry changes.  If there are more than one changes,\n * reset them entirely. Then, if there's no changes, clone the current geometry\n * as the first entry. One entry means that there's no changes.\n * @private\n */\nexports.Controller.prototype.resetGeometryChanges_ = function() {\n  if (this.geometryChanges_.length > 1) {\n    this.geometryChanges_.length = 0;\n  }\n  if (this.geometryChanges_.length === 0) {\n    const geometry = this.feature.getGeometry();\n    const clone = exports.Controller.cloneGeometry_(geometry);\n    this.geometryChanges_.push(clone);\n  }\n};\n\n\n/**\n * Called after the modification interaction has completed modifying the\n * existing geometry. The new geometry is pushed in the changes array.\n * If the geometry type is `MultiPolygon`, we check if any of the inner\n * geometries intersects with one an other first. Those that does are merged\n * before being pushed to the changes.\n *\n * @param {ol.interaction.Modify.Event} evt Event.\n * @private\n */\nexports.Controller.prototype.handleModifyInteractionModifyEnd_ = function(\n  evt\n) {\n  let geometry = this.feature.getGeometry();\n\n  if (geometry instanceof MultiPolygon) {\n    const jstsGeom = this.jstsOL3Parser_.read(geometry);\n    const jstsBuffered = jstsGeom.buffer(0);\n    geometry = ngeoUtils.toMulti(this.jstsOL3Parser_.write(jstsBuffered));\n    this.skipGeometryChange_ = true;\n    this.feature.setGeometry(geometry.clone());\n    this.skipGeometryChange_ = false;\n  }\n\n  const clone = exports.Controller.cloneGeometry_(geometry);\n  googAsserts.assert(clone);\n  this.geometryChanges_.push(clone);\n  this.scope_.$apply();\n};\n\n\n/**\n * @param {gmfx.StylesObject} styles Hash of style.\n * @param {ol.Color} color Color.\n * @param {boolean=} opt_incVertice Whether to include vertice or not. Defaults\n *     to `true`.\n * @private\n */\nexports.Controller.prototype.initializeStyles_ = function(\n  styles, color, opt_incVertice\n) {\n\n  const incVertice = opt_incVertice !== false;\n  const rgbaColor = color.slice();\n  rgbaColor.push(0.3);\n\n  const image = new olStyleCircle({\n    radius: 8,\n    stroke: new olStyleStroke({\n      color: color,\n      width: 1\n    }),\n    fill: new olStyleFill({color: rgbaColor})\n  });\n\n  styles['Point'] = new olStyleStyle({\n    image\n  });\n  styles['MultiPoint'] = new olStyleStyle({\n    image\n  });\n\n  styles['LineString'] = [\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: color,\n        width: 3\n      })\n    })\n  ];\n  if (incVertice) {\n    styles['LineString'].push(\n      this.ngeoFeatureHelper_.getVertexStyle(true)\n    );\n  }\n  styles['MultiLineString'] = [\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: color,\n        width: 3\n      })\n    })\n  ];\n  if (incVertice) {\n    styles['MultiLineString'].push(\n      this.ngeoFeatureHelper_.getVertexStyle(true)\n    );\n  }\n\n  styles['Polygon'] = [\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: color,\n        width: 2\n      }),\n      fill: new olStyleFill({\n        color: rgbaColor\n      })\n    })\n  ];\n  if (incVertice) {\n    styles['Polygon'].push(\n      this.ngeoFeatureHelper_.getVertexStyle(true)\n    );\n  }\n  styles['MultiPolygon'] = [\n    new olStyleStyle({\n      stroke: new olStyleStroke({\n        color: color,\n        width: 2\n      }),\n      fill: new olStyleFill({\n        color: rgbaColor\n      })\n    })\n  ];\n  if (incVertice) {\n    styles['MultiPolygon'].push(\n      this.ngeoFeatureHelper_.getVertexStyle(true)\n    );\n  }\n\n};\n\n\n/**\n * Set the style of the feature depending on:\n *  - the geometry type\n *  - the dirty state of the component\n *  - whether the modify control is active or not\n *\n * @private\n */\nexports.Controller.prototype.setFeatureStyle_ = function() {\n  const geometry = this.feature.getGeometry();\n  if (geometry) {\n    const geomType = geometry.getType();\n    const modifyActive = this.modify_.getActive();\n    let style;\n    if (this.dirty) {\n      if (modifyActive) {\n        style = this.dirtyStyles_[geomType];\n      } else {\n        style = this.dirtyStylesWoVertice_[geomType];\n      }\n    } else {\n      if (modifyActive) {\n        style = this.defaultStyles_[geomType];\n      } else {\n        style = this.defaultStylesWoVertice_[geomType];\n      }\n    }\n    this.feature.setStyle(style);\n  }\n};\n\n\n/**\n * Registers a newly added Layertree controller 'leaf', i.e. groups are\n * excluded.\n *\n * If the Layertree controller node id is equal to the `layerNodeId` configured\n * with this component, then find the WMS layer associated with it for\n * for refresh purpose.\n *\n * @param {ngeo.layertree.Controller} treeCtrl Layertree controller to register\n * @private\n */\nexports.Controller.prototype.registerTreeCtrl_ = function(treeCtrl) {\n\n  // Skip any Layertree controller that has a node that is not a leaf\n  const node = /** @type {gmfThemes.GmfGroup|gmfThemes.GmfLayer} */ (\n    treeCtrl.node);\n  if (node.children && node.children.length) {\n    return;\n  }\n\n  // Set editable WMS layer for refresh purpose\n  if (node.id === this.layerNodeId) {\n    const layer = gmfLayertreeSyncLayertreeMap.getLayer(treeCtrl);\n    googAsserts.assert(\n      layer instanceof olLayerImage || layer instanceof olLayerTile);\n    this.editableWMSLayer_ = layer;\n  }\n\n};\n\n\n/**\n * Unregisters all currently registered Layertree controllers.\n *\n * Unset the WMS layer associated with the `layerNodeId` configured with\n * this component.\n *\n * @private\n */\nexports.Controller.prototype.unregisterAllTreeCtrl_ = function() {\n  this.editableWMSLayer_ = null;\n};\n\n\n/**\n * Refresh the WMS layer, if set.\n * @private\n */\nexports.Controller.prototype.refreshWMSLayer_ = function() {\n  if (this.editableWMSLayer_) {\n    this.ngeoLayerHelper_.refreshWMSLayer(this.editableWMSLayer_);\n  }\n};\n\n\n/**\n * Called before the window unloads. Show a confirmation message if there are\n * unsaved modifications.\n * @param {Event} e Event.\n * @return {string|undefined} Message\n * @private\n */\nexports.Controller.prototype.handleWindowBeforeUnload_ = function(e) {\n  const gettextCatalog = this.gettextCatalog_;\n  if (this.dirty) {\n    const msg = gettextCatalog.getString('There are unsaved changes.');\n    (e || window.event).returnValue = msg;\n    return msg;\n  }\n  return undefined;\n};\n\n\n/**\n * Called when a feature is added to the collection of sketch features.\n * Depending on the current behaviour, use the added sketch feature to process\n * the existing geometry.\n *\n * @param {ol.Collection.Event} evt Event.\n * @private\n */\nexports.Controller.prototype.handleSketchFeaturesAdd_ = function(evt) {\n  const sketchFeature = /** @type {ol.Feature} */ (evt.element);\n  const sketchGeom = /** @type {ol.geom.Geometry} */ (\n    sketchFeature.getGeometry());\n\n  const geom = this.feature.getGeometry();\n\n  if (geom) {\n    const jstsGeom = this.jstsOL3Parser_.read(geom);\n    const jstsSketchGeom = this.jstsOL3Parser_.read(sketchGeom);\n    let jstsProcessedGeom;\n\n    if (this.process === gmfObjecteditingToolsComponent.ProcessType.ADD) {\n      jstsProcessedGeom = jstsGeom.union(jstsSketchGeom);\n    } else {\n      if (jstsGeom.intersects(jstsSketchGeom)) {\n        jstsProcessedGeom = jstsGeom.difference(jstsSketchGeom);\n      }\n    }\n\n    if (jstsProcessedGeom) {\n      const processedGeom = this.jstsOL3Parser_.write(jstsProcessedGeom);\n      const multiGeom = ngeoUtils.toMulti(processedGeom);\n      this.feature.setGeometry(multiGeom.clone());\n    }\n\n  } else if (this.process === gmfObjecteditingToolsComponent.ProcessType.ADD) {\n    this.feature.setGeometry(ngeoUtils.toMulti(sketchGeom.clone()));\n  }\n\n  this.sketchFeatures.clear();\n};\n\n\n/**\n * Called when the geometry property of the feature changes, i.e. not when the\n * geometry itself changes but when a new geometry is set to the feature.\n *\n * This happens either when resetting the geometry to null, in which case\n * there's nothing to do here. Otherwise, it happens after the combinaison\n * of a sketch geometry with the existing feature geometry. This new geom\n * is pushed in the `geometryChanges_` array.\n *\n * @private\n */\nexports.Controller.prototype.handleFeatureGeometryChange_ = function() {\n  const geom = this.feature.getGeometry();\n  this.timeout_(() => {\n    this.featureHasGeom = !gmfObjecteditingGeom.isEmpty(geom);\n  });\n\n  if (this.skipGeometryChange_) {\n    return;\n  }\n\n  if (geom) {\n    // Use a timeout here, because there can be a scope digest already in\n    // progress. For example, with tools that requires the user to draw\n    // features on the map, we would need to manually call:\n    // this.scope_.$apply();\n    // For tools that use promises instead, such as the \"copy/delete\" from,\n    // a scope is already in progress so we must not invoke it again.\n    this.timeout_(() => {\n      this.geometryChanges_.push(geom.clone());\n    });\n  }\n};\n\n\n/**\n * @param {Array.<gmfx.ObjectEditingQueryableLayerInfo>} layersInfo List\n *     of queryable layers information, which contains the node and ogcServer.\n * @private\n */\nexports.Controller.prototype.handleGetQueryableLayersInfo_ = function(layersInfo) {\n  this.queryableLayersInfo = layersInfo;\n  if (this.queryableLayersInfo.length) {\n    this.selectedQueryableLayerInfo = this.queryableLayersInfo[0];\n  }\n};\n\n\n/**\n * @private\n */\nexports.Controller.prototype.handleDestroy_ = function() {\n  this.features_.clear();\n  this.toggle_(false);\n  this.undoAllChanges_();\n};\n\n\n// == Static methods and type definitions ==\n\n\n/**\n * Utility method that gets the clone of a geometry, which can be null or\n * undefined. In the latter case, a null value is returned instead of a\n * geometry.\n * @param {?ol.geom.Geometry|undefined} geometry A geometry, undefined or\n *     null value.\n * @return {?ol.geom.Geometry} A geometry clone or null value.\n * @private\n */\nexports.Controller.cloneGeometry_ = function(geometry) {\n  let clone = null;\n  if (geometry) {\n    clone = geometry.clone();\n  }\n  return clone;\n};\n\n\n/**\n * @const\n * @private\n */\nexports.Controller.NAMESPACE_ = 'oe';\n\n\n/**\n * @enum {string}\n */\nexports.Controller.State = {\n  INSERT: 'insert',\n  UPDATE: 'update'\n};\n\n\nexports.controller('GmfObjecteditingController',\n  exports.Controller);\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.Manager\n */\nimport gmfEditingEditFeature from 'gmf/editing/EditFeature.js';\nimport ngeoStatemanagerLocation from 'ngeo/statemanager/Location.js';\nimport olFeature from 'ol/Feature.js';\n\n/**\n * A service that looks for certain parameters in the url and use them to fetch\n * a feature using the GMF protocol.\n *\n * @param {angular.$q} $q Angular $q service.\n * @param {gmf.editing.EditFeature} gmfEditFeature Gmf edit feature service.\n * @param {ngeo.statemanager.Location} ngeoLocation ngeo location service.\n * @constructor\n * @struct\n * @ngInject\n */\nconst exports = function($q, gmfEditFeature, ngeoLocation) {\n\n  /**\n   * @type {angular.$q}\n   * @private\n   */\n  this.q_ = $q;\n\n  /**\n   * @type {gmf.editing.EditFeature}\n   * @private\n   */\n  this.gmfEditFeature_ = gmfEditFeature;\n\n  /**\n   * @type {ngeo.statemanager.Location}\n   * @private\n   */\n  this.ngeoLocation_ = ngeoLocation;\n\n  /**\n   * @type {angular.$q.Deferred|null}\n   * @private\n   */\n  this.getFeatureDefered_ = null;\n\n};\n\n\n/**\n * Use the EditFeature service to fetch a single feature using parameters in\n * the url. The method returns a promise that has the feature as argument in\n * the callback method. If any parameter in the url is missing, `null` is\n * returned, otherwise the query is made. If the query returns a feature, it\n * is returned, otherwise one is created with empty geometry and with the\n * property set.\n *\n * @return {angular.$q.Promise} Promise.\n * @export\n */\nexports.prototype.getFeature = function() {\n\n  if (!this.getFeatureDefered_) {\n    this.getFeatureDefered_ = this.q_.defer();\n\n    const geomType = this.ngeoLocation_.getParam(\n      exports.Param.GEOM_TYPE);\n    const id = this.ngeoLocation_.getParam(\n      exports.Param.ID);\n    const layer = this.ngeoLocation_.getParam(\n      exports.Param.LAYER);\n    const property = this.ngeoLocation_.getParam(\n      exports.Param.PROPERTY);\n    const theme = this.ngeoLocation_.getParam(\n      exports.Param.THEME);\n\n    if (geomType && id && layer && property && theme) {\n      this.gmfEditFeature_.getFeaturesWithComparisonFilters(\n        [layer],\n        [{\n          operator: 'eq',\n          property: property,\n          value: id\n        }]\n      ).then(this.handleGetFeatures_.bind(this, property, id));\n    } else {\n      this.getFeatureDefered_.resolve(null);\n    }\n  }\n\n  return this.getFeatureDefered_.promise;\n\n};\n\n\n/**\n * @return {string|undefined} The geometry type.\n * @export\n */\nexports.prototype.getGeomType = function() {\n  return this.ngeoLocation_.getParam(\n    exports.Param.GEOM_TYPE);\n};\n\n\n/**\n * @return {number|undefined} The gmf layer node id.\n * @export\n */\nexports.prototype.getLayerNodeId = function() {\n  return this.ngeoLocation_.getParamAsInt(\n    exports.Param.LAYER);\n};\n\n\n/**\n * Called after getting features with comparison filters. Resolve the deferred\n * promise with the first returned feature (if any), otherwise resolve it\n * with a feature created with an empty geometry and the property key + value\n * that was used in the attempt to fetch it.\n *\n * @param {string} key Property key.\n * @param {string} value Property value.\n * @param {Array.<ol.Feature>} features List of features.\n * @private\n */\nexports.prototype.handleGetFeatures_ = function(key, value, features) {\n  let feature;\n\n  if (features.length) {\n    feature = features[0];\n  } else {\n    const featureProperties = {};\n    featureProperties[key] = value;\n    featureProperties['geometry'] = null;\n    feature = new olFeature(featureProperties);\n  }\n\n  this.getFeatureDefered_.resolve(feature);\n};\n\n\n/**\n * @enum {string}\n * @export\n */\nexports.Param = {\n  /**\n   * @type {string}\n   * @export\n   */\n  GEOM_TYPE: 'objectediting_geomtype',\n  /**\n   * @type {string}\n   * @export\n   */\n  ID: 'objectediting_id',\n  /**\n   * @type {string}\n   * @export\n   */\n  LAYER: 'objectediting_layer',\n  /**\n   * @type {string}\n   * @export\n   */\n  PROPERTY: 'objectediting_property',\n  /**\n   * @type {string}\n   * @export\n   */\n  THEME: 'objectediting_theme'\n};\n\n\n/**\n * @type {!angular.Module}\n */\nexports.module = angular.module('gmfObjectEditingManager', [\n  gmfEditingEditFeature.module.name,\n  ngeoStatemanagerLocation.module.name,\n]);\nexports.module.service('gmfObjectEditingManager', exports);\n\n\nexport default exports;\n","/**\n * @module gmf.objectediting.module\n */\nimport gmfObjecteditingComponent from 'gmf/objectediting/component.js';\nimport gmfObjecteditingGetWMSFeatureComponent from 'gmf/objectediting/getWMSFeatureComponent.js';\nimport gmfObjecteditingManager from 'gmf/objectediting/Manager.js';\nimport gmfObjecteditingQuery from 'gmf/objectediting/Query.js';\nimport gmfObjecteditingToolsComponent from 'gmf/objectediting/toolsComponent.js';\n\n/**\n * @type {!angular.Module}\n */\nconst exports = angular.module('gmfObjecteditingModule', [\n  gmfObjecteditingComponent.name,\n  gmfObjecteditingGetWMSFeatureComponent.name,\n  gmfObjecteditingManager.module.name,\n  gmfObjecteditingQuery.module.name,\n  gmfObjecteditingToolsComponent.name,\n]);\n\n\nexport default exports;\n","/**\n * @module ngeo.proj.EPSG2056\n */\nimport * as olProj from 'ol/proj.js';\n\n/** @suppress {extraRequire} */\nimport * as olProjProj4 from 'ol/proj/proj4.js';\n\nimport somerc from 'ngeo/proj/somerc.js';\nimport proj4 from 'proj4';\n\nconst epsg2056def = [\n  `+proj=${somerc}`,\n  '+lat_0=46.95240555555556',\n  '+lon_0=7.439583333333333',\n  '+k_0=1',\n  '+x_0=2600000',\n  '+y_0=1200000',\n  '+ellps=bessel',\n  '+towgs84=674.374,15.056,405.346,0,0,0,0',\n  '+units=m',\n  '+no_defs'\n].join(' ');\nconst epsg2056extent = [2420000, 1030000, 2900000, 1350000];\n\nproj4.defs('EPSG:2056', epsg2056def);\nolProjProj4.register(proj4);\nolProj.get('EPSG:2056').setExtent(epsg2056extent);\n\nconst exports = 'EPSG:2056';\n\n\nexport default exports;\n","/**\n * @module app.oeedit.Controller\n */\n/**\n * Application entry point.\n *\n * This file includes `goog.require`'s for all the components/directives used\n * by the HTML page and the controller to provide the configuration.\n */\n\nimport gmfControllersAbstractDesktopController from 'gmf/controllers/AbstractDesktopController.js';\nimport './less/main.less';\nimport appBase from '../appmodule.js';\nimport gmfObjecteditingModule from 'gmf/objectediting/module.js';\nimport ngeoMiscToolActivate from 'ngeo/misc/ToolActivate.js';\nimport ngeoProjEPSG2056 from 'ngeo/proj/EPSG2056.js';\nimport ngeoProjEPSG21781 from 'ngeo/proj/EPSG21781.js';\nimport * as olBase from 'ol/index.js';\nimport olCollection from 'ol/Collection.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport Raven from 'raven-js/src/raven.js';\nimport RavenPluginsAngular from 'raven-js/plugins/angular.js';\n\nif (!window.requestAnimationFrame) {\n  alert('Your browser is not supported, please update it or use another one. You will be redirected.\\n\\n'\n    + 'Votre navigateur n\\'est pas supporté, veuillez le mettre à jour ou en utiliser un autre. Vous allez être redirigé.\\n\\n'\n    + 'Ihr Browser wird nicht unterstützt, bitte aktualisieren Sie ihn oder verwenden Sie einen anderen. Sie werden weitergeleitet.');\n  window.location = 'http://geomapfish.org/';\n}\n\n/**\n * @param {angular.Scope} $scope Scope.\n * @param {angular.$injector} $injector Main injector.\n * @param {angular.$timeout} $timeout Angular timeout service.\n * @constructor\n * @extends {gmf.controllers.AbstractDesktopController}\n * @ngInject\n * @export\n */\nconst exports = function($scope, $injector, $timeout) {\n\n  /**\n   * @type {boolean}\n   * @export\n   */\n  this.oeEditActive = false;\n\n  gmfControllersAbstractDesktopController.call(this, {\n    srid: 21781,\n    mapViewConfig: {\n      center: [632464, 185457],\n      zoom: 3,\n      resolutions: [250, 100, 50, 20, 10, 5, 2, 1, 0.5, 0.25, 0.1, 0.05]\n    }\n  }, $scope, $injector);\n\n  /**\n   * The ngeo ToolActivate manager service.\n   * @type {ngeo.misc.ToolActivateMgr}\n   */\n  const ngeoToolActivateMgr = $injector.get('ngeoToolActivateMgr');\n\n  ngeoToolActivateMgr.unregisterGroup('mapTools');\n\n  const oeEditToolActivate = new ngeoMiscToolActivate(this, 'oeEditActive');\n  ngeoToolActivateMgr.registerTool('mapTools', oeEditToolActivate, true);\n\n  const queryToolActivate = new ngeoMiscToolActivate(this, 'queryActive');\n  ngeoToolActivateMgr.registerTool('mapTools', queryToolActivate, false);\n\n  // Set edit tool as default active one\n  $timeout(() => {\n    this.oeEditActive = true;\n  });\n\n  /**\n   * @type {ol.source.Vector}\n   * @private\n   */\n  this.vectorSource_ = new olSourceVector({\n    wrapX: false\n  });\n\n  /**\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.vectorLayer_ = new olLayerVector({\n    source: this.vectorSource_\n  });\n\n  /**\n   * @type {ol.Collection.<ol.Feature>}\n   * @export\n   */\n  this.sketchFeatures = new olCollection();\n\n  /**\n   * @type {ol.layer.Vector}\n   * @private\n   */\n  this.sketchLayer_ = new olLayerVector({\n    source: new olSourceVector({\n      features: this.sketchFeatures,\n      wrapX: false\n    })\n  });\n\n  /**\n   * @type {gmf.theme.Themes} gmfObjectEditingManager The gmf theme service\n   */\n  const gmfThemes = $injector.get('gmfThemes');\n\n  gmfThemes.getThemesObject().then((themes) => {\n    if (themes) {\n      // Add layer vector after\n      this.map.addLayer(this.vectorLayer_);\n      this.map.addLayer(this.sketchLayer_);\n    }\n  });\n\n  /**\n   * @type {gmf.objectediting.Manager} gmfObjectEditingManager The gmf\n   *     ObjectEditing manager service.\n   */\n  const gmfObjectEditingManager = $injector.get('gmfObjectEditingManager');\n\n  /**\n   * @type {string|undefined}\n   * @export\n   */\n  this.oeGeomType = gmfObjectEditingManager.getGeomType();\n\n  /**\n   * @type {number|undefined}\n   * @export\n   */\n  this.oeLayerNodeId = gmfObjectEditingManager.getLayerNodeId();\n\n  /**\n   * @type {?ol.Feature}\n   * @export\n   */\n  this.oeFeature = null;\n\n  gmfObjectEditingManager.getFeature().then((feature) => {\n    this.oeFeature = feature;\n    if (feature) {\n      this.vectorSource_.addFeature(feature);\n    }\n  });\n\n  /**\n   * @type {Array.<string>}\n   * @export\n   */\n  this.searchCoordinatesProjections = [ngeoProjEPSG21781, ngeoProjEPSG2056, 'EPSG:4326'];\n\n  /**\n   * @type {!Array.<number>}\n   * @export\n   */\n  this.scaleSelectorValues = [250000, 100000, 50000, 20000, 10000, 5000, 2000, 1000, 500, 250, 100, 50];\n\n  /**\n   * @type {Array.<string>}\n   * @export\n   */\n  this.elevationLayers = ['aster', 'srtm'];\n\n  /**\n   * @type {string}\n   * @export\n   */\n  this.selectedElevationLayer = this.elevationLayers[0];\n\n  /**\n   * @type {Object.<string, gmfx.ProfileLineConfiguration>}\n   * @export\n   */\n  this.profileLinesconfiguration = {\n    'aster': {color: '#0000A0'},\n    'srtm': {color: '#00A000'}\n  };\n\n  /**\n   * @type {Array.<gmfx.MousePositionProjection>}\n   * @export\n   */\n  this.mousePositionProjections = [{\n    code: ngeoProjEPSG2056,\n    label: 'CH1903+ / LV95',\n    filter: 'ngeoNumberCoordinates::{x}, {y} m'\n  }, {\n    code: ngeoProjEPSG21781,\n    label: 'CH1903 / LV03',\n    filter: 'ngeoNumberCoordinates::{x}, {y} m'\n  }, {\n    code: 'EPSG:4326',\n    label: 'WGS84',\n    filter: 'ngeoDMSCoordinates:2'\n  }];\n\n  // Allow angular-gettext-tools to collect the strings to translate\n  /** @type {angularGettext.Catalog} */\n  const gettextCatalog = $injector.get('gettextCatalog');\n  gettextCatalog.getString('Add a theme');\n  gettextCatalog.getString('Add a sub theme');\n  gettextCatalog.getString('Add a layer');\n\n  if ($injector.has('sentryUrl')) {\n    const options = $injector.has('sentryOptions') ? $injector.get('sentryOptions') : undefined;\n    const raven = new Raven();\n    raven.config($injector.get('sentryUrl'), options)\n      .addPlugin(RavenPluginsAngular)\n      .install();\n  }\n};\n\nolBase.inherits(exports, gmfControllersAbstractDesktopController);\n\nexports.module = angular.module('Appoeedit', [\n  appBase.module.name,\n  gmfControllersAbstractDesktopController.module.name,\n  gmfObjecteditingModule.name,\n]);\n\nexports.module.value('gmfContextualdatacontentTemplateUrl', 'gmf/contextualdata');\nexports.module.run(/* @ngInject */ ($templateCache) => {\n  $templateCache.put('gmf/contextualdata', require('./contextualdata.html'));\n});\n\nexports.module.value('gmfPermalinkOptions', /** @type {gmfx.PermalinkOptions} */ ({\n  pointRecenterZoom: 10\n}));\n\nexports.module.controller('OEEditController', exports);\n\nexport default exports;\n","module.exports = \"<table> <tr> <td translate> Swiss grid (LV03) </td> <td> {{coord_21781|ngeoNumberCoordinates:0:'{x} / {y}'}} </td> </tr> <tr> <td translate> Wgs Coord. </td> <td> {{coord_4326|ngeoNumberCoordinates:2:'{y} / {x}'}} </td> </tr> <tr> <td translate> Wgs Coord. DMS </td> <td> {{coord_4326|ngeoDMSCoordinates:0:'{y} {x}'}} </td> </tr> <tr> <td translate> Elevation (SRTM) </td> <td ng-if=srtm> {{srtm | number}} [m] </td> </tr> <tr> <td translate> Elevation (Aster) </td> <td ng-if=aster> {{aster | number}} [m] </td> </tr> </table> <a ng-href=\\\"https://maps.google.ch/?ie=UTF8&ll={{coord_4326_northern}},{{coord_4326_eastern}}&layer=c&cbll={{coord_4326_northern}},{{coord_4326_eastern}}&cbp=12,57.78,,0,8.1\\\" target=_blank>Google StreetView</a> \";","module.exports = \"<gmf-objecteditingtools gmf-objecteditingtools-active=oeCtrl.toolsActive gmf-objecteditingtools-copyfromactive=oeCtrl.copyFromActive gmf-objecteditingtools-deletefromactive=oeCtrl.deleteFromActive gmf-objecteditingtools-feature=oeCtrl.feature gmf-objecteditingtools-geomtype=::oeCtrl.geomType gmf-objecteditingtools-map=::oeCtrl.map gmf-objecteditingtools-process=oeCtrl.process gmf-objecteditingtools-queryablelayerinfo=oeCtrl.selectedQueryableLayerInfo gmf-objecteditingtools-requireslayer=oeCtrl.queryableLayerListShown gmf-objecteditingtools-sketchfeatures=::oeCtrl.sketchFeatures> </gmf-objecteditingtools> <div class=form-group ng-show=oeCtrl.queryableLayerListShown> <label ng-show=\\\"oeCtrl.copyFromActive === true\\\" class=control-label>{{'Copy from:' | translate}}</label> <label ng-show=\\\"oeCtrl.deleteFromActive === true\\\" class=control-label>{{'Cut from:' | translate}}</label> <select class=form-control ng-model=oeCtrl.selectedQueryableLayerInfo ng-options=\\\"layerInfo.layerNode.name | translate for layerInfo in oeCtrl.queryableLayersInfo\\\"> </select> </div> <form novalidate name=form class=\\\"form gmf-objectediting-form\\\"> <input type=submit value=\\\"{{'Save' | translate}}\\\" class=\\\"btn btn-sm btn-default gmf-objectediting-btn-save\\\" ng-click=\\\"form.$valid && oeCtrl.save()\\\" ng-disabled=\\\"!oeCtrl.dirty || oeCtrl.pending || !oeCtrl.featureHasGeom\\\" title=\\\"{{'Save modifications' | translate}}\\\"> <a class=\\\"btn btn-sm btn-link gmf-objectediting-btn-undo\\\" ng-click=oeCtrl.undo() ng-disabled=\\\"!oeCtrl.dirty || oeCtrl.pending\\\" title=\\\"{{'Undo latest modifications' | translate}}\\\" href>{{'Undo' | translate}}</a> <a class=\\\"btn btn-sm btn-link gmf-objectediting-btn-delete\\\" ng-click=oeCtrl.delete() ng-disabled=\\\"oeCtrl.isStateInsert() || oeCtrl.pending\\\" title=\\\"{{'Delete the feature' | translate}}\\\" href>{{'Delete' | translate}}</a> </form> \";","module.exports = \"<div class=btn-group role=group aria-label=\\\"\\\"> <a href ngeo-btn ngeo-createfeature ngeo-createfeature-active=oetCtrl.drawActive ngeo-createfeature-features=::oetCtrl.sketchFeatures ngeo-createfeature-geom-type=::oetCtrl.geomType ngeo-createfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default\\\" ng-class=\\\"{active: oetCtrl.drawActive}\\\" ng-if=\\\"::(oetCtrl.geomType === 'MultiPoint')\\\" ng-model=oetCtrl.drawActive title=\\\"{{'Add a point to the geometry' | translate}}\\\"> <span class=\\\"fa fa-plus-square-o gmf-icon-oe-draw\\\"> </span> </a> <a href ngeo-btn ngeo-createfeature ngeo-createfeature-active=oetCtrl.drawActive ngeo-createfeature-features=::oetCtrl.sketchFeatures ngeo-createfeature-geom-type=::oetCtrl.geomType ngeo-createfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default\\\" ng-class=\\\"{active: oetCtrl.drawActive}\\\" ng-if=\\\"::(oetCtrl.geomType === 'MultiLineString')\\\" ng-model=oetCtrl.drawActive title=\\\"{{'Add a linestring to the geometry' | translate}}\\\"> <span class=\\\"fa fa-plus-square-o gmf-icon-oe-draw\\\"> </span> </a> <a href ngeo-btn ngeo-createfeature ngeo-createfeature-active=oetCtrl.drawActive ngeo-createfeature-features=::oetCtrl.sketchFeatures ngeo-createfeature-geom-type=::oetCtrl.geomType ngeo-createfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default\\\" ng-class=\\\"{active: oetCtrl.drawActive}\\\" ng-if=\\\"::(oetCtrl.geomType === 'MultiPolygon')\\\" ng-model=oetCtrl.drawActive title=\\\"{{'Add a polygon to the geometry' | translate}}\\\"> <span class=\\\"fa fa-plus-square-o gmf-icon-oe-draw\\\"> </span> </a> <a href ngeo-btn ngeo-createfeature ngeo-createfeature-active=oetCtrl.eraseActive ngeo-createfeature-features=::oetCtrl.sketchFeatures ngeo-createfeature-geom-type=::oetCtrl.geomTypePolygon ngeo-createfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default\\\" ng-class=\\\"{active: oetCtrl.eraseActive}\\\" ng-model=oetCtrl.eraseActive title=\\\"{{'Erase geometry' | translate}}\\\"> <span class=\\\"fa fa-minus-square-o gmf-icon-oe-erase\\\"> </span> </a> <a href ng-if=\\\"::oetCtrl.geomType === 'MultiPolygon'\\\" ngeo-btn ngeo-createregularpolygonfromclick ngeo-createregularpolygonfromclick-active=oetCtrl.drawTriangleActive ngeo-createregularpolygonfromclick-angle=oetCtrl.triangleAngle ngeo-createregularpolygonfromclick-features=::oetCtrl.sketchFeatures ngeo-createregularpolygonfromclick-map=::oetCtrl.map ngeo-createregularpolygonfromclick-radius=::oetCtrl.triangleRadius class=\\\"btn btn-sm btn-default ngeo-createregularpolygonfromclick\\\" ng-class=\\\"{active: oetCtrl.drawTriangleActive}\\\" ng-model=oetCtrl.drawTriangleActive title=\\\"{{'Draw a triangle' | translate}}\\\"> <span class=\\\"fa fa-play fa-rotate-270 gmf-icon-oe-triangle\\\"> </span> </a> <a href ngeo-btn gmf-objecteditinggetwmsfeature gmf-objecteditinggetwmsfeature-active=oetCtrl.copyFromActive gmf-objecteditinggetwmsfeature-features=::oetCtrl.sketchFeatures gmf-objecteditinggetwmsfeature-layerinfo=oetCtrl.queryableLayerInfo gmf-objecteditinggetwmsfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default gmf-objecteditinggetwmsfeature-add\\\" ng-class=\\\"{active: oetCtrl.copyFromActive}\\\" ng-model=oetCtrl.copyFromActive title=\\\"{{'Copy from external WMS feature' | translate}}\\\"> <span class=\\\"fa fa-clone gmf-icon-oe-copyfrom\\\"> </span> </a> <a href ngeo-btn gmf-objecteditinggetwmsfeature gmf-objecteditinggetwmsfeature-active=oetCtrl.deleteFromActive gmf-objecteditinggetwmsfeature-features=::oetCtrl.sketchFeatures gmf-objecteditinggetwmsfeature-layerinfo=oetCtrl.queryableLayerInfo gmf-objecteditinggetwmsfeature-map=::oetCtrl.map class=\\\"btn btn-sm btn-default gmf-objecteditinggetwmsfeature-delete\\\" ng-class=\\\"{active: oetCtrl.deleteFromActive}\\\" ng-model=oetCtrl.deleteFromActive title=\\\"{{'Cut from external WMS feature' | translate}}\\\"> <span class=\\\"fa fa-scissors gmf-icon-oe-deletefrom\\\"> </span> </a> </div> \";","module.exports = \"<div class=form-group> <select class=form-control ng-model=$ctrl.mode ng-options=\\\"mode | translate for mode in $ctrl.modes\\\" ng-click=\\\"$ctrl.hasError = false\\\"> </select> </div> <div> <form name=idsl_form novalidate ng-show=\\\"$ctrl.mode === 'Local'\\\"> <div class=form-group> <div class=input-group> <input name=file type=file required/> <input class=form-control placeholder=\\\"{{'No file' | translate}}\\\" readonly=readonly type=text value={{$ctrl.fileNameAndSize}} ng-click=$ctrl.browse() /> <span class=input-group-btn> <button class=\\\"btn btn-default\\\" type=button ng-click=$ctrl.browse() translate>Browse</button> </span> </div> </div> <div class=form-group> <button class=\\\"btn btn-sm btn-default form-control\\\" ng-class=\\\"{'has-error': $ctrl.hasError}\\\" title=\\\"{{'Load a file from local' | translate}}\\\" type=submit ng-click=\\\"idsl_form.$valid && $ctrl.load()\\\" ng-disabled=\\\"$ctrl.file === undefined || $ctrl.hasError\\\"> <span ng-if=!$ctrl.hasError>{{'Load local file' | translate}}</span> <span ng-if=$ctrl.hasError>{{'Unable to load the file' | translate}}</span> </button> </div> </form> <form name=idsc_form novalidate ng-show=\\\"$ctrl.mode === 'Online'\\\"> <div class=\\\"form-group gmf-importdatasource-url-form-group\\\"> <input autocomplete=off class=form-control name=url placeholder=\\\"{{'Choose or enter online resource URL' | translate}}\\\" required type=url ng-disabled=$ctrl.pending ng-model=$ctrl.url /> </div> <div class=form-group> <button class=\\\"btn btn-sm btn-default form-control gmf-importdatasource-connect-btn\\\" ng-class=\\\"{'has-error': $ctrl.hasError}\\\" title=\\\"{{'Connect to online resource' | translate}}\\\" type=submit ng-click=\\\"idsc_form.$valid && $ctrl.connect()\\\" ng-disabled=\\\"idsc_form.$invalid || $ctrl.pending\\\"> <span ng-if=$ctrl.pending>{{'Connecting, please wait...' | translate}}</span> <span ng-if=\\\"!$ctrl.pending && $ctrl.hasError\\\">{{'Failed to connect' | translate}}</span> <span ng-if=\\\"!$ctrl.pending && !$ctrl.hasError\\\">{{'Connect' | translate}}</span> </button> </div> </form> </div> <div class=gmf-importdatasource-layers ng-if=\\\"$ctrl.wmsCapabilities !== null || $ctrl.wmtsCapabilities !== null\\\"> <hr/> <gmf-wmscapabilitylayertreenode capabilities=::$ctrl.wmsCapabilities layer=::$ctrl.wmsCapabilities.Capability.Layer url=::$ctrl.url ng-if=\\\"$ctrl.wmsCapabilities !== null\\\"> </gmf-wmscapabilitylayertreenode> <gmf-wmtscapabilitylayertree capabilities=::$ctrl.wmtsCapabilities layers=::$ctrl.wmtsCapabilities.Contents.Layer url=::$ctrl.url ng-if=\\\"$ctrl.wmtsCapabilities !== null\\\"> </gmf-wmtscapabilitylayertree> </div> \";","module.exports = \"<ul> <li ng-repeat=\\\"layer in ::$ctrl.layers\\\"> <div class=gmf-wmscapabilitylayertreenode-header> <span class=gmf-wmscapabilitylayertreenode-popover-container ngeo-popover ngeo-popover-dismiss=.content ngeo-popover-placement=left> <span ngeo-popover-anchor class=\\\"fa fa-cog gmf-wmscapabilitylayertreenode-actions\\\"> </span> <div class=gmf-wmscapabilitylayertreenode-popover-content ngeo-popover-content> <ul> <li> <i class=\\\"fa fa-plus fa-fw\\\"></i> <a href=\\\"\\\" ng-click=\\\"$ctrl.createAndAddDataSource(layer); popoverCtrl.dismissPopover()\\\"> <span translate>Add layer</span> </a> </li> <li ng-if=\\\"::(layer.Abstract !== undefined)\\\"> <i class=\\\"fa fa-th-list fa-fw\\\"></i> <a aria-expanded=false data-toggle=collapse href=#gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}} ng-click=popoverCtrl.dismissPopover()> <span translate>Open/Close description</span> </a> </li> </ul> </div> </span> <a class=\\\"fa fa-circle-thin gmf-wmscapabilitylayertreenode-no-icon fa-fw\\\"></a> <span class=gmf-wmscapabilitylayertreenode-title>{{ ::layer.Title }}</span> <div class=\\\"collapse gmf-wmscapabilitylayertreenode-description\\\" id=gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}} ng-if=\\\"::(layer.Abstract !== undefined)\\\"> <a aria-expanded=false class=gmf-wmscapabilitylayertreenode-description-toggle data-toggle=collapse href=#gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}}> <span translate>Hide description</span> </a> <span class=gmf-wmscapabilitylayertreenode-description-content>{{ ::layer.Abstract }}</span> </div> </div> </li> </ul> \";","module.exports = \"<ul> <li ng-repeat=\\\"layer in ::$ctrl.layer.Layer\\\"> <div class=gmf-wmscapabilitylayertreenode-header> <span class=gmf-wmscapabilitylayertreenode-popover-container ng-if=\\\"::(layer.Name !== undefined || layer.Abstract !== undefined)\\\" ngeo-popover ngeo-popover-dismiss=.content ngeo-popover-placement=left> <span ngeo-popover-anchor class=\\\"fa fa-cog gmf-wmscapabilitylayertreenode-actions\\\"> </span> <div class=gmf-wmscapabilitylayertreenode-popover-content ngeo-popover-content> <ul> <li ng-if=\\\"::(layer.Name !== undefined)\\\"> <i class=\\\"fa fa-plus fa-fw\\\"></i> <a href=\\\"\\\" ng-click=\\\"$ctrl.createAndAddDataSource(layer); popoverCtrl.dismissPopover()\\\"> <span translate>Add layer</span> </a> </li> <li ng-if=\\\"::(layer.Abstract !== undefined)\\\"> <i class=\\\"fa fa-th-list fa-fw\\\"></i> <a aria-expanded=false data-toggle=collapse href=#gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}} ng-click=popoverCtrl.dismissPopover()> <span translate>Open/Close description</span> </a> </li> </ul> </div> </span> <a aria-expanded=false class=\\\"fa gmf-wmscapabilitylayertreenode-expand-node fa-fw\\\" data-toggle=collapse href=#gmf-wmscapabilitylayertreenode-children-{{::$ctrl.getUid(layer)}} ng-if=\\\"::(layer.Layer !== undefined && layer.Layer.length)\\\"></a> <span ng-if=\\\"::(layer.Layer !== undefined && layer.Layer.length)\\\" class=\\\"fa fa-fw gmf-wmscapabilitylayertreenode-group\\\"> </span> <a class=\\\"fa fa-circle-thin gmf-wmscapabilitylayertreenode-no-icon fa-fw\\\" ng-if=\\\"::(layer.Layer === undefined || layer.Layer.length === 0)\\\"></a> <span class=gmf-wmscapabilitylayertreenode-title>{{ ::layer.Title }}</span> <div class=\\\"collapse gmf-wmscapabilitylayertreenode-description\\\" id=gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}} ng-if=\\\"::(layer.Abstract !== undefined)\\\"> <a aria-expanded=false class=gmf-wmscapabilitylayertreenode-description-toggle data-toggle=collapse href=#gmf-wmscapabilitylayertreenode-description-{{::$ctrl.getUid(layer)}}> <span translate>Hide description</span> </a> <span class=gmf-wmscapabilitylayertreenode-description-content>{{ ::layer.Abstract }}</span> </div> </div> <gmf-wmscapabilitylayertreenode class=collapse id=gmf-wmscapabilitylayertreenode-children-{{::$ctrl.getUid(layer)}} capabilities=::$ctrl.capabilities layer=::layer ng-if=\\\"::(layer.Layer !== undefined)\\\"> </gmf-wmscapabilitylayertreenode> </li> </ul> \";","module.exports = \"<div class=\\\"text-center btn-group dropup\\\" gmf-elevation gmf-elevation-active=ctrl.active gmf-elevation-elevation=ctrl.elevationValue gmf-elevation-loading=ctrl.elevationLoading gmf-elevation-layer=ctrl.selectedElevationLayer gmf-elevation-layersconfig=ctrl.layersconfig gmf-elevation-map=::ctrl.map> <a type=button class=\\\"btn btn-default\\\" aria-expanded=false ng-class=\\\"::{'dropdown-toggle': ctrl.layers.length > 1}\\\" ng-attr-data-toggle=\\\"{{::(ctrl.layers.length > 1) ? 'dropdown' : ''}}\\\"> <span class=gmf-elevationwidget-value> {{ctrl.elevationValue}} <span ng-show=ctrl.elevationLoading class=\\\"fa fa-spinner\\\"></span> <span ng-show=\\\"!ctrl.elevationValue && !ctrl.elevationLoading\\\" translate>Elevation…</span> </span><span class=caret ng-if=\\\"::ctrl.layers.length > 1\\\"></span> </a> <ul class=\\\"dropdown-menu dropdown-menu-right\\\" role=menu ng-if=\\\"::ctrl.layers.length > 1\\\"> <li class=dropdown-header translate>Elevation data sources</li> <li ng-repeat=\\\"elevationItem in ::ctrl.layers\\\"> <a href ng-click=\\\"ctrl.selectedElevationLayer = elevationItem\\\"> <span class=\\\"fa fa-fw\\\" ng-class=\\\"{'fa-check': ctrl.selectedElevationLayer === elevationItem}\\\"></span> {{elevationItem | translate}} </a> </li> </ul> </div> \";","module.exports = \"<div class=\\\"gmf-profile-container panel\\\" ng-show=ctrl.active> <div class=ngeo-profile ng-show=!ctrl.isErrored ngeo-profile=ctrl.profileData ngeo-profile-highlight=ctrl.profileHighlight ngeo-profile-options=::ctrl.profileOptions> </div> <ul class=gmf-profile-legend ng-show=!ctrl.isErrored> <li ng-repeat=\\\"name in ::ctrl.getLayersNames()\\\"> <i class=\\\"fa fa-minus\\\" ng-style=ctrl.getStyle(name)></i> {{name | translate}} <span ng-if=\\\"ctrl.currentPoint.elevations[name] != null\\\"> {{ctrl.currentPoint.elevations[name]}}&nbsp;{{ctrl.currentPoint.yUnits}} </span> </li> </ul> <div class=\\\"gmf-profile-export btn-group dropup\\\" ng-show=!ctrl.isErrored> <a class=dropdown-toggle href=\\\"\\\" ng-show=\\\"ctrl.profileData.length !== 0\\\" data-toggle=dropdown aria-expanded=false> {{'Export' | translate}}&nbsp;<i class=\\\"fa fa-caret-up\\\"></i> </a> <ul class=\\\"dropdown-menu dropdown-menu-right\\\" role=menu> <li> <a href=\\\"\\\" ng-click=::ctrl.downloadCsv()> <i class=\\\"fa fa-table\\\"></i>&nbsp;{{'Download CSV' | translate}}</a> </li> </ul> </div> <div class=gmf-profile-error ng-show=ctrl.isErrored> <p>{{'The profile service does not respond, please try later.' | translate}}</p> </div> <div class=close ng-click=\\\"ctrl.line = null\\\">&times;</div> </div> \";","module.exports = \"<div class=gmf-print> <div ng-show=\\\"$ctrl.isState('CAPABILITIES_NOT_LOADED') !== true && $ctrl.isState('ERROR_ON_GETCAPABILITIES') !== true\\\"> <div class=\\\"gmf-print-layout-selector form-horizontal\\\"><ng-transclude/></div> <div ng-repeat=\\\"attribute in $ctrl.layoutInfo.simpleAttributes\\\" class=\\\"gmf-print-layoutinfo form-group\\\"> <div ng-if=\\\"$ctrl.hiddenAttributeNames === undefined || $ctrl.hiddenAttributeNames.indexOf(attribute.name) < 0\\\"> <input ng-if=\\\"attribute.type === 'number'\\\" ng-model=attribute.value class=form-control type=number ng-attr-placeholder=\\\"{{attribute.name | translate}}\\\"> <input ng-if=\\\"attribute.type === 'text'\\\" ng-model=attribute.value class=form-control type=text ng-attr-placeholder=\\\"{{attribute.name | translate}}\\\"> <textarea ng-if=\\\"attribute.type === 'textarea'\\\" ng-model=attribute.value class=form-control row=3 ng-attr-placeholder=\\\"{{attribute.name | translate}}\\\"></textarea> <div ng-if=\\\"attribute.type === 'checkbox'\\\" class=checkbox> <label> <input ng-model=attribute.value type=checkbox> <span>{{attribute.name | translate}}</span> </label> </div> </div> </div> <div ng-show=\\\"$ctrl.layoutInfo.legend !== undefined\\\" class=\\\"gmf-print-legend checkbox\\\"> <label> <input ng-model=$ctrl.layoutInfo.legend type=checkbox> <span translate>Legend</span> </label> </div> <div class=\\\"gmf-print-layout-selector form-horizontal\\\"> <div ng-show=\\\"$ctrl.layoutInfo.layouts.length !== 1\\\" class=form-group> <label class=\\\"control-label col-md-5\\\" translate>Layout</label> <div class=col-md-7> <div class=\\\"btn-group btn-block\\\"> <button type=button class=\\\"btn btn-default form-control\\\" data-toggle=dropdown> <span>{{$ctrl.layoutInfo.layout | translate}}&nbsp;</span> <i class=\\\"fa fa-caret-down\\\"></i> </button> <ul class=\\\"dropdown-menu dropdown-menu-right btn-block\\\" role=menu> <li ng-repeat=\\\"layout in $ctrl.layoutInfo.layouts\\\"> <a ng-click=$ctrl.setLayout(layout) href=\\\"\\\">{{layout | translate}}</a> </li> </ul> </div> </div> </div> <div ng-show=\\\"$ctrl.layoutInfo.scales.length !== 1\\\" class=\\\"gmf-print-scale-selector form-group\\\"> <label class=\\\"control-label col-md-5\\\" translate>Scale</label> <div class=col-md-7> <div class=\\\"btn-group btn-block\\\"> <button type=button class=\\\"btn btn-default form-control\\\" data-toggle=dropdown aria-expanded=false> <span>{{$ctrl.layoutInfo.scale | ngeoScalify}}&nbsp;</span> <i class=\\\"fa fa-caret-down\\\"></i> </button> <ul class=\\\"dropdown-menu dropdown-menu-right btn-block\\\" role=menu> <li ng-repeat=\\\"scale in $ctrl.layoutInfo.scales\\\"> <a ng-click=$ctrl.getSetScale(scale) href=\\\"\\\">{{scale | ngeoScalify}}</a> </li> <span ng-if=$ctrl.scaleInput> <li class=dropdown-header translate>Manual entry</li> <li> <div class=gmf-print-custom-scale> 1 : <input class=gmf-print-custom-scale-input type=number min=1 ng-model=$ctrl.getSetScale ng-model-options=\\\"{getterSetter: true}\\\"> </div> </li> </span> </ul> </div> </div> </div> <div ng-show=\\\"$ctrl.layoutInfo.dpis.length !== 1\\\" class=\\\"gmf-print-dpi-selector form-group\\\"> <label class=\\\"control-label col-md-3\\\" translate>DPI</label> <div class=col-md-5> <div class=\\\"btn-group btn-block\\\"> <button type=button class=\\\"btn btn-default form-control\\\" data-toggle=dropdown aria-expanded=false> <span>{{$ctrl.layoutInfo.dpi}}&nbsp;</span> <i class=\\\"fa fa-caret-down\\\"></i> </button> <ul class=\\\"dropdown-menu dropdown-menu-right btn-block\\\" role=menu> <li ng-repeat=\\\"dpi in $ctrl.layoutInfo.dpis\\\"> <a href=\\\"\\\" ng-click=$ctrl.setDpi(dpi)>{{dpi}}</a> </li> </ul> </div> </div> </div> <div class=\\\"gmf-print-rotation-selector form-group\\\"> <label class=\\\"control-label col-md-3\\\" translate>Rotation</label> <div class=col-md-5> <input class=\\\"form-control gmf-print-rotation-input\\\" type=range value=0 min=-180 max=180 data-toggle=tooltip title=\\\"{{'You can also use Alt+Shift on the map' | translate}}\\\"> </div> <div class=col-md-4> <input class=\\\"form-control gmf-print-rotation-input\\\" type=number min=-180 max=180 value=0> </div> </div> </div> <div class=\\\"gmf-print-actions form-group pull-right\\\"> <span ng-show=\\\"$ctrl.isState('PRINTING')\\\"> <i class=\\\"fa fa-refresh fa-spin\\\"></i> </span> <a ng-show=\\\"$ctrl.isState('PRINTING')\\\" class=\\\"gmf-print-cancel btn btn-link\\\" href=\\\"\\\" ng-click=$ctrl.cancel() translate>Abort</a> <button ng-show=$ctrl.layoutInfo.formats.png class=\\\"gmf-print-image btn btn-primary\\\" ng-disabled=\\\"$ctrl.isState('PRINTING')\\\" ng-click=\\\"$ctrl.print('png')\\\" translate>Image</button> <button ng-show=$ctrl.layoutInfo.formats.pdf class=\\\"gmf-print-pdf btn btn-primary\\\" ng-disabled=\\\"$ctrl.isState('PRINTING')\\\" ng-click=\\\"$ctrl.print('pdf')\\\" translate>PDF</button> </div> <div ng-show=\\\"$ctrl.isState('ERROR_ON_REPORT')\\\" class=\\\"gmf-print-error-report form-group pull-left text-danger\\\"> <p>{{'Error during the print, please try again.' | translate}}</p> </div> </div> <div ng-show=\\\"$ctrl.isState('CAPABILITIES_NOT_LOADED')\\\" class=\\\"gmf-print-wait form-group pull-left\\\"> <p>{{'Connecting to the print server, please wait.' | translate}}</p> </div> <div ng-show=\\\"$ctrl.isState('ERROR_ON_GETCAPABILITIES')\\\" class=\\\"gmf-print-error-capabilities form-group pull-left text-danger\\\"> <p>{{'The print server is unavailable. Please, try later.' | translate}}</p> </div> </div> \";","module.exports = \"<div ng-switch=efsCtrl.selectedEditableTreeCtrl> <div ng-switch-when=null> <select class=form-control ng-model=efsCtrl.selectedEditableTreeCtrl ng-show=\\\"efsCtrl.editableTreeCtrls.length > 0\\\" ng-options=\\\"treeCtrl.node.name | translate for treeCtrl in efsCtrl.editableTreeCtrls\\\"> <option value=\\\"\\\" translate>-- Choose a layer --</option> </select> <span ng-show=\\\"efsCtrl.editableTreeCtrls.length == 0\\\" translate>No editable layer available!</span> </div> <div ng-switch-default> <div class=row> <div class=col-sm-12> <span translate>Currently editing: </span> <b>{{ efsCtrl.selectedEditableTreeCtrl.node.name | translate }}</b> <span class=\\\"fa fa-pencil\\\"></span> <br> <button ng-click=efsCtrl.stopEditing() class=\\\"btn btn-link btn-xs pull-right\\\"> <span class=\\\"fa fa-times\\\"></span> {{'Stop editing' | translate}} </button> </div> </div> <gmf-editfeature gmf-editfeature-dirty=efsCtrl.dirty gmf-editfeature-editabletreectrl=::efsCtrl.selectedEditableTreeCtrl gmf-editfeature-map=::efsCtrl.map gmf-editfeature-state=efsCtrl.state gmf-editfeature-tolerance=::efsCtrl.tolerance gmf-editfeature-vector=::efsCtrl.vectorLayer gmf-editfeature-closeaftersave=::efsCtrl.closeAfterSave> </gmf-editfeature> </div> </div> \";","module.exports = \"<div> <div ng-switch=efCtrl.feature> <a ng-switch-when=null ng-if=efCtrl.geomType href ngeo-btn ngeo-createfeature ngeo-createfeature-active=efCtrl.createActive ngeo-createfeature-features=::efCtrl.features ngeo-createfeature-geom-type=::efCtrl.geomType ngeo-createfeature-map=::efCtrl.map class=\\\"btn btn-default\\\" ng-class=\\\"{active: efCtrl.createActive}\\\" ng-model=efCtrl.createActive> <span ng-switch=::efCtrl.geomType> <span ng-switch-when=Point> <span class=\\\"gmf-icon gmf-icon-point\\\"></span> {{'Draw new point' | translate}} </span> <span ng-switch-when=MultiPoint> <span class=\\\"gmf-icon gmf-icon-point\\\"></span> {{'Draw new point' | translate}} </span> <span ng-switch-when=LineString> <span class=\\\"gmf-icon gmf-icon-line\\\"></span> {{'Draw new linestring' | translate}} </span> <span ng-switch-when=MultiLineString> <span class=\\\"gmf-icon gmf-icon-line\\\"></span> {{'Draw new linestring' | translate}} </span> <span ng-switch-when=Polygon> <span class=\\\"gmf-icon gmf-icon-polygon\\\"></span> {{'Draw new polygon' | translate}} </span> <span ng-switch-when=MultiPolygon> <span class=\\\"gmf-icon gmf-icon-polygon\\\"></span> {{'Draw new polygon' | translate}} </span> </span> </a> <div ng-switch-default> <form novalidate name=form class=\\\"form gmf-editfeature-attributes-container\\\" ng-if=efCtrl.attributes> <div class=row> <div class=col-sm-12> <a class=close ng-click=efCtrl.cancel() ng-disabled=efCtrl.pending title=\\\"{{'Cancel modifications' | translate}}\\\" href>&times;</a> </div> </div> <ngeo-attributes ngeo-attributes-attributes=::efCtrl.attributes ngeo-attributes-disabled=efCtrl.pending ngeo-attributes-feature=::efCtrl.feature> </ngeo-attributes> <input type=submit value=\\\"{{'Save' | translate}}\\\" class=\\\"btn btn-sm btn-default gmf-editfeature-btn-save\\\" ng-click=\\\"form.$valid && efCtrl.save()\\\" ng-disabled=\\\"!efCtrl.dirty || efCtrl.pending\\\" title=\\\"{{'Save modifications' | translate}}\\\"> <a class=\\\"btn btn-sm btn-default gmf-editfeature-btn-cancel\\\" ng-click=efCtrl.confirmCancel() ng-disabled=efCtrl.pending title=\\\"{{'Cancel modifications' | translate}}\\\" href>{{'Cancel' | translate}}</a> <button class=\\\"btn btn-sm btn-link gmf-editfeature-btn-delete\\\" ng-click=efCtrl.delete() ng-disabled=efCtrl.pending ng-show=efCtrl.featureId title=\\\"{{'Delete this feature' | translate}}\\\"> <span class=\\\"fa fa-trash\\\"></span> {{'Delete' | translate}} </button> </form> </div> </div> <ngeo-modal ng-model=efCtrl.unsavedModificationsModalShown> <div class=modal-header> <button type=button class=close data-dismiss=modal aria-label=\\\"{{'Close' | translate}}\\\"> <span aria-hidden=true>&times;</span> </button> <h4 class=modal-title> {{'Unsaved modifications!' | translate}} </h4> </div> <div class=modal-body> {{'There are unsaved changes.' | translate}} </div> <div class=modal-footer> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal ng-click=efCtrl.continueWithoutSaving()> {{'Continue without saving' | translate}} </button> <button type=button class=\\\"btn btn-primary\\\" data-dismiss=modal> {{'Cancel' | translate}} </button> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal ng-click=efCtrl.submit()> {{'Save' | translate}} </button> </div> </ngeo-modal> <ngeo-modal ng-model=efCtrl.showServerError> <div class=modal-header>{{'Server error.' | translate}}</div> <div class=modal-body>{{efCtrl.serverErrorType}}<br> {{efCtrl.serverErrorMessage || ('Unexpected server error.' | translate)}}</div> </ngeo-modal> </div> \";","module.exports = \"<fieldset ng-disabled=attrCtrl.disabled> <div class=form-group ng-repeat=\\\"attribute in ::attrCtrl.attributes\\\"> <div ng-if=\\\"attribute.type !== 'geometry'\\\"> <label ng-if=\\\"::attribute.type !== 'boolean'\\\" class=control-label>{{ ::attribute.name | translate }} <span class=text-muted>{{::attribute.required ? \\\"*\\\" : \\\"\\\"}}</span> </label> <div ng-switch=::attribute.type> <div ng-switch-when=boolean class=checkbox> <label> <input name={{::attribute.name}} ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); type=checkbox>  <span> {{ ::attribute.name | translate }} <span class=text-muted>{{::attribute.required ? \\\"*\\\" : \\\"\\\"}}</span></span> </label> </div> <select name={{::attribute.name}} ng-required=attribute.required ng-switch-when=select ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); class=form-control type=text> <option ng-repeat=\\\"attribute in ::attribute.choices\\\" value=\\\"{{ ::attribute }}\\\"> {{ ::attribute | translate }} </option> </select> <input name={{::attribute.name}} ng-required=attribute.required ng-switch-when=date ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); ngeo-datetimepicker ngeo-datetimepicker-options=\\\"'{&quot;timepicker&quot;: false, &quot;format&quot;: &quot;' + attribute.format + '&quot;, &quot;allowBlank&quot;: true, &quot;todayButton&quot;: false, &quot;mask&quot;: &quot;' + attribute.mask + '&quot;}'\\\" class=form-control type=text>  <input name={{::attribute.name}} id=time ng-required=attribute.required ng-switch-when=time ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); ngeo-datetimepicker ngeo-datetimepicker-options=\\\"'{&quot;datepicker&quot;: false, &quot;format&quot;: &quot;' + attribute.format + '&quot;, &quot;todayButton&quot;: false, &quot;mask&quot;: &quot;' + attribute.mask + '&quot;, &quot;defaultTime&quot;: &quot;00:00&quot;}'\\\" class=form-control type=text>  <input name={{::attribute.name}} ng-required=attribute.required ng-switch-when=datetime ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); ngeo-datetimepicker ngeo-datetimepicker-options=\\\"'{&quot;scrollTime&quot;: false, &quot;format&quot;: &quot;' + attribute.format + '&quot;, &quot;allowBlank&quot;: true, &quot;todayButton&quot;: false, &quot;mask&quot;: &quot;' + attribute.mask + '&quot;, &quot;defaultTime&quot;: &quot;00:00&quot;}'\\\" class=form-control type=text>  <div ng-switch-when=number ng-switch=::attribute.numType> <input name={{::attribute.name}} ng-required=attribute.required ng-switch-when=integer ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); class=form-control step=1 type=number>  <input name={{::attribute.name}} ng-required=attribute.required ng-switch-default ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); class=form-control type=number>  </div> <input name={{::attribute.name}} ng-required=attribute.required ng-switch-default ng-model=attrCtrl.properties[attribute.name] ng-change=attrCtrl.handleInputChange(attribute.name); ng-maxlength=attribute.maxLength class=form-control type=text>  <div ng-show=\\\"attrCtrl.form.$submitted || attrCtrl.form[attribute.name].$touched\\\"> <p class=text-danger ng-show=attrCtrl.form[attribute.name].$error.required> {{'This field is required' | translate}} </p> </div> </div> </div> </div> </fieldset> \";","module.exports = \"<ngeo-drawfeature ngeo-btn-group class=btn-group ngeo-drawfeature-active=efCtrl.drawActive ngeo-drawfeature-map=efCtrl.map ngeo-drawfeature-showmeasure=efCtrl.showMeasure> <a data-toggle=tooltip title=\\\"{{'Draw a point on the map' | translate}}\\\" href ngeo-btn ngeo-drawpoint class=\\\"btn btn-default ngeo-drawfeature-point\\\" ng-class=\\\"{active: dfCtrl.drawPoint.active}\\\" ng-model=dfCtrl.drawPoint.active> <span class=\\\"gmf-icon gmf-icon-point\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a line on the map' | translate}}\\\" href ngeo-btn ngeo-measurelength class=\\\"btn btn-default ngeo-drawfeature-linestring\\\" ng-class=\\\"{active: dfCtrl.measureLength.active}\\\" ng-model=dfCtrl.measureLength.active> <span class=\\\"gmf-icon gmf-icon-line\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a polygon on the map' | translate}}\\\" href ngeo-btn ngeo-measurearea class=\\\"btn btn-default ngeo-drawfeature-polygon\\\" ng-class=\\\"{active: dfCtrl.measureArea.active}\\\" ng-model=dfCtrl.measureArea.active> <span class=\\\"gmf-icon gmf-icon-polygon\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a circle on the map' | translate}}\\\" href ngeo-btn ngeo-measureazimut class=\\\"btn btn-default ngeo-drawfeature-circle\\\" ng-class=\\\"{active: dfCtrl.measureAzimut.active}\\\" ng-model=dfCtrl.measureAzimut.active> <span class=\\\"gmf-icon gmf-icon-circle\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a rectangle on the map' | translate}}\\\" href ngeo-btn ngeo-drawrectangle class=\\\"btn btn-default ngeo-drawfeature-rectangle\\\" ng-class=\\\"{active: dfCtrl.drawRectangle.active}\\\" ng-model=dfCtrl.drawRectangle.active> <span class=\\\"gmf-icon gmf-icon-rectangle\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a text label on the map' | translate}}\\\" href ngeo-btn ngeo-drawtext class=\\\"btn btn-default ngeo-drawfeature-text\\\" ng-class=\\\"{active: dfCtrl.drawText.active}\\\" ng-model=dfCtrl.drawText.active> <span class=\\\"gmf-icon gmf-icon-text\\\"></span> </a> </ngeo-drawfeature> <div ng-switch=efCtrl.selectedFeature> <hr class=gmf-drawfeature-separator ng-show=\\\"efCtrl.getFeaturesArray().length > 0\\\"> <div ng-switch-when=null> <div ng-show=\\\"efCtrl.getFeaturesArray().length > 0\\\"> <div class=ngeo-drawfeature-actionbuttons> <button type=button data-toggle=dropdown aria-haspopup=true aria-expanded=false ngeo-exportfeatures ngeo-exportfeatures-features=efCtrl.features class=\\\"btn btn-link btn-sm\\\"> <span class=\\\"fa fa-mail-forward\\\"></span> {{'Export' | translate}} <span class=caret></span> </button> <button ng-click=efCtrl.clearFeatures() class=\\\"btn btn-link btn-xs\\\"> <span class=\\\"fa fa-trash\\\"></span> {{'Delete All' | translate}} </button> </div> <div class=gmf-eol></div> <div class=\\\"gmf-drawfeature-featurelist list-group list-group-sm\\\"> <button role=button class=list-group-item ng-repeat=\\\"feature in efCtrl.getFeaturesArray()\\\" ng-click=efCtrl.selectFeatureFromList(feature);> {{ feature.get(efCtrl.nameProperty) }} </button> </div> </div> </div> <div ng-switch-default> <button ng-click=\\\"efCtrl.selectedFeature = null;\\\" class=\\\"btn btn-link btn-xs\\\"> <span class=\\\"fa fa-arrow-left\\\"></span> {{'List' | translate}} </button> <div class=ngeo-drawfeature-actionbuttons> <button type=button data-toggle=dropdown aria-haspopup=true aria-expanded=false ngeo-exportfeatures ngeo-exportfeatures-features=efCtrl.selectedFeatures class=\\\"btn btn-link btn-xs\\\"> <span class=\\\"fa fa-mail-forward\\\"></span> {{'Export' | translate}} <span class=caret></span> </button> <button ng-click=efCtrl.removeFeature(efCtrl.selectedFeature); class=\\\"btn btn-link btn-xs\\\"> <span class=\\\"fa fa-trash\\\"></span> {{'Delete' | translate}} </button> </div> <div class=gmf-eol></div> <gmf-featurestyle gmf-featurestyle-feature=efCtrl.selectedFeature> </gmf-featurestyle> </div> </div> \";","module.exports = \"<div ng-if=\\\"fsCtrl.feature && fsCtrl.type\\\"> <div class=form-group> <input ng-model=fsCtrl.getSetName ng-model-options=\\\"{getterSetter: true}\\\" ng-attr-placeholder=\\\"{{'Name' | translate}}\\\" class=form-control /> </div> <div ng-if=\\\"fsCtrl.type !== 'Text'\\\" class=form-group> <input id=gmf-featurestyle-showlabel type=checkbox ng-model=fsCtrl.getSetShowLabel ng-model-options=\\\"{getterSetter: true}\\\"/> <label ng-switch=fsCtrl.type for=gmf-featurestyle-showlabel class=control-label> {{'Display label' | translate}} </label> </div> <div ng-if=\\\"fsCtrl.type !== 'Text'\\\" class=form-group> <input id=gmf-featurestyle-showmeasure type=checkbox ng-model=fsCtrl.getSetShowMeasure ng-model-options=\\\"{getterSetter: true}\\\"/> <label ng-switch=fsCtrl.type for=gmf-featurestyle-showmeasure class=control-label> <span ng-switch-when=Circle> {{'Display azimuth and radius' | translate}} </span> <span ng-switch-when=Polygon> {{'Display surface' | translate}} </span> <span ng-switch-when=Rectangle> {{'Display surface' | translate}} </span> <span ng-switch-when=LineString> {{'Display length' | translate}} </span> <span ng-switch-when=Point> {{'Display coordinates' | translate}} </span> </label> <em class=text-muted> ({{ fsCtrl.measure }}) </em> </div> </div> <div ng-if=\\\"fsCtrl.feature && fsCtrl.type\\\" class=form-horizontal> <div class=form-group> <div ngeo-colorpicker=\\\"\\\" ngeo-colorpicker-color=fsCtrl.color class=col-md-12> </div> </div> <div ng-if=\\\"fsCtrl.type === 'Point'\\\" class=\\\"form-group form-group-nomargin\\\"> <label class=\\\"control-label col-md-4\\\">{{'Size' | translate}}</label> <div class=col-md-8> <input type=range class=form-control min=3 max=20 step=1 ng-model=fsCtrl.getSetSize ng-model-options=\\\"{getterSetter: true}\\\"/> </div> </div> <div ng-if=\\\"fsCtrl.type === 'Text'\\\" class=\\\"form-group form-group-nomargin\\\"> <label class=\\\"control-label col-md-4\\\">{{'Size' | translate}}</label> <div class=col-md-8> <input type=range class=form-control min=8 max=30 step=1 ng-model=fsCtrl.getSetSize ng-model-options=\\\"{getterSetter: true}\\\"/> </div> </div> <div ng-if=\\\"fsCtrl.type === 'Circle' || fsCtrl.type === 'LineString' || fsCtrl.type === 'Polygon' || fsCtrl.type === 'Rectangle'\\\" class=\\\"form-group form-group-nomargin\\\"> <label class=\\\"control-label col-md-4\\\">{{'Stroke' | translate}}</label> <div class=col-md-8> <input type=range class=form-control min=0.5 max=5 step=0.5 ng-model=fsCtrl.getSetStroke ng-model-options=\\\"{getterSetter: true}\\\"/> </div> </div> <div ng-if=\\\"fsCtrl.type === 'Circle' || fsCtrl.type === 'Polygon' || fsCtrl.type === 'Rectangle'\\\" class=\\\"form-group form-group-nomargin\\\"> <label class=\\\"control-label col-md-4\\\">{{'Opacity' | translate}}</label> <div class=col-md-8> <input type=range class=form-control min=0 max=1 step=0.05 ng-model=fsCtrl.getSetOpacity ng-model-options=\\\"{getterSetter: true}\\\"/> </div> </div> <div ng-if=\\\"fsCtrl.type === 'Text'\\\" class=\\\"form-group form-group-nomargin\\\"> <label class=\\\"control-label col-md-4\\\">{{'Angle' | translate}}</label> <div class=col-md-8> <input type=range class=form-control min=-180 max=180 step=22.5 ng-model=fsCtrl.getSetAngle ng-model-options=\\\"{getterSetter: true}\\\"/> </div> </div> </div> \";","module.exports = \"<div class=ngeo-displaywindow ng-show=$ctrl.open title=\\\"\\\"> <div class=windowcontainer ng-style=$ctrl.style> <button type=button class=\\\"btn fa-close close\\\" ng-click=$ctrl.close()> </button> <div class=animation-container> <div class=slide-animation> <div class=\\\"header ui-draggable-handle\\\" ng-if=\\\"$ctrl.title !== null\\\"> <p class=title>{{$ctrl.title | translate}}</p> </div> <div class=\\\"details content\\\" ng-if=$ctrl.content ng-bind-html=$ctrl.content> </div> <div class=\\\"details iframe\\\" ng-if=\\\"$ctrl.url !== null\\\"> <iframe frameborder=0 type=text/html height=100% width=100% ng-src=\\\"{{ $ctrl.urlTrusted }}\\\"></iframe> </div> <div class=content-template-container></div> </div> </div> </div> </div> \";","module.exports = \"<ul class=gmf-theme-selector> <li ng-repeat=\\\"theme in $ctrl.themes\\\" ng-click=$ctrl.setTheme(theme) ng-class=\\\"{'gmf-theme-selector-active': $ctrl.gmfThemeManager.getThemeName() == theme.name}\\\"> <img class=gmf-thumb ng-src={{::theme.icon}} /> <span class=gmf-text>{{theme.name | translate}}</span> </li> </ul> \";","module.exports = \"<div class=gmf-search> <input type=text ng-attr-placeholder={{$ctrl.placeholder|translate}} class=form-control ng-model=$ctrl.inputValue ngeo-search=$ctrl.options ngeo-search-datasets=$ctrl.datasets ngeo-search-listeners=$ctrl.listeners> <span class=\\\"gmf-clear-button ng-hide\\\" ng-hide=\\\"!$ctrl.clearButton || $ctrl.inputValue == ''\\\" ng-click=$ctrl.onClearButton()> </span> </div> <span ng-if=$ctrl.colorChooser> <span ng-show=$ctrl.displayColorPicker ngeo-popover ngeo-popover-placement=bottom> <button class=\\\"gmf-color-button fa fa-tint\\\" ngeo-popover-anchor data-original-title=\\\"{{'Change the color of the search result'|translate}}\\\"></button> <div ngeo-popover-content> <div ngeo-colorpicker ngeo-colorpicker-color=$ctrl.color></div> </div> </span> </span> \";","module.exports = \"<table class=ngeo-colorpicker-palette> <tr ng-repeat=\\\"colors in ::ctrl.colors\\\"> <td ng-repeat=\\\"color in ::colors\\\" ng-click=ctrl.setColor(color) ng-class=\\\"{'ngeo-colorpicker-selected': color == ctrl.color}\\\"> <div ng-style=\\\"::{'background-color': color}\\\"></div> </td> </tr> </table> \";","module.exports = \"<div class=gmf-displayquerywindow ng-class=\\\"{'desktop': ctrl.desktop, 'mobile': !ctrl.desktop}\\\" ng-show=ctrl.open> <button class=collapse-button type=button ng-show=::!ctrl.desktop ngeo-swipe-up=\\\"ctrl.collapsed = false\\\" ngeo-swipe-down=\\\"ctrl.collapsed = true\\\" ngeo-swipe-disable-mouse ng-click=\\\"ctrl.collapsed = !ctrl.collapsed\\\" ng-class=\\\"[ctrl.collapsed ? 'collapse-button-up' : 'collapse-button-down']\\\"> </button> <div class=windowcontainer ng-swipe-disable-mouse ng-swipe-left=ctrl.next() ng-swipe-right=ctrl.previous()> <button type=button class=\\\"btn fa-close close\\\" ng-click=ctrl.close()> </button> <div class=animation-container ng-class=\\\"[ctrl.collapsed ? '' : 'animation-container-detailed', ctrl.isNext ? 'next' : 'previous']\\\"> <div ng-animate-swap=ctrl.animate class=\\\"slide-animation gmf-animatable\\\"> <div class=\\\"header ui-draggable-handle\\\"> <p class=title>{{ctrl.source.label | translate}}</p> <p class=subtitle>{{ctrl.getFeatureValues()[ctrl.source.identifierAttributeField]}}</p> </div> <div class=details> <table> <tr ng-repeat=\\\"(key, value) in ctrl.getFeatureValues()\\\" ng-if=\\\"value !== undefined\\\"> <td class=details-key ng-bind-html=\\\"key | translate | ngeoTrustHtml\\\"></td> <td class=details-value ng-bind-html=\\\"value | removeCDATA | ngeoTrustHtml\\\"></td> </tr> </table> </div> </div> </div> <div class=navigate> <div class=placeholder> <button type=button class=\\\"previous btn\\\" ng-disabled=ctrl.isFirst() ng-show=\\\"ctrl.getResultLength() > 1\\\" ng-click=ctrl.previous()> <span ng-show=::ctrl.desktop>{{'Prev.' | translate}}</span> </button> </div> <div class=results> <span ng-show=::!ctrl.desktop>{{'Result' | translate}}</span> <span>{{ctrl.currentResult + 1}}</span> <span>/</span> <span>{{ctrl.getResultLength()}}</span> <div ng-show=::ctrl.desktop class=dropup> <button type=button class=\\\"btn btn-default dropdown-toggle\\\" data-toggle=dropdown aria-expanded=false> <span class=\\\"fa fa-filter\\\"></span> <span class=\\\"fa fa-caret-up\\\"></span> </button> <ul class=\\\"dropdown-menu dropdown-menu-right\\\" role=menu> <li> <a href=# ng-click=ctrl.setSelectedSource(null)> <i class=\\\"fa fa-fw\\\" ng-class=\\\"{'fa-check': ctrl.selectedSource === null}\\\"> </i> <span>{{'All layers' | translate}} ({{ctrl.ngeoQueryResult.total}})</span> </a> </li> <li role=separator class=divider> </li> <li ng-repeat-start=\\\"source in ctrl.ngeoQueryResult.sources | filter: ctrl.sourcesFilter\\\" ng-repeat-end ng-class=\\\"{'disabled': source.features.length <= 0}\\\"> <a href=# ng-click=ctrl.setSelectedSource(source)> <i class=\\\"fa fa-fw\\\" ng-class=\\\"{'fa-check': ctrl.selectedSource === source}\\\"> </i> <span>{{source.label | translate}} ({{source.features.length}})</span> </a> </li> </ul> </div> </div> <div class=placeholder> <button type=button class=\\\"next btn\\\" ng-disabled=ctrl.isLast() ng-show=\\\"ctrl.getResultLength() > 1\\\" ng-click=ctrl.next()> <span ng-show=::ctrl.desktop>{{'Next' | translate}}</span> </button> </div> </div> </div> </div> \";","module.exports = \"<div class=\\\"gmf-displayquerygrid panel\\\" ng-show=ctrl.active> <div class=close ng-click=ctrl.clear()> &times; </div> <ul class=\\\"nav nav-pills\\\" role=tablist> <li ng-repeat=\\\"gridSource in ctrl.getGridSources() track by gridSource.source.label\\\" role=presentation ng-class=\\\"{'active' : ctrl.isSelected(gridSource)}\\\" ng-click=ctrl.selectTab(gridSource)> <a href=#{{ctrl.escapeValue(gridSource.source.label)}} data-target=#{{ctrl.escapeValue(gridSource.source.label)}} aria-controls={{ctrl.escapeValue(gridSource.source.label)}} role=tab data-toggle=tab> <span ng-if=\\\"gridSource.source.tooManyResults !== true\\\"> {{gridSource.source.label | translate}} ({{gridSource.source.features.length}}) </span> <span ng-if=\\\"gridSource.source.tooManyResults === true\\\"> {{gridSource.source.label | translate}} ({{gridSource.source.totalFeatureCount}}*) </span> </a> </li> </ul> <div class=tab-content> <div ng-repeat=\\\"gridSource in ctrl.getGridSources() track by gridSource.source.label\\\" role=tabpanel class=tab-pane ng-class=\\\"{'active' : ctrl.isSelected(gridSource)}\\\" id={{ctrl.escapeValue(gridSource.source.label)}}> <ngeo-grid ngeo-grid-configuration=gridSource.configuration ng-if=\\\"gridSource.source.tooManyResults !== true\\\"> </ngeo-grid> <div ng-if=\\\"gridSource.source.tooManyResults === true\\\"> <div class=\\\"gmf-displayquerygrid-message alert alert-warning\\\"> <p><span translate>The results can not be displayed because the maximum number has been reached</span> ({{gridSource.source.limit}}).</p> <p translate>Please refine your query.</p> </div> </div> </div> </div> <div class=navbar ng-show=\\\"!ctrl.pending && ctrl.getActiveGridSource() && ctrl.getActiveGridSource().configuration !== null\\\"> <ul class=\\\"nav navbar-nav navbar-right\\\"> <li class=ng-hide ng-show=ctrl.isOneSelected()> <p class=\\\"navbar-text ng-binding\\\"> {{ctrl.getSelectedRowCount()}} <span translate>selected element(s)</span> </p> </li> <li ng-show=ctrl.isOneSelected() class=ng-hide> <button class=\\\"btn btn-link btn-xs\\\" title=\\\"{{'Zoom to selection' | translate}}\\\" ng-click=ctrl.zoomToSelection()> <i class=\\\"fa fa-search-plus\\\"></i> <span translate>Zoom to</span> </button> </li> <li ng-show=ctrl.isOneSelected() class=ng-hide> <button class=\\\"btn btn-link btn-xs\\\" title=\\\"{{'Export selection as CSV' | translate}}\\\" ng-click=ctrl.downloadCsv()> <i class=\\\"fa fa-download\\\"></i> <span translate>Export as CSV</span> </button> </li> <li class=\\\"dropdown navbar-link dropup\\\"> <button type=button class=\\\"dropup btn btn-default btn-xs\\\" data-toggle=dropdown aria-haspopup=true aria-expanded=false> <span translate>Select</span> <span class=caret></span> </button> <ul class=dropdown-menu aria-labelledby=dLabel> <li> <a href=\\\"\\\" ng-click=ctrl.selectAll() translate>All</a> </li> <li> <a href=\\\"\\\" ng-click=ctrl.unselectAll() translate>None</a> </li> <li> <a href=\\\"\\\" ng-click=ctrl.invertSelection() translate>Reverse selection</a> </li> </ul> </li> </ul> </div> <div ng-show=ctrl.pending class=gmf-displayquerygrid-pending> <span class=\\\"fa fa-spinner fa-spin\\\"></span> </div> </div> \";","module.exports = \"<div class=ngeo-grid-table-container> <table float-thead=ctrl.floatTheadConfig ng-model=ctrl.configuration.data class=\\\"table table-bordered table-striped table-hover\\\"> <thead class=table-header> <tr> <th ng-repeat=\\\"columnDefs in ctrl.configuration.columnDefs\\\" ng-click=ctrl.sort(columnDefs.name) ng-bind-html=\\\"columnDefs.name | ngeoTrustHtml | translate\\\"> <i ng-show=\\\"ctrl.sortedBy !== columnDefs.name\\\" class=\\\"fa fa-fw\\\"></i> <i ng-show=\\\"ctrl.sortedBy === columnDefs.name && ctrl.sortAscending === true\\\" class=\\\"fa fa-caret-up\\\"></i> <i ng-show=\\\"ctrl.sortedBy === columnDefs.name && ctrl.sortAscending === false\\\" class=\\\"fa fa-caret-down\\\"></i> </th> </tr> </thead> <tbody> <tr ng-repeat=\\\"attributes in ctrl.configuration.data\\\" ng-class=\\\"['row-' + ctrl.configuration.getRowUid(attributes), ctrl.configuration.isRowSelected(attributes) ? 'ngeo-grid-active': '']\\\" ng-click=\\\"ctrl.clickRow(attributes, $event)\\\" ng-mousedown=ctrl.preventTextSelection($event)> <td ng-repeat=\\\"columnDefs in ctrl.configuration.columnDefs\\\" ng-bind-html=\\\"attributes[columnDefs.name] | removeCDATA | ngeoTrustHtml\\\"></td> </tr> </tbody> </table> </div> \";","module.exports = \"<div class=\\\"btn-group dropup\\\"> <a type=button class=\\\"btn btn-default dropdown-toggle\\\" data-toggle=dropdown aria-expanded=false> <span class=gmf-mouseposition-control-target></span> <span class=caret></span> </a> <ul class=\\\"dropdown-menu dropdown-menu-right\\\" role=menu> <li class=dropdown-header translate>Coordinate systems</li> <li ng-repeat=\\\"projitem in ::ctrl.projections\\\"> <a href ng-click=ctrl.setProjection(projitem)> <span class=\\\"fa fa-fw\\\" ng-class=\\\"{'fa-check': ctrl.projection == projitem}\\\"></span> {{::projitem.label}} </a> </li> </ul> </div> \";","module.exports = \"<div ngeo-map=ctrl.map ngeo-map-manage-resize=ctrl.manageResize ngeo-map-resize-transition=ctrl.resizeTransition> </div> \";","module.exports = \"<div class=\\\"btn-group btn-block\\\" ng-class=\\\"::{'dropup': scaleselectorCtrl.options.dropup}\\\"> <button type=button class=\\\"btn btn-default dropdown-toggle\\\" data-toggle=dropdown aria-expanded=false> <span ng-bind-html=\\\"scaleselectorCtrl.currentScale | ngeoScalify | ngeoTrustHtml\\\"></span>&nbsp;<i class=caret></i> </button> <ul class=\\\"dropdown-menu btn-block\\\" role=menu> <li ng-repeat=\\\"zoomLevel in ::scaleselectorCtrl.zoomLevels\\\"> <a href ng-click=scaleselectorCtrl.changeZoom(zoomLevel) ng-bind-html=\\\"scaleselectorCtrl.getScale(zoomLevel) | ngeoScalify | ngeoTrustHtml\\\"> </a> </li> </ul> </div> \";","module.exports = \"<div class=modal-header> <button type=button class=close data-dismiss=modal aria-label=Close><span aria-hidden=true>&times;</span></button> <h4 class=modal-title translate>Share this map</h4> </div> <div class=modal-body> <form role=form name=gmfShareForm novalidate> <div class=form-group> <label for=gmfShareInputShortLink translate>Permalink</label> <input type=text class=form-control id=gmfShareInputShortLink onclick=this.select() ng-model=$ctrl.shortLink readonly=True> <p class=help-block translate>Copy this link to share it.</p> <p class=text-danger ng-if=$ctrl.showLengthWarning> <span class=\\\"fa fa-exclamation-triangle\\\"></span> {{'You have a lot of drawn elements in this map. The above link may not be correctly supported by some browsers.' | translate}} </p> <p class=text-danger ng-if=$ctrl.errorOnGetShortUrl> <span class=\\\"fa fa-exclamation\\\"></span> {{'Error, cannot get the shortened URL.' | translate}} </p> </div> <hr ng-if=::$ctrl.enableEmail> <div class=gmf-share-email ng-if=::$ctrl.enableEmail> <div class=form-group> <label for=gmfShareInputEmail translate>Send this link to</label> <input type=email class=form-control name=inputEmail id=gmfShareInputEmail placeholder=E-mail ng-model=$ctrl.email required> <span ng-show=\\\"gmfShareForm.$submitted || gmfShareForm.inputEmail.$touched\\\"> <span class=text-danger ng-show=\\\"gmfShareForm.inputEmail.$error.email || gmfShareForm.inputEmail.$error.required\\\"> <i class=\\\"fa fa-exclamation-triangle\\\" aria-hidden=true></i> {{'Invalid email.' | translate}}</span> </span> </div> <div class=form-group> <textarea class=form-control ng-attr-placeholder=\\\"{{'Message (optional)' | translate }}\\\" ng-model=$ctrl.message></textarea> </div> <span class=text-success ng-if=$ctrl.successfullySent> <i class=\\\"fa fa-check\\\" aria-hidden=true></i> {{ 'Link successfully sent.' | translate }} </span> <span class=text-danger ng-if=$ctrl.errorOnsend> <i class=\\\"fa fa-exclamation\\\" aria-hidden=true></i> {{ 'Error, the link has not been sent.' | translate }} </span> </div> <div class=text-right> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal translate>Close</button> <button ng-if=::$ctrl.enableEmail type=submit class=\\\"btn btn-default btn-primary\\\" ng-click=$ctrl.sendShortUrl() ng-disabled=!gmfShareForm.$valid translate>Send </button> </div> </form> </div> \";","module.exports = \"<div class=gmf-time-slider> <div ui-slider=sliderCtrl.sliderOptions ng-model=sliderCtrl.dates> <span class=\\\"ui-slider-handle ui-state-default ui-corner-all\\\" tabindex=0 data-toggle=tooltip title=\\\"\\\"> </span> </div> <div class=gmf-time-slider-displayed-dates> <div class=gmf-time-slider-start-date ng-if=\\\"::sliderCtrl.time.mode === 'range'\\\"> <span>{{sliderCtrl.getLocalizedDate(sliderCtrl.dates[0])}}</span> </div> <div class=gmf-time-slider-start-date ng-if=\\\"::sliderCtrl.time.mode === 'value'\\\"> <span>{{sliderCtrl.getLocalizedDate(sliderCtrl.dates)}}</span> </div> <div class=gmf-time-slider-end-date ng-if=\\\"::sliderCtrl.time.mode === 'range'\\\"> <span>{{sliderCtrl.getLocalizedDate(sliderCtrl.dates[1])}}</span> </div> </div> </div> \";","module.exports = \"<div class=gmf-layertree-root-tools ng-if=layertreeCtrl.isRoot> <a href ng-if=\\\"gmfLayertreeCtrl.nodesCount() > 0\\\" ng-click=gmfLayertreeCtrl.removeAllNodes()> <span class=\\\"fa fa-trash\\\"></span> {{'Clear all' | translate}} </a> </div> <div ng-if=::!layertreeCtrl.isRoot id=gmf-layertree-node-{{::layertreeCtrl.uid}} ng-class=\\\"[layertreeCtrl.node.children ? 'gmf-layertree-group' : 'gmf-layertree-leaf', 'gmf-layertree-depth-' + layertreeCtrl.depth, gmfLayertreeCtrl.getResolutionStyle(layertreeCtrl.node), gmfLayertreeCtrl.getNodeState(layertreeCtrl)]\\\"> <div class=ngeo-sortable-handle ng-show=\\\"layertreeCtrl.depth === 1 && layertreeCtrl.parent.children.length > 1\\\"> <i class=\\\"gmf-layertree-sortable-handle-icon fa fa-ellipsis-v\\\"></i> </div> <a ng-if=::layertreeCtrl.node.children data-toggle=collapse href=#gmf-layertree-layer-group-{{::layertreeCtrl.uid}} aria-expanded={{::layertreeCtrl.node.metadata.isExpanded}} class=\\\"fa gmf-layertree-expand-node fa-fw\\\"> </a> <a href ng-click=::gmfLayertreeCtrl.toggleActive(layertreeCtrl) ng-if=::!layertreeCtrl.node.children ng-class=\\\"::{'gmf-layertree-no-layer-icon' : !gmfLayertreeCtrl.getLegendIconURL(layertreeCtrl)}\\\" class=gmf-layertree-layer-icon> <div> <img ng-if=\\\"::(legendIconUrl=gmfLayertreeCtrl.getLegendIconURL(layertreeCtrl))\\\" ng-src={{::legendIconUrl}}>  </div> </a> <a href ng-click=::gmfLayertreeCtrl.toggleActive(layertreeCtrl) ng-if=::layertreeCtrl.node.children> <span ng-switch=\\\"layertreeCtrl.node.children && !layertreeCtrl.layer.loading\\\"> <i ng-switch-when=true class=\\\"fa fa-fw gmf-layertree-state\\\"></i> <i ng-switch-when=false class=\\\"fa fa-fw fa-refresh fa-spin\\\"></i> </span> </a> <a href ng-click=::gmfLayertreeCtrl.toggleActive(layertreeCtrl) class=gmf-layertree-name data-toggle=tooltip data-placement=top title=\\\"{{layertreeCtrl.node.name | translate}}\\\"> {{layertreeCtrl.node.name | translate}} <i class=\\\"gmf-icon gmf-icon-search-go gmf-layertree-zoom\\\" data-toggle=tooltip data-placement=bottom data-title=\\\"{{'Not visible at current scale. Click to zoom.'|translate}}\\\" ng-click=\\\"::gmfLayertreeCtrl.zoomToResolution(layertreeCtrl); $event.preventDefault(); $event.stopPropagation();\\\" ng-if=\\\"gmfLayertreeCtrl.getNodeState(layertreeCtrl) == 'on'\\\"> </i> <span ngeo-popover ngeo-popover-dismiss=.content ng-if=\\\"gmfLayertreeCtrl.getNodeState(layertreeCtrl) !== 'off' && layertreeCtrl.node.time && layertreeCtrl.node.time.mode !== 'disabled'\\\"> <span ngeo-popover-anchor class=\\\"fa fa-clock-o\\\" ng-click=\\\"$event.preventDefault(); $event.stopPropagation()\\\"> </span> <div ngeo-popover-content> <ngeo-date-picker ng-if=\\\"::layertreeCtrl.node.time.widget === 'datepicker'\\\" time=layertreeCtrl.node.time on-date-selected=\\\"gmfLayertreeCtrl.updateWMSTimeLayerState(layertreeCtrl, time)\\\"> </ngeo-date-picker> <gmf-time-slider ng-if=\\\"::layertreeCtrl.node.time.widget === 'slider'\\\" gmf-time-slider-time=layertreeCtrl.node.time gmf-time-slider-on-date-selected=\\\"gmfLayertreeCtrl.updateWMSTimeLayerState(layertreeCtrl, time)\\\"> </gmf-time-slider> </div> </span> <span class=\\\"fa fa-pencil\\\" data-toggle=tooltip data-placement=right title=\\\"{{'Currently editing this layer'|translate}}\\\" ng-if=layertreeCtrl.properties.editing> </span> </a> <span class=gmf-layertree-right-buttons> <a href=\\\"\\\" ng-if=\\\"::layertreeCtrl.depth == 1\\\" ng-click=gmfLayertreeCtrl.removeNode(layertreeCtrl.node)> <span class=\\\"fa fa-trash\\\"></span> </a> <a class=gmf-layertree-node-menu-btn href=\\\"\\\" ng-if=::gmfLayertreeCtrl.supportsCustomization(layertreeCtrl) ng-click=\\\"::gmfLayertreeCtrl.toggleNodeLegend('#gmf-layertree-node-menu-' + layertreeCtrl.uid)\\\"> <span class=\\\"fa fa-cog\\\"></span> </a> <span ngeo-popover ng-if=\\\"::(layertreeCtrl.depth === 1 && !layertreeCtrl.node.mixed) || (layertreeCtrl.depth > 1 && layertreeCtrl.parent.node.mixed && !layertreeCtrl.node.children) || (gmfLayertreeCtrl.getLegendsObject(layertreeCtrl) && layertreeCtrl.node.metadata.legend) || layertreeCtrl.getDataSource().filtrable\\\" ngeo-popover-dismiss=.content> <span ngeo-popover-anchor class=\\\"extra-actions fa fa-cog\\\"> </span> <div ngeo-popover-content> <ul> <li ng-if=\\\"::(layertreeCtrl.depth === 1 && !layertreeCtrl.node.mixed) || (layertreeCtrl.depth > 1 && layertreeCtrl.parent.node.mixed)\\\"> <i class=\\\"fa fa-tint fa-fw\\\"></i> <span for=layer-opactity>{{'Opacity'|translate}}</span> <input class=input-action name=layer-opactity type=range min=0 max=1 step=0.01 ng-model=layertreeCtrl.layer.opacity /> </li> <li ng-if=\\\"::gmfLayertreeCtrl.getLegendsObject(layertreeCtrl) && layertreeCtrl.node.metadata.legend\\\"> <i class=\\\"fa fa-th-list fa-fw\\\"></i> <a ng-click=\\\"::gmfLayertreeCtrl.toggleNodeLegend('#gmf-layertree-node-' + layertreeCtrl.uid + '-legend'); popoverCtrl.dismissPopover()\\\" data-toggle=collapse href=\\\"\\\"> {{'Show/hide legend'|translate}} </a> </li> <li ng-if=\\\"layertreeCtrl.getDataSource() && layertreeCtrl.getDataSource().filtrable\\\"> <i class=\\\"fa fa-filter fa-fw\\\"></i> <a ng-click=gmfLayertreeCtrl.toggleFiltrableDataSource(layertreeCtrl.getDataSource()) href=\\\"\\\"> {{'Filter'|translate}} </a> </li> </ul> </div> </span> <span class=gmf-layertree-metadata ng-if=::layertreeCtrl.node.metadata.metadataUrl> <span ng-if=\\\"::gmfLayertreeCtrl.openLinksInNewWindow === true\\\"> <a title=\\\"{{'More informations'|translate}}\\\" href={{::layertreeCtrl.node.metadata.metadataUrl}} target=blank_> </a> </span> <span ng-if=\\\"::gmfLayertreeCtrl.openLinksInNewWindow !== true\\\"> <a title=\\\"{{'More informations'|translate}}\\\" href=\\\"\\\" ng-click=gmfLayertreeCtrl.displayMetadata(layertreeCtrl)> </a> </span> </span> </span> </div> <div class=gmf-layertree-node-menu id=gmf-layertree-node-menu-{{::layertreeCtrl.uid}} style=display:none ng-if=::gmfLayertreeCtrl.supportsCustomization(layertreeCtrl)> <div ng-if=::gmfLayertreeCtrl.supportsOpacityChange(layertreeCtrl)> <i class=\\\"fa fa-tint fa-fw\\\"></i> <span for=layer-opactity>{{'Opacity'|translate}}</span> <input class=input-action name=layer-opactity type=range min=0 max=1 step=0.01 ng-model=layertreeCtrl.layer.opacity /> </div> <a class=gmf-layertree-node-menu-togglelegend ng-if=::gmfLayertreeCtrl.supportsLegend(layertreeCtrl) data-toggle=collapse ng-click=\\\"::gmfLayertreeCtrl.toggleNodeLegend('#gmf-layertree-node-' + layertreeCtrl.uid + '-legend')\\\" href=\\\"\\\"> <span class=\\\"fa fa-th-list\\\"> </span> {{'Show/hide legend'|translate}} </a> </div> <div ng-if=\\\"::!layertreeCtrl.isRoot && gmfLayertreeCtrl.getLegendsObject(layertreeCtrl) && layertreeCtrl.node.metadata.legend\\\" id=gmf-layertree-node-{{::layertreeCtrl.uid}}-legend class=\\\"collapse gmf-layertree-legend\\\" ng-class=\\\"[gmfLayertreeCtrl.getNodeState(layertreeCtrl), layertreeCtrl.node.metadata.isLegendExpanded ? 'in' : '']\\\"> <a title=\\\"{{'Hide legend'|translate}}\\\" data-toggle=collapse ng-click=\\\"::gmfLayertreeCtrl.toggleNodeLegend('#gmf-layertree-node-' + layertreeCtrl.uid + '-legend')\\\" href=\\\"\\\"> {{'Hide legend'|translate}} </a> <div ng-if=\\\"gmfLayertreeCtrl.isNodeLegendVisible('#gmf-layertree-node-' + layertreeCtrl.uid + '-legend')\\\"> <div ng-repeat=\\\"(title, url) in gmfLayertreeCtrl.getLegendsObject(layertreeCtrl)\\\"> <p ng-if=\\\"gmfLayertreeCtrl.getNumberOfLegendsObject(layertreeCtrl) > 1\\\">{{title|translate}}</p> <img ng-src={{url}}> </div> </div> </div> <ul class=gmf-layertree-root-external-datasources ng-if=\\\"layertreeCtrl.isRoot && (gmfLayertreeCtrl.gmfExternalDataSourcesManager.wmsGroups.length || gmfLayertreeCtrl.gmfExternalDataSourcesManager.wmtsGroups.length || gmfLayertreeCtrl.gmfExternalDataSourcesManager.fileGroup.dataSources.length)\\\"> <gmf-datasourcegrouptree class=\\\"gmf-layertree-node gmf-layertree-depth-1\\\" ng-repeat=\\\"wmtsGroup in gmfLayertreeCtrl.gmfExternalDataSourcesManager.wmtsGroups\\\" group=wmtsGroup> </gmf-datasourcegrouptree> <gmf-datasourcegrouptree class=\\\"gmf-layertree-node gmf-layertree-depth-1\\\" ng-repeat=\\\"wmsGroup in gmfLayertreeCtrl.gmfExternalDataSourcesManager.wmsGroups\\\" group=wmsGroup> </gmf-datasourcegrouptree> <gmf-datasourcegrouptree class=\\\"gmf-layertree-node gmf-layertree-depth-1\\\" ng-if=gmfLayertreeCtrl.gmfExternalDataSourcesManager.fileGroup.dataSources.length group=gmfLayertreeCtrl.gmfExternalDataSourcesManager.fileGroup> </gmf-datasourcegrouptree> </ul> <ul id=gmf-layertree-layer-group-{{::layertreeCtrl.uid}} ng-if=::layertreeCtrl.node.children ng-class=\\\"{collapse: !layertreeCtrl.isRoot, in : layertreeCtrl.node.metadata.isExpanded}\\\" ngeo-sortable=\\\"::layertreeCtrl.isRoot && layertreeCtrl.node.children\\\" ngeo-sortable-options=\\\"{handleClassName: 'ngeo-sortable-handle', draggerClassName: 'gmf-layertree-dragger', placeholderClassName : 'gmf-layertree-curr-drag-item'}\\\" ngeo-sortable-callback=::gmfLayertreeCtrl.afterReorder ngeo-sortable-callback-ctx=::gmfLayertreeCtrl> <li class=gmf-layertree-node ng-repeat=\\\"node in layertreeCtrl.node.children\\\" ng-class=\\\"'gmf-layertree-depth-' + layertreeCtrl.depth\\\" ngeo-layertree=node ngeo-layertree-notroot ngeo-layertree-map=layertreeCtrl.map ngeo-layertree-nodelayerexpr=layertreeCtrl.nodelayerExpr ngeo-layertree-listenersexpr=layertreeCtrl.listenersExpr> </li> </ul> \";","module.exports = \"<span ng-if=::!layertreeCtrl.isRoot>{{::layertreeCtrl.node.name}}</span> <input type=checkbox ng-if=\\\"::layertreeCtrl.node && !layertreeCtrl.node.children\\\" ng-model=layertreeCtrl.getSetActive ng-model-options=\\\"{getterSetter: true}\\\"/> <ul ng-if=::layertreeCtrl.node.children> <li ng-repeat=\\\"node in ::layertreeCtrl.node.children\\\" ngeo-layertree=::node ngeo-layertree-notroot ngeo-layertree-map=layertreeCtrl.map ngeo-layertree-nodelayerexpr=layertreeCtrl.nodelayerExpr ngeo-layertree-listenersexpr=layertreeCtrl.listenersExpr> </li> </ul> \";","module.exports = \"<div class=\\\"gmf-layertree-group gmf-layertree-depth-1 {{$ctrl.group.visibilityState}}\\\"> <a data-toggle=collapse href=#gmf-layertree-layer-group-{{::$ctrl.getGroupUid()}} aria-expanded=true class=\\\"fa gmf-layertree-expand-node fa-fw\\\"> </a> <a class=\\\"fa fa-fw gmf-layertree-state\\\" href ng-click=$ctrl.toggle()> </a> <a class=gmf-layertree-name href ng-click=$ctrl.toggle()> <span>{{$ctrl.group.title | translate}}</span> </a> <span class=gmf-layertree-right-buttons> <a href=\\\"\\\" ng-click=$ctrl.remove()> <span class=\\\"fa fa-trash\\\"></span> </a> </span> </div> <ul id=gmf-layertree-layer-group-{{::$ctrl.getGroupUid()}} class=\\\"collapse in\\\"> <li class=\\\"gmf-layertree-node gmf-layertree-depth-2\\\" ng-class=\\\"[dataSource.visible ? 'on' : 'off']\\\" ng-repeat=\\\"dataSource in $ctrl.group.dataSources\\\"> <div class=gmf-layertree-leaf> <a href ng-click=$ctrl.toggleDataSource(dataSource) class=\\\"gmf-layertree-layer-icon gmf-layertree-no-layer-icon\\\"> </a> <a class=gmf-layertree-name href ng-click=$ctrl.toggleDataSource(dataSource)> <span>{{dataSource.name | translate}}</span> </a> <span class=gmf-layertree-right-buttons> <a href=\\\"\\\" ng-click=$ctrl.removeDataSource(dataSource)> <span class=\\\"fa fa-trash\\\"></span> </a> </span> </div> </li> </ul> \";","module.exports = __webpack_public_path__ + \"crosshair.3aa99e.svg\";","module.exports = \"<div class=form-group ng-switch=$ctrl.filtrableDataSources.length> <span ng-switch-when=0 translate>No filtrable layer available!</span> <select class=form-control ng-disabled=$ctrl.aRuleIsActive ng-switch-default ng-model=$ctrl.gmfDataSourceBeingFiltered.dataSource ng-options=\\\"dataSource.name | translate for dataSource in $ctrl.filtrableDataSources\\\"> <option value=\\\"\\\" translate>-- Layer to filter --</option> </select> <div ng-if=\\\"$ctrl.customRules && $ctrl.directedRules && $ctrl.readyDataSource\\\"> <hr class=gmf-filterselector-separator /> <div class=\\\"dropdown gmf-filterselector-savedfilters\\\"> <a class=\\\"btn btn-link dropdown-toggle ngeo-filter-condition-button\\\" ng-class=\\\"{disabled: $ctrl.aRuleIsActive || $ctrl.gmfSavedFilters.currentDataSourceItems.length === 0}\\\" type=button data-toggle=dropdown ng-disabled=\\\"$ctrl.aRuleIsActive || $ctrl.gmfSavedFilters.currentDataSourceItems.length === 0\\\"> <span translate>Saved</span> <span class=caret></span> </a> <ul class=dropdown-menu> <li ng-repeat=\\\"item in $ctrl.gmfSavedFilters.currentDataSourceItems\\\"> <a href ng-click=$ctrl.saveFilterLoadItem(item)> <span>{{::item.name}}</span> </a> </li> <li role=separator class=divider></li> <li> <a href ng-click=$ctrl.saveFilterManage()> <span translate>Manage saved filters</span> </a> </li> </ul> </div> <ngeo-filter a-rule-is-active=$ctrl.aRuleIsActive custom-rules=$ctrl.customRules datasource=$ctrl.readyDataSource directed-rules=$ctrl.directedRules feature-overlay=$ctrl.featureOverlay map=$ctrl.map tool-group=$ctrl.toolGroup> </ngeo-filter> <div> <a class=\\\"btn btn-link gmf-filterselector-savebtn\\\" type=button data-toggle=dropdown ng-click=\\\"!$ctrl.aRuleIsActive && $ctrl.saveFilterShowModal()\\\" ng-disabled=$ctrl.aRuleIsActive> <span class=\\\"fa fa-save\\\"></span> <span translate>Save</span> </a> </div> </div> <ngeo-modal ng-model=$ctrl.saveFilterSaveModalShown> <div class=modal-header> <button type=button class=close data-dismiss=modal aria-label=\\\"{{'Close' | translate}}\\\"> <span aria-hidden=true>&times;</span> </button> <h4 class=modal-title>{{'Save filter' | translate}}</h4> </div> <div class=modal-body> <p class=gmf-filterselector-savefilter-desc translate> You can save the filter that you created to re-load it later. </p> <input type=text class=form-control name=name ng-model=$ctrl.saveFilterName placeholder=\\\"{{'Filter name' | translate}}\\\"/> </div> <div class=modal-footer> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal>{{'Cancel' | translate}}</button> <button type=button ng-click=$ctrl.saveFilterSave() ng-disabled=\\\"$ctrl.saveFilterName === ''\\\" class=\\\"btn btn-primary\\\">{{'Save' | translate}}</button> </div> </ngeo-modal> <ngeo-modal ng-model=$ctrl.saveFilterManageModalShown> <div class=gmf-filterselector-managefilter-modal> <div class=modal-header> <button type=button class=close data-dismiss=modal aria-label=\\\"{{'Close' | translate}}\\\"> <span aria-hidden=true>&times;</span> </button> <h4 class=modal-title>{{'Manage filters' | translate}}</h4> </div> <div class=modal-body> <ul> <li ng-repeat=\\\"item in $ctrl.gmfSavedFilters.currentDataSourceItems\\\"> <span>{{::item.name}}</span> <a href ng-click=$ctrl.saveFilterRemoveItem(item)> {{ 'Delete' | translate }} </a> <div class=gmf-eol></div> </li> </ul> </div> <div class=modal-footer> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal>{{'Close' | translate}}</button> </div> </div> </ngeo-modal> </div> \";","module.exports = \"<div class=dropdown> <a class=\\\"btn btn-link dropdown-toggle ngeo-filter-condition-button\\\" ng-class=\\\"{disabled: $ctrl.aRuleIsActive}\\\" type=button data-toggle=dropdown ng-disabled=$ctrl.aRuleIsActive> <span class=\\\"fa fa-cog\\\"></span> <span class=caret></span> </a> <ul class=dropdown-menu> <li class=ngeo-filter-condition-criteria-header translate>Criteria taken into account</li> <li ng-repeat=\\\"condition in ::$ctrl.conditions\\\"> <a href ng-click=$ctrl.setCondition(condition)> <span ng-class=\\\"{'ngeo-filter-condition-criteria-active': condition.value == $ctrl.datasource.filterCondition}\\\" class=\\\"fa fa-check ngeo-filter-condition-criteria\\\"> </span> <span>{{::condition.text | translate}}</span> </a> </li> </ul> </div> <ngeo-rule ng-repeat=\\\"rule in $ctrl.directedRules\\\" feature-overlay=::$ctrl.featureOverlay class=ngeo-filter-rule-directed map=$ctrl.map rule=rule tool-group=$ctrl.toolGroup> </ngeo-rule> <hr class=ngeo-filter-separator-rules /> <div ng-repeat=\\\"rule in $ctrl.customRules\\\"> <a class=\\\"btn btn-xs btn-link ngeo-filter-rule-custom-rm-btn\\\" ng-click=\\\"!$ctrl.aRuleIsActive && $ctrl.removeCustomRule(rule)\\\" ng-disabled=$ctrl.aRuleIsActive href> <span class=\\\"fa fa-remove\\\"></span> </a> <ngeo-rule feature-overlay=::$ctrl.featureOverlay class=ngeo-filter-rule-custom map=$ctrl.map rule=rule tool-group=$ctrl.toolGroup> </ngeo-rule> </div> <div class=dropdown> <a class=\\\"btn btn-link dropdown-toggle\\\" ng-class=\\\"{disabled: $ctrl.aRuleIsActive}\\\" type=button data-toggle=dropdown ng-disabled=$ctrl.aRuleIsActive> <span translate>+ Add a new criteria</span> <span class=caret></span> </a> <ul class=dropdown-menu> <li ng-repeat=\\\"attribute in ::$ctrl.geometryAttributes\\\"> <a href ng-click=$ctrl.createAndAddCustomRule(attribute)> <span translate>Spatial filter</span> </a> </li> <li role=presentation class=divider></li> <li ng-repeat=\\\"attribute in ::$ctrl.otherAttributes\\\"> <a href ng-click=$ctrl.createAndAddCustomRule(attribute)> <span>{{::attribute.name | translate}}</span> </a> </li> </ul> </div> <hr class=ngeo-filter-separator-criteria /> <a class=\\\"btn btn-link\\\" type=button ng-click=$ctrl.apply() ng-disabled=\\\"$ctrl.hasARule() === false || $ctrl.datasource.visible === false\\\"> <span class=\\\"fa fa-check\\\"></span> <span translate>Apply filter</span> </a> <a class=\\\"btn btn-link\\\" type=button ng-click=$ctrl.getData() ng-disabled=\\\"$ctrl.hasARule() === false || $ctrl.datasource.visible === false\\\"> <span class=\\\"fa fa-chevron-right\\\"></span> <span translate>Get data</span> </a> \";","module.exports = \"<div class=dropdown ng-class=\\\"{open: $ctrl.rule.active}\\\"> <a class=\\\"btn btn-default btn-sm dropdown-toggle\\\" type=button ng-click=$ctrl.toggle()> <span>{{ ::$ctrl.clone.name | translate }}</span> <span class=caret></span> </a> <div class=\\\"dropdown-menu form-group\\\"> <select class=\\\"form-control input-sm ngeo-rule-operators-list\\\" ng-disabled=$ctrl.drawActive ng-if=::$ctrl.clone.operators ng-model=$ctrl.clone.operator ng-options=\\\"$ctrl.operators[operator] | translate for operator in ::$ctrl.clone.operators track by operator\\\"> </select> <div ng-switch=::$ctrl.clone.type> <div class=\\\"ngeo-rule-type-date form-group\\\" ng-if=$ctrl.rule.active ng-switch-when=date|datetime ng-switch-when-separator=|> <div ng-switch=$ctrl.clone.operator> <div ng-switch-when=..|time_during ng-switch-when-separator=|> <ngeo-date-picker time=$ctrl.timeRangeMode on-date-selected=$ctrl.onDateRangeSelected(time)> </ngeo-date-picker> </div> <div ng-switch-default> <ngeo-date-picker time=$ctrl.timeValueMode on-date-selected=$ctrl.onDateSelected(time)> </ngeo-date-picker> </div> </div> </div> <div class=\\\"ngeo-rule-type-geometry form-group\\\" ng-switch-when=geometry> <div ng-switch=$ctrl.geomType> <span class=\\\"gmf-icon gmf-icon-point\\\" ng-switch-when=Point> </span> <span class=\\\"gmf-icon gmf-icon-line\\\" ng-switch-when=LineString> </span> <span class=\\\"gmf-icon gmf-icon-polygon\\\" ng-switch-when=Polygon> </span> <span class=\\\"gmf-icon gmf-icon-circle\\\" ng-switch-when=Circle> </span> <span class=\\\"gmf-icon gmf-icon-rectangle\\\" ng-switch-when=Rectangle> </span> </div> <ngeo-drawfeature ngeo-drawfeature-active=$ctrl.drawActive ngeo-drawfeature-features=$ctrl.drawnFeatures ngeo-drawfeature-map=$ctrl.map> <div ngeo-btn-group class=btn-group> <a data-toggle=tooltip title=\\\"{{'Draw a point on the map' | translate}}\\\" href ngeo-btn ngeo-drawpoint class=\\\"btn btn-sm btn-default ngeo-drawfeature-point\\\" ng-show=\\\"['intersects', 'within'].indexOf($ctrl.clone.operator) !== -1\\\" ng-class=\\\"{active: dfCtrl.drawPoint.active}\\\" ng-model=dfCtrl.drawPoint.active> <span class=\\\"gmf-icon gmf-icon-point\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a line on the map' | translate}}\\\" href ngeo-btn ngeo-measurelength class=\\\"btn btn-sm btn-default ngeo-drawfeature-linestring\\\" ng-show=\\\"['intersects', 'within'].indexOf($ctrl.clone.operator) !== -1\\\" ng-class=\\\"{active: dfCtrl.measureLength.active}\\\" ng-model=dfCtrl.measureLength.active> <span class=\\\"gmf-icon gmf-icon-line\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a polygon on the map' | translate}}\\\" href ngeo-btn ngeo-measurearea class=\\\"btn btn-sm btn-default ngeo-drawfeature-polygon\\\" ng-class=\\\"{active: dfCtrl.measureArea.active}\\\" ng-model=dfCtrl.measureArea.active> <span class=\\\"gmf-icon gmf-icon-polygon\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a circle on the map' | translate}}\\\" href ngeo-btn ngeo-measureazimut class=\\\"btn btn-sm btn-default ngeo-drawfeature-circle\\\" ng-class=\\\"{active: dfCtrl.measureAzimut.active}\\\" ng-model=dfCtrl.measureAzimut.active> <span class=\\\"gmf-icon gmf-icon-circle\\\"></span> </a> <a data-toggle=tooltip title=\\\"{{'Draw a rectangle on the map' | translate}}\\\" href ngeo-btn ngeo-drawrectangle class=\\\"btn btn-sm btn-default ngeo-drawfeature-rectangle\\\" ng-class=\\\"{active: dfCtrl.drawRectangle.active}\\\" ng-model=dfCtrl.drawRectangle.active> <span class=\\\"gmf-icon gmf-icon-rectangle\\\"></span> </a> </div> <div class=ngeo-rule-type-geometry-instructions ng-if=$ctrl.drawActive> <span ng-if=dfCtrl.drawPoint.active> {{ 'Draw a point on the map.' | translate }} </span> <span ng-if=dfCtrl.measureLength.active> {{ 'Draw a line string on the map.' | translate }} </span> <span ng-if=dfCtrl.measureArea.active> {{ 'Draw a polygon on the map.' | translate }} </span> <span ng-if=dfCtrl.measureAzimut.active> {{ 'Draw a circle on the map.' | translate }} </span> <span ng-if=dfCtrl.drawRectangle.active> {{ 'Draw a rectangle on the map.' | translate }} </span> </div> </ngeo-drawfeature> </div> <div class=\\\"checkbox ngeo-rule-type-select\\\" ng-switch-when=select> <a ng-click=$ctrl.selectAllChoices() href>{{ All | translate}} </a> <label class=\\\"form-group ol-unselectable\\\" ng-repeat=\\\"choice in ::$ctrl.clone.choices\\\"> <input ng-checked=\\\"$ctrl.clone.getExpression() && $ctrl.clone.getExpression().split(',').indexOf(choice) > -1\\\" ng-click=$ctrl.toggleChoiceSelection(choice) type=checkbox value=choice /> <span>{{ choice | translate }}</span> </label> </div> <div class=\\\"form-group ngeo-rule-type-text\\\" ng-switch-default> <div ng-switch=$ctrl.clone.operator> <div ng-switch-when=..> <input type=number class=\\\"form-control input-sm\\\" ng-model=$ctrl.clone.lowerBoundary /> <input type=number class=\\\"form-control input-sm\\\" ng-model=$ctrl.clone.upperBoundary /> </div> <div ng-switch-default> <input type=number class=\\\"form-control input-sm\\\" ng-if=\\\"$ctrl.clone.type === 'number'\\\" ng-model=$ctrl.clone.expression /> <input type=text class=\\\"form-control input-sm\\\" ng-if=\\\"$ctrl.clone.type !== 'number'\\\" ng-model=$ctrl.clone.expression /> </div> </div> </div> <div class=ngeo-rule-btns> <button class=\\\"btn btn-xs btn-default\\\" ng-click=$ctrl.apply() type=button>{{'Apply' | translate}}</button> <button class=\\\"btn btn-xs btn-default\\\" ng-click=$ctrl.cancel() type=button>{{'Cancel' | translate}}</button> </div> </div> </div> </div> <div class=ngeo-rule-value ng-if=\\\"$ctrl.rule.value !== null\\\"> <a class=\\\"btn btn-xs btn-link\\\" ng-click=\\\"!$ctrl.rule.active && $ctrl.reset()\\\" ng-disabled=$ctrl.rule.active href> <span class=\\\"fa fa-remove\\\"></span> </a> <div ng-switch=::$ctrl.rule.type> <div ng-switch-when=date|datetime ng-switch-when-separator=|> <div ng-switch=$ctrl.rule.operator> <div ng-switch-when=..|time_during ng-switch-when-separator=|> <span translate>From </span> <span>{{ $ctrl.timeToDate($ctrl.rule.lowerBoundary) }}</span> <span translate> to </span> <span>{{ $ctrl.timeToDate($ctrl.rule.upperBoundary) }}</span> </div> <div ng-switch-default> <span>{{ $ctrl.operatorsShortFormat[$ctrl.rule.operator] }}</span> <span>{{ $ctrl.timeToDate($ctrl.rule.getExpression()) }}</span> </div> </div> </div> <div ng-switch-when=geometry> <span>{{ $ctrl.operators[$ctrl.rule.operator] }}</span> <span ng-switch=$ctrl.getRuleGeometryType()> <span class=\\\"gmf-icon gmf-icon-point\\\" ng-switch-when=Point> </span> <span class=\\\"gmf-icon gmf-icon-line\\\" ng-switch-when=LineString> </span> <span class=\\\"gmf-icon gmf-icon-polygon\\\" ng-switch-when=Polygon> </span> <span class=\\\"gmf-icon gmf-icon-circle\\\" ng-switch-when=Circle> </span> <span class=\\\"gmf-icon gmf-icon-rectangle\\\" ng-switch-when=Rectangle> </span> </span> </div> <div ng-switch-when=select> <span ng-repeat=\\\"choice in $ctrl.rule.getExpression().split(',')\\\"> {{ choice | translate }}{{ $last ? '' : ', ' }} </span> </div> <div ng-switch-default> <div ng-switch=$ctrl.rule.operator> <div ng-switch-when=..|time_during ng-switch-when-separator=|> <span translate>Between </span> <span>{{ $ctrl.rule.lowerBoundary }}</span> <span translate> and </span> <span>{{ $ctrl.rule.upperBoundary }}</span> </div> <div ng-switch-default> <span>{{ $ctrl.operatorsShortFormat[$ctrl.rule.operator] }}</span> <span>{{ $ctrl.rule.getExpression() }}</span> </div> </div> </div> </div> </div> \";","module.exports = \"<div class=ngeo-datepicker> <form name=dateForm class=ngeo-datepicker-form novalidate> <div ng-if=\\\"::datepickerCtrl.time.widget === 'datepicker'\\\"> <div class=ngeo-datepicker-start-date> <span ng-if=\\\"::datepickerCtrl.time.mode === 'range'\\\" translate>From:</span> <span ng-if=\\\"::datepickerCtrl.time.mode !== 'range'\\\" translate>Date:</span> <input name=sdate ui-date=datepickerCtrl.sdateOptions ng-model=datepickerCtrl.sdate required=\\\"\\\"/> </div> <div class=ngeo-datepicker-end-date ng-if=\\\"::datepickerCtrl.time.mode === 'range'\\\"> <span translate>To:</span> <input name=edate ui-date=datepickerCtrl.edateOptions ng-model=datepickerCtrl.edate required=\\\"\\\"/> </div> </div> </form> </div> \";","module.exports = \"<h4 class=\\\"popover-title ngeo-popup-title\\\"> <span ng-bind-html=title></span> <button type=button class=close ng-click=\\\"open = false\\\"> &times;</button> </h4> <div class=popover-content ng-bind-html=content></div> \";","module.exports = \"<ul class=gmf-backgroundlayerselector> <li ng-repeat=\\\"layer in ctrl.bgLayers\\\" ng-click=ctrl.setLayer(layer) ng-class=\\\"{'gmf-backgroundlayerselector-active': ctrl.bgLayer == layer, 'gmf-backgroundlayerselector-disabled': ctrl.opacityLayer == layer}\\\"> <img class=gmf-thumb ng-src=\\\"{{::layer.get('metadata')['thumbnail']}}\\\"/> <span class=gmf-text>{{layer.get(\\\"label\\\") | translate}}</span> <span ng-class=\\\"{'gmf-backgroundlayerselector-opacity-check': ctrl.opacityLayer == layer}\\\"></span> </li> <input ng-if=ctrl.opacityLayer class=\\\"input-action gmf-backgroundlayerselector-opacity-slider\\\" name=bg-layer-opacity type=range min=0 max=1 step=0.01 ng-model=ctrl.getSetBgLayerOpacity ng-model-options=\\\"{getterSetter: true}\\\"> </ul> \";","module.exports = \"<div ng-if=$ctrl.gmfUser.username> <div class=form-group> <span>{{'Logged in as' | translate}}</span> <strong>{{ ::$ctrl.gmfUser.username }}</strong>. </div> <form name=logoutForm role=form ng-submit=$ctrl.logout() ng-controller=GmfAuthenticationController ng-class=\\\"{'has-error': $ctrl.error}\\\" ng-if=!$ctrl.changingPassword> <div class=form-group> <input type=submit class=\\\"form-control btn btn-primary\\\" value=\\\"{{'Logout' | translate}}\\\"/> </div> <div class=form-group> <input ng-show=$ctrl.allowPasswordChange type=button class=\\\"form-control btn btn-default\\\" value=\\\"{{'Change password' | translate}}\\\" ng-click=\\\"$ctrl.changingPassword = true\\\"/> </div> </form> <form name=changePasswordForm role=form ng-submit=$ctrl.changePassword() ng-controller=GmfAuthenticationController ng-class=\\\"{'has-error': $ctrl.error}\\\" ng-if=$ctrl.changingPassword> <div class=form-group> <input type=password class=form-control name=oldpassword ng-model=$ctrl.oldPwdVal ng-attr-placeholder=\\\"{{'Old password' | translate}}\\\"/> </div> <div class=form-group> <input type=password class=form-control name=newpassword ng-model=$ctrl.newPwdVal ng-attr-placeholder=\\\"{{'New password' | translate}}\\\"/> </div> <div class=form-group> <input type=password class=form-control name=newpasswordconfirm ng-model=$ctrl.newPwdConfVal ng-attr-placeholder=\\\"{{'Confirm new password' | translate}}\\\"/> </div> <div class=form-group> <input type=submit class=\\\"form-control btn btn-primary\\\" value=\\\"{{'Change password' | translate}}\\\"/> </div> <div class=form-group> <input type=button class=\\\"form-control btn btn-default\\\" value=\\\"{{'Cancel' | translate}}\\\" ng-if=!$ctrl.userMustChangeItsPassword ng-click=$ctrl.changePasswordReset() /> <input type=button class=\\\"form-control btn btn-default\\\" value=\\\"{{'Logout' | translate}}\\\" ng-if=$ctrl.userMustChangeItsPassword ng-click=$ctrl.logout() /> </div> </form> <div ng-show=$ctrl.error class=\\\"gmf-authentication-error help-block\\\"></div> </div> <div ng-if=!$ctrl.gmfUser.username> <div class=\\\"alert alert-warning\\\" ng-show=$ctrl.infoMessage> <span>{{ $ctrl.infoMessage }}</span> </div> <form name=loginForm role=form ng-submit=$ctrl.login() ng-controller=GmfAuthenticationController ng-class=\\\"{'has-error': $ctrl.error}\\\"> <div class=form-group> <input type=text class=form-control name=login ng-model=$ctrl.loginVal ng-attr-placeholder=\\\"{{'Username' | translate}}\\\"/> </div> <div class=form-group> <input type=password class=form-control name=password ng-model=$ctrl.pwdVal ng-attr-placeholder=\\\"{{'Password' | translate}}\\\"/> </div> <div class=form-group> <input type=submit class=\\\"form-control btn btn-primary\\\" value=\\\"{{'Connect' | translate}}\\\"/> </div> <div ng-show=$ctrl.allowPasswordReset class=form-group> <a ng-click=$ctrl.resetPassword() href=\\\"\\\">{{'Password forgotten?' | translate}}</a> </div> </form> <div ng-show=$ctrl.error class=\\\"gmf-authentication-error help-block\\\"></div> <ngeo-modal ng-model=$ctrl.resetPasswordModalShown> <div class=modal-header> <button type=button class=close data-dismiss=modal aria-label=\\\"{{'Close' | translate}}\\\"> <span aria-hidden=true>&times;</span> </button> <h4 class=modal-title> {{'Password forgotten?' | translate}} </h4> </div> <div class=modal-body translate> A new password has just been sent to you by e-mail. </div> <div class=modal-footer> <button type=button class=\\\"btn btn-default\\\" data-dismiss=modal>{{'OK' | translate}}</button> </div> </ngeo-modal> </div> \";"],"sourceRoot":""}