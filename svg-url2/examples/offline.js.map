{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./examples/offline.js","webpack:///./src/offline/AbstractLocalforageWrapper.js","webpack:///./src/offline/Configuration.js","webpack:///./src/offline/Downloader.js","webpack:///./src/offline/LocalforageAndroidWrapper.js","webpack:///./src/offline/LocalforageCordovaWrapper.js","webpack:///./src/offline/LocalforageIosWrapper.js","webpack:///./src/offline/Mode.js","webpack:///./src/offline/NetworkStatus.js","webpack:///./src/offline/Restorer.js","webpack:///./src/offline/SerializerDeserializer.js","webpack:///./src/offline/ServiceManager.js","webpack:///./src/offline/TilesDownloader.js","webpack:///./src/offline/component.html","webpack:///./src/offline/component.js","webpack:///./src/offline/module.js","webpack:///./src/offline/utils.js"],"names":["exports","module","angular","ngeoMapModule","name","ngeoOfflineModule","NgeoOfflineServiceManager","value","service","ngeoOfflineConfiguration","MainController","ngeoFeatureOverlayMgr","ngeoNetworkStatus","ngeoOfflineServiceManager","offlineExtentSize","map","olMap","layers","olLayerTile","source","olSourceOSM","view","olView","center","zoom","init","setSaveService","setRestoreService","controller","Action","waitingPromises_","Map","currentId_","setItem","args","createAction","getItem","clear","config","command","id","action","waitingPromise","promise","Promise","resolve","reject","set","postToBackend","receiveMessage","event","context","msg","get","console","error","delete","JSON","stringify","defaultImageLoadFunction_","defaultImageLoadFunction","$rootScope","ngeoBackgroundLayerMgr","ngeoOfflineGutter","localforage_","createLocalforage","configureLocalforage","rootScope_","hasData","initializeHasOfflineData","ngeoBackgroundLayerMgr_","serDes_","SerializerDeserializer","gutter","gutter_","dispatchProgress_","progress","dispatchEvent","ngeoCustomEvent","then","setHasOfflineData","hasOfflineData","needDigest","$applyAsync","traceGetSetItem","key","location","search","includes","log","LocalforageCordovaWrapper","LocalforageAndroidWrapper","LocalforageIosWrapper","localforage","removeItem","estimateLoadDataSize","getLayerKey","layerItem","layer","onTileDownloadSuccess","tile","response","utils","normalizeURL","url","onTileDownloadError","getExtentByZoom","ancestors","userExtent","currentZoom","getView","getZoom","results","forEach","dz","push","extent","sourceImageWMSToTileWMS","projection","olSourceImageWMS","getUrl","getImageLoadFunction","tileGrid","createTileGridForProjection","getProjection","olSourceTileWMS","attributions","getAttributions","params","getParams","createLayerMetadatas","layersItems","visitLayer","olLayerLayer","extentByZoom","olProj","getSource","layerType","layerSerialization","olLayerImage","serializeTileLayer","olLayerVector","backgroundLayer","getLayers","root","traverseLayer","createTileLoadFunction_","offlineLayer","that","tileLoadFunction","imageTile","src","content","getImage","recreateOfflineLayer","serialization","deserializeTileLayer","getMaxNumberOfParallelDownloads","olObservable","magnitude2","a","b","magnitudeSquared","i","length","Math","pow","Downloader","configuration_","tileDownloader_","cancel","queueLayerTiles_","layerMetadata","queue","assert","olSourceWMTS","getTileGrid","tileUrlFunction","getTileUrlFunction","extentZoom","z","queueByZ","minX","minY","maxX","maxY","forEachTileCoord","coord","undefined","DEVICE_PIXEL_RATIO","centerTileCoord","sort","save","layersMetadatas","persistentLayers","zooms","tiles","obj","indexOf","persistentObject","setOfflineContentPromise","maxDownloads","TilesDownloader","tileDownloadPromise","download","allPromise","all","window","stringified","receiveFromAndroid","actionString","parse","AbstractWrapper","addEventListener","bind","postMessage","receiveFromIos","item","Mode","enabled_","component_","ngeoOfflineConfiguration_","isEnabled","enable","registerComponent","component","activateOfflineMode","Service","$document","$window","$timeout","ngeoOfflineTestUrl","$document_","$window_","$timeout_","$rootScope_","ngeoOfflineTestUrl_","count_","offline_","promise_","initialize_","navigator","onLine","triggerChangeStatusEvent_","check","evt","jqxhr","settings","thrownError","test","timeout","$","ajax","method","success","offline","$digest","isDisconnected","ngeoMiscDebounce","httpInterceptor","$q","ngeoDebounce","debouncedCheck","request","requestError","rejection","responseError","factory","configFunction_","$httpProvider","interceptors","Restorer","restore","offlineContent","doRestore","getLayerGroup","addLayer","ngeoMapBackgroundLayerMgr","SerDes","createBaseObject_","olObject","properties","getProperties","typeOf","serializeTilegrid","tilegrid","getExtent","getMinZoom","getOrigin","getResolutions","getTileSize","deserializeTilegrid","options","OlTilegridTileGrid","serializeTilegridWMTS","resolutions","getMatrixIds","deserializeTilegridWMTS","OlTilegridWMTS","serializeSourceTileWMS","getUrls","getCode","deserializeSourceTileWMS","OlSourceTileWMS","serializeSourceWMTS","dimensions","getDimensions","format","getFormat","urls","version","getVersion","getLayer","style","getStyle","matrixSet","getMatrixSet","tileGridWMTS","requestEncoding","getRequestEncoding","deserializeSourceWMTS","OlSourceWMTS","makeInfinitySerializable_","number","Infinity","opacity","getOpacity","visible","getVisible","minResolution","getMinResolution","maxResolution","getMaxResolution","zIndex","getZIndex","sourceType","OlLayerTile","ServiceManager","$injector","$injector_","saveService_","restoreService_","getOfflineService_","serviceLike","has","saveLikeService","restoreLikeService","warn","blobToDataUrl","blob","reader","FileReader","onload","result","onerror","readAsDataURL","callbacks","workers","maxNumberOfWorkers_","wasStarted_","tiles_","callbacks_","allCount_","okCount_","koCount_","requestedCount_","resolvePromise_","tileIndex_","cancel_","downloadTile_","tileUrl","xhr","XMLHttpRequest","open","responseType","onTileDownloaded","errorCallback","e","onloadCallback","target","size","dataUrl","onabort","ontimeout","send","ngeoMapFeatureOverlayMgr","ngeoMessageModalComponent","element","attrs","templateUrl","run","$templateCache","put","require","ngeoOfflineTemplateUrl","$element","$attrs","bindings","Controller","ngeoOfflineMode","ngeoOfflineServiceManager_","offlineMode","networkStatus","extentSize","featuresOverlay_","getFeatureOverlay","overlayCollection_","OlCollection","setFeatures","postcomposeListener_","postComposeListenerKey_","dataPolygon_","selectingExtent","downloading","progressPercents","menuDisplayed","displayAlertAbortDownload","displayAlertLoadData","displayAlertNoLayer","maskMargin","minZoom","maxZoom","originalMinZoom","originalMaxZoom","estimatedLoadDataSize","progressCallback_","detail","floor","finishDownload_","$onInit","createMaskPostcompose_","on","$onDestroy","un","computeSizeAndDisplayAlertLoadData","toggleViewExtentSelection","finished","unByKey","removeZoomConstraints_","addZoomConstraints_","render","validateExtent","getDowloadExtent_","askAbortDownload","abortDownload","deleteData","showMenu","createPolygonFromExtent_","getSize","fit","displayExtent_","deactivateOfflineMode","reload","toggleExtentVisibility","isExtentVisible","getLength","reloadIfInOfflineMode","feature","OlFeature","getMaxZoom","setZoom","setMaxZoom","setMinZoom","frameState","resolution","viewState","viewportWidth","pixelRatio","viewportHeight","extentLength","min","extentHalfLength","ceil","beginPath","moveTo","lineTo","closePath","createExtent_","fillStyle","fill","projExtent","OlGeomPolygon","extentToRectangle","olGeomGeometryLayout","XY","halfLength","minx","miny","maxx","maxy","getCenter","getExtentSize_","mapSize","maskSizePixel","maskSizeMeter","getResolution","ngeoOfflineComponent","ngeoOfflineNetworkStatus","downloader","restorer","mode","visitor","descend","olLayerGroup","childLayer","extractor","RegExp","matches","match"],"mappings":";AAAA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,gBAAQ,oBAAoB;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,yBAAiB,4BAA4B;AAC7C;AACA;AACA,0BAAkB,2BAA2B;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;AACA;AACA;AACA,wBAAgB,uBAAuB;AACvC;;;AAGA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;ACnJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAAMA,OAAO,GAAG,EAAhB;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIAA,OAAO,CAACC,MAAR,GAAiBC,+CAAO,CAACD,MAAR,CAAe,KAAf,EAAsB,CACrC,SADqC,EAErCE,0DAAa,CAACC,IAFuB,EAGrCC,8DAAiB,CAACD,IAHmB,EAIrCE,uEAAyB,CAACL,MAA1B,CAAiCG,IAJI,C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","file":"offline.js","sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t\"offline\": 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \tvar jsonpArray = window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([31,\"commons\"]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","/**\n * @module app.offline\n */\nconst exports = {};\n\nimport '@fortawesome/fontawesome-free/css/fontawesome.min.css';\nimport './offline.css';\nimport './common_dependencies.js';\nimport olMap from 'ol/Map.js';\n\nimport olView from 'ol/View.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olSourceOSM from 'ol/source/OSM.js';\nimport ngeoMapModule from 'ngeo/map/module.js';\nimport ngeoOfflineModule from 'ngeo/offline/module.js';\nimport ngeoOfflineConfiguration from 'ngeo/offline/Configuration.js';\nimport NgeoOfflineServiceManager from 'ngeo/offline/ServiceManager.js';\nimport angular from 'angular';\n\n\n/** @type {!angular.IModule} **/\nexports.module = angular.module('app', [\n  'gettext',\n  ngeoMapModule.name,\n  ngeoOfflineModule.name,\n  NgeoOfflineServiceManager.module.name,\n]);\n\nexports.module.value('ngeoOfflineTestUrl', '../../src/offline/component.html');\n\n// Define the offline download configuration service\nngeoOfflineModule.service('ngeoOfflineConfiguration', ngeoOfflineConfiguration);\n\nclass MainController {\n\n  /**\n   * @param {import(\"ngeo/map/FeatureOverlayMgr.js\").FeatureOverlayMgr} ngeoFeatureOverlayMgr\n   * ngeo feature overlay manager service.\n   * @param {import(\"ngeo/offline/NetworkStatus.js\").default} ngeoNetworkStatus ngeo network status service.\n   * @param {NgeoOfflineServiceManager} ngeoOfflineServiceManager ngeo offline service.\n   * @ngInject\n   */\n  constructor(ngeoFeatureOverlayMgr, ngeoNetworkStatus, ngeoOfflineServiceManager) {\n\n    /**\n     * Save a square of 10 km sideways (Map's unit is the meter).\n     * @type {number}\n     * @export\n     */\n    this.offlineExtentSize = 10000;\n\n    /**\n     * @type {ngeoNetworkStatus}\n     * @export\n     */\n    this.ngeoNetworkStatus = ngeoNetworkStatus;\n\n    /**\n     * @type {olMap}\n     * @export\n     */\n    this.map = new olMap({\n      layers: [\n        new olLayerTile({\n          source: new olSourceOSM()\n        })\n      ],\n      view: new olView({\n        center: [352379, 5172733],\n        zoom: 4\n      })\n    });\n\n    ngeoFeatureOverlayMgr.init(this.map);\n\n    ngeoOfflineServiceManager.setSaveService('offlineDownloader');\n    ngeoOfflineServiceManager.setRestoreService('ngeoOfflineRestorer');\n  }\n}\n\n\nexports.module.controller('MainController', MainController);\n\n\nexport default exports;\n","/**\n * @typedef {{\n *   id: number,\n *   plugin: string,\n *   command: string,\n *   args: !Array<*>,\n *   context: (*|undefined)\n * }}\n */\n// eslint-disable-next-line no-unused-vars\nlet Action;\n\n/**\n * @abstract\n */\nconst exports = class AbstractLocalforageWrapper {\n  constructor() {\n    this.waitingPromises_ = new Map();\n    this.currentId_ = 0;\n  }\n\n  setItem(...args) {\n    return this.createAction('setItem', ...args);\n  }\n\n  getItem(...args) {\n    return this.createAction('getItem', ...args);\n  }\n\n  clear() {\n    return this.createAction('clear');\n  }\n\n  config(...args) {\n    return this.createAction('config', ...args);\n  }\n\n  /**\n   * @export\n   * @param {string} command .\n   * @param  {...*} args .\n   * @return {Promise} .\n   */\n  createAction(command, ...args) {\n    const id = ++this.currentId_;\n    /**\n     * @type {Action}\n     */\n    const action = {\n      'plugin': 'localforage',\n      'command': command,\n      'args': args,\n      'id': id\n    };\n    const waitingPromise = {};\n    const promise = new Promise((resolve, reject) => {\n      waitingPromise['resolve'] = resolve;\n      waitingPromise['reject'] = reject;\n    });\n    this.waitingPromises_.set(id, waitingPromise);\n    this.postToBackend(action);\n    return promise;\n  }\n\n  /**\n   * @export\n   * @param {*} event .\n   */\n  receiveMessage(event) {\n    /**\n     * @type {Action}\n     */\n    const action = event['data'];\n    const id = action['id'];\n    const command = action['command'];\n    const args = action['args'] || [];\n    const context = action['context'];\n    const msg = action['msg'];\n\n    const waitingPromise = this.waitingPromises_.get(id);\n    if (command === 'error') {\n      console.error(msg, args, context);\n      if (waitingPromise) {\n        waitingPromise.reject(args, context);\n        this.waitingPromises_.delete(id);\n      }\n    } else if (command === 'response') {\n      waitingPromise.resolve(...args);\n      this.waitingPromises_.delete(id);\n    } else {\n      console.error('Unhandled command', JSON.stringify(action, null, '\\t'));\n    }\n  }\n\n  /**\n   * @abstract\n   * @protected\n   * @param {Action} action .\n   */\n  postToBackend(action) {\n  }\n};\n\n\nexport default exports;\n","import olObservable from 'ol/Observable.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport * as olProj from 'ol/proj.js';\nimport {defaultImageLoadFunction} from 'ol/source/Image.js';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport {createForProjection as createTileGridForProjection} from 'ol/tilegrid.js';\nimport SerializerDeserializer from 'ngeo/offline/SerializerDeserializer.js';\nimport LocalforageCordovaWrapper from 'ngeo/offline/LocalforageCordovaWrapper.js';\nimport LocalforageAndroidWrapper from 'ngeo/offline/LocalforageAndroidWrapper.js';\nimport LocalforageIosWrapper from 'ngeo/offline/LocalforageIosWrapper.js';\nimport ngeoCustomEvent from 'ngeo/CustomEvent.js';\nimport utils from 'ngeo/offline/utils.js';\nconst defaultImageLoadFunction_ = defaultImageLoadFunction;\n\nimport localforage from 'localforage/src/localforage.js';\n\n\n/**\n * @implements {ngeox.OfflineOnTileDownload}\n */\nconst exports = class extends olObservable {\n\n  /**\n   * @ngInject\n   * @param {!angular.IScope} $rootScope The rootScope provider.\n   * @param {!import(\"ngeo/map/BackgroundLayerMgr.js\").MapBackgroundLayerManager} ngeoBackgroundLayerMgr\n   *    Background layer manager.\n   * @param {number} ngeoOfflineGutter A gutter around the tiles to download (to avoid cut symbols)\n   */\n  constructor($rootScope, ngeoBackgroundLayerMgr, ngeoOfflineGutter) {\n    super();\n\n    this.localforage_ = this.createLocalforage();\n    this.configureLocalforage();\n\n    /**\n     * @private\n     * @type {!angular.IScope}\n     */\n    this.rootScope_ = $rootScope;\n\n    /**\n     * @protected\n     * @type {boolean}\n     */\n    this.hasData = false;\n    this.initializeHasOfflineData();\n\n    /**\n     * @private\n     * @type {!import(\"ngeo/map/BackgroundLayerMgr.js\").MapBackgroundLayerManager}\n     */\n    this.ngeoBackgroundLayerMgr_ = ngeoBackgroundLayerMgr;\n\n    /**\n     * @private\n     * @type {SerializerDeserializer}\n     */\n    this.serDes_ = new SerializerDeserializer({gutter: ngeoOfflineGutter});\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.gutter_ = ngeoOfflineGutter;\n  }\n\n  /**\n   * @private\n   * @param {number} progress new progress.\n   */\n  dispatchProgress_(progress) {\n    this.dispatchEvent(new ngeoCustomEvent('progress', {\n      'progress': progress\n    }));\n  }\n\n  /**\n   * @protected\n   */\n  initializeHasOfflineData() {\n    this.getItem('offline_content').then(value => this.setHasOfflineData(!!value));\n  }\n\n  /**\n   * @export\n   * @return {boolean} whether some offline data is available in the storage\n   */\n  hasOfflineData() {\n    return this.hasData;\n  }\n\n  /**\n   * @param {boolean} value whether there is offline data available in the storage.\n   */\n  setHasOfflineData(value) {\n    const needDigest = value !== this.hasData;\n    this.hasData = value;\n    if (needDigest) {\n      this.rootScope_.$applyAsync(); // force update of the UI\n    }\n  }\n\n  /**\n   * Hook to allow measuring get/set item performance.\n   * @param {string} msg A message\n   * @param {string} key The key to work on\n   * @param {Promise<?>} promise A promise\n   * @return {Promise<?>} The promise we passed\n   */\n  traceGetSetItem(msg, key, promise) {\n    return promise;\n  }\n\n  createLocalforage() {\n    if (location.search.includes('localforage=cordova')) {\n      console.log('Using cordova localforage');\n      return new LocalforageCordovaWrapper();\n    } else if (location.search.includes('localforage=android')) {\n      console.log('Using android localforage');\n      return new LocalforageAndroidWrapper();\n    } else if (location.search.includes('localforage=ios')) {\n      console.log('Using ios localforage');\n      return new LocalforageIosWrapper();\n    }\n    return localforage;\n  }\n\n  configureLocalforage() {\n    this.localforage_.config({\n      'name': 'ngeoOfflineStorage',\n      'version': 1.0,\n      'storeName': 'offlineStorage'\n    });\n  }\n\n  /**\n   * @param {string} key The key\n   * @return {Promise<?>} A promise\n   */\n  getItem(key) {\n    return this.traceGetSetItem('getItem', key, this.localforage_['getItem'](key));\n  }\n\n  /**\n   * @param {string} key .\n   * @return {Promise<?>} .\n   */\n  removeItem(key) {\n    return this.traceGetSetItem('removeItem', key, this.localforage_['removeItem'](key));\n  }\n\n  /**\n   * @param {string} key The key\n   * @param {*} value A value\n   * @return {Promise<?>} A promise\n   */\n  setItem(key, value) {\n    return this.traceGetSetItem('setItem', key, this.localforage_['setItem'](key, value));\n  }\n\n  /**\n   * @return {Promise} A promise\n   */\n  clear() {\n    this.setHasOfflineData(false);\n    return this.traceGetSetItem('clear', '', this.localforage_['clear']());\n  }\n\n  /**\n   * @param {!import(\"ol/Map.js\").default} map A map\n   * @return {number} An \"estimation\" of the size of the data to download\n   */\n  estimateLoadDataSize(map) {\n    return 50;\n  }\n\n  /**\n   * @param {import(\"./index.js\").OfflineLayerMetadata} layerItem The layer metadata\n   * @return {string} A key identifying an offline layer and used during restore.\n   */\n  getLayerKey(layerItem) {\n    return /** @type {string} */ (layerItem.layer.get('label'));\n  }\n\n  /**\n   * @override\n   * @param {number} progress The download progress\n   * @param {import(\"./index.js\").OfflineTile} tile The tile\n   * @return {Promise} A promise\n   */\n  onTileDownloadSuccess(progress, tile) {\n    this.dispatchProgress_(progress);\n\n    if (tile.response) {\n      return this.setItem(utils.normalizeURL(tile.url), tile.response);\n    }\n    return Promise.resolve();\n  }\n\n  /**\n   * @override\n   * @param {number} progress The progress\n   * @return {Promise} A promise\n   */\n  onTileDownloadError(progress) {\n    this.dispatchProgress_(progress);\n    return Promise.resolve();\n  }\n\n  /**\n    * @param {import(\"ol/Map.js\").default} map A map\n    * @param {import(\"ol/layer/Layer.js\").default} layer A layer\n    * @param {Array<import(\"ol/layer/Group.js\").default>} ancestors The ancestors of that layer\n    * @param {import(\"ol/extent.js\").Extent} userExtent The extent selected by the user.\n    * @return {Array<import(\"./index.js\").OfflineExtentByZoom>} The extent to download per zoom level\n   */\n  getExtentByZoom(map, layer, ancestors, userExtent) {\n    const currentZoom = map.getView().getZoom();\n    // const viewportExtent = map.calculateExtent(map.getSize());\n\n    const results = [];\n    [0, 1, 2, 3, 4].forEach((dz) => {\n      results.push({\n        zoom: currentZoom + dz,\n        extent: userExtent\n      });\n    });\n    return results;\n  }\n\n  /**\n   * @protected\n   * @param {import(\"ol/source/Source.js\").default} source An ImageWMS source\n   * @param {!import(\"ol/proj/Projection.js\").default} projection The projection\n   * @return {import(\"ol/source/Source.js\").default} A tiled equivalent source\n   */\n  sourceImageWMSToTileWMS(source, projection) {\n    if (source instanceof olSourceImageWMS && source.getUrl()\n        && source.getImageLoadFunction() === defaultImageLoadFunction_) {\n      const tileGrid = createTileGridForProjection(source.getProjection() || projection, 42, 256);\n      source = new olSourceTileWMS({\n        gutter: this.gutter_,\n        url: source.getUrl(),\n        tileGrid: tileGrid,\n        attributions: source.getAttributions(),\n        projection: source.getProjection(),\n        params: source.getParams()\n      });\n    }\n    return source;\n  }\n\n  /**\n   * @param {import(\"ol/Map.js\").default} map The map to work on.\n   * @param {import(\"ol/extent.js\").Extent} userExtent The extent selected by the user.\n   * @return {!Array<import(\"./index.js\").OfflineLayerMetadata>} the downloadable layers and metadata.\n   */\n  createLayerMetadatas(map, userExtent) {\n    const layersItems = [];\n\n    /**\n     * @param {import(\"ol/layer/Base.js\").default} layer .\n     * @param {Array<import(\"ol/layer/Group.js\").default>} ancestors .\n     * @return {boolean} whether to traverse this layer children.\n     */\n    const visitLayer = (layer, ancestors) => {\n      if (layer instanceof olLayerLayer) {\n        const extentByZoom = this.getExtentByZoom(map, layer, ancestors, userExtent);\n        const projection = olProj.get(map.getView().getProjection());\n        const source = this.sourceImageWMSToTileWMS(layer.getSource(), projection);\n        let layerType;\n        let layerSerialization;\n        if (layer instanceof olLayerTile || layer instanceof olLayerImage) {\n          layerType = 'tile';\n          layerSerialization = this.serDes_.serializeTileLayer(layer, source);\n        } else if (layer instanceof olLayerVector) {\n          layerType = 'vector';\n        }\n\n        const backgroundLayer = this.ngeoBackgroundLayerMgr_.get(map) === layer;\n        layersItems.push({\n          backgroundLayer,\n          map,\n          extentByZoom,\n          layerType,\n          layerSerialization,\n          layer,\n          source,\n          ancestors\n        });\n      }\n      return true;\n    };\n    map.getLayers().forEach((root) => {\n      utils.traverseLayer(root, [], visitLayer);\n    });\n    return layersItems;\n  }\n\n  /**\n   * @private\n   * @param {import(\"./index.js\").OfflinePersistentLayer} offlineLayer The offline layer\n   * @return {function(import(\"ol/ImageTile.js\").default, string)} the tile function\n   */\n  createTileLoadFunction_(offlineLayer) {\n    const that = this;\n    /**\n     * Load the tile from persistent storage.\n     * @param {import(\"ol/ImageTile.js\").default} imageTile The image tile\n     * @param {string} src The tile URL\n     */\n    const tileLoadFunction = function(imageTile, src) {\n      that.getItem(utils.normalizeURL(src)).then((content) => {\n        if (!content) {\n          // use a transparent 1x1 image to make the map consistent\n          /* eslint-disable-next-line */\n          content = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';\n        }\n        /** @type {HTMLImageElement} */ (imageTile.getImage()).src = content;\n      });\n    };\n    return tileLoadFunction;\n  }\n\n  /**\n   * @param {import(\"./index.js\").OfflinePersistentLayer} offlineLayer The layer to recreate\n   * @return {import(\"ol/layer/Layer.js\").default} the layer.\n   */\n  recreateOfflineLayer(offlineLayer) {\n    if (offlineLayer.layerType === 'tile') {\n      const serialization = offlineLayer.layerSerialization;\n      const tileLoadFunction = this.createTileLoadFunction_(offlineLayer);\n      const layer = this.serDes_.deserializeTileLayer(serialization, tileLoadFunction);\n      return layer;\n    }\n    return null;\n  }\n\n  /**\n   * @return {number} The number\n   */\n  getMaxNumberOfParallelDownloads() {\n    return 11;\n  }\n};\n\n\nexport default exports;\n","import {DEVICE_PIXEL_RATIO} from 'ol/has.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport olSourceWMTS from 'ol/source/WMTS.js';\nimport TilesDownloader from 'ngeo/offline/TilesDownloader.js';\nimport angular from 'angular';\n\n\n/**\n * @param {import(\"ol/coordinate.js\").Coordinate} a Some coordinates.\n * @param {import(\"ol/coordinate.js\").Coordinate} b Some other coordinates.\n * @return {number} The squared magnitude.\n */\nfunction magnitude2(a, b) {\n  let magnitudeSquared = 0;\n  for (let i = 0; i < a.length; ++i) {\n    magnitudeSquared += Math.pow(a[1] - b[1], 2);\n  }\n  return magnitudeSquared;\n}\n\n\nconst Downloader = class {\n\n  /**\n   * @ngInject\n   * @param {import(\"ngeo/offline/Configuration.js\").default} ngeoOfflineConfiguration\n   * A service for customizing offline behaviour.\n   */\n  constructor(ngeoOfflineConfiguration) {\n    /**\n     * @private\n     * @type {import(\"ngeo/offline/Configuration.js\").default}\n     */\n    this.configuration_ = ngeoOfflineConfiguration;\n\n    /**\n     * @type {TilesDownloader}\n     * @private\n     */\n    this.tileDownloader_ = null;\n  }\n\n  cancel() {\n    this.tileDownloader_.cancel();\n  }\n\n  /**\n   * @param {import(\"./index.js\").OfflineLayerMetadata} layerMetadata Layers metadata.\n   * @param {Array<import(\"./index.js\").OfflineTile>} queue Queue of tiles to download.\n   */\n  queueLayerTiles_(layerMetadata, queue) {\n    const source = /** @type {olSourceTileWMS|olSourceWMTS} */ (layerMetadata.source);\n    const {map, extentByZoom} = layerMetadata;\n\n    if (!source) {\n      return;\n    }\n    console.assert(source instanceof olSourceTileWMS || source instanceof olSourceWMTS);\n    const projection = map.getView().getProjection();\n    const tileGrid = source.getTileGrid();\n    const tileUrlFunction = source.getTileUrlFunction();\n\n    console.assert(extentByZoom);\n    for (const extentZoom of extentByZoom) {\n      const z = extentZoom.zoom;\n      const extent = extentZoom.extent;\n      const queueByZ = [];\n      let minX, minY, maxX, maxY;\n      tileGrid.forEachTileCoord(extent, z, (coord) => {\n        maxX = coord[1];\n        maxY = coord[2];\n        if (minX === undefined || minY === undefined) {\n          minX = coord[1];\n          minY = coord[2];\n        }\n        const url = tileUrlFunction(coord, DEVICE_PIXEL_RATIO, projection);\n        console.assert(url);\n\n        /**\n         * @type {import(\"./index.js\").OfflineTile}\n         */\n        const tile = {coord, url, response: null};\n        queueByZ.push(tile);\n      });\n\n      // @ts-ignore\n      const centerTileCoord = [z, (minX + maxX) / 2, (minY + maxY) / 2];\n      queueByZ.sort((a, b) => magnitude2(a.coord, centerTileCoord) - magnitude2(b.coord, centerTileCoord));\n      queue.push(...queueByZ);\n    }\n  }\n\n  /**\n   * @param {import(\"ol/extent.js\").Extent} extent The extent to download.\n   * @param {import(\"ol/Map.js\").default} map The map to work on.\n   * @return {Promise} A promise resolving when save is finished.\n   */\n  save(extent, map) {\n    /**\n     * @type {!Array<import(\"./index.js\").OfflineLayerMetadata>}\n     */\n    const layersMetadatas = this.configuration_.createLayerMetadatas(map, extent);\n\n    /**\n     * @type {!Array<import(\"./index.js\").OfflinePersistentLayer>}\n     */\n    const persistentLayers = [];\n    const queue = [];\n    const zooms = [];\n    for (const layerItem of layersMetadatas) {\n      if (layerItem.layerType === 'tile') {\n        const tiles = [];\n        this.queueLayerTiles_(layerItem, tiles);\n        queue.push(...tiles);\n      }\n      persistentLayers.push({\n        backgroundLayer: layerItem.backgroundLayer,\n        layerType: layerItem.layerType,\n        layerSerialization: layerItem.layerSerialization,\n        key: this.configuration_.getLayerKey(layerItem),\n      });\n\n      layerItem.extentByZoom.forEach((obj) => {\n        const zoom = obj.zoom;\n        if (zooms.indexOf(zoom) < 0) {\n          zooms.push(zoom);\n        }\n      });\n    }\n\n    /**\n     * @type {import(\"./index.js\").OfflinePersistentContent}\n     */\n    const persistentObject = {\n      extent: extent,\n      layers: persistentLayers,\n      zooms: zooms.sort((a, b) => (a < b ? -1 : 1))\n    };\n    const setOfflineContentPromise = this.configuration_.setItem('offline_content', persistentObject);\n\n    const maxDownloads = this.configuration_.getMaxNumberOfParallelDownloads();\n    this.tileDownloader_ = new TilesDownloader(queue, this.configuration_, maxDownloads);\n    const tileDownloadPromise = this.tileDownloader_.download();\n\n    const allPromise = Promise.all([setOfflineContentPromise, tileDownloadPromise]);\n    const setHasOfflineData = () => this.configuration_.setHasOfflineData(true);\n    allPromise.then(setHasOfflineData, setHasOfflineData);\n    return allPromise;\n  }\n};\n\nconst name = 'offlineDownloader';\nDownloader.module = angular.module(name, []).service(name, Downloader);\n\nconst exports = Downloader;\n\n\nexport default exports;\n","import AbstractWrapper from 'ngeo/offline/AbstractLocalforageWrapper.js';\n\nconst exports = class AndroidWrapper extends AbstractWrapper {\n  constructor() {\n    super();\n    window['androidWrapper'] = this;\n  }\n\n  /**\n   * @override\n   */\n  postToBackend(action) {\n    const stringified = JSON.stringify(action);\n    window['ngeoHost']['postMessageToAndroid'](stringified);\n  }\n\n  /**\n   * @export\n   * @param {string} actionString .\n   */\n  receiveFromAndroid(actionString) {\n    const action = JSON.parse(actionString);\n    this.receiveMessage({\n      'data': action\n    });\n  }\n};\n\n\nexport default exports;\n","import AbstractWrapper from 'ngeo/offline/AbstractLocalforageWrapper.js';\n\nconst exports = class CordovaWrapper extends AbstractWrapper {\n  constructor() {\n    super();\n    window.addEventListener('message', this.receiveMessage.bind(this), false);\n  }\n\n  /**\n   * @override\n   */\n  postToBackend(action) {\n    window['parent'].postMessage(action, '*');\n  }\n};\n\n\nexport default exports;\n","import AbstractWrapper from 'ngeo/offline/AbstractLocalforageWrapper.js';\n\nconst exports = class IosWrapper extends AbstractWrapper {\n  constructor() {\n    super();\n    window['iosWrapper'] = this;\n  }\n\n  /**\n   * @override\n   */\n  postToBackend(action) {\n    if (action['command'] === 'setItem') {\n      action['args'][1] = JSON.stringify(action['args'][1]);\n    }\n    const stringified = JSON.stringify(action);\n    window['webkit']['messageHandlers']['ios']['postMessage'](stringified);\n  }\n\n  /**\n   * @export\n   * @param {string} actionString .\n   */\n  receiveFromIos(actionString) {\n    const action = JSON.parse(actionString);\n    action['args'] = (action['args'] || []).map(item => JSON.parse(item));\n    this.receiveMessage({\n      'data': action\n    });\n  }\n};\n\n\nexport default exports;\n","import angular from 'angular';\n\n\nclass Mode {\n\n  /**\n   * @param {import(\"ngeo/offline/Configuration.js\").default} ngeoOfflineConfiguration\n   * ngeo offline configuration service.\n   * @ngInject\n   * @ngdoc service\n   * @ngname ngeoOfflineState\n   */\n  constructor(ngeoOfflineConfiguration) {\n\n    /**\n     * Offline mode is enabled or not.\n     * @type {boolean}\n     * @private\n     */\n    this.enabled_ = false;\n\n    /**\n     * Offline component.\n     * @type {import(\"ngeo/offline/component.js\").Controller|undefined}\n     * @private\n     */\n    this.component_;\n\n    /**\n     * @private\n     * @type {import(\"ngeo/offline/Configuration.js\").default}\n     */\n    this.ngeoOfflineConfiguration_ = ngeoOfflineConfiguration;\n  }\n\n  /**\n   * Return if we are in offline mode.\n   * @return {boolean} whether offline mode is enabled\n   * @export\n   */\n  isEnabled() {\n    return this.enabled_;\n  }\n\n  /**\n   * Enable offline mode. ATM we cannot escape from the offline mode.\n   * @export\n   */\n  enable() {\n    this.enabled_ = true;\n  }\n\n  /**\n   *\n   * @param {import(\"ngeo/offline/component.js\").Controller} component Offline component.\n   * @export\n   */\n  registerComponent(component) {\n    this.component_ = component;\n  }\n\n  /**\n   * @export\n   */\n  activateOfflineMode() {\n    this.component_.activateOfflineMode();\n  }\n\n  /**\n   * @return {boolean} True if data are accessible offline.\n   * @export\n   */\n  hasData() {\n    return this.ngeoOfflineConfiguration_.hasOfflineData();\n  }\n\n}\n\n/**\n * @type {!angular.IModule}\n */\nconst module = angular.module('ngeoOfflineMode', []);\nmodule.service('ngeoOfflineMode', Mode);\nMode.module = module;\n\n\nexport default Mode;\n","import ngeoMiscDebounce from 'ngeo/misc/debounce.js';\nimport angular from 'angular';\n\n\nconst Service = class {\n\n  /**\n   * This service watches the status of network connection.\n   *\n   * Currently it watches every $http and $.ajax requests errors, if an error\n   * occurs we wait 2 sec then we make an http request on the checker file.\n   * If the checker responds that means we are online, otherwise we make a\n   * 2nd request 2 sec later, if the 2nd requests failed that means we\n   * are offline.\n   *\n   * A timeout of 1 sec is set for the checker file, so if we have a bad\n   * connection, we consider we are offline.\n   *\n   * During offline mode we test every 2 sec if we are back online.\n   *\n   * @ngInject\n   * @param {!jQuery} $document Angular document service.\n   * @param {angular.IWindowService} $window Angular window service.\n   * @param {angular.ITimeoutService} $timeout Angular timeout service.\n   * @param {angular.IScope} $rootScope The root scope.\n   * @param {string} ngeoOfflineTestUrl Url of the test page.\n   */\n  constructor($document, $window, $timeout, $rootScope, ngeoOfflineTestUrl) {\n\n    /**\n     * @private\n     * @type {!jQuery}\n     */\n    this.$document_ = $document;\n\n    /**\n     * @private\n     * @type {!Window}\n     */\n    this.$window_ = $window;\n\n    /**\n     * @private\n     * @type {!angular.ITimeoutService}\n     */\n    this.$timeout_ = $timeout;\n\n    /**\n     * @private\n     * @type {angular.IScope}\n     */\n    this.$rootScope_ = $rootScope;\n\n    /**\n     * @private\n     * @type {string}\n     */\n    this.ngeoOfflineTestUrl_ = ngeoOfflineTestUrl;\n\n    /**\n     * @private\n     * @type {!number}\n     */\n    this.count_ = 0;\n\n    /**\n     * @type {!boolean|undefined}\n     * @private\n     */\n    this.offline_;\n\n    /**\n     * @private\n     * @type {angular.IPromise|undefined}\n     */\n    this.promise_;\n\n    this.initialize_();\n\n  }\n\n  initialize_() {\n    this.offline_ = !this.$window_.navigator.onLine;\n\n    // airplane mode, works offline(firefox)\n    this.$window_.addEventListener('offline', () => {\n      this.triggerChangeStatusEvent_(true);\n    });\n\n    // online event doesn't means we have a internet connection, that means we\n    // have possiby one (connected to a router ...)\n    this.$window_.addEventListener('online', () => {\n      this.check(undefined);\n    });\n\n    // We catch every $.ajax request errors or (canceled request).\n    if (this.$document_['ajaxError']) {\n      this.$document_['ajaxError']((evt, jqxhr, settings, thrownError) => {\n        // Filter out canceled requests\n        if (!/^(canceled|abort)$/.test(thrownError)) {\n          this.check(2000);\n        }\n      });\n    }\n  }\n\n  /**\n   * Check fir network status\n   *\n   * @param {number=} timeout Delay for timeout.\n   */\n  check(timeout) {\n    if (this.promise_) {\n      this.$timeout_.cancel(this.promise_);\n      this.promise_ = undefined;\n    }\n    if (timeout !== undefined) {\n      this.count_++;\n      this.promise_ = this.$timeout_(() => this.check(), timeout);\n      return;\n    }\n    $.ajax({\n      method: 'GET',\n      url: this.ngeoOfflineTestUrl_,\n      timeout: 1000,\n      success: () => {\n        this.count_ = 0;\n        if (this.offline_) {\n          this.triggerChangeStatusEvent_(false);\n        }\n      },\n      error: () => {\n        this.count_++;\n        // We consider we are offline after 3 requests failed\n        if (this.count_ > 2 && !this.offline_) {\n          this.triggerChangeStatusEvent_(true);\n        }\n      }\n    });\n\n  }\n\n  /**\n   * @param {boolean} offline whether it's offline or not.\n   * @private\n   */\n  triggerChangeStatusEvent_(offline) {\n    this.offline_ = offline;\n    // this.$rootScope_.$broadcast('ngeoNetworkStatusChange', net.offline);\n    this.$rootScope_.$digest();\n  }\n\n  /**\n   * @return {boolean} True if we are disconnected.\n   * @export\n   */\n  isDisconnected() {\n    return !!this.offline_;\n  }\n};\n\n\nconst name = 'ngeoNetworkStatus';\n\nService.module = angular.module(name, [\n  ngeoMiscDebounce.name\n]);\nService.module.service(name, Service);\n\n\n/**\n * @ngInject\n * @param {angular.IQService} $q The Angular $q service.\n * @param {import(\"ngeo/misc/debounce.js\").miscDebounce<function()>} ngeoDebounce ngeo debounce service.\n * @param {Service} ngeoNetworkStatus ngeo network status service.\n * @return {angular.IHttpInterceptor} the interceptor\n */\nconst httpInterceptor = function($q, ngeoDebounce, ngeoNetworkStatus) {\n  const debouncedCheck = ngeoDebounce(() => ngeoNetworkStatus.check(undefined), 2000, false);\n  return {\n    request(config) {\n      return config;\n    },\n    requestError(rejection) {\n      return $q.reject(rejection);\n    },\n    response(response) {\n      return response;\n    },\n    responseError(rejection) {\n      debouncedCheck();\n      return $q.reject(rejection);\n    }\n  };\n};\nService.module.factory('httpInterceptor', httpInterceptor);\n\n\n/**\n * @ngInject\n * @private\n * @param {angular.IHttpProvider} $httpProvider .\n */\nService.module.configFunction_ = function($httpProvider) {\n  $httpProvider.interceptors.push('httpInterceptor');\n};\nService.module.config(Service.module.configFunction_);\n\nService.module.value('ngeoOfflineTestUrl', '');\n\nconst exports = Service;\n\n\nexport default exports;\n","import ngeoMapBackgroundLayerMgr from 'ngeo/map/BackgroundLayerMgr.js';\nimport angular from 'angular';\n\n\nclass Restorer {\n\n  /**\n   * @ngInject\n   * @param {import(\"ngeo/offline/Configuration.js\").default}\n   * ngeoOfflineConfiguration A service for customizing offline behaviour.\n   * @param {import(\"ngeo/map/BackgroundLayerMgr.js\").MapBackgroundLayerManager}\n   * ngeoBackgroundLayerMgr The background layer manager.\n   */\n  constructor(ngeoOfflineConfiguration, ngeoBackgroundLayerMgr) {\n    /**\n     * @private\n     * @type {import(\"ngeo/offline/Configuration.js\").default}\n     */\n    this.configuration_ = ngeoOfflineConfiguration;\n\n    /**\n     * @private\n     * @type {import(\"ngeo/map/BackgroundLayerMgr.js\").MapBackgroundLayerManager}\n     */\n    this.ngeoBackgroundLayerMgr_ = ngeoBackgroundLayerMgr;\n  }\n\n  /**\n   * @param {import(\"ol/Map.js\").default} map The map to work on.\n   * @return {Promise<import(\"ol/extent.js\").Extent>} A promise to the extent of the restored area.\n   */\n  restore(map) {\n    return this.configuration_.getItem('offline_content').then(\n      offlineContent => this.doRestore(map, offlineContent));\n  }\n\n  /**\n   * @protected\n   * @param {import(\"ol/Map.js\").default} map A map\n   * @param {import(\"./index.js\").OfflinePersistentContent} offlineContent The offline content\n   * @return {import(\"ol/extent.js\").Extent} The extent of the restored area\n   */\n  doRestore(map, offlineContent) {\n    map.getLayerGroup().getLayers().clear();\n    for (const offlineLayer of offlineContent.layers) {\n      const layer = this.configuration_.recreateOfflineLayer(offlineLayer);\n      if (layer) {\n        map.addLayer(layer);\n        if (offlineLayer.backgroundLayer) {\n          this.ngeoBackgroundLayerMgr_.set(map, layer);\n        }\n      }\n    }\n    return offlineContent.extent;\n  }\n}\n\nconst name = 'ngeoOfflineRestorer';\nRestorer.module = angular.module(name, [\n  ngeoMapBackgroundLayerMgr.name\n]).service(name, Restorer);\n\nconst exports = Restorer;\n\n\nexport default exports;\n","import OlTilegridTileGrid from 'ol/tilegrid/TileGrid.js';\nimport OlTilegridWMTS from 'ol/tilegrid/WMTS.js';\nimport * as olProj from 'ol/proj.js';\nimport OlSourceTileWMS from 'ol/source/TileWMS.js';\nimport OlSourceWMTS from 'ol/source/WMTS.js';\nimport OlLayerTile from 'ol/layer/Tile.js';\n\n\nconst SerDes = class {\n  /**\n   * @param {Object} options The options\n   */\n  constructor({gutter}) {\n    /**\n     * @private\n     */\n    this.gutter_ = gutter;\n  }\n\n  /**\n   * @private\n   * @param {import(\"ol/Object.js\").default} olObject An OL object\n   * @return {Object} The serializable properties of the object\n   */\n  createBaseObject_(olObject) {\n    const properties = olObject.getProperties();\n    const obj = {};\n    for (const key in properties) {\n      const value = properties[key];\n      const typeOf = typeof value;\n      if (typeOf === 'string' || typeOf === 'number') {\n        obj[key] = value;\n      }\n    }\n    return obj;\n  }\n\n  /**\n   * @param {OlTilegridTileGrid} tilegrid .\n   * @return {string} .\n   */\n  serializeTilegrid(tilegrid) {\n    const obj = {};\n    obj['extent'] = tilegrid.getExtent();\n    obj['minZoom'] = tilegrid.getMinZoom();\n    obj['origin'] = tilegrid.getOrigin(0); // hack\n    obj['resolutions'] = tilegrid.getResolutions();\n    obj['tileSize'] = tilegrid.getTileSize(tilegrid.getMinZoom());\n    return JSON.stringify(obj);\n  }\n\n  /**\n   * @param {string} serialization .\n   * @return {OlTilegridTileGrid} tilegrid\n   */\n  deserializeTilegrid(serialization) {\n    const options = /** @type {import (\"ol/tilegrid/WMTS\").Options} */ (JSON.parse(serialization));\n    return new OlTilegridTileGrid(options);\n  }\n\n  /**\n   * @param {OlTilegridWMTS} tilegrid .\n   * @return {string|undefined} .\n   */\n  serializeTilegridWMTS(tilegrid) {\n    if (!tilegrid) {\n      return undefined;\n    }\n    const obj = {};\n    const resolutions = tilegrid.getResolutions();\n    obj['extent'] = tilegrid.getExtent();\n    obj['minZoom'] = tilegrid.getMinZoom();\n    obj['matrixIds'] = tilegrid.getMatrixIds();\n    obj['resolutions'] = resolutions;\n\n    obj['origins'] = [];\n    for (let z = 0; z < resolutions.length; ++z) {\n      obj['origins'].push(tilegrid.getOrigin(z));\n    }\n    return JSON.stringify(obj);\n  }\n\n  /**\n   * @param {string} serialization .\n   * @return {OlTilegridWMTS} tilegrid .\n   */\n  deserializeTilegridWMTS(serialization) {\n    const options = /** @type {import (\"ol/tilegrid/WMTS\").Options} */ (JSON.parse(serialization));\n    return new OlTilegridWMTS(options);\n  }\n\n\n  /**\n   * @param {OlSourceTileWMS} source .\n   * @return {string} .\n   */\n  serializeSourceTileWMS(source) {\n    const obj = this.createBaseObject_(source);\n    obj['params'] = source.getParams();\n    obj['urls'] = source.getUrls();\n    obj['tileGrid'] = this.serializeTilegrid(source.getTileGrid());\n    const projection = source.getProjection();\n    if (projection) {\n      obj['projection'] = olProj.get(source.getProjection()).getCode();\n    }\n\n    return JSON.stringify(obj);\n  }\n\n  /**\n   * @param {string} serialization .\n   * @param {function(import(\"ol/ImageTile.js\").default, string)=} tileLoadFunction .\n   * @return {OlSourceTileWMS} source .\n   */\n  deserializeSourceTileWMS(serialization, tileLoadFunction) {\n    const options = /** @type {import (\"ol/source/TileWMS\").Options} */ (JSON.parse(serialization));\n    options.tileLoadFunction = tileLoadFunction;\n    if (options.tileGrid) {\n      options.tileGrid = this.deserializeTilegrid(/** @type{any} */ (options).tileGrid);\n    }\n    options.gutter = this.gutter_;\n    return new OlSourceTileWMS(options);\n  }\n\n  /**\n   * @param {OlSourceWMTS} source .\n   * @return {string} .\n   */\n  serializeSourceWMTS(source) {\n    const obj = this.createBaseObject_(source);\n    obj.dimensions = source.getDimensions();\n    obj.format = source.getFormat();\n    obj.urls = source.getUrls();\n    obj.version = source.getVersion();\n    obj.layer = source.getLayer();\n    obj.style = source.getStyle();\n    obj.matrixSet = source.getMatrixSet();\n    // The OL getTileGrid method is expected to return a WMTS tilegrid so it is OK to cast here.\n    const tileGridWMTS = /** @type {OlTilegridWMTS} */ (source.getTileGrid());\n    obj.tileGrid = this.serializeTilegridWMTS(tileGridWMTS);\n    obj.requestEncoding = source.getRequestEncoding();\n    const projection = source.getProjection();\n    if (projection) {\n      obj.projection = olProj.get(source.getProjection()).getCode();\n    }\n\n    return JSON.stringify(obj);\n  }\n\n  /**\n   * @param {string} serialization .\n   * @param {function(import(\"ol/ImageTile.js\").default, string)=} tileLoadFunction .\n   * @return {OlSourceWMTS} .\n   */\n  deserializeSourceWMTS(serialization, tileLoadFunction) {\n    const options = /** @type {import(\"ol/source/WMTS\").Options} */ (JSON.parse(serialization));\n    options.tileLoadFunction = tileLoadFunction;\n    if (options.tileGrid) {\n      options.tileGrid = this.deserializeTilegridWMTS(/** @type{any} */(options).tileGrid);\n    }\n    return new OlSourceWMTS(options);\n  }\n\n  /**\n   * @private\n   * @param {number} number Some number which may be Infinity\n   * @return {number} The same number or an arbitrary big number instead of Infinity\n   */\n  makeInfinitySerializable_(number) {\n    if (number === Infinity) {\n      return 1000;\n    }\n    return number;\n  }\n\n  /**\n   * @param {!import(\"ol/layer/Tile.js\").default|import(\"ol/layer/Image\").default} layer .\n   * @param {import(\"ol/source/Source.js\").default=} source .\n   * @return {string} .\n   */\n  serializeTileLayer(layer, source) {\n    const obj = this.createBaseObject_(layer);\n    obj.opacity = layer.getOpacity();\n    obj.visible = layer.getVisible();\n    obj.minResolution = layer.getMinResolution();\n    obj.maxResolution = this.makeInfinitySerializable_(layer.getMaxResolution());\n    obj.zIndex = layer.getZIndex();\n    source = source || layer.getSource();\n    if (source instanceof OlSourceTileWMS) {\n      obj.source = this.serializeSourceTileWMS(source);\n      obj.sourceType = 'tileWMS';\n    } else if (source instanceof OlSourceWMTS) {\n      obj.source = this.serializeSourceWMTS(source);\n      obj.sourceType = 'WMTS';\n    }\n    return JSON.stringify(obj);\n  }\n\n  /**\n   * @param {string} serialization .\n   * @param {function(import(\"ol/ImageTile.js\").default, string)=} tileLoadFunction .\n   * @return {!import(\"ol/layer/Tile.js\").default} .\n   */\n  deserializeTileLayer(serialization, tileLoadFunction) {\n    const options = /** @type import(\"ol/layer/Tile\").Options */ (JSON.parse(serialization));\n    const sourceType = options['sourceType'];\n    if (sourceType === 'tileWMS') {\n      options.source = this.deserializeSourceTileWMS(/** @type any */ (options).source, tileLoadFunction);\n    } else if (sourceType === 'WMTS') {\n      options.source = this.deserializeSourceWMTS(/** @type any */ (options).source, tileLoadFunction);\n    }\n    return new OlLayerTile(options);\n  }\n};\n\nconst exports = SerDes;\n\n\nexport default exports;\n","import angular from 'angular';\n\n\nclass ServiceManager {\n\n  /**\n   * @param {angular.auto.IInjectorService} $injector Main injector.\n   * @struct\n   * @ngInject\n   * @ngdoc service\n   * @ngname ngeoOfflineServiceManager\n   */\n  constructor($injector) {\n\n    /**\n     * @type {angular.auto.IInjectorService}\n     * @private\n     */\n    this.$injector_ = $injector;\n\n    /**\n     * @type {*}\n     * @private\n     */\n    this.saveService_ = null;\n\n    /**\n     * @type {*}\n     * @private\n     */\n    this.restoreService_ = null;\n  }\n\n  /**\n   * @param {string|Object} serviceLike A service like.\n   * @param {string} method A method.\n   * @return {Object} A returned object.\n   */\n  getOfflineService_(serviceLike, method) {\n    if (typeof serviceLike === 'string') {\n      if (!this.$injector_.has(serviceLike)) {\n        console.error(`The offline ${method} service could not be found`);\n        return;\n      }\n      const service = this.$injector_.get(serviceLike);\n      if (!service[method]) {\n        console.error(`The offline service ${serviceLike} does not have a ${method} method`);\n        return;\n      }\n      return service;\n    }\n    if (!serviceLike[method]) {\n      console.error(`The provided offline service does not have a ${method} method`);\n      return;\n    }\n    return serviceLike;\n  }\n\n  /**\n   * Set the service to call on 'save'.\n   * @param {string|{save: Function}} saveLikeService\n   * A service name that can be injected or an object that have a 'save' method.\n   */\n  setSaveService(saveLikeService) {\n    this.saveService_ = this.getOfflineService_(saveLikeService, 'save');\n  }\n\n  /**\n   * Set the service to call on 'restore'\n   * @param {string|{restore: Function}} restoreLikeService\n   * A service name that can be injected or an object that have a 'restore' method.\n   */\n  setRestoreService(restoreLikeService) {\n    this.restoreService_ = this.getOfflineService_(restoreLikeService, 'restore');\n  }\n\n  cancel() {\n    if (!this.saveService_) {\n      console.warn('You must register a saveService first');\n      return;\n    }\n    this.saveService_.cancel();\n  }\n\n  /**\n   * Ask the provided service to save the data to an offline purpose\n   * @param {import(\"ol/extent.js\").Extent} extent The extent to dowload.\n   * @param {import(\"ol/Map\").default} map The map to work on.\n   */\n  save(extent, map) {\n    if (!this.saveService_) {\n      console.warn('You must register a saveService first');\n      return;\n    }\n    this.saveService_.save(extent, map);\n  }\n\n  /**\n   * Ask the provided service to restore the saved data on the map\n   * @param {import(\"ol/Map.js\").default} map The map to work on.\n   * @return {Promise<import(\"ol/extent.js\").Extent>} A promise to the extent of the downloaded area\n   */\n  restore(map) {\n    if (!this.restoreService_) {\n      console.warn('You must register a restoreService first');\n      return Promise.reject();\n    }\n    return this.restoreService_.restore(map);\n  }\n}\n\nServiceManager.module = angular.module('ngeoOfflineServiceManager', []);\nServiceManager.module.service('ngeoOfflineServiceManager', ServiceManager);\n\n\nexport default ServiceManager;\n","/**\n * @param {!Blob} blob A blob\n * @return {Promise<string>} data URL\n */\nfunction blobToDataUrl(blob) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = function() {\n      resolve(/** @type String */ (reader.result));\n    };\n    reader.onerror = reject;\n    reader.readAsDataURL(blob);\n  });\n}\n\nconst exports = class {\n\n  /**\n   * @param {Array<import(\"./index.js\").OfflineTile>} tiles An array of tiles to download.\n   * @param {import(\"./index.js\").OfflineOnTileDownload} callbacks The callbacks.\n   * @param {number} workers The maximum number of workers.\n   */\n  constructor(tiles, callbacks, workers) {\n    /**\n     * @private\n     * @type {number}\n     */\n    this.maxNumberOfWorkers_ = workers;\n\n    /**\n     * @private\n     */\n    this.wasStarted_ = false;\n\n    /**\n     * @type {Array<import(\"./index.js\").OfflineTile>}\n     * @private\n     */\n    this.tiles_ = tiles;\n\n    /**\n     * @private\n     * @type {import(\"./index.js\").OfflineOnTileDownload}\n     */\n    this.callbacks_ = callbacks;\n\n    /**\n     * @private\n     */\n    this.allCount_ = 0;\n\n    /**\n     * @private\n     */\n    this.okCount_ = 0;\n\n    /**\n     * @private\n     */\n    this.koCount_ = 0;\n\n    /**\n     * @private\n     */\n    this.requestedCount_ = 0;\n\n    /**\n     * @private\n     * @type {function(): any}\n     */\n    this.resolvePromise_;\n\n    /**\n     * @private\n     * @type {Promise}\n     */\n    this.promise_ = null;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.tileIndex_ = 0;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.cancel_ = false;\n  }\n\n  cancel() {\n    this.cancel_ = true;\n  }\n\n  /**\n   * @private to download.\n   */\n  downloadTile_() {\n    if (this.cancel_ || this.tileIndex_ >= this.tiles_.length) {\n      return;\n    }\n    const tile = this.tiles_[this.tileIndex_++];\n    const tileUrl = tile.url;\n    const xhr = new XMLHttpRequest();\n    xhr['tileUrl'] = tile.url;\n    xhr.open('GET', tileUrl, true);\n    xhr.responseType = 'blob';\n    const onTileDownloaded = () => {\n      if (this.allCount_ === this.tiles_.length) {\n        this.resolvePromise_();\n      }\n      this.downloadTile_();\n    };\n\n    const errorCallback = (e) => {\n      if (this.cancel_) {\n        return;\n      }\n      ++this.allCount_;\n      ++this.koCount_;\n      const progress = this.allCount_ / this.tiles_.length;\n      this.callbacks_.onTileDownloadError(progress).then(onTileDownloaded, onTileDownloaded);\n    };\n\n    const onloadCallback = (e) => {\n      /**\n       * @type {Blob}\n       */\n      const response = e.target.response;\n      if (response && response.size !== 0) { // non-empty tile\n        blobToDataUrl(response).then(\n          (dataUrl) => {\n            if (this.cancel_) {\n              return;\n            }\n            ++this.allCount_;\n            ++this.okCount_;\n            tile.response = dataUrl;\n            const progress = this.allCount_ / this.tiles_.length;\n            this.callbacks_.onTileDownloadSuccess(progress, tile).then(onTileDownloaded, onTileDownloaded);\n          },\n          () => {\n            if (this.cancel_) {\n              return;\n            }\n            errorCallback(e);\n          }\n        );\n      } else {\n        if (this.cancel_) {\n          return;\n        }\n        ++this.allCount_;\n        ++this.okCount_;\n        this.callbacks_.onTileDownloadSuccess(this.allCount_ / this.tiles_.length, tile).then(\n          onTileDownloaded, onTileDownloaded);\n      }\n    };\n\n    xhr.onload = onloadCallback;\n    xhr.onerror = errorCallback;\n    xhr.onabort = errorCallback;\n    xhr.ontimeout = errorCallback;\n    xhr.send();\n    ++this.requestedCount_;\n  }\n\n  /**\n   * @return {Promise} A promise that resolves when the downloads are complete (failing or not)\n   */\n  download() {\n    if (this.promise_) {\n      return this.promise_;\n    }\n\n    this.promise_ = new Promise((resolve, reject) => {\n      this.resolvePromise_ = resolve;\n    });\n\n    console.assert(this.tiles_);\n    if (this.tiles_.length === 0) {\n      this.callbacks_.onTileDownloadError(1); // forcing progress update\n      this.resolvePromise_();\n    } else {\n      for (let i = 0; i < this.maxNumberOfWorkers_; ++i) {\n        this.downloadTile_();\n      }\n    }\n\n    return this.promise_;\n  }\n};\n\n\nexport default exports;\n","module.exports = function(obj) {\nobj || (obj = {});\nvar __t, __p = '';\nwith (obj) {\n__p += '<div class=\"main-button\">\\n  <span ng-if=\"!$ctrl.hasData()\">\\n    <div class=\"no-data\" ng-click=\"$ctrl.toggleViewExtentSelection()\"></div>\\n  </span>\\n  <span ng-if=\"$ctrl.hasData()\">\\n    <div class=\"with-data\" ng-click=\"$ctrl.showMenu()\"></div>\\n  </span>\\n</div>\\n\\n<div ng-if=\"$ctrl.selectingExtent && !$ctrl.networkStatus.isDisconnected()\" class=\"validate-extent btn btn-primary\">\\n  <div ng-if=\"!$ctrl.downloading\" ng-click=\"$ctrl.computeSizeAndDisplayAlertLoadData()\" translate>Save map</div>\\n  <div ng-if=\"$ctrl.downloading\" ng-click=\"$ctrl.askAbortDownload()\" translate>Abort</div>\\n</div>\\n\\n\\n<div ng-if=\"$ctrl.downloading\" class=\"in-progress\">\\n  <div>{{$ctrl.progressPercents}}%</div>\\n</div>\\n\\n<ngeo-modal ng-model=\"$ctrl.menuDisplayed\">\\n  <div class=\"modal-header\">\\n    <button type=\"button\" class=\"close\"\\n              data-dismiss=\"modal\"\\n              aria-label=\"{{\\'Close\\' | translate}}\">\\n      <span aria-hidden=\"true\">&times;</span>\\n    </button>\\n    <h4 class=\"modal-title\" translate>Offline map</h4>\\n  </div>\\n  <div class=\"modal-body\">\\n    <div ng-if=\"$ctrl.hasData()\">\\n      <button type=\"button\" class=\"extent-zoom btn btn-default\"\\n              ng-if=\"!$ctrl.offlineMode.isEnabled()\"\\n              ng-click=\"$ctrl.activateOfflineMode()\"\\n              translate>Activate offline mode\\n      </button>\\n      <button type=\"button\" class=\"extent-zoom btn btn-default\"\\n              ng-if=\"$ctrl.offlineMode.isEnabled() && !$ctrl.networkStatus.isDisconnected()\"\\n              ng-click=\"$ctrl.deactivateOfflineMode()\"\\n              translate>Deactivate offline mode\\n      </button>\\n\\n      <button type=\"button\" class=\"extent-show btn btn-default\"\\n              ng-if=\"$ctrl.offlineMode.isEnabled()\"\\n              ng-click=\"$ctrl.toggleExtentVisibility()\">\\n        <span ng-if=\"$ctrl.isExtentVisible()\" translate>Hide extent</span>\\n        <span ng-if=\"!$ctrl.isExtentVisible()\" translate >Show extent</span>\\n      </button>\\n      <button type=\"button\" class=\"delete btn btn-default\"\\n              ng-if=\"!$ctrl.networkStatus.isDisconnected()\"\\n              ng-click=\"$ctrl.displayAlertDestroyData = true\"\\n              translate>Delete data\\n      </button>\\n    </div>\\n    <div ng-if=\"!$ctrl.hasData() && !$ctrl.networkStatus.isDisconnected()\">\\n      <button type=\"button\" class=\"new-data btn btn-default\"\\n              ng-click=\"$ctrl.toggleViewExtentSelection()\"\\n              translate>Save new map\\n      </button>\\n    </div>\\n  </div>\\n</ngeo-modal>\\n\\n<ngeo-modal ng-model=\"$ctrl.displayAlertLoadData\">\\n  <div class=\"modal-header\">\\n    <h4 class=\"modal-title\" translate>Warning</h4>\\n  </div>\\n  <div class=\"modal-body\">\\n      <p translate>~{{$ctrl.estimatedLoadDataSize}}MB of maps will be downloaded (until scale 1:25\\'000) - Don\\'t lock your device or navigate away from this site during the download process. Deactivate \"private\" mode of your browser.</p>\\n      <button type=\"button\" class=\"validate btn btn-primary\"\\n              data-dismiss=\"modal\"\\n              ng-click=\"$ctrl.validateExtent()\"\\n              translate>Ok\\n      </button>\\n      <button type=\"button\" class=\"delete btn btn-default\"\\n              data-dismiss=\"modal\"\\n              translate>Cancel\\n      </button>\\n  </div>\\n</ngeo-modal>\\n\\n<ngeo-modal ng-model=\"$ctrl.displayAlertNoLayer\">\\n  <div class=\"modal-header\">\\n    <h4 class=\"modal-title\" translate>Warning</h4>\\n  </div>\\n  <div class=\"modal-body\">\\n      <p translate>No maps selected for saving.</p>\\n      <button type=\"button\" class=\"delete btn btn-default\"\\n              data-dismiss=\"modal\"\\n              translate>Ok\\n      </button>\\n  </div>\\n</ngeo-modal>\\n\\n<ngeo-modal ng-model=\"$ctrl.displayAlertDestroyData\">\\n  <div class=\"modal-header\">\\n    <h4 class=\"modal-title\" translate>Warning</h4>\\n  </div>\\n  <div class=\"modal-body\">\\n      <p translate>Do you really want to remove your data ?</p>\\n      <button type=\"button\" class=\"validate btn btn-primary\"\\n              data-dismiss=\"modal\"\\n              ng-click=\"$ctrl.deleteData()\"\\n              translate>Ok\\n      </button>\\n      <button type=\"button\" class=\"delete btn btn-default\"\\n              data-dismiss=\"modal\"\\n              translate>Cancel\\n      </button>\\n  </div>\\n</ngeo-modal>\\n\\n<ngeo-modal ng-model=\"$ctrl.displayAlertAbortDownload\">\\n  <div class=\"modal-header\">\\n    <h4 class=\"modal-title\" translate>Warning</h4>\\n  </div>\\n  <div class=\"modal-body\">\\n      <p translate>Do you really want to remove your data ?</p>\\n      <button type=\"button\" class=\"validate btn btn-primary\"\\n              data-dismiss=\"modal\"\\n              ng-click=\"$ctrl.abortDownload()\"\\n              translate>Ok\\n      </button>\\n      <button type=\"button\" class=\"delete btn btn-default\"\\n              data-dismiss=\"modal\"\\n              ng-click=\"$ctrl.followDownloadProgression_()\"\\n              translate>Cancel\\n      </button>\\n  </div>\\n</ngeo-modal>\\n';\n\n}\nreturn __p\n}","import ngeoMapFeatureOverlayMgr from 'ngeo/map/FeatureOverlayMgr.js';\nimport ngeoMessageModalComponent from 'ngeo/message/modalComponent.js';\nimport {extentToRectangle} from 'ngeo/utils.js';\nimport OlCollection from 'ol/Collection.js';\nimport {unByKey} from 'ol/Observable.js';\nimport OlFeature from 'ol/Feature.js';\nimport OlGeomPolygon from 'ol/geom/Polygon.js';\nimport olGeomGeometryLayout from 'ol/geom/GeometryLayout.js';\nimport {DEVICE_PIXEL_RATIO} from 'ol/has.js';\nimport angular from 'angular';\n\n/**\n * @type {!angular.IModule}\n */\nconst module = angular.module('ngeoOffline', [\n  ngeoMapFeatureOverlayMgr.name,\n  ngeoMessageModalComponent.name\n]);\n\nmodule.value('ngeoOfflineTemplateUrl',\n  /**\n   * @param {JQuery} element Element.\n   * @param {angular.IAttributes} attrs Attributes.\n   * @return {string} Template URL.\n   */\n  (element, attrs) => {\n    const templateUrl = attrs['ngeoOfflineTemplateurl'];\n    return templateUrl !== undefined ? templateUrl :\n      'ngeo/offline/component.html';\n  });\n\nmodule.run(/* @ngInject */ ($templateCache) => {\n  // @ts-ignore: webpack\n  $templateCache.put('ngeo/offline/component.html', require('./component.html'));\n});\n\n/**\n * @param {!JQuery} $element Element.\n * @param {!angular.IAttributes} $attrs Attributes.\n * @param {!function(!JQuery, !angular.IAttributes): string} ngeoOfflineTemplateUrl Template function.\n * @return {string} Template URL.\n * @ngInject\n */\nfunction ngeoOfflineTemplateUrl($element, $attrs, ngeoOfflineTemplateUrl) {\n  return ngeoOfflineTemplateUrl($element, $attrs);\n}\n\n\n/**\n * Provides the \"offline\" component.\n *\n * Example:\n *\n *     <ngeo-offline\n *       ngeo-offline-map=\"ctrl.map\"\n *       ngeo-offline-extentsize=\"ctrl.offlineExtentSize\">\n *       ngeo-offline-mask-margin=\"::100\"\n *       ngeo-offline-min_zoom=\"::11\"\n *       ngeo-offline-max_zoom=\"::15\"\n *     </ngeo-offline>\n *\n * See our live example: [../examples/offline.html](../examples/offline.html)\n *\n * @htmlAttribute {import(\"ol/Map.js\").default} ngeo-offline-map The map.\n * @htmlAttribute {number} ngeo-offline-extentsize The size, in map units, of a side of the extent.\n * @private\n * @ngdoc component\n * @ngname ngeoOffline\n */\nconst component = {\n  bindings: {\n    'map': '<ngeoOfflineMap',\n    'extentSize': '<?ngeoOfflineExtentsize',\n    'maskMargin': '<?ngeoOfflineMaskMargin',\n    'minZoom': '<?ngeoOfflineMinZoom',\n    'maxZoom': '<?ngeoOfflineMaxZoom',\n  },\n  controller: 'ngeoOfflineController',\n  templateUrl: ngeoOfflineTemplateUrl\n};\n\n\nmodule.component('ngeoOffline', component);\n\n\nexport const Controller = class {\n\n  /**\n   * @private\n   * @param {angular.ITimeoutService} $timeout Angular timeout service.\n   * @param {import(\"ngeo/map/FeatureOverlayMgr.js\").FeatureOverlayMgr} ngeoFeatureOverlayMgr\n   * ngeo feature overlay manager service.\n   * @param {import(\"ngeo/offline/ServiceManager.js\").default} ngeoOfflineServiceManager\n   * ngeo offline service Manager.\n   * @param {import(\"ngeo/offline/Configuration.js\").default} ngeoOfflineConfiguration\n   * ngeo offline configuration service.\n   * @param {import(\"ngeo/offline/Mode.js\").default} ngeoOfflineMode Offline mode manager.\n   * @param {import(\"ngeo/offline/NetworkStatus.js\").default} ngeoNetworkStatus ngeo network status service.\n   * @ngInject\n   * @ngdoc controller\n   * @ngname ngeoOfflineController\n   */\n  constructor($timeout, ngeoFeatureOverlayMgr, ngeoOfflineServiceManager, ngeoOfflineConfiguration,\n    ngeoOfflineMode, ngeoNetworkStatus) {\n\n    /**\n     * @type {angular.ITimeoutService}\n     * @private\n     */\n    this.$timeout_ = $timeout;\n\n    /**\n     * @type {import(\"ngeo/offline/ServiceManager.js\").default}\n     * @private\n     */\n    this.ngeoOfflineServiceManager_ = ngeoOfflineServiceManager;\n\n    /**\n     * @private\n     * @type {import(\"ngeo/offline/Configuration.js\").default}\n     */\n    this.ngeoOfflineConfiguration_ = ngeoOfflineConfiguration;\n\n    /**\n     * @type {import(\"ngeo/offline/Mode.js\").default}\n     * @export\n     */\n    this.offlineMode = ngeoOfflineMode;\n\n    /**\n     * @type {import(\"ngeo/offline/NetworkStatus.js\").default}\n     * @export\n     */\n    this.networkStatus = ngeoNetworkStatus;\n\n    /**\n     * The map.\n     * @type {!import(\"ol/Map\").default}\n     * @export\n     */\n    this.map;\n\n    /**\n     * The size, in map units, of a side of the extent.\n     * @type {number}\n     * @export\n     */\n    this.extentSize;\n\n    /**\n     * @type {import(\"ngeo/map/FeatureOverlay.js\").FeatureOverlay}\n     * @private\n     */\n    this.featuresOverlay_ = ngeoFeatureOverlayMgr.getFeatureOverlay();\n\n    /**\n     * @type {!OlCollection<OlFeature>}\n     * @private\n     */\n    this.overlayCollection_ = new OlCollection();\n\n    this.featuresOverlay_.setFeatures(this.overlayCollection_);\n\n    /**\n     * @type {function(import(\"ol/render/Event\").default):any}\n     */\n    this.postcomposeListener_;\n\n    /**\n     * @type {import(\"ol/events.js\").EventsKey|Array.<import(\"ol/events.js\").EventsKey>}\n     * @private\n     */\n    this.postComposeListenerKey_ = null;\n\n\n    /**\n     * @type {OlGeomPolygon}\n     * @private\n     */\n    this.dataPolygon_ = null;\n\n    /**\n     * Whether the current view is the extent selection.\n     * @type {boolean}\n     * @export\n     */\n    this.selectingExtent = false;\n\n    /**\n     * Whether the current view is downloading one.\n     * @type {boolean}\n     * @export\n     */\n    this.downloading = false;\n\n    /**\n     * The progression of the data loading (0-100%).\n     * @type {number}\n     * @export\n     */\n    this.progressPercents = 0;\n\n    /**\n     * Whether the menu is currently displayed.\n     * @type {boolean}\n     * @export\n     */\n    this.menuDisplayed = false;\n\n    /**\n     * Whether the cancel download modal is displayed.\n     * @type {boolean}\n     * @export\n     */\n    this.displayAlertAbortDownload = false;\n\n    /**\n     * Whether the load data modal is displayed.\n     * @type {boolean}\n     * @export\n     */\n    this.displayAlertLoadData = false;\n\n    /**\n     * Whether the \"no layer\" modal is displayed.\n     * @type {boolean}\n     * @export\n     */\n    this.displayAlertNoLayer = false;\n\n    /**\n     * Offline mask minimum margin in pixels.\n     * @type {number}\n     * @export\n     */\n    this.maskMargin;\n\n    /**\n     * Minimum zoom where offline is enable.\n     * @type {number}\n     * @export\n     */\n    this.minZoom;\n\n    /**\n     * Maximum zoom where offline is enable.\n     * @type {number}\n     * @export\n     */\n    this.maxZoom;\n\n    /**\n     * Map view max zoom constraint.\n     * @type {number}\n     * @export\n     */\n    this.originalMinZoom;\n\n    /**\n     * Map view min zoom constraint.\n     * @type {number}\n     * @export\n     */\n    this.originalMaxZoom;\n\n    /**\n     * @type {number}\n     * @export\n     */\n    this.estimatedLoadDataSize;\n\n    /**\n     * @private\n     * @param {import(\"ngeo/CustomEvent\").default} event the progress event.\n     */\n    this.progressCallback_ = (event) => {\n      const progress = event.detail['progress'];\n      this.progressPercents = Math.floor(progress * 100);\n      if (progress === 1) {\n        this.finishDownload_();\n      }\n      this.$timeout_(() => {}, 0); // FIXME: force redraw\n    };\n  }\n\n  $onInit() {\n    this.offlineMode.registerComponent(this);\n    this.postcomposeListener_ = this.createMaskPostcompose_();\n    this.ngeoOfflineConfiguration_.on('progress', this.progressCallback_);\n    this.maskMargin = this.maskMargin || 100;\n    this.minZoom = this.minZoom || 10;\n    this.maxZoom = this.maxZoom || 15;\n  }\n\n  $onDestroy() {\n    this.ngeoOfflineConfiguration_.un('progress', this.progressCallback_);\n  }\n\n  /**\n   * @return {boolean} True if data are accessible offline.\n   * @export\n   */\n  hasData() {\n    return this.ngeoOfflineConfiguration_.hasOfflineData();\n  }\n\n  /**\n   * @export\n   */\n  computeSizeAndDisplayAlertLoadData() {\n    this.estimatedLoadDataSize = this.ngeoOfflineConfiguration_.estimateLoadDataSize(this.map);\n    if (this.estimatedLoadDataSize > 0) {\n      this.displayAlertLoadData = true;\n    } else {\n      this.displayAlertNoLayer = true;\n    }\n  }\n  /**\n   * Toggle the selecting extent view.\n   * @param {boolean=} finished If just finished downloading.\n   * @export\n   */\n  toggleViewExtentSelection(finished) {\n    this.menuDisplayed = false;\n    this.selectingExtent = !this.selectingExtent;\n\n    if (this.postComposeListenerKey_) {\n      unByKey(this.postComposeListenerKey_);\n      this.postComposeListenerKey_ = null;\n      this.removeZoomConstraints_();\n    }\n    if (this.selectingExtent && !this.postComposeListenerKey_) {\n      this.addZoomConstraints_();\n      this.postComposeListenerKey_ = this.map.on('postcompose', this.postcomposeListener_);\n    }\n    this.map.render();\n  }\n\n  /**\n   * Validate the current extent and download data.\n   * @export\n   */\n  validateExtent() {\n    this.progressPercents = 0;\n    const extent = this.getDowloadExtent_();\n    this.downloading = true;\n    this.ngeoOfflineServiceManager_.save(extent, this.map);\n  }\n\n\n  /**\n   * @private\n   */\n  finishDownload_() {\n    this.downloading = false;\n    this.toggleViewExtentSelection(true);\n  }\n\n  /**\n   * Ask to abort the download of data.\n   * @export\n   */\n  askAbortDownload() {\n    this.displayAlertAbortDownload = true;\n  }\n\n  /**\n   * Abort the download of data.\n   * @export\n   */\n  abortDownload() {\n    this.downloading = false;\n    this.ngeoOfflineServiceManager_.cancel();\n    this.deleteData();\n  }\n\n  /**\n   * Show the main menu.\n   * @export\n   */\n  showMenu() {\n    this.menuDisplayed = true;\n  }\n\n  /**\n   * Activate offline mode.\n   * Zoom to the extent of that data and restore the data.\n   * @export\n   */\n  activateOfflineMode() {\n    this.ngeoOfflineServiceManager_.restore(this.map).then((extent) => {\n      this.dataPolygon_ = this.createPolygonFromExtent_(extent);\n      const size = /** @type {import(\"ol/size.js\").Size} */ (this.map.getSize());\n      this.map.getView().fit(extent, {size});\n      this.menuDisplayed = false;\n      this.displayExtent_();\n      this.offlineMode.enable();\n    });\n  }\n\n  /**\n   *\n   * Deactivate offline mode.\n   * Reload the page.\n   * @export\n   */\n  deactivateOfflineMode() {\n    window.location.reload();\n  }\n\n  /**\n   * Toggle the visibility of the data's extent.\n   * @export\n   */\n  toggleExtentVisibility() {\n    if (this.isExtentVisible()) {\n      this.overlayCollection_.clear();\n    } else {\n      this.displayExtent_();\n    }\n  }\n\n  /**\n   * @return {boolean} True if the extent is currently visible. False otherwise.\n   * @export\n   */\n  isExtentVisible() {\n    return this.overlayCollection_.getLength() > 0;\n  }\n\n  /**\n   * Delete the saved data.\n   * @export\n   */\n  deleteData() {\n    this.overlayCollection_.clear();\n    this.dataPolygon_ = null;\n    if (this.networkStatus.isDisconnected()) {\n      this.menuDisplayed = false;\n    }\n\n    const reloadIfInOfflineMode = () => {\n      if (this.offlineMode.isEnabled()) {\n        this.deactivateOfflineMode();\n      }\n    };\n    this.ngeoOfflineConfiguration_.clear().then(reloadIfInOfflineMode);\n  }\n\n  /**\n   * @private\n   */\n  displayExtent_() {\n    if (!this.isExtentVisible()) {\n      const feature = new OlFeature(this.dataPolygon_);\n      this.overlayCollection_.push(feature);\n    }\n  }\n\n  /**\n   * When enabling mask extent, zoom the view to the defined zoom range and\n   * add constraints to the view to not allow user to move out of this range.\n   * @private\n   */\n  addZoomConstraints_() {\n    const view = this.map.getView();\n    const zoom = view.getZoom();\n\n    this.originalMinZoom = view.getMinZoom();\n    this.originalMaxZoom = view.getMaxZoom();\n\n    if (zoom < this.minZoom) {\n      view.setZoom(this.minZoom);\n    } else if (zoom > this.maxZoom) {\n      view.setZoom(this.maxZoom);\n    }\n    view.setMaxZoom(this.maxZoom);\n    view.setMinZoom(this.minZoom);\n  }\n\n  /**\n   * @private\n   */\n  removeZoomConstraints_() {\n    const view = this.map.getView();\n    view.setMaxZoom(this.originalMaxZoom);\n    view.setMinZoom(this.originalMinZoom);\n  }\n\n  /**\n   * @return {function(import(\"ol/render/Event\").default):any} Function to use as a map postcompose listener.\n   * @private\n   */\n  createMaskPostcompose_() {\n    return (evt) => {\n      const context = evt.context;\n      const frameState = evt.frameState;\n      const resolution = frameState.viewState.resolution;\n\n      const viewportWidth = frameState.size[0] * frameState.pixelRatio;\n      const viewportHeight = frameState.size[1] * frameState.pixelRatio;\n\n      const extentLength = this.extentSize ?\n        this.extentSize / resolution * DEVICE_PIXEL_RATIO :\n        Math.min(viewportWidth, viewportHeight) - this.maskMargin * 2;\n\n      const extentHalfLength = Math.ceil(extentLength / 2);\n\n      // Draw a mask on the whole map.\n      context.beginPath();\n      context.moveTo(0, 0);\n      context.lineTo(viewportWidth, 0);\n      context.lineTo(viewportWidth, viewportHeight);\n      context.lineTo(0, viewportHeight);\n      context.lineTo(0, 0);\n      context.closePath();\n\n      // Draw the get data zone\n      const extent = this.createExtent_([viewportWidth / 2, viewportHeight / 2], extentHalfLength);\n\n      context.moveTo(extent[0], extent[1]);\n      context.lineTo(extent[0], extent[3]);\n      context.lineTo(extent[2], extent[3]);\n      context.lineTo(extent[2], extent[1]);\n      context.lineTo(extent[0], extent[1]);\n      context.closePath();\n\n      // Fill the mask\n      context.fillStyle = 'rgba(0, 5, 25, 0.5)';\n      context.fill();\n    };\n  }\n\n  /**\n   * A polygon on the whole extent of the projection, with a hole for the offline extent.\n   * @param {import(\"ol/extent.js\").Extent} extent An extent\n   * @return {OlGeomPolygon} Polygon to save, based on the projection extent, the center of the map and\n   *     the extentSize property.\n   * @private\n   */\n  createPolygonFromExtent_(extent) {\n    const projExtent = this.map.getView().getProjection().getExtent();\n    return new OlGeomPolygon([\n      extentToRectangle(projExtent),\n      extentToRectangle(extent),\n    ], olGeomGeometryLayout.XY);\n  }\n\n  /**\n   * @param {import(\"ol/coordinate.js\").Coordinate} center, a xy point.\n   * @param {number} halfLength a half length of a square's side.\n   * @return {Array.<number>} an extent.\n   * @private\n   */\n  createExtent_(center, halfLength) {\n    const minx = center[0] - halfLength;\n    const miny = center[1] - halfLength;\n    const maxx = center[0] + halfLength;\n    const maxy = center[1] + halfLength;\n    return [minx, miny, maxx, maxy];\n  }\n\n  /**\n   * @return {import(\"ol/extent.js\").Extent} the download extent.\n   * @private\n   */\n  getDowloadExtent_() {\n    const center = /** @type {import(\"ol/coordinate.js\").Coordinate}*/(this.map.getView().getCenter());\n    const halfLength = Math.ceil(this.extentSize || this.getExtentSize_()) / 2;\n    return this.createExtent_(center, halfLength);\n  }\n\n  getExtentSize_() {\n    const mapSize = this.map.getSize();\n    const maskSizePixel = DEVICE_PIXEL_RATIO * Math.min(mapSize[0], mapSize[1]) - this.maskMargin * 2;\n    const maskSizeMeter = maskSizePixel * this.map.getView().getResolution() / DEVICE_PIXEL_RATIO;\n    return maskSizeMeter;\n  }\n};\n\n\nmodule.controller('ngeoOfflineController', Controller);\n\n\nexport default module;\n","import ngeoOfflineComponent from 'ngeo/offline/component.js';\nimport ngeoOfflineNetworkStatus from 'ngeo/offline/NetworkStatus.js';\nimport ngeoOfflineServiceManager from 'ngeo/offline/ServiceManager.js';\nimport downloader from 'ngeo/offline/Downloader.js';\nimport restorer from 'ngeo/offline/Restorer.js';\nimport mode from 'ngeo/offline/Mode.js';\nimport angular from 'angular';\n\n\n/**\n * @type {!angular.IModule}\n */\nconst exports = angular.module('ngeoOfflineModule', [\n  ngeoOfflineComponent.name,\n  ngeoOfflineNetworkStatus.module.name,\n  ngeoOfflineServiceManager.module.name,\n  downloader.module.name,\n  restorer.module.name,\n  mode.module.name\n]);\n\nexports.value('ngeoOfflineGutter', 96);\n\n\nexport default exports;\n","const exports = {};\nimport olLayerGroup from 'ol/layer/Group.js';\n\n\n/**\n * @param {import(\"ol/layer/Base.js\").default} layer A layer tree.\n * @param {!Array<import(\"ol/layer/Group.js\").default>} ancestors The groups to which the layer belongs to.\n * @param {function(import(\"ol/layer/Base.js\").default, Array<import(\"ol/layer/Group.js\").default>): boolean}\n * visitor A function which will return false if descend must stop.\n */\nexports.traverseLayer = function(layer, ancestors, visitor) {\n  const descend = visitor(layer, ancestors);\n  if (descend && layer instanceof olLayerGroup) {\n    layer.getLayers().forEach((childLayer) => {\n      exports.traverseLayer(childLayer, [...ancestors, layer], visitor);\n    });\n  }\n};\n\nconst extractor = new RegExp('[^/]*//[^/]+/(.*)');\n/**\n * Extract the part after the URL authority.\n * @param {string} url A URL to normalize\n * @return {string} The normalized string.\n */\nexports.normalizeURL = function(url) {\n  const matches = url.match(extractor);\n  return matches[1];\n};\n\n\nexport default exports;\n"],"sourceRoot":""}